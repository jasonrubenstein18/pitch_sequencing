######plot(statcast.2016$hit_distance_sc, statcast.2016$hit_speed)
#####
FF <- subset(statcast.2016, second_pitch == "FF" )
CU <- subset(statcast.2016, second_pitch == "CU" )
SL <- subset(statcast.2016, second_pitch == "SL" )
FT <- subset(statcast.2016, second_pitch == "FT")
CH <- subset(statcast.2016, second_pitch == "CH")
#EP <- subset(statcast.2016, pitch_type == "EP")
FC <- subset(statcast.2016, second_pitch == "FC")
FS <- subset(statcast.2016, second_pitch == "FS")
KC <- subset(statcast.2016, second_pitch == "KC")
KN <- subset(statcast.2016, second_pitch == "KN")
#SC <- subset(statcast.2016, pitch_type == "SC")
SI <- subset(statcast.2016, second_pitch == "SI")

######### 4-Seam Fastball ########
siFF <- subset(statcast.2016, first_pitch == "SI" & second_pitch == "FF")
knFF <- subset(statcast.2016, first_pitch == "KN" & second_pitch == "FF")
kcFF <- subset(statcast.2016, first_pitch == "KC" & second_pitch == "FF")
fsFF <- subset(statcast.2016, first_pitch == "FS" & second_pitch == "FF")
fcFF <- subset(statcast.2016, first_pitch == "FC" & second_pitch == "FF")
chFF <- subset(statcast.2016, first_pitch == "CH" & second_pitch == "FF")
ftFF <- subset(statcast.2016, first_pitch == "FT" & second_pitch == "FF")
slFF <- subset(statcast.2016, first_pitch == "SL" & second_pitch == "FF")
cuFF <- subset(statcast.2016, first_pitch == "CU" & second_pitch == "FF")

######### 2-Seam Fastball #########
knFT <- subset(statcast.2016, first_pitch == "KN" & second_pitch == "FT")
siFT <- subset(statcast.2016, first_pitch == "SI" & second_pitch == "FT")
kcFT <- subset(statcast.2016, first_pitch == "KC" & second_pitch == "FT")
fsFT <- subset(statcast.2016, first_pitch == "FS" & second_pitch == "FT")
fcFT <- subset(statcast.2016, first_pitch == "FC" & second_pitch == "FT")
chFT <- subset(statcast.2016, first_pitch == "CH" & second_pitch == "FT")
slFT <- subset(statcast.2016, first_pitch == "SL" & second_pitch == "FT")
cuFT <- subset(statcast.2016, first_pitch == "CU" & second_pitch == "FT")
ffFT <- subset(statcast.2016, first_pitch == "FF" & second_pitch == "FT")

######### Slider #########
siSL <- subset(statcast.2016, first_pitch == "SI" & second_pitch == "SL")
knSL <- subset(statcast.2016, first_pitch == "KN" & second_pitch == "SL")
kcSL <- subset(statcast.2016, first_pitch == "KC" & second_pitch == "SL")
fsSL <- subset(statcast.2016, first_pitch == "FS" & second_pitch == "SL")
fcSL <- subset(statcast.2016, first_pitch == "FC" & second_pitch == "SL")
chSL <- subset(statcast.2016, first_pitch == "CH" & second_pitch == "SL")
ftSL <- subset(statcast.2016, first_pitch == "FT" & second_pitch == "SL")
cuSL <- subset(statcast.2016, first_pitch == "CU" & second_pitch == "SL")
ffSL <- subset(statcast.2016, first_pitch == "FF" & second_pitch == "SL")

######### Curveball #########
siCU <- subset(statcast.2016, first_pitch == "SI" & second_pitch == "CU")
knCU <- subset(statcast.2016, first_pitch == "KN" & second_pitch == "CU")
kcCU <- subset(statcast.2016, first_pitch == "KC" & second_pitch == "CU")
fsCU <- subset(statcast.2016, first_pitch == "FS" & second_pitch == "CU")
fcCU <- subset(statcast.2016, first_pitch == "FC" & second_pitch == "CU")
chCU <- subset(statcast.2016, first_pitch == "CH" & second_pitch == "CU")
ftCU <- subset(statcast.2016, first_pitch == "FT" & second_pitch == "CU")
slCU <- subset(statcast.2016, first_pitch == "SL" & second_pitch == "CU")
ffCU <- subset(statcast.2016, first_pitch == "FF" & second_pitch == "CU")

######### Changeup #########
siCH <- subset(statcast.2016, first_pitch == "SI" & second_pitch == "CH")
knCH <- subset(statcast.2016, first_pitch == "KN" & second_pitch == "CH")
kcCH <- subset(statcast.2016, first_pitch == "KC" & second_pitch == "CH")
fsCH <- subset(statcast.2016, first_pitch == "FS" & second_pitch == "CH")
fcCH <- subset(statcast.2016, first_pitch == "FC" & second_pitch == "CH")
ftCH <- subset(statcast.2016, first_pitch == "FT" & second_pitch == "CH")
cuCH <- subset(statcast.2016, first_pitch == "CU" & second_pitch == "CH")
slCH <- subset(statcast.2016, first_pitch == "SL" & second_pitch == "CH")
ffCH <- subset(statcast.2016, first_pitch == "FF" & second_pitch == "CH")

######### Cutter #########
siFC <- subset(statcast.2016, first_pitch == "SI" & second_pitch == "FC")
knFC <- subset(statcast.2016, first_pitch == "KN" & second_pitch == "FC")
kcFC <- subset(statcast.2016, first_pitch == "KC" & second_pitch == "FC")
fsFC <- subset(statcast.2016, first_pitch == "FS" & second_pitch == "FC")
chFC <- subset(statcast.2016, first_pitch == "CH" & second_pitch == "FC")
ftFC <- subset(statcast.2016, first_pitch == "FT" & second_pitch == "FC")
slFC <- subset(statcast.2016, first_pitch == "SL" & second_pitch == "FC")
cuFC <- subset(statcast.2016, first_pitch == "CU" & second_pitch == "FC")
ffFC <- subset(statcast.2016, first_pitch == "FF" & second_pitch == "FC")
######### Splitter #########
siFS <- subset(statcast.2016, first_pitch == "SI" & second_pitch == "FS")
knFS <- subset(statcast.2016, first_pitch == "KN" & second_pitch == "FS")
kcFS <- subset(statcast.2016, first_pitch == "KC" & second_pitch == "FS")
fcFS <- subset(statcast.2016, first_pitch == "FC" & second_pitch == "FS")
chFS <- subset(statcast.2016, first_pitch == "CH" & second_pitch == "FS")
ftFS <- subset(statcast.2016, first_pitch == "FT" & second_pitch == "FS")
slFS <- subset(statcast.2016, first_pitch == "SL" & second_pitch == "FS")
cuFS <- subset(statcast.2016, first_pitch == "CU" & second_pitch == "FS")
ffFS <- subset(statcast.2016, first_pitch == "FF" & second_pitch == "FS")

######### Knuckle Curve #########
siKC <- subset(statcast.2016, first_pitch == "SI" & second_pitch == "KC")
knKC <- subset(statcast.2016, first_pitch == "KN" & second_pitch == "KC") 
fsKC <- subset(statcast.2016, first_pitch == "FS" & second_pitch == "KC") 
chKC <- subset(statcast.2016, first_pitch == "CH" & second_pitch == "KC")
ftKC <- subset(statcast.2016, first_pitch == "FT" & second_pitch == "KC")
slKC <- subset(statcast.2016, first_pitch == "SL" & second_pitch == "KC")
fcKC <- subset(statcast.2016, first_pitch == "FC" & second_pitch == "KC")
cuKC <- subset(statcast.2016, first_pitch == "CU" & second_pitch == "KC")
ffKC <- subset(statcast.2016, first_pitch == "FF" & second_pitch == "KC")

######### Knuckleball #########
siKN <- subset(statcast.2016, first_pitch == "SI" & second_pitch == "KN")
kcKN <- subset(statcast.2016, first_pitch == "KC" & second_pitch == "KN") 
fsKN <- subset(statcast.2016, first_pitch == "FS" & second_pitch == "KN")
fcKN <- subset(statcast.2016, first_pitch == "FC" & second_pitch == "KN")
chKN <- subset(statcast.2016, first_pitch == "CH" & second_pitch == "KN")
ftKN <- subset(statcast.2016, first_pitch == "FT" & second_pitch == "KN")
slKN <- subset(statcast.2016, first_pitch == "SL" & second_pitch == "KN")
cuKN <- subset(statcast.2016, first_pitch == "CU" & second_pitch == "KN")
ffKN <- subset(statcast.2016, first_pitch == "FF" & second_pitch == "KN")

######### Sinker #########
knSI <- subset(statcast.2016, first_pitch == "KN" & second_pitch == "SI")
kcSI <- subset(statcast.2016, first_pitch == "KC" & second_pitch == "SI")
fsSI <- subset(statcast.2016, first_pitch == "FS" & second_pitch == "SI")
fcSI <- subset(statcast.2016, first_pitch == "FC" & second_pitch == "SI")
chSI <- subset(statcast.2016, first_pitch == "CH" & second_pitch == "SI")
ftSI <- subset(statcast.2016, first_pitch == "FT" & second_pitch == "SI")
slSI <- subset(statcast.2016, first_pitch == "SL" & second_pitch == "SI")
cuSI <- subset(statcast.2016, first_pitch == "CU" & second_pitch == "SI")
ffSI <- subset(statcast.2016, first_pitch == "FF" & second_pitch == "SI")

########################
par(mfrow= c(3,4))
plot(FF$hit_distance_sc, FF$hit_speed)
plot(FT$hit_distance_sc, FT$hit_speed)
plot(FS$hit_distance_sc, FS$hit_speed)
plot(FC$hit_distance_sc, FC$hit_speed)
plot(CH$hit_distance_sc, CH$hit_speed)
plot(SL$hit_distance_sc, SL$hit_speed)
plot(CU$hit_distance_sc, CU$hit_speed)
plot(EP$hit_distance_sc, EP$hit_speed)
plot(KC$hit_distance_sc, KC$hit_speed)
plot(KN$hit_distance_sc, KN$hit_speed)
plot(SI$hit_distance_sc, SI$hit_speed)
plot(SC$hit_distance_sc, SC$hit_speed)


par(mfrow= c(3,4))
plot(FF$hit_distance_sc, FF$hit_angle)
plot(FT$hit_distance_sc, FT$hit_angle)
plot(FS$hit_distance_sc, FS$hit_angle)
plot(FC$hit_distance_sc, FC$hit_angle)
plot(CH$hit_distance_sc, CH$hit_angle)
plot(SL$hit_distance_sc, SL$hit_angle)
plot(CU$hit_distance_sc, CU$hit_angle)
plot(EP$hit_distance_sc, EP$hit_angle)
plot(KC$hit_distance_sc, KC$hit_angle)
plot(KN$hit_distance_sc, KN$hit_angle)
plot(SI$hit_distance_sc, SI$hit_angle)
plot(SC$hit_distance_sc, SC$hit_angle)

par(mfrow= c(3,4))
plot(FF$hit_angle, FF$hit_speed)
plot(FT$hit_angle, FT$hit_speed)
plot(FS$hit_angle, FS$hit_speed)
plot(FC$hit_angle, FC$hit_speed)
plot(CH$hit_angle, CH$hit_speed)
plot(SL$hit_angle, SL$hit_speed)
plot(CU$hit_angle, CU$hit_speed)
plot(EP$hit_angle, EP$hit_speed)
plot(KC$hit_angle, KC$hit_speed)
plot(KN$hit_angle, KN$hit_speed)
plot(SI$hit_angle, SI$hit_speed)
plot(SC$hit_angle, SC$hit_speed)
#Plots Plots


########################## Start 4-Seam Fastballs
#####
siFF$hit_distance_sc <- as.numeric(siFF$hit_distance_sc)
siFF$hit_angle <- as.numeric(siFF$hit_angle)
siFF$hit_speed <- as.numeric(siFF$hit_speed)

siFF$hit <- with(siFF, ifelse(grepl("Single", siFF$events), 1,
															ifelse(grepl("Double", siFF$events), 1,
																		 ifelse(grepl("Triple", siFF$events), 1, 
																		 			 ifelse(grepl("Home Run", siFF$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

siFF$fieldingTeam <- with(siFF, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[siFF$hit_distance_sc == "null"] = NA
#siFF$hit_speed[siFF$hit_speed == "null"] = NA
#siFF$hit_angle[siFF$hit_angle == "null"] = NA

# include row names for unique record identification

siFF$row <- row.names(siFF) %>% as.numeric()

# recode stand and home_team as factors

siFF$stand <- as.factor(siFF$stand)
siFF$home_team <- as.factor(siFF$home_team)


siFF$game_date <- as.Date(siFF$game_date)


# subset 

siFF_working_data <- ungroup(siFF) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(siFF_working_data)
str(ungroup(siFF))
table(siFF_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

siFF_working_data <- filter(siFF_working_data, hc_x != 1, hc_y != 1)
head(siFF_working_data)

# create training and test sets
# scaled data

set.seed(42)
siFF_train <- sample_frac(siFF_working_data, .15, replace = FALSE)
siFF_split <- setdiff(siFF_working_data, siFF_train)
siFF_test <- sample_frac(siFF_split, .50, replace = FALSE)
siFF_validate <- setdiff(siFF_split, siFF_test)

nrow(siFF_train) + nrow(siFF_test) + nrow(siFF_validate) == nrow(siFF_working_data)

with(siFF_train, table(hit)) %>% prop.table()
with(siFF_test, table(hit)) %>% prop.table()
with(siFF_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
head(siFF_train)

str(siFF)
##as.numeric(siFF$hit_distance_sc, siFF$hit_speed, siFF$hit_angle)

#siFF_train$hit_distance_sc <- as.numeric(siFF_train$hit_distance_sc)
#siFF_train$hit_speed <- as.numeric(siFF_train$hit_speed)
#siFF_train$hit_angle <- as.numeric(siFF_train$hit_angle)
#View(siFF_train)
siFF_scaled_data <- scale(siFF_train[,c(1:5)])
siFF_scale_values <- attr(siFF_scaled_data, 'scaled:scale')
siFF_scale_values
siFF_center_values <- attr(siFF_scaled_data, 'scaled:center')
siFF_center_values
siFF_train <- cbind(siFF_scaled_data, select(siFF_train, hit:row))

# save levels for factor variables
siFF_levels_home_team <- levels(siFF_train$home_team)
siFF_levels_stand <- levels(siFF_train$stand)
siFF_levels_fieldingTeam <- levels(siFF_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(siFF_test)

siFF_test$hit_distance_sc <- (siFF_test$hit_distance_sc - siFF_center_values[1]) / siFF_scale_values[1]

siFF_test$hit_speed <- (siFF_test$hit_speed - siFF_center_values[2]) / siFF_scale_values[2]

siFF_test$hit_angle <- (siFF_test$hit_angle - siFF_center_values[3]) / siFF_scale_values[3]

siFF_test$hc_x <- (siFF_test$hc_x - siFF_center_values[4]) / siFF_scale_values[4]

siFF_test$hc_y <- (siFF_test$hc_y - siFF_center_values[5]) / siFF_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

siFF_validate$hit_distance_sc <- (siFF_validate$hit_distance_sc - siFF_center_values[1]) / siFF_scale_values[1]

siFF_validate$hit_speed <- (siFF_validate$hit_speed - siFF_center_values[2]) / siFF_scale_values[2]

siFF_validate$hit_angle <- (siFF_validate$hit_angle - siFF_center_values[3]) / siFF_scale_values[3]

siFF_validate$hc_x <- (siFF_validate$hc_x - siFF_center_values[4]) / siFF_scale_values[4]

siFF_validate$hc_y <- (siFF_validate$hc_y - siFF_center_values[5]) / siFF_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(siFF_train)

set.seed(42)
siFF_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(siFF_train, -row), ntree = 501, importance = TRUE)

print(siFF_rf.1)

plot(siFF_rf.1)

varImpPlot(siFF_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
siFF_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(siFF_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(siFF_rf.5)

plot(siFF_rf.5)

varImpPlot(siFF_rf.5)

siFF_predict_fit.rf.5 <- data.frame(fits = predict(siFF_rf.5, siFF_test, type = "prob")[,2], actuals = siFF_test$hit)

siFF_pred.rf.5 <- prediction(siFF_predict_fit.rf.5$fits, siFF_predict_fit.rf.5$actuals)

siFF_roc.pred.rf.5 <- performance(siFF_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(siFF_roc.pred.rf.5)
abline(a = 0, b = 1)
siFF_opt <- opt.cut(siFF_roc.pred.rf.5, siFF_pred.rf.5)
siFF_opt
siFF_opt <- siFF_opt[3]
siFF_predict_fit.rf.5$fits <- with(siFF_predict_fit.rf.5, ifelse(fits > siFF_opt, 1, 0)) 

str(siFF_test)

#siFF_test$fieldingTeam <- as.character(siFF_test$fieldingTeam)
#siFF_test$home_team <- as.character(siFF_test$home_team)
#siFF_test$hit <- as.logical(siFF_test$hit)
#siFF_test$stand <- as.logical(siFF_test$stand)
str(siFF_test)
siFF_rf.5_confusion_test <- confusionMatrix(model = siFF_rf.5, x = siFF_test, y = siFF_test$hit)
siFF_rf.5_confusion_validate <- confusionMatrix(model = siFF_rf.5, x = siFF_validate, y = siFF_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


siFF_test_rows <- siFF_test$row
siFF_validate_rows <- siFF_validate$row
siFF_pred_data_emp_1 <- ungroup(siFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFF_test_rows)

siFF_pred_data_emp <- ungroup(siFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFF_validate_rows) %>%
	rbind(siFF_pred_data_emp_1)

siFF_out_of_training_rows <- siFF_pred_data_emp$row

siFF_rf.5_full_out_of_sample_data <- ungroup(siFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFF_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



siFF_rf.5_full_out_of_sample_data_scaled <- siFF_rf.5_full_out_of_sample_data

siFF_rf.5_full_out_of_sample_data_scaled$hit_speed <- (siFF_rf.5_full_out_of_sample_data_scaled$hit_speed - siFF_center_values[2]) / siFF_scale_values[2]

siFF_rf.5_full_out_of_sample_data_scaled$hit_angle <- (siFF_rf.5_full_out_of_sample_data_scaled$hit_angle - siFF_center_values[3]) / siFF_scale_values[3]

siFF_rf.5.prob <- predict(siFF_rf.5, siFF_rf.5_full_out_of_sample_data_scaled, type = "response")

siFF_rf.5_full_out_of_sample_data <- cbind(filter(siFF_rf.5_full_out_of_sample_data, row %in% siFF_out_of_training_rows), siFF_rf.5.prob)

names(siFF_rf.5_full_out_of_sample_data)[65] <- "fits"
names(siFF_rf.5_full_out_of_sample_data)

siFF_rf.5_full_out_of_sample_data_reduced <- siFF_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

siFF_rf.5_mean_table <- siFF_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

siFF_rf.5_full_out_of_sample_data$type <- with(siFF_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

siFF_rf.5_full_out_of_sample_data$hit_label <- with(siFF_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

siFF_rf.5_plot1 <- ggplot(siFF_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siFF_rf.5_plot1

siFF_rf.5_plot2 <- ggplot(siFF_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siFF_rf.5_plot2

siFF_rf.5_plot3 <- ggplot(siFF_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siFF_rf.5_plot3

siFF_grid_plot_rf.5 <- grid.arrange(siFF_rf.5_plot1, siFF_rf.5_plot2, siFF_rf.5_plot3, ncol = 3)
siFF_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

siFF_test_rows <- siFF_test$row
siFF_validate_rows <- siFF_validate$row
siFF_pred_data_emp_1 <- ungroup(siFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFF_test_rows)

siFF_pred_data_emp <- ungroup(siFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFF_validate_rows) %>%
	rbind(siFF_pred_data_emp_1)

siFF_out_of_training_rows <- siFF_pred_data_emp$row

siFF_pred_data_emp <- ungroup(siFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFF_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

siFF_pred_data_emp_scaled <- siFF_pred_data_emp

siFF_pred_data_emp_scaled$hit_speed <- (siFF_pred_data_emp_scaled$hit_speed - siFF_center_values[2]) / siFF_scale_values[2]

siFF_pred_data_emp_scaled$hit_angle <- (siFF_pred_data_emp_scaled$hit_angle - siFF_center_values[3]) / siFF_scale_values[3]

siFF_pred_prob_hit <- predict(siFF_rf.5, siFF_pred_data_emp_scaled, type = "prob")[,2]
siFF_pred_prob_hit_fits <- cbind(siFF_pred_data_emp, siFF_pred_prob_hit)

siFF_pred_prob_hit_fits[,c(1:2)] <- siFF_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

siFF_angle_speed_pred <- siFF_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = siFF_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nSI-FF Hit Probability\n") + theme_bp_grey()

siFF_angle_speed_pred

#####
knFF$hit_distance_sc <- as.numeric(knFF$hit_distance_sc, na.rm = TRUE)
knFF$hit_angle <- as.numeric(knFF$hit_angle, na.rm = TRUE)
knFF$hit_speed <- as.numeric(knFF$hit_speed, na.rm = TRUE)

knFF$hit <- with(knFF, ifelse(grepl("Single", knFF$events), 1,
															ifelse(grepl("Double", knFF$events), 1,
																		 ifelse(grepl("Triple", knFF$events), 1, 
																		 			 ifelse(grepl("Home Run", knFF$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

knFF$fieldingTeam <- with(knFF, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[knFF$hit_distance_sc == "null"] = NA
#knFF$hit_speed[knFF$hit_speed == "null"] = NA
#knFF$hit_angle[knFF$hit_angle == "null"] = NA

# include row names for unique record identification

knFF$row <- row.names(knFF) %>% as.numeric()

# recode stand and home_team as factors

knFF$stand <- as.factor(knFF$stand)
knFF$home_team <- as.factor(knFF$home_team)


knFF$game_date <- as.Date(knFF$game_date)


# subset 

knFF_working_data <- ungroup(knFF) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(knFF_working_data)
str(ungroup(knFF))
table(knFF_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

knFF_working_data <- filter(knFF_working_data, hc_x != 1, hc_y != 1)
head(knFF_working_data)

# create training and test sets
# scaled data

set.seed(42)
knFF_train <- sample_frac(knFF_working_data, .15, replace = FALSE)
knFF_split <- setdiff(knFF_working_data, knFF_train)
knFF_test <- sample_frac(knFF_split, .50, replace = FALSE)
knFF_validate <- setdiff(knFF_split, knFF_test)

nrow(knFF_train) + nrow(knFF_test) + nrow(knFF_validate) == nrow(knFF_working_data)

with(knFF_train, table(hit)) %>% prop.table()
with(knFF_test, table(hit)) %>% prop.table()
with(knFF_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(knFF)
##as.numeric(knFF$hit_distance_sc, knFF$hit_speed, knFF$hit_angle)

#knFF_train$hit_distance_sc <- as.numeric(knFF_train$hit_distance_sc)
#knFF_train$hit_speed <- as.numeric(knFF_train$hit_speed)
#knFF_train$hit_angle <- as.numeric(knFF_train$hit_angle)
#View(knFF_train)
knFF_scaled_data <- scale(knFF_train[,c(1:5)])
knFF_scale_values <- attr(knFF_scaled_data, 'scaled:scale')
knFF_scale_values
knFF_center_values <- attr(knFF_scaled_data, 'scaled:center')
knFF_center_values
knFF_train <- cbind(knFF_scaled_data, select(knFF_train, hit:row))

# save levels for factor variables
knFF_levels_home_team <- levels(knFF_train$home_team)
knFF_levels_stand <- levels(knFF_train$stand)
knFF_levels_fieldingTeam <- levels(knFF_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(knFF_test)

knFF_test$hit_distance_sc <- (knFF_test$hit_distance_sc - knFF_center_values[1]) / knFF_scale_values[1]

knFF_test$hit_speed <- (knFF_test$hit_speed - knFF_center_values[2]) / knFF_scale_values[2]

knFF_test$hit_angle <- (knFF_test$hit_angle - knFF_center_values[3]) / knFF_scale_values[3]

knFF_test$hc_x <- (knFF_test$hc_x - knFF_center_values[4]) / knFF_scale_values[4]

knFF_test$hc_y <- (knFF_test$hc_y - knFF_center_values[5]) / knFF_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

knFF_validate$hit_distance_sc <- (knFF_validate$hit_distance_sc - knFF_center_values[1]) / knFF_scale_values[1]

knFF_validate$hit_speed <- (knFF_validate$hit_speed - knFF_center_values[2]) / knFF_scale_values[2]

knFF_validate$hit_angle <- (knFF_validate$hit_angle - knFF_center_values[3]) / knFF_scale_values[3]

knFF_validate$hc_x <- (knFF_validate$hc_x - knFF_center_values[4]) / knFF_scale_values[4]

knFF_validate$hc_y <- (knFF_validate$hc_y - knFF_center_values[5]) / knFF_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(knFF_train)

set.seed(42)
knFF_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(knFF_train, -row), ntree = 501, importance = TRUE)

print(knFF_rf.1)

plot(knFF_rf.1)

varImpPlot(knFF_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
knFF_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(knFF_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(knFF_rf.5)

plot(knFF_rf.5)

varImpPlot(knFF_rf.5)

knFF_predict_fit.rf.5 <- data.frame(fits = predict(knFF_rf.5, knFF_test, type = "prob")[,2], actuals = knFF_test$hit)

knFF_pred.rf.5 <- prediction(knFF_predict_fit.rf.5$fits, knFF_predict_fit.rf.5$actuals)

knFF_roc.pred.rf.5 <- performance(knFF_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(knFF_roc.pred.rf.5)
abline(a = 0, b = 1)
knFF_opt <- opt.cut(knFF_roc.pred.rf.5, knFF_pred.rf.5)
knFF_opt
knFF_opt <- knFF_opt[3]
knFF_predict_fit.rf.5$fits <- with(knFF_predict_fit.rf.5, ifelse(fits > knFF_opt, 1, 0)) 

str(knFF_test)

#knFF_test$fieldingTeam <- as.character(knFF_test$fieldingTeam)
#knFF_test$home_team <- as.character(knFF_test$home_team)
#knFF_test$hit <- as.logical(knFF_test$hit)
#knFF_test$stand <- as.logical(knFF_test$stand)
str(knFF_test)
knFF_rf.5_confusion_test <- confusionMatrix(model = knFF_rf.5, x = knFF_test, y = knFF_test$hit)
knFF_rf.5_confusion_validate <- confusionMatrix(model = knFF_rf.5, x = knFF_validate, y = knFF_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


knFF_test_rows <- knFF_test$row
knFF_validate_rows <- knFF_validate$row
knFF_pred_data_emp_1 <- ungroup(knFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFF_test_rows)

knFF_pred_data_emp <- ungroup(knFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFF_validate_rows) %>%
	rbind(knFF_pred_data_emp_1)

knFF_out_of_training_rows <- knFF_pred_data_emp$row

knFF_rf.5_full_out_of_sample_data <- ungroup(knFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFF_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



knFF_rf.5_full_out_of_sample_data_scaled <- knFF_rf.5_full_out_of_sample_data

knFF_rf.5_full_out_of_sample_data_scaled$hit_speed <- (knFF_rf.5_full_out_of_sample_data_scaled$hit_speed - knFF_center_values[2]) / knFF_scale_values[2]

knFF_rf.5_full_out_of_sample_data_scaled$hit_angle <- (knFF_rf.5_full_out_of_sample_data_scaled$hit_angle - knFF_center_values[3]) / knFF_scale_values[3]

knFF_rf.5.prob <- predict(knFF_rf.5, knFF_rf.5_full_out_of_sample_data_scaled, type = "response")

knFF_rf.5_full_out_of_sample_data <- cbind(filter(knFF_rf.5_full_out_of_sample_data, row %in% knFF_out_of_training_rows), knFF_rf.5.prob)

names(knFF_rf.5_full_out_of_sample_data)[65] <- "fits"
names(knFF_rf.5_full_out_of_sample_data)

knFF_rf.5_full_out_of_sample_data_reduced <- knFF_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

knFF_rf.5_mean_table <- knFF_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

knFF_rf.5_full_out_of_sample_data$type <- with(knFF_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

knFF_rf.5_full_out_of_sample_data$hit_label <- with(knFF_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

knFF_rf.5_plot1 <- ggplot(knFF_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knFF_rf.5_plot1

knFF_rf.5_plot2 <- ggplot(knFF_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knFF_rf.5_plot2

knFF_rf.5_plot3 <- ggplot(knFF_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knFF_rf.5_plot3

knFF_grid_plot_rf.5 <- grid.arrange(knFF_rf.5_plot1, knFF_rf.5_plot2, knFF_rf.5_plot3, ncol = 3)
knFF_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

knFF_test_rows <- knFF_test$row
knFF_validate_rows <- knFF_validate$row
knFF_pred_data_emp_1 <- ungroup(knFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFF_test_rows)

knFF_pred_data_emp <- ungroup(knFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFF_validate_rows) %>%
	rbind(knFF_pred_data_emp_1)

knFF_out_of_training_rows <- knFF_pred_data_emp$row

knFF_pred_data_emp <- ungroup(knFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFF_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

knFF_pred_data_emp_scaled <- knFF_pred_data_emp

knFF_pred_data_emp_scaled$hit_speed <- (knFF_pred_data_emp_scaled$hit_speed - knFF_center_values[2]) / knFF_scale_values[2]

knFF_pred_data_emp_scaled$hit_angle <- (knFF_pred_data_emp_scaled$hit_angle - knFF_center_values[3]) / knFF_scale_values[3]

knFF_pred_prob_hit <- predict(knFF_rf.5, knFF_pred_data_emp_scaled, type = "prob")[,2]
knFF_pred_prob_hit_fits <- cbind(knFF_pred_data_emp, knFF_pred_prob_hit)

knFF_pred_prob_hit_fits[,c(1:2)] <- knFF_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

knFF_angle_speed_pred <- knFF_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = knFF_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nKN-FF Hit Probability\n") + theme_bp_grey()

knFF_angle_speed_pred

#####
kcFF$hit_distance_sc <- as.numeric(kcFF$hit_distance_sc, na.rm = TRUE)
kcFF$hit_angle <- as.numeric(kcFF$hit_angle, na.rm = TRUE)
kcFF$hit_speed <- as.numeric(kcFF$hit_speed, na.rm = TRUE)

kcFF$hit <- with(kcFF, ifelse(grepl("Single", kcFF$events), 1,
															ifelse(grepl("Double", kcFF$events), 1,
																		 ifelse(grepl("Triple", kcFF$events), 1, 
																		 			 ifelse(grepl("Home Run", kcFF$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

kcFF$fieldingTeam <- with(kcFF, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[kcFF$hit_distance_sc == "null"] = NA
#kcFF$hit_speed[kcFF$hit_speed == "null"] = NA
#kcFF$hit_angle[kcFF$hit_angle == "null"] = NA

# include row names for unique record identification

kcFF$row <- row.names(kcFF) %>% as.numeric()

# recode stand and home_team as factors

kcFF$stand <- as.factor(kcFF$stand)
kcFF$home_team <- as.factor(kcFF$home_team)


kcFF$game_date <- as.Date(kcFF$game_date)


# subset 

kcFF_working_data <- ungroup(kcFF) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(kcFF_working_data)
str(ungroup(kcFF))
table(kcFF_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

kcFF_working_data <- filter(kcFF_working_data, hc_x != 1, hc_y != 1)
head(kcFF_working_data)

# create training and test sets
# scaled data

set.seed(42)
kcFF_train <- sample_frac(kcFF_working_data, .15, replace = FALSE)
kcFF_split <- setdiff(kcFF_working_data, kcFF_train)
kcFF_test <- sample_frac(kcFF_split, .50, replace = FALSE)
kcFF_validate <- setdiff(kcFF_split, kcFF_test)

nrow(kcFF_train) + nrow(kcFF_test) + nrow(kcFF_validate) == nrow(kcFF_working_data)

with(kcFF_train, table(hit)) %>% prop.table()
with(kcFF_test, table(hit)) %>% prop.table()
with(kcFF_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(kcFF)
##as.numeric(kcFF$hit_distance_sc, kcFF$hit_speed, kcFF$hit_angle)

#kcFF_train$hit_distance_sc <- as.numeric(kcFF_train$hit_distance_sc)
#kcFF_train$hit_speed <- as.numeric(kcFF_train$hit_speed)
#kcFF_train$hit_angle <- as.numeric(kcFF_train$hit_angle)
#View(kcFF_train)
kcFF_scaled_data <- scale(kcFF_train[,c(1:5)])
kcFF_scale_values <- attr(kcFF_scaled_data, 'scaled:scale')
kcFF_scale_values
kcFF_center_values <- attr(kcFF_scaled_data, 'scaled:center')
kcFF_center_values
kcFF_train <- cbind(kcFF_scaled_data, select(kcFF_train, hit:row))

# save levels for factor variables
kcFF_levels_home_team <- levels(kcFF_train$home_team)
kcFF_levels_stand <- levels(kcFF_train$stand)
kcFF_levels_fieldingTeam <- levels(kcFF_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(kcFF_test)

kcFF_test$hit_distance_sc <- (kcFF_test$hit_distance_sc - kcFF_center_values[1]) / kcFF_scale_values[1]

kcFF_test$hit_speed <- (kcFF_test$hit_speed - kcFF_center_values[2]) / kcFF_scale_values[2]

kcFF_test$hit_angle <- (kcFF_test$hit_angle - kcFF_center_values[3]) / kcFF_scale_values[3]

kcFF_test$hc_x <- (kcFF_test$hc_x - kcFF_center_values[4]) / kcFF_scale_values[4]

kcFF_test$hc_y <- (kcFF_test$hc_y - kcFF_center_values[5]) / kcFF_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

kcFF_validate$hit_distance_sc <- (kcFF_validate$hit_distance_sc - kcFF_center_values[1]) / kcFF_scale_values[1]

kcFF_validate$hit_speed <- (kcFF_validate$hit_speed - kcFF_center_values[2]) / kcFF_scale_values[2]

kcFF_validate$hit_angle <- (kcFF_validate$hit_angle - kcFF_center_values[3]) / kcFF_scale_values[3]

kcFF_validate$hc_x <- (kcFF_validate$hc_x - kcFF_center_values[4]) / kcFF_scale_values[4]

kcFF_validate$hc_y <- (kcFF_validate$hc_y - kcFF_center_values[5]) / kcFF_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(kcFF_train)

set.seed(42)
kcFF_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(kcFF_train, -row), ntree = 501, importance = TRUE)

print(kcFF_rf.1)

plot(kcFF_rf.1)

varImpPlot(kcFF_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
kcFF_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(kcFF_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(kcFF_rf.5)

plot(kcFF_rf.5)

varImpPlot(kcFF_rf.5)

kcFF_predict_fit.rf.5 <- data.frame(fits = predict(kcFF_rf.5, kcFF_test, type = "prob")[,2], actuals = kcFF_test$hit)

kcFF_pred.rf.5 <- prediction(kcFF_predict_fit.rf.5$fits, kcFF_predict_fit.rf.5$actuals)

kcFF_roc.pred.rf.5 <- performance(kcFF_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(kcFF_roc.pred.rf.5)
abline(a = 0, b = 1)
kcFF_opt <- opt.cut(kcFF_roc.pred.rf.5, kcFF_pred.rf.5)
kcFF_opt
kcFF_opt <- kcFF_opt[3]
kcFF_predict_fit.rf.5$fits <- with(kcFF_predict_fit.rf.5, ifelse(fits > kcFF_opt, 1, 0)) 

str(kcFF_test)

#kcFF_test$fieldingTeam <- as.character(kcFF_test$fieldingTeam)
#kcFF_test$home_team <- as.character(kcFF_test$home_team)
#kcFF_test$hit <- as.logical(kcFF_test$hit)
#kcFF_test$stand <- as.logical(kcFF_test$stand)
str(kcFF_test)
kcFF_rf.5_confusion_test <- confusionMatrix(model = kcFF_rf.5, x = kcFF_test, y = kcFF_test$hit)
kcFF_rf.5_confusion_validate <- confusionMatrix(model = kcFF_rf.5, x = kcFF_validate, y = kcFF_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


kcFF_test_rows <- kcFF_test$row
kcFF_validate_rows <- kcFF_validate$row
kcFF_pred_data_emp_1 <- ungroup(kcFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFF_test_rows)

kcFF_pred_data_emp <- ungroup(kcFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFF_validate_rows) %>%
	rbind(kcFF_pred_data_emp_1)

kcFF_out_of_training_rows <- kcFF_pred_data_emp$row

kcFF_rf.5_full_out_of_sample_data <- ungroup(kcFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFF_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



kcFF_rf.5_full_out_of_sample_data_scaled <- kcFF_rf.5_full_out_of_sample_data

kcFF_rf.5_full_out_of_sample_data_scaled$hit_speed <- (kcFF_rf.5_full_out_of_sample_data_scaled$hit_speed - kcFF_center_values[2]) / kcFF_scale_values[2]

kcFF_rf.5_full_out_of_sample_data_scaled$hit_angle <- (kcFF_rf.5_full_out_of_sample_data_scaled$hit_angle - kcFF_center_values[3]) / kcFF_scale_values[3]

kcFF_rf.5.prob <- predict(kcFF_rf.5, kcFF_rf.5_full_out_of_sample_data_scaled, type = "response")

kcFF_rf.5_full_out_of_sample_data <- cbind(filter(kcFF_rf.5_full_out_of_sample_data, row %in% kcFF_out_of_training_rows), kcFF_rf.5.prob)

names(kcFF_rf.5_full_out_of_sample_data)[65] <- "fits"
names(kcFF_rf.5_full_out_of_sample_data)

kcFF_rf.5_full_out_of_sample_data_reduced <- kcFF_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

kcFF_rf.5_mean_table <- kcFF_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

kcFF_rf.5_full_out_of_sample_data$type <- with(kcFF_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

kcFF_rf.5_full_out_of_sample_data$hit_label <- with(kcFF_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

kcFF_rf.5_plot1 <- ggplot(kcFF_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcFF_rf.5_plot1

kcFF_rf.5_plot2 <- ggplot(kcFF_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcFF_rf.5_plot2

kcFF_rf.5_plot3 <- ggplot(kcFF_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcFF_rf.5_plot3

kcFF_grid_plot_rf.5 <- grid.arrange(kcFF_rf.5_plot1, kcFF_rf.5_plot2, kcFF_rf.5_plot3, ncol = 3)
kcFF_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

kcFF_test_rows <- kcFF_test$row
kcFF_validate_rows <- kcFF_validate$row
kcFF_pred_data_emp_1 <- ungroup(kcFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFF_test_rows)

kcFF_pred_data_emp <- ungroup(kcFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFF_validate_rows) %>%
	rbind(kcFF_pred_data_emp_1)

kcFF_out_of_training_rows <- kcFF_pred_data_emp$row

kcFF_pred_data_emp <- ungroup(kcFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFF_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

kcFF_pred_data_emp_scaled <- kcFF_pred_data_emp

kcFF_pred_data_emp_scaled$hit_speed <- (kcFF_pred_data_emp_scaled$hit_speed - kcFF_center_values[2]) / kcFF_scale_values[2]

kcFF_pred_data_emp_scaled$hit_angle <- (kcFF_pred_data_emp_scaled$hit_angle - kcFF_center_values[3]) / kcFF_scale_values[3]

kcFF_pred_prob_hit <- predict(kcFF_rf.5, kcFF_pred_data_emp_scaled, type = "prob")[,2]
kcFF_pred_prob_hit_fits <- cbind(kcFF_pred_data_emp, kcFF_pred_prob_hit)

kcFF_pred_prob_hit_fits[,c(1:2)] <- kcFF_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

kcFF_angle_speed_pred <- kcFF_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = kcFF_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nKC-FF Hit Probability\n") + theme_bp_grey()

kcFF_angle_speed_pred --
#####
fsFF$hit_distance_sc <- as.numeric(fsFF$hit_distance_sc, na.rm = TRUE)
fsFF$hit_angle <- as.numeric(fsFF$hit_angle, na.rm = TRUE)
fsFF$hit_speed <- as.numeric(fsFF$hit_speed, na.rm = TRUE)

fsFF$hit <- with(fsFF, ifelse(grepl("Single", fsFF$events), 1,
															ifelse(grepl("Double", fsFF$events), 1,
																		 ifelse(grepl("Triple", fsFF$events), 1, 
																		 			 ifelse(grepl("Home Run", fsFF$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

fsFF$fieldingTeam <- with(fsFF, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[fsFF$hit_distance_sc == "null"] = NA
#fsFF$hit_speed[fsFF$hit_speed == "null"] = NA
#fsFF$hit_angle[fsFF$hit_angle == "null"] = NA

# include row names for unique record identification

fsFF$row <- row.names(fsFF) %>% as.numeric()

# recode stand and home_team as factors

fsFF$stand <- as.factor(fsFF$stand)
fsFF$home_team <- as.factor(fsFF$home_team)


fsFF$game_date <- as.Date(fsFF$game_date)


# subset 

fsFF_working_data <- ungroup(fsFF) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(fsFF_working_data)
str(ungroup(fsFF))
table(fsFF_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

fsFF_working_data <- filter(fsFF_working_data, hc_x != 1, hc_y != 1)
head(fsFF_working_data)

# create training and test sets
# scaled data

set.seed(42)
fsFF_train <- sample_frac(fsFF_working_data, .15, replace = FALSE)
fsFF_split <- setdiff(fsFF_working_data, fsFF_train)
fsFF_test <- sample_frac(fsFF_split, .50, replace = FALSE)
fsFF_validate <- setdiff(fsFF_split, fsFF_test)

nrow(fsFF_train) + nrow(fsFF_test) + nrow(fsFF_validate) == nrow(fsFF_working_data)

with(fsFF_train, table(hit)) %>% prop.table()
with(fsFF_test, table(hit)) %>% prop.table()
with(fsFF_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(fsFF)
##as.numeric(fsFF$hit_distance_sc, fsFF$hit_speed, fsFF$hit_angle)

#fsFF_train$hit_distance_sc <- as.numeric(fsFF_train$hit_distance_sc)
#fsFF_train$hit_speed <- as.numeric(fsFF_train$hit_speed)
#fsFF_train$hit_angle <- as.numeric(fsFF_train$hit_angle)
#View(fsFF_train)
fsFF_scaled_data <- scale(fsFF_train[,c(1:5)])
fsFF_scale_values <- attr(fsFF_scaled_data, 'scaled:scale')
fsFF_scale_values
fsFF_center_values <- attr(fsFF_scaled_data, 'scaled:center')
fsFF_center_values
fsFF_train <- cbind(fsFF_scaled_data, select(fsFF_train, hit:row))

# save levels for factor variables
fsFF_levels_home_team <- levels(fsFF_train$home_team)
fsFF_levels_stand <- levels(fsFF_train$stand)
fsFF_levels_fieldingTeam <- levels(fsFF_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(fsFF_test)

fsFF_test$hit_distance_sc <- (fsFF_test$hit_distance_sc - fsFF_center_values[1]) / fsFF_scale_values[1]

fsFF_test$hit_speed <- (fsFF_test$hit_speed - fsFF_center_values[2]) / fsFF_scale_values[2]

fsFF_test$hit_angle <- (fsFF_test$hit_angle - fsFF_center_values[3]) / fsFF_scale_values[3]

fsFF_test$hc_x <- (fsFF_test$hc_x - fsFF_center_values[4]) / fsFF_scale_values[4]

fsFF_test$hc_y <- (fsFF_test$hc_y - fsFF_center_values[5]) / fsFF_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

fsFF_validate$hit_distance_sc <- (fsFF_validate$hit_distance_sc - fsFF_center_values[1]) / fsFF_scale_values[1]

fsFF_validate$hit_speed <- (fsFF_validate$hit_speed - fsFF_center_values[2]) / fsFF_scale_values[2]

fsFF_validate$hit_angle <- (fsFF_validate$hit_angle - fsFF_center_values[3]) / fsFF_scale_values[3]

fsFF_validate$hc_x <- (fsFF_validate$hc_x - fsFF_center_values[4]) / fsFF_scale_values[4]

fsFF_validate$hc_y <- (fsFF_validate$hc_y - fsFF_center_values[5]) / fsFF_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(fsFF_train)

set.seed(42)
fsFF_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(fsFF_train, -row), ntree = 501, importance = TRUE)

print(fsFF_rf.1)

plot(fsFF_rf.1)

varImpPlot(fsFF_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
fsFF_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(fsFF_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(fsFF_rf.5)

plot(fsFF_rf.5)

varImpPlot(fsFF_rf.5)

fsFF_predict_fit.rf.5 <- data.frame(fits = predict(fsFF_rf.5, fsFF_test, type = "prob")[,2], actuals = fsFF_test$hit)

fsFF_pred.rf.5 <- prediction(fsFF_predict_fit.rf.5$fits, fsFF_predict_fit.rf.5$actuals)

fsFF_roc.pred.rf.5 <- performance(fsFF_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(fsFF_roc.pred.rf.5)
abline(a = 0, b = 1)
fsFF_opt <- opt.cut(fsFF_roc.pred.rf.5, fsFF_pred.rf.5)
fsFF_opt
fsFF_opt <- fsFF_opt[3]
fsFF_predict_fit.rf.5$fits <- with(fsFF_predict_fit.rf.5, ifelse(fits > fsFF_opt, 1, 0)) 

str(fsFF_test)

#fsFF_test$fieldingTeam <- as.character(fsFF_test$fieldingTeam)
#fsFF_test$home_team <- as.character(fsFF_test$home_team)
#fsFF_test$hit <- as.logical(fsFF_test$hit)
#fsFF_test$stand <- as.logical(fsFF_test$stand)
str(fsFF_test)
fsFF_rf.5_confusion_test <- confusionMatrix(model = fsFF_rf.5, x = fsFF_test, y = fsFF_test$hit)
fsFF_rf.5_confusion_validate <- confusionMatrix(model = fsFF_rf.5, x = fsFF_validate, y = fsFF_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


fsFF_test_rows <- fsFF_test$row
fsFF_validate_rows <- fsFF_validate$row
fsFF_pred_data_emp_1 <- ungroup(fsFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsFF_test_rows)

fsFF_pred_data_emp <- ungroup(fsFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsFF_validate_rows) %>%
	rbind(fsFF_pred_data_emp_1)

fsFF_out_of_training_rows <- fsFF_pred_data_emp$row

fsFF_rf.5_full_out_of_sample_data <- ungroup(fsFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsFF_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



fsFF_rf.5_full_out_of_sample_data_scaled <- fsFF_rf.5_full_out_of_sample_data

fsFF_rf.5_full_out_of_sample_data_scaled$hit_speed <- (fsFF_rf.5_full_out_of_sample_data_scaled$hit_speed - fsFF_center_values[2]) / fsFF_scale_values[2]

fsFF_rf.5_full_out_of_sample_data_scaled$hit_angle <- (fsFF_rf.5_full_out_of_sample_data_scaled$hit_angle - fsFF_center_values[3]) / fsFF_scale_values[3]

fsFF_rf.5.prob <- predict(fsFF_rf.5, fsFF_rf.5_full_out_of_sample_data_scaled, type = "response")

fsFF_rf.5_full_out_of_sample_data <- cbind(filter(fsFF_rf.5_full_out_of_sample_data, row %in% fsFF_out_of_training_rows), fsFF_rf.5.prob)

names(fsFF_rf.5_full_out_of_sample_data)[65] <- "fits"
names(fsFF_rf.5_full_out_of_sample_data)

fsFF_rf.5_full_out_of_sample_data_reduced <- fsFF_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

fsFF_rf.5_mean_table <- fsFF_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

fsFF_rf.5_full_out_of_sample_data$type <- with(fsFF_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

fsFF_rf.5_full_out_of_sample_data$hit_label <- with(fsFF_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

fsFF_rf.5_plot1 <- ggplot(fsFF_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsFF_rf.5_plot1

fsFF_rf.5_plot2 <- ggplot(fsFF_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsFF_rf.5_plot2

fsFF_rf.5_plot3 <- ggplot(fsFF_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsFF_rf.5_plot3

fsFF_grid_plot_rf.5 <- grid.arrange(fsFF_rf.5_plot1, fsFF_rf.5_plot2, fsFF_rf.5_plot3, ncol = 3)
fsFF_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

fsFF_test_rows <- fsFF_test$row
fsFF_validate_rows <- fsFF_validate$row
fsFF_pred_data_emp_1 <- ungroup(fsFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsFF_test_rows)

fsFF_pred_data_emp <- ungroup(fsFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsFF_validate_rows) %>%
	rbind(fsFF_pred_data_emp_1)

fsFF_out_of_training_rows <- fsFF_pred_data_emp$row

fsFF_pred_data_emp <- ungroup(fsFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsFF_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

fsFF_pred_data_emp_scaled <- fsFF_pred_data_emp

fsFF_pred_data_emp_scaled$hit_speed <- (fsFF_pred_data_emp_scaled$hit_speed - fsFF_center_values[2]) / fsFF_scale_values[2]

fsFF_pred_data_emp_scaled$hit_angle <- (fsFF_pred_data_emp_scaled$hit_angle - fsFF_center_values[3]) / fsFF_scale_values[3]

fsFF_pred_prob_hit <- predict(fsFF_rf.5, fsFF_pred_data_emp_scaled, type = "prob")[,2]
fsFF_pred_prob_hit_fits <- cbind(fsFF_pred_data_emp, fsFF_pred_prob_hit)

fsFF_pred_prob_hit_fits[,c(1:2)] <- fsFF_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

fsFF_angle_speed_pred <- fsFF_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = fsFF_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFS-FF Hit Probability\n") + theme_bp_grey()

fsFF_angle_speed_pred	
#####
fcFF$hit_distance_sc <- as.numeric(fcFF$hit_distance_sc, na.rm = TRUE)
fcFF$hit_angle <- as.numeric(fcFF$hit_angle, na.rm = TRUE)
fcFF$hit_speed <- as.numeric(fcFF$hit_speed, na.rm = TRUE)

fcFF$hit <- with(fcFF, ifelse(grepl("Single", fcFF$events), 1,
															ifelse(grepl("Double", fcFF$events), 1,
																		 ifelse(grepl("Triple", fcFF$events), 1, 
																		 			 ifelse(grepl("Home Run", fcFF$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

fcFF$fieldingTeam <- with(fcFF, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[fcFF$hit_distance_sc == "null"] = NA
#fcFF$hit_speed[fcFF$hit_speed == "null"] = NA
#fcFF$hit_angle[fcFF$hit_angle == "null"] = NA

# include row names for unique record identification

fcFF$row <- row.names(fcFF) %>% as.numeric()

# recode stand and home_team as factors

fcFF$stand <- as.factor(fcFF$stand)
fcFF$home_team <- as.factor(fcFF$home_team)


fcFF$game_date <- as.Date(fcFF$game_date)


# subset 

fcFF_working_data <- ungroup(fcFF) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(fcFF_working_data)
str(ungroup(fcFF))
table(fcFF_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

fcFF_working_data <- filter(fcFF_working_data, hc_x != 1, hc_y != 1)
head(fcFF_working_data)

# create training and test sets
# scaled data

set.seed(42)
fcFF_train <- sample_frac(fcFF_working_data, .15, replace = FALSE)
fcFF_split <- setdiff(fcFF_working_data, fcFF_train)
fcFF_test <- sample_frac(fcFF_split, .50, replace = FALSE)
fcFF_validate <- setdiff(fcFF_split, fcFF_test)

nrow(fcFF_train) + nrow(fcFF_test) + nrow(fcFF_validate) == nrow(fcFF_working_data)

with(fcFF_train, table(hit)) %>% prop.table()
with(fcFF_test, table(hit)) %>% prop.table()
with(fcFF_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(fcFF)
##as.numeric(fcFF$hit_distance_sc, fcFF$hit_speed, fcFF$hit_angle)

#fcFF_train$hit_distance_sc <- as.numeric(fcFF_train$hit_distance_sc)
#fcFF_train$hit_speed <- as.numeric(fcFF_train$hit_speed)
#fcFF_train$hit_angle <- as.numeric(fcFF_train$hit_angle)
#View(fcFF_train)
fcFF_scaled_data <- scale(fcFF_train[,c(1:5)])
fcFF_scale_values <- attr(fcFF_scaled_data, 'scaled:scale')
fcFF_scale_values
fcFF_center_values <- attr(fcFF_scaled_data, 'scaled:center')
fcFF_center_values
fcFF_train <- cbind(fcFF_scaled_data, select(fcFF_train, hit:row))

# save levels for factor variables
fcFF_levels_home_team <- levels(fcFF_train$home_team)
fcFF_levels_stand <- levels(fcFF_train$stand)
fcFF_levels_fieldingTeam <- levels(fcFF_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(fcFF_test)

fcFF_test$hit_distance_sc <- (fcFF_test$hit_distance_sc - fcFF_center_values[1]) / fcFF_scale_values[1]

fcFF_test$hit_speed <- (fcFF_test$hit_speed - fcFF_center_values[2]) / fcFF_scale_values[2]

fcFF_test$hit_angle <- (fcFF_test$hit_angle - fcFF_center_values[3]) / fcFF_scale_values[3]

fcFF_test$hc_x <- (fcFF_test$hc_x - fcFF_center_values[4]) / fcFF_scale_values[4]

fcFF_test$hc_y <- (fcFF_test$hc_y - fcFF_center_values[5]) / fcFF_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

fcFF_validate$hit_distance_sc <- (fcFF_validate$hit_distance_sc - fcFF_center_values[1]) / fcFF_scale_values[1]

fcFF_validate$hit_speed <- (fcFF_validate$hit_speed - fcFF_center_values[2]) / fcFF_scale_values[2]

fcFF_validate$hit_angle <- (fcFF_validate$hit_angle - fcFF_center_values[3]) / fcFF_scale_values[3]

fcFF_validate$hc_x <- (fcFF_validate$hc_x - fcFF_center_values[4]) / fcFF_scale_values[4]

fcFF_validate$hc_y <- (fcFF_validate$hc_y - fcFF_center_values[5]) / fcFF_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(fcFF_train)

set.seed(42)
fcFF_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(fcFF_train, -row), ntree = 501, importance = TRUE)

print(fcFF_rf.1)

plot(fcFF_rf.1)

varImpPlot(fcFF_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
fcFF_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(fcFF_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(fcFF_rf.5)

plot(fcFF_rf.5)

varImpPlot(fcFF_rf.5)

fcFF_predict_fit.rf.5 <- data.frame(fits = predict(fcFF_rf.5, fcFF_test, type = "prob")[,2], actuals = fcFF_test$hit)

fcFF_pred.rf.5 <- prediction(fcFF_predict_fit.rf.5$fits, fcFF_predict_fit.rf.5$actuals)

fcFF_roc.pred.rf.5 <- performance(fcFF_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(fcFF_roc.pred.rf.5)
abline(a = 0, b = 1)
fcFF_opt <- opt.cut(fcFF_roc.pred.rf.5, fcFF_pred.rf.5)
fcFF_opt
fcFF_opt <- fcFF_opt[3]
fcFF_predict_fit.rf.5$fits <- with(fcFF_predict_fit.rf.5, ifelse(fits > fcFF_opt, 1, 0)) 

str(fcFF_test)

#fcFF_test$fieldingTeam <- as.character(fcFF_test$fieldingTeam)
#fcFF_test$home_team <- as.character(fcFF_test$home_team)
#fcFF_test$hit <- as.logical(fcFF_test$hit)
#fcFF_test$stand <- as.logical(fcFF_test$stand)
str(fcFF_test)
fcFF_rf.5_confusion_test <- confusionMatrix(model = fcFF_rf.5, x = fcFF_test, y = fcFF_test$hit)
fcFF_rf.5_confusion_validate <- confusionMatrix(model = fcFF_rf.5, x = fcFF_validate, y = fcFF_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


fcFF_test_rows <- fcFF_test$row
fcFF_validate_rows <- fcFF_validate$row
fcFF_pred_data_emp_1 <- ungroup(fcFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcFF_test_rows)

fcFF_pred_data_emp <- ungroup(fcFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcFF_validate_rows) %>%
	rbind(fcFF_pred_data_emp_1)

fcFF_out_of_training_rows <- fcFF_pred_data_emp$row

fcFF_rf.5_full_out_of_sample_data <- ungroup(fcFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcFF_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



fcFF_rf.5_full_out_of_sample_data_scaled <- fcFF_rf.5_full_out_of_sample_data

fcFF_rf.5_full_out_of_sample_data_scaled$hit_speed <- (fcFF_rf.5_full_out_of_sample_data_scaled$hit_speed - fcFF_center_values[2]) / fcFF_scale_values[2]

fcFF_rf.5_full_out_of_sample_data_scaled$hit_angle <- (fcFF_rf.5_full_out_of_sample_data_scaled$hit_angle - fcFF_center_values[3]) / fcFF_scale_values[3]

fcFF_rf.5.prob <- predict(fcFF_rf.5, fcFF_rf.5_full_out_of_sample_data_scaled, type = "response")

fcFF_rf.5_full_out_of_sample_data <- cbind(filter(fcFF_rf.5_full_out_of_sample_data, row %in% fcFF_out_of_training_rows), fcFF_rf.5.prob)

names(fcFF_rf.5_full_out_of_sample_data)[65] <- "fits"
names(fcFF_rf.5_full_out_of_sample_data)

fcFF_rf.5_full_out_of_sample_data_reduced <- fcFF_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

fcFF_rf.5_mean_table <- fcFF_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

fcFF_rf.5_full_out_of_sample_data$type <- with(fcFF_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

fcFF_rf.5_full_out_of_sample_data$hit_label <- with(fcFF_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

fcFF_rf.5_plot1 <- ggplot(fcFF_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcFF_rf.5_plot1

fcFF_rf.5_plot2 <- ggplot(fcFF_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcFF_rf.5_plot2

fcFF_rf.5_plot3 <- ggplot(fcFF_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcFF_rf.5_plot3

fcFF_grid_plot_rf.5 <- grid.arrange(fcFF_rf.5_plot1, fcFF_rf.5_plot2, fcFF_rf.5_plot3, ncol = 3)
fcFF_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

fcFF_test_rows <- fcFF_test$row
fcFF_validate_rows <- fcFF_validate$row
fcFF_pred_data_emp_1 <- ungroup(fcFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcFF_test_rows)

fcFF_pred_data_emp <- ungroup(fcFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcFF_validate_rows) %>%
	rbind(fcFF_pred_data_emp_1)

fcFF_out_of_training_rows <- fcFF_pred_data_emp$row

fcFF_pred_data_emp <- ungroup(fcFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcFF_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

fcFF_pred_data_emp_scaled <- fcFF_pred_data_emp

fcFF_pred_data_emp_scaled$hit_speed <- (fcFF_pred_data_emp_scaled$hit_speed - fcFF_center_values[2]) / fcFF_scale_values[2]

fcFF_pred_data_emp_scaled$hit_angle <- (fcFF_pred_data_emp_scaled$hit_angle - fcFF_center_values[3]) / fcFF_scale_values[3]

fcFF_pred_prob_hit <- predict(fcFF_rf.5, fcFF_pred_data_emp_scaled, type = "prob")[,2]
fcFF_pred_prob_hit_fits <- cbind(fcFF_pred_data_emp, fcFF_pred_prob_hit)

fcFF_pred_prob_hit_fits[,c(1:2)] <- fcFF_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

fcFF_angle_speed_pred <- fcFF_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = fcFF_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFC-FF Hit Probability\n") + theme_bp_grey()

fcFF_angle_speed_pred
#####

chFF$hit_distance_sc <- as.numeric(chFF$hit_distance_sc, na.rm = TRUE)
chFF$hit_angle <- as.numeric(chFF$hit_angle, na.rm = TRUE)
chFF$hit_speed <- as.numeric(chFF$hit_speed, na.rm = TRUE)

chFF$hit <- with(chFF, ifelse(grepl("Single", chFF$events), 1,
															ifelse(grepl("Double", chFF$events), 1,
																		 ifelse(grepl("Triple", chFF$events), 1, 
																		 			 ifelse(grepl("Home Run", chFF$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

chFF$fieldingTeam <- with(chFF, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[chFF$hit_distance_sc == "null"] = NA
#chFF$hit_speed[chFF$hit_speed == "null"] = NA
#chFF$hit_angle[chFF$hit_angle == "null"] = NA

# include row names for unique record identification

chFF$row <- row.names(chFF) %>% as.numeric()

# recode stand and home_team as factors

chFF$stand <- as.factor(chFF$stand)
chFF$home_team <- as.factor(chFF$home_team)


chFF$game_date <- as.Date(chFF$game_date)


# subset 

chFF_working_data <- ungroup(chFF) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(chFF_working_data)
str(ungroup(chFF))
table(chFF_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

chFF_working_data <- filter(chFF_working_data, hc_x != 1, hc_y != 1)
head(chFF_working_data)

# create training and test sets
# scaled data

set.seed(42)
chFF_train <- sample_frac(chFF_working_data, .15, replace = FALSE)
chFF_split <- setdiff(chFF_working_data, chFF_train)
chFF_test <- sample_frac(chFF_split, .50, replace = FALSE)
chFF_validate <- setdiff(chFF_split, chFF_test)

nrow(chFF_train) + nrow(chFF_test) + nrow(chFF_validate) == nrow(chFF_working_data)

with(chFF_train, table(hit)) %>% prop.table()
with(chFF_test, table(hit)) %>% prop.table()
with(chFF_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(chFF)
##as.numeric(chFF$hit_distance_sc, chFF$hit_speed, chFF$hit_angle)

#chFF_train$hit_distance_sc <- as.numeric(chFF_train$hit_distance_sc)
#chFF_train$hit_speed <- as.numeric(chFF_train$hit_speed)
#chFF_train$hit_angle <- as.numeric(chFF_train$hit_angle)
#View(chFF_train)
chFF_scaled_data <- scale(chFF_train[,c(1:5)])
chFF_scale_values <- attr(chFF_scaled_data, 'scaled:scale')
chFF_scale_values
chFF_center_values <- attr(chFF_scaled_data, 'scaled:center')
chFF_center_values
chFF_train <- cbind(chFF_scaled_data, select(chFF_train, hit:row))

# save levels for factor variables
chFF_levels_home_team <- levels(chFF_train$home_team)
chFF_levels_stand <- levels(chFF_train$stand)
chFF_levels_fieldingTeam <- levels(chFF_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(chFF_test)

chFF_test$hit_distance_sc <- (chFF_test$hit_distance_sc - chFF_center_values[1]) / chFF_scale_values[1]

chFF_test$hit_speed <- (chFF_test$hit_speed - chFF_center_values[2]) / chFF_scale_values[2]

chFF_test$hit_angle <- (chFF_test$hit_angle - chFF_center_values[3]) / chFF_scale_values[3]

chFF_test$hc_x <- (chFF_test$hc_x - chFF_center_values[4]) / chFF_scale_values[4]

chFF_test$hc_y <- (chFF_test$hc_y - chFF_center_values[5]) / chFF_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

chFF_validate$hit_distance_sc <- (chFF_validate$hit_distance_sc - chFF_center_values[1]) / chFF_scale_values[1]

chFF_validate$hit_speed <- (chFF_validate$hit_speed - chFF_center_values[2]) / chFF_scale_values[2]

chFF_validate$hit_angle <- (chFF_validate$hit_angle - chFF_center_values[3]) / chFF_scale_values[3]

chFF_validate$hc_x <- (chFF_validate$hc_x - chFF_center_values[4]) / chFF_scale_values[4]

chFF_validate$hc_y <- (chFF_validate$hc_y - chFF_center_values[5]) / chFF_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(chFF_train)

set.seed(42)
chFF_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(chFF_train, -row), ntree = 501, importance = TRUE)

print(chFF_rf.1)

plot(chFF_rf.1)

varImpPlot(chFF_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
chFF_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(chFF_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(chFF_rf.5)

plot(chFF_rf.5)

varImpPlot(chFF_rf.5)

chFF_predict_fit.rf.5 <- data.frame(fits = predict(chFF_rf.5, chFF_test, type = "prob")[,2], actuals = chFF_test$hit)

chFF_pred.rf.5 <- prediction(chFF_predict_fit.rf.5$fits, chFF_predict_fit.rf.5$actuals)

chFF_roc.pred.rf.5 <- performance(chFF_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(chFF_roc.pred.rf.5)
abline(a = 0, b = 1)
chFF_opt <- opt.cut(chFF_roc.pred.rf.5, chFF_pred.rf.5)
chFF_opt
chFF_opt <- chFF_opt[3]
chFF_predict_fit.rf.5$fits <- with(chFF_predict_fit.rf.5, ifelse(fits > chFF_opt, 1, 0)) 

str(chFF_test)

#chFF_test$fieldingTeam <- as.character(chFF_test$fieldingTeam)
#chFF_test$home_team <- as.character(chFF_test$home_team)
#chFF_test$hit <- as.logical(chFF_test$hit)
#chFF_test$stand <- as.logical(chFF_test$stand)
str(chFF_test)
chFF_rf.5_confusion_test <- confusionMatrix(model = chFF_rf.5, x = chFF_test, y = chFF_test$hit)
chFF_rf.5_confusion_validate <- confusionMatrix(model = chFF_rf.5, x = chFF_validate, y = chFF_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


chFF_test_rows <- chFF_test$row
chFF_validate_rows <- chFF_validate$row
chFF_pred_data_emp_1 <- ungroup(chFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFF_test_rows)

chFF_pred_data_emp <- ungroup(chFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFF_validate_rows) %>%
	rbind(chFF_pred_data_emp_1)

chFF_out_of_training_rows <- chFF_pred_data_emp$row

chFF_rf.5_full_out_of_sample_data <- ungroup(chFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFF_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



chFF_rf.5_full_out_of_sample_data_scaled <- chFF_rf.5_full_out_of_sample_data

chFF_rf.5_full_out_of_sample_data_scaled$hit_speed <- (chFF_rf.5_full_out_of_sample_data_scaled$hit_speed - chFF_center_values[2]) / chFF_scale_values[2]

chFF_rf.5_full_out_of_sample_data_scaled$hit_angle <- (chFF_rf.5_full_out_of_sample_data_scaled$hit_angle - chFF_center_values[3]) / chFF_scale_values[3]

chFF_rf.5.prob <- predict(chFF_rf.5, chFF_rf.5_full_out_of_sample_data_scaled, type = "response")

chFF_rf.5_full_out_of_sample_data <- cbind(filter(chFF_rf.5_full_out_of_sample_data, row %in% chFF_out_of_training_rows), chFF_rf.5.prob)

names(chFF_rf.5_full_out_of_sample_data)[65] <- "fits"
names(chFF_rf.5_full_out_of_sample_data)

chFF_rf.5_full_out_of_sample_data_reduced <- chFF_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

chFF_rf.5_mean_table <- chFF_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

chFF_rf.5_full_out_of_sample_data$type <- with(chFF_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

chFF_rf.5_full_out_of_sample_data$hit_label <- with(chFF_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

chFF_rf.5_plot1 <- ggplot(chFF_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chFF_rf.5_plot1

chFF_rf.5_plot2 <- ggplot(chFF_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chFF_rf.5_plot2

chFF_rf.5_plot3 <- ggplot(chFF_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chFF_rf.5_plot3

chFF_grid_plot_rf.5 <- grid.arrange(chFF_rf.5_plot1, chFF_rf.5_plot2, chFF_rf.5_plot3, ncol = 3)
chFF_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

chFF_test_rows <- chFF_test$row
chFF_validate_rows <- chFF_validate$row
chFF_pred_data_emp_1 <- ungroup(chFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFF_test_rows)

chFF_pred_data_emp <- ungroup(chFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFF_validate_rows) %>%
	rbind(chFF_pred_data_emp_1)

chFF_out_of_training_rows <- chFF_pred_data_emp$row

chFF_pred_data_emp <- ungroup(chFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFF_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

chFF_pred_data_emp_scaled <- chFF_pred_data_emp

chFF_pred_data_emp_scaled$hit_speed <- (chFF_pred_data_emp_scaled$hit_speed - chFF_center_values[2]) / chFF_scale_values[2]

chFF_pred_data_emp_scaled$hit_angle <- (chFF_pred_data_emp_scaled$hit_angle - chFF_center_values[3]) / chFF_scale_values[3]

chFF_pred_prob_hit <- predict(chFF_rf.5, chFF_pred_data_emp_scaled, type = "prob")[,2]
chFF_pred_prob_hit_fits <- cbind(chFF_pred_data_emp, chFF_pred_prob_hit)

chFF_pred_prob_hit_fits[,c(1:2)] <- chFF_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

chFF_angle_speed_pred <- chFF_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = chFF_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nCH-FF Hit Probability\n") + theme_bp_grey()

chFF_angle_speed_pred
 # CH-FF
#####
ftFF$hit_distance_sc <- as.numeric(ftFF$hit_distance_sc, na.rm = TRUE)
ftFF$hit_angle <- as.numeric(ftFF$hit_angle, na.rm = TRUE)
ftFF$hit_speed <- as.numeric(ftFF$hit_speed, na.rm = TRUE)

ftFF$hit <- with(ftFF, ifelse(grepl("Single", ftFF$events), 1,
															ifelse(grepl("Double", ftFF$events), 1,
																		 ifelse(grepl("Triple", ftFF$events), 1, 
																		 			 ifelse(grepl("Home Run", ftFF$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

ftFF$fieldingTeam <- with(ftFF, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[ftFF$hit_distance_sc == "null"] = NA
#ftFF$hit_speed[ftFF$hit_speed == "null"] = NA
#ftFF$hit_angle[ftFF$hit_angle == "null"] = NA

# include row names for unique record identification

ftFF$row <- row.names(ftFF) %>% as.numeric()

# recode stand and home_team as factors

ftFF$stand <- as.factor(ftFF$stand)
ftFF$home_team <- as.factor(ftFF$home_team)


ftFF$game_date <- as.Date(ftFF$game_date)


# subset 

ftFF_working_data <- ungroup(ftFF) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(ftFF_working_data)
str(ungroup(ftFF))
table(ftFF_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

ftFF_working_data <- filter(ftFF_working_data, hc_x != 1, hc_y != 1)
head(ftFF_working_data)

# create training and test sets
# scaled data

set.seed(42)
ftFF_train <- sample_frac(ftFF_working_data, .15, replace = FALSE)
ftFF_split <- setdiff(ftFF_working_data, ftFF_train)
ftFF_test <- sample_frac(ftFF_split, .50, replace = FALSE)
ftFF_validate <- setdiff(ftFF_split, ftFF_test)

nrow(ftFF_train) + nrow(ftFF_test) + nrow(ftFF_validate) == nrow(ftFF_working_data)

with(ftFF_train, table(hit)) %>% prop.table()
with(ftFF_test, table(hit)) %>% prop.table()
with(ftFF_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(ftFF)
##as.numeric(ftFF$hit_distance_sc, ftFF$hit_speed, ftFF$hit_angle)

#ftFF_train$hit_distance_sc <- as.numeric(ftFF_train$hit_distance_sc)
#ftFF_train$hit_speed <- as.numeric(ftFF_train$hit_speed)
#ftFF_train$hit_angle <- as.numeric(ftFF_train$hit_angle)
#View(ftFF_train)
ftFF_scaled_data <- scale(ftFF_train[,c(1:5)])
ftFF_scale_values <- attr(ftFF_scaled_data, 'scaled:scale')
ftFF_scale_values
ftFF_center_values <- attr(ftFF_scaled_data, 'scaled:center')
ftFF_center_values
ftFF_train <- cbind(ftFF_scaled_data, select(ftFF_train, hit:row))

# save levels for factor variables
ftFF_levels_home_team <- levels(ftFF_train$home_team)
ftFF_levels_stand <- levels(ftFF_train$stand)
ftFF_levels_fieldingTeam <- levels(ftFF_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(ftFF_test)

ftFF_test$hit_distance_sc <- (ftFF_test$hit_distance_sc - ftFF_center_values[1]) / ftFF_scale_values[1]

ftFF_test$hit_speed <- (ftFF_test$hit_speed - ftFF_center_values[2]) / ftFF_scale_values[2]

ftFF_test$hit_angle <- (ftFF_test$hit_angle - ftFF_center_values[3]) / ftFF_scale_values[3]

ftFF_test$hc_x <- (ftFF_test$hc_x - ftFF_center_values[4]) / ftFF_scale_values[4]

ftFF_test$hc_y <- (ftFF_test$hc_y - ftFF_center_values[5]) / ftFF_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

ftFF_validate$hit_distance_sc <- (ftFF_validate$hit_distance_sc - ftFF_center_values[1]) / ftFF_scale_values[1]

ftFF_validate$hit_speed <- (ftFF_validate$hit_speed - ftFF_center_values[2]) / ftFF_scale_values[2]

ftFF_validate$hit_angle <- (ftFF_validate$hit_angle - ftFF_center_values[3]) / ftFF_scale_values[3]

ftFF_validate$hc_x <- (ftFF_validate$hc_x - ftFF_center_values[4]) / ftFF_scale_values[4]

ftFF_validate$hc_y <- (ftFF_validate$hc_y - ftFF_center_values[5]) / ftFF_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(ftFF_train)

set.seed(42)
ftFF_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(ftFF_train, -row), ntree = 501, importance = TRUE)

print(ftFF_rf.1)

plot(ftFF_rf.1)

varImpPlot(ftFF_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
ftFF_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(ftFF_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(ftFF_rf.5)

plot(ftFF_rf.5)

varImpPlot(ftFF_rf.5)

ftFF_predict_fit.rf.5 <- data.frame(fits = predict(ftFF_rf.5, ftFF_test, type = "prob")[,2], actuals = ftFF_test$hit)

ftFF_pred.rf.5 <- prediction(ftFF_predict_fit.rf.5$fits, ftFF_predict_fit.rf.5$actuals)

ftFF_roc.pred.rf.5 <- performance(ftFF_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(ftFF_roc.pred.rf.5)
abline(a = 0, b = 1)
ftFF_opt <- opt.cut(ftFF_roc.pred.rf.5, ftFF_pred.rf.5)
ftFF_opt
ftFF_opt <- ftFF_opt[3]
ftFF_predict_fit.rf.5$fits <- with(ftFF_predict_fit.rf.5, ifelse(fits > ftFF_opt, 1, 0)) 

str(ftFF_test)

#ftFF_test$fieldingTeam <- as.character(ftFF_test$fieldingTeam)
#ftFF_test$home_team <- as.character(ftFF_test$home_team)
#ftFF_test$hit <- as.logical(ftFF_test$hit)
#ftFF_test$stand <- as.logical(ftFF_test$stand)
str(ftFF_test)
ftFF_rf.5_confusion_test <- confusionMatrix(model = ftFF_rf.5, x = ftFF_test, y = ftFF_test$hit)
ftFF_rf.5_confusion_validate <- confusionMatrix(model = ftFF_rf.5, x = ftFF_validate, y = ftFF_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


ftFF_test_rows <- ftFF_test$row
ftFF_validate_rows <- ftFF_validate$row
ftFF_pred_data_emp_1 <- ungroup(ftFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftFF_test_rows)

ftFF_pred_data_emp <- ungroup(ftFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftFF_validate_rows) %>%
	rbind(ftFF_pred_data_emp_1)

ftFF_out_of_training_rows <- ftFF_pred_data_emp$row

ftFF_rf.5_full_out_of_sample_data <- ungroup(ftFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftFF_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



ftFF_rf.5_full_out_of_sample_data_scaled <- ftFF_rf.5_full_out_of_sample_data

ftFF_rf.5_full_out_of_sample_data_scaled$hit_speed <- (ftFF_rf.5_full_out_of_sample_data_scaled$hit_speed - ftFF_center_values[2]) / ftFF_scale_values[2]

ftFF_rf.5_full_out_of_sample_data_scaled$hit_angle <- (ftFF_rf.5_full_out_of_sample_data_scaled$hit_angle - ftFF_center_values[3]) / ftFF_scale_values[3]

ftFF_rf.5.prob <- predict(ftFF_rf.5, ftFF_rf.5_full_out_of_sample_data_scaled, type = "response")

ftFF_rf.5_full_out_of_sample_data <- cbind(filter(ftFF_rf.5_full_out_of_sample_data, row %in% ftFF_out_of_training_rows), ftFF_rf.5.prob)

names(ftFF_rf.5_full_out_of_sample_data)[65] <- "fits"
names(ftFF_rf.5_full_out_of_sample_data)

ftFF_rf.5_full_out_of_sample_data_reduced <- ftFF_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

ftFF_rf.5_mean_table <- ftFF_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

ftFF_rf.5_full_out_of_sample_data$type <- with(ftFF_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

ftFF_rf.5_full_out_of_sample_data$hit_label <- with(ftFF_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

ftFF_rf.5_plot1 <- ggplot(ftFF_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftFF_rf.5_plot1

ftFF_rf.5_plot2 <- ggplot(ftFF_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftFF_rf.5_plot2

ftFF_rf.5_plot3 <- ggplot(ftFF_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftFF_rf.5_plot3

ftFF_grid_plot_rf.5 <- grid.arrange(ftFF_rf.5_plot1, ftFF_rf.5_plot2, ftFF_rf.5_plot3, ncol = 3)
ftFF_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

ftFF_test_rows <- ftFF_test$row
ftFF_validate_rows <- ftFF_validate$row
ftFF_pred_data_emp_1 <- ungroup(ftFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftFF_test_rows)

ftFF_pred_data_emp <- ungroup(ftFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftFF_validate_rows) %>%
	rbind(ftFF_pred_data_emp_1)

ftFF_out_of_training_rows <- ftFF_pred_data_emp$row

ftFF_pred_data_emp <- ungroup(ftFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftFF_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

ftFF_pred_data_emp_scaled <- ftFF_pred_data_emp

ftFF_pred_data_emp_scaled$hit_speed <- (ftFF_pred_data_emp_scaled$hit_speed - ftFF_center_values[2]) / ftFF_scale_values[2]

ftFF_pred_data_emp_scaled$hit_angle <- (ftFF_pred_data_emp_scaled$hit_angle - ftFF_center_values[3]) / ftFF_scale_values[3]

ftFF_pred_prob_hit <- predict(ftFF_rf.5, ftFF_pred_data_emp_scaled, type = "prob")[,2]
ftFF_pred_prob_hit_fits <- cbind(ftFF_pred_data_emp, ftFF_pred_prob_hit)

ftFF_pred_prob_hit_fits[,c(1:2)] <- ftFF_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

ftFF_angle_speed_pred <- ftFF_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = ftFF_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFT-FF Hit Probability\n") + theme_bp_grey()

ftFF_angle_speed_pred
#####

slFF$hit_distance_sc <- as.numeric(slFF$hit_distance_sc, na.rm = TRUE)
slFF$hit_angle <- as.numeric(slFF$hit_angle, na.rm = TRUE)
slFF$hit_speed <- as.numeric(slFF$hit_speed, na.rm = TRUE)

slFF$hit <- with(slFF, ifelse(grepl("Single", slFF$events), 1,
															ifelse(grepl("Double", slFF$events), 1,
																		 ifelse(grepl("Triple", slFF$events), 1, 
																		 			 ifelse(grepl("Home Run", slFF$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

slFF$fieldingTeam <- with(slFF, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[slFF$hit_distance_sc == "null"] = NA
#slFF$hit_speed[slFF$hit_speed == "null"] = NA
#slFF$hit_angle[slFF$hit_angle == "null"] = NA

# include row names for unique record identification

slFF$row <- row.names(slFF) %>% as.numeric()

# recode stand and home_team as factors

slFF$stand <- as.factor(slFF$stand)
slFF$home_team <- as.factor(slFF$home_team)


slFF$game_date <- as.Date(slFF$game_date)


# subset 

slFF_working_data <- ungroup(slFF) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(slFF_working_data)
str(ungroup(slFF))
table(slFF_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

slFF_working_data <- filter(slFF_working_data, hc_x != 1, hc_y != 1)
head(slFF_working_data)

# create training and test sets
# scaled data

set.seed(42)
slFF_train <- sample_frac(slFF_working_data, .15, replace = FALSE)
slFF_split <- setdiff(slFF_working_data, slFF_train)
slFF_test <- sample_frac(slFF_split, .50, replace = FALSE)
slFF_validate <- setdiff(slFF_split, slFF_test)

nrow(slFF_train) + nrow(slFF_test) + nrow(slFF_validate) == nrow(slFF_working_data)

with(slFF_train, table(hit)) %>% prop.table()
with(slFF_test, table(hit)) %>% prop.table()
with(slFF_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(slFF)
##as.numeric(slFF$hit_distance_sc, slFF$hit_speed, slFF$hit_angle)

#slFF_train$hit_distance_sc <- as.numeric(slFF_train$hit_distance_sc)
#slFF_train$hit_speed <- as.numeric(slFF_train$hit_speed)
#slFF_train$hit_angle <- as.numeric(slFF_train$hit_angle)
#View(slFF_train)
slFF_scaled_data <- scale(slFF_train[,c(1:5)])
slFF_scale_values <- attr(slFF_scaled_data, 'scaled:scale')
slFF_scale_values
slFF_center_values <- attr(slFF_scaled_data, 'scaled:center')
slFF_center_values
slFF_train <- cbind(slFF_scaled_data, select(slFF_train, hit:row))

# save levels for factor variables
slFF_levels_home_team <- levels(slFF_train$home_team)
slFF_levels_stand <- levels(slFF_train$stand)
slFF_levels_fieldingTeam <- levels(slFF_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(slFF_test)

slFF_test$hit_distance_sc <- (slFF_test$hit_distance_sc - slFF_center_values[1]) / slFF_scale_values[1]

slFF_test$hit_speed <- (slFF_test$hit_speed - slFF_center_values[2]) / slFF_scale_values[2]

slFF_test$hit_angle <- (slFF_test$hit_angle - slFF_center_values[3]) / slFF_scale_values[3]

slFF_test$hc_x <- (slFF_test$hc_x - slFF_center_values[4]) / slFF_scale_values[4]

slFF_test$hc_y <- (slFF_test$hc_y - slFF_center_values[5]) / slFF_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

slFF_validate$hit_distance_sc <- (slFF_validate$hit_distance_sc - slFF_center_values[1]) / slFF_scale_values[1]

slFF_validate$hit_speed <- (slFF_validate$hit_speed - slFF_center_values[2]) / slFF_scale_values[2]

slFF_validate$hit_angle <- (slFF_validate$hit_angle - slFF_center_values[3]) / slFF_scale_values[3]

slFF_validate$hc_x <- (slFF_validate$hc_x - slFF_center_values[4]) / slFF_scale_values[4]

slFF_validate$hc_y <- (slFF_validate$hc_y - slFF_center_values[5]) / slFF_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(slFF_train)

set.seed(42)
slFF_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(slFF_train, -row), ntree = 501, importance = TRUE)

print(slFF_rf.1)

plot(slFF_rf.1)

varImpPlot(slFF_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
slFF_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(slFF_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(slFF_rf.5)

plot(slFF_rf.5)

varImpPlot(slFF_rf.5)

slFF_predict_fit.rf.5 <- data.frame(fits = predict(slFF_rf.5, slFF_test, type = "prob")[,2], actuals = slFF_test$hit)

slFF_pred.rf.5 <- prediction(slFF_predict_fit.rf.5$fits, slFF_predict_fit.rf.5$actuals)

slFF_roc.pred.rf.5 <- performance(slFF_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(slFF_roc.pred.rf.5)
abline(a = 0, b = 1)
slFF_opt <- opt.cut(slFF_roc.pred.rf.5, slFF_pred.rf.5)
slFF_opt
slFF_opt <- slFF_opt[3]
slFF_predict_fit.rf.5$fits <- with(slFF_predict_fit.rf.5, ifelse(fits > slFF_opt, 1, 0)) 

str(slFF_test)

#slFF_test$fieldingTeam <- as.character(slFF_test$fieldingTeam)
#slFF_test$home_team <- as.character(slFF_test$home_team)
#slFF_test$hit <- as.logical(slFF_test$hit)
#slFF_test$stand <- as.logical(slFF_test$stand)
str(slFF_test)
slFF_rf.5_confusion_test <- confusionMatrix(model = slFF_rf.5, x = slFF_test, y = slFF_test$hit)
slFF_rf.5_confusion_validate <- confusionMatrix(model = slFF_rf.5, x = slFF_validate, y = slFF_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


slFF_test_rows <- slFF_test$row
slFF_validate_rows <- slFF_validate$row
slFF_pred_data_emp_1 <- ungroup(slFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFF_test_rows)

slFF_pred_data_emp <- ungroup(slFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFF_validate_rows) %>%
	rbind(slFF_pred_data_emp_1)

slFF_out_of_training_rows <- slFF_pred_data_emp$row

slFF_rf.5_full_out_of_sample_data <- ungroup(slFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFF_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



slFF_rf.5_full_out_of_sample_data_scaled <- slFF_rf.5_full_out_of_sample_data

slFF_rf.5_full_out_of_sample_data_scaled$hit_speed <- (slFF_rf.5_full_out_of_sample_data_scaled$hit_speed - slFF_center_values[2]) / slFF_scale_values[2]

slFF_rf.5_full_out_of_sample_data_scaled$hit_angle <- (slFF_rf.5_full_out_of_sample_data_scaled$hit_angle - slFF_center_values[3]) / slFF_scale_values[3]

slFF_rf.5.prob <- predict(slFF_rf.5, slFF_rf.5_full_out_of_sample_data_scaled, type = "response")

slFF_rf.5_full_out_of_sample_data <- cbind(filter(slFF_rf.5_full_out_of_sample_data, row %in% slFF_out_of_training_rows), slFF_rf.5.prob)

names(slFF_rf.5_full_out_of_sample_data)[65] <- "fits"
names(slFF_rf.5_full_out_of_sample_data)

slFF_rf.5_full_out_of_sample_data_reduced <- slFF_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

slFF_rf.5_mean_table <- slFF_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

slFF_rf.5_full_out_of_sample_data$type <- with(slFF_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

slFF_rf.5_full_out_of_sample_data$hit_label <- with(slFF_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

slFF_rf.5_plot1 <- ggplot(slFF_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slFF_rf.5_plot1

slFF_rf.5_plot2 <- ggplot(slFF_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slFF_rf.5_plot2

slFF_rf.5_plot3 <- ggplot(slFF_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slFF_rf.5_plot3

slFF_grid_plot_rf.5 <- grid.arrange(slFF_rf.5_plot1, slFF_rf.5_plot2, slFF_rf.5_plot3, ncol = 3)
slFF_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

slFF_test_rows <- slFF_test$row
slFF_validate_rows <- slFF_validate$row
slFF_pred_data_emp_1 <- ungroup(slFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFF_test_rows)

slFF_pred_data_emp <- ungroup(slFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFF_validate_rows) %>%
	rbind(slFF_pred_data_emp_1)

slFF_out_of_training_rows <- slFF_pred_data_emp$row

slFF_pred_data_emp <- ungroup(slFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFF_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

slFF_pred_data_emp_scaled <- slFF_pred_data_emp

slFF_pred_data_emp_scaled$hit_speed <- (slFF_pred_data_emp_scaled$hit_speed - slFF_center_values[2]) / slFF_scale_values[2]

slFF_pred_data_emp_scaled$hit_angle <- (slFF_pred_data_emp_scaled$hit_angle - slFF_center_values[3]) / slFF_scale_values[3]

slFF_pred_prob_hit <- predict(slFF_rf.5, slFF_pred_data_emp_scaled, type = "prob")[,2]
slFF_pred_prob_hit_fits <- cbind(slFF_pred_data_emp, slFF_pred_prob_hit)

slFF_pred_prob_hit_fits[,c(1:2)] <- slFF_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

slFF_angle_speed_pred <- slFF_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = slFF_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nSL-FF Hit Probability\n") + theme_bp_grey()

slFF_angle_speed_pred



#####

cuFF$hit_distance_sc <- as.numeric(cuFF$hit_distance_sc, na.rm = TRUE)
cuFF$hit_angle <- as.numeric(cuFF$hit_angle, na.rm = TRUE)
cuFF$hit_speed <- as.numeric(cuFF$hit_speed, na.rm = TRUE)

cuFF$hit <- with(cuFF, ifelse(grepl("Single", cuFF$events), 1,
															ifelse(grepl("Double", cuFF$events), 1,
																		 ifelse(grepl("Triple", cuFF$events), 1, 
																		 			 ifelse(grepl("Home Run", cuFF$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

cuFF$fieldingTeam <- with(cuFF, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[cuFF$hit_distance_sc == "null"] = NA
#cuFF$hit_speed[cuFF$hit_speed == "null"] = NA
#cuFF$hit_angle[cuFF$hit_angle == "null"] = NA

# include row names for unique record identification

cuFF$row <- row.names(cuFF) %>% as.numeric()

# recode stand and home_team as factors

cuFF$stand <- as.factor(cuFF$stand)
cuFF$home_team <- as.factor(cuFF$home_team)


cuFF$game_date <- as.Date(cuFF$game_date)


# subset 

cuFF_working_data <- ungroup(cuFF) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(cuFF_working_data)
str(ungroup(cuFF))
table(cuFF_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

cuFF_working_data <- filter(cuFF_working_data, hc_x != 1, hc_y != 1)
head(cuFF_working_data)

# create training and test sets
# scaled data

set.seed(42)
cuFF_train <- sample_frac(cuFF_working_data, .15, replace = FALSE)
cuFF_split <- setdiff(cuFF_working_data, cuFF_train)
cuFF_test <- sample_frac(cuFF_split, .50, replace = FALSE)
cuFF_validate <- setdiff(cuFF_split, cuFF_test)

nrow(cuFF_train) + nrow(cuFF_test) + nrow(cuFF_validate) == nrow(cuFF_working_data)

with(cuFF_train, table(hit)) %>% prop.table()
with(cuFF_test, table(hit)) %>% prop.table()
with(cuFF_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(cuFF)
##as.numeric(cuFF$hit_distance_sc, cuFF$hit_speed, cuFF$hit_angle)

#cuFF_train$hit_distance_sc <- as.numeric(cuFF_train$hit_distance_sc)
#cuFF_train$hit_speed <- as.numeric(cuFF_train$hit_speed)
#cuFF_train$hit_angle <- as.numeric(cuFF_train$hit_angle)
#View(cuFF_train)
cuFF_scaled_data <- scale(cuFF_train[,c(1:5)])
cuFF_scale_values <- attr(cuFF_scaled_data, 'scaled:scale')
cuFF_scale_values
cuFF_center_values <- attr(cuFF_scaled_data, 'scaled:center')
cuFF_center_values
cuFF_train <- cbind(cuFF_scaled_data, select(cuFF_train, hit:row))

# save levels for factor variables
cuFF_levels_home_team <- levels(cuFF_train$home_team)
cuFF_levels_stand <- levels(cuFF_train$stand)
cuFF_levels_fieldingTeam <- levels(cuFF_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(cuFF_test)

cuFF_test$hit_distance_sc <- (cuFF_test$hit_distance_sc - cuFF_center_values[1]) / cuFF_scale_values[1]

cuFF_test$hit_speed <- (cuFF_test$hit_speed - cuFF_center_values[2]) / cuFF_scale_values[2]

cuFF_test$hit_angle <- (cuFF_test$hit_angle - cuFF_center_values[3]) / cuFF_scale_values[3]

cuFF_test$hc_x <- (cuFF_test$hc_x - cuFF_center_values[4]) / cuFF_scale_values[4]

cuFF_test$hc_y <- (cuFF_test$hc_y - cuFF_center_values[5]) / cuFF_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

cuFF_validate$hit_distance_sc <- (cuFF_validate$hit_distance_sc - cuFF_center_values[1]) / cuFF_scale_values[1]

cuFF_validate$hit_speed <- (cuFF_validate$hit_speed - cuFF_center_values[2]) / cuFF_scale_values[2]

cuFF_validate$hit_angle <- (cuFF_validate$hit_angle - cuFF_center_values[3]) / cuFF_scale_values[3]

cuFF_validate$hc_x <- (cuFF_validate$hc_x - cuFF_center_values[4]) / cuFF_scale_values[4]

cuFF_validate$hc_y <- (cuFF_validate$hc_y - cuFF_center_values[5]) / cuFF_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(cuFF_train)

set.seed(42)
cuFF_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(cuFF_train, -row), ntree = 501, importance = TRUE)

print(cuFF_rf.1)

plot(cuFF_rf.1)

varImpPlot(cuFF_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
cuFF_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(cuFF_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(cuFF_rf.5)

plot(cuFF_rf.5)

varImpPlot(cuFF_rf.5)

cuFF_predict_fit.rf.5 <- data.frame(fits = predict(cuFF_rf.5, cuFF_test, type = "prob")[,2], actuals = cuFF_test$hit)

cuFF_pred.rf.5 <- prediction(cuFF_predict_fit.rf.5$fits, cuFF_predict_fit.rf.5$actuals)

cuFF_roc.pred.rf.5 <- performance(cuFF_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(cuFF_roc.pred.rf.5)
abline(a = 0, b = 1)
cuFF_opt <- opt.cut(cuFF_roc.pred.rf.5, cuFF_pred.rf.5)
cuFF_opt
cuFF_opt <- cuFF_opt[3]
cuFF_predict_fit.rf.5$fits <- with(cuFF_predict_fit.rf.5, ifelse(fits > cuFF_opt, 1, 0)) 

str(cuFF_test)

#cuFF_test$fieldingTeam <- as.character(cuFF_test$fieldingTeam)
#cuFF_test$home_team <- as.character(cuFF_test$home_team)
#cuFF_test$hit <- as.logical(cuFF_test$hit)
#cuFF_test$stand <- as.logical(cuFF_test$stand)
str(cuFF_test)
cuFF_rf.5_confusion_test <- confusionMatrix(model = cuFF_rf.5, x = cuFF_test, y = cuFF_test$hit)
cuFF_rf.5_confusion_validate <- confusionMatrix(model = cuFF_rf.5, x = cuFF_validate, y = cuFF_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


cuFF_test_rows <- cuFF_test$row
cuFF_validate_rows <- cuFF_validate$row
cuFF_pred_data_emp_1 <- ungroup(cuFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFF_test_rows)

cuFF_pred_data_emp <- ungroup(cuFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFF_validate_rows) %>%
	rbind(cuFF_pred_data_emp_1)

cuFF_out_of_training_rows <- cuFF_pred_data_emp$row

cuFF_rf.5_full_out_of_sample_data <- ungroup(cuFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFF_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



cuFF_rf.5_full_out_of_sample_data_scaled <- cuFF_rf.5_full_out_of_sample_data

cuFF_rf.5_full_out_of_sample_data_scaled$hit_speed <- (cuFF_rf.5_full_out_of_sample_data_scaled$hit_speed - cuFF_center_values[2]) / cuFF_scale_values[2]

cuFF_rf.5_full_out_of_sample_data_scaled$hit_angle <- (cuFF_rf.5_full_out_of_sample_data_scaled$hit_angle - cuFF_center_values[3]) / cuFF_scale_values[3]

cuFF_rf.5.prob <- predict(cuFF_rf.5, cuFF_rf.5_full_out_of_sample_data_scaled, type = "response")

cuFF_rf.5_full_out_of_sample_data <- cbind(filter(cuFF_rf.5_full_out_of_sample_data, row %in% cuFF_out_of_training_rows), cuFF_rf.5.prob)

names(cuFF_rf.5_full_out_of_sample_data)[65] <- "fits"
names(cuFF_rf.5_full_out_of_sample_data)

cuFF_rf.5_full_out_of_sample_data_reduced <- cuFF_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

cuFF_rf.5_mean_table <- cuFF_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

cuFF_rf.5_full_out_of_sample_data$type <- with(cuFF_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

cuFF_rf.5_full_out_of_sample_data$hit_label <- with(cuFF_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

cuFF_rf.5_plot1 <- ggplot(cuFF_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuFF_rf.5_plot1

cuFF_rf.5_plot2 <- ggplot(cuFF_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuFF_rf.5_plot2

cuFF_rf.5_plot3 <- ggplot(cuFF_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuFF_rf.5_plot3

cuFF_grid_plot_rf.5 <- grid.arrange(cuFF_rf.5_plot1, cuFF_rf.5_plot2, cuFF_rf.5_plot3, ncol = 3)
cuFF_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

cuFF_test_rows <- cuFF_test$row
cuFF_validate_rows <- cuFF_validate$row
cuFF_pred_data_emp_1 <- ungroup(cuFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFF_test_rows)

cuFF_pred_data_emp <- ungroup(cuFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFF_validate_rows) %>%
	rbind(cuFF_pred_data_emp_1)

cuFF_out_of_training_rows <- cuFF_pred_data_emp$row

cuFF_pred_data_emp <- ungroup(cuFF) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFF_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

cuFF_pred_data_emp_scaled <- cuFF_pred_data_emp

cuFF_pred_data_emp_scaled$hit_speed <- (cuFF_pred_data_emp_scaled$hit_speed - cuFF_center_values[2]) / cuFF_scale_values[2]

cuFF_pred_data_emp_scaled$hit_angle <- (cuFF_pred_data_emp_scaled$hit_angle - cuFF_center_values[3]) / cuFF_scale_values[3]

cuFF_pred_prob_hit <- predict(cuFF_rf.5, cuFF_pred_data_emp_scaled, type = "prob")[,2]
cuFF_pred_prob_hit_fits <- cbind(cuFF_pred_data_emp, cuFF_pred_prob_hit)

cuFF_pred_prob_hit_fits[,c(1:2)] <- cuFF_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

cuFF_angle_speed_pred <- cuFF_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = cuFF_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nCU-FF Hit Probability\n") + theme_bp_grey()

cuFF_angle_speed_pred
############# End 4-Seam Fastballs; Start 2-Seam Fastballs
########################## Start 2-Seam Fastballs
#####
knFT$hit_distance_sc <- as.numeric(knFT$hit_distance_sc, na.rm = TRUE)
knFT$hit_angle <- as.numeric(knFT$hit_angle, na.rm = TRUE)
knFT$hit_speed <- as.numeric(knFT$hit_speed, na.rm = TRUE)

knFT$hit <- with(knFT, ifelse(grepl("Single", knFT$events), 1,
															ifelse(grepl("Double", knFT$events), 1,
																		 ifelse(grepl("Triple", knFT$events), 1, 
																		 			 ifelse(grepl("Home Run", knFT$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

knFT$fieldingTeam <- with(knFT, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[knFT$hit_distance_sc == "null"] = NA
#knFT$hit_speed[knFT$hit_speed == "null"] = NA
#knFT$hit_angle[knFT$hit_angle == "null"] = NA

# include row names for unique record identification

knFT$row <- row.names(knFT) %>% as.numeric()

# recode stand and home_team as factors

knFT$stand <- as.factor(knFT$stand)
knFT$home_team <- as.factor(knFT$home_team)


knFT$game_date <- as.Date(knFT$game_date)


# subset 

knFT_working_data <- ungroup(knFT) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(knFT_working_data)
str(ungroup(knFT))
table(knFT_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

knFT_working_data <- filter(knFT_working_data, hc_x != 1, hc_y != 1)
head(knFT_working_data)

# create training and test sets
# scaled data

set.seed(42)
knFT_train <- sample_frac(knFT_working_data, .15, replace = FALSE)
knFT_split <- setdiff(knFT_working_data, knFT_train)
knFT_test <- sample_frac(knFT_split, .50, replace = FALSE)
knFT_validate <- setdiff(knFT_split, knFT_test)

nrow(knFT_train) + nrow(knFT_test) + nrow(knFT_validate) == nrow(knFT_working_data)

with(knFT_train, table(hit)) %>% prop.table()
with(knFT_test, table(hit)) %>% prop.table()
with(knFT_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(knFT)
##as.numeric(knFT$hit_distance_sc, knFT$hit_speed, knFT$hit_angle)

#knFT_train$hit_distance_sc <- as.numeric(knFT_train$hit_distance_sc)
#knFT_train$hit_speed <- as.numeric(knFT_train$hit_speed)
#knFT_train$hit_angle <- as.numeric(knFT_train$hit_angle)
#View(knFT_train)
knFT_scaled_data <- scale(knFT_train[,c(1:5)])
knFT_scale_values <- attr(knFT_scaled_data, 'scaled:scale')
knFT_scale_values
knFT_center_values <- attr(knFT_scaled_data, 'scaled:center')
knFT_center_values
knFT_train <- cbind(knFT_scaled_data, select(knFT_train, hit:row))

# save levels for factor variables
knFT_levels_home_team <- levels(knFT_train$home_team)
knFT_levels_stand <- levels(knFT_train$stand)
knFT_levels_fieldingTeam <- levels(knFT_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(knFT_test)

knFT_test$hit_distance_sc <- (knFT_test$hit_distance_sc - knFT_center_values[1]) / knFT_scale_values[1]

knFT_test$hit_speed <- (knFT_test$hit_speed - knFT_center_values[2]) / knFT_scale_values[2]

knFT_test$hit_angle <- (knFT_test$hit_angle - knFT_center_values[3]) / knFT_scale_values[3]

knFT_test$hc_x <- (knFT_test$hc_x - knFT_center_values[4]) / knFT_scale_values[4]

knFT_test$hc_y <- (knFT_test$hc_y - knFT_center_values[5]) / knFT_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

knFT_validate$hit_distance_sc <- (knFT_validate$hit_distance_sc - knFT_center_values[1]) / knFT_scale_values[1]

knFT_validate$hit_speed <- (knFT_validate$hit_speed - knFT_center_values[2]) / knFT_scale_values[2]

knFT_validate$hit_angle <- (knFT_validate$hit_angle - knFT_center_values[3]) / knFT_scale_values[3]

knFT_validate$hc_x <- (knFT_validate$hc_x - knFT_center_values[4]) / knFT_scale_values[4]

knFT_validate$hc_y <- (knFT_validate$hc_y - knFT_center_values[5]) / knFT_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(knFT_train)

set.seed(42)
knFT_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(knFT_train, -row), ntree = 501, importance = TRUE)

print(knFT_rf.1)

plot(knFT_rf.1)

varImpPlot(knFT_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
knFT_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(knFT_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(knFT_rf.5)

plot(knFT_rf.5)

varImpPlot(knFT_rf.5)

knFT_predict_fit.rf.5 <- data.frame(fits = predict(knFT_rf.5, knFT_test, type = "prob")[,2], actuals = knFT_test$hit)

knFT_pred.rf.5 <- prediction(knFT_predict_fit.rf.5$fits, knFT_predict_fit.rf.5$actuals)

knFT_roc.pred.rf.5 <- performance(knFT_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(knFT_roc.pred.rf.5)
abline(a = 0, b = 1)
knFT_opt <- opt.cut(knFT_roc.pred.rf.5, knFT_pred.rf.5)
knFT_opt
knFT_opt <- knFT_opt[3]
knFT_predict_fit.rf.5$fits <- with(knFT_predict_fit.rf.5, ifelse(fits > knFT_opt, 1, 0)) 

str(knFT_test)

#knFT_test$fieldingTeam <- as.character(knFT_test$fieldingTeam)
#knFT_test$home_team <- as.character(knFT_test$home_team)
#knFT_test$hit <- as.logical(knFT_test$hit)
#knFT_test$stand <- as.logical(knFT_test$stand)
str(knFT_test)
knFT_rf.5_confusion_test <- confusionMatrix(model = knFT_rf.5, x = knFT_test, y = knFT_test$hit)
knFT_rf.5_confusion_validate <- confusionMatrix(model = knFT_rf.5, x = knFT_validate, y = knFT_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


knFT_test_rows <- knFT_test$row
knFT_validate_rows <- knFT_validate$row
knFT_pred_data_emp_1 <- ungroup(knFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFT_test_rows)

knFT_pred_data_emp <- ungroup(knFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFT_validate_rows) %>%
	rbind(knFT_pred_data_emp_1)

knFT_out_of_training_rows <- knFT_pred_data_emp$row

knFT_rf.5_full_out_of_sample_data <- ungroup(knFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFT_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



knFT_rf.5_full_out_of_sample_data_scaled <- knFT_rf.5_full_out_of_sample_data

knFT_rf.5_full_out_of_sample_data_scaled$hit_speed <- (knFT_rf.5_full_out_of_sample_data_scaled$hit_speed - knFT_center_values[2]) / knFT_scale_values[2]

knFT_rf.5_full_out_of_sample_data_scaled$hit_angle <- (knFT_rf.5_full_out_of_sample_data_scaled$hit_angle - knFT_center_values[3]) / knFT_scale_values[3]

knFT_rf.5.prob <- predict(knFT_rf.5, knFT_rf.5_full_out_of_sample_data_scaled, type = "response")

knFT_rf.5_full_out_of_sample_data <- cbind(filter(knFT_rf.5_full_out_of_sample_data, row %in% knFT_out_of_training_rows), knFT_rf.5.prob)

names(knFT_rf.5_full_out_of_sample_data)[65] <- "fits"
names(knFT_rf.5_full_out_of_sample_data)

knFT_rf.5_full_out_of_sample_data_reduced <- knFT_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

knFT_rf.5_mean_table <- knFT_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

knFT_rf.5_full_out_of_sample_data$type <- with(knFT_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

knFT_rf.5_full_out_of_sample_data$hit_label <- with(knFT_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

knFT_rf.5_plot1 <- ggplot(knFT_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knFT_rf.5_plot1

knFT_rf.5_plot2 <- ggplot(knFT_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knFT_rf.5_plot2

knFT_rf.5_plot3 <- ggplot(knFT_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knFT_rf.5_plot3

knFT_grid_plot_rf.5 <- grid.arrange(knFT_rf.5_plot1, knFT_rf.5_plot2, knFT_rf.5_plot3, ncol = 3)
knFT_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

knFT_test_rows <- knFT_test$row
knFT_validate_rows <- knFT_validate$row
knFT_pred_data_emp_1 <- ungroup(knFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFT_test_rows)

knFT_pred_data_emp <- ungroup(knFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFT_validate_rows) %>%
	rbind(knFT_pred_data_emp_1)

knFT_out_of_training_rows <- knFT_pred_data_emp$row

knFT_pred_data_emp <- ungroup(knFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFT_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

knFT_pred_data_emp_scaled <- knFT_pred_data_emp

knFT_pred_data_emp_scaled$hit_speed <- (knFT_pred_data_emp_scaled$hit_speed - knFT_center_values[2]) / knFT_scale_values[2]

knFT_pred_data_emp_scaled$hit_angle <- (knFT_pred_data_emp_scaled$hit_angle - knFT_center_values[3]) / knFT_scale_values[3]

knFT_pred_prob_hit <- predict(knFT_rf.5, knFT_pred_data_emp_scaled, type = "prob")[,2]
knFT_pred_prob_hit_fits <- cbind(knFT_pred_data_emp, knFT_pred_prob_hit)

knFT_pred_prob_hit_fits[,c(1:2)] <- knFT_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

knFT_angle_speed_pred <- knFT_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = knFT_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nKN-FT Hit Probability\n") + theme_bp_grey()

knFT_angle_speed_pred
#####

siFT$hit_distance_sc <- as.numeric(siFT$hit_distance_sc, na.rm = TRUE)
siFT$hit_angle <- as.numeric(siFT$hit_angle, na.rm = TRUE)
siFT$hit_speed <- as.numeric(siFT$hit_speed, na.rm = TRUE)

siFT$hit <- with(siFT, ifelse(grepl("Single", siFT$events), 1,
															ifelse(grepl("Double", siFT$events), 1,
																		 ifelse(grepl("Triple", siFT$events), 1, 
																		 			 ifelse(grepl("Home Run", siFT$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

siFT$fieldingTeam <- with(siFT, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[siFT$hit_distance_sc == "null"] = NA
#siFT$hit_speed[siFT$hit_speed == "null"] = NA
#siFT$hit_angle[siFT$hit_angle == "null"] = NA

# include row names for unique record identification

siFT$row <- row.names(siFT) %>% as.numeric()

# recode stand and home_team as factors

siFT$stand <- as.factor(siFT$stand)
siFT$home_team <- as.factor(siFT$home_team)


siFT$game_date <- as.Date(siFT$game_date)


# subset 

siFT_working_data <- ungroup(siFT) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(siFT_working_data)
str(ungroup(siFT))
table(siFT_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

siFT_working_data <- filter(siFT_working_data, hc_x != 1, hc_y != 1)
head(siFT_working_data)

# create training and test sets
# scaled data

set.seed(42)
siFT_train <- sample_frac(siFT_working_data, .15, replace = FALSE)
siFT_split <- setdiff(siFT_working_data, siFT_train)
siFT_test <- sample_frac(siFT_split, .50, replace = FALSE)
siFT_validate <- setdiff(siFT_split, siFT_test)

nrow(siFT_train) + nrow(siFT_test) + nrow(siFT_validate) == nrow(siFT_working_data)

with(siFT_train, table(hit)) %>% prop.table()
with(siFT_test, table(hit)) %>% prop.table()
with(siFT_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(siFT)
##as.numeric(siFT$hit_distance_sc, siFT$hit_speed, siFT$hit_angle)

#siFT_train$hit_distance_sc <- as.numeric(siFT_train$hit_distance_sc)
#siFT_train$hit_speed <- as.numeric(siFT_train$hit_speed)
#siFT_train$hit_angle <- as.numeric(siFT_train$hit_angle)
#View(siFT_train)
siFT_scaled_data <- scale(siFT_train[,c(1:5)])
siFT_scale_values <- attr(siFT_scaled_data, 'scaled:scale')
siFT_scale_values
siFT_center_values <- attr(siFT_scaled_data, 'scaled:center')
siFT_center_values
siFT_train <- cbind(siFT_scaled_data, select(siFT_train, hit:row))

# save levels for factor variables
siFT_levels_home_team <- levels(siFT_train$home_team)
siFT_levels_stand <- levels(siFT_train$stand)
siFT_levels_fieldingTeam <- levels(siFT_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(siFT_test)

siFT_test$hit_distance_sc <- (siFT_test$hit_distance_sc - siFT_center_values[1]) / siFT_scale_values[1]

siFT_test$hit_speed <- (siFT_test$hit_speed - siFT_center_values[2]) / siFT_scale_values[2]

siFT_test$hit_angle <- (siFT_test$hit_angle - siFT_center_values[3]) / siFT_scale_values[3]

siFT_test$hc_x <- (siFT_test$hc_x - siFT_center_values[4]) / siFT_scale_values[4]

siFT_test$hc_y <- (siFT_test$hc_y - siFT_center_values[5]) / siFT_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

siFT_validate$hit_distance_sc <- (siFT_validate$hit_distance_sc - siFT_center_values[1]) / siFT_scale_values[1]

siFT_validate$hit_speed <- (siFT_validate$hit_speed - siFT_center_values[2]) / siFT_scale_values[2]

siFT_validate$hit_angle <- (siFT_validate$hit_angle - siFT_center_values[3]) / siFT_scale_values[3]

siFT_validate$hc_x <- (siFT_validate$hc_x - siFT_center_values[4]) / siFT_scale_values[4]

siFT_validate$hc_y <- (siFT_validate$hc_y - siFT_center_values[5]) / siFT_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(siFT_train)

set.seed(42)
siFT_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(siFT_train, -row), ntree = 501, importance = TRUE)

print(siFT_rf.1)

plot(siFT_rf.1)

varImpPlot(siFT_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
siFT_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(siFT_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(siFT_rf.5)

plot(siFT_rf.5)

varImpPlot(siFT_rf.5)

siFT_predict_fit.rf.5 <- data.frame(fits = predict(siFT_rf.5, siFT_test, type = "prob")[,2], actuals = siFT_test$hit)

siFT_pred.rf.5 <- prediction(siFT_predict_fit.rf.5$fits, siFT_predict_fit.rf.5$actuals)

siFT_roc.pred.rf.5 <- performance(siFT_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(siFT_roc.pred.rf.5)
abline(a = 0, b = 1)
siFT_opt <- opt.cut(siFT_roc.pred.rf.5, siFT_pred.rf.5)
siFT_opt
siFT_opt <- siFT_opt[3]
siFT_predict_fit.rf.5$fits <- with(siFT_predict_fit.rf.5, ifelse(fits > siFT_opt, 1, 0)) 

str(siFT_test)

#siFT_test$fieldingTeam <- as.character(siFT_test$fieldingTeam)
#siFT_test$home_team <- as.character(siFT_test$home_team)
#siFT_test$hit <- as.logical(siFT_test$hit)
#siFT_test$stand <- as.logical(siFT_test$stand)
str(siFT_test)
siFT_rf.5_confusion_test <- confusionMatrix(model = siFT_rf.5, x = siFT_test, y = siFT_test$hit)
siFT_rf.5_confusion_validate <- confusionMatrix(model = siFT_rf.5, x = siFT_validate, y = siFT_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


siFT_test_rows <- siFT_test$row
siFT_validate_rows <- siFT_validate$row
siFT_pred_data_emp_1 <- ungroup(siFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFT_test_rows)

siFT_pred_data_emp <- ungroup(siFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFT_validate_rows) %>%
	rbind(siFT_pred_data_emp_1)

siFT_out_of_training_rows <- siFT_pred_data_emp$row

siFT_rf.5_full_out_of_sample_data <- ungroup(siFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFT_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



siFT_rf.5_full_out_of_sample_data_scaled <- siFT_rf.5_full_out_of_sample_data

siFT_rf.5_full_out_of_sample_data_scaled$hit_speed <- (siFT_rf.5_full_out_of_sample_data_scaled$hit_speed - siFT_center_values[2]) / siFT_scale_values[2]

siFT_rf.5_full_out_of_sample_data_scaled$hit_angle <- (siFT_rf.5_full_out_of_sample_data_scaled$hit_angle - siFT_center_values[3]) / siFT_scale_values[3]

siFT_rf.5.prob <- predict(siFT_rf.5, siFT_rf.5_full_out_of_sample_data_scaled, type = "response")

siFT_rf.5_full_out_of_sample_data <- cbind(filter(siFT_rf.5_full_out_of_sample_data, row %in% siFT_out_of_training_rows), siFT_rf.5.prob)

names(siFT_rf.5_full_out_of_sample_data)[65] <- "fits"
names(siFT_rf.5_full_out_of_sample_data)

siFT_rf.5_full_out_of_sample_data_reduced <- siFT_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

siFT_rf.5_mean_table <- siFT_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

siFT_rf.5_full_out_of_sample_data$type <- with(siFT_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

siFT_rf.5_full_out_of_sample_data$hit_label <- with(siFT_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

siFT_rf.5_plot1 <- ggplot(siFT_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siFT_rf.5_plot1

siFT_rf.5_plot2 <- ggplot(siFT_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siFT_rf.5_plot2

siFT_rf.5_plot3 <- ggplot(siFT_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siFT_rf.5_plot3

siFT_grid_plot_rf.5 <- grid.arrange(siFT_rf.5_plot1, siFT_rf.5_plot2, siFT_rf.5_plot3, ncol = 3)
siFT_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

siFT_test_rows <- siFT_test$row
siFT_validate_rows <- siFT_validate$row
siFT_pred_data_emp_1 <- ungroup(siFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFT_test_rows)

siFT_pred_data_emp <- ungroup(siFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFT_validate_rows) %>%
	rbind(siFT_pred_data_emp_1)

siFT_out_of_training_rows <- siFT_pred_data_emp$row

siFT_pred_data_emp <- ungroup(siFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFT_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

siFT_pred_data_emp_scaled <- siFT_pred_data_emp

siFT_pred_data_emp_scaled$hit_speed <- (siFT_pred_data_emp_scaled$hit_speed - siFT_center_values[2]) / siFT_scale_values[2]

siFT_pred_data_emp_scaled$hit_angle <- (siFT_pred_data_emp_scaled$hit_angle - siFT_center_values[3]) / siFT_scale_values[3]

siFT_pred_prob_hit <- predict(siFT_rf.5, siFT_pred_data_emp_scaled, type = "prob")[,2]
siFT_pred_prob_hit_fits <- cbind(siFT_pred_data_emp, siFT_pred_prob_hit)

siFT_pred_prob_hit_fits[,c(1:2)] <- siFT_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

siFT_angle_speed_pred <- siFT_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = siFT_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nSI-FT Hit Probability\n") + theme_bp_grey()

siFT_angle_speed_pred
#####

kcFT$hit_distance_sc <- as.numeric(kcFT$hit_distance_sc, na.rm = TRUE)
kcFT$hit_angle <- as.numeric(kcFT$hit_angle, na.rm = TRUE)
kcFT$hit_speed <- as.numeric(kcFT$hit_speed, na.rm = TRUE)

kcFT$hit <- with(kcFT, ifelse(grepl("Single", kcFT$events), 1,
															ifelse(grepl("Double", kcFT$events), 1,
																		 ifelse(grepl("Triple", kcFT$events), 1, 
																		 			 ifelse(grepl("Home Run", kcFT$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

kcFT$fieldingTeam <- with(kcFT, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[kcFT$hit_distance_sc == "null"] = NA
#kcFT$hit_speed[kcFT$hit_speed == "null"] = NA
#kcFT$hit_angle[kcFT$hit_angle == "null"] = NA

# include row names for unique record identification

kcFT$row <- row.names(kcFT) %>% as.numeric()

# recode stand and home_team as factors

kcFT$stand <- as.factor(kcFT$stand)
kcFT$home_team <- as.factor(kcFT$home_team)


kcFT$game_date <- as.Date(kcFT$game_date)


# subset 

kcFT_working_data <- ungroup(kcFT) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(kcFT_working_data)
str(ungroup(kcFT))
table(kcFT_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

kcFT_working_data <- filter(kcFT_working_data, hc_x != 1, hc_y != 1)
head(kcFT_working_data)

# create training and test sets
# scaled data

set.seed(42)
kcFT_train <- sample_frac(kcFT_working_data, .15, replace = FALSE)
kcFT_split <- setdiff(kcFT_working_data, kcFT_train)
kcFT_test <- sample_frac(kcFT_split, .50, replace = FALSE)
kcFT_validate <- setdiff(kcFT_split, kcFT_test)

nrow(kcFT_train) + nrow(kcFT_test) + nrow(kcFT_validate) == nrow(kcFT_working_data)

with(kcFT_train, table(hit)) %>% prop.table()
with(kcFT_test, table(hit)) %>% prop.table()
with(kcFT_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(kcFT)
##as.numeric(kcFT$hit_distance_sc, kcFT$hit_speed, kcFT$hit_angle)

#kcFT_train$hit_distance_sc <- as.numeric(kcFT_train$hit_distance_sc)
#kcFT_train$hit_speed <- as.numeric(kcFT_train$hit_speed)
#kcFT_train$hit_angle <- as.numeric(kcFT_train$hit_angle)
#View(kcFT_train)
kcFT_scaled_data <- scale(kcFT_train[,c(1:5)])
kcFT_scale_values <- attr(kcFT_scaled_data, 'scaled:scale')
kcFT_scale_values
kcFT_center_values <- attr(kcFT_scaled_data, 'scaled:center')
kcFT_center_values
kcFT_train <- cbind(kcFT_scaled_data, select(kcFT_train, hit:row))

# save levels for factor variables
kcFT_levels_home_team <- levels(kcFT_train$home_team)
kcFT_levels_stand <- levels(kcFT_train$stand)
kcFT_levels_fieldingTeam <- levels(kcFT_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(kcFT_test)

kcFT_test$hit_distance_sc <- (kcFT_test$hit_distance_sc - kcFT_center_values[1]) / kcFT_scale_values[1]

kcFT_test$hit_speed <- (kcFT_test$hit_speed - kcFT_center_values[2]) / kcFT_scale_values[2]

kcFT_test$hit_angle <- (kcFT_test$hit_angle - kcFT_center_values[3]) / kcFT_scale_values[3]

kcFT_test$hc_x <- (kcFT_test$hc_x - kcFT_center_values[4]) / kcFT_scale_values[4]

kcFT_test$hc_y <- (kcFT_test$hc_y - kcFT_center_values[5]) / kcFT_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

kcFT_validate$hit_distance_sc <- (kcFT_validate$hit_distance_sc - kcFT_center_values[1]) / kcFT_scale_values[1]

kcFT_validate$hit_speed <- (kcFT_validate$hit_speed - kcFT_center_values[2]) / kcFT_scale_values[2]

kcFT_validate$hit_angle <- (kcFT_validate$hit_angle - kcFT_center_values[3]) / kcFT_scale_values[3]

kcFT_validate$hc_x <- (kcFT_validate$hc_x - kcFT_center_values[4]) / kcFT_scale_values[4]

kcFT_validate$hc_y <- (kcFT_validate$hc_y - kcFT_center_values[5]) / kcFT_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(kcFT_train)

set.seed(42)
kcFT_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(kcFT_train, -row), ntree = 501, importance = TRUE)

print(kcFT_rf.1)

plot(kcFT_rf.1)

varImpPlot(kcFT_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
kcFT_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(kcFT_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(kcFT_rf.5)

plot(kcFT_rf.5)

varImpPlot(kcFT_rf.5)

kcFT_predict_fit.rf.5 <- data.frame(fits = predict(kcFT_rf.5, kcFT_test, type = "prob")[,2], actuals = kcFT_test$hit)

kcFT_pred.rf.5 <- prediction(kcFT_predict_fit.rf.5$fits, kcFT_predict_fit.rf.5$actuals)

kcFT_roc.pred.rf.5 <- performance(kcFT_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(kcFT_roc.pred.rf.5)
abline(a = 0, b = 1)
kcFT_opt <- opt.cut(kcFT_roc.pred.rf.5, kcFT_pred.rf.5)
kcFT_opt
kcFT_opt <- kcFT_opt[3]
kcFT_predict_fit.rf.5$fits <- with(kcFT_predict_fit.rf.5, ifelse(fits > kcFT_opt, 1, 0)) 

str(kcFT_test)

#kcFT_test$fieldingTeam <- as.character(kcFT_test$fieldingTeam)
#kcFT_test$home_team <- as.character(kcFT_test$home_team)
#kcFT_test$hit <- as.logical(kcFT_test$hit)
#kcFT_test$stand <- as.logical(kcFT_test$stand)
str(kcFT_test)
kcFT_rf.5_confusion_test <- confusionMatrix(model = kcFT_rf.5, x = kcFT_test, y = kcFT_test$hit)
kcFT_rf.5_confusion_validate <- confusionMatrix(model = kcFT_rf.5, x = kcFT_validate, y = kcFT_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


kcFT_test_rows <- kcFT_test$row
kcFT_validate_rows <- kcFT_validate$row
kcFT_pred_data_emp_1 <- ungroup(kcFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFT_test_rows)

kcFT_pred_data_emp <- ungroup(kcFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFT_validate_rows) %>%
	rbind(kcFT_pred_data_emp_1)

kcFT_out_of_training_rows <- kcFT_pred_data_emp$row

kcFT_rf.5_full_out_of_sample_data <- ungroup(kcFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFT_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



kcFT_rf.5_full_out_of_sample_data_scaled <- kcFT_rf.5_full_out_of_sample_data

kcFT_rf.5_full_out_of_sample_data_scaled$hit_speed <- (kcFT_rf.5_full_out_of_sample_data_scaled$hit_speed - kcFT_center_values[2]) / kcFT_scale_values[2]

kcFT_rf.5_full_out_of_sample_data_scaled$hit_angle <- (kcFT_rf.5_full_out_of_sample_data_scaled$hit_angle - kcFT_center_values[3]) / kcFT_scale_values[3]

kcFT_rf.5.prob <- predict(kcFT_rf.5, kcFT_rf.5_full_out_of_sample_data_scaled, type = "response")

kcFT_rf.5_full_out_of_sample_data <- cbind(filter(kcFT_rf.5_full_out_of_sample_data, row %in% kcFT_out_of_training_rows), kcFT_rf.5.prob)

names(kcFT_rf.5_full_out_of_sample_data)[65] <- "fits"
names(kcFT_rf.5_full_out_of_sample_data)

kcFT_rf.5_full_out_of_sample_data_reduced <- kcFT_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

kcFT_rf.5_mean_table <- kcFT_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

kcFT_rf.5_full_out_of_sample_data$type <- with(kcFT_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

kcFT_rf.5_full_out_of_sample_data$hit_label <- with(kcFT_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

kcFT_rf.5_plot1 <- ggplot(kcFT_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcFT_rf.5_plot1

kcFT_rf.5_plot2 <- ggplot(kcFT_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcFT_rf.5_plot2

kcFT_rf.5_plot3 <- ggplot(kcFT_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcFT_rf.5_plot3

kcFT_grid_plot_rf.5 <- grid.arrange(kcFT_rf.5_plot1, kcFT_rf.5_plot2, kcFT_rf.5_plot3, ncol = 3)
kcFT_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

kcFT_test_rows <- kcFT_test$row
kcFT_validate_rows <- kcFT_validate$row
kcFT_pred_data_emp_1 <- ungroup(kcFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFT_test_rows)

kcFT_pred_data_emp <- ungroup(kcFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFT_validate_rows) %>%
	rbind(kcFT_pred_data_emp_1)

kcFT_out_of_training_rows <- kcFT_pred_data_emp$row

kcFT_pred_data_emp <- ungroup(kcFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFT_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

kcFT_pred_data_emp_scaled <- kcFT_pred_data_emp

kcFT_pred_data_emp_scaled$hit_speed <- (kcFT_pred_data_emp_scaled$hit_speed - kcFT_center_values[2]) / kcFT_scale_values[2]

kcFT_pred_data_emp_scaled$hit_angle <- (kcFT_pred_data_emp_scaled$hit_angle - kcFT_center_values[3]) / kcFT_scale_values[3]

kcFT_pred_prob_hit <- predict(kcFT_rf.5, kcFT_pred_data_emp_scaled, type = "prob")[,2]
kcFT_pred_prob_hit_fits <- cbind(kcFT_pred_data_emp, kcFT_pred_prob_hit)

kcFT_pred_prob_hit_fits[,c(1:2)] <- kcFT_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

kcFT_angle_speed_pred <- kcFT_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = kcFT_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nKC-FT Hit Probability\n") + theme_bp_grey()

kcFT_angle_speed_pred
#####

fsFT$hit_distance_sc <- as.numeric(fsFT$hit_distance_sc, na.rm = TRUE)
fsFT$hit_angle <- as.numeric(fsFT$hit_angle, na.rm = TRUE)
fsFT$hit_speed <- as.numeric(fsFT$hit_speed, na.rm = TRUE)

fsFT$hit <- with(fsFT, ifelse(grepl("Single", fsFT$events), 1,
															ifelse(grepl("Double", fsFT$events), 1,
																		 ifelse(grepl("Triple", fsFT$events), 1, 
																		 			 ifelse(grepl("Home Run", fsFT$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

fsFT$fieldingTeam <- with(fsFT, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[fsFT$hit_distance_sc == "null"] = NA
#fsFT$hit_speed[fsFT$hit_speed == "null"] = NA
#fsFT$hit_angle[fsFT$hit_angle == "null"] = NA

# include row names for unique record identification

fsFT$row <- row.names(fsFT) %>% as.numeric()

# recode stand and home_team as factors

fsFT$stand <- as.factor(fsFT$stand)
fsFT$home_team <- as.factor(fsFT$home_team)


fsFT$game_date <- as.Date(fsFT$game_date)


# subset 

fsFT_working_data <- ungroup(fsFT) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(fsFT_working_data)
str(ungroup(fsFT))
table(fsFT_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

fsFT_working_data <- filter(fsFT_working_data, hc_x != 1, hc_y != 1)
head(fsFT_working_data)

# create training and test sets
# scaled data

set.seed(42)
fsFT_train <- sample_frac(fsFT_working_data, .15, replace = FALSE)
fsFT_split <- setdiff(fsFT_working_data, fsFT_train)
fsFT_test <- sample_frac(fsFT_split, .50, replace = FALSE)
fsFT_validate <- setdiff(fsFT_split, fsFT_test)

nrow(fsFT_train) + nrow(fsFT_test) + nrow(fsFT_validate) == nrow(fsFT_working_data)

with(fsFT_train, table(hit)) %>% prop.table()
with(fsFT_test, table(hit)) %>% prop.table()
with(fsFT_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(fsFT)
##as.numeric(fsFT$hit_distance_sc, fsFT$hit_speed, fsFT$hit_angle)

#fsFT_train$hit_distance_sc <- as.numeric(fsFT_train$hit_distance_sc)
#fsFT_train$hit_speed <- as.numeric(fsFT_train$hit_speed)
#fsFT_train$hit_angle <- as.numeric(fsFT_train$hit_angle)
#View(fsFT_train)
fsFT_scaled_data <- scale(fsFT_train[,c(1:5)])
fsFT_scale_values <- attr(fsFT_scaled_data, 'scaled:scale')
fsFT_scale_values
fsFT_center_values <- attr(fsFT_scaled_data, 'scaled:center')
fsFT_center_values
fsFT_train <- cbind(fsFT_scaled_data, select(fsFT_train, hit:row))

# save levels for factor variables
fsFT_levels_home_team <- levels(fsFT_train$home_team)
fsFT_levels_stand <- levels(fsFT_train$stand)
fsFT_levels_fieldingTeam <- levels(fsFT_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(fsFT_test)

fsFT_test$hit_distance_sc <- (fsFT_test$hit_distance_sc - fsFT_center_values[1]) / fsFT_scale_values[1]

fsFT_test$hit_speed <- (fsFT_test$hit_speed - fsFT_center_values[2]) / fsFT_scale_values[2]

fsFT_test$hit_angle <- (fsFT_test$hit_angle - fsFT_center_values[3]) / fsFT_scale_values[3]

fsFT_test$hc_x <- (fsFT_test$hc_x - fsFT_center_values[4]) / fsFT_scale_values[4]

fsFT_test$hc_y <- (fsFT_test$hc_y - fsFT_center_values[5]) / fsFT_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

fsFT_validate$hit_distance_sc <- (fsFT_validate$hit_distance_sc - fsFT_center_values[1]) / fsFT_scale_values[1]

fsFT_validate$hit_speed <- (fsFT_validate$hit_speed - fsFT_center_values[2]) / fsFT_scale_values[2]

fsFT_validate$hit_angle <- (fsFT_validate$hit_angle - fsFT_center_values[3]) / fsFT_scale_values[3]

fsFT_validate$hc_x <- (fsFT_validate$hc_x - fsFT_center_values[4]) / fsFT_scale_values[4]

fsFT_validate$hc_y <- (fsFT_validate$hc_y - fsFT_center_values[5]) / fsFT_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(fsFT_train)

set.seed(42)
fsFT_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(fsFT_train, -row), ntree = 501, importance = TRUE)

print(fsFT_rf.1)

plot(fsFT_rf.1)

varImpPlot(fsFT_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
fsFT_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(fsFT_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(fsFT_rf.5)

plot(fsFT_rf.5)

varImpPlot(fsFT_rf.5)

fsFT_predict_fit.rf.5 <- data.frame(fits = predict(fsFT_rf.5, fsFT_test, type = "prob")[,2], actuals = fsFT_test$hit)

fsFT_pred.rf.5 <- prediction(fsFT_predict_fit.rf.5$fits, fsFT_predict_fit.rf.5$actuals)

fsFT_roc.pred.rf.5 <- performance(fsFT_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(fsFT_roc.pred.rf.5)
abline(a = 0, b = 1)
fsFT_opt <- opt.cut(fsFT_roc.pred.rf.5, fsFT_pred.rf.5)
fsFT_opt
fsFT_opt <- fsFT_opt[3]
fsFT_predict_fit.rf.5$fits <- with(fsFT_predict_fit.rf.5, ifelse(fits > fsFT_opt, 1, 0)) 

str(fsFT_test)

#fsFT_test$fieldingTeam <- as.character(fsFT_test$fieldingTeam)
#fsFT_test$home_team <- as.character(fsFT_test$home_team)
#fsFT_test$hit <- as.logical(fsFT_test$hit)
#fsFT_test$stand <- as.logical(fsFT_test$stand)
str(fsFT_test)
fsFT_rf.5_confusion_test <- confusionMatrix(model = fsFT_rf.5, x = fsFT_test, y = fsFT_test$hit)
fsFT_rf.5_confusion_validate <- confusionMatrix(model = fsFT_rf.5, x = fsFT_validate, y = fsFT_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


fsFT_test_rows <- fsFT_test$row
fsFT_validate_rows <- fsFT_validate$row
fsFT_pred_data_emp_1 <- ungroup(fsFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsFT_test_rows)

fsFT_pred_data_emp <- ungroup(fsFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsFT_validate_rows) %>%
	rbind(fsFT_pred_data_emp_1)

fsFT_out_of_training_rows <- fsFT_pred_data_emp$row

fsFT_rf.5_full_out_of_sample_data <- ungroup(fsFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsFT_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



fsFT_rf.5_full_out_of_sample_data_scaled <- fsFT_rf.5_full_out_of_sample_data

fsFT_rf.5_full_out_of_sample_data_scaled$hit_speed <- (fsFT_rf.5_full_out_of_sample_data_scaled$hit_speed - fsFT_center_values[2]) / fsFT_scale_values[2]

fsFT_rf.5_full_out_of_sample_data_scaled$hit_angle <- (fsFT_rf.5_full_out_of_sample_data_scaled$hit_angle - fsFT_center_values[3]) / fsFT_scale_values[3]

fsFT_rf.5.prob <- predict(fsFT_rf.5, fsFT_rf.5_full_out_of_sample_data_scaled, type = "response")

fsFT_rf.5_full_out_of_sample_data <- cbind(filter(fsFT_rf.5_full_out_of_sample_data, row %in% fsFT_out_of_training_rows), fsFT_rf.5.prob)

names(fsFT_rf.5_full_out_of_sample_data)[65] <- "fits"
names(fsFT_rf.5_full_out_of_sample_data)

fsFT_rf.5_full_out_of_sample_data_reduced <- fsFT_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

fsFT_rf.5_mean_table <- fsFT_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

fsFT_rf.5_full_out_of_sample_data$type <- with(fsFT_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

fsFT_rf.5_full_out_of_sample_data$hit_label <- with(fsFT_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

fsFT_rf.5_plot1 <- ggplot(fsFT_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsFT_rf.5_plot1

fsFT_rf.5_plot2 <- ggplot(fsFT_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsFT_rf.5_plot2

fsFT_rf.5_plot3 <- ggplot(fsFT_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsFT_rf.5_plot3

fsFT_grid_plot_rf.5 <- grid.arrange(fsFT_rf.5_plot1, fsFT_rf.5_plot2, fsFT_rf.5_plot3, ncol = 3)
fsFT_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

fsFT_test_rows <- fsFT_test$row
fsFT_validate_rows <- fsFT_validate$row
fsFT_pred_data_emp_1 <- ungroup(fsFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsFT_test_rows)

fsFT_pred_data_emp <- ungroup(fsFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsFT_validate_rows) %>%
	rbind(fsFT_pred_data_emp_1)

fsFT_out_of_training_rows <- fsFT_pred_data_emp$row

fsFT_pred_data_emp <- ungroup(fsFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsFT_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

fsFT_pred_data_emp_scaled <- fsFT_pred_data_emp

fsFT_pred_data_emp_scaled$hit_speed <- (fsFT_pred_data_emp_scaled$hit_speed - fsFT_center_values[2]) / fsFT_scale_values[2]

fsFT_pred_data_emp_scaled$hit_angle <- (fsFT_pred_data_emp_scaled$hit_angle - fsFT_center_values[3]) / fsFT_scale_values[3]

fsFT_pred_prob_hit <- predict(fsFT_rf.5, fsFT_pred_data_emp_scaled, type = "prob")[,2]
fsFT_pred_prob_hit_fits <- cbind(fsFT_pred_data_emp, fsFT_pred_prob_hit)

fsFT_pred_prob_hit_fits[,c(1:2)] <- fsFT_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

fsFT_angle_speed_pred <- fsFT_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = fsFT_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFS-FT Hit Probability\n") + theme_bp_grey()

fsFT_angle_speed_pred
#####
fcFT$hit_distance_sc <- as.numeric(fcFT$hit_distance_sc, na.rm = TRUE)
fcFT$hit_angle <- as.numeric(fcFT$hit_angle, na.rm = TRUE)
fcFT$hit_speed <- as.numeric(fcFT$hit_speed, na.rm = TRUE)

fcFT$hit <- with(fcFT, ifelse(grepl("Single", fcFT$events), 1,
															ifelse(grepl("Double", fcFT$events), 1,
																		 ifelse(grepl("Triple", fcFT$events), 1, 
																		 			 ifelse(grepl("Home Run", fcFT$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

fcFT$fieldingTeam <- with(fcFT, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[fcFT$hit_distance_sc == "null"] = NA
#fcFT$hit_speed[fcFT$hit_speed == "null"] = NA
#fcFT$hit_angle[fcFT$hit_angle == "null"] = NA

# include row names for unique record identification

fcFT$row <- row.names(fcFT) %>% as.numeric()

# recode stand and home_team as factors

fcFT$stand <- as.factor(fcFT$stand)
fcFT$home_team <- as.factor(fcFT$home_team)


fcFT$game_date <- as.Date(fcFT$game_date)


# subset 

fcFT_working_data <- ungroup(fcFT) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(fcFT_working_data)
str(ungroup(fcFT))
table(fcFT_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

fcFT_working_data <- filter(fcFT_working_data, hc_x != 1, hc_y != 1)
head(fcFT_working_data)

# create training and test sets
# scaled data

set.seed(42)
fcFT_train <- sample_frac(fcFT_working_data, .15, replace = FALSE)
fcFT_split <- setdiff(fcFT_working_data, fcFT_train)
fcFT_test <- sample_frac(fcFT_split, .50, replace = FALSE)
fcFT_validate <- setdiff(fcFT_split, fcFT_test)

nrow(fcFT_train) + nrow(fcFT_test) + nrow(fcFT_validate) == nrow(fcFT_working_data)

with(fcFT_train, table(hit)) %>% prop.table()
with(fcFT_test, table(hit)) %>% prop.table()
with(fcFT_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(fcFT)
##as.numeric(fcFT$hit_distance_sc, fcFT$hit_speed, fcFT$hit_angle)

#fcFT_train$hit_distance_sc <- as.numeric(fcFT_train$hit_distance_sc)
#fcFT_train$hit_speed <- as.numeric(fcFT_train$hit_speed)
#fcFT_train$hit_angle <- as.numeric(fcFT_train$hit_angle)
#View(fcFT_train)
fcFT_scaled_data <- scale(fcFT_train[,c(1:5)])
fcFT_scale_values <- attr(fcFT_scaled_data, 'scaled:scale')
fcFT_scale_values
fcFT_center_values <- attr(fcFT_scaled_data, 'scaled:center')
fcFT_center_values
fcFT_train <- cbind(fcFT_scaled_data, select(fcFT_train, hit:row))

# save levels for factor variables
fcFT_levels_home_team <- levels(fcFT_train$home_team)
fcFT_levels_stand <- levels(fcFT_train$stand)
fcFT_levels_fieldingTeam <- levels(fcFT_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(fcFT_test)

fcFT_test$hit_distance_sc <- (fcFT_test$hit_distance_sc - fcFT_center_values[1]) / fcFT_scale_values[1]

fcFT_test$hit_speed <- (fcFT_test$hit_speed - fcFT_center_values[2]) / fcFT_scale_values[2]

fcFT_test$hit_angle <- (fcFT_test$hit_angle - fcFT_center_values[3]) / fcFT_scale_values[3]

fcFT_test$hc_x <- (fcFT_test$hc_x - fcFT_center_values[4]) / fcFT_scale_values[4]

fcFT_test$hc_y <- (fcFT_test$hc_y - fcFT_center_values[5]) / fcFT_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

fcFT_validate$hit_distance_sc <- (fcFT_validate$hit_distance_sc - fcFT_center_values[1]) / fcFT_scale_values[1]

fcFT_validate$hit_speed <- (fcFT_validate$hit_speed - fcFT_center_values[2]) / fcFT_scale_values[2]

fcFT_validate$hit_angle <- (fcFT_validate$hit_angle - fcFT_center_values[3]) / fcFT_scale_values[3]

fcFT_validate$hc_x <- (fcFT_validate$hc_x - fcFT_center_values[4]) / fcFT_scale_values[4]

fcFT_validate$hc_y <- (fcFT_validate$hc_y - fcFT_center_values[5]) / fcFT_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(fcFT_train)

set.seed(42)
fcFT_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(fcFT_train, -row), ntree = 501, importance = TRUE)

print(fcFT_rf.1)

plot(fcFT_rf.1)

varImpPlot(fcFT_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
fcFT_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(fcFT_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(fcFT_rf.5)

plot(fcFT_rf.5)

varImpPlot(fcFT_rf.5)

fcFT_predict_fit.rf.5 <- data.frame(fits = predict(fcFT_rf.5, fcFT_test, type = "prob")[,2], actuals = fcFT_test$hit)

fcFT_pred.rf.5 <- prediction(fcFT_predict_fit.rf.5$fits, fcFT_predict_fit.rf.5$actuals)

fcFT_roc.pred.rf.5 <- performance(fcFT_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(fcFT_roc.pred.rf.5)
abline(a = 0, b = 1)
fcFT_opt <- opt.cut(fcFT_roc.pred.rf.5, fcFT_pred.rf.5)
fcFT_opt
fcFT_opt <- fcFT_opt[3]
fcFT_predict_fit.rf.5$fits <- with(fcFT_predict_fit.rf.5, ifelse(fits > fcFT_opt, 1, 0)) 

str(fcFT_test)

#fcFT_test$fieldingTeam <- as.character(fcFT_test$fieldingTeam)
#fcFT_test$home_team <- as.character(fcFT_test$home_team)
#fcFT_test$hit <- as.logical(fcFT_test$hit)
#fcFT_test$stand <- as.logical(fcFT_test$stand)
str(fcFT_test)
fcFT_rf.5_confusion_test <- confusionMatrix(model = fcFT_rf.5, x = fcFT_test, y = fcFT_test$hit)
fcFT_rf.5_confusion_validate <- confusionMatrix(model = fcFT_rf.5, x = fcFT_validate, y = fcFT_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


fcFT_test_rows <- fcFT_test$row
fcFT_validate_rows <- fcFT_validate$row
fcFT_pred_data_emp_1 <- ungroup(fcFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcFT_test_rows)

fcFT_pred_data_emp <- ungroup(fcFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcFT_validate_rows) %>%
	rbind(fcFT_pred_data_emp_1)

fcFT_out_of_training_rows <- fcFT_pred_data_emp$row

fcFT_rf.5_full_out_of_sample_data <- ungroup(fcFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcFT_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



fcFT_rf.5_full_out_of_sample_data_scaled <- fcFT_rf.5_full_out_of_sample_data

fcFT_rf.5_full_out_of_sample_data_scaled$hit_speed <- (fcFT_rf.5_full_out_of_sample_data_scaled$hit_speed - fcFT_center_values[2]) / fcFT_scale_values[2]

fcFT_rf.5_full_out_of_sample_data_scaled$hit_angle <- (fcFT_rf.5_full_out_of_sample_data_scaled$hit_angle - fcFT_center_values[3]) / fcFT_scale_values[3]

fcFT_rf.5.prob <- predict(fcFT_rf.5, fcFT_rf.5_full_out_of_sample_data_scaled, type = "response")

fcFT_rf.5_full_out_of_sample_data <- cbind(filter(fcFT_rf.5_full_out_of_sample_data, row %in% fcFT_out_of_training_rows), fcFT_rf.5.prob)

names(fcFT_rf.5_full_out_of_sample_data)[65] <- "fits"
names(fcFT_rf.5_full_out_of_sample_data)

fcFT_rf.5_full_out_of_sample_data_reduced <- fcFT_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

fcFT_rf.5_mean_table <- fcFT_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

fcFT_rf.5_full_out_of_sample_data$type <- with(fcFT_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

fcFT_rf.5_full_out_of_sample_data$hit_label <- with(fcFT_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

fcFT_rf.5_plot1 <- ggplot(fcFT_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcFT_rf.5_plot1

fcFT_rf.5_plot2 <- ggplot(fcFT_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcFT_rf.5_plot2

fcFT_rf.5_plot3 <- ggplot(fcFT_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcFT_rf.5_plot3

fcFT_grid_plot_rf.5 <- grid.arrange(fcFT_rf.5_plot1, fcFT_rf.5_plot2, fcFT_rf.5_plot3, ncol = 3)
fcFT_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

fcFT_test_rows <- fcFT_test$row
fcFT_validate_rows <- fcFT_validate$row
fcFT_pred_data_emp_1 <- ungroup(fcFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcFT_test_rows)

fcFT_pred_data_emp <- ungroup(fcFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcFT_validate_rows) %>%
	rbind(fcFT_pred_data_emp_1)

fcFT_out_of_training_rows <- fcFT_pred_data_emp$row

fcFT_pred_data_emp <- ungroup(fcFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcFT_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

fcFT_pred_data_emp_scaled <- fcFT_pred_data_emp

fcFT_pred_data_emp_scaled$hit_speed <- (fcFT_pred_data_emp_scaled$hit_speed - fcFT_center_values[2]) / fcFT_scale_values[2]

fcFT_pred_data_emp_scaled$hit_angle <- (fcFT_pred_data_emp_scaled$hit_angle - fcFT_center_values[3]) / fcFT_scale_values[3]

fcFT_pred_prob_hit <- predict(fcFT_rf.5, fcFT_pred_data_emp_scaled, type = "prob")[,2]
fcFT_pred_prob_hit_fits <- cbind(fcFT_pred_data_emp, fcFT_pred_prob_hit)

fcFT_pred_prob_hit_fits[,c(1:2)] <- fcFT_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

fcFT_angle_speed_pred <- fcFT_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = fcFT_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFC-FT Hit Probability\n") + theme_bp_grey()

fcFT_angle_speed_pred
#####
chFT$hit_distance_sc <- as.numeric(chFT$hit_distance_sc, na.rm = TRUE)
chFT$hit_angle <- as.numeric(chFT$hit_angle, na.rm = TRUE)
chFT$hit_speed <- as.numeric(chFT$hit_speed, na.rm = TRUE)

chFT$hit <- with(chFT, ifelse(grepl("Single", chFT$events), 1,
															ifelse(grepl("Double", chFT$events), 1,
																		 ifelse(grepl("Triple", chFT$events), 1, 
																		 			 ifelse(grepl("Home Run", chFT$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

chFT$fieldingTeam <- with(chFT, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[chFT$hit_distance_sc == "null"] = NA
#chFT$hit_speed[chFT$hit_speed == "null"] = NA
#chFT$hit_angle[chFT$hit_angle == "null"] = NA

# include row names for unique record identification

chFT$row <- row.names(chFT) %>% as.numeric()

# recode stand and home_team as factors

chFT$stand <- as.factor(chFT$stand)
chFT$home_team <- as.factor(chFT$home_team)


chFT$game_date <- as.Date(chFT$game_date)


# subset 

chFT_working_data <- ungroup(chFT) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(chFT_working_data)
str(ungroup(chFT))
table(chFT_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

chFT_working_data <- filter(chFT_working_data, hc_x != 1, hc_y != 1)
head(chFT_working_data)

# create training and test sets
# scaled data

set.seed(42)
chFT_train <- sample_frac(chFT_working_data, .15, replace = FALSE)
chFT_split <- setdiff(chFT_working_data, chFT_train)
chFT_test <- sample_frac(chFT_split, .50, replace = FALSE)
chFT_validate <- setdiff(chFT_split, chFT_test)

nrow(chFT_train) + nrow(chFT_test) + nrow(chFT_validate) == nrow(chFT_working_data)

with(chFT_train, table(hit)) %>% prop.table()
with(chFT_test, table(hit)) %>% prop.table()
with(chFT_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(chFT)
##as.numeric(chFT$hit_distance_sc, chFT$hit_speed, chFT$hit_angle)

#chFT_train$hit_distance_sc <- as.numeric(chFT_train$hit_distance_sc)
#chFT_train$hit_speed <- as.numeric(chFT_train$hit_speed)
#chFT_train$hit_angle <- as.numeric(chFT_train$hit_angle)
#View(chFT_train)
chFT_scaled_data <- scale(chFT_train[,c(1:5)])
chFT_scale_values <- attr(chFT_scaled_data, 'scaled:scale')
chFT_scale_values
chFT_center_values <- attr(chFT_scaled_data, 'scaled:center')
chFT_center_values
chFT_train <- cbind(chFT_scaled_data, select(chFT_train, hit:row))

# save levels for factor variables
chFT_levels_home_team <- levels(chFT_train$home_team)
chFT_levels_stand <- levels(chFT_train$stand)
chFT_levels_fieldingTeam <- levels(chFT_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(chFT_test)

chFT_test$hit_distance_sc <- (chFT_test$hit_distance_sc - chFT_center_values[1]) / chFT_scale_values[1]

chFT_test$hit_speed <- (chFT_test$hit_speed - chFT_center_values[2]) / chFT_scale_values[2]

chFT_test$hit_angle <- (chFT_test$hit_angle - chFT_center_values[3]) / chFT_scale_values[3]

chFT_test$hc_x <- (chFT_test$hc_x - chFT_center_values[4]) / chFT_scale_values[4]

chFT_test$hc_y <- (chFT_test$hc_y - chFT_center_values[5]) / chFT_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

chFT_validate$hit_distance_sc <- (chFT_validate$hit_distance_sc - chFT_center_values[1]) / chFT_scale_values[1]

chFT_validate$hit_speed <- (chFT_validate$hit_speed - chFT_center_values[2]) / chFT_scale_values[2]

chFT_validate$hit_angle <- (chFT_validate$hit_angle - chFT_center_values[3]) / chFT_scale_values[3]

chFT_validate$hc_x <- (chFT_validate$hc_x - chFT_center_values[4]) / chFT_scale_values[4]

chFT_validate$hc_y <- (chFT_validate$hc_y - chFT_center_values[5]) / chFT_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(chFT_train)

set.seed(42)
chFT_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(chFT_train, -row), ntree = 501, importance = TRUE)

print(chFT_rf.1)

plot(chFT_rf.1)

varImpPlot(chFT_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
chFT_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(chFT_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(chFT_rf.5)

plot(chFT_rf.5)

varImpPlot(chFT_rf.5)

chFT_predict_fit.rf.5 <- data.frame(fits = predict(chFT_rf.5, chFT_test, type = "prob")[,2], actuals = chFT_test$hit)

chFT_pred.rf.5 <- prediction(chFT_predict_fit.rf.5$fits, chFT_predict_fit.rf.5$actuals)

chFT_roc.pred.rf.5 <- performance(chFT_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(chFT_roc.pred.rf.5)
abline(a = 0, b = 1)
chFT_opt <- opt.cut(chFT_roc.pred.rf.5, chFT_pred.rf.5)
chFT_opt
chFT_opt <- chFT_opt[3]
chFT_predict_fit.rf.5$fits <- with(chFT_predict_fit.rf.5, ifelse(fits > chFT_opt, 1, 0)) 

str(chFT_test)

#chFT_test$fieldingTeam <- as.character(chFT_test$fieldingTeam)
#chFT_test$home_team <- as.character(chFT_test$home_team)
#chFT_test$hit <- as.logical(chFT_test$hit)
#chFT_test$stand <- as.logical(chFT_test$stand)
str(chFT_test)
chFT_rf.5_confusion_test <- confusionMatrix(model = chFT_rf.5, x = chFT_test, y = chFT_test$hit)
chFT_rf.5_confusion_validate <- confusionMatrix(model = chFT_rf.5, x = chFT_validate, y = chFT_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


chFT_test_rows <- chFT_test$row
chFT_validate_rows <- chFT_validate$row
chFT_pred_data_emp_1 <- ungroup(chFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFT_test_rows)

chFT_pred_data_emp <- ungroup(chFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFT_validate_rows) %>%
	rbind(chFT_pred_data_emp_1)

chFT_out_of_training_rows <- chFT_pred_data_emp$row

chFT_rf.5_full_out_of_sample_data <- ungroup(chFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFT_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



chFT_rf.5_full_out_of_sample_data_scaled <- chFT_rf.5_full_out_of_sample_data

chFT_rf.5_full_out_of_sample_data_scaled$hit_speed <- (chFT_rf.5_full_out_of_sample_data_scaled$hit_speed - chFT_center_values[2]) / chFT_scale_values[2]

chFT_rf.5_full_out_of_sample_data_scaled$hit_angle <- (chFT_rf.5_full_out_of_sample_data_scaled$hit_angle - chFT_center_values[3]) / chFT_scale_values[3]

chFT_rf.5.prob <- predict(chFT_rf.5, chFT_rf.5_full_out_of_sample_data_scaled, type = "response")

chFT_rf.5_full_out_of_sample_data <- cbind(filter(chFT_rf.5_full_out_of_sample_data, row %in% chFT_out_of_training_rows), chFT_rf.5.prob)

names(chFT_rf.5_full_out_of_sample_data)[65] <- "fits"
names(chFT_rf.5_full_out_of_sample_data)

chFT_rf.5_full_out_of_sample_data_reduced <- chFT_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

chFT_rf.5_mean_table <- chFT_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

chFT_rf.5_full_out_of_sample_data$type <- with(chFT_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

chFT_rf.5_full_out_of_sample_data$hit_label <- with(chFT_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

chFT_rf.5_plot1 <- ggplot(chFT_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chFT_rf.5_plot1

chFT_rf.5_plot2 <- ggplot(chFT_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chFT_rf.5_plot2

chFT_rf.5_plot3 <- ggplot(chFT_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chFT_rf.5_plot3

chFT_grid_plot_rf.5 <- grid.arrange(chFT_rf.5_plot1, chFT_rf.5_plot2, chFT_rf.5_plot3, ncol = 3)
chFT_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

chFT_test_rows <- chFT_test$row
chFT_validate_rows <- chFT_validate$row
chFT_pred_data_emp_1 <- ungroup(chFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFT_test_rows)

chFT_pred_data_emp <- ungroup(chFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFT_validate_rows) %>%
	rbind(chFT_pred_data_emp_1)

chFT_out_of_training_rows <- chFT_pred_data_emp$row

chFT_pred_data_emp <- ungroup(chFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFT_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

chFT_pred_data_emp_scaled <- chFT_pred_data_emp

chFT_pred_data_emp_scaled$hit_speed <- (chFT_pred_data_emp_scaled$hit_speed - chFT_center_values[2]) / chFT_scale_values[2]

chFT_pred_data_emp_scaled$hit_angle <- (chFT_pred_data_emp_scaled$hit_angle - chFT_center_values[3]) / chFT_scale_values[3]

chFT_pred_prob_hit <- predict(chFT_rf.5, chFT_pred_data_emp_scaled, type = "prob")[,2]
chFT_pred_prob_hit_fits <- cbind(chFT_pred_data_emp, chFT_pred_prob_hit)

chFT_pred_prob_hit_fits[,c(1:2)] <- chFT_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

chFT_angle_speed_pred <- chFT_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = chFT_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nCH-FT Hit Probability\n") + theme_bp_grey()

chFT_angle_speed_pred
#####
slFT$hit_distance_sc <- as.numeric(slFT$hit_distance_sc, na.rm = TRUE)
slFT$hit_angle <- as.numeric(slFT$hit_angle, na.rm = TRUE)
slFT$hit_speed <- as.numeric(slFT$hit_speed, na.rm = TRUE)

slFT$hit <- with(slFT, ifelse(grepl("Single", slFT$events), 1,
															ifelse(grepl("Double", slFT$events), 1,
																		 ifelse(grepl("Triple", slFT$events), 1, 
																		 			 ifelse(grepl("Home Run", slFT$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

slFT$fieldingTeam <- with(slFT, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[slFT$hit_distance_sc == "null"] = NA
#slFT$hit_speed[slFT$hit_speed == "null"] = NA
#slFT$hit_angle[slFT$hit_angle == "null"] = NA

# include row names for unique record identification

slFT$row <- row.names(slFT) %>% as.numeric()

# recode stand and home_team as factors

slFT$stand <- as.factor(slFT$stand)
slFT$home_team <- as.factor(slFT$home_team)


slFT$game_date <- as.Date(slFT$game_date)


# subset 

slFT_working_data <- ungroup(slFT) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(slFT_working_data)
str(ungroup(slFT))
table(slFT_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

slFT_working_data <- filter(slFT_working_data, hc_x != 1, hc_y != 1)
head(slFT_working_data)

# create training and test sets
# scaled data

set.seed(42)
slFT_train <- sample_frac(slFT_working_data, .15, replace = FALSE)
slFT_split <- setdiff(slFT_working_data, slFT_train)
slFT_test <- sample_frac(slFT_split, .50, replace = FALSE)
slFT_validate <- setdiff(slFT_split, slFT_test)

nrow(slFT_train) + nrow(slFT_test) + nrow(slFT_validate) == nrow(slFT_working_data)

with(slFT_train, table(hit)) %>% prop.table()
with(slFT_test, table(hit)) %>% prop.table()
with(slFT_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(slFT)
##as.numeric(slFT$hit_distance_sc, slFT$hit_speed, slFT$hit_angle)

#slFT_train$hit_distance_sc <- as.numeric(slFT_train$hit_distance_sc)
#slFT_train$hit_speed <- as.numeric(slFT_train$hit_speed)
#slFT_train$hit_angle <- as.numeric(slFT_train$hit_angle)
#View(slFT_train)
slFT_scaled_data <- scale(slFT_train[,c(1:5)])
slFT_scale_values <- attr(slFT_scaled_data, 'scaled:scale')
slFT_scale_values
slFT_center_values <- attr(slFT_scaled_data, 'scaled:center')
slFT_center_values
slFT_train <- cbind(slFT_scaled_data, select(slFT_train, hit:row))

# save levels for factor variables
slFT_levels_home_team <- levels(slFT_train$home_team)
slFT_levels_stand <- levels(slFT_train$stand)
slFT_levels_fieldingTeam <- levels(slFT_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(slFT_test)

slFT_test$hit_distance_sc <- (slFT_test$hit_distance_sc - slFT_center_values[1]) / slFT_scale_values[1]

slFT_test$hit_speed <- (slFT_test$hit_speed - slFT_center_values[2]) / slFT_scale_values[2]

slFT_test$hit_angle <- (slFT_test$hit_angle - slFT_center_values[3]) / slFT_scale_values[3]

slFT_test$hc_x <- (slFT_test$hc_x - slFT_center_values[4]) / slFT_scale_values[4]

slFT_test$hc_y <- (slFT_test$hc_y - slFT_center_values[5]) / slFT_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

slFT_validate$hit_distance_sc <- (slFT_validate$hit_distance_sc - slFT_center_values[1]) / slFT_scale_values[1]

slFT_validate$hit_speed <- (slFT_validate$hit_speed - slFT_center_values[2]) / slFT_scale_values[2]

slFT_validate$hit_angle <- (slFT_validate$hit_angle - slFT_center_values[3]) / slFT_scale_values[3]

slFT_validate$hc_x <- (slFT_validate$hc_x - slFT_center_values[4]) / slFT_scale_values[4]

slFT_validate$hc_y <- (slFT_validate$hc_y - slFT_center_values[5]) / slFT_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(slFT_train)

set.seed(42)
slFT_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(slFT_train, -row), ntree = 501, importance = TRUE)

print(slFT_rf.1)

plot(slFT_rf.1)

varImpPlot(slFT_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
slFT_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(slFT_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(slFT_rf.5)

plot(slFT_rf.5)

varImpPlot(slFT_rf.5)

slFT_predict_fit.rf.5 <- data.frame(fits = predict(slFT_rf.5, slFT_test, type = "prob")[,2], actuals = slFT_test$hit)

slFT_pred.rf.5 <- prediction(slFT_predict_fit.rf.5$fits, slFT_predict_fit.rf.5$actuals)

slFT_roc.pred.rf.5 <- performance(slFT_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(slFT_roc.pred.rf.5)
abline(a = 0, b = 1)
slFT_opt <- opt.cut(slFT_roc.pred.rf.5, slFT_pred.rf.5)
slFT_opt
slFT_opt <- slFT_opt[3]
slFT_predict_fit.rf.5$fits <- with(slFT_predict_fit.rf.5, ifelse(fits > slFT_opt, 1, 0)) 

str(slFT_test)

#slFT_test$fieldingTeam <- as.character(slFT_test$fieldingTeam)
#slFT_test$home_team <- as.character(slFT_test$home_team)
#slFT_test$hit <- as.logical(slFT_test$hit)
#slFT_test$stand <- as.logical(slFT_test$stand)
str(slFT_test)
slFT_rf.5_confusion_test <- confusionMatrix(model = slFT_rf.5, x = slFT_test, y = slFT_test$hit)
slFT_rf.5_confusion_validate <- confusionMatrix(model = slFT_rf.5, x = slFT_validate, y = slFT_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


slFT_test_rows <- slFT_test$row
slFT_validate_rows <- slFT_validate$row
slFT_pred_data_emp_1 <- ungroup(slFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFT_test_rows)

slFT_pred_data_emp <- ungroup(slFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFT_validate_rows) %>%
	rbind(slFT_pred_data_emp_1)

slFT_out_of_training_rows <- slFT_pred_data_emp$row

slFT_rf.5_full_out_of_sample_data <- ungroup(slFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFT_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



slFT_rf.5_full_out_of_sample_data_scaled <- slFT_rf.5_full_out_of_sample_data

slFT_rf.5_full_out_of_sample_data_scaled$hit_speed <- (slFT_rf.5_full_out_of_sample_data_scaled$hit_speed - slFT_center_values[2]) / slFT_scale_values[2]

slFT_rf.5_full_out_of_sample_data_scaled$hit_angle <- (slFT_rf.5_full_out_of_sample_data_scaled$hit_angle - slFT_center_values[3]) / slFT_scale_values[3]

slFT_rf.5.prob <- predict(slFT_rf.5, slFT_rf.5_full_out_of_sample_data_scaled, type = "response")

slFT_rf.5_full_out_of_sample_data <- cbind(filter(slFT_rf.5_full_out_of_sample_data, row %in% slFT_out_of_training_rows), slFT_rf.5.prob)

names(slFT_rf.5_full_out_of_sample_data)[65] <- "fits"
names(slFT_rf.5_full_out_of_sample_data)

slFT_rf.5_full_out_of_sample_data_reduced <- slFT_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

slFT_rf.5_mean_table <- slFT_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

slFT_rf.5_full_out_of_sample_data$type <- with(slFT_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

slFT_rf.5_full_out_of_sample_data$hit_label <- with(slFT_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

slFT_rf.5_plot1 <- ggplot(slFT_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slFT_rf.5_plot1

slFT_rf.5_plot2 <- ggplot(slFT_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slFT_rf.5_plot2

slFT_rf.5_plot3 <- ggplot(slFT_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slFT_rf.5_plot3

slFT_grid_plot_rf.5 <- grid.arrange(slFT_rf.5_plot1, slFT_rf.5_plot2, slFT_rf.5_plot3, ncol = 3)
slFT_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

slFT_test_rows <- slFT_test$row
slFT_validate_rows <- slFT_validate$row
slFT_pred_data_emp_1 <- ungroup(slFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFT_test_rows)

slFT_pred_data_emp <- ungroup(slFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFT_validate_rows) %>%
	rbind(slFT_pred_data_emp_1)

slFT_out_of_training_rows <- slFT_pred_data_emp$row

slFT_pred_data_emp <- ungroup(slFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFT_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

slFT_pred_data_emp_scaled <- slFT_pred_data_emp

slFT_pred_data_emp_scaled$hit_speed <- (slFT_pred_data_emp_scaled$hit_speed - slFT_center_values[2]) / slFT_scale_values[2]

slFT_pred_data_emp_scaled$hit_angle <- (slFT_pred_data_emp_scaled$hit_angle - slFT_center_values[3]) / slFT_scale_values[3]

slFT_pred_prob_hit <- predict(slFT_rf.5, slFT_pred_data_emp_scaled, type = "prob")[,2]
slFT_pred_prob_hit_fits <- cbind(slFT_pred_data_emp, slFT_pred_prob_hit)

slFT_pred_prob_hit_fits[,c(1:2)] <- slFT_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

slFT_angle_speed_pred <- slFT_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = slFT_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nSL-FT Hit Probability\n") + theme_bp_grey()

slFT_angle_speed_pred
#####
cuFT$hit_distance_sc <- as.numeric(cuFT$hit_distance_sc, na.rm = TRUE)
cuFT$hit_angle <- as.numeric(cuFT$hit_angle, na.rm = TRUE)
cuFT$hit_speed <- as.numeric(cuFT$hit_speed, na.rm = TRUE)

cuFT$hit <- with(cuFT, ifelse(grepl("Single", cuFT$events), 1,
															ifelse(grepl("Double", cuFT$events), 1,
																		 ifelse(grepl("Triple", cuFT$events), 1, 
																		 			 ifelse(grepl("Home Run", cuFT$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

cuFT$fieldingTeam <- with(cuFT, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[cuFT$hit_distance_sc == "null"] = NA
#cuFT$hit_speed[cuFT$hit_speed == "null"] = NA
#cuFT$hit_angle[cuFT$hit_angle == "null"] = NA

# include row names for unique record identification

cuFT$row <- row.names(cuFT) %>% as.numeric()

# recode stand and home_team as factors

cuFT$stand <- as.factor(cuFT$stand)
cuFT$home_team <- as.factor(cuFT$home_team)


cuFT$game_date <- as.Date(cuFT$game_date)


# subset 

cuFT_working_data <- ungroup(cuFT) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(cuFT_working_data)
str(ungroup(cuFT))
table(cuFT_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

cuFT_working_data <- filter(cuFT_working_data, hc_x != 1, hc_y != 1)
head(cuFT_working_data)

# create training and test sets
# scaled data

set.seed(42)
cuFT_train <- sample_frac(cuFT_working_data, .15, replace = FALSE)
cuFT_split <- setdiff(cuFT_working_data, cuFT_train)
cuFT_test <- sample_frac(cuFT_split, .50, replace = FALSE)
cuFT_validate <- setdiff(cuFT_split, cuFT_test)

nrow(cuFT_train) + nrow(cuFT_test) + nrow(cuFT_validate) == nrow(cuFT_working_data)

with(cuFT_train, table(hit)) %>% prop.table()
with(cuFT_test, table(hit)) %>% prop.table()
with(cuFT_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(cuFT)
##as.numeric(cuFT$hit_distance_sc, cuFT$hit_speed, cuFT$hit_angle)

#cuFT_train$hit_distance_sc <- as.numeric(cuFT_train$hit_distance_sc)
#cuFT_train$hit_speed <- as.numeric(cuFT_train$hit_speed)
#cuFT_train$hit_angle <- as.numeric(cuFT_train$hit_angle)
#View(cuFT_train)
cuFT_scaled_data <- scale(cuFT_train[,c(1:5)])
cuFT_scale_values <- attr(cuFT_scaled_data, 'scaled:scale')
cuFT_scale_values
cuFT_center_values <- attr(cuFT_scaled_data, 'scaled:center')
cuFT_center_values
cuFT_train <- cbind(cuFT_scaled_data, select(cuFT_train, hit:row))

# save levels for factor variables
cuFT_levels_home_team <- levels(cuFT_train$home_team)
cuFT_levels_stand <- levels(cuFT_train$stand)
cuFT_levels_fieldingTeam <- levels(cuFT_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(cuFT_test)

cuFT_test$hit_distance_sc <- (cuFT_test$hit_distance_sc - cuFT_center_values[1]) / cuFT_scale_values[1]

cuFT_test$hit_speed <- (cuFT_test$hit_speed - cuFT_center_values[2]) / cuFT_scale_values[2]

cuFT_test$hit_angle <- (cuFT_test$hit_angle - cuFT_center_values[3]) / cuFT_scale_values[3]

cuFT_test$hc_x <- (cuFT_test$hc_x - cuFT_center_values[4]) / cuFT_scale_values[4]

cuFT_test$hc_y <- (cuFT_test$hc_y - cuFT_center_values[5]) / cuFT_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

cuFT_validate$hit_distance_sc <- (cuFT_validate$hit_distance_sc - cuFT_center_values[1]) / cuFT_scale_values[1]

cuFT_validate$hit_speed <- (cuFT_validate$hit_speed - cuFT_center_values[2]) / cuFT_scale_values[2]

cuFT_validate$hit_angle <- (cuFT_validate$hit_angle - cuFT_center_values[3]) / cuFT_scale_values[3]

cuFT_validate$hc_x <- (cuFT_validate$hc_x - cuFT_center_values[4]) / cuFT_scale_values[4]

cuFT_validate$hc_y <- (cuFT_validate$hc_y - cuFT_center_values[5]) / cuFT_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(cuFT_train)

set.seed(42)
cuFT_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(cuFT_train, -row), ntree = 501, importance = TRUE)

print(cuFT_rf.1)

plot(cuFT_rf.1)

varImpPlot(cuFT_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
cuFT_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(cuFT_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(cuFT_rf.5)

plot(cuFT_rf.5)

varImpPlot(cuFT_rf.5)

cuFT_predict_fit.rf.5 <- data.frame(fits = predict(cuFT_rf.5, cuFT_test, type = "prob")[,2], actuals = cuFT_test$hit)

cuFT_pred.rf.5 <- prediction(cuFT_predict_fit.rf.5$fits, cuFT_predict_fit.rf.5$actuals)

cuFT_roc.pred.rf.5 <- performance(cuFT_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(cuFT_roc.pred.rf.5)
abline(a = 0, b = 1)
cuFT_opt <- opt.cut(cuFT_roc.pred.rf.5, cuFT_pred.rf.5)
cuFT_opt
cuFT_opt <- cuFT_opt[3]
cuFT_predict_fit.rf.5$fits <- with(cuFT_predict_fit.rf.5, ifelse(fits > cuFT_opt, 1, 0)) 

str(cuFT_test)

#cuFT_test$fieldingTeam <- as.character(cuFT_test$fieldingTeam)
#cuFT_test$home_team <- as.character(cuFT_test$home_team)
#cuFT_test$hit <- as.logical(cuFT_test$hit)
#cuFT_test$stand <- as.logical(cuFT_test$stand)
str(cuFT_test)
cuFT_rf.5_confusion_test <- confusionMatrix(model = cuFT_rf.5, x = cuFT_test, y = cuFT_test$hit)
cuFT_rf.5_confusion_validate <- confusionMatrix(model = cuFT_rf.5, x = cuFT_validate, y = cuFT_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


cuFT_test_rows <- cuFT_test$row
cuFT_validate_rows <- cuFT_validate$row
cuFT_pred_data_emp_1 <- ungroup(cuFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFT_test_rows)

cuFT_pred_data_emp <- ungroup(cuFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFT_validate_rows) %>%
	rbind(cuFT_pred_data_emp_1)

cuFT_out_of_training_rows <- cuFT_pred_data_emp$row

cuFT_rf.5_full_out_of_sample_data <- ungroup(cuFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFT_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



cuFT_rf.5_full_out_of_sample_data_scaled <- cuFT_rf.5_full_out_of_sample_data

cuFT_rf.5_full_out_of_sample_data_scaled$hit_speed <- (cuFT_rf.5_full_out_of_sample_data_scaled$hit_speed - cuFT_center_values[2]) / cuFT_scale_values[2]

cuFT_rf.5_full_out_of_sample_data_scaled$hit_angle <- (cuFT_rf.5_full_out_of_sample_data_scaled$hit_angle - cuFT_center_values[3]) / cuFT_scale_values[3]

cuFT_rf.5.prob <- predict(cuFT_rf.5, cuFT_rf.5_full_out_of_sample_data_scaled, type = "response")

cuFT_rf.5_full_out_of_sample_data <- cbind(filter(cuFT_rf.5_full_out_of_sample_data, row %in% cuFT_out_of_training_rows), cuFT_rf.5.prob)

names(cuFT_rf.5_full_out_of_sample_data)[65] <- "fits"
names(cuFT_rf.5_full_out_of_sample_data)

cuFT_rf.5_full_out_of_sample_data_reduced <- cuFT_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

cuFT_rf.5_mean_table <- cuFT_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

cuFT_rf.5_full_out_of_sample_data$type <- with(cuFT_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

cuFT_rf.5_full_out_of_sample_data$hit_label <- with(cuFT_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

cuFT_rf.5_plot1 <- ggplot(cuFT_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuFT_rf.5_plot1

cuFT_rf.5_plot2 <- ggplot(cuFT_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuFT_rf.5_plot2

cuFT_rf.5_plot3 <- ggplot(cuFT_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuFT_rf.5_plot3

cuFT_grid_plot_rf.5 <- grid.arrange(cuFT_rf.5_plot1, cuFT_rf.5_plot2, cuFT_rf.5_plot3, ncol = 3)
cuFT_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

cuFT_test_rows <- cuFT_test$row
cuFT_validate_rows <- cuFT_validate$row
cuFT_pred_data_emp_1 <- ungroup(cuFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFT_test_rows)

cuFT_pred_data_emp <- ungroup(cuFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFT_validate_rows) %>%
	rbind(cuFT_pred_data_emp_1)

cuFT_out_of_training_rows <- cuFT_pred_data_emp$row

cuFT_pred_data_emp <- ungroup(cuFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFT_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

cuFT_pred_data_emp_scaled <- cuFT_pred_data_emp

cuFT_pred_data_emp_scaled$hit_speed <- (cuFT_pred_data_emp_scaled$hit_speed - cuFT_center_values[2]) / cuFT_scale_values[2]

cuFT_pred_data_emp_scaled$hit_angle <- (cuFT_pred_data_emp_scaled$hit_angle - cuFT_center_values[3]) / cuFT_scale_values[3]

cuFT_pred_prob_hit <- predict(cuFT_rf.5, cuFT_pred_data_emp_scaled, type = "prob")[,2]
cuFT_pred_prob_hit_fits <- cbind(cuFT_pred_data_emp, cuFT_pred_prob_hit)

cuFT_pred_prob_hit_fits[,c(1:2)] <- cuFT_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

cuFT_angle_speed_pred <- cuFT_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = cuFT_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nCU-FT Hit Probability\n") + theme_bp_grey()

cuFT_angle_speed_pred
#####
ffFT$hit_distance_sc <- as.numeric(ffFT$hit_distance_sc, na.rm = TRUE)
ffFT$hit_angle <- as.numeric(ffFT$hit_angle, na.rm = TRUE)
ffFT$hit_speed <- as.numeric(ffFT$hit_speed, na.rm = TRUE)

ffFT$hit <- with(ffFT, ifelse(grepl("Single", ffFT$events), 1,
															ifelse(grepl("Double", ffFT$events), 1,
																		 ifelse(grepl("Triple", ffFT$events), 1, 
																		 			 ifelse(grepl("Home Run", ffFT$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

ffFT$fieldingTeam <- with(ffFT, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[ffFT$hit_distance_sc == "null"] = NA
#ffFT$hit_speed[ffFT$hit_speed == "null"] = NA
#ffFT$hit_angle[ffFT$hit_angle == "null"] = NA

# include row names for unique record identification

ffFT$row <- row.names(ffFT) %>% as.numeric()

# recode stand and home_team as factors

ffFT$stand <- as.factor(ffFT$stand)
ffFT$home_team <- as.factor(ffFT$home_team)


ffFT$game_date <- as.Date(ffFT$game_date)


# subset 

ffFT_working_data <- ungroup(ffFT) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(ffFT_working_data)
str(ungroup(ffFT))
table(ffFT_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

ffFT_working_data <- filter(ffFT_working_data, hc_x != 1, hc_y != 1)
head(ffFT_working_data)

# create training and test sets
# scaled data

set.seed(42)
ffFT_train <- sample_frac(ffFT_working_data, .15, replace = FALSE)
ffFT_split <- setdiff(ffFT_working_data, ffFT_train)
ffFT_test <- sample_frac(ffFT_split, .50, replace = FALSE)
ffFT_validate <- setdiff(ffFT_split, ffFT_test)

nrow(ffFT_train) + nrow(ffFT_test) + nrow(ffFT_validate) == nrow(ffFT_working_data)

with(ffFT_train, table(hit)) %>% prop.table()
with(ffFT_test, table(hit)) %>% prop.table()
with(ffFT_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(ffFT)
##as.numeric(ffFT$hit_distance_sc, ffFT$hit_speed, ffFT$hit_angle)

#ffFT_train$hit_distance_sc <- as.numeric(ffFT_train$hit_distance_sc)
#ffFT_train$hit_speed <- as.numeric(ffFT_train$hit_speed)
#ffFT_train$hit_angle <- as.numeric(ffFT_train$hit_angle)
#View(ffFT_train)
ffFT_scaled_data <- scale(ffFT_train[,c(1:5)])
ffFT_scale_values <- attr(ffFT_scaled_data, 'scaled:scale')
ffFT_scale_values
ffFT_center_values <- attr(ffFT_scaled_data, 'scaled:center')
ffFT_center_values
ffFT_train <- cbind(ffFT_scaled_data, select(ffFT_train, hit:row))

# save levels for factor variables
ffFT_levels_home_team <- levels(ffFT_train$home_team)
ffFT_levels_stand <- levels(ffFT_train$stand)
ffFT_levels_fieldingTeam <- levels(ffFT_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(ffFT_test)

ffFT_test$hit_distance_sc <- (ffFT_test$hit_distance_sc - ffFT_center_values[1]) / ffFT_scale_values[1]

ffFT_test$hit_speed <- (ffFT_test$hit_speed - ffFT_center_values[2]) / ffFT_scale_values[2]

ffFT_test$hit_angle <- (ffFT_test$hit_angle - ffFT_center_values[3]) / ffFT_scale_values[3]

ffFT_test$hc_x <- (ffFT_test$hc_x - ffFT_center_values[4]) / ffFT_scale_values[4]

ffFT_test$hc_y <- (ffFT_test$hc_y - ffFT_center_values[5]) / ffFT_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

ffFT_validate$hit_distance_sc <- (ffFT_validate$hit_distance_sc - ffFT_center_values[1]) / ffFT_scale_values[1]

ffFT_validate$hit_speed <- (ffFT_validate$hit_speed - ffFT_center_values[2]) / ffFT_scale_values[2]

ffFT_validate$hit_angle <- (ffFT_validate$hit_angle - ffFT_center_values[3]) / ffFT_scale_values[3]

ffFT_validate$hc_x <- (ffFT_validate$hc_x - ffFT_center_values[4]) / ffFT_scale_values[4]

ffFT_validate$hc_y <- (ffFT_validate$hc_y - ffFT_center_values[5]) / ffFT_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(ffFT_train)

set.seed(42)
ffFT_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(ffFT_train, -row), ntree = 501, importance = TRUE)

print(ffFT_rf.1)

plot(ffFT_rf.1)

varImpPlot(ffFT_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
ffFT_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(ffFT_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(ffFT_rf.5)

plot(ffFT_rf.5)

varImpPlot(ffFT_rf.5)

ffFT_predict_fit.rf.5 <- data.frame(fits = predict(ffFT_rf.5, ffFT_test, type = "prob")[,2], actuals = ffFT_test$hit)

ffFT_pred.rf.5 <- prediction(ffFT_predict_fit.rf.5$fits, ffFT_predict_fit.rf.5$actuals)

ffFT_roc.pred.rf.5 <- performance(ffFT_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(ffFT_roc.pred.rf.5)
abline(a = 0, b = 1)
ffFT_opt <- opt.cut(ffFT_roc.pred.rf.5, ffFT_pred.rf.5)
ffFT_opt
ffFT_opt <- ffFT_opt[3]
ffFT_predict_fit.rf.5$fits <- with(ffFT_predict_fit.rf.5, ifelse(fits > ffFT_opt, 1, 0)) 

str(ffFT_test)

#ffFT_test$fieldingTeam <- as.character(ffFT_test$fieldingTeam)
#ffFT_test$home_team <- as.character(ffFT_test$home_team)
#ffFT_test$hit <- as.logical(ffFT_test$hit)
#ffFT_test$stand <- as.logical(ffFT_test$stand)
str(ffFT_test)
ffFT_rf.5_confusion_test <- confusionMatrix(model = ffFT_rf.5, x = ffFT_test, y = ffFT_test$hit)
ffFT_rf.5_confusion_validate <- confusionMatrix(model = ffFT_rf.5, x = ffFT_validate, y = ffFT_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


ffFT_test_rows <- ffFT_test$row
ffFT_validate_rows <- ffFT_validate$row
ffFT_pred_data_emp_1 <- ungroup(ffFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffFT_test_rows)

ffFT_pred_data_emp <- ungroup(ffFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffFT_validate_rows) %>%
	rbind(ffFT_pred_data_emp_1)

ffFT_out_of_training_rows <- ffFT_pred_data_emp$row

ffFT_rf.5_full_out_of_sample_data <- ungroup(ffFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffFT_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



ffFT_rf.5_full_out_of_sample_data_scaled <- ffFT_rf.5_full_out_of_sample_data

ffFT_rf.5_full_out_of_sample_data_scaled$hit_speed <- (ffFT_rf.5_full_out_of_sample_data_scaled$hit_speed - ffFT_center_values[2]) / ffFT_scale_values[2]

ffFT_rf.5_full_out_of_sample_data_scaled$hit_angle <- (ffFT_rf.5_full_out_of_sample_data_scaled$hit_angle - ffFT_center_values[3]) / ffFT_scale_values[3]

ffFT_rf.5.prob <- predict(ffFT_rf.5, ffFT_rf.5_full_out_of_sample_data_scaled, type = "response")

ffFT_rf.5_full_out_of_sample_data <- cbind(filter(ffFT_rf.5_full_out_of_sample_data, row %in% ffFT_out_of_training_rows), ffFT_rf.5.prob)

names(ffFT_rf.5_full_out_of_sample_data)[65] <- "fits"
names(ffFT_rf.5_full_out_of_sample_data)

ffFT_rf.5_full_out_of_sample_data_reduced <- ffFT_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

ffFT_rf.5_mean_table <- ffFT_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

ffFT_rf.5_full_out_of_sample_data$type <- with(ffFT_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

ffFT_rf.5_full_out_of_sample_data$hit_label <- with(ffFT_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

ffFT_rf.5_plot1 <- ggplot(ffFT_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffFT_rf.5_plot1

ffFT_rf.5_plot2 <- ggplot(ffFT_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffFT_rf.5_plot2

ffFT_rf.5_plot3 <- ggplot(ffFT_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffFT_rf.5_plot3

ffFT_grid_plot_rf.5 <- grid.arrange(ffFT_rf.5_plot1, ffFT_rf.5_plot2, ffFT_rf.5_plot3, ncol = 3)
ffFT_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

ffFT_test_rows <- ffFT_test$row
ffFT_validate_rows <- ffFT_validate$row
ffFT_pred_data_emp_1 <- ungroup(ffFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffFT_test_rows)

ffFT_pred_data_emp <- ungroup(ffFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffFT_validate_rows) %>%
	rbind(ffFT_pred_data_emp_1)

ffFT_out_of_training_rows <- ffFT_pred_data_emp$row

ffFT_pred_data_emp <- ungroup(ffFT) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffFT_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

ffFT_pred_data_emp_scaled <- ffFT_pred_data_emp

ffFT_pred_data_emp_scaled$hit_speed <- (ffFT_pred_data_emp_scaled$hit_speed - ffFT_center_values[2]) / ffFT_scale_values[2]

ffFT_pred_data_emp_scaled$hit_angle <- (ffFT_pred_data_emp_scaled$hit_angle - ffFT_center_values[3]) / ffFT_scale_values[3]

ffFT_pred_prob_hit <- predict(ffFT_rf.5, ffFT_pred_data_emp_scaled, type = "prob")[,2]
ffFT_pred_prob_hit_fits <- cbind(ffFT_pred_data_emp, ffFT_pred_prob_hit)

ffFT_pred_prob_hit_fits[,c(1:2)] <- ffFT_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

ffFT_angle_speed_pred <- ffFT_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = ffFT_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFF-FT Hit Probability\n") + theme_bp_grey()

ffFT_angle_speed_pred
############# End 2-Seam Fastballs; Start Sliders
########################## Start Sliders
#####
siSL$hit_distance_sc <- as.numeric(siSL$hit_distance_sc, na.rm = TRUE)
siSL$hit_angle <- as.numeric(siSL$hit_angle, na.rm = TRUE)
siSL$hit_speed <- as.numeric(siSL$hit_speed, na.rm = TRUE)

siSL$hit <- with(siSL, ifelse(grepl("Single", siSL$events), 1,
															ifelse(grepl("Double", siSL$events), 1,
																		 ifelse(grepl("Triple", siSL$events), 1, 
																		 			 ifelse(grepl("Home Run", siSL$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

siSL$fieldingTeam <- with(siSL, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[siSL$hit_distance_sc == "null"] = NA
#siSL$hit_speed[siSL$hit_speed == "null"] = NA
#siSL$hit_angle[siSL$hit_angle == "null"] = NA

# include row names for unique record identification

siSL$row <- row.names(siSL) %>% as.numeric()

# recode stand and home_team as factors

siSL$stand <- as.factor(siSL$stand)
siSL$home_team <- as.factor(siSL$home_team)


siSL$game_date <- as.Date(siSL$game_date)


# subset 

siSL_working_data <- ungroup(siSL) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(siSL_working_data)
str(ungroup(siSL))
table(siSL_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

siSL_working_data <- filter(siSL_working_data, hc_x != 1, hc_y != 1)
head(siSL_working_data)

# create training and test sets
# scaled data

set.seed(42)
siSL_train <- sample_frac(siSL_working_data, .15, replace = FALSE)
siSL_split <- setdiff(siSL_working_data, siSL_train)
siSL_test <- sample_frac(siSL_split, .50, replace = FALSE)
siSL_validate <- setdiff(siSL_split, siSL_test)

nrow(siSL_train) + nrow(siSL_test) + nrow(siSL_validate) == nrow(siSL_working_data)

with(siSL_train, table(hit)) %>% prop.table()
with(siSL_test, table(hit)) %>% prop.table()
with(siSL_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(siSL)
##as.numeric(siSL$hit_distance_sc, siSL$hit_speed, siSL$hit_angle)

#siSL_train$hit_distance_sc <- as.numeric(siSL_train$hit_distance_sc)
#siSL_train$hit_speed <- as.numeric(siSL_train$hit_speed)
#siSL_train$hit_angle <- as.numeric(siSL_train$hit_angle)
#View(siSL_train)
siSL_scaled_data <- scale(siSL_train[,c(1:5)])
siSL_scale_values <- attr(siSL_scaled_data, 'scaled:scale')
siSL_scale_values
siSL_center_values <- attr(siSL_scaled_data, 'scaled:center')
siSL_center_values
siSL_train <- cbind(siSL_scaled_data, select(siSL_train, hit:row))

# save levels for factor variables
siSL_levels_home_team <- levels(siSL_train$home_team)
siSL_levels_stand <- levels(siSL_train$stand)
siSL_levels_fieldingTeam <- levels(siSL_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(siSL_test)

siSL_test$hit_distance_sc <- (siSL_test$hit_distance_sc - siSL_center_values[1]) / siSL_scale_values[1]

siSL_test$hit_speed <- (siSL_test$hit_speed - siSL_center_values[2]) / siSL_scale_values[2]

siSL_test$hit_angle <- (siSL_test$hit_angle - siSL_center_values[3]) / siSL_scale_values[3]

siSL_test$hc_x <- (siSL_test$hc_x - siSL_center_values[4]) / siSL_scale_values[4]

siSL_test$hc_y <- (siSL_test$hc_y - siSL_center_values[5]) / siSL_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

siSL_validate$hit_distance_sc <- (siSL_validate$hit_distance_sc - siSL_center_values[1]) / siSL_scale_values[1]

siSL_validate$hit_speed <- (siSL_validate$hit_speed - siSL_center_values[2]) / siSL_scale_values[2]

siSL_validate$hit_angle <- (siSL_validate$hit_angle - siSL_center_values[3]) / siSL_scale_values[3]

siSL_validate$hc_x <- (siSL_validate$hc_x - siSL_center_values[4]) / siSL_scale_values[4]

siSL_validate$hc_y <- (siSL_validate$hc_y - siSL_center_values[5]) / siSL_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(siSL_train)

set.seed(42)
siSL_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(siSL_train, -row), ntree = 501, importance = TRUE)

print(siSL_rf.1)

plot(siSL_rf.1)

varImpPlot(siSL_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
siSL_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(siSL_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(siSL_rf.5)

plot(siSL_rf.5)

varImpPlot(siSL_rf.5)

siSL_predict_fit.rf.5 <- data.frame(fits = predict(siSL_rf.5, siSL_test, type = "prob")[,2], actuals = siSL_test$hit)

siSL_pred.rf.5 <- prediction(siSL_predict_fit.rf.5$fits, siSL_predict_fit.rf.5$actuals)

siSL_roc.pred.rf.5 <- performance(siSL_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(siSL_roc.pred.rf.5)
abline(a = 0, b = 1)
siSL_opt <- opt.cut(siSL_roc.pred.rf.5, siSL_pred.rf.5)
siSL_opt
siSL_opt <- siSL_opt[3]
siSL_predict_fit.rf.5$fits <- with(siSL_predict_fit.rf.5, ifelse(fits > siSL_opt, 1, 0)) 

str(siSL_test)

#siSL_test$fieldingTeam <- as.character(siSL_test$fieldingTeam)
#siSL_test$home_team <- as.character(siSL_test$home_team)
#siSL_test$hit <- as.logical(siSL_test$hit)
#siSL_test$stand <- as.logical(siSL_test$stand)
str(siSL_test)
siSL_rf.5_confusion_test <- confusionMatrix(model = siSL_rf.5, x = siSL_test, y = siSL_test$hit)
siSL_rf.5_confusion_validate <- confusionMatrix(model = siSL_rf.5, x = siSL_validate, y = siSL_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


siSL_test_rows <- siSL_test$row
siSL_validate_rows <- siSL_validate$row
siSL_pred_data_emp_1 <- ungroup(siSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siSL_test_rows)

siSL_pred_data_emp <- ungroup(siSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siSL_validate_rows) %>%
	rbind(siSL_pred_data_emp_1)

siSL_out_of_training_rows <- siSL_pred_data_emp$row

siSL_rf.5_full_out_of_sample_data <- ungroup(siSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siSL_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



siSL_rf.5_full_out_of_sample_data_scaled <- siSL_rf.5_full_out_of_sample_data

siSL_rf.5_full_out_of_sample_data_scaled$hit_speed <- (siSL_rf.5_full_out_of_sample_data_scaled$hit_speed - siSL_center_values[2]) / siSL_scale_values[2]

siSL_rf.5_full_out_of_sample_data_scaled$hit_angle <- (siSL_rf.5_full_out_of_sample_data_scaled$hit_angle - siSL_center_values[3]) / siSL_scale_values[3]

siSL_rf.5.prob <- predict(siSL_rf.5, siSL_rf.5_full_out_of_sample_data_scaled, type = "response")

siSL_rf.5_full_out_of_sample_data <- cbind(filter(siSL_rf.5_full_out_of_sample_data, row %in% siSL_out_of_training_rows), siSL_rf.5.prob)

names(siSL_rf.5_full_out_of_sample_data)[65] <- "fits"
names(siSL_rf.5_full_out_of_sample_data)

siSL_rf.5_full_out_of_sample_data_reduced <- siSL_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

siSL_rf.5_mean_table <- siSL_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

siSL_rf.5_full_out_of_sample_data$type <- with(siSL_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

siSL_rf.5_full_out_of_sample_data$hit_label <- with(siSL_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

siSL_rf.5_plot1 <- ggplot(siSL_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siSL_rf.5_plot1

siSL_rf.5_plot2 <- ggplot(siSL_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siSL_rf.5_plot2

siSL_rf.5_plot3 <- ggplot(siSL_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siSL_rf.5_plot3

siSL_grid_plot_rf.5 <- grid.arrange(siSL_rf.5_plot1, siSL_rf.5_plot2, siSL_rf.5_plot3, ncol = 3)
siSL_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

siSL_test_rows <- siSL_test$row
siSL_validate_rows <- siSL_validate$row
siSL_pred_data_emp_1 <- ungroup(siSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siSL_test_rows)

siSL_pred_data_emp <- ungroup(siSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siSL_validate_rows) %>%
	rbind(siSL_pred_data_emp_1)

siSL_out_of_training_rows <- siSL_pred_data_emp$row

siSL_pred_data_emp <- ungroup(siSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siSL_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

siSL_pred_data_emp_scaled <- siSL_pred_data_emp

siSL_pred_data_emp_scaled$hit_speed <- (siSL_pred_data_emp_scaled$hit_speed - siSL_center_values[2]) / siSL_scale_values[2]

siSL_pred_data_emp_scaled$hit_angle <- (siSL_pred_data_emp_scaled$hit_angle - siSL_center_values[3]) / siSL_scale_values[3]

siSL_pred_prob_hit <- predict(siSL_rf.5, siSL_pred_data_emp_scaled, type = "prob")[,2]
siSL_pred_prob_hit_fits <- cbind(siSL_pred_data_emp, siSL_pred_prob_hit)

siSL_pred_prob_hit_fits[,c(1:2)] <- siSL_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

siSL_angle_speed_pred <- siSL_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = siSL_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nSI-SL Hit Probability\n") + theme_bp_grey()

siSL_angle_speed_pred
#####
knSL$hit_distance_sc <- as.numeric(knSL$hit_distance_sc, na.rm = TRUE)
knSL$hit_angle <- as.numeric(knSL$hit_angle, na.rm = TRUE)
knSL$hit_speed <- as.numeric(knSL$hit_speed, na.rm = TRUE)

knSL$hit <- with(knSL, ifelse(grepl("Single", knSL$events), 1,
															ifelse(grepl("Double", knSL$events), 1,
																		 ifelse(grepl("Triple", knSL$events), 1, 
																		 			 ifelse(grepl("Home Run", knSL$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

knSL$fieldingTeam <- with(knSL, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[knSL$hit_distance_sc == "null"] = NA
#knSL$hit_speed[knSL$hit_speed == "null"] = NA
#knSL$hit_angle[knSL$hit_angle == "null"] = NA

# include row names for unique record identification

knSL$row <- row.names(knSL) %>% as.numeric()

# recode stand and home_team as factors

knSL$stand <- as.factor(knSL$stand)
knSL$home_team <- as.factor(knSL$home_team)


knSL$game_date <- as.Date(knSL$game_date)


# subset 

knSL_working_data <- ungroup(knSL) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(knSL_working_data)
str(ungroup(knSL))
table(knSL_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

knSL_working_data <- filter(knSL_working_data, hc_x != 1, hc_y != 1)
head(knSL_working_data)

# create training and test sets
# scaled data

set.seed(42)
knSL_train <- sample_frac(knSL_working_data, .15, replace = FALSE)
knSL_split <- setdiff(knSL_working_data, knSL_train)
knSL_test <- sample_frac(knSL_split, .50, replace = FALSE)
knSL_validate <- setdiff(knSL_split, knSL_test)

nrow(knSL_train) + nrow(knSL_test) + nrow(knSL_validate) == nrow(knSL_working_data)

with(knSL_train, table(hit)) %>% prop.table()
with(knSL_test, table(hit)) %>% prop.table()
with(knSL_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(knSL)
##as.numeric(knSL$hit_distance_sc, knSL$hit_speed, knSL$hit_angle)

#knSL_train$hit_distance_sc <- as.numeric(knSL_train$hit_distance_sc)
#knSL_train$hit_speed <- as.numeric(knSL_train$hit_speed)
#knSL_train$hit_angle <- as.numeric(knSL_train$hit_angle)
#View(knSL_train)
knSL_scaled_data <- scale(knSL_train[,c(1:5)])
knSL_scale_values <- attr(knSL_scaled_data, 'scaled:scale')
knSL_scale_values
knSL_center_values <- attr(knSL_scaled_data, 'scaled:center')
knSL_center_values
knSL_train <- cbind(knSL_scaled_data, select(knSL_train, hit:row))

# save levels for factor variables
knSL_levels_home_team <- levels(knSL_train$home_team)
knSL_levels_stand <- levels(knSL_train$stand)
knSL_levels_fieldingTeam <- levels(knSL_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(knSL_test)

knSL_test$hit_distance_sc <- (knSL_test$hit_distance_sc - knSL_center_values[1]) / knSL_scale_values[1]

knSL_test$hit_speed <- (knSL_test$hit_speed - knSL_center_values[2]) / knSL_scale_values[2]

knSL_test$hit_angle <- (knSL_test$hit_angle - knSL_center_values[3]) / knSL_scale_values[3]

knSL_test$hc_x <- (knSL_test$hc_x - knSL_center_values[4]) / knSL_scale_values[4]

knSL_test$hc_y <- (knSL_test$hc_y - knSL_center_values[5]) / knSL_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

knSL_validate$hit_distance_sc <- (knSL_validate$hit_distance_sc - knSL_center_values[1]) / knSL_scale_values[1]

knSL_validate$hit_speed <- (knSL_validate$hit_speed - knSL_center_values[2]) / knSL_scale_values[2]

knSL_validate$hit_angle <- (knSL_validate$hit_angle - knSL_center_values[3]) / knSL_scale_values[3]

knSL_validate$hc_x <- (knSL_validate$hc_x - knSL_center_values[4]) / knSL_scale_values[4]

knSL_validate$hc_y <- (knSL_validate$hc_y - knSL_center_values[5]) / knSL_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(knSL_train)

set.seed(42)
knSL_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(knSL_train, -row), ntree = 501, importance = TRUE)

print(knSL_rf.1)

plot(knSL_rf.1)

varImpPlot(knSL_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
knSL_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(knSL_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(knSL_rf.5)

plot(knSL_rf.5)

varImpPlot(knSL_rf.5)

knSL_predict_fit.rf.5 <- data.frame(fits = predict(knSL_rf.5, knSL_test, type = "prob")[,2], actuals = knSL_test$hit)

knSL_pred.rf.5 <- prediction(knSL_predict_fit.rf.5$fits, knSL_predict_fit.rf.5$actuals)

knSL_roc.pred.rf.5 <- performance(knSL_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(knSL_roc.pred.rf.5)
abline(a = 0, b = 1)
knSL_opt <- opt.cut(knSL_roc.pred.rf.5, knSL_pred.rf.5)
knSL_opt
knSL_opt <- knSL_opt[3]
knSL_predict_fit.rf.5$fits <- with(knSL_predict_fit.rf.5, ifelse(fits > knSL_opt, 1, 0)) 

str(knSL_test)

#knSL_test$fieldingTeam <- as.character(knSL_test$fieldingTeam)
#knSL_test$home_team <- as.character(knSL_test$home_team)
#knSL_test$hit <- as.logical(knSL_test$hit)
#knSL_test$stand <- as.logical(knSL_test$stand)
str(knSL_test)
knSL_rf.5_confusion_test <- confusionMatrix(model = knSL_rf.5, x = knSL_test, y = knSL_test$hit)
knSL_rf.5_confusion_validate <- confusionMatrix(model = knSL_rf.5, x = knSL_validate, y = knSL_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


knSL_test_rows <- knSL_test$row
knSL_validate_rows <- knSL_validate$row
knSL_pred_data_emp_1 <- ungroup(knSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knSL_test_rows)

knSL_pred_data_emp <- ungroup(knSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knSL_validate_rows) %>%
	rbind(knSL_pred_data_emp_1)

knSL_out_of_training_rows <- knSL_pred_data_emp$row

knSL_rf.5_full_out_of_sample_data <- ungroup(knSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knSL_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



knSL_rf.5_full_out_of_sample_data_scaled <- knSL_rf.5_full_out_of_sample_data

knSL_rf.5_full_out_of_sample_data_scaled$hit_speed <- (knSL_rf.5_full_out_of_sample_data_scaled$hit_speed - knSL_center_values[2]) / knSL_scale_values[2]

knSL_rf.5_full_out_of_sample_data_scaled$hit_angle <- (knSL_rf.5_full_out_of_sample_data_scaled$hit_angle - knSL_center_values[3]) / knSL_scale_values[3]

knSL_rf.5.prob <- predict(knSL_rf.5, knSL_rf.5_full_out_of_sample_data_scaled, type = "response")

knSL_rf.5_full_out_of_sample_data <- cbind(filter(knSL_rf.5_full_out_of_sample_data, row %in% knSL_out_of_training_rows), knSL_rf.5.prob)

names(knSL_rf.5_full_out_of_sample_data)[65] <- "fits"
names(knSL_rf.5_full_out_of_sample_data)

knSL_rf.5_full_out_of_sample_data_reduced <- knSL_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

knSL_rf.5_mean_table <- knSL_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

knSL_rf.5_full_out_of_sample_data$type <- with(knSL_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

knSL_rf.5_full_out_of_sample_data$hit_label <- with(knSL_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

knSL_rf.5_plot1 <- ggplot(knSL_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knSL_rf.5_plot1

knSL_rf.5_plot2 <- ggplot(knSL_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knSL_rf.5_plot2

knSL_rf.5_plot3 <- ggplot(knSL_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knSL_rf.5_plot3

knSL_grid_plot_rf.5 <- grid.arrange(knSL_rf.5_plot1, knSL_rf.5_plot2, knSL_rf.5_plot3, ncol = 3)
knSL_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

knSL_test_rows <- knSL_test$row
knSL_validate_rows <- knSL_validate$row
knSL_pred_data_emp_1 <- ungroup(knSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knSL_test_rows)

knSL_pred_data_emp <- ungroup(knSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knSL_validate_rows) %>%
	rbind(knSL_pred_data_emp_1)

knSL_out_of_training_rows <- knSL_pred_data_emp$row

knSL_pred_data_emp <- ungroup(knSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knSL_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

knSL_pred_data_emp_scaled <- knSL_pred_data_emp

knSL_pred_data_emp_scaled$hit_speed <- (knSL_pred_data_emp_scaled$hit_speed - knSL_center_values[2]) / knSL_scale_values[2]

knSL_pred_data_emp_scaled$hit_angle <- (knSL_pred_data_emp_scaled$hit_angle - knSL_center_values[3]) / knSL_scale_values[3]

knSL_pred_prob_hit <- predict(knSL_rf.5, knSL_pred_data_emp_scaled, type = "prob")[,2]
knSL_pred_prob_hit_fits <- cbind(knSL_pred_data_emp, knSL_pred_prob_hit)

knSL_pred_prob_hit_fits[,c(1:2)] <- knSL_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

knSL_angle_speed_pred <- knSL_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = knSL_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nKN-SL Hit Probability\n") + theme_bp_grey()

knSL_angle_speed_pred
#####
kcSL$hit_distance_sc <- as.numeric(kcSL$hit_distance_sc, na.rm = TRUE)
kcSL$hit_angle <- as.numeric(kcSL$hit_angle, na.rm = TRUE)
kcSL$hit_speed <- as.numeric(kcSL$hit_speed, na.rm = TRUE)

kcSL$hit <- with(kcSL, ifelse(grepl("Single", kcSL$events), 1,
															ifelse(grepl("Double", kcSL$events), 1,
																		 ifelse(grepl("Triple", kcSL$events), 1, 
																		 			 ifelse(grepl("Home Run", kcSL$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

kcSL$fieldingTeam <- with(kcSL, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[kcSL$hit_distance_sc == "null"] = NA
#kcSL$hit_speed[kcSL$hit_speed == "null"] = NA
#kcSL$hit_angle[kcSL$hit_angle == "null"] = NA

# include row names for unique record identification

kcSL$row <- row.names(kcSL) %>% as.numeric()

# recode stand and home_team as factors

kcSL$stand <- as.factor(kcSL$stand)
kcSL$home_team <- as.factor(kcSL$home_team)


kcSL$game_date <- as.Date(kcSL$game_date)


# subset 

kcSL_working_data <- ungroup(kcSL) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(kcSL_working_data)
str(ungroup(kcSL))
table(kcSL_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

kcSL_working_data <- filter(kcSL_working_data, hc_x != 1, hc_y != 1)
head(kcSL_working_data)

# create training and test sets
# scaled data

set.seed(42)
kcSL_train <- sample_frac(kcSL_working_data, .15, replace = FALSE)
kcSL_split <- setdiff(kcSL_working_data, kcSL_train)
kcSL_test <- sample_frac(kcSL_split, .50, replace = FALSE)
kcSL_validate <- setdiff(kcSL_split, kcSL_test)

nrow(kcSL_train) + nrow(kcSL_test) + nrow(kcSL_validate) == nrow(kcSL_working_data)

with(kcSL_train, table(hit)) %>% prop.table()
with(kcSL_test, table(hit)) %>% prop.table()
with(kcSL_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(kcSL)
##as.numeric(kcSL$hit_distance_sc, kcSL$hit_speed, kcSL$hit_angle)

#kcSL_train$hit_distance_sc <- as.numeric(kcSL_train$hit_distance_sc)
#kcSL_train$hit_speed <- as.numeric(kcSL_train$hit_speed)
#kcSL_train$hit_angle <- as.numeric(kcSL_train$hit_angle)
#View(kcSL_train)
kcSL_scaled_data <- scale(kcSL_train[,c(1:5)])
kcSL_scale_values <- attr(kcSL_scaled_data, 'scaled:scale')
kcSL_scale_values
kcSL_center_values <- attr(kcSL_scaled_data, 'scaled:center')
kcSL_center_values
kcSL_train <- cbind(kcSL_scaled_data, select(kcSL_train, hit:row))

# save levels for factor variables
kcSL_levels_home_team <- levels(kcSL_train$home_team)
kcSL_levels_stand <- levels(kcSL_train$stand)
kcSL_levels_fieldingTeam <- levels(kcSL_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(kcSL_test)

kcSL_test$hit_distance_sc <- (kcSL_test$hit_distance_sc - kcSL_center_values[1]) / kcSL_scale_values[1]

kcSL_test$hit_speed <- (kcSL_test$hit_speed - kcSL_center_values[2]) / kcSL_scale_values[2]

kcSL_test$hit_angle <- (kcSL_test$hit_angle - kcSL_center_values[3]) / kcSL_scale_values[3]

kcSL_test$hc_x <- (kcSL_test$hc_x - kcSL_center_values[4]) / kcSL_scale_values[4]

kcSL_test$hc_y <- (kcSL_test$hc_y - kcSL_center_values[5]) / kcSL_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

kcSL_validate$hit_distance_sc <- (kcSL_validate$hit_distance_sc - kcSL_center_values[1]) / kcSL_scale_values[1]

kcSL_validate$hit_speed <- (kcSL_validate$hit_speed - kcSL_center_values[2]) / kcSL_scale_values[2]

kcSL_validate$hit_angle <- (kcSL_validate$hit_angle - kcSL_center_values[3]) / kcSL_scale_values[3]

kcSL_validate$hc_x <- (kcSL_validate$hc_x - kcSL_center_values[4]) / kcSL_scale_values[4]

kcSL_validate$hc_y <- (kcSL_validate$hc_y - kcSL_center_values[5]) / kcSL_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(kcSL_train)

set.seed(42)
kcSL_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(kcSL_train, -row), ntree = 501, importance = TRUE)

print(kcSL_rf.1)

plot(kcSL_rf.1)

varImpPlot(kcSL_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
kcSL_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(kcSL_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(kcSL_rf.5)

plot(kcSL_rf.5)

varImpPlot(kcSL_rf.5)

kcSL_predict_fit.rf.5 <- data.frame(fits = predict(kcSL_rf.5, kcSL_test, type = "prob")[,2], actuals = kcSL_test$hit)

kcSL_pred.rf.5 <- prediction(kcSL_predict_fit.rf.5$fits, kcSL_predict_fit.rf.5$actuals)

kcSL_roc.pred.rf.5 <- performance(kcSL_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(kcSL_roc.pred.rf.5)
abline(a = 0, b = 1)
kcSL_opt <- opt.cut(kcSL_roc.pred.rf.5, kcSL_pred.rf.5)
kcSL_opt
kcSL_opt <- kcSL_opt[3]
kcSL_predict_fit.rf.5$fits <- with(kcSL_predict_fit.rf.5, ifelse(fits > kcSL_opt, 1, 0)) 

str(kcSL_test)

#kcSL_test$fieldingTeam <- as.character(kcSL_test$fieldingTeam)
#kcSL_test$home_team <- as.character(kcSL_test$home_team)
#kcSL_test$hit <- as.logical(kcSL_test$hit)
#kcSL_test$stand <- as.logical(kcSL_test$stand)
str(kcSL_test)
kcSL_rf.5_confusion_test <- confusionMatrix(model = kcSL_rf.5, x = kcSL_test, y = kcSL_test$hit)
kcSL_rf.5_confusion_validate <- confusionMatrix(model = kcSL_rf.5, x = kcSL_validate, y = kcSL_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


kcSL_test_rows <- kcSL_test$row
kcSL_validate_rows <- kcSL_validate$row
kcSL_pred_data_emp_1 <- ungroup(kcSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcSL_test_rows)

kcSL_pred_data_emp <- ungroup(kcSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcSL_validate_rows) %>%
	rbind(kcSL_pred_data_emp_1)

kcSL_out_of_training_rows <- kcSL_pred_data_emp$row

kcSL_rf.5_full_out_of_sample_data <- ungroup(kcSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcSL_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



kcSL_rf.5_full_out_of_sample_data_scaled <- kcSL_rf.5_full_out_of_sample_data

kcSL_rf.5_full_out_of_sample_data_scaled$hit_speed <- (kcSL_rf.5_full_out_of_sample_data_scaled$hit_speed - kcSL_center_values[2]) / kcSL_scale_values[2]

kcSL_rf.5_full_out_of_sample_data_scaled$hit_angle <- (kcSL_rf.5_full_out_of_sample_data_scaled$hit_angle - kcSL_center_values[3]) / kcSL_scale_values[3]

kcSL_rf.5.prob <- predict(kcSL_rf.5, kcSL_rf.5_full_out_of_sample_data_scaled, type = "response")

kcSL_rf.5_full_out_of_sample_data <- cbind(filter(kcSL_rf.5_full_out_of_sample_data, row %in% kcSL_out_of_training_rows), kcSL_rf.5.prob)

names(kcSL_rf.5_full_out_of_sample_data)[65] <- "fits"
names(kcSL_rf.5_full_out_of_sample_data)

kcSL_rf.5_full_out_of_sample_data_reduced <- kcSL_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

kcSL_rf.5_mean_table <- kcSL_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

kcSL_rf.5_full_out_of_sample_data$type <- with(kcSL_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

kcSL_rf.5_full_out_of_sample_data$hit_label <- with(kcSL_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

kcSL_rf.5_plot1 <- ggplot(kcSL_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcSL_rf.5_plot1

kcSL_rf.5_plot2 <- ggplot(kcSL_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcSL_rf.5_plot2

kcSL_rf.5_plot3 <- ggplot(kcSL_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcSL_rf.5_plot3

kcSL_grid_plot_rf.5 <- grid.arrange(kcSL_rf.5_plot1, kcSL_rf.5_plot2, kcSL_rf.5_plot3, ncol = 3)
kcSL_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

kcSL_test_rows <- kcSL_test$row
kcSL_validate_rows <- kcSL_validate$row
kcSL_pred_data_emp_1 <- ungroup(kcSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcSL_test_rows)

kcSL_pred_data_emp <- ungroup(kcSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcSL_validate_rows) %>%
	rbind(kcSL_pred_data_emp_1)

kcSL_out_of_training_rows <- kcSL_pred_data_emp$row

kcSL_pred_data_emp <- ungroup(kcSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcSL_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

kcSL_pred_data_emp_scaled <- kcSL_pred_data_emp

kcSL_pred_data_emp_scaled$hit_speed <- (kcSL_pred_data_emp_scaled$hit_speed - kcSL_center_values[2]) / kcSL_scale_values[2]

kcSL_pred_data_emp_scaled$hit_angle <- (kcSL_pred_data_emp_scaled$hit_angle - kcSL_center_values[3]) / kcSL_scale_values[3]

kcSL_pred_prob_hit <- predict(kcSL_rf.5, kcSL_pred_data_emp_scaled, type = "prob")[,2]
kcSL_pred_prob_hit_fits <- cbind(kcSL_pred_data_emp, kcSL_pred_prob_hit)

kcSL_pred_prob_hit_fits[,c(1:2)] <- kcSL_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

kcSL_angle_speed_pred <- kcSL_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = kcSL_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nKC-SL Hit Probability\n") + theme_bp_grey()

kcSL_angle_speed_pred
#####
fsSL$hit_distance_sc <- as.numeric(fsSL$hit_distance_sc, na.rm = TRUE)
fsSL$hit_angle <- as.numeric(fsSL$hit_angle, na.rm = TRUE)
fsSL$hit_speed <- as.numeric(fsSL$hit_speed, na.rm = TRUE)

fsSL$hit <- with(fsSL, ifelse(grepl("Single", fsSL$events), 1,
															ifelse(grepl("Double", fsSL$events), 1,
																		 ifelse(grepl("Triple", fsSL$events), 1, 
																		 			 ifelse(grepl("Home Run", fsSL$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

fsSL$fieldingTeam <- with(fsSL, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[fsSL$hit_distance_sc == "null"] = NA
#fsSL$hit_speed[fsSL$hit_speed == "null"] = NA
#fsSL$hit_angle[fsSL$hit_angle == "null"] = NA

# include row names for unique record identification

fsSL$row <- row.names(fsSL) %>% as.numeric()

# recode stand and home_team as factors

fsSL$stand <- as.factor(fsSL$stand)
fsSL$home_team <- as.factor(fsSL$home_team)


fsSL$game_date <- as.Date(fsSL$game_date)


# subset 

fsSL_working_data <- ungroup(fsSL) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(fsSL_working_data)
str(ungroup(fsSL))
table(fsSL_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

fsSL_working_data <- filter(fsSL_working_data, hc_x != 1, hc_y != 1)
head(fsSL_working_data)

# create training and test sets
# scaled data

set.seed(42)
fsSL_train <- sample_frac(fsSL_working_data, .15, replace = FALSE)
fsSL_split <- setdiff(fsSL_working_data, fsSL_train)
fsSL_test <- sample_frac(fsSL_split, .50, replace = FALSE)
fsSL_validate <- setdiff(fsSL_split, fsSL_test)

nrow(fsSL_train) + nrow(fsSL_test) + nrow(fsSL_validate) == nrow(fsSL_working_data)

with(fsSL_train, table(hit)) %>% prop.table()
with(fsSL_test, table(hit)) %>% prop.table()
with(fsSL_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(fsSL)
##as.numeric(fsSL$hit_distance_sc, fsSL$hit_speed, fsSL$hit_angle)

#fsSL_train$hit_distance_sc <- as.numeric(fsSL_train$hit_distance_sc)
#fsSL_train$hit_speed <- as.numeric(fsSL_train$hit_speed)
#fsSL_train$hit_angle <- as.numeric(fsSL_train$hit_angle)
#View(fsSL_train)
fsSL_scaled_data <- scale(fsSL_train[,c(1:5)])
fsSL_scale_values <- attr(fsSL_scaled_data, 'scaled:scale')
fsSL_scale_values
fsSL_center_values <- attr(fsSL_scaled_data, 'scaled:center')
fsSL_center_values
fsSL_train <- cbind(fsSL_scaled_data, select(fsSL_train, hit:row))

# save levels for factor variables
fsSL_levels_home_team <- levels(fsSL_train$home_team)
fsSL_levels_stand <- levels(fsSL_train$stand)
fsSL_levels_fieldingTeam <- levels(fsSL_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(fsSL_test)

fsSL_test$hit_distance_sc <- (fsSL_test$hit_distance_sc - fsSL_center_values[1]) / fsSL_scale_values[1]

fsSL_test$hit_speed <- (fsSL_test$hit_speed - fsSL_center_values[2]) / fsSL_scale_values[2]

fsSL_test$hit_angle <- (fsSL_test$hit_angle - fsSL_center_values[3]) / fsSL_scale_values[3]

fsSL_test$hc_x <- (fsSL_test$hc_x - fsSL_center_values[4]) / fsSL_scale_values[4]

fsSL_test$hc_y <- (fsSL_test$hc_y - fsSL_center_values[5]) / fsSL_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

fsSL_validate$hit_distance_sc <- (fsSL_validate$hit_distance_sc - fsSL_center_values[1]) / fsSL_scale_values[1]

fsSL_validate$hit_speed <- (fsSL_validate$hit_speed - fsSL_center_values[2]) / fsSL_scale_values[2]

fsSL_validate$hit_angle <- (fsSL_validate$hit_angle - fsSL_center_values[3]) / fsSL_scale_values[3]

fsSL_validate$hc_x <- (fsSL_validate$hc_x - fsSL_center_values[4]) / fsSL_scale_values[4]

fsSL_validate$hc_y <- (fsSL_validate$hc_y - fsSL_center_values[5]) / fsSL_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(fsSL_train)

set.seed(42)
fsSL_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(fsSL_train, -row), ntree = 501, importance = TRUE)

print(fsSL_rf.1)

plot(fsSL_rf.1)

varImpPlot(fsSL_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
fsSL_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(fsSL_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(fsSL_rf.5)

plot(fsSL_rf.5)

varImpPlot(fsSL_rf.5)

fsSL_predict_fit.rf.5 <- data.frame(fits = predict(fsSL_rf.5, fsSL_test, type = "prob")[,2], actuals = fsSL_test$hit)

fsSL_pred.rf.5 <- prediction(fsSL_predict_fit.rf.5$fits, fsSL_predict_fit.rf.5$actuals)

fsSL_roc.pred.rf.5 <- performance(fsSL_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(fsSL_roc.pred.rf.5)
abline(a = 0, b = 1)
fsSL_opt <- opt.cut(fsSL_roc.pred.rf.5, fsSL_pred.rf.5)
fsSL_opt
fsSL_opt <- fsSL_opt[3]
fsSL_predict_fit.rf.5$fits <- with(fsSL_predict_fit.rf.5, ifelse(fits > fsSL_opt, 1, 0)) 

str(fsSL_test)

#fsSL_test$fieldingTeam <- as.character(fsSL_test$fieldingTeam)
#fsSL_test$home_team <- as.character(fsSL_test$home_team)
#fsSL_test$hit <- as.logical(fsSL_test$hit)
#fsSL_test$stand <- as.logical(fsSL_test$stand)
str(fsSL_test)
fsSL_rf.5_confusion_test <- confusionMatrix(model = fsSL_rf.5, x = fsSL_test, y = fsSL_test$hit)
fsSL_rf.5_confusion_validate <- confusionMatrix(model = fsSL_rf.5, x = fsSL_validate, y = fsSL_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


fsSL_test_rows <- fsSL_test$row
fsSL_validate_rows <- fsSL_validate$row
fsSL_pred_data_emp_1 <- ungroup(fsSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsSL_test_rows)

fsSL_pred_data_emp <- ungroup(fsSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsSL_validate_rows) %>%
	rbind(fsSL_pred_data_emp_1)

fsSL_out_of_training_rows <- fsSL_pred_data_emp$row

fsSL_rf.5_full_out_of_sample_data <- ungroup(fsSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsSL_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



fsSL_rf.5_full_out_of_sample_data_scaled <- fsSL_rf.5_full_out_of_sample_data

fsSL_rf.5_full_out_of_sample_data_scaled$hit_speed <- (fsSL_rf.5_full_out_of_sample_data_scaled$hit_speed - fsSL_center_values[2]) / fsSL_scale_values[2]

fsSL_rf.5_full_out_of_sample_data_scaled$hit_angle <- (fsSL_rf.5_full_out_of_sample_data_scaled$hit_angle - fsSL_center_values[3]) / fsSL_scale_values[3]

fsSL_rf.5.prob <- predict(fsSL_rf.5, fsSL_rf.5_full_out_of_sample_data_scaled, type = "response")

fsSL_rf.5_full_out_of_sample_data <- cbind(filter(fsSL_rf.5_full_out_of_sample_data, row %in% fsSL_out_of_training_rows), fsSL_rf.5.prob)

names(fsSL_rf.5_full_out_of_sample_data)[65] <- "fits"
names(fsSL_rf.5_full_out_of_sample_data)

fsSL_rf.5_full_out_of_sample_data_reduced <- fsSL_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

fsSL_rf.5_mean_table <- fsSL_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

fsSL_rf.5_full_out_of_sample_data$type <- with(fsSL_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

fsSL_rf.5_full_out_of_sample_data$hit_label <- with(fsSL_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

fsSL_rf.5_plot1 <- ggplot(fsSL_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsSL_rf.5_plot1

fsSL_rf.5_plot2 <- ggplot(fsSL_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsSL_rf.5_plot2

fsSL_rf.5_plot3 <- ggplot(fsSL_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsSL_rf.5_plot3

fsSL_grid_plot_rf.5 <- grid.arrange(fsSL_rf.5_plot1, fsSL_rf.5_plot2, fsSL_rf.5_plot3, ncol = 3)
fsSL_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

fsSL_test_rows <- fsSL_test$row
fsSL_validate_rows <- fsSL_validate$row
fsSL_pred_data_emp_1 <- ungroup(fsSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsSL_test_rows)

fsSL_pred_data_emp <- ungroup(fsSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsSL_validate_rows) %>%
	rbind(fsSL_pred_data_emp_1)

fsSL_out_of_training_rows <- fsSL_pred_data_emp$row

fsSL_pred_data_emp <- ungroup(fsSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsSL_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

fsSL_pred_data_emp_scaled <- fsSL_pred_data_emp

fsSL_pred_data_emp_scaled$hit_speed <- (fsSL_pred_data_emp_scaled$hit_speed - fsSL_center_values[2]) / fsSL_scale_values[2]

fsSL_pred_data_emp_scaled$hit_angle <- (fsSL_pred_data_emp_scaled$hit_angle - fsSL_center_values[3]) / fsSL_scale_values[3]

fsSL_pred_prob_hit <- predict(fsSL_rf.5, fsSL_pred_data_emp_scaled, type = "prob")[,2]
fsSL_pred_prob_hit_fits <- cbind(fsSL_pred_data_emp, fsSL_pred_prob_hit)

fsSL_pred_prob_hit_fits[,c(1:2)] <- fsSL_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

fsSL_angle_speed_pred <- fsSL_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = fsSL_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFS-SL Hit Probability\n") + theme_bp_grey()

fsSL_angle_speed_pred
#####
fcSL$hit_distance_sc <- as.numeric(fcSL$hit_distance_sc, na.rm = TRUE)
fcSL$hit_angle <- as.numeric(fcSL$hit_angle, na.rm = TRUE)
fcSL$hit_speed <- as.numeric(fcSL$hit_speed, na.rm = TRUE)

fcSL$hit <- with(fcSL, ifelse(grepl("Single", fcSL$events), 1,
															ifelse(grepl("Double", fcSL$events), 1,
																		 ifelse(grepl("Triple", fcSL$events), 1, 
																		 			 ifelse(grepl("Home Run", fcSL$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

fcSL$fieldingTeam <- with(fcSL, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[fcSL$hit_distance_sc == "null"] = NA
#fcSL$hit_speed[fcSL$hit_speed == "null"] = NA
#fcSL$hit_angle[fcSL$hit_angle == "null"] = NA

# include row names for unique record identification

fcSL$row <- row.names(fcSL) %>% as.numeric()

# recode stand and home_team as factors

fcSL$stand <- as.factor(fcSL$stand)
fcSL$home_team <- as.factor(fcSL$home_team)


fcSL$game_date <- as.Date(fcSL$game_date)


# subset 

fcSL_working_data <- ungroup(fcSL) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(fcSL_working_data)
str(ungroup(fcSL))
table(fcSL_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

fcSL_working_data <- filter(fcSL_working_data, hc_x != 1, hc_y != 1)
head(fcSL_working_data)

# create training and test sets
# scaled data

set.seed(42)
fcSL_train <- sample_frac(fcSL_working_data, .15, replace = FALSE)
fcSL_split <- setdiff(fcSL_working_data, fcSL_train)
fcSL_test <- sample_frac(fcSL_split, .50, replace = FALSE)
fcSL_validate <- setdiff(fcSL_split, fcSL_test)

nrow(fcSL_train) + nrow(fcSL_test) + nrow(fcSL_validate) == nrow(fcSL_working_data)

with(fcSL_train, table(hit)) %>% prop.table()
with(fcSL_test, table(hit)) %>% prop.table()
with(fcSL_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(fcSL)
##as.numeric(fcSL$hit_distance_sc, fcSL$hit_speed, fcSL$hit_angle)

#fcSL_train$hit_distance_sc <- as.numeric(fcSL_train$hit_distance_sc)
#fcSL_train$hit_speed <- as.numeric(fcSL_train$hit_speed)
#fcSL_train$hit_angle <- as.numeric(fcSL_train$hit_angle)
#View(fcSL_train)
fcSL_scaled_data <- scale(fcSL_train[,c(1:5)])
fcSL_scale_values <- attr(fcSL_scaled_data, 'scaled:scale')
fcSL_scale_values
fcSL_center_values <- attr(fcSL_scaled_data, 'scaled:center')
fcSL_center_values
fcSL_train <- cbind(fcSL_scaled_data, select(fcSL_train, hit:row))

# save levels for factor variables
fcSL_levels_home_team <- levels(fcSL_train$home_team)
fcSL_levels_stand <- levels(fcSL_train$stand)
fcSL_levels_fieldingTeam <- levels(fcSL_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(fcSL_test)

fcSL_test$hit_distance_sc <- (fcSL_test$hit_distance_sc - fcSL_center_values[1]) / fcSL_scale_values[1]

fcSL_test$hit_speed <- (fcSL_test$hit_speed - fcSL_center_values[2]) / fcSL_scale_values[2]

fcSL_test$hit_angle <- (fcSL_test$hit_angle - fcSL_center_values[3]) / fcSL_scale_values[3]

fcSL_test$hc_x <- (fcSL_test$hc_x - fcSL_center_values[4]) / fcSL_scale_values[4]

fcSL_test$hc_y <- (fcSL_test$hc_y - fcSL_center_values[5]) / fcSL_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

fcSL_validate$hit_distance_sc <- (fcSL_validate$hit_distance_sc - fcSL_center_values[1]) / fcSL_scale_values[1]

fcSL_validate$hit_speed <- (fcSL_validate$hit_speed - fcSL_center_values[2]) / fcSL_scale_values[2]

fcSL_validate$hit_angle <- (fcSL_validate$hit_angle - fcSL_center_values[3]) / fcSL_scale_values[3]

fcSL_validate$hc_x <- (fcSL_validate$hc_x - fcSL_center_values[4]) / fcSL_scale_values[4]

fcSL_validate$hc_y <- (fcSL_validate$hc_y - fcSL_center_values[5]) / fcSL_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(fcSL_train)

set.seed(42)
fcSL_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(fcSL_train, -row), ntree = 501, importance = TRUE)

print(fcSL_rf.1)

plot(fcSL_rf.1)

varImpPlot(fcSL_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
fcSL_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(fcSL_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(fcSL_rf.5)

plot(fcSL_rf.5)

varImpPlot(fcSL_rf.5)

fcSL_predict_fit.rf.5 <- data.frame(fits = predict(fcSL_rf.5, fcSL_test, type = "prob")[,2], actuals = fcSL_test$hit)

fcSL_pred.rf.5 <- prediction(fcSL_predict_fit.rf.5$fits, fcSL_predict_fit.rf.5$actuals)

fcSL_roc.pred.rf.5 <- performance(fcSL_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(fcSL_roc.pred.rf.5)
abline(a = 0, b = 1)
fcSL_opt <- opt.cut(fcSL_roc.pred.rf.5, fcSL_pred.rf.5)
fcSL_opt
fcSL_opt <- fcSL_opt[3]
fcSL_predict_fit.rf.5$fits <- with(fcSL_predict_fit.rf.5, ifelse(fits > fcSL_opt, 1, 0)) 

str(fcSL_test)

#fcSL_test$fieldingTeam <- as.character(fcSL_test$fieldingTeam)
#fcSL_test$home_team <- as.character(fcSL_test$home_team)
#fcSL_test$hit <- as.logical(fcSL_test$hit)
#fcSL_test$stand <- as.logical(fcSL_test$stand)
str(fcSL_test)
fcSL_rf.5_confusion_test <- confusionMatrix(model = fcSL_rf.5, x = fcSL_test, y = fcSL_test$hit)
fcSL_rf.5_confusion_validate <- confusionMatrix(model = fcSL_rf.5, x = fcSL_validate, y = fcSL_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


fcSL_test_rows <- fcSL_test$row
fcSL_validate_rows <- fcSL_validate$row
fcSL_pred_data_emp_1 <- ungroup(fcSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcSL_test_rows)

fcSL_pred_data_emp <- ungroup(fcSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcSL_validate_rows) %>%
	rbind(fcSL_pred_data_emp_1)

fcSL_out_of_training_rows <- fcSL_pred_data_emp$row

fcSL_rf.5_full_out_of_sample_data <- ungroup(fcSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcSL_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



fcSL_rf.5_full_out_of_sample_data_scaled <- fcSL_rf.5_full_out_of_sample_data

fcSL_rf.5_full_out_of_sample_data_scaled$hit_speed <- (fcSL_rf.5_full_out_of_sample_data_scaled$hit_speed - fcSL_center_values[2]) / fcSL_scale_values[2]

fcSL_rf.5_full_out_of_sample_data_scaled$hit_angle <- (fcSL_rf.5_full_out_of_sample_data_scaled$hit_angle - fcSL_center_values[3]) / fcSL_scale_values[3]

fcSL_rf.5.prob <- predict(fcSL_rf.5, fcSL_rf.5_full_out_of_sample_data_scaled, type = "response")

fcSL_rf.5_full_out_of_sample_data <- cbind(filter(fcSL_rf.5_full_out_of_sample_data, row %in% fcSL_out_of_training_rows), fcSL_rf.5.prob)

names(fcSL_rf.5_full_out_of_sample_data)[65] <- "fits"
names(fcSL_rf.5_full_out_of_sample_data)

fcSL_rf.5_full_out_of_sample_data_reduced <- fcSL_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

fcSL_rf.5_mean_table <- fcSL_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

fcSL_rf.5_full_out_of_sample_data$type <- with(fcSL_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

fcSL_rf.5_full_out_of_sample_data$hit_label <- with(fcSL_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

fcSL_rf.5_plot1 <- ggplot(fcSL_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcSL_rf.5_plot1

fcSL_rf.5_plot2 <- ggplot(fcSL_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcSL_rf.5_plot2

fcSL_rf.5_plot3 <- ggplot(fcSL_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcSL_rf.5_plot3

fcSL_grid_plot_rf.5 <- grid.arrange(fcSL_rf.5_plot1, fcSL_rf.5_plot2, fcSL_rf.5_plot3, ncol = 3)
fcSL_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

fcSL_test_rows <- fcSL_test$row
fcSL_validate_rows <- fcSL_validate$row
fcSL_pred_data_emp_1 <- ungroup(fcSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcSL_test_rows)

fcSL_pred_data_emp <- ungroup(fcSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcSL_validate_rows) %>%
	rbind(fcSL_pred_data_emp_1)

fcSL_out_of_training_rows <- fcSL_pred_data_emp$row

fcSL_pred_data_emp <- ungroup(fcSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcSL_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

fcSL_pred_data_emp_scaled <- fcSL_pred_data_emp

fcSL_pred_data_emp_scaled$hit_speed <- (fcSL_pred_data_emp_scaled$hit_speed - fcSL_center_values[2]) / fcSL_scale_values[2]

fcSL_pred_data_emp_scaled$hit_angle <- (fcSL_pred_data_emp_scaled$hit_angle - fcSL_center_values[3]) / fcSL_scale_values[3]

fcSL_pred_prob_hit <- predict(fcSL_rf.5, fcSL_pred_data_emp_scaled, type = "prob")[,2]
fcSL_pred_prob_hit_fits <- cbind(fcSL_pred_data_emp, fcSL_pred_prob_hit)

fcSL_pred_prob_hit_fits[,c(1:2)] <- fcSL_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

fcSL_angle_speed_pred <- fcSL_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = fcSL_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFC-SL Hit Probability\n") + theme_bp_grey()

fcSL_angle_speed_pred
#####
chSL$hit_distance_sc <- as.numeric(chSL$hit_distance_sc, na.rm = TRUE)
chSL$hit_angle <- as.numeric(chSL$hit_angle, na.rm = TRUE)
chSL$hit_speed <- as.numeric(chSL$hit_speed, na.rm = TRUE)

chSL$hit <- with(chSL, ifelse(grepl("Single", chSL$events), 1,
															ifelse(grepl("Double", chSL$events), 1,
																		 ifelse(grepl("Triple", chSL$events), 1, 
																		 			 ifelse(grepl("Home Run", chSL$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

chSL$fieldingTeam <- with(chSL, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[chSL$hit_distance_sc == "null"] = NA
#chSL$hit_speed[chSL$hit_speed == "null"] = NA
#chSL$hit_angle[chSL$hit_angle == "null"] = NA

# include row names for unique record identification

chSL$row <- row.names(chSL) %>% as.numeric()

# recode stand and home_team as factors

chSL$stand <- as.factor(chSL$stand)
chSL$home_team <- as.factor(chSL$home_team)


chSL$game_date <- as.Date(chSL$game_date)


# subset 

chSL_working_data <- ungroup(chSL) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(chSL_working_data)
str(ungroup(chSL))
table(chSL_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

chSL_working_data <- filter(chSL_working_data, hc_x != 1, hc_y != 1)
head(chSL_working_data)

# create training and test sets
# scaled data

set.seed(42)
chSL_train <- sample_frac(chSL_working_data, .15, replace = FALSE)
chSL_split <- setdiff(chSL_working_data, chSL_train)
chSL_test <- sample_frac(chSL_split, .50, replace = FALSE)
chSL_validate <- setdiff(chSL_split, chSL_test)

nrow(chSL_train) + nrow(chSL_test) + nrow(chSL_validate) == nrow(chSL_working_data)

with(chSL_train, table(hit)) %>% prop.table()
with(chSL_test, table(hit)) %>% prop.table()
with(chSL_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(chSL)
##as.numeric(chSL$hit_distance_sc, chSL$hit_speed, chSL$hit_angle)

#chSL_train$hit_distance_sc <- as.numeric(chSL_train$hit_distance_sc)
#chSL_train$hit_speed <- as.numeric(chSL_train$hit_speed)
#chSL_train$hit_angle <- as.numeric(chSL_train$hit_angle)
#View(chSL_train)
chSL_scaled_data <- scale(chSL_train[,c(1:5)])
chSL_scale_values <- attr(chSL_scaled_data, 'scaled:scale')
chSL_scale_values
chSL_center_values <- attr(chSL_scaled_data, 'scaled:center')
chSL_center_values
chSL_train <- cbind(chSL_scaled_data, select(chSL_train, hit:row))

# save levels for factor variables
chSL_levels_home_team <- levels(chSL_train$home_team)
chSL_levels_stand <- levels(chSL_train$stand)
chSL_levels_fieldingTeam <- levels(chSL_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(chSL_test)

chSL_test$hit_distance_sc <- (chSL_test$hit_distance_sc - chSL_center_values[1]) / chSL_scale_values[1]

chSL_test$hit_speed <- (chSL_test$hit_speed - chSL_center_values[2]) / chSL_scale_values[2]

chSL_test$hit_angle <- (chSL_test$hit_angle - chSL_center_values[3]) / chSL_scale_values[3]

chSL_test$hc_x <- (chSL_test$hc_x - chSL_center_values[4]) / chSL_scale_values[4]

chSL_test$hc_y <- (chSL_test$hc_y - chSL_center_values[5]) / chSL_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

chSL_validate$hit_distance_sc <- (chSL_validate$hit_distance_sc - chSL_center_values[1]) / chSL_scale_values[1]

chSL_validate$hit_speed <- (chSL_validate$hit_speed - chSL_center_values[2]) / chSL_scale_values[2]

chSL_validate$hit_angle <- (chSL_validate$hit_angle - chSL_center_values[3]) / chSL_scale_values[3]

chSL_validate$hc_x <- (chSL_validate$hc_x - chSL_center_values[4]) / chSL_scale_values[4]

chSL_validate$hc_y <- (chSL_validate$hc_y - chSL_center_values[5]) / chSL_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(chSL_train)

set.seed(42)
chSL_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(chSL_train, -row), ntree = 501, importance = TRUE)

print(chSL_rf.1)

plot(chSL_rf.1)

varImpPlot(chSL_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
chSL_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(chSL_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(chSL_rf.5)

plot(chSL_rf.5)

varImpPlot(chSL_rf.5)

chSL_predict_fit.rf.5 <- data.frame(fits = predict(chSL_rf.5, chSL_test, type = "prob")[,2], actuals = chSL_test$hit)

chSL_pred.rf.5 <- prediction(chSL_predict_fit.rf.5$fits, chSL_predict_fit.rf.5$actuals)

chSL_roc.pred.rf.5 <- performance(chSL_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(chSL_roc.pred.rf.5)
abline(a = 0, b = 1)
chSL_opt <- opt.cut(chSL_roc.pred.rf.5, chSL_pred.rf.5)
chSL_opt
chSL_opt <- chSL_opt[3]
chSL_predict_fit.rf.5$fits <- with(chSL_predict_fit.rf.5, ifelse(fits > chSL_opt, 1, 0)) 

str(chSL_test)

#chSL_test$fieldingTeam <- as.character(chSL_test$fieldingTeam)
#chSL_test$home_team <- as.character(chSL_test$home_team)
#chSL_test$hit <- as.logical(chSL_test$hit)
#chSL_test$stand <- as.logical(chSL_test$stand)
str(chSL_test)
chSL_rf.5_confusion_test <- confusionMatrix(model = chSL_rf.5, x = chSL_test, y = chSL_test$hit)
chSL_rf.5_confusion_validate <- confusionMatrix(model = chSL_rf.5, x = chSL_validate, y = chSL_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


chSL_test_rows <- chSL_test$row
chSL_validate_rows <- chSL_validate$row
chSL_pred_data_emp_1 <- ungroup(chSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chSL_test_rows)

chSL_pred_data_emp <- ungroup(chSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chSL_validate_rows) %>%
	rbind(chSL_pred_data_emp_1)

chSL_out_of_training_rows <- chSL_pred_data_emp$row

chSL_rf.5_full_out_of_sample_data <- ungroup(chSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chSL_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



chSL_rf.5_full_out_of_sample_data_scaled <- chSL_rf.5_full_out_of_sample_data

chSL_rf.5_full_out_of_sample_data_scaled$hit_speed <- (chSL_rf.5_full_out_of_sample_data_scaled$hit_speed - chSL_center_values[2]) / chSL_scale_values[2]

chSL_rf.5_full_out_of_sample_data_scaled$hit_angle <- (chSL_rf.5_full_out_of_sample_data_scaled$hit_angle - chSL_center_values[3]) / chSL_scale_values[3]

chSL_rf.5.prob <- predict(chSL_rf.5, chSL_rf.5_full_out_of_sample_data_scaled, type = "response")

chSL_rf.5_full_out_of_sample_data <- cbind(filter(chSL_rf.5_full_out_of_sample_data, row %in% chSL_out_of_training_rows), chSL_rf.5.prob)

names(chSL_rf.5_full_out_of_sample_data)[65] <- "fits"
names(chSL_rf.5_full_out_of_sample_data)

chSL_rf.5_full_out_of_sample_data_reduced <- chSL_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

chSL_rf.5_mean_table <- chSL_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

chSL_rf.5_full_out_of_sample_data$type <- with(chSL_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

chSL_rf.5_full_out_of_sample_data$hit_label <- with(chSL_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

chSL_rf.5_plot1 <- ggplot(chSL_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chSL_rf.5_plot1

chSL_rf.5_plot2 <- ggplot(chSL_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chSL_rf.5_plot2

chSL_rf.5_plot3 <- ggplot(chSL_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chSL_rf.5_plot3

chSL_grid_plot_rf.5 <- grid.arrange(chSL_rf.5_plot1, chSL_rf.5_plot2, chSL_rf.5_plot3, ncol = 3)
chSL_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

chSL_test_rows <- chSL_test$row
chSL_validate_rows <- chSL_validate$row
chSL_pred_data_emp_1 <- ungroup(chSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chSL_test_rows)

chSL_pred_data_emp <- ungroup(chSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chSL_validate_rows) %>%
	rbind(chSL_pred_data_emp_1)

chSL_out_of_training_rows <- chSL_pred_data_emp$row

chSL_pred_data_emp <- ungroup(chSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chSL_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

chSL_pred_data_emp_scaled <- chSL_pred_data_emp

chSL_pred_data_emp_scaled$hit_speed <- (chSL_pred_data_emp_scaled$hit_speed - chSL_center_values[2]) / chSL_scale_values[2]

chSL_pred_data_emp_scaled$hit_angle <- (chSL_pred_data_emp_scaled$hit_angle - chSL_center_values[3]) / chSL_scale_values[3]

chSL_pred_prob_hit <- predict(chSL_rf.5, chSL_pred_data_emp_scaled, type = "prob")[,2]
chSL_pred_prob_hit_fits <- cbind(chSL_pred_data_emp, chSL_pred_prob_hit)

chSL_pred_prob_hit_fits[,c(1:2)] <- chSL_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

chSL_angle_speed_pred <- chSL_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = chSL_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nCH-SL Hit Probability\n") + theme_bp_grey()

chSL_angle_speed_pred
#####
ftSL$hit_distance_sc <- as.numeric(ftSL$hit_distance_sc, na.rm = TRUE)
ftSL$hit_angle <- as.numeric(ftSL$hit_angle, na.rm = TRUE)
ftSL$hit_speed <- as.numeric(ftSL$hit_speed, na.rm = TRUE)

ftSL$hit <- with(ftSL, ifelse(grepl("Single", ftSL$events), 1,
															ifelse(grepl("Double", ftSL$events), 1,
																		 ifelse(grepl("Triple", ftSL$events), 1, 
																		 			 ifelse(grepl("Home Run", ftSL$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

ftSL$fieldingTeam <- with(ftSL, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[ftSL$hit_distance_sc == "null"] = NA
#ftSL$hit_speed[ftSL$hit_speed == "null"] = NA
#ftSL$hit_angle[ftSL$hit_angle == "null"] = NA

# include row names for unique record identification

ftSL$row <- row.names(ftSL) %>% as.numeric()

# recode stand and home_team as factors

ftSL$stand <- as.factor(ftSL$stand)
ftSL$home_team <- as.factor(ftSL$home_team)


ftSL$game_date <- as.Date(ftSL$game_date)


# subset 

ftSL_working_data <- ungroup(ftSL) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(ftSL_working_data)
str(ungroup(ftSL))
table(ftSL_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

ftSL_working_data <- filter(ftSL_working_data, hc_x != 1, hc_y != 1)
head(ftSL_working_data)

# create training and test sets
# scaled data

set.seed(42)
ftSL_train <- sample_frac(ftSL_working_data, .15, replace = FALSE)
ftSL_split <- setdiff(ftSL_working_data, ftSL_train)
ftSL_test <- sample_frac(ftSL_split, .50, replace = FALSE)
ftSL_validate <- setdiff(ftSL_split, ftSL_test)

nrow(ftSL_train) + nrow(ftSL_test) + nrow(ftSL_validate) == nrow(ftSL_working_data)

with(ftSL_train, table(hit)) %>% prop.table()
with(ftSL_test, table(hit)) %>% prop.table()
with(ftSL_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(ftSL)
##as.numeric(ftSL$hit_distance_sc, ftSL$hit_speed, ftSL$hit_angle)

#ftSL_train$hit_distance_sc <- as.numeric(ftSL_train$hit_distance_sc)
#ftSL_train$hit_speed <- as.numeric(ftSL_train$hit_speed)
#ftSL_train$hit_angle <- as.numeric(ftSL_train$hit_angle)
#View(ftSL_train)
ftSL_scaled_data <- scale(ftSL_train[,c(1:5)])
ftSL_scale_values <- attr(ftSL_scaled_data, 'scaled:scale')
ftSL_scale_values
ftSL_center_values <- attr(ftSL_scaled_data, 'scaled:center')
ftSL_center_values
ftSL_train <- cbind(ftSL_scaled_data, select(ftSL_train, hit:row))

# save levels for factor variables
ftSL_levels_home_team <- levels(ftSL_train$home_team)
ftSL_levels_stand <- levels(ftSL_train$stand)
ftSL_levels_fieldingTeam <- levels(ftSL_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(ftSL_test)

ftSL_test$hit_distance_sc <- (ftSL_test$hit_distance_sc - ftSL_center_values[1]) / ftSL_scale_values[1]

ftSL_test$hit_speed <- (ftSL_test$hit_speed - ftSL_center_values[2]) / ftSL_scale_values[2]

ftSL_test$hit_angle <- (ftSL_test$hit_angle - ftSL_center_values[3]) / ftSL_scale_values[3]

ftSL_test$hc_x <- (ftSL_test$hc_x - ftSL_center_values[4]) / ftSL_scale_values[4]

ftSL_test$hc_y <- (ftSL_test$hc_y - ftSL_center_values[5]) / ftSL_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

ftSL_validate$hit_distance_sc <- (ftSL_validate$hit_distance_sc - ftSL_center_values[1]) / ftSL_scale_values[1]

ftSL_validate$hit_speed <- (ftSL_validate$hit_speed - ftSL_center_values[2]) / ftSL_scale_values[2]

ftSL_validate$hit_angle <- (ftSL_validate$hit_angle - ftSL_center_values[3]) / ftSL_scale_values[3]

ftSL_validate$hc_x <- (ftSL_validate$hc_x - ftSL_center_values[4]) / ftSL_scale_values[4]

ftSL_validate$hc_y <- (ftSL_validate$hc_y - ftSL_center_values[5]) / ftSL_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(ftSL_train)

set.seed(42)
ftSL_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(ftSL_train, -row), ntree = 501, importance = TRUE)

print(ftSL_rf.1)

plot(ftSL_rf.1)

varImpPlot(ftSL_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
ftSL_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(ftSL_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(ftSL_rf.5)

plot(ftSL_rf.5)

varImpPlot(ftSL_rf.5)

ftSL_predict_fit.rf.5 <- data.frame(fits = predict(ftSL_rf.5, ftSL_test, type = "prob")[,2], actuals = ftSL_test$hit)

ftSL_pred.rf.5 <- prediction(ftSL_predict_fit.rf.5$fits, ftSL_predict_fit.rf.5$actuals)

ftSL_roc.pred.rf.5 <- performance(ftSL_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(ftSL_roc.pred.rf.5)
abline(a = 0, b = 1)
ftSL_opt <- opt.cut(ftSL_roc.pred.rf.5, ftSL_pred.rf.5)
ftSL_opt
ftSL_opt <- ftSL_opt[3]
ftSL_predict_fit.rf.5$fits <- with(ftSL_predict_fit.rf.5, ifelse(fits > ftSL_opt, 1, 0)) 

str(ftSL_test)

#ftSL_test$fieldingTeam <- as.character(ftSL_test$fieldingTeam)
#ftSL_test$home_team <- as.character(ftSL_test$home_team)
#ftSL_test$hit <- as.logical(ftSL_test$hit)
#ftSL_test$stand <- as.logical(ftSL_test$stand)
str(ftSL_test)
ftSL_rf.5_confusion_test <- confusionMatrix(model = ftSL_rf.5, x = ftSL_test, y = ftSL_test$hit)
ftSL_rf.5_confusion_validate <- confusionMatrix(model = ftSL_rf.5, x = ftSL_validate, y = ftSL_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


ftSL_test_rows <- ftSL_test$row
ftSL_validate_rows <- ftSL_validate$row
ftSL_pred_data_emp_1 <- ungroup(ftSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftSL_test_rows)

ftSL_pred_data_emp <- ungroup(ftSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftSL_validate_rows) %>%
	rbind(ftSL_pred_data_emp_1)

ftSL_out_of_training_rows <- ftSL_pred_data_emp$row

ftSL_rf.5_full_out_of_sample_data <- ungroup(ftSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftSL_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



ftSL_rf.5_full_out_of_sample_data_scaled <- ftSL_rf.5_full_out_of_sample_data

ftSL_rf.5_full_out_of_sample_data_scaled$hit_speed <- (ftSL_rf.5_full_out_of_sample_data_scaled$hit_speed - ftSL_center_values[2]) / ftSL_scale_values[2]

ftSL_rf.5_full_out_of_sample_data_scaled$hit_angle <- (ftSL_rf.5_full_out_of_sample_data_scaled$hit_angle - ftSL_center_values[3]) / ftSL_scale_values[3]

ftSL_rf.5.prob <- predict(ftSL_rf.5, ftSL_rf.5_full_out_of_sample_data_scaled, type = "response")

ftSL_rf.5_full_out_of_sample_data <- cbind(filter(ftSL_rf.5_full_out_of_sample_data, row %in% ftSL_out_of_training_rows), ftSL_rf.5.prob)

names(ftSL_rf.5_full_out_of_sample_data)[65] <- "fits"
names(ftSL_rf.5_full_out_of_sample_data)

ftSL_rf.5_full_out_of_sample_data_reduced <- ftSL_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

ftSL_rf.5_mean_table <- ftSL_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

ftSL_rf.5_full_out_of_sample_data$type <- with(ftSL_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

ftSL_rf.5_full_out_of_sample_data$hit_label <- with(ftSL_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

ftSL_rf.5_plot1 <- ggplot(ftSL_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftSL_rf.5_plot1

ftSL_rf.5_plot2 <- ggplot(ftSL_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftSL_rf.5_plot2

ftSL_rf.5_plot3 <- ggplot(ftSL_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftSL_rf.5_plot3

ftSL_grid_plot_rf.5 <- grid.arrange(ftSL_rf.5_plot1, ftSL_rf.5_plot2, ftSL_rf.5_plot3, ncol = 3)
ftSL_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

ftSL_test_rows <- ftSL_test$row
ftSL_validate_rows <- ftSL_validate$row
ftSL_pred_data_emp_1 <- ungroup(ftSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftSL_test_rows)

ftSL_pred_data_emp <- ungroup(ftSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftSL_validate_rows) %>%
	rbind(ftSL_pred_data_emp_1)

ftSL_out_of_training_rows <- ftSL_pred_data_emp$row

ftSL_pred_data_emp <- ungroup(ftSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftSL_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

ftSL_pred_data_emp_scaled <- ftSL_pred_data_emp

ftSL_pred_data_emp_scaled$hit_speed <- (ftSL_pred_data_emp_scaled$hit_speed - ftSL_center_values[2]) / ftSL_scale_values[2]

ftSL_pred_data_emp_scaled$hit_angle <- (ftSL_pred_data_emp_scaled$hit_angle - ftSL_center_values[3]) / ftSL_scale_values[3]

ftSL_pred_prob_hit <- predict(ftSL_rf.5, ftSL_pred_data_emp_scaled, type = "prob")[,2]
ftSL_pred_prob_hit_fits <- cbind(ftSL_pred_data_emp, ftSL_pred_prob_hit)

ftSL_pred_prob_hit_fits[,c(1:2)] <- ftSL_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

ftSL_angle_speed_pred <- ftSL_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = ftSL_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFT-SL Hit Probability\n") + theme_bp_grey()

ftSL_angle_speed_pred
#####
cuSL$hit_distance_sc <- as.numeric(cuSL$hit_distance_sc, na.rm = TRUE)
cuSL$hit_angle <- as.numeric(cuSL$hit_angle, na.rm = TRUE)
cuSL$hit_speed <- as.numeric(cuSL$hit_speed, na.rm = TRUE)

cuSL$hit <- with(cuSL, ifelse(grepl("Single", cuSL$events), 1,
															ifelse(grepl("Double", cuSL$events), 1,
																		 ifelse(grepl("Triple", cuSL$events), 1, 
																		 			 ifelse(grepl("Home Run", cuSL$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

cuSL$fieldingTeam <- with(cuSL, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[cuSL$hit_distance_sc == "null"] = NA
#cuSL$hit_speed[cuSL$hit_speed == "null"] = NA
#cuSL$hit_angle[cuSL$hit_angle == "null"] = NA

# include row names for unique record identification

cuSL$row <- row.names(cuSL) %>% as.numeric()

# recode stand and home_team as factors

cuSL$stand <- as.factor(cuSL$stand)
cuSL$home_team <- as.factor(cuSL$home_team)


cuSL$game_date <- as.Date(cuSL$game_date)


# subset 

cuSL_working_data <- ungroup(cuSL) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(cuSL_working_data)
str(ungroup(cuSL))
table(cuSL_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

cuSL_working_data <- filter(cuSL_working_data, hc_x != 1, hc_y != 1)
head(cuSL_working_data)

# create training and test sets
# scaled data

set.seed(42)
cuSL_train <- sample_frac(cuSL_working_data, .15, replace = FALSE)
cuSL_split <- setdiff(cuSL_working_data, cuSL_train)
cuSL_test <- sample_frac(cuSL_split, .50, replace = FALSE)
cuSL_validate <- setdiff(cuSL_split, cuSL_test)

nrow(cuSL_train) + nrow(cuSL_test) + nrow(cuSL_validate) == nrow(cuSL_working_data)

with(cuSL_train, table(hit)) %>% prop.table()
with(cuSL_test, table(hit)) %>% prop.table()
with(cuSL_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(cuSL)
##as.numeric(cuSL$hit_distance_sc, cuSL$hit_speed, cuSL$hit_angle)

#cuSL_train$hit_distance_sc <- as.numeric(cuSL_train$hit_distance_sc)
#cuSL_train$hit_speed <- as.numeric(cuSL_train$hit_speed)
#cuSL_train$hit_angle <- as.numeric(cuSL_train$hit_angle)
#View(cuSL_train)
cuSL_scaled_data <- scale(cuSL_train[,c(1:5)])
cuSL_scale_values <- attr(cuSL_scaled_data, 'scaled:scale')
cuSL_scale_values
cuSL_center_values <- attr(cuSL_scaled_data, 'scaled:center')
cuSL_center_values
cuSL_train <- cbind(cuSL_scaled_data, select(cuSL_train, hit:row))

# save levels for factor variables
cuSL_levels_home_team <- levels(cuSL_train$home_team)
cuSL_levels_stand <- levels(cuSL_train$stand)
cuSL_levels_fieldingTeam <- levels(cuSL_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(cuSL_test)

cuSL_test$hit_distance_sc <- (cuSL_test$hit_distance_sc - cuSL_center_values[1]) / cuSL_scale_values[1]

cuSL_test$hit_speed <- (cuSL_test$hit_speed - cuSL_center_values[2]) / cuSL_scale_values[2]

cuSL_test$hit_angle <- (cuSL_test$hit_angle - cuSL_center_values[3]) / cuSL_scale_values[3]

cuSL_test$hc_x <- (cuSL_test$hc_x - cuSL_center_values[4]) / cuSL_scale_values[4]

cuSL_test$hc_y <- (cuSL_test$hc_y - cuSL_center_values[5]) / cuSL_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

cuSL_validate$hit_distance_sc <- (cuSL_validate$hit_distance_sc - cuSL_center_values[1]) / cuSL_scale_values[1]

cuSL_validate$hit_speed <- (cuSL_validate$hit_speed - cuSL_center_values[2]) / cuSL_scale_values[2]

cuSL_validate$hit_angle <- (cuSL_validate$hit_angle - cuSL_center_values[3]) / cuSL_scale_values[3]

cuSL_validate$hc_x <- (cuSL_validate$hc_x - cuSL_center_values[4]) / cuSL_scale_values[4]

cuSL_validate$hc_y <- (cuSL_validate$hc_y - cuSL_center_values[5]) / cuSL_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(cuSL_train)

set.seed(42)
cuSL_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(cuSL_train, -row), ntree = 501, importance = TRUE)

print(cuSL_rf.1)

plot(cuSL_rf.1)

varImpPlot(cuSL_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
cuSL_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(cuSL_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(cuSL_rf.5)

plot(cuSL_rf.5)

varImpPlot(cuSL_rf.5)

cuSL_predict_fit.rf.5 <- data.frame(fits = predict(cuSL_rf.5, cuSL_test, type = "prob")[,2], actuals = cuSL_test$hit)

cuSL_pred.rf.5 <- prediction(cuSL_predict_fit.rf.5$fits, cuSL_predict_fit.rf.5$actuals)

cuSL_roc.pred.rf.5 <- performance(cuSL_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(cuSL_roc.pred.rf.5)
abline(a = 0, b = 1)
cuSL_opt <- opt.cut(cuSL_roc.pred.rf.5, cuSL_pred.rf.5)
cuSL_opt
cuSL_opt <- cuSL_opt[3]
cuSL_predict_fit.rf.5$fits <- with(cuSL_predict_fit.rf.5, ifelse(fits > cuSL_opt, 1, 0)) 

str(cuSL_test)

#cuSL_test$fieldingTeam <- as.character(cuSL_test$fieldingTeam)
#cuSL_test$home_team <- as.character(cuSL_test$home_team)
#cuSL_test$hit <- as.logical(cuSL_test$hit)
#cuSL_test$stand <- as.logical(cuSL_test$stand)
str(cuSL_test)
cuSL_rf.5_confusion_test <- confusionMatrix(model = cuSL_rf.5, x = cuSL_test, y = cuSL_test$hit)
cuSL_rf.5_confusion_validate <- confusionMatrix(model = cuSL_rf.5, x = cuSL_validate, y = cuSL_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


cuSL_test_rows <- cuSL_test$row
cuSL_validate_rows <- cuSL_validate$row
cuSL_pred_data_emp_1 <- ungroup(cuSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuSL_test_rows)

cuSL_pred_data_emp <- ungroup(cuSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuSL_validate_rows) %>%
	rbind(cuSL_pred_data_emp_1)

cuSL_out_of_training_rows <- cuSL_pred_data_emp$row

cuSL_rf.5_full_out_of_sample_data <- ungroup(cuSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuSL_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



cuSL_rf.5_full_out_of_sample_data_scaled <- cuSL_rf.5_full_out_of_sample_data

cuSL_rf.5_full_out_of_sample_data_scaled$hit_speed <- (cuSL_rf.5_full_out_of_sample_data_scaled$hit_speed - cuSL_center_values[2]) / cuSL_scale_values[2]

cuSL_rf.5_full_out_of_sample_data_scaled$hit_angle <- (cuSL_rf.5_full_out_of_sample_data_scaled$hit_angle - cuSL_center_values[3]) / cuSL_scale_values[3]

cuSL_rf.5.prob <- predict(cuSL_rf.5, cuSL_rf.5_full_out_of_sample_data_scaled, type = "response")

cuSL_rf.5_full_out_of_sample_data <- cbind(filter(cuSL_rf.5_full_out_of_sample_data, row %in% cuSL_out_of_training_rows), cuSL_rf.5.prob)

names(cuSL_rf.5_full_out_of_sample_data)[65] <- "fits"
names(cuSL_rf.5_full_out_of_sample_data)

cuSL_rf.5_full_out_of_sample_data_reduced <- cuSL_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

cuSL_rf.5_mean_table <- cuSL_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

cuSL_rf.5_full_out_of_sample_data$type <- with(cuSL_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

cuSL_rf.5_full_out_of_sample_data$hit_label <- with(cuSL_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

cuSL_rf.5_plot1 <- ggplot(cuSL_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuSL_rf.5_plot1

cuSL_rf.5_plot2 <- ggplot(cuSL_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuSL_rf.5_plot2

cuSL_rf.5_plot3 <- ggplot(cuSL_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuSL_rf.5_plot3

cuSL_grid_plot_rf.5 <- grid.arrange(cuSL_rf.5_plot1, cuSL_rf.5_plot2, cuSL_rf.5_plot3, ncol = 3)
cuSL_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

cuSL_test_rows <- cuSL_test$row
cuSL_validate_rows <- cuSL_validate$row
cuSL_pred_data_emp_1 <- ungroup(cuSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuSL_test_rows)

cuSL_pred_data_emp <- ungroup(cuSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuSL_validate_rows) %>%
	rbind(cuSL_pred_data_emp_1)

cuSL_out_of_training_rows <- cuSL_pred_data_emp$row

cuSL_pred_data_emp <- ungroup(cuSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuSL_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

cuSL_pred_data_emp_scaled <- cuSL_pred_data_emp

cuSL_pred_data_emp_scaled$hit_speed <- (cuSL_pred_data_emp_scaled$hit_speed - cuSL_center_values[2]) / cuSL_scale_values[2]

cuSL_pred_data_emp_scaled$hit_angle <- (cuSL_pred_data_emp_scaled$hit_angle - cuSL_center_values[3]) / cuSL_scale_values[3]

cuSL_pred_prob_hit <- predict(cuSL_rf.5, cuSL_pred_data_emp_scaled, type = "prob")[,2]
cuSL_pred_prob_hit_fits <- cbind(cuSL_pred_data_emp, cuSL_pred_prob_hit)

cuSL_pred_prob_hit_fits[,c(1:2)] <- cuSL_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

cuSL_angle_speed_pred <- cuSL_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = cuSL_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nCU-SL Hit Probability\n") + theme_bp_grey()

cuSL_angle_speed_pred
#####
ffSL$hit_distance_sc <- as.numeric(ffSL$hit_distance_sc, na.rm = TRUE)
ffSL$hit_angle <- as.numeric(ffSL$hit_angle, na.rm = TRUE)
ffSL$hit_speed <- as.numeric(ffSL$hit_speed, na.rm = TRUE)

ffSL$hit <- with(ffSL, ifelse(grepl("Single", ffSL$events), 1,
															ifelse(grepl("Double", ffSL$events), 1,
																		 ifelse(grepl("Triple", ffSL$events), 1, 
																		 			 ifelse(grepl("Home Run", ffSL$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

ffSL$fieldingTeam <- with(ffSL, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[ffSL$hit_distance_sc == "null"] = NA
#ffSL$hit_speed[ffSL$hit_speed == "null"] = NA
#ffSL$hit_angle[ffSL$hit_angle == "null"] = NA

# include row names for unique record identification

ffSL$row <- row.names(ffSL) %>% as.numeric()

# recode stand and home_team as factors

ffSL$stand <- as.factor(ffSL$stand)
ffSL$home_team <- as.factor(ffSL$home_team)


ffSL$game_date <- as.Date(ffSL$game_date)


# subset 

ffSL_working_data <- ungroup(ffSL) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(ffSL_working_data)
str(ungroup(ffSL))
table(ffSL_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

ffSL_working_data <- filter(ffSL_working_data, hc_x != 1, hc_y != 1)
head(ffSL_working_data)

# create training and test sets
# scaled data

set.seed(42)
ffSL_train <- sample_frac(ffSL_working_data, .15, replace = FALSE)
ffSL_split <- setdiff(ffSL_working_data, ffSL_train)
ffSL_test <- sample_frac(ffSL_split, .50, replace = FALSE)
ffSL_validate <- setdiff(ffSL_split, ffSL_test)

nrow(ffSL_train) + nrow(ffSL_test) + nrow(ffSL_validate) == nrow(ffSL_working_data)

with(ffSL_train, table(hit)) %>% prop.table()
with(ffSL_test, table(hit)) %>% prop.table()
with(ffSL_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(ffSL)
##as.numeric(ffSL$hit_distance_sc, ffSL$hit_speed, ffSL$hit_angle)

#ffSL_train$hit_distance_sc <- as.numeric(ffSL_train$hit_distance_sc)
#ffSL_train$hit_speed <- as.numeric(ffSL_train$hit_speed)
#ffSL_train$hit_angle <- as.numeric(ffSL_train$hit_angle)
#View(ffSL_train)
ffSL_scaled_data <- scale(ffSL_train[,c(1:5)])
ffSL_scale_values <- attr(ffSL_scaled_data, 'scaled:scale')
ffSL_scale_values
ffSL_center_values <- attr(ffSL_scaled_data, 'scaled:center')
ffSL_center_values
ffSL_train <- cbind(ffSL_scaled_data, select(ffSL_train, hit:row))

# save levels for factor variables
ffSL_levels_home_team <- levels(ffSL_train$home_team)
ffSL_levels_stand <- levels(ffSL_train$stand)
ffSL_levels_fieldingTeam <- levels(ffSL_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(ffSL_test)

ffSL_test$hit_distance_sc <- (ffSL_test$hit_distance_sc - ffSL_center_values[1]) / ffSL_scale_values[1]

ffSL_test$hit_speed <- (ffSL_test$hit_speed - ffSL_center_values[2]) / ffSL_scale_values[2]

ffSL_test$hit_angle <- (ffSL_test$hit_angle - ffSL_center_values[3]) / ffSL_scale_values[3]

ffSL_test$hc_x <- (ffSL_test$hc_x - ffSL_center_values[4]) / ffSL_scale_values[4]

ffSL_test$hc_y <- (ffSL_test$hc_y - ffSL_center_values[5]) / ffSL_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

ffSL_validate$hit_distance_sc <- (ffSL_validate$hit_distance_sc - ffSL_center_values[1]) / ffSL_scale_values[1]

ffSL_validate$hit_speed <- (ffSL_validate$hit_speed - ffSL_center_values[2]) / ffSL_scale_values[2]

ffSL_validate$hit_angle <- (ffSL_validate$hit_angle - ffSL_center_values[3]) / ffSL_scale_values[3]

ffSL_validate$hc_x <- (ffSL_validate$hc_x - ffSL_center_values[4]) / ffSL_scale_values[4]

ffSL_validate$hc_y <- (ffSL_validate$hc_y - ffSL_center_values[5]) / ffSL_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(ffSL_train)

set.seed(42)
ffSL_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(ffSL_train, -row), ntree = 501, importance = TRUE)

print(ffSL_rf.1)

plot(ffSL_rf.1)

varImpPlot(ffSL_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
ffSL_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(ffSL_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(ffSL_rf.5)

plot(ffSL_rf.5)

varImpPlot(ffSL_rf.5)

ffSL_predict_fit.rf.5 <- data.frame(fits = predict(ffSL_rf.5, ffSL_test, type = "prob")[,2], actuals = ffSL_test$hit)

ffSL_pred.rf.5 <- prediction(ffSL_predict_fit.rf.5$fits, ffSL_predict_fit.rf.5$actuals)

ffSL_roc.pred.rf.5 <- performance(ffSL_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(ffSL_roc.pred.rf.5)
abline(a = 0, b = 1)
ffSL_opt <- opt.cut(ffSL_roc.pred.rf.5, ffSL_pred.rf.5)
ffSL_opt
ffSL_opt <- ffSL_opt[3]
ffSL_predict_fit.rf.5$fits <- with(ffSL_predict_fit.rf.5, ifelse(fits > ffSL_opt, 1, 0)) 

str(ffSL_test)

#ffSL_test$fieldingTeam <- as.character(ffSL_test$fieldingTeam)
#ffSL_test$home_team <- as.character(ffSL_test$home_team)
#ffSL_test$hit <- as.logical(ffSL_test$hit)
#ffSL_test$stand <- as.logical(ffSL_test$stand)
str(ffSL_test)
ffSL_rf.5_confusion_test <- confusionMatrix(model = ffSL_rf.5, x = ffSL_test, y = ffSL_test$hit)
ffSL_rf.5_confusion_validate <- confusionMatrix(model = ffSL_rf.5, x = ffSL_validate, y = ffSL_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


ffSL_test_rows <- ffSL_test$row
ffSL_validate_rows <- ffSL_validate$row
ffSL_pred_data_emp_1 <- ungroup(ffSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffSL_test_rows)

ffSL_pred_data_emp <- ungroup(ffSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffSL_validate_rows) %>%
	rbind(ffSL_pred_data_emp_1)

ffSL_out_of_training_rows <- ffSL_pred_data_emp$row

ffSL_rf.5_full_out_of_sample_data <- ungroup(ffSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffSL_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



ffSL_rf.5_full_out_of_sample_data_scaled <- ffSL_rf.5_full_out_of_sample_data

ffSL_rf.5_full_out_of_sample_data_scaled$hit_speed <- (ffSL_rf.5_full_out_of_sample_data_scaled$hit_speed - ffSL_center_values[2]) / ffSL_scale_values[2]

ffSL_rf.5_full_out_of_sample_data_scaled$hit_angle <- (ffSL_rf.5_full_out_of_sample_data_scaled$hit_angle - ffSL_center_values[3]) / ffSL_scale_values[3]

ffSL_rf.5.prob <- predict(ffSL_rf.5, ffSL_rf.5_full_out_of_sample_data_scaled, type = "response")

ffSL_rf.5_full_out_of_sample_data <- cbind(filter(ffSL_rf.5_full_out_of_sample_data, row %in% ffSL_out_of_training_rows), ffSL_rf.5.prob)

names(ffSL_rf.5_full_out_of_sample_data)[65] <- "fits"
names(ffSL_rf.5_full_out_of_sample_data)

ffSL_rf.5_full_out_of_sample_data_reduced <- ffSL_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

ffSL_rf.5_mean_table <- ffSL_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

ffSL_rf.5_full_out_of_sample_data$type <- with(ffSL_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

ffSL_rf.5_full_out_of_sample_data$hit_label <- with(ffSL_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

ffSL_rf.5_plot1 <- ggplot(ffSL_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffSL_rf.5_plot1

ffSL_rf.5_plot2 <- ggplot(ffSL_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffSL_rf.5_plot2

ffSL_rf.5_plot3 <- ggplot(ffSL_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffSL_rf.5_plot3

ffSL_grid_plot_rf.5 <- grid.arrange(ffSL_rf.5_plot1, ffSL_rf.5_plot2, ffSL_rf.5_plot3, ncol = 3)
ffSL_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

ffSL_test_rows <- ffSL_test$row
ffSL_validate_rows <- ffSL_validate$row
ffSL_pred_data_emp_1 <- ungroup(ffSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffSL_test_rows)

ffSL_pred_data_emp <- ungroup(ffSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffSL_validate_rows) %>%
	rbind(ffSL_pred_data_emp_1)

ffSL_out_of_training_rows <- ffSL_pred_data_emp$row

ffSL_pred_data_emp <- ungroup(ffSL) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffSL_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

ffSL_pred_data_emp_scaled <- ffSL_pred_data_emp

ffSL_pred_data_emp_scaled$hit_speed <- (ffSL_pred_data_emp_scaled$hit_speed - ffSL_center_values[2]) / ffSL_scale_values[2]

ffSL_pred_data_emp_scaled$hit_angle <- (ffSL_pred_data_emp_scaled$hit_angle - ffSL_center_values[3]) / ffSL_scale_values[3]

ffSL_pred_prob_hit <- predict(ffSL_rf.5, ffSL_pred_data_emp_scaled, type = "prob")[,2]
ffSL_pred_prob_hit_fits <- cbind(ffSL_pred_data_emp, ffSL_pred_prob_hit)

ffSL_pred_prob_hit_fits[,c(1:2)] <- ffSL_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

ffSL_angle_speed_pred <- ffSL_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = ffSL_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFF-SL Hit Probability\n") + theme_bp_grey()

ffSL_angle_speed_pred
############# End Sliders; Start Curveballs
#####
siCU$hit_distance_sc <- as.numeric(siCU$hit_distance_sc, na.rm = TRUE)
siCU$hit_angle <- as.numeric(siCU$hit_angle, na.rm = TRUE)
siCU$hit_speed <- as.numeric(siCU$hit_speed, na.rm = TRUE)

siCU$hit <- with(siCU, ifelse(grepl("Single", siCU$events), 1,
															ifelse(grepl("Double", siCU$events), 1,
																		 ifelse(grepl("Triple", siCU$events), 1, 
																		 			 ifelse(grepl("Home Run", siCU$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

siCU$fieldingTeam <- with(siCU, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[siCU$hit_distance_sc == "null"] = NA
#siCU$hit_speed[siCU$hit_speed == "null"] = NA
#siCU$hit_angle[siCU$hit_angle == "null"] = NA

# include row names for unique record identification

siCU$row <- row.names(siCU) %>% as.numeric()

# recode stand and home_team as factors

siCU$stand <- as.factor(siCU$stand)
siCU$home_team <- as.factor(siCU$home_team)


siCU$game_date <- as.Date(siCU$game_date)


# subset 

siCU_working_data <- ungroup(siCU) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(siCU_working_data)
str(ungroup(siCU))
table(siCU_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

siCU_working_data <- filter(siCU_working_data, hc_x != 1, hc_y != 1)
head(siCU_working_data)

# create training and test sets
# scaled data

set.seed(42)
siCU_train <- sample_frac(siCU_working_data, .15, replace = FALSE)
siCU_split <- setdiff(siCU_working_data, siCU_train)
siCU_test <- sample_frac(siCU_split, .50, replace = FALSE)
siCU_validate <- setdiff(siCU_split, siCU_test)

nrow(siCU_train) + nrow(siCU_test) + nrow(siCU_validate) == nrow(siCU_working_data)

with(siCU_train, table(hit)) %>% prop.table()
with(siCU_test, table(hit)) %>% prop.table()
with(siCU_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(siCU)
##as.numeric(siCU$hit_distance_sc, siCU$hit_speed, siCU$hit_angle)

#siCU_train$hit_distance_sc <- as.numeric(siCU_train$hit_distance_sc)
#siCU_train$hit_speed <- as.numeric(siCU_train$hit_speed)
#siCU_train$hit_angle <- as.numeric(siCU_train$hit_angle)
#View(siCU_train)
siCU_scaled_data <- scale(siCU_train[,c(1:5)])
siCU_scale_values <- attr(siCU_scaled_data, 'scaled:scale')
siCU_scale_values
siCU_center_values <- attr(siCU_scaled_data, 'scaled:center')
siCU_center_values
siCU_train <- cbind(siCU_scaled_data, select(siCU_train, hit:row))

# save levels for factor variables
siCU_levels_home_team <- levels(siCU_train$home_team)
siCU_levels_stand <- levels(siCU_train$stand)
siCU_levels_fieldingTeam <- levels(siCU_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(siCU_test)

siCU_test$hit_distance_sc <- (siCU_test$hit_distance_sc - siCU_center_values[1]) / siCU_scale_values[1]

siCU_test$hit_speed <- (siCU_test$hit_speed - siCU_center_values[2]) / siCU_scale_values[2]

siCU_test$hit_angle <- (siCU_test$hit_angle - siCU_center_values[3]) / siCU_scale_values[3]

siCU_test$hc_x <- (siCU_test$hc_x - siCU_center_values[4]) / siCU_scale_values[4]

siCU_test$hc_y <- (siCU_test$hc_y - siCU_center_values[5]) / siCU_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

siCU_validate$hit_distance_sc <- (siCU_validate$hit_distance_sc - siCU_center_values[1]) / siCU_scale_values[1]

siCU_validate$hit_speed <- (siCU_validate$hit_speed - siCU_center_values[2]) / siCU_scale_values[2]

siCU_validate$hit_angle <- (siCU_validate$hit_angle - siCU_center_values[3]) / siCU_scale_values[3]

siCU_validate$hc_x <- (siCU_validate$hc_x - siCU_center_values[4]) / siCU_scale_values[4]

siCU_validate$hc_y <- (siCU_validate$hc_y - siCU_center_values[5]) / siCU_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(siCU_train)

set.seed(42)
siCU_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(siCU_train, -row), ntree = 501, importance = TRUE)

print(siCU_rf.1)

plot(siCU_rf.1)

varImpPlot(siCU_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
siCU_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(siCU_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(siCU_rf.5)

plot(siCU_rf.5)

varImpPlot(siCU_rf.5)

siCU_predict_fit.rf.5 <- data.frame(fits = predict(siCU_rf.5, siCU_test, type = "prob")[,2], actuals = siCU_test$hit)

siCU_pred.rf.5 <- prediction(siCU_predict_fit.rf.5$fits, siCU_predict_fit.rf.5$actuals)

siCU_roc.pred.rf.5 <- performance(siCU_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(siCU_roc.pred.rf.5)
abline(a = 0, b = 1)
siCU_opt <- opt.cut(siCU_roc.pred.rf.5, siCU_pred.rf.5)
siCU_opt
siCU_opt <- siCU_opt[3]
siCU_predict_fit.rf.5$fits <- with(siCU_predict_fit.rf.5, ifelse(fits > siCU_opt, 1, 0)) 

str(siCU_test)

#siCU_test$fieldingTeam <- as.character(siCU_test$fieldingTeam)
#siCU_test$home_team <- as.character(siCU_test$home_team)
#siCU_test$hit <- as.logical(siCU_test$hit)
#siCU_test$stand <- as.logical(siCU_test$stand)
str(siCU_test)
siCU_rf.5_confusion_test <- confusionMatrix(model = siCU_rf.5, x = siCU_test, y = siCU_test$hit)
siCU_rf.5_confusion_validate <- confusionMatrix(model = siCU_rf.5, x = siCU_validate, y = siCU_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


siCU_test_rows <- siCU_test$row
siCU_validate_rows <- siCU_validate$row
siCU_pred_data_emp_1 <- ungroup(siCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siCU_test_rows)

siCU_pred_data_emp <- ungroup(siCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siCU_validate_rows) %>%
	rbind(siCU_pred_data_emp_1)

siCU_out_of_training_rows <- siCU_pred_data_emp$row

siCU_rf.5_full_out_of_sample_data <- ungroup(siCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siCU_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



siCU_rf.5_full_out_of_sample_data_scaled <- siCU_rf.5_full_out_of_sample_data

siCU_rf.5_full_out_of_sample_data_scaled$hit_speed <- (siCU_rf.5_full_out_of_sample_data_scaled$hit_speed - siCU_center_values[2]) / siCU_scale_values[2]

siCU_rf.5_full_out_of_sample_data_scaled$hit_angle <- (siCU_rf.5_full_out_of_sample_data_scaled$hit_angle - siCU_center_values[3]) / siCU_scale_values[3]

siCU_rf.5.prob <- predict(siCU_rf.5, siCU_rf.5_full_out_of_sample_data_scaled, type = "response")

siCU_rf.5_full_out_of_sample_data <- cbind(filter(siCU_rf.5_full_out_of_sample_data, row %in% siCU_out_of_training_rows), siCU_rf.5.prob)

names(siCU_rf.5_full_out_of_sample_data)[65] <- "fits"
names(siCU_rf.5_full_out_of_sample_data)

siCU_rf.5_full_out_of_sample_data_reduced <- siCU_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

siCU_rf.5_mean_table <- siCU_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

siCU_rf.5_full_out_of_sample_data$type <- with(siCU_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

siCU_rf.5_full_out_of_sample_data$hit_label <- with(siCU_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

siCU_rf.5_plot1 <- ggplot(siCU_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siCU_rf.5_plot1

siCU_rf.5_plot2 <- ggplot(siCU_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siCU_rf.5_plot2

siCU_rf.5_plot3 <- ggplot(siCU_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siCU_rf.5_plot3

siCU_grid_plot_rf.5 <- grid.arrange(siCU_rf.5_plot1, siCU_rf.5_plot2, siCU_rf.5_plot3, ncol = 3)
siCU_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

siCU_test_rows <- siCU_test$row
siCU_validate_rows <- siCU_validate$row
siCU_pred_data_emp_1 <- ungroup(siCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siCU_test_rows)

siCU_pred_data_emp <- ungroup(siCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siCU_validate_rows) %>%
	rbind(siCU_pred_data_emp_1)

siCU_out_of_training_rows <- siCU_pred_data_emp$row

siCU_pred_data_emp <- ungroup(siCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siCU_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

siCU_pred_data_emp_scaled <- siCU_pred_data_emp

siCU_pred_data_emp_scaled$hit_speed <- (siCU_pred_data_emp_scaled$hit_speed - siCU_center_values[2]) / siCU_scale_values[2]

siCU_pred_data_emp_scaled$hit_angle <- (siCU_pred_data_emp_scaled$hit_angle - siCU_center_values[3]) / siCU_scale_values[3]

siCU_pred_prob_hit <- predict(siCU_rf.5, siCU_pred_data_emp_scaled, type = "prob")[,2]
siCU_pred_prob_hit_fits <- cbind(siCU_pred_data_emp, siCU_pred_prob_hit)

siCU_pred_prob_hit_fits[,c(1:2)] <- siCU_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

siCU_angle_speed_pred <- siCU_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = siCU_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nSI-CU Hit Probability\n") + theme_bp_grey()

siCU_angle_speed_pred
#####
knCU$hit_distance_sc <- as.numeric(knCU$hit_distance_sc, na.rm = TRUE)
knCU$hit_angle <- as.numeric(knCU$hit_angle, na.rm = TRUE)
knCU$hit_speed <- as.numeric(knCU$hit_speed, na.rm = TRUE)

knCU$hit <- with(knCU, ifelse(grepl("Single", knCU$events), 1,
															ifelse(grepl("Double", knCU$events), 1,
																		 ifelse(grepl("Triple", knCU$events), 1, 
																		 			 ifelse(grepl("Home Run", knCU$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

knCU$fieldingTeam <- with(knCU, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[knCU$hit_distance_sc == "null"] = NA
#knCU$hit_speed[knCU$hit_speed == "null"] = NA
#knCU$hit_angle[knCU$hit_angle == "null"] = NA

# include row names for unique record identification

knCU$row <- row.names(knCU) %>% as.numeric()

# recode stand and home_team as factors

knCU$stand <- as.factor(knCU$stand)
knCU$home_team <- as.factor(knCU$home_team)


knCU$game_date <- as.Date(knCU$game_date)


# subset 

knCU_working_data <- ungroup(knCU) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(knCU_working_data)
str(ungroup(knCU))
table(knCU_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

knCU_working_data <- filter(knCU_working_data, hc_x != 1, hc_y != 1)
head(knCU_working_data)

# create training and test sets
# scaled data

set.seed(42)
knCU_train <- sample_frac(knCU_working_data, .15, replace = FALSE)
knCU_split <- setdiff(knCU_working_data, knCU_train)
knCU_test <- sample_frac(knCU_split, .50, replace = FALSE)
knCU_validate <- setdiff(knCU_split, knCU_test)

nrow(knCU_train) + nrow(knCU_test) + nrow(knCU_validate) == nrow(knCU_working_data)

with(knCU_train, table(hit)) %>% prop.table()
with(knCU_test, table(hit)) %>% prop.table()
with(knCU_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(knCU)
##as.numeric(knCU$hit_distance_sc, knCU$hit_speed, knCU$hit_angle)

#knCU_train$hit_distance_sc <- as.numeric(knCU_train$hit_distance_sc)
#knCU_train$hit_speed <- as.numeric(knCU_train$hit_speed)
#knCU_train$hit_angle <- as.numeric(knCU_train$hit_angle)
#View(knCU_train)
knCU_scaled_data <- scale(knCU_train[,c(1:5)])
knCU_scale_values <- attr(knCU_scaled_data, 'scaled:scale')
knCU_scale_values
knCU_center_values <- attr(knCU_scaled_data, 'scaled:center')
knCU_center_values
knCU_train <- cbind(knCU_scaled_data, select(knCU_train, hit:row))

# save levels for factor variables
knCU_levels_home_team <- levels(knCU_train$home_team)
knCU_levels_stand <- levels(knCU_train$stand)
knCU_levels_fieldingTeam <- levels(knCU_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(knCU_test)

knCU_test$hit_distance_sc <- (knCU_test$hit_distance_sc - knCU_center_values[1]) / knCU_scale_values[1]

knCU_test$hit_speed <- (knCU_test$hit_speed - knCU_center_values[2]) / knCU_scale_values[2]

knCU_test$hit_angle <- (knCU_test$hit_angle - knCU_center_values[3]) / knCU_scale_values[3]

knCU_test$hc_x <- (knCU_test$hc_x - knCU_center_values[4]) / knCU_scale_values[4]

knCU_test$hc_y <- (knCU_test$hc_y - knCU_center_values[5]) / knCU_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

knCU_validate$hit_distance_sc <- (knCU_validate$hit_distance_sc - knCU_center_values[1]) / knCU_scale_values[1]

knCU_validate$hit_speed <- (knCU_validate$hit_speed - knCU_center_values[2]) / knCU_scale_values[2]

knCU_validate$hit_angle <- (knCU_validate$hit_angle - knCU_center_values[3]) / knCU_scale_values[3]

knCU_validate$hc_x <- (knCU_validate$hc_x - knCU_center_values[4]) / knCU_scale_values[4]

knCU_validate$hc_y <- (knCU_validate$hc_y - knCU_center_values[5]) / knCU_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(knCU_train)

set.seed(42)
knCU_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(knCU_train, -row), ntree = 501, importance = TRUE)

print(knCU_rf.1)

plot(knCU_rf.1)

varImpPlot(knCU_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
knCU_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(knCU_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(knCU_rf.5)

plot(knCU_rf.5)

varImpPlot(knCU_rf.5)

knCU_predict_fit.rf.5 <- data.frame(fits = predict(knCU_rf.5, knCU_test, type = "prob")[,2], actuals = knCU_test$hit)

knCU_pred.rf.5 <- prediction(knCU_predict_fit.rf.5$fits, knCU_predict_fit.rf.5$actuals)

knCU_roc.pred.rf.5 <- performance(knCU_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(knCU_roc.pred.rf.5)
abline(a = 0, b = 1)
knCU_opt <- opt.cut(knCU_roc.pred.rf.5, knCU_pred.rf.5)
knCU_opt
knCU_opt <- knCU_opt[3]
knCU_predict_fit.rf.5$fits <- with(knCU_predict_fit.rf.5, ifelse(fits > knCU_opt, 1, 0)) 

str(knCU_test)

#knCU_test$fieldingTeam <- as.character(knCU_test$fieldingTeam)
#knCU_test$home_team <- as.character(knCU_test$home_team)
#knCU_test$hit <- as.logical(knCU_test$hit)
#knCU_test$stand <- as.logical(knCU_test$stand)
str(knCU_test)
knCU_rf.5_confusion_test <- confusionMatrix(model = knCU_rf.5, x = knCU_test, y = knCU_test$hit)
knCU_rf.5_confusion_validate <- confusionMatrix(model = knCU_rf.5, x = knCU_validate, y = knCU_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


knCU_test_rows <- knCU_test$row
knCU_validate_rows <- knCU_validate$row
knCU_pred_data_emp_1 <- ungroup(knCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knCU_test_rows)

knCU_pred_data_emp <- ungroup(knCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knCU_validate_rows) %>%
	rbind(knCU_pred_data_emp_1)

knCU_out_of_training_rows <- knCU_pred_data_emp$row

knCU_rf.5_full_out_of_sample_data <- ungroup(knCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knCU_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



knCU_rf.5_full_out_of_sample_data_scaled <- knCU_rf.5_full_out_of_sample_data

knCU_rf.5_full_out_of_sample_data_scaled$hit_speed <- (knCU_rf.5_full_out_of_sample_data_scaled$hit_speed - knCU_center_values[2]) / knCU_scale_values[2]

knCU_rf.5_full_out_of_sample_data_scaled$hit_angle <- (knCU_rf.5_full_out_of_sample_data_scaled$hit_angle - knCU_center_values[3]) / knCU_scale_values[3]

knCU_rf.5.prob <- predict(knCU_rf.5, knCU_rf.5_full_out_of_sample_data_scaled, type = "response")

knCU_rf.5_full_out_of_sample_data <- cbind(filter(knCU_rf.5_full_out_of_sample_data, row %in% knCU_out_of_training_rows), knCU_rf.5.prob)

names(knCU_rf.5_full_out_of_sample_data)[65] <- "fits"
names(knCU_rf.5_full_out_of_sample_data)

knCU_rf.5_full_out_of_sample_data_reduced <- knCU_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

knCU_rf.5_mean_table <- knCU_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

knCU_rf.5_full_out_of_sample_data$type <- with(knCU_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

knCU_rf.5_full_out_of_sample_data$hit_label <- with(knCU_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

knCU_rf.5_plot1 <- ggplot(knCU_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knCU_rf.5_plot1

knCU_rf.5_plot2 <- ggplot(knCU_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knCU_rf.5_plot2

knCU_rf.5_plot3 <- ggplot(knCU_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knCU_rf.5_plot3

knCU_grid_plot_rf.5 <- grid.arrange(knCU_rf.5_plot1, knCU_rf.5_plot2, knCU_rf.5_plot3, ncol = 3)
knCU_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

knCU_test_rows <- knCU_test$row
knCU_validate_rows <- knCU_validate$row
knCU_pred_data_emp_1 <- ungroup(knCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knCU_test_rows)

knCU_pred_data_emp <- ungroup(knCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knCU_validate_rows) %>%
	rbind(knCU_pred_data_emp_1)

knCU_out_of_training_rows <- knCU_pred_data_emp$row

knCU_pred_data_emp <- ungroup(knCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knCU_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

knCU_pred_data_emp_scaled <- knCU_pred_data_emp

knCU_pred_data_emp_scaled$hit_speed <- (knCU_pred_data_emp_scaled$hit_speed - knCU_center_values[2]) / knCU_scale_values[2]

knCU_pred_data_emp_scaled$hit_angle <- (knCU_pred_data_emp_scaled$hit_angle - knCU_center_values[3]) / knCU_scale_values[3]

knCU_pred_prob_hit <- predict(knCU_rf.5, knCU_pred_data_emp_scaled, type = "prob")[,2]
knCU_pred_prob_hit_fits <- cbind(knCU_pred_data_emp, knCU_pred_prob_hit)

knCU_pred_prob_hit_fits[,c(1:2)] <- knCU_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

knCU_angle_speed_pred <- knCU_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = knCU_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nKN-CU Hit Probability\n") + theme_bp_grey()

knCU_angle_speed_pred
#####
kcCU$hit_distance_sc <- as.numeric(kcCU$hit_distance_sc, na.rm = TRUE)
kcCU$hit_angle <- as.numeric(kcCU$hit_angle, na.rm = TRUE)
kcCU$hit_speed <- as.numeric(kcCU$hit_speed, na.rm = TRUE)

kcCU$hit <- with(kcCU, ifelse(grepl("Single", kcCU$events), 1,
															ifelse(grepl("Double", kcCU$events), 1,
																		 ifelse(grepl("Triple", kcCU$events), 1, 
																		 			 ifelse(grepl("Home Run", kcCU$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

kcCU$fieldingTeam <- with(kcCU, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[kcCU$hit_distance_sc == "null"] = NA
#kcCU$hit_speed[kcCU$hit_speed == "null"] = NA
#kcCU$hit_angle[kcCU$hit_angle == "null"] = NA

# include row names for unique record identification

kcCU$row <- row.names(kcCU) %>% as.numeric()

# recode stand and home_team as factors

kcCU$stand <- as.factor(kcCU$stand)
kcCU$home_team <- as.factor(kcCU$home_team)


kcCU$game_date <- as.Date(kcCU$game_date)


# subset 

kcCU_working_data <- ungroup(kcCU) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(kcCU_working_data)
str(ungroup(kcCU))
table(kcCU_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

kcCU_working_data <- filter(kcCU_working_data, hc_x != 1, hc_y != 1)
head(kcCU_working_data)

# create training and test sets
# scaled data

set.seed(42)
kcCU_train <- sample_frac(kcCU_working_data, .15, replace = FALSE)
kcCU_split <- setdiff(kcCU_working_data, kcCU_train)
kcCU_test <- sample_frac(kcCU_split, .50, replace = FALSE)
kcCU_validate <- setdiff(kcCU_split, kcCU_test)

nrow(kcCU_train) + nrow(kcCU_test) + nrow(kcCU_validate) == nrow(kcCU_working_data)

with(kcCU_train, table(hit)) %>% prop.table()
with(kcCU_test, table(hit)) %>% prop.table()
with(kcCU_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(kcCU)
##as.numeric(kcCU$hit_distance_sc, kcCU$hit_speed, kcCU$hit_angle)

#kcCU_train$hit_distance_sc <- as.numeric(kcCU_train$hit_distance_sc)
#kcCU_train$hit_speed <- as.numeric(kcCU_train$hit_speed)
#kcCU_train$hit_angle <- as.numeric(kcCU_train$hit_angle)
#View(kcCU_train)
kcCU_scaled_data <- scale(kcCU_train[,c(1:5)])
kcCU_scale_values <- attr(kcCU_scaled_data, 'scaled:scale')
kcCU_scale_values
kcCU_center_values <- attr(kcCU_scaled_data, 'scaled:center')
kcCU_center_values
kcCU_train <- cbind(kcCU_scaled_data, select(kcCU_train, hit:row))

# save levels for factor variables
kcCU_levels_home_team <- levels(kcCU_train$home_team)
kcCU_levels_stand <- levels(kcCU_train$stand)
kcCU_levels_fieldingTeam <- levels(kcCU_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(kcCU_test)

kcCU_test$hit_distance_sc <- (kcCU_test$hit_distance_sc - kcCU_center_values[1]) / kcCU_scale_values[1]

kcCU_test$hit_speed <- (kcCU_test$hit_speed - kcCU_center_values[2]) / kcCU_scale_values[2]

kcCU_test$hit_angle <- (kcCU_test$hit_angle - kcCU_center_values[3]) / kcCU_scale_values[3]

kcCU_test$hc_x <- (kcCU_test$hc_x - kcCU_center_values[4]) / kcCU_scale_values[4]

kcCU_test$hc_y <- (kcCU_test$hc_y - kcCU_center_values[5]) / kcCU_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

kcCU_validate$hit_distance_sc <- (kcCU_validate$hit_distance_sc - kcCU_center_values[1]) / kcCU_scale_values[1]

kcCU_validate$hit_speed <- (kcCU_validate$hit_speed - kcCU_center_values[2]) / kcCU_scale_values[2]

kcCU_validate$hit_angle <- (kcCU_validate$hit_angle - kcCU_center_values[3]) / kcCU_scale_values[3]

kcCU_validate$hc_x <- (kcCU_validate$hc_x - kcCU_center_values[4]) / kcCU_scale_values[4]

kcCU_validate$hc_y <- (kcCU_validate$hc_y - kcCU_center_values[5]) / kcCU_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(kcCU_train)

set.seed(42)
kcCU_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(kcCU_train, -row), ntree = 501, importance = TRUE)

print(kcCU_rf.1)

plot(kcCU_rf.1)

varImpPlot(kcCU_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
kcCU_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(kcCU_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(kcCU_rf.5)

plot(kcCU_rf.5)

varImpPlot(kcCU_rf.5)

kcCU_predict_fit.rf.5 <- data.frame(fits = predict(kcCU_rf.5, kcCU_test, type = "prob")[,2], actuals = kcCU_test$hit)

kcCU_pred.rf.5 <- prediction(kcCU_predict_fit.rf.5$fits, kcCU_predict_fit.rf.5$actuals)

kcCU_roc.pred.rf.5 <- performance(kcCU_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(kcCU_roc.pred.rf.5)
abline(a = 0, b = 1)
kcCU_opt <- opt.cut(kcCU_roc.pred.rf.5, kcCU_pred.rf.5)
kcCU_opt
kcCU_opt <- kcCU_opt[3]
kcCU_predict_fit.rf.5$fits <- with(kcCU_predict_fit.rf.5, ifelse(fits > kcCU_opt, 1, 0)) 

str(kcCU_test)

#kcCU_test$fieldingTeam <- as.character(kcCU_test$fieldingTeam)
#kcCU_test$home_team <- as.character(kcCU_test$home_team)
#kcCU_test$hit <- as.logical(kcCU_test$hit)
#kcCU_test$stand <- as.logical(kcCU_test$stand)
str(kcCU_test)
kcCU_rf.5_confusion_test <- confusionMatrix(model = kcCU_rf.5, x = kcCU_test, y = kcCU_test$hit)
kcCU_rf.5_confusion_validate <- confusionMatrix(model = kcCU_rf.5, x = kcCU_validate, y = kcCU_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


kcCU_test_rows <- kcCU_test$row
kcCU_validate_rows <- kcCU_validate$row
kcCU_pred_data_emp_1 <- ungroup(kcCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcCU_test_rows)

kcCU_pred_data_emp <- ungroup(kcCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcCU_validate_rows) %>%
	rbind(kcCU_pred_data_emp_1)

kcCU_out_of_training_rows <- kcCU_pred_data_emp$row

kcCU_rf.5_full_out_of_sample_data <- ungroup(kcCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcCU_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



kcCU_rf.5_full_out_of_sample_data_scaled <- kcCU_rf.5_full_out_of_sample_data

kcCU_rf.5_full_out_of_sample_data_scaled$hit_speed <- (kcCU_rf.5_full_out_of_sample_data_scaled$hit_speed - kcCU_center_values[2]) / kcCU_scale_values[2]

kcCU_rf.5_full_out_of_sample_data_scaled$hit_angle <- (kcCU_rf.5_full_out_of_sample_data_scaled$hit_angle - kcCU_center_values[3]) / kcCU_scale_values[3]

kcCU_rf.5.prob <- predict(kcCU_rf.5, kcCU_rf.5_full_out_of_sample_data_scaled, type = "response")

kcCU_rf.5_full_out_of_sample_data <- cbind(filter(kcCU_rf.5_full_out_of_sample_data, row %in% kcCU_out_of_training_rows), kcCU_rf.5.prob)

names(kcCU_rf.5_full_out_of_sample_data)[65] <- "fits"
names(kcCU_rf.5_full_out_of_sample_data)

kcCU_rf.5_full_out_of_sample_data_reduced <- kcCU_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

kcCU_rf.5_mean_table <- kcCU_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

kcCU_rf.5_full_out_of_sample_data$type <- with(kcCU_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

kcCU_rf.5_full_out_of_sample_data$hit_label <- with(kcCU_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

kcCU_rf.5_plot1 <- ggplot(kcCU_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcCU_rf.5_plot1

kcCU_rf.5_plot2 <- ggplot(kcCU_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcCU_rf.5_plot2

kcCU_rf.5_plot3 <- ggplot(kcCU_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcCU_rf.5_plot3

kcCU_grid_plot_rf.5 <- grid.arrange(kcCU_rf.5_plot1, kcCU_rf.5_plot2, kcCU_rf.5_plot3, ncol = 3)
kcCU_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

kcCU_test_rows <- kcCU_test$row
kcCU_validate_rows <- kcCU_validate$row
kcCU_pred_data_emp_1 <- ungroup(kcCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcCU_test_rows)

kcCU_pred_data_emp <- ungroup(kcCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcCU_validate_rows) %>%
	rbind(kcCU_pred_data_emp_1)

kcCU_out_of_training_rows <- kcCU_pred_data_emp$row

kcCU_pred_data_emp <- ungroup(kcCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcCU_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

kcCU_pred_data_emp_scaled <- kcCU_pred_data_emp

kcCU_pred_data_emp_scaled$hit_speed <- (kcCU_pred_data_emp_scaled$hit_speed - kcCU_center_values[2]) / kcCU_scale_values[2]

kcCU_pred_data_emp_scaled$hit_angle <- (kcCU_pred_data_emp_scaled$hit_angle - kcCU_center_values[3]) / kcCU_scale_values[3]

kcCU_pred_prob_hit <- predict(kcCU_rf.5, kcCU_pred_data_emp_scaled, type = "prob")[,2]
kcCU_pred_prob_hit_fits <- cbind(kcCU_pred_data_emp, kcCU_pred_prob_hit)

kcCU_pred_prob_hit_fits[,c(1:2)] <- kcCU_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

kcCU_angle_speed_pred <- kcCU_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = kcCU_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nKC-CU Hit Probability\n") + theme_bp_grey()

kcCU_angle_speed_pred
#####
fsCU$hit_distance_sc <- as.numeric(fsCU$hit_distance_sc, na.rm = TRUE)
fsCU$hit_angle <- as.numeric(fsCU$hit_angle, na.rm = TRUE)
fsCU$hit_speed <- as.numeric(fsCU$hit_speed, na.rm = TRUE)

fsCU$hit <- with(fsCU, ifelse(grepl("Single", fsCU$events), 1,
															ifelse(grepl("Double", fsCU$events), 1,
																		 ifelse(grepl("Triple", fsCU$events), 1, 
																		 			 ifelse(grepl("Home Run", fsCU$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

fsCU$fieldingTeam <- with(fsCU, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[fsCU$hit_distance_sc == "null"] = NA
#fsCU$hit_speed[fsCU$hit_speed == "null"] = NA
#fsCU$hit_angle[fsCU$hit_angle == "null"] = NA

# include row names for unique record identification

fsCU$row <- row.names(fsCU) %>% as.numeric()

# recode stand and home_team as factors

fsCU$stand <- as.factor(fsCU$stand)
fsCU$home_team <- as.factor(fsCU$home_team)


fsCU$game_date <- as.Date(fsCU$game_date)


# subset 

fsCU_working_data <- ungroup(fsCU) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(fsCU_working_data)
str(ungroup(fsCU))
table(fsCU_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

fsCU_working_data <- filter(fsCU_working_data, hc_x != 1, hc_y != 1)
head(fsCU_working_data)

# create training and test sets
# scaled data

set.seed(42)
fsCU_train <- sample_frac(fsCU_working_data, .15, replace = FALSE)
fsCU_split <- setdiff(fsCU_working_data, fsCU_train)
fsCU_test <- sample_frac(fsCU_split, .50, replace = FALSE)
fsCU_validate <- setdiff(fsCU_split, fsCU_test)

nrow(fsCU_train) + nrow(fsCU_test) + nrow(fsCU_validate) == nrow(fsCU_working_data)

with(fsCU_train, table(hit)) %>% prop.table()
with(fsCU_test, table(hit)) %>% prop.table()
with(fsCU_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(fsCU)
##as.numeric(fsCU$hit_distance_sc, fsCU$hit_speed, fsCU$hit_angle)

#fsCU_train$hit_distance_sc <- as.numeric(fsCU_train$hit_distance_sc)
#fsCU_train$hit_speed <- as.numeric(fsCU_train$hit_speed)
#fsCU_train$hit_angle <- as.numeric(fsCU_train$hit_angle)
#View(fsCU_train)
fsCU_scaled_data <- scale(fsCU_train[,c(1:5)])
fsCU_scale_values <- attr(fsCU_scaled_data, 'scaled:scale')
fsCU_scale_values
fsCU_center_values <- attr(fsCU_scaled_data, 'scaled:center')
fsCU_center_values
fsCU_train <- cbind(fsCU_scaled_data, select(fsCU_train, hit:row))

# save levels for factor variables
fsCU_levels_home_team <- levels(fsCU_train$home_team)
fsCU_levels_stand <- levels(fsCU_train$stand)
fsCU_levels_fieldingTeam <- levels(fsCU_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(fsCU_test)

fsCU_test$hit_distance_sc <- (fsCU_test$hit_distance_sc - fsCU_center_values[1]) / fsCU_scale_values[1]

fsCU_test$hit_speed <- (fsCU_test$hit_speed - fsCU_center_values[2]) / fsCU_scale_values[2]

fsCU_test$hit_angle <- (fsCU_test$hit_angle - fsCU_center_values[3]) / fsCU_scale_values[3]

fsCU_test$hc_x <- (fsCU_test$hc_x - fsCU_center_values[4]) / fsCU_scale_values[4]

fsCU_test$hc_y <- (fsCU_test$hc_y - fsCU_center_values[5]) / fsCU_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

fsCU_validate$hit_distance_sc <- (fsCU_validate$hit_distance_sc - fsCU_center_values[1]) / fsCU_scale_values[1]

fsCU_validate$hit_speed <- (fsCU_validate$hit_speed - fsCU_center_values[2]) / fsCU_scale_values[2]

fsCU_validate$hit_angle <- (fsCU_validate$hit_angle - fsCU_center_values[3]) / fsCU_scale_values[3]

fsCU_validate$hc_x <- (fsCU_validate$hc_x - fsCU_center_values[4]) / fsCU_scale_values[4]

fsCU_validate$hc_y <- (fsCU_validate$hc_y - fsCU_center_values[5]) / fsCU_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(fsCU_train)

set.seed(42)
fsCU_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(fsCU_train, -row), ntree = 501, importance = TRUE)

print(fsCU_rf.1)

plot(fsCU_rf.1)

varImpPlot(fsCU_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
fsCU_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(fsCU_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(fsCU_rf.5)

plot(fsCU_rf.5)

varImpPlot(fsCU_rf.5)

fsCU_predict_fit.rf.5 <- data.frame(fits = predict(fsCU_rf.5, fsCU_test, type = "prob")[,2], actuals = fsCU_test$hit)

fsCU_pred.rf.5 <- prediction(fsCU_predict_fit.rf.5$fits, fsCU_predict_fit.rf.5$actuals)

fsCU_roc.pred.rf.5 <- performance(fsCU_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(fsCU_roc.pred.rf.5)
abline(a = 0, b = 1)
fsCU_opt <- opt.cut(fsCU_roc.pred.rf.5, fsCU_pred.rf.5)
fsCU_opt
fsCU_opt <- fsCU_opt[3]
fsCU_predict_fit.rf.5$fits <- with(fsCU_predict_fit.rf.5, ifelse(fits > fsCU_opt, 1, 0)) 

str(fsCU_test)

#fsCU_test$fieldingTeam <- as.character(fsCU_test$fieldingTeam)
#fsCU_test$home_team <- as.character(fsCU_test$home_team)
#fsCU_test$hit <- as.logical(fsCU_test$hit)
#fsCU_test$stand <- as.logical(fsCU_test$stand)
str(fsCU_test)
fsCU_rf.5_confusion_test <- confusionMatrix(model = fsCU_rf.5, x = fsCU_test, y = fsCU_test$hit)
fsCU_rf.5_confusion_validate <- confusionMatrix(model = fsCU_rf.5, x = fsCU_validate, y = fsCU_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


fsCU_test_rows <- fsCU_test$row
fsCU_validate_rows <- fsCU_validate$row
fsCU_pred_data_emp_1 <- ungroup(fsCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsCU_test_rows)

fsCU_pred_data_emp <- ungroup(fsCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsCU_validate_rows) %>%
	rbind(fsCU_pred_data_emp_1)

fsCU_out_of_training_rows <- fsCU_pred_data_emp$row

fsCU_rf.5_full_out_of_sample_data <- ungroup(fsCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsCU_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



fsCU_rf.5_full_out_of_sample_data_scaled <- fsCU_rf.5_full_out_of_sample_data

fsCU_rf.5_full_out_of_sample_data_scaled$hit_speed <- (fsCU_rf.5_full_out_of_sample_data_scaled$hit_speed - fsCU_center_values[2]) / fsCU_scale_values[2]

fsCU_rf.5_full_out_of_sample_data_scaled$hit_angle <- (fsCU_rf.5_full_out_of_sample_data_scaled$hit_angle - fsCU_center_values[3]) / fsCU_scale_values[3]

fsCU_rf.5.prob <- predict(fsCU_rf.5, fsCU_rf.5_full_out_of_sample_data_scaled, type = "response")

fsCU_rf.5_full_out_of_sample_data <- cbind(filter(fsCU_rf.5_full_out_of_sample_data, row %in% fsCU_out_of_training_rows), fsCU_rf.5.prob)

names(fsCU_rf.5_full_out_of_sample_data)[65] <- "fits"
names(fsCU_rf.5_full_out_of_sample_data)

fsCU_rf.5_full_out_of_sample_data_reduced <- fsCU_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

fsCU_rf.5_mean_table <- fsCU_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

fsCU_rf.5_full_out_of_sample_data$type <- with(fsCU_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

fsCU_rf.5_full_out_of_sample_data$hit_label <- with(fsCU_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

fsCU_rf.5_plot1 <- ggplot(fsCU_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsCU_rf.5_plot1

fsCU_rf.5_plot2 <- ggplot(fsCU_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsCU_rf.5_plot2

fsCU_rf.5_plot3 <- ggplot(fsCU_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsCU_rf.5_plot3

fsCU_grid_plot_rf.5 <- grid.arrange(fsCU_rf.5_plot1, fsCU_rf.5_plot2, fsCU_rf.5_plot3, ncol = 3)
fsCU_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

fsCU_test_rows <- fsCU_test$row
fsCU_validate_rows <- fsCU_validate$row
fsCU_pred_data_emp_1 <- ungroup(fsCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsCU_test_rows)

fsCU_pred_data_emp <- ungroup(fsCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsCU_validate_rows) %>%
	rbind(fsCU_pred_data_emp_1)

fsCU_out_of_training_rows <- fsCU_pred_data_emp$row

fsCU_pred_data_emp <- ungroup(fsCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsCU_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

fsCU_pred_data_emp_scaled <- fsCU_pred_data_emp

fsCU_pred_data_emp_scaled$hit_speed <- (fsCU_pred_data_emp_scaled$hit_speed - fsCU_center_values[2]) / fsCU_scale_values[2]

fsCU_pred_data_emp_scaled$hit_angle <- (fsCU_pred_data_emp_scaled$hit_angle - fsCU_center_values[3]) / fsCU_scale_values[3]

fsCU_pred_prob_hit <- predict(fsCU_rf.5, fsCU_pred_data_emp_scaled, type = "prob")[,2]
fsCU_pred_prob_hit_fits <- cbind(fsCU_pred_data_emp, fsCU_pred_prob_hit)

fsCU_pred_prob_hit_fits[,c(1:2)] <- fsCU_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

fsCU_angle_speed_pred <- fsCU_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = fsCU_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFS-CU Hit Probability\n") + theme_bp_grey()

fsCU_angle_speed_pred
#####
fcCU$hit_distance_sc <- as.numeric(fcCU$hit_distance_sc, na.rm = TRUE)
fcCU$hit_angle <- as.numeric(fcCU$hit_angle, na.rm = TRUE)
fcCU$hit_speed <- as.numeric(fcCU$hit_speed, na.rm = TRUE)

fcCU$hit <- with(fcCU, ifelse(grepl("Single", fcCU$events), 1,
															ifelse(grepl("Double", fcCU$events), 1,
																		 ifelse(grepl("Triple", fcCU$events), 1, 
																		 			 ifelse(grepl("Home Run", fcCU$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

fcCU$fieldingTeam <- with(fcCU, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[fcCU$hit_distance_sc == "null"] = NA
#fcCU$hit_speed[fcCU$hit_speed == "null"] = NA
#fcCU$hit_angle[fcCU$hit_angle == "null"] = NA

# include row names for unique record identification

fcCU$row <- row.names(fcCU) %>% as.numeric()

# recode stand and home_team as factors

fcCU$stand <- as.factor(fcCU$stand)
fcCU$home_team <- as.factor(fcCU$home_team)


fcCU$game_date <- as.Date(fcCU$game_date)


# subset 

fcCU_working_data <- ungroup(fcCU) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(fcCU_working_data)
str(ungroup(fcCU))
table(fcCU_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

fcCU_working_data <- filter(fcCU_working_data, hc_x != 1, hc_y != 1)
head(fcCU_working_data)

# create training and test sets
# scaled data

set.seed(42)
fcCU_train <- sample_frac(fcCU_working_data, .15, replace = FALSE)
fcCU_split <- setdiff(fcCU_working_data, fcCU_train)
fcCU_test <- sample_frac(fcCU_split, .50, replace = FALSE)
fcCU_validate <- setdiff(fcCU_split, fcCU_test)

nrow(fcCU_train) + nrow(fcCU_test) + nrow(fcCU_validate) == nrow(fcCU_working_data)

with(fcCU_train, table(hit)) %>% prop.table()
with(fcCU_test, table(hit)) %>% prop.table()
with(fcCU_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(fcCU)
##as.numeric(fcCU$hit_distance_sc, fcCU$hit_speed, fcCU$hit_angle)

#fcCU_train$hit_distance_sc <- as.numeric(fcCU_train$hit_distance_sc)
#fcCU_train$hit_speed <- as.numeric(fcCU_train$hit_speed)
#fcCU_train$hit_angle <- as.numeric(fcCU_train$hit_angle)
#View(fcCU_train)
fcCU_scaled_data <- scale(fcCU_train[,c(1:5)])
fcCU_scale_values <- attr(fcCU_scaled_data, 'scaled:scale')
fcCU_scale_values
fcCU_center_values <- attr(fcCU_scaled_data, 'scaled:center')
fcCU_center_values
fcCU_train <- cbind(fcCU_scaled_data, select(fcCU_train, hit:row))

# save levels for factor variables
fcCU_levels_home_team <- levels(fcCU_train$home_team)
fcCU_levels_stand <- levels(fcCU_train$stand)
fcCU_levels_fieldingTeam <- levels(fcCU_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(fcCU_test)

fcCU_test$hit_distance_sc <- (fcCU_test$hit_distance_sc - fcCU_center_values[1]) / fcCU_scale_values[1]

fcCU_test$hit_speed <- (fcCU_test$hit_speed - fcCU_center_values[2]) / fcCU_scale_values[2]

fcCU_test$hit_angle <- (fcCU_test$hit_angle - fcCU_center_values[3]) / fcCU_scale_values[3]

fcCU_test$hc_x <- (fcCU_test$hc_x - fcCU_center_values[4]) / fcCU_scale_values[4]

fcCU_test$hc_y <- (fcCU_test$hc_y - fcCU_center_values[5]) / fcCU_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

fcCU_validate$hit_distance_sc <- (fcCU_validate$hit_distance_sc - fcCU_center_values[1]) / fcCU_scale_values[1]

fcCU_validate$hit_speed <- (fcCU_validate$hit_speed - fcCU_center_values[2]) / fcCU_scale_values[2]

fcCU_validate$hit_angle <- (fcCU_validate$hit_angle - fcCU_center_values[3]) / fcCU_scale_values[3]

fcCU_validate$hc_x <- (fcCU_validate$hc_x - fcCU_center_values[4]) / fcCU_scale_values[4]

fcCU_validate$hc_y <- (fcCU_validate$hc_y - fcCU_center_values[5]) / fcCU_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(fcCU_train)

set.seed(42)
fcCU_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(fcCU_train, -row), ntree = 501, importance = TRUE)

print(fcCU_rf.1)

plot(fcCU_rf.1)

varImpPlot(fcCU_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
fcCU_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(fcCU_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(fcCU_rf.5)

plot(fcCU_rf.5)

varImpPlot(fcCU_rf.5)

fcCU_predict_fit.rf.5 <- data.frame(fits = predict(fcCU_rf.5, fcCU_test, type = "prob")[,2], actuals = fcCU_test$hit)

fcCU_pred.rf.5 <- prediction(fcCU_predict_fit.rf.5$fits, fcCU_predict_fit.rf.5$actuals)

fcCU_roc.pred.rf.5 <- performance(fcCU_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(fcCU_roc.pred.rf.5)
abline(a = 0, b = 1)
fcCU_opt <- opt.cut(fcCU_roc.pred.rf.5, fcCU_pred.rf.5)
fcCU_opt
fcCU_opt <- fcCU_opt[3]
fcCU_predict_fit.rf.5$fits <- with(fcCU_predict_fit.rf.5, ifelse(fits > fcCU_opt, 1, 0)) 

str(fcCU_test)

#fcCU_test$fieldingTeam <- as.character(fcCU_test$fieldingTeam)
#fcCU_test$home_team <- as.character(fcCU_test$home_team)
#fcCU_test$hit <- as.logical(fcCU_test$hit)
#fcCU_test$stand <- as.logical(fcCU_test$stand)
str(fcCU_test)
fcCU_rf.5_confusion_test <- confusionMatrix(model = fcCU_rf.5, x = fcCU_test, y = fcCU_test$hit)
fcCU_rf.5_confusion_validate <- confusionMatrix(model = fcCU_rf.5, x = fcCU_validate, y = fcCU_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


fcCU_test_rows <- fcCU_test$row
fcCU_validate_rows <- fcCU_validate$row
fcCU_pred_data_emp_1 <- ungroup(fcCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcCU_test_rows)

fcCU_pred_data_emp <- ungroup(fcCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcCU_validate_rows) %>%
	rbind(fcCU_pred_data_emp_1)

fcCU_out_of_training_rows <- fcCU_pred_data_emp$row

fcCU_rf.5_full_out_of_sample_data <- ungroup(fcCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcCU_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



fcCU_rf.5_full_out_of_sample_data_scaled <- fcCU_rf.5_full_out_of_sample_data

fcCU_rf.5_full_out_of_sample_data_scaled$hit_speed <- (fcCU_rf.5_full_out_of_sample_data_scaled$hit_speed - fcCU_center_values[2]) / fcCU_scale_values[2]

fcCU_rf.5_full_out_of_sample_data_scaled$hit_angle <- (fcCU_rf.5_full_out_of_sample_data_scaled$hit_angle - fcCU_center_values[3]) / fcCU_scale_values[3]

fcCU_rf.5.prob <- predict(fcCU_rf.5, fcCU_rf.5_full_out_of_sample_data_scaled, type = "response")

fcCU_rf.5_full_out_of_sample_data <- cbind(filter(fcCU_rf.5_full_out_of_sample_data, row %in% fcCU_out_of_training_rows), fcCU_rf.5.prob)

names(fcCU_rf.5_full_out_of_sample_data)[65] <- "fits"
names(fcCU_rf.5_full_out_of_sample_data)

fcCU_rf.5_full_out_of_sample_data_reduced <- fcCU_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

fcCU_rf.5_mean_table <- fcCU_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

fcCU_rf.5_full_out_of_sample_data$type <- with(fcCU_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

fcCU_rf.5_full_out_of_sample_data$hit_label <- with(fcCU_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

fcCU_rf.5_plot1 <- ggplot(fcCU_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcCU_rf.5_plot1

fcCU_rf.5_plot2 <- ggplot(fcCU_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcCU_rf.5_plot2

fcCU_rf.5_plot3 <- ggplot(fcCU_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcCU_rf.5_plot3

fcCU_grid_plot_rf.5 <- grid.arrange(fcCU_rf.5_plot1, fcCU_rf.5_plot2, fcCU_rf.5_plot3, ncol = 3)
fcCU_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

fcCU_test_rows <- fcCU_test$row
fcCU_validate_rows <- fcCU_validate$row
fcCU_pred_data_emp_1 <- ungroup(fcCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcCU_test_rows)

fcCU_pred_data_emp <- ungroup(fcCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcCU_validate_rows) %>%
	rbind(fcCU_pred_data_emp_1)

fcCU_out_of_training_rows <- fcCU_pred_data_emp$row

fcCU_pred_data_emp <- ungroup(fcCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcCU_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

fcCU_pred_data_emp_scaled <- fcCU_pred_data_emp

fcCU_pred_data_emp_scaled$hit_speed <- (fcCU_pred_data_emp_scaled$hit_speed - fcCU_center_values[2]) / fcCU_scale_values[2]

fcCU_pred_data_emp_scaled$hit_angle <- (fcCU_pred_data_emp_scaled$hit_angle - fcCU_center_values[3]) / fcCU_scale_values[3]

fcCU_pred_prob_hit <- predict(fcCU_rf.5, fcCU_pred_data_emp_scaled, type = "prob")[,2]
fcCU_pred_prob_hit_fits <- cbind(fcCU_pred_data_emp, fcCU_pred_prob_hit)

fcCU_pred_prob_hit_fits[,c(1:2)] <- fcCU_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

fcCU_angle_speed_pred <- fcCU_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = fcCU_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFC-CU Hit Probability\n") + theme_bp_grey()

fcCU_angle_speed_pred
#####
chCU$hit_distance_sc <- as.numeric(chCU$hit_distance_sc, na.rm = TRUE)
chCU$hit_angle <- as.numeric(chCU$hit_angle, na.rm = TRUE)
chCU$hit_speed <- as.numeric(chCU$hit_speed, na.rm = TRUE)

chCU$hit <- with(chCU, ifelse(grepl("Single", chCU$events), 1,
															ifelse(grepl("Double", chCU$events), 1,
																		 ifelse(grepl("Triple", chCU$events), 1, 
																		 			 ifelse(grepl("Home Run", chCU$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

chCU$fieldingTeam <- with(chCU, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[chCU$hit_distance_sc == "null"] = NA
#chCU$hit_speed[chCU$hit_speed == "null"] = NA
#chCU$hit_angle[chCU$hit_angle == "null"] = NA

# include row names for unique record identification

chCU$row <- row.names(chCU) %>% as.numeric()

# recode stand and home_team as factors

chCU$stand <- as.factor(chCU$stand)
chCU$home_team <- as.factor(chCU$home_team)


chCU$game_date <- as.Date(chCU$game_date)


# subset 

chCU_working_data <- ungroup(chCU) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(chCU_working_data)
str(ungroup(chCU))
table(chCU_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

chCU_working_data <- filter(chCU_working_data, hc_x != 1, hc_y != 1)
head(chCU_working_data)

# create training and test sets
# scaled data

set.seed(42)
chCU_train <- sample_frac(chCU_working_data, .15, replace = FALSE)
chCU_split <- setdiff(chCU_working_data, chCU_train)
chCU_test <- sample_frac(chCU_split, .50, replace = FALSE)
chCU_validate <- setdiff(chCU_split, chCU_test)

nrow(chCU_train) + nrow(chCU_test) + nrow(chCU_validate) == nrow(chCU_working_data)

with(chCU_train, table(hit)) %>% prop.table()
with(chCU_test, table(hit)) %>% prop.table()
with(chCU_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(chCU)
##as.numeric(chCU$hit_distance_sc, chCU$hit_speed, chCU$hit_angle)

#chCU_train$hit_distance_sc <- as.numeric(chCU_train$hit_distance_sc)
#chCU_train$hit_speed <- as.numeric(chCU_train$hit_speed)
#chCU_train$hit_angle <- as.numeric(chCU_train$hit_angle)
#View(chCU_train)
chCU_scaled_data <- scale(chCU_train[,c(1:5)])
chCU_scale_values <- attr(chCU_scaled_data, 'scaled:scale')
chCU_scale_values
chCU_center_values <- attr(chCU_scaled_data, 'scaled:center')
chCU_center_values
chCU_train <- cbind(chCU_scaled_data, select(chCU_train, hit:row))

# save levels for factor variables
chCU_levels_home_team <- levels(chCU_train$home_team)
chCU_levels_stand <- levels(chCU_train$stand)
chCU_levels_fieldingTeam <- levels(chCU_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(chCU_test)

chCU_test$hit_distance_sc <- (chCU_test$hit_distance_sc - chCU_center_values[1]) / chCU_scale_values[1]

chCU_test$hit_speed <- (chCU_test$hit_speed - chCU_center_values[2]) / chCU_scale_values[2]

chCU_test$hit_angle <- (chCU_test$hit_angle - chCU_center_values[3]) / chCU_scale_values[3]

chCU_test$hc_x <- (chCU_test$hc_x - chCU_center_values[4]) / chCU_scale_values[4]

chCU_test$hc_y <- (chCU_test$hc_y - chCU_center_values[5]) / chCU_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

chCU_validate$hit_distance_sc <- (chCU_validate$hit_distance_sc - chCU_center_values[1]) / chCU_scale_values[1]

chCU_validate$hit_speed <- (chCU_validate$hit_speed - chCU_center_values[2]) / chCU_scale_values[2]

chCU_validate$hit_angle <- (chCU_validate$hit_angle - chCU_center_values[3]) / chCU_scale_values[3]

chCU_validate$hc_x <- (chCU_validate$hc_x - chCU_center_values[4]) / chCU_scale_values[4]

chCU_validate$hc_y <- (chCU_validate$hc_y - chCU_center_values[5]) / chCU_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(chCU_train)

set.seed(42)
chCU_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(chCU_train, -row), ntree = 501, importance = TRUE)

print(chCU_rf.1)

plot(chCU_rf.1)

varImpPlot(chCU_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
chCU_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(chCU_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(chCU_rf.5)

plot(chCU_rf.5)

varImpPlot(chCU_rf.5)

chCU_predict_fit.rf.5 <- data.frame(fits = predict(chCU_rf.5, chCU_test, type = "prob")[,2], actuals = chCU_test$hit)

chCU_pred.rf.5 <- prediction(chCU_predict_fit.rf.5$fits, chCU_predict_fit.rf.5$actuals)

chCU_roc.pred.rf.5 <- performance(chCU_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(chCU_roc.pred.rf.5)
abline(a = 0, b = 1)
chCU_opt <- opt.cut(chCU_roc.pred.rf.5, chCU_pred.rf.5)
chCU_opt
chCU_opt <- chCU_opt[3]
chCU_predict_fit.rf.5$fits <- with(chCU_predict_fit.rf.5, ifelse(fits > chCU_opt, 1, 0)) 

str(chCU_test)

#chCU_test$fieldingTeam <- as.character(chCU_test$fieldingTeam)
#chCU_test$home_team <- as.character(chCU_test$home_team)
#chCU_test$hit <- as.logical(chCU_test$hit)
#chCU_test$stand <- as.logical(chCU_test$stand)
str(chCU_test)
chCU_rf.5_confusion_test <- confusionMatrix(model = chCU_rf.5, x = chCU_test, y = chCU_test$hit)
chCU_rf.5_confusion_validate <- confusionMatrix(model = chCU_rf.5, x = chCU_validate, y = chCU_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


chCU_test_rows <- chCU_test$row
chCU_validate_rows <- chCU_validate$row
chCU_pred_data_emp_1 <- ungroup(chCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chCU_test_rows)

chCU_pred_data_emp <- ungroup(chCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chCU_validate_rows) %>%
	rbind(chCU_pred_data_emp_1)

chCU_out_of_training_rows <- chCU_pred_data_emp$row

chCU_rf.5_full_out_of_sample_data <- ungroup(chCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chCU_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



chCU_rf.5_full_out_of_sample_data_scaled <- chCU_rf.5_full_out_of_sample_data

chCU_rf.5_full_out_of_sample_data_scaled$hit_speed <- (chCU_rf.5_full_out_of_sample_data_scaled$hit_speed - chCU_center_values[2]) / chCU_scale_values[2]

chCU_rf.5_full_out_of_sample_data_scaled$hit_angle <- (chCU_rf.5_full_out_of_sample_data_scaled$hit_angle - chCU_center_values[3]) / chCU_scale_values[3]

chCU_rf.5.prob <- predict(chCU_rf.5, chCU_rf.5_full_out_of_sample_data_scaled, type = "response")

chCU_rf.5_full_out_of_sample_data <- cbind(filter(chCU_rf.5_full_out_of_sample_data, row %in% chCU_out_of_training_rows), chCU_rf.5.prob)

names(chCU_rf.5_full_out_of_sample_data)[65] <- "fits"
names(chCU_rf.5_full_out_of_sample_data)

chCU_rf.5_full_out_of_sample_data_reduced <- chCU_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

chCU_rf.5_mean_table <- chCU_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

chCU_rf.5_full_out_of_sample_data$type <- with(chCU_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

chCU_rf.5_full_out_of_sample_data$hit_label <- with(chCU_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

chCU_rf.5_plot1 <- ggplot(chCU_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chCU_rf.5_plot1

chCU_rf.5_plot2 <- ggplot(chCU_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chCU_rf.5_plot2

chCU_rf.5_plot3 <- ggplot(chCU_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chCU_rf.5_plot3

chCU_grid_plot_rf.5 <- grid.arrange(chCU_rf.5_plot1, chCU_rf.5_plot2, chCU_rf.5_plot3, ncol = 3)
chCU_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

chCU_test_rows <- chCU_test$row
chCU_validate_rows <- chCU_validate$row
chCU_pred_data_emp_1 <- ungroup(chCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chCU_test_rows)

chCU_pred_data_emp <- ungroup(chCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chCU_validate_rows) %>%
	rbind(chCU_pred_data_emp_1)

chCU_out_of_training_rows <- chCU_pred_data_emp$row

chCU_pred_data_emp <- ungroup(chCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chCU_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

chCU_pred_data_emp_scaled <- chCU_pred_data_emp

chCU_pred_data_emp_scaled$hit_speed <- (chCU_pred_data_emp_scaled$hit_speed - chCU_center_values[2]) / chCU_scale_values[2]

chCU_pred_data_emp_scaled$hit_angle <- (chCU_pred_data_emp_scaled$hit_angle - chCU_center_values[3]) / chCU_scale_values[3]

chCU_pred_prob_hit <- predict(chCU_rf.5, chCU_pred_data_emp_scaled, type = "prob")[,2]
chCU_pred_prob_hit_fits <- cbind(chCU_pred_data_emp, chCU_pred_prob_hit)

chCU_pred_prob_hit_fits[,c(1:2)] <- chCU_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

chCU_angle_speed_pred <- chCU_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = chCU_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nCH-CU Hit Probability\n") + theme_bp_grey()

chCU_angle_speed_pred

#####
ftCU$hit_distance_sc <- as.numeric(ftCU$hit_distance_sc, na.rm = TRUE)
ftCU$hit_angle <- as.numeric(ftCU$hit_angle, na.rm = TRUE)
ftCU$hit_speed <- as.numeric(ftCU$hit_speed, na.rm = TRUE)

ftCU$hit <- with(ftCU, ifelse(grepl("Single", ftCU$events), 1,
															ifelse(grepl("Double", ftCU$events), 1,
																		 ifelse(grepl("Triple", ftCU$events), 1, 
																		 			 ifelse(grepl("Home Run", ftCU$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

ftCU$fieldingTeam <- with(ftCU, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[ftCU$hit_distance_sc == "null"] = NA
#ftCU$hit_speed[ftCU$hit_speed == "null"] = NA
#ftCU$hit_angle[ftCU$hit_angle == "null"] = NA

# include row names for unique record identification

ftCU$row <- row.names(ftCU) %>% as.numeric()

# recode stand and home_team as factors

ftCU$stand <- as.factor(ftCU$stand)
ftCU$home_team <- as.factor(ftCU$home_team)


ftCU$game_date <- as.Date(ftCU$game_date)


# subset 

ftCU_working_data <- ungroup(ftCU) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(ftCU_working_data)
str(ungroup(ftCU))
table(ftCU_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

ftCU_working_data <- filter(ftCU_working_data, hc_x != 1, hc_y != 1)
head(ftCU_working_data)

# create training and test sets
# scaled data

set.seed(42)
ftCU_train <- sample_frac(ftCU_working_data, .15, replace = FALSE)
ftCU_split <- setdiff(ftCU_working_data, ftCU_train)
ftCU_test <- sample_frac(ftCU_split, .50, replace = FALSE)
ftCU_validate <- setdiff(ftCU_split, ftCU_test)

nrow(ftCU_train) + nrow(ftCU_test) + nrow(ftCU_validate) == nrow(ftCU_working_data)

with(ftCU_train, table(hit)) %>% prop.table()
with(ftCU_test, table(hit)) %>% prop.table()
with(ftCU_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(ftCU)
##as.numeric(ftCU$hit_distance_sc, ftCU$hit_speed, ftCU$hit_angle)

#ftCU_train$hit_distance_sc <- as.numeric(ftCU_train$hit_distance_sc)
#ftCU_train$hit_speed <- as.numeric(ftCU_train$hit_speed)
#ftCU_train$hit_angle <- as.numeric(ftCU_train$hit_angle)
#View(ftCU_train)
ftCU_scaled_data <- scale(ftCU_train[,c(1:5)])
ftCU_scale_values <- attr(ftCU_scaled_data, 'scaled:scale')
ftCU_scale_values
ftCU_center_values <- attr(ftCU_scaled_data, 'scaled:center')
ftCU_center_values
ftCU_train <- cbind(ftCU_scaled_data, select(ftCU_train, hit:row))

# save levels for factor variables
ftCU_levels_home_team <- levels(ftCU_train$home_team)
ftCU_levels_stand <- levels(ftCU_train$stand)
ftCU_levels_fieldingTeam <- levels(ftCU_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(ftCU_test)

ftCU_test$hit_distance_sc <- (ftCU_test$hit_distance_sc - ftCU_center_values[1]) / ftCU_scale_values[1]

ftCU_test$hit_speed <- (ftCU_test$hit_speed - ftCU_center_values[2]) / ftCU_scale_values[2]

ftCU_test$hit_angle <- (ftCU_test$hit_angle - ftCU_center_values[3]) / ftCU_scale_values[3]

ftCU_test$hc_x <- (ftCU_test$hc_x - ftCU_center_values[4]) / ftCU_scale_values[4]

ftCU_test$hc_y <- (ftCU_test$hc_y - ftCU_center_values[5]) / ftCU_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

ftCU_validate$hit_distance_sc <- (ftCU_validate$hit_distance_sc - ftCU_center_values[1]) / ftCU_scale_values[1]

ftCU_validate$hit_speed <- (ftCU_validate$hit_speed - ftCU_center_values[2]) / ftCU_scale_values[2]

ftCU_validate$hit_angle <- (ftCU_validate$hit_angle - ftCU_center_values[3]) / ftCU_scale_values[3]

ftCU_validate$hc_x <- (ftCU_validate$hc_x - ftCU_center_values[4]) / ftCU_scale_values[4]

ftCU_validate$hc_y <- (ftCU_validate$hc_y - ftCU_center_values[5]) / ftCU_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(ftCU_train)

set.seed(42)
ftCU_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(ftCU_train, -row), ntree = 501, importance = TRUE)

print(ftCU_rf.1)

plot(ftCU_rf.1)

varImpPlot(ftCU_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
ftCU_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(ftCU_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(ftCU_rf.5)

plot(ftCU_rf.5)

varImpPlot(ftCU_rf.5)

ftCU_predict_fit.rf.5 <- data.frame(fits = predict(ftCU_rf.5, ftCU_test, type = "prob")[,2], actuals = ftCU_test$hit)

ftCU_pred.rf.5 <- prediction(ftCU_predict_fit.rf.5$fits, ftCU_predict_fit.rf.5$actuals)

ftCU_roc.pred.rf.5 <- performance(ftCU_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(ftCU_roc.pred.rf.5)
abline(a = 0, b = 1)
ftCU_opt <- opt.cut(ftCU_roc.pred.rf.5, ftCU_pred.rf.5)
ftCU_opt
ftCU_opt <- ftCU_opt[3]
ftCU_predict_fit.rf.5$fits <- with(ftCU_predict_fit.rf.5, ifelse(fits > ftCU_opt, 1, 0)) 

str(ftCU_test)

#ftCU_test$fieldingTeam <- as.character(ftCU_test$fieldingTeam)
#ftCU_test$home_team <- as.character(ftCU_test$home_team)
#ftCU_test$hit <- as.logical(ftCU_test$hit)
#ftCU_test$stand <- as.logical(ftCU_test$stand)
str(ftCU_test)
ftCU_rf.5_confusion_test <- confusionMatrix(model = ftCU_rf.5, x = ftCU_test, y = ftCU_test$hit)
ftCU_rf.5_confusion_validate <- confusionMatrix(model = ftCU_rf.5, x = ftCU_validate, y = ftCU_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


ftCU_test_rows <- ftCU_test$row
ftCU_validate_rows <- ftCU_validate$row
ftCU_pred_data_emp_1 <- ungroup(ftCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftCU_test_rows)

ftCU_pred_data_emp <- ungroup(ftCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftCU_validate_rows) %>%
	rbind(ftCU_pred_data_emp_1)

ftCU_out_of_training_rows <- ftCU_pred_data_emp$row

ftCU_rf.5_full_out_of_sample_data <- ungroup(ftCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftCU_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



ftCU_rf.5_full_out_of_sample_data_scaled <- ftCU_rf.5_full_out_of_sample_data

ftCU_rf.5_full_out_of_sample_data_scaled$hit_speed <- (ftCU_rf.5_full_out_of_sample_data_scaled$hit_speed - ftCU_center_values[2]) / ftCU_scale_values[2]

ftCU_rf.5_full_out_of_sample_data_scaled$hit_angle <- (ftCU_rf.5_full_out_of_sample_data_scaled$hit_angle - ftCU_center_values[3]) / ftCU_scale_values[3]

ftCU_rf.5.prob <- predict(ftCU_rf.5, ftCU_rf.5_full_out_of_sample_data_scaled, type = "response")

ftCU_rf.5_full_out_of_sample_data <- cbind(filter(ftCU_rf.5_full_out_of_sample_data, row %in% ftCU_out_of_training_rows), ftCU_rf.5.prob)

names(ftCU_rf.5_full_out_of_sample_data)[65] <- "fits"
names(ftCU_rf.5_full_out_of_sample_data)

ftCU_rf.5_full_out_of_sample_data_reduced <- ftCU_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

ftCU_rf.5_mean_table <- ftCU_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

ftCU_rf.5_full_out_of_sample_data$type <- with(ftCU_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

ftCU_rf.5_full_out_of_sample_data$hit_label <- with(ftCU_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

ftCU_rf.5_plot1 <- ggplot(ftCU_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftCU_rf.5_plot1

ftCU_rf.5_plot2 <- ggplot(ftCU_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftCU_rf.5_plot2

ftCU_rf.5_plot3 <- ggplot(ftCU_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftCU_rf.5_plot3

ftCU_grid_plot_rf.5 <- grid.arrange(ftCU_rf.5_plot1, ftCU_rf.5_plot2, ftCU_rf.5_plot3, ncol = 3)
ftCU_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

ftCU_test_rows <- ftCU_test$row
ftCU_validate_rows <- ftCU_validate$row
ftCU_pred_data_emp_1 <- ungroup(ftCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftCU_test_rows)

ftCU_pred_data_emp <- ungroup(ftCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftCU_validate_rows) %>%
	rbind(ftCU_pred_data_emp_1)

ftCU_out_of_training_rows <- ftCU_pred_data_emp$row

ftCU_pred_data_emp <- ungroup(ftCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftCU_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

ftCU_pred_data_emp_scaled <- ftCU_pred_data_emp

ftCU_pred_data_emp_scaled$hit_speed <- (ftCU_pred_data_emp_scaled$hit_speed - ftCU_center_values[2]) / ftCU_scale_values[2]

ftCU_pred_data_emp_scaled$hit_angle <- (ftCU_pred_data_emp_scaled$hit_angle - ftCU_center_values[3]) / ftCU_scale_values[3]

ftCU_pred_prob_hit <- predict(ftCU_rf.5, ftCU_pred_data_emp_scaled, type = "prob")[,2]
ftCU_pred_prob_hit_fits <- cbind(ftCU_pred_data_emp, ftCU_pred_prob_hit)

ftCU_pred_prob_hit_fits[,c(1:2)] <- ftCU_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

ftCU_angle_speed_pred <- ftCU_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = ftCU_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFT-CU Hit Probability\n") + theme_bp_grey()

ftCU_angle_speed_pred
#####
slCU$hit_distance_sc <- as.numeric(slCU$hit_distance_sc, na.rm = TRUE)
slCU$hit_angle <- as.numeric(slCU$hit_angle, na.rm = TRUE)
slCU$hit_speed <- as.numeric(slCU$hit_speed, na.rm = TRUE)

slCU$hit <- with(slCU, ifelse(grepl("Single", slCU$events), 1,
															ifelse(grepl("Double", slCU$events), 1,
																		 ifelse(grepl("Triple", slCU$events), 1, 
																		 			 ifelse(grepl("Home Run", slCU$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

slCU$fieldingTeam <- with(slCU, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[slCU$hit_distance_sc == "null"] = NA
#slCU$hit_speed[slCU$hit_speed == "null"] = NA
#slCU$hit_angle[slCU$hit_angle == "null"] = NA

# include row names for unique record identification

slCU$row <- row.names(slCU) %>% as.numeric()

# recode stand and home_team as factors

slCU$stand <- as.factor(slCU$stand)
slCU$home_team <- as.factor(slCU$home_team)


slCU$game_date <- as.Date(slCU$game_date)


# subset 

slCU_working_data <- ungroup(slCU) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(slCU_working_data)
str(ungroup(slCU))
table(slCU_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

slCU_working_data <- filter(slCU_working_data, hc_x != 1, hc_y != 1)
head(slCU_working_data)

# create training and test sets
# scaled data

set.seed(42)
slCU_train <- sample_frac(slCU_working_data, .15, replace = FALSE)
slCU_split <- setdiff(slCU_working_data, slCU_train)
slCU_test <- sample_frac(slCU_split, .50, replace = FALSE)
slCU_validate <- setdiff(slCU_split, slCU_test)

nrow(slCU_train) + nrow(slCU_test) + nrow(slCU_validate) == nrow(slCU_working_data)

with(slCU_train, table(hit)) %>% prop.table()
with(slCU_test, table(hit)) %>% prop.table()
with(slCU_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(slCU)
##as.numeric(slCU$hit_distance_sc, slCU$hit_speed, slCU$hit_angle)

#slCU_train$hit_distance_sc <- as.numeric(slCU_train$hit_distance_sc)
#slCU_train$hit_speed <- as.numeric(slCU_train$hit_speed)
#slCU_train$hit_angle <- as.numeric(slCU_train$hit_angle)
#View(slCU_train)
slCU_scaled_data <- scale(slCU_train[,c(1:5)])
slCU_scale_values <- attr(slCU_scaled_data, 'scaled:scale')
slCU_scale_values
slCU_center_values <- attr(slCU_scaled_data, 'scaled:center')
slCU_center_values
slCU_train <- cbind(slCU_scaled_data, select(slCU_train, hit:row))

# save levels for factor variables
slCU_levels_home_team <- levels(slCU_train$home_team)
slCU_levels_stand <- levels(slCU_train$stand)
slCU_levels_fieldingTeam <- levels(slCU_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(slCU_test)

slCU_test$hit_distance_sc <- (slCU_test$hit_distance_sc - slCU_center_values[1]) / slCU_scale_values[1]

slCU_test$hit_speed <- (slCU_test$hit_speed - slCU_center_values[2]) / slCU_scale_values[2]

slCU_test$hit_angle <- (slCU_test$hit_angle - slCU_center_values[3]) / slCU_scale_values[3]

slCU_test$hc_x <- (slCU_test$hc_x - slCU_center_values[4]) / slCU_scale_values[4]

slCU_test$hc_y <- (slCU_test$hc_y - slCU_center_values[5]) / slCU_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

slCU_validate$hit_distance_sc <- (slCU_validate$hit_distance_sc - slCU_center_values[1]) / slCU_scale_values[1]

slCU_validate$hit_speed <- (slCU_validate$hit_speed - slCU_center_values[2]) / slCU_scale_values[2]

slCU_validate$hit_angle <- (slCU_validate$hit_angle - slCU_center_values[3]) / slCU_scale_values[3]

slCU_validate$hc_x <- (slCU_validate$hc_x - slCU_center_values[4]) / slCU_scale_values[4]

slCU_validate$hc_y <- (slCU_validate$hc_y - slCU_center_values[5]) / slCU_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(slCU_train)

set.seed(42)
slCU_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(slCU_train, -row), ntree = 501, importance = TRUE)

print(slCU_rf.1)

plot(slCU_rf.1)

varImpPlot(slCU_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
slCU_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(slCU_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(slCU_rf.5)

plot(slCU_rf.5)

varImpPlot(slCU_rf.5)

slCU_predict_fit.rf.5 <- data.frame(fits = predict(slCU_rf.5, slCU_test, type = "prob")[,2], actuals = slCU_test$hit)

slCU_pred.rf.5 <- prediction(slCU_predict_fit.rf.5$fits, slCU_predict_fit.rf.5$actuals)

slCU_roc.pred.rf.5 <- performance(slCU_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(slCU_roc.pred.rf.5)
abline(a = 0, b = 1)
slCU_opt <- opt.cut(slCU_roc.pred.rf.5, slCU_pred.rf.5)
slCU_opt
slCU_opt <- slCU_opt[3]
slCU_predict_fit.rf.5$fits <- with(slCU_predict_fit.rf.5, ifelse(fits > slCU_opt, 1, 0)) 

str(slCU_test)

#slCU_test$fieldingTeam <- as.character(slCU_test$fieldingTeam)
#slCU_test$home_team <- as.character(slCU_test$home_team)
#slCU_test$hit <- as.logical(slCU_test$hit)
#slCU_test$stand <- as.logical(slCU_test$stand)
str(slCU_test)
slCU_rf.5_confusion_test <- confusionMatrix(model = slCU_rf.5, x = slCU_test, y = slCU_test$hit)
slCU_rf.5_confusion_validate <- confusionMatrix(model = slCU_rf.5, x = slCU_validate, y = slCU_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


slCU_test_rows <- slCU_test$row
slCU_validate_rows <- slCU_validate$row
slCU_pred_data_emp_1 <- ungroup(slCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slCU_test_rows)

slCU_pred_data_emp <- ungroup(slCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slCU_validate_rows) %>%
	rbind(slCU_pred_data_emp_1)

slCU_out_of_training_rows <- slCU_pred_data_emp$row

slCU_rf.5_full_out_of_sample_data <- ungroup(slCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slCU_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



slCU_rf.5_full_out_of_sample_data_scaled <- slCU_rf.5_full_out_of_sample_data

slCU_rf.5_full_out_of_sample_data_scaled$hit_speed <- (slCU_rf.5_full_out_of_sample_data_scaled$hit_speed - slCU_center_values[2]) / slCU_scale_values[2]

slCU_rf.5_full_out_of_sample_data_scaled$hit_angle <- (slCU_rf.5_full_out_of_sample_data_scaled$hit_angle - slCU_center_values[3]) / slCU_scale_values[3]

slCU_rf.5.prob <- predict(slCU_rf.5, slCU_rf.5_full_out_of_sample_data_scaled, type = "response")

slCU_rf.5_full_out_of_sample_data <- cbind(filter(slCU_rf.5_full_out_of_sample_data, row %in% slCU_out_of_training_rows), slCU_rf.5.prob)

names(slCU_rf.5_full_out_of_sample_data)[65] <- "fits"
names(slCU_rf.5_full_out_of_sample_data)

slCU_rf.5_full_out_of_sample_data_reduced <- slCU_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

slCU_rf.5_mean_table <- slCU_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

slCU_rf.5_full_out_of_sample_data$type <- with(slCU_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

slCU_rf.5_full_out_of_sample_data$hit_label <- with(slCU_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

slCU_rf.5_plot1 <- ggplot(slCU_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slCU_rf.5_plot1

slCU_rf.5_plot2 <- ggplot(slCU_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slCU_rf.5_plot2

slCU_rf.5_plot3 <- ggplot(slCU_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slCU_rf.5_plot3

slCU_grid_plot_rf.5 <- grid.arrange(slCU_rf.5_plot1, slCU_rf.5_plot2, slCU_rf.5_plot3, ncol = 3)
slCU_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

slCU_test_rows <- slCU_test$row
slCU_validate_rows <- slCU_validate$row
slCU_pred_data_emp_1 <- ungroup(slCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slCU_test_rows)

slCU_pred_data_emp <- ungroup(slCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slCU_validate_rows) %>%
	rbind(slCU_pred_data_emp_1)

slCU_out_of_training_rows <- slCU_pred_data_emp$row

slCU_pred_data_emp <- ungroup(slCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slCU_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

slCU_pred_data_emp_scaled <- slCU_pred_data_emp

slCU_pred_data_emp_scaled$hit_speed <- (slCU_pred_data_emp_scaled$hit_speed - slCU_center_values[2]) / slCU_scale_values[2]

slCU_pred_data_emp_scaled$hit_angle <- (slCU_pred_data_emp_scaled$hit_angle - slCU_center_values[3]) / slCU_scale_values[3]

slCU_pred_prob_hit <- predict(slCU_rf.5, slCU_pred_data_emp_scaled, type = "prob")[,2]
slCU_pred_prob_hit_fits <- cbind(slCU_pred_data_emp, slCU_pred_prob_hit)

slCU_pred_prob_hit_fits[,c(1:2)] <- slCU_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

slCU_angle_speed_pred <- slCU_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = slCU_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nSL-CU Hit Probability\n") + theme_bp_grey()

slCU_angle_speed_pred
#####
ffCU$hit_distance_sc <- as.numeric(ffCU$hit_distance_sc, na.rm = TRUE)
ffCU$hit_angle <- as.numeric(ffCU$hit_angle, na.rm = TRUE)
ffCU$hit_speed <- as.numeric(ffCU$hit_speed, na.rm = TRUE)

ffCU$hit <- with(ffCU, ifelse(grepl("Single", ffCU$events), 1,
															ifelse(grepl("Double", ffCU$events), 1,
																		 ifelse(grepl("Triple", ffCU$events), 1, 
																		 			 ifelse(grepl("Home Run", ffCU$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

ffCU$fieldingTeam <- with(ffCU, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[ffCU$hit_distance_sc == "null"] = NA
#ffCU$hit_speed[ffCU$hit_speed == "null"] = NA
#ffCU$hit_angle[ffCU$hit_angle == "null"] = NA

# include row names for unique record identification

ffCU$row <- row.names(ffCU) %>% as.numeric()

# recode stand and home_team as factors

ffCU$stand <- as.factor(ffCU$stand)
ffCU$home_team <- as.factor(ffCU$home_team)


ffCU$game_date <- as.Date(ffCU$game_date)


# subset 

ffCU_working_data <- ungroup(ffCU) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(ffCU_working_data)
str(ungroup(ffCU))
table(ffCU_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

ffCU_working_data <- filter(ffCU_working_data, hc_x != 1, hc_y != 1)
head(ffCU_working_data)

# create training and test sets
# scaled data

set.seed(42)
ffCU_train <- sample_frac(ffCU_working_data, .15, replace = FALSE)
ffCU_split <- setdiff(ffCU_working_data, ffCU_train)
ffCU_test <- sample_frac(ffCU_split, .50, replace = FALSE)
ffCU_validate <- setdiff(ffCU_split, ffCU_test)

nrow(ffCU_train) + nrow(ffCU_test) + nrow(ffCU_validate) == nrow(ffCU_working_data)

with(ffCU_train, table(hit)) %>% prop.table()
with(ffCU_test, table(hit)) %>% prop.table()
with(ffCU_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(ffCU)
##as.numeric(ffCU$hit_distance_sc, ffCU$hit_speed, ffCU$hit_angle)

#ffCU_train$hit_distance_sc <- as.numeric(ffCU_train$hit_distance_sc)
#ffCU_train$hit_speed <- as.numeric(ffCU_train$hit_speed)
#ffCU_train$hit_angle <- as.numeric(ffCU_train$hit_angle)
#View(ffCU_train)
ffCU_scaled_data <- scale(ffCU_train[,c(1:5)])
ffCU_scale_values <- attr(ffCU_scaled_data, 'scaled:scale')
ffCU_scale_values
ffCU_center_values <- attr(ffCU_scaled_data, 'scaled:center')
ffCU_center_values
ffCU_train <- cbind(ffCU_scaled_data, select(ffCU_train, hit:row))

# save levels for factor variables
ffCU_levels_home_team <- levels(ffCU_train$home_team)
ffCU_levels_stand <- levels(ffCU_train$stand)
ffCU_levels_fieldingTeam <- levels(ffCU_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(ffCU_test)

ffCU_test$hit_distance_sc <- (ffCU_test$hit_distance_sc - ffCU_center_values[1]) / ffCU_scale_values[1]

ffCU_test$hit_speed <- (ffCU_test$hit_speed - ffCU_center_values[2]) / ffCU_scale_values[2]

ffCU_test$hit_angle <- (ffCU_test$hit_angle - ffCU_center_values[3]) / ffCU_scale_values[3]

ffCU_test$hc_x <- (ffCU_test$hc_x - ffCU_center_values[4]) / ffCU_scale_values[4]

ffCU_test$hc_y <- (ffCU_test$hc_y - ffCU_center_values[5]) / ffCU_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

ffCU_validate$hit_distance_sc <- (ffCU_validate$hit_distance_sc - ffCU_center_values[1]) / ffCU_scale_values[1]

ffCU_validate$hit_speed <- (ffCU_validate$hit_speed - ffCU_center_values[2]) / ffCU_scale_values[2]

ffCU_validate$hit_angle <- (ffCU_validate$hit_angle - ffCU_center_values[3]) / ffCU_scale_values[3]

ffCU_validate$hc_x <- (ffCU_validate$hc_x - ffCU_center_values[4]) / ffCU_scale_values[4]

ffCU_validate$hc_y <- (ffCU_validate$hc_y - ffCU_center_values[5]) / ffCU_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(ffCU_train)

set.seed(42)
ffCU_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(ffCU_train, -row), ntree = 501, importance = TRUE)

print(ffCU_rf.1)

plot(ffCU_rf.1)

varImpPlot(ffCU_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
ffCU_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(ffCU_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(ffCU_rf.5)

plot(ffCU_rf.5)

varImpPlot(ffCU_rf.5)

ffCU_predict_fit.rf.5 <- data.frame(fits = predict(ffCU_rf.5, ffCU_test, type = "prob")[,2], actuals = ffCU_test$hit)

ffCU_pred.rf.5 <- prediction(ffCU_predict_fit.rf.5$fits, ffCU_predict_fit.rf.5$actuals)

ffCU_roc.pred.rf.5 <- performance(ffCU_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(ffCU_roc.pred.rf.5)
abline(a = 0, b = 1)
ffCU_opt <- opt.cut(ffCU_roc.pred.rf.5, ffCU_pred.rf.5)
ffCU_opt
ffCU_opt <- ffCU_opt[3]
ffCU_predict_fit.rf.5$fits <- with(ffCU_predict_fit.rf.5, ifelse(fits > ffCU_opt, 1, 0)) 

str(ffCU_test)

#ffCU_test$fieldingTeam <- as.character(ffCU_test$fieldingTeam)
#ffCU_test$home_team <- as.character(ffCU_test$home_team)
#ffCU_test$hit <- as.logical(ffCU_test$hit)
#ffCU_test$stand <- as.logical(ffCU_test$stand)
str(ffCU_test)
ffCU_rf.5_confusion_test <- confusionMatrix(model = ffCU_rf.5, x = ffCU_test, y = ffCU_test$hit)
ffCU_rf.5_confusion_validate <- confusionMatrix(model = ffCU_rf.5, x = ffCU_validate, y = ffCU_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


ffCU_test_rows <- ffCU_test$row
ffCU_validate_rows <- ffCU_validate$row
ffCU_pred_data_emp_1 <- ungroup(ffCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffCU_test_rows)

ffCU_pred_data_emp <- ungroup(ffCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffCU_validate_rows) %>%
	rbind(ffCU_pred_data_emp_1)

ffCU_out_of_training_rows <- ffCU_pred_data_emp$row

ffCU_rf.5_full_out_of_sample_data <- ungroup(ffCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffCU_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



ffCU_rf.5_full_out_of_sample_data_scaled <- ffCU_rf.5_full_out_of_sample_data

ffCU_rf.5_full_out_of_sample_data_scaled$hit_speed <- (ffCU_rf.5_full_out_of_sample_data_scaled$hit_speed - ffCU_center_values[2]) / ffCU_scale_values[2]

ffCU_rf.5_full_out_of_sample_data_scaled$hit_angle <- (ffCU_rf.5_full_out_of_sample_data_scaled$hit_angle - ffCU_center_values[3]) / ffCU_scale_values[3]

ffCU_rf.5.prob <- predict(ffCU_rf.5, ffCU_rf.5_full_out_of_sample_data_scaled, type = "response")

ffCU_rf.5_full_out_of_sample_data <- cbind(filter(ffCU_rf.5_full_out_of_sample_data, row %in% ffCU_out_of_training_rows), ffCU_rf.5.prob)

names(ffCU_rf.5_full_out_of_sample_data)[65] <- "fits"
names(ffCU_rf.5_full_out_of_sample_data)

ffCU_rf.5_full_out_of_sample_data_reduced <- ffCU_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

ffCU_rf.5_mean_table <- ffCU_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

ffCU_rf.5_full_out_of_sample_data$type <- with(ffCU_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

ffCU_rf.5_full_out_of_sample_data$hit_label <- with(ffCU_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

ffCU_rf.5_plot1 <- ggplot(ffCU_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffCU_rf.5_plot1

ffCU_rf.5_plot2 <- ggplot(ffCU_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffCU_rf.5_plot2

ffCU_rf.5_plot3 <- ggplot(ffCU_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffCU_rf.5_plot3

ffCU_grid_plot_rf.5 <- grid.arrange(ffCU_rf.5_plot1, ffCU_rf.5_plot2, ffCU_rf.5_plot3, ncol = 3)
ffCU_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

ffCU_test_rows <- ffCU_test$row
ffCU_validate_rows <- ffCU_validate$row
ffCU_pred_data_emp_1 <- ungroup(ffCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffCU_test_rows)

ffCU_pred_data_emp <- ungroup(ffCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffCU_validate_rows) %>%
	rbind(ffCU_pred_data_emp_1)

ffCU_out_of_training_rows <- ffCU_pred_data_emp$row

ffCU_pred_data_emp <- ungroup(ffCU) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffCU_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

ffCU_pred_data_emp_scaled <- ffCU_pred_data_emp

ffCU_pred_data_emp_scaled$hit_speed <- (ffCU_pred_data_emp_scaled$hit_speed - ffCU_center_values[2]) / ffCU_scale_values[2]

ffCU_pred_data_emp_scaled$hit_angle <- (ffCU_pred_data_emp_scaled$hit_angle - ffCU_center_values[3]) / ffCU_scale_values[3]

ffCU_pred_prob_hit <- predict(ffCU_rf.5, ffCU_pred_data_emp_scaled, type = "prob")[,2]
ffCU_pred_prob_hit_fits <- cbind(ffCU_pred_data_emp, ffCU_pred_prob_hit)

ffCU_pred_prob_hit_fits[,c(1:2)] <- ffCU_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

ffCU_angle_speed_pred <- ffCU_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = ffCU_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFF-CU Hit Probability\n") + theme_bp_grey()

ffCU_angle_speed_pred
############# End Curveballs; Start Changeups
#####
siCH$hit_distance_sc <- as.numeric(siCH$hit_distance_sc, na.rm = TRUE)
siCH$hit_angle <- as.numeric(siCH$hit_angle, na.rm = TRUE)
siCH$hit_speed <- as.numeric(siCH$hit_speed, na.rm = TRUE)

siCH$hit <- with(siCH, ifelse(grepl("Single", siCH$events), 1,
															ifelse(grepl("Double", siCH$events), 1,
																		 ifelse(grepl("Triple", siCH$events), 1, 
																		 			 ifelse(grepl("Home Run", siCH$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

siCH$fieldingTeam <- with(siCH, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[siCH$hit_distance_sc == "null"] = NA
#siCH$hit_speed[siCH$hit_speed == "null"] = NA
#siCH$hit_angle[siCH$hit_angle == "null"] = NA

# include row names for unique record identification

siCH$row <- row.names(siCH) %>% as.numeric()

# recode stand and home_team as factors

siCH$stand <- as.factor(siCH$stand)
siCH$home_team <- as.factor(siCH$home_team)


siCH$game_date <- as.Date(siCH$game_date)


# subset 

siCH_working_data <- ungroup(siCH) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(siCH_working_data)
str(ungroup(siCH))
table(siCH_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

siCH_working_data <- filter(siCH_working_data, hc_x != 1, hc_y != 1)
head(siCH_working_data)

# create training and test sets
# scaled data

set.seed(42)
siCH_train <- sample_frac(siCH_working_data, .15, replace = FALSE)
siCH_split <- setdiff(siCH_working_data, siCH_train)
siCH_test <- sample_frac(siCH_split, .50, replace = FALSE)
siCH_validate <- setdiff(siCH_split, siCH_test)

nrow(siCH_train) + nrow(siCH_test) + nrow(siCH_validate) == nrow(siCH_working_data)

with(siCH_train, table(hit)) %>% prop.table()
with(siCH_test, table(hit)) %>% prop.table()
with(siCH_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(siCH)
##as.numeric(siCH$hit_distance_sc, siCH$hit_speed, siCH$hit_angle)

#siCH_train$hit_distance_sc <- as.numeric(siCH_train$hit_distance_sc)
#siCH_train$hit_speed <- as.numeric(siCH_train$hit_speed)
#siCH_train$hit_angle <- as.numeric(siCH_train$hit_angle)
#View(siCH_train)
siCH_scaled_data <- scale(siCH_train[,c(1:5)])
siCH_scale_values <- attr(siCH_scaled_data, 'scaled:scale')
siCH_scale_values
siCH_center_values <- attr(siCH_scaled_data, 'scaled:center')
siCH_center_values
siCH_train <- cbind(siCH_scaled_data, select(siCH_train, hit:row))

# save levels for factor variables
siCH_levels_home_team <- levels(siCH_train$home_team)
siCH_levels_stand <- levels(siCH_train$stand)
siCH_levels_fieldingTeam <- levels(siCH_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(siCH_test)

siCH_test$hit_distance_sc <- (siCH_test$hit_distance_sc - siCH_center_values[1]) / siCH_scale_values[1]

siCH_test$hit_speed <- (siCH_test$hit_speed - siCH_center_values[2]) / siCH_scale_values[2]

siCH_test$hit_angle <- (siCH_test$hit_angle - siCH_center_values[3]) / siCH_scale_values[3]

siCH_test$hc_x <- (siCH_test$hc_x - siCH_center_values[4]) / siCH_scale_values[4]

siCH_test$hc_y <- (siCH_test$hc_y - siCH_center_values[5]) / siCH_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

siCH_validate$hit_distance_sc <- (siCH_validate$hit_distance_sc - siCH_center_values[1]) / siCH_scale_values[1]

siCH_validate$hit_speed <- (siCH_validate$hit_speed - siCH_center_values[2]) / siCH_scale_values[2]

siCH_validate$hit_angle <- (siCH_validate$hit_angle - siCH_center_values[3]) / siCH_scale_values[3]

siCH_validate$hc_x <- (siCH_validate$hc_x - siCH_center_values[4]) / siCH_scale_values[4]

siCH_validate$hc_y <- (siCH_validate$hc_y - siCH_center_values[5]) / siCH_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(siCH_train)

set.seed(42)
siCH_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(siCH_train, -row), ntree = 501, importance = TRUE)

print(siCH_rf.1)

plot(siCH_rf.1)

varImpPlot(siCH_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
siCH_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(siCH_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(siCH_rf.5)

plot(siCH_rf.5)

varImpPlot(siCH_rf.5)

siCH_predict_fit.rf.5 <- data.frame(fits = predict(siCH_rf.5, siCH_test, type = "prob")[,2], actuals = siCH_test$hit)

siCH_pred.rf.5 <- prediction(siCH_predict_fit.rf.5$fits, siCH_predict_fit.rf.5$actuals)

siCH_roc.pred.rf.5 <- performance(siCH_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(siCH_roc.pred.rf.5)
abline(a = 0, b = 1)
siCH_opt <- opt.cut(siCH_roc.pred.rf.5, siCH_pred.rf.5)
siCH_opt
siCH_opt <- siCH_opt[3]
siCH_predict_fit.rf.5$fits <- with(siCH_predict_fit.rf.5, ifelse(fits > siCH_opt, 1, 0)) 

str(siCH_test)

#siCH_test$fieldingTeam <- as.character(siCH_test$fieldingTeam)
#siCH_test$home_team <- as.character(siCH_test$home_team)
#siCH_test$hit <- as.logical(siCH_test$hit)
#siCH_test$stand <- as.logical(siCH_test$stand)
str(siCH_test)
siCH_rf.5_confusion_test <- confusionMatrix(model = siCH_rf.5, x = siCH_test, y = siCH_test$hit)
siCH_rf.5_confusion_validate <- confusionMatrix(model = siCH_rf.5, x = siCH_validate, y = siCH_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


siCH_test_rows <- siCH_test$row
siCH_validate_rows <- siCH_validate$row
siCH_pred_data_emp_1 <- ungroup(siCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siCH_test_rows)

siCH_pred_data_emp <- ungroup(siCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siCH_validate_rows) %>%
	rbind(siCH_pred_data_emp_1)

siCH_out_of_training_rows <- siCH_pred_data_emp$row

siCH_rf.5_full_out_of_sample_data <- ungroup(siCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siCH_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



siCH_rf.5_full_out_of_sample_data_scaled <- siCH_rf.5_full_out_of_sample_data

siCH_rf.5_full_out_of_sample_data_scaled$hit_speed <- (siCH_rf.5_full_out_of_sample_data_scaled$hit_speed - siCH_center_values[2]) / siCH_scale_values[2]

siCH_rf.5_full_out_of_sample_data_scaled$hit_angle <- (siCH_rf.5_full_out_of_sample_data_scaled$hit_angle - siCH_center_values[3]) / siCH_scale_values[3]

siCH_rf.5.prob <- predict(siCH_rf.5, siCH_rf.5_full_out_of_sample_data_scaled, type = "response")

siCH_rf.5_full_out_of_sample_data <- cbind(filter(siCH_rf.5_full_out_of_sample_data, row %in% siCH_out_of_training_rows), siCH_rf.5.prob)

names(siCH_rf.5_full_out_of_sample_data)[65] <- "fits"
names(siCH_rf.5_full_out_of_sample_data)

siCH_rf.5_full_out_of_sample_data_reduced <- siCH_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

siCH_rf.5_mean_table <- siCH_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

siCH_rf.5_full_out_of_sample_data$type <- with(siCH_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

siCH_rf.5_full_out_of_sample_data$hit_label <- with(siCH_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

siCH_rf.5_plot1 <- ggplot(siCH_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siCH_rf.5_plot1

siCH_rf.5_plot2 <- ggplot(siCH_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siCH_rf.5_plot2

siCH_rf.5_plot3 <- ggplot(siCH_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siCH_rf.5_plot3

siCH_grid_plot_rf.5 <- grid.arrange(siCH_rf.5_plot1, siCH_rf.5_plot2, siCH_rf.5_plot3, ncol = 3)
siCH_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

siCH_test_rows <- siCH_test$row
siCH_validate_rows <- siCH_validate$row
siCH_pred_data_emp_1 <- ungroup(siCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siCH_test_rows)

siCH_pred_data_emp <- ungroup(siCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siCH_validate_rows) %>%
	rbind(siCH_pred_data_emp_1)

siCH_out_of_training_rows <- siCH_pred_data_emp$row

siCH_pred_data_emp <- ungroup(siCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siCH_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

siCH_pred_data_emp_scaled <- siCH_pred_data_emp

siCH_pred_data_emp_scaled$hit_speed <- (siCH_pred_data_emp_scaled$hit_speed - siCH_center_values[2]) / siCH_scale_values[2]

siCH_pred_data_emp_scaled$hit_angle <- (siCH_pred_data_emp_scaled$hit_angle - siCH_center_values[3]) / siCH_scale_values[3]

siCH_pred_prob_hit <- predict(siCH_rf.5, siCH_pred_data_emp_scaled, type = "prob")[,2]
siCH_pred_prob_hit_fits <- cbind(siCH_pred_data_emp, siCH_pred_prob_hit)

siCH_pred_prob_hit_fits[,c(1:2)] <- siCH_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

siCH_angle_speed_pred <- siCH_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = siCH_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nSI-CH Hit Probability\n") + theme_bp_grey()

siCH_angle_speed_pred
########################## Start Changeups
#####
knCH$hit_distance_sc <- as.numeric(knCH$hit_distance_sc, na.rm = TRUE)
knCH$hit_angle <- as.numeric(knCH$hit_angle, na.rm = TRUE)
knCH$hit_speed <- as.numeric(knCH$hit_speed, na.rm = TRUE)

knCH$hit <- with(knCH, ifelse(grepl("Single", knCH$events), 1,
															ifelse(grepl("Double", knCH$events), 1,
																		 ifelse(grepl("Triple", knCH$events), 1, 
																		 			 ifelse(grepl("Home Run", knCH$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

knCH$fieldingTeam <- with(knCH, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[knCH$hit_distance_sc == "null"] = NA
#knCH$hit_speed[knCH$hit_speed == "null"] = NA
#knCH$hit_angle[knCH$hit_angle == "null"] = NA

# include row names for unique record identification

knCH$row <- row.names(knCH) %>% as.numeric()

# recode stand and home_team as factors

knCH$stand <- as.factor(knCH$stand)
knCH$home_team <- as.factor(knCH$home_team)


knCH$game_date <- as.Date(knCH$game_date)


# subset 

knCH_working_data <- ungroup(knCH) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(knCH_working_data)
str(ungroup(knCH))
table(knCH_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

knCH_working_data <- filter(knCH_working_data, hc_x != 1, hc_y != 1)
head(knCH_working_data)

# create training and test sets
# scaled data

set.seed(42)
knCH_train <- sample_frac(knCH_working_data, .15, replace = FALSE)
knCH_split <- setdiff(knCH_working_data, knCH_train)
knCH_test <- sample_frac(knCH_split, .50, replace = FALSE)
knCH_validate <- setdiff(knCH_split, knCH_test)

nrow(knCH_train) + nrow(knCH_test) + nrow(knCH_validate) == nrow(knCH_working_data)

with(knCH_train, table(hit)) %>% prop.table()
with(knCH_test, table(hit)) %>% prop.table()
with(knCH_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(knCH)
##as.numeric(knCH$hit_distance_sc, knCH$hit_speed, knCH$hit_angle)

#knCH_train$hit_distance_sc <- as.numeric(knCH_train$hit_distance_sc)
#knCH_train$hit_speed <- as.numeric(knCH_train$hit_speed)
#knCH_train$hit_angle <- as.numeric(knCH_train$hit_angle)
#View(knCH_train)
knCH_scaled_data <- scale(knCH_train[,c(1:5)])
knCH_scale_values <- attr(knCH_scaled_data, 'scaled:scale')
knCH_scale_values
knCH_center_values <- attr(knCH_scaled_data, 'scaled:center')
knCH_center_values
knCH_train <- cbind(knCH_scaled_data, select(knCH_train, hit:row))

# save levels for factor variables
knCH_levels_home_team <- levels(knCH_train$home_team)
knCH_levels_stand <- levels(knCH_train$stand)
knCH_levels_fieldingTeam <- levels(knCH_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(knCH_test)

knCH_test$hit_distance_sc <- (knCH_test$hit_distance_sc - knCH_center_values[1]) / knCH_scale_values[1]

knCH_test$hit_speed <- (knCH_test$hit_speed - knCH_center_values[2]) / knCH_scale_values[2]

knCH_test$hit_angle <- (knCH_test$hit_angle - knCH_center_values[3]) / knCH_scale_values[3]

knCH_test$hc_x <- (knCH_test$hc_x - knCH_center_values[4]) / knCH_scale_values[4]

knCH_test$hc_y <- (knCH_test$hc_y - knCH_center_values[5]) / knCH_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

knCH_validate$hit_distance_sc <- (knCH_validate$hit_distance_sc - knCH_center_values[1]) / knCH_scale_values[1]

knCH_validate$hit_speed <- (knCH_validate$hit_speed - knCH_center_values[2]) / knCH_scale_values[2]

knCH_validate$hit_angle <- (knCH_validate$hit_angle - knCH_center_values[3]) / knCH_scale_values[3]

knCH_validate$hc_x <- (knCH_validate$hc_x - knCH_center_values[4]) / knCH_scale_values[4]

knCH_validate$hc_y <- (knCH_validate$hc_y - knCH_center_values[5]) / knCH_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(knCH_train)

set.seed(42)
knCH_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(knCH_train, -row), ntree = 501, importance = TRUE)

print(knCH_rf.1)

plot(knCH_rf.1)

varImpPlot(knCH_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
knCH_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(knCH_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(knCH_rf.5)

plot(knCH_rf.5)

varImpPlot(knCH_rf.5)

knCH_predict_fit.rf.5 <- data.frame(fits = predict(knCH_rf.5, knCH_test, type = "prob")[,2], actuals = knCH_test$hit)

knCH_pred.rf.5 <- prediction(knCH_predict_fit.rf.5$fits, knCH_predict_fit.rf.5$actuals)

knCH_roc.pred.rf.5 <- performance(knCH_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(knCH_roc.pred.rf.5)
abline(a = 0, b = 1)
knCH_opt <- opt.cut(knCH_roc.pred.rf.5, knCH_pred.rf.5)
knCH_opt
knCH_opt <- knCH_opt[3]
knCH_predict_fit.rf.5$fits <- with(knCH_predict_fit.rf.5, ifelse(fits > knCH_opt, 1, 0)) 

str(knCH_test)

#knCH_test$fieldingTeam <- as.character(knCH_test$fieldingTeam)
#knCH_test$home_team <- as.character(knCH_test$home_team)
#knCH_test$hit <- as.logical(knCH_test$hit)
#knCH_test$stand <- as.logical(knCH_test$stand)
str(knCH_test)
knCH_rf.5_confusion_test <- confusionMatrix(model = knCH_rf.5, x = knCH_test, y = knCH_test$hit)
knCH_rf.5_confusion_validate <- confusionMatrix(model = knCH_rf.5, x = knCH_validate, y = knCH_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


knCH_test_rows <- knCH_test$row
knCH_validate_rows <- knCH_validate$row
knCH_pred_data_emp_1 <- ungroup(knCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knCH_test_rows)

knCH_pred_data_emp <- ungroup(knCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knCH_validate_rows) %>%
	rbind(knCH_pred_data_emp_1)

knCH_out_of_training_rows <- knCH_pred_data_emp$row

knCH_rf.5_full_out_of_sample_data <- ungroup(knCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knCH_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



knCH_rf.5_full_out_of_sample_data_scaled <- knCH_rf.5_full_out_of_sample_data

knCH_rf.5_full_out_of_sample_data_scaled$hit_speed <- (knCH_rf.5_full_out_of_sample_data_scaled$hit_speed - knCH_center_values[2]) / knCH_scale_values[2]

knCH_rf.5_full_out_of_sample_data_scaled$hit_angle <- (knCH_rf.5_full_out_of_sample_data_scaled$hit_angle - knCH_center_values[3]) / knCH_scale_values[3]

knCH_rf.5.prob <- predict(knCH_rf.5, knCH_rf.5_full_out_of_sample_data_scaled, type = "response")

knCH_rf.5_full_out_of_sample_data <- cbind(filter(knCH_rf.5_full_out_of_sample_data, row %in% knCH_out_of_training_rows), knCH_rf.5.prob)

names(knCH_rf.5_full_out_of_sample_data)[65] <- "fits"
names(knCH_rf.5_full_out_of_sample_data)

knCH_rf.5_full_out_of_sample_data_reduced <- knCH_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

knCH_rf.5_mean_table <- knCH_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

knCH_rf.5_full_out_of_sample_data$type <- with(knCH_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

knCH_rf.5_full_out_of_sample_data$hit_label <- with(knCH_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

knCH_rf.5_plot1 <- ggplot(knCH_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knCH_rf.5_plot1

knCH_rf.5_plot2 <- ggplot(knCH_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knCH_rf.5_plot2

knCH_rf.5_plot3 <- ggplot(knCH_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knCH_rf.5_plot3

knCH_grid_plot_rf.5 <- grid.arrange(knCH_rf.5_plot1, knCH_rf.5_plot2, knCH_rf.5_plot3, ncol = 3)
knCH_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

knCH_test_rows <- knCH_test$row
knCH_validate_rows <- knCH_validate$row
knCH_pred_data_emp_1 <- ungroup(knCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knCH_test_rows)

knCH_pred_data_emp <- ungroup(knCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knCH_validate_rows) %>%
	rbind(knCH_pred_data_emp_1)

knCH_out_of_training_rows <- knCH_pred_data_emp$row

knCH_pred_data_emp <- ungroup(knCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knCH_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

knCH_pred_data_emp_scaled <- knCH_pred_data_emp

knCH_pred_data_emp_scaled$hit_speed <- (knCH_pred_data_emp_scaled$hit_speed - knCH_center_values[2]) / knCH_scale_values[2]

knCH_pred_data_emp_scaled$hit_angle <- (knCH_pred_data_emp_scaled$hit_angle - knCH_center_values[3]) / knCH_scale_values[3]

knCH_pred_prob_hit <- predict(knCH_rf.5, knCH_pred_data_emp_scaled, type = "prob")[,2]
knCH_pred_prob_hit_fits <- cbind(knCH_pred_data_emp, knCH_pred_prob_hit)

knCH_pred_prob_hit_fits[,c(1:2)] <- knCH_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

knCH_angle_speed_pred <- knCH_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = knCH_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nKN-CH Hit Probability\n") + theme_bp_grey()

knCH_angle_speed_pred
#####
kcCH$hit_distance_sc <- as.numeric(kcCH$hit_distance_sc, na.rm = TRUE)
kcCH$hit_angle <- as.numeric(kcCH$hit_angle, na.rm = TRUE)
kcCH$hit_speed <- as.numeric(kcCH$hit_speed, na.rm = TRUE)

kcCH$hit <- with(kcCH, ifelse(grepl("Single", kcCH$events), 1,
															ifelse(grepl("Double", kcCH$events), 1,
																		 ifelse(grepl("Triple", kcCH$events), 1, 
																		 			 ifelse(grepl("Home Run", kcCH$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

kcCH$fieldingTeam <- with(kcCH, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[kcCH$hit_distance_sc == "null"] = NA
#kcCH$hit_speed[kcCH$hit_speed == "null"] = NA
#kcCH$hit_angle[kcCH$hit_angle == "null"] = NA

# include row names for unique record identification

kcCH$row <- row.names(kcCH) %>% as.numeric()

# recode stand and home_team as factors

kcCH$stand <- as.factor(kcCH$stand)
kcCH$home_team <- as.factor(kcCH$home_team)


kcCH$game_date <- as.Date(kcCH$game_date)


# subset 

kcCH_working_data <- ungroup(kcCH) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(kcCH_working_data)
str(ungroup(kcCH))
table(kcCH_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

kcCH_working_data <- filter(kcCH_working_data, hc_x != 1, hc_y != 1)
head(kcCH_working_data)

# create training and test sets
# scaled data

set.seed(42)
kcCH_train <- sample_frac(kcCH_working_data, .15, replace = FALSE)
kcCH_split <- setdiff(kcCH_working_data, kcCH_train)
kcCH_test <- sample_frac(kcCH_split, .50, replace = FALSE)
kcCH_validate <- setdiff(kcCH_split, kcCH_test)

nrow(kcCH_train) + nrow(kcCH_test) + nrow(kcCH_validate) == nrow(kcCH_working_data)

with(kcCH_train, table(hit)) %>% prop.table()
with(kcCH_test, table(hit)) %>% prop.table()
with(kcCH_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(kcCH)
##as.numeric(kcCH$hit_distance_sc, kcCH$hit_speed, kcCH$hit_angle)

#kcCH_train$hit_distance_sc <- as.numeric(kcCH_train$hit_distance_sc)
#kcCH_train$hit_speed <- as.numeric(kcCH_train$hit_speed)
#kcCH_train$hit_angle <- as.numeric(kcCH_train$hit_angle)
#View(kcCH_train)
kcCH_scaled_data <- scale(kcCH_train[,c(1:5)])
kcCH_scale_values <- attr(kcCH_scaled_data, 'scaled:scale')
kcCH_scale_values
kcCH_center_values <- attr(kcCH_scaled_data, 'scaled:center')
kcCH_center_values
kcCH_train <- cbind(kcCH_scaled_data, select(kcCH_train, hit:row))

# save levels for factor variables
kcCH_levels_home_team <- levels(kcCH_train$home_team)
kcCH_levels_stand <- levels(kcCH_train$stand)
kcCH_levels_fieldingTeam <- levels(kcCH_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(kcCH_test)

kcCH_test$hit_distance_sc <- (kcCH_test$hit_distance_sc - kcCH_center_values[1]) / kcCH_scale_values[1]

kcCH_test$hit_speed <- (kcCH_test$hit_speed - kcCH_center_values[2]) / kcCH_scale_values[2]

kcCH_test$hit_angle <- (kcCH_test$hit_angle - kcCH_center_values[3]) / kcCH_scale_values[3]

kcCH_test$hc_x <- (kcCH_test$hc_x - kcCH_center_values[4]) / kcCH_scale_values[4]

kcCH_test$hc_y <- (kcCH_test$hc_y - kcCH_center_values[5]) / kcCH_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

kcCH_validate$hit_distance_sc <- (kcCH_validate$hit_distance_sc - kcCH_center_values[1]) / kcCH_scale_values[1]

kcCH_validate$hit_speed <- (kcCH_validate$hit_speed - kcCH_center_values[2]) / kcCH_scale_values[2]

kcCH_validate$hit_angle <- (kcCH_validate$hit_angle - kcCH_center_values[3]) / kcCH_scale_values[3]

kcCH_validate$hc_x <- (kcCH_validate$hc_x - kcCH_center_values[4]) / kcCH_scale_values[4]

kcCH_validate$hc_y <- (kcCH_validate$hc_y - kcCH_center_values[5]) / kcCH_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(kcCH_train)

set.seed(42)
kcCH_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(kcCH_train, -row), ntree = 501, importance = TRUE)

print(kcCH_rf.1)

plot(kcCH_rf.1)

varImpPlot(kcCH_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
kcCH_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(kcCH_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(kcCH_rf.5)

plot(kcCH_rf.5)

varImpPlot(kcCH_rf.5)

kcCH_predict_fit.rf.5 <- data.frame(fits = predict(kcCH_rf.5, kcCH_test, type = "prob")[,2], actuals = kcCH_test$hit)

kcCH_pred.rf.5 <- prediction(kcCH_predict_fit.rf.5$fits, kcCH_predict_fit.rf.5$actuals)

kcCH_roc.pred.rf.5 <- performance(kcCH_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(kcCH_roc.pred.rf.5)
abline(a = 0, b = 1)
kcCH_opt <- opt.cut(kcCH_roc.pred.rf.5, kcCH_pred.rf.5)
kcCH_opt
kcCH_opt <- kcCH_opt[3]
kcCH_predict_fit.rf.5$fits <- with(kcCH_predict_fit.rf.5, ifelse(fits > kcCH_opt, 1, 0)) 

str(kcCH_test)

#kcCH_test$fieldingTeam <- as.character(kcCH_test$fieldingTeam)
#kcCH_test$home_team <- as.character(kcCH_test$home_team)
#kcCH_test$hit <- as.logical(kcCH_test$hit)
#kcCH_test$stand <- as.logical(kcCH_test$stand)
str(kcCH_test)
kcCH_rf.5_confusion_test <- confusionMatrix(model = kcCH_rf.5, x = kcCH_test, y = kcCH_test$hit)
kcCH_rf.5_confusion_validate <- confusionMatrix(model = kcCH_rf.5, x = kcCH_validate, y = kcCH_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


kcCH_test_rows <- kcCH_test$row
kcCH_validate_rows <- kcCH_validate$row
kcCH_pred_data_emp_1 <- ungroup(kcCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcCH_test_rows)

kcCH_pred_data_emp <- ungroup(kcCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcCH_validate_rows) %>%
	rbind(kcCH_pred_data_emp_1)

kcCH_out_of_training_rows <- kcCH_pred_data_emp$row

kcCH_rf.5_full_out_of_sample_data <- ungroup(kcCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcCH_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



kcCH_rf.5_full_out_of_sample_data_scaled <- kcCH_rf.5_full_out_of_sample_data

kcCH_rf.5_full_out_of_sample_data_scaled$hit_speed <- (kcCH_rf.5_full_out_of_sample_data_scaled$hit_speed - kcCH_center_values[2]) / kcCH_scale_values[2]

kcCH_rf.5_full_out_of_sample_data_scaled$hit_angle <- (kcCH_rf.5_full_out_of_sample_data_scaled$hit_angle - kcCH_center_values[3]) / kcCH_scale_values[3]

kcCH_rf.5.prob <- predict(kcCH_rf.5, kcCH_rf.5_full_out_of_sample_data_scaled, type = "response")

kcCH_rf.5_full_out_of_sample_data <- cbind(filter(kcCH_rf.5_full_out_of_sample_data, row %in% kcCH_out_of_training_rows), kcCH_rf.5.prob)

names(kcCH_rf.5_full_out_of_sample_data)[65] <- "fits"
names(kcCH_rf.5_full_out_of_sample_data)

kcCH_rf.5_full_out_of_sample_data_reduced <- kcCH_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

kcCH_rf.5_mean_table <- kcCH_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

kcCH_rf.5_full_out_of_sample_data$type <- with(kcCH_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

kcCH_rf.5_full_out_of_sample_data$hit_label <- with(kcCH_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

kcCH_rf.5_plot1 <- ggplot(kcCH_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcCH_rf.5_plot1

kcCH_rf.5_plot2 <- ggplot(kcCH_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcCH_rf.5_plot2

kcCH_rf.5_plot3 <- ggplot(kcCH_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcCH_rf.5_plot3

kcCH_grid_plot_rf.5 <- grid.arrange(kcCH_rf.5_plot1, kcCH_rf.5_plot2, kcCH_rf.5_plot3, ncol = 3)
kcCH_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

kcCH_test_rows <- kcCH_test$row
kcCH_validate_rows <- kcCH_validate$row
kcCH_pred_data_emp_1 <- ungroup(kcCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcCH_test_rows)

kcCH_pred_data_emp <- ungroup(kcCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcCH_validate_rows) %>%
	rbind(kcCH_pred_data_emp_1)

kcCH_out_of_training_rows <- kcCH_pred_data_emp$row

kcCH_pred_data_emp <- ungroup(kcCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcCH_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

kcCH_pred_data_emp_scaled <- kcCH_pred_data_emp

kcCH_pred_data_emp_scaled$hit_speed <- (kcCH_pred_data_emp_scaled$hit_speed - kcCH_center_values[2]) / kcCH_scale_values[2]

kcCH_pred_data_emp_scaled$hit_angle <- (kcCH_pred_data_emp_scaled$hit_angle - kcCH_center_values[3]) / kcCH_scale_values[3]

kcCH_pred_prob_hit <- predict(kcCH_rf.5, kcCH_pred_data_emp_scaled, type = "prob")[,2]
kcCH_pred_prob_hit_fits <- cbind(kcCH_pred_data_emp, kcCH_pred_prob_hit)

kcCH_pred_prob_hit_fits[,c(1:2)] <- kcCH_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

kcCH_angle_speed_pred <- kcCH_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = kcCH_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nKC-CH Hit Probability\n") + theme_bp_grey()

kcCH_angle_speed_pred
#####
fsCH$hit_distance_sc <- as.numeric(fsCH$hit_distance_sc, na.rm = TRUE)
fsCH$hit_angle <- as.numeric(fsCH$hit_angle, na.rm = TRUE)
fsCH$hit_speed <- as.numeric(fsCH$hit_speed, na.rm = TRUE)

fsCH$hit <- with(fsCH, ifelse(grepl("Single", fsCH$events), 1,
															ifelse(grepl("Double", fsCH$events), 1,
																		 ifelse(grepl("Triple", fsCH$events), 1, 
																		 			 ifelse(grepl("Home Run", fsCH$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

fsCH$fieldingTeam <- with(fsCH, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[fsCH$hit_distance_sc == "null"] = NA
#fsCH$hit_speed[fsCH$hit_speed == "null"] = NA
#fsCH$hit_angle[fsCH$hit_angle == "null"] = NA

# include row names for unique record identification

fsCH$row <- row.names(fsCH) %>% as.numeric()

# recode stand and home_team as factors

fsCH$stand <- as.factor(fsCH$stand)
fsCH$home_team <- as.factor(fsCH$home_team)


fsCH$game_date <- as.Date(fsCH$game_date)


# subset 

fsCH_working_data <- ungroup(fsCH) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(fsCH_working_data)
str(ungroup(fsCH))
table(fsCH_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

fsCH_working_data <- filter(fsCH_working_data, hc_x != 1, hc_y != 1)
head(fsCH_working_data)

# create training and test sets
# scaled data

set.seed(42)
fsCH_train <- sample_frac(fsCH_working_data, .15, replace = FALSE)
fsCH_split <- setdiff(fsCH_working_data, fsCH_train)
fsCH_test <- sample_frac(fsCH_split, .50, replace = FALSE)
fsCH_validate <- setdiff(fsCH_split, fsCH_test)

nrow(fsCH_train) + nrow(fsCH_test) + nrow(fsCH_validate) == nrow(fsCH_working_data)

with(fsCH_train, table(hit)) %>% prop.table()
with(fsCH_test, table(hit)) %>% prop.table()
with(fsCH_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(fsCH)
##as.numeric(fsCH$hit_distance_sc, fsCH$hit_speed, fsCH$hit_angle)

#fsCH_train$hit_distance_sc <- as.numeric(fsCH_train$hit_distance_sc)
#fsCH_train$hit_speed <- as.numeric(fsCH_train$hit_speed)
#fsCH_train$hit_angle <- as.numeric(fsCH_train$hit_angle)
#View(fsCH_train)
fsCH_scaled_data <- scale(fsCH_train[,c(1:5)])
fsCH_scale_values <- attr(fsCH_scaled_data, 'scaled:scale')
fsCH_scale_values
fsCH_center_values <- attr(fsCH_scaled_data, 'scaled:center')
fsCH_center_values
fsCH_train <- cbind(fsCH_scaled_data, select(fsCH_train, hit:row))

# save levels for factor variables
fsCH_levels_home_team <- levels(fsCH_train$home_team)
fsCH_levels_stand <- levels(fsCH_train$stand)
fsCH_levels_fieldingTeam <- levels(fsCH_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(fsCH_test)

fsCH_test$hit_distance_sc <- (fsCH_test$hit_distance_sc - fsCH_center_values[1]) / fsCH_scale_values[1]

fsCH_test$hit_speed <- (fsCH_test$hit_speed - fsCH_center_values[2]) / fsCH_scale_values[2]

fsCH_test$hit_angle <- (fsCH_test$hit_angle - fsCH_center_values[3]) / fsCH_scale_values[3]

fsCH_test$hc_x <- (fsCH_test$hc_x - fsCH_center_values[4]) / fsCH_scale_values[4]

fsCH_test$hc_y <- (fsCH_test$hc_y - fsCH_center_values[5]) / fsCH_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

fsCH_validate$hit_distance_sc <- (fsCH_validate$hit_distance_sc - fsCH_center_values[1]) / fsCH_scale_values[1]

fsCH_validate$hit_speed <- (fsCH_validate$hit_speed - fsCH_center_values[2]) / fsCH_scale_values[2]

fsCH_validate$hit_angle <- (fsCH_validate$hit_angle - fsCH_center_values[3]) / fsCH_scale_values[3]

fsCH_validate$hc_x <- (fsCH_validate$hc_x - fsCH_center_values[4]) / fsCH_scale_values[4]

fsCH_validate$hc_y <- (fsCH_validate$hc_y - fsCH_center_values[5]) / fsCH_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(fsCH_train)

set.seed(42)
fsCH_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(fsCH_train, -row), ntree = 501, importance = TRUE)

print(fsCH_rf.1)

plot(fsCH_rf.1)

varImpPlot(fsCH_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
fsCH_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(fsCH_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(fsCH_rf.5)

plot(fsCH_rf.5)

varImpPlot(fsCH_rf.5)

fsCH_predict_fit.rf.5 <- data.frame(fits = predict(fsCH_rf.5, fsCH_test, type = "prob")[,2], actuals = fsCH_test$hit)

fsCH_pred.rf.5 <- prediction(fsCH_predict_fit.rf.5$fits, fsCH_predict_fit.rf.5$actuals)

fsCH_roc.pred.rf.5 <- performance(fsCH_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(fsCH_roc.pred.rf.5)
abline(a = 0, b = 1)
fsCH_opt <- opt.cut(fsCH_roc.pred.rf.5, fsCH_pred.rf.5)
fsCH_opt
fsCH_opt <- fsCH_opt[3]
fsCH_predict_fit.rf.5$fits <- with(fsCH_predict_fit.rf.5, ifelse(fits > fsCH_opt, 1, 0)) 

str(fsCH_test)

#fsCH_test$fieldingTeam <- as.character(fsCH_test$fieldingTeam)
#fsCH_test$home_team <- as.character(fsCH_test$home_team)
#fsCH_test$hit <- as.logical(fsCH_test$hit)
#fsCH_test$stand <- as.logical(fsCH_test$stand)
str(fsCH_test)
fsCH_rf.5_confusion_test <- confusionMatrix(model = fsCH_rf.5, x = fsCH_test, y = fsCH_test$hit)
fsCH_rf.5_confusion_validate <- confusionMatrix(model = fsCH_rf.5, x = fsCH_validate, y = fsCH_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


fsCH_test_rows <- fsCH_test$row
fsCH_validate_rows <- fsCH_validate$row
fsCH_pred_data_emp_1 <- ungroup(fsCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsCH_test_rows)

fsCH_pred_data_emp <- ungroup(fsCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsCH_validate_rows) %>%
	rbind(fsCH_pred_data_emp_1)

fsCH_out_of_training_rows <- fsCH_pred_data_emp$row

fsCH_rf.5_full_out_of_sample_data <- ungroup(fsCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsCH_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



fsCH_rf.5_full_out_of_sample_data_scaled <- fsCH_rf.5_full_out_of_sample_data

fsCH_rf.5_full_out_of_sample_data_scaled$hit_speed <- (fsCH_rf.5_full_out_of_sample_data_scaled$hit_speed - fsCH_center_values[2]) / fsCH_scale_values[2]

fsCH_rf.5_full_out_of_sample_data_scaled$hit_angle <- (fsCH_rf.5_full_out_of_sample_data_scaled$hit_angle - fsCH_center_values[3]) / fsCH_scale_values[3]

fsCH_rf.5.prob <- predict(fsCH_rf.5, fsCH_rf.5_full_out_of_sample_data_scaled, type = "response")

fsCH_rf.5_full_out_of_sample_data <- cbind(filter(fsCH_rf.5_full_out_of_sample_data, row %in% fsCH_out_of_training_rows), fsCH_rf.5.prob)

names(fsCH_rf.5_full_out_of_sample_data)[65] <- "fits"
names(fsCH_rf.5_full_out_of_sample_data)

fsCH_rf.5_full_out_of_sample_data_reduced <- fsCH_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

fsCH_rf.5_mean_table <- fsCH_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

fsCH_rf.5_full_out_of_sample_data$type <- with(fsCH_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

fsCH_rf.5_full_out_of_sample_data$hit_label <- with(fsCH_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

fsCH_rf.5_plot1 <- ggplot(fsCH_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsCH_rf.5_plot1

fsCH_rf.5_plot2 <- ggplot(fsCH_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsCH_rf.5_plot2

fsCH_rf.5_plot3 <- ggplot(fsCH_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsCH_rf.5_plot3

fsCH_grid_plot_rf.5 <- grid.arrange(fsCH_rf.5_plot1, fsCH_rf.5_plot2, fsCH_rf.5_plot3, ncol = 3)
fsCH_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

fsCH_test_rows <- fsCH_test$row
fsCH_validate_rows <- fsCH_validate$row
fsCH_pred_data_emp_1 <- ungroup(fsCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsCH_test_rows)

fsCH_pred_data_emp <- ungroup(fsCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsCH_validate_rows) %>%
	rbind(fsCH_pred_data_emp_1)

fsCH_out_of_training_rows <- fsCH_pred_data_emp$row

fsCH_pred_data_emp <- ungroup(fsCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsCH_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

fsCH_pred_data_emp_scaled <- fsCH_pred_data_emp

fsCH_pred_data_emp_scaled$hit_speed <- (fsCH_pred_data_emp_scaled$hit_speed - fsCH_center_values[2]) / fsCH_scale_values[2]

fsCH_pred_data_emp_scaled$hit_angle <- (fsCH_pred_data_emp_scaled$hit_angle - fsCH_center_values[3]) / fsCH_scale_values[3]

fsCH_pred_prob_hit <- predict(fsCH_rf.5, fsCH_pred_data_emp_scaled, type = "prob")[,2]
fsCH_pred_prob_hit_fits <- cbind(fsCH_pred_data_emp, fsCH_pred_prob_hit)

fsCH_pred_prob_hit_fits[,c(1:2)] <- fsCH_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

fsCH_angle_speed_pred <- fsCH_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = fsCH_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFS-CH Hit Probability\n") + theme_bp_grey()

fsCH_angle_speed_pred
#####
fcCH$hit_distance_sc <- as.numeric(fcCH$hit_distance_sc, na.rm = TRUE)
fcCH$hit_angle <- as.numeric(fcCH$hit_angle, na.rm = TRUE)
fcCH$hit_speed <- as.numeric(fcCH$hit_speed, na.rm = TRUE)

fcCH$hit <- with(fcCH, ifelse(grepl("Single", fcCH$events), 1,
															ifelse(grepl("Double", fcCH$events), 1,
																		 ifelse(grepl("Triple", fcCH$events), 1, 
																		 			 ifelse(grepl("Home Run", fcCH$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

fcCH$fieldingTeam <- with(fcCH, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[fcCH$hit_distance_sc == "null"] = NA
#fcCH$hit_speed[fcCH$hit_speed == "null"] = NA
#fcCH$hit_angle[fcCH$hit_angle == "null"] = NA

# include row names for unique record identification

fcCH$row <- row.names(fcCH) %>% as.numeric()

# recode stand and home_team as factors

fcCH$stand <- as.factor(fcCH$stand)
fcCH$home_team <- as.factor(fcCH$home_team)


fcCH$game_date <- as.Date(fcCH$game_date)


# subset 

fcCH_working_data <- ungroup(fcCH) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(fcCH_working_data)
str(ungroup(fcCH))
table(fcCH_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

fcCH_working_data <- filter(fcCH_working_data, hc_x != 1, hc_y != 1)
head(fcCH_working_data)

# create training and test sets
# scaled data

set.seed(42)
fcCH_train <- sample_frac(fcCH_working_data, .15, replace = FALSE)
fcCH_split <- setdiff(fcCH_working_data, fcCH_train)
fcCH_test <- sample_frac(fcCH_split, .50, replace = FALSE)
fcCH_validate <- setdiff(fcCH_split, fcCH_test)

nrow(fcCH_train) + nrow(fcCH_test) + nrow(fcCH_validate) == nrow(fcCH_working_data)

with(fcCH_train, table(hit)) %>% prop.table()
with(fcCH_test, table(hit)) %>% prop.table()
with(fcCH_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(fcCH)
##as.numeric(fcCH$hit_distance_sc, fcCH$hit_speed, fcCH$hit_angle)

#fcCH_train$hit_distance_sc <- as.numeric(fcCH_train$hit_distance_sc)
#fcCH_train$hit_speed <- as.numeric(fcCH_train$hit_speed)
#fcCH_train$hit_angle <- as.numeric(fcCH_train$hit_angle)
#View(fcCH_train)
fcCH_scaled_data <- scale(fcCH_train[,c(1:5)])
fcCH_scale_values <- attr(fcCH_scaled_data, 'scaled:scale')
fcCH_scale_values
fcCH_center_values <- attr(fcCH_scaled_data, 'scaled:center')
fcCH_center_values
fcCH_train <- cbind(fcCH_scaled_data, select(fcCH_train, hit:row))

# save levels for factor variables
fcCH_levels_home_team <- levels(fcCH_train$home_team)
fcCH_levels_stand <- levels(fcCH_train$stand)
fcCH_levels_fieldingTeam <- levels(fcCH_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(fcCH_test)

fcCH_test$hit_distance_sc <- (fcCH_test$hit_distance_sc - fcCH_center_values[1]) / fcCH_scale_values[1]

fcCH_test$hit_speed <- (fcCH_test$hit_speed - fcCH_center_values[2]) / fcCH_scale_values[2]

fcCH_test$hit_angle <- (fcCH_test$hit_angle - fcCH_center_values[3]) / fcCH_scale_values[3]

fcCH_test$hc_x <- (fcCH_test$hc_x - fcCH_center_values[4]) / fcCH_scale_values[4]

fcCH_test$hc_y <- (fcCH_test$hc_y - fcCH_center_values[5]) / fcCH_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

fcCH_validate$hit_distance_sc <- (fcCH_validate$hit_distance_sc - fcCH_center_values[1]) / fcCH_scale_values[1]

fcCH_validate$hit_speed <- (fcCH_validate$hit_speed - fcCH_center_values[2]) / fcCH_scale_values[2]

fcCH_validate$hit_angle <- (fcCH_validate$hit_angle - fcCH_center_values[3]) / fcCH_scale_values[3]

fcCH_validate$hc_x <- (fcCH_validate$hc_x - fcCH_center_values[4]) / fcCH_scale_values[4]

fcCH_validate$hc_y <- (fcCH_validate$hc_y - fcCH_center_values[5]) / fcCH_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(fcCH_train)

set.seed(42)
fcCH_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(fcCH_train, -row), ntree = 501, importance = TRUE)

print(fcCH_rf.1)

plot(fcCH_rf.1)

varImpPlot(fcCH_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
fcCH_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(fcCH_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(fcCH_rf.5)

plot(fcCH_rf.5)

varImpPlot(fcCH_rf.5)

fcCH_predict_fit.rf.5 <- data.frame(fits = predict(fcCH_rf.5, fcCH_test, type = "prob")[,2], actuals = fcCH_test$hit)

fcCH_pred.rf.5 <- prediction(fcCH_predict_fit.rf.5$fits, fcCH_predict_fit.rf.5$actuals)

fcCH_roc.pred.rf.5 <- performance(fcCH_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(fcCH_roc.pred.rf.5)
abline(a = 0, b = 1)
fcCH_opt <- opt.cut(fcCH_roc.pred.rf.5, fcCH_pred.rf.5)
fcCH_opt
fcCH_opt <- fcCH_opt[3]
fcCH_predict_fit.rf.5$fits <- with(fcCH_predict_fit.rf.5, ifelse(fits > fcCH_opt, 1, 0)) 

str(fcCH_test)

#fcCH_test$fieldingTeam <- as.character(fcCH_test$fieldingTeam)
#fcCH_test$home_team <- as.character(fcCH_test$home_team)
#fcCH_test$hit <- as.logical(fcCH_test$hit)
#fcCH_test$stand <- as.logical(fcCH_test$stand)
str(fcCH_test)
fcCH_rf.5_confusion_test <- confusionMatrix(model = fcCH_rf.5, x = fcCH_test, y = fcCH_test$hit)
fcCH_rf.5_confusion_validate <- confusionMatrix(model = fcCH_rf.5, x = fcCH_validate, y = fcCH_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


fcCH_test_rows <- fcCH_test$row
fcCH_validate_rows <- fcCH_validate$row
fcCH_pred_data_emp_1 <- ungroup(fcCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcCH_test_rows)

fcCH_pred_data_emp <- ungroup(fcCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcCH_validate_rows) %>%
	rbind(fcCH_pred_data_emp_1)

fcCH_out_of_training_rows <- fcCH_pred_data_emp$row

fcCH_rf.5_full_out_of_sample_data <- ungroup(fcCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcCH_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



fcCH_rf.5_full_out_of_sample_data_scaled <- fcCH_rf.5_full_out_of_sample_data

fcCH_rf.5_full_out_of_sample_data_scaled$hit_speed <- (fcCH_rf.5_full_out_of_sample_data_scaled$hit_speed - fcCH_center_values[2]) / fcCH_scale_values[2]

fcCH_rf.5_full_out_of_sample_data_scaled$hit_angle <- (fcCH_rf.5_full_out_of_sample_data_scaled$hit_angle - fcCH_center_values[3]) / fcCH_scale_values[3]

fcCH_rf.5.prob <- predict(fcCH_rf.5, fcCH_rf.5_full_out_of_sample_data_scaled, type = "response")

fcCH_rf.5_full_out_of_sample_data <- cbind(filter(fcCH_rf.5_full_out_of_sample_data, row %in% fcCH_out_of_training_rows), fcCH_rf.5.prob)

names(fcCH_rf.5_full_out_of_sample_data)[65] <- "fits"
names(fcCH_rf.5_full_out_of_sample_data)

fcCH_rf.5_full_out_of_sample_data_reduced <- fcCH_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

fcCH_rf.5_mean_table <- fcCH_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

fcCH_rf.5_full_out_of_sample_data$type <- with(fcCH_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

fcCH_rf.5_full_out_of_sample_data$hit_label <- with(fcCH_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

fcCH_rf.5_plot1 <- ggplot(fcCH_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcCH_rf.5_plot1

fcCH_rf.5_plot2 <- ggplot(fcCH_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcCH_rf.5_plot2

fcCH_rf.5_plot3 <- ggplot(fcCH_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcCH_rf.5_plot3

fcCH_grid_plot_rf.5 <- grid.arrange(fcCH_rf.5_plot1, fcCH_rf.5_plot2, fcCH_rf.5_plot3, ncol = 3)
fcCH_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

fcCH_test_rows <- fcCH_test$row
fcCH_validate_rows <- fcCH_validate$row
fcCH_pred_data_emp_1 <- ungroup(fcCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcCH_test_rows)

fcCH_pred_data_emp <- ungroup(fcCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcCH_validate_rows) %>%
	rbind(fcCH_pred_data_emp_1)

fcCH_out_of_training_rows <- fcCH_pred_data_emp$row

fcCH_pred_data_emp <- ungroup(fcCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcCH_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

fcCH_pred_data_emp_scaled <- fcCH_pred_data_emp

fcCH_pred_data_emp_scaled$hit_speed <- (fcCH_pred_data_emp_scaled$hit_speed - fcCH_center_values[2]) / fcCH_scale_values[2]

fcCH_pred_data_emp_scaled$hit_angle <- (fcCH_pred_data_emp_scaled$hit_angle - fcCH_center_values[3]) / fcCH_scale_values[3]

fcCH_pred_prob_hit <- predict(fcCH_rf.5, fcCH_pred_data_emp_scaled, type = "prob")[,2]
fcCH_pred_prob_hit_fits <- cbind(fcCH_pred_data_emp, fcCH_pred_prob_hit)

fcCH_pred_prob_hit_fits[,c(1:2)] <- fcCH_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

fcCH_angle_speed_pred <- fcCH_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = fcCH_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFC-CH Hit Probability\n") + theme_bp_grey()

fcCH_angle_speed_pred
#####
ftCH$hit_distance_sc <- as.numeric(ftCH$hit_distance_sc, na.rm = TRUE)
ftCH$hit_angle <- as.numeric(ftCH$hit_angle, na.rm = TRUE)
ftCH$hit_speed <- as.numeric(ftCH$hit_speed, na.rm = TRUE)

ftCH$hit <- with(ftCH, ifelse(grepl("Single", ftCH$events), 1,
															ifelse(grepl("Double", ftCH$events), 1,
																		 ifelse(grepl("Triple", ftCH$events), 1, 
																		 			 ifelse(grepl("Home Run", ftCH$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

ftCH$fieldingTeam <- with(ftCH, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[ftCH$hit_distance_sc == "null"] = NA
#ftCH$hit_speed[ftCH$hit_speed == "null"] = NA
#ftCH$hit_angle[ftCH$hit_angle == "null"] = NA

# include row names for unique record identification

ftCH$row <- row.names(ftCH) %>% as.numeric()

# recode stand and home_team as factors

ftCH$stand <- as.factor(ftCH$stand)
ftCH$home_team <- as.factor(ftCH$home_team)


ftCH$game_date <- as.Date(ftCH$game_date)


# subset 

ftCH_working_data <- ungroup(ftCH) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(ftCH_working_data)
str(ungroup(ftCH))
table(ftCH_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

ftCH_working_data <- filter(ftCH_working_data, hc_x != 1, hc_y != 1)
head(ftCH_working_data)

# create training and test sets
# scaled data

set.seed(42)
ftCH_train <- sample_frac(ftCH_working_data, .15, replace = FALSE)
ftCH_split <- setdiff(ftCH_working_data, ftCH_train)
ftCH_test <- sample_frac(ftCH_split, .50, replace = FALSE)
ftCH_validate <- setdiff(ftCH_split, ftCH_test)

nrow(ftCH_train) + nrow(ftCH_test) + nrow(ftCH_validate) == nrow(ftCH_working_data)

with(ftCH_train, table(hit)) %>% prop.table()
with(ftCH_test, table(hit)) %>% prop.table()
with(ftCH_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(ftCH)
##as.numeric(ftCH$hit_distance_sc, ftCH$hit_speed, ftCH$hit_angle)

#ftCH_train$hit_distance_sc <- as.numeric(ftCH_train$hit_distance_sc)
#ftCH_train$hit_speed <- as.numeric(ftCH_train$hit_speed)
#ftCH_train$hit_angle <- as.numeric(ftCH_train$hit_angle)
#View(ftCH_train)
ftCH_scaled_data <- scale(ftCH_train[,c(1:5)])
ftCH_scale_values <- attr(ftCH_scaled_data, 'scaled:scale')
ftCH_scale_values
ftCH_center_values <- attr(ftCH_scaled_data, 'scaled:center')
ftCH_center_values
ftCH_train <- cbind(ftCH_scaled_data, select(ftCH_train, hit:row))

# save levels for factor variables
ftCH_levels_home_team <- levels(ftCH_train$home_team)
ftCH_levels_stand <- levels(ftCH_train$stand)
ftCH_levels_fieldingTeam <- levels(ftCH_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(ftCH_test)

ftCH_test$hit_distance_sc <- (ftCH_test$hit_distance_sc - ftCH_center_values[1]) / ftCH_scale_values[1]

ftCH_test$hit_speed <- (ftCH_test$hit_speed - ftCH_center_values[2]) / ftCH_scale_values[2]

ftCH_test$hit_angle <- (ftCH_test$hit_angle - ftCH_center_values[3]) / ftCH_scale_values[3]

ftCH_test$hc_x <- (ftCH_test$hc_x - ftCH_center_values[4]) / ftCH_scale_values[4]

ftCH_test$hc_y <- (ftCH_test$hc_y - ftCH_center_values[5]) / ftCH_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

ftCH_validate$hit_distance_sc <- (ftCH_validate$hit_distance_sc - ftCH_center_values[1]) / ftCH_scale_values[1]

ftCH_validate$hit_speed <- (ftCH_validate$hit_speed - ftCH_center_values[2]) / ftCH_scale_values[2]

ftCH_validate$hit_angle <- (ftCH_validate$hit_angle - ftCH_center_values[3]) / ftCH_scale_values[3]

ftCH_validate$hc_x <- (ftCH_validate$hc_x - ftCH_center_values[4]) / ftCH_scale_values[4]

ftCH_validate$hc_y <- (ftCH_validate$hc_y - ftCH_center_values[5]) / ftCH_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(ftCH_train)

set.seed(42)
ftCH_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(ftCH_train, -row), ntree = 501, importance = TRUE)

print(ftCH_rf.1)

plot(ftCH_rf.1)

varImpPlot(ftCH_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
ftCH_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(ftCH_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(ftCH_rf.5)

plot(ftCH_rf.5)

varImpPlot(ftCH_rf.5)

ftCH_predict_fit.rf.5 <- data.frame(fits = predict(ftCH_rf.5, ftCH_test, type = "prob")[,2], actuals = ftCH_test$hit)

ftCH_pred.rf.5 <- prediction(ftCH_predict_fit.rf.5$fits, ftCH_predict_fit.rf.5$actuals)

ftCH_roc.pred.rf.5 <- performance(ftCH_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(ftCH_roc.pred.rf.5)
abline(a = 0, b = 1)
ftCH_opt <- opt.cut(ftCH_roc.pred.rf.5, ftCH_pred.rf.5)
ftCH_opt
ftCH_opt <- ftCH_opt[3]
ftCH_predict_fit.rf.5$fits <- with(ftCH_predict_fit.rf.5, ifelse(fits > ftCH_opt, 1, 0)) 

str(ftCH_test)

#ftCH_test$fieldingTeam <- as.character(ftCH_test$fieldingTeam)
#ftCH_test$home_team <- as.character(ftCH_test$home_team)
#ftCH_test$hit <- as.logical(ftCH_test$hit)
#ftCH_test$stand <- as.logical(ftCH_test$stand)
str(ftCH_test)
ftCH_rf.5_confusion_test <- confusionMatrix(model = ftCH_rf.5, x = ftCH_test, y = ftCH_test$hit)
ftCH_rf.5_confusion_validate <- confusionMatrix(model = ftCH_rf.5, x = ftCH_validate, y = ftCH_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


ftCH_test_rows <- ftCH_test$row
ftCH_validate_rows <- ftCH_validate$row
ftCH_pred_data_emp_1 <- ungroup(ftCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftCH_test_rows)

ftCH_pred_data_emp <- ungroup(ftCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftCH_validate_rows) %>%
	rbind(ftCH_pred_data_emp_1)

ftCH_out_of_training_rows <- ftCH_pred_data_emp$row

ftCH_rf.5_full_out_of_sample_data <- ungroup(ftCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftCH_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



ftCH_rf.5_full_out_of_sample_data_scaled <- ftCH_rf.5_full_out_of_sample_data

ftCH_rf.5_full_out_of_sample_data_scaled$hit_speed <- (ftCH_rf.5_full_out_of_sample_data_scaled$hit_speed - ftCH_center_values[2]) / ftCH_scale_values[2]

ftCH_rf.5_full_out_of_sample_data_scaled$hit_angle <- (ftCH_rf.5_full_out_of_sample_data_scaled$hit_angle - ftCH_center_values[3]) / ftCH_scale_values[3]

ftCH_rf.5.prob <- predict(ftCH_rf.5, ftCH_rf.5_full_out_of_sample_data_scaled, type = "response")

ftCH_rf.5_full_out_of_sample_data <- cbind(filter(ftCH_rf.5_full_out_of_sample_data, row %in% ftCH_out_of_training_rows), ftCH_rf.5.prob)

names(ftCH_rf.5_full_out_of_sample_data)[65] <- "fits"
names(ftCH_rf.5_full_out_of_sample_data)

ftCH_rf.5_full_out_of_sample_data_reduced <- ftCH_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

ftCH_rf.5_mean_table <- ftCH_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

ftCH_rf.5_full_out_of_sample_data$type <- with(ftCH_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

ftCH_rf.5_full_out_of_sample_data$hit_label <- with(ftCH_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

ftCH_rf.5_plot1 <- ggplot(ftCH_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftCH_rf.5_plot1

ftCH_rf.5_plot2 <- ggplot(ftCH_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftCH_rf.5_plot2

ftCH_rf.5_plot3 <- ggplot(ftCH_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftCH_rf.5_plot3

ftCH_grid_plot_rf.5 <- grid.arrange(ftCH_rf.5_plot1, ftCH_rf.5_plot2, ftCH_rf.5_plot3, ncol = 3)
ftCH_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

ftCH_test_rows <- ftCH_test$row
ftCH_validate_rows <- ftCH_validate$row
ftCH_pred_data_emp_1 <- ungroup(ftCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftCH_test_rows)

ftCH_pred_data_emp <- ungroup(ftCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftCH_validate_rows) %>%
	rbind(ftCH_pred_data_emp_1)

ftCH_out_of_training_rows <- ftCH_pred_data_emp$row

ftCH_pred_data_emp <- ungroup(ftCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftCH_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

ftCH_pred_data_emp_scaled <- ftCH_pred_data_emp

ftCH_pred_data_emp_scaled$hit_speed <- (ftCH_pred_data_emp_scaled$hit_speed - ftCH_center_values[2]) / ftCH_scale_values[2]

ftCH_pred_data_emp_scaled$hit_angle <- (ftCH_pred_data_emp_scaled$hit_angle - ftCH_center_values[3]) / ftCH_scale_values[3]

ftCH_pred_prob_hit <- predict(ftCH_rf.5, ftCH_pred_data_emp_scaled, type = "prob")[,2]
ftCH_pred_prob_hit_fits <- cbind(ftCH_pred_data_emp, ftCH_pred_prob_hit)

ftCH_pred_prob_hit_fits[,c(1:2)] <- ftCH_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

ftCH_angle_speed_pred <- ftCH_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = ftCH_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFT-CH Hit Probability\n") + theme_bp_grey()

ftCH_angle_speed_pred
#####
cuCH$hit_distance_sc <- as.numeric(cuCH$hit_distance_sc, na.rm = TRUE)
cuCH$hit_angle <- as.numeric(cuCH$hit_angle, na.rm = TRUE)
cuCH$hit_speed <- as.numeric(cuCH$hit_speed, na.rm = TRUE)

cuCH$hit <- with(cuCH, ifelse(grepl("Single", cuCH$events), 1,
															ifelse(grepl("Double", cuCH$events), 1,
																		 ifelse(grepl("Triple", cuCH$events), 1, 
																		 			 ifelse(grepl("Home Run", cuCH$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

cuCH$fieldingTeam <- with(cuCH, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[cuCH$hit_distance_sc == "null"] = NA
#cuCH$hit_speed[cuCH$hit_speed == "null"] = NA
#cuCH$hit_angle[cuCH$hit_angle == "null"] = NA

# include row names for unique record identification

cuCH$row <- row.names(cuCH) %>% as.numeric()

# recode stand and home_team as factors

cuCH$stand <- as.factor(cuCH$stand)
cuCH$home_team <- as.factor(cuCH$home_team)


cuCH$game_date <- as.Date(cuCH$game_date)


# subset 

cuCH_working_data <- ungroup(cuCH) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(cuCH_working_data)
str(ungroup(cuCH))
table(cuCH_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

cuCH_working_data <- filter(cuCH_working_data, hc_x != 1, hc_y != 1)
head(cuCH_working_data)

# create training and test sets
# scaled data

set.seed(42)
cuCH_train <- sample_frac(cuCH_working_data, .15, replace = FALSE)
cuCH_split <- setdiff(cuCH_working_data, cuCH_train)
cuCH_test <- sample_frac(cuCH_split, .50, replace = FALSE)
cuCH_validate <- setdiff(cuCH_split, cuCH_test)

nrow(cuCH_train) + nrow(cuCH_test) + nrow(cuCH_validate) == nrow(cuCH_working_data)

with(cuCH_train, table(hit)) %>% prop.table()
with(cuCH_test, table(hit)) %>% prop.table()
with(cuCH_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(cuCH)
##as.numeric(cuCH$hit_distance_sc, cuCH$hit_speed, cuCH$hit_angle)

#cuCH_train$hit_distance_sc <- as.numeric(cuCH_train$hit_distance_sc)
#cuCH_train$hit_speed <- as.numeric(cuCH_train$hit_speed)
#cuCH_train$hit_angle <- as.numeric(cuCH_train$hit_angle)
#View(cuCH_train)
cuCH_scaled_data <- scale(cuCH_train[,c(1:5)])
cuCH_scale_values <- attr(cuCH_scaled_data, 'scaled:scale')
cuCH_scale_values
cuCH_center_values <- attr(cuCH_scaled_data, 'scaled:center')
cuCH_center_values
cuCH_train <- cbind(cuCH_scaled_data, select(cuCH_train, hit:row))

# save levels for factor variables
cuCH_levels_home_team <- levels(cuCH_train$home_team)
cuCH_levels_stand <- levels(cuCH_train$stand)
cuCH_levels_fieldingTeam <- levels(cuCH_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(cuCH_test)

cuCH_test$hit_distance_sc <- (cuCH_test$hit_distance_sc - cuCH_center_values[1]) / cuCH_scale_values[1]

cuCH_test$hit_speed <- (cuCH_test$hit_speed - cuCH_center_values[2]) / cuCH_scale_values[2]

cuCH_test$hit_angle <- (cuCH_test$hit_angle - cuCH_center_values[3]) / cuCH_scale_values[3]

cuCH_test$hc_x <- (cuCH_test$hc_x - cuCH_center_values[4]) / cuCH_scale_values[4]

cuCH_test$hc_y <- (cuCH_test$hc_y - cuCH_center_values[5]) / cuCH_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

cuCH_validate$hit_distance_sc <- (cuCH_validate$hit_distance_sc - cuCH_center_values[1]) / cuCH_scale_values[1]

cuCH_validate$hit_speed <- (cuCH_validate$hit_speed - cuCH_center_values[2]) / cuCH_scale_values[2]

cuCH_validate$hit_angle <- (cuCH_validate$hit_angle - cuCH_center_values[3]) / cuCH_scale_values[3]

cuCH_validate$hc_x <- (cuCH_validate$hc_x - cuCH_center_values[4]) / cuCH_scale_values[4]

cuCH_validate$hc_y <- (cuCH_validate$hc_y - cuCH_center_values[5]) / cuCH_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(cuCH_train)

set.seed(42)
cuCH_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(cuCH_train, -row), ntree = 501, importance = TRUE)

print(cuCH_rf.1)

plot(cuCH_rf.1)

varImpPlot(cuCH_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
cuCH_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(cuCH_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(cuCH_rf.5)

plot(cuCH_rf.5)

varImpPlot(cuCH_rf.5)

cuCH_predict_fit.rf.5 <- data.frame(fits = predict(cuCH_rf.5, cuCH_test, type = "prob")[,2], actuals = cuCH_test$hit)

cuCH_pred.rf.5 <- prediction(cuCH_predict_fit.rf.5$fits, cuCH_predict_fit.rf.5$actuals)

cuCH_roc.pred.rf.5 <- performance(cuCH_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(cuCH_roc.pred.rf.5)
abline(a = 0, b = 1)
cuCH_opt <- opt.cut(cuCH_roc.pred.rf.5, cuCH_pred.rf.5)
cuCH_opt
cuCH_opt <- cuCH_opt[3]
cuCH_predict_fit.rf.5$fits <- with(cuCH_predict_fit.rf.5, ifelse(fits > cuCH_opt, 1, 0)) 

str(cuCH_test)

#cuCH_test$fieldingTeam <- as.character(cuCH_test$fieldingTeam)
#cuCH_test$home_team <- as.character(cuCH_test$home_team)
#cuCH_test$hit <- as.logical(cuCH_test$hit)
#cuCH_test$stand <- as.logical(cuCH_test$stand)
str(cuCH_test)
cuCH_rf.5_confusion_test <- confusionMatrix(model = cuCH_rf.5, x = cuCH_test, y = cuCH_test$hit)
cuCH_rf.5_confusion_validate <- confusionMatrix(model = cuCH_rf.5, x = cuCH_validate, y = cuCH_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


cuCH_test_rows <- cuCH_test$row
cuCH_validate_rows <- cuCH_validate$row
cuCH_pred_data_emp_1 <- ungroup(cuCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuCH_test_rows)

cuCH_pred_data_emp <- ungroup(cuCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuCH_validate_rows) %>%
	rbind(cuCH_pred_data_emp_1)

cuCH_out_of_training_rows <- cuCH_pred_data_emp$row

cuCH_rf.5_full_out_of_sample_data <- ungroup(cuCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuCH_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



cuCH_rf.5_full_out_of_sample_data_scaled <- cuCH_rf.5_full_out_of_sample_data

cuCH_rf.5_full_out_of_sample_data_scaled$hit_speed <- (cuCH_rf.5_full_out_of_sample_data_scaled$hit_speed - cuCH_center_values[2]) / cuCH_scale_values[2]

cuCH_rf.5_full_out_of_sample_data_scaled$hit_angle <- (cuCH_rf.5_full_out_of_sample_data_scaled$hit_angle - cuCH_center_values[3]) / cuCH_scale_values[3]

cuCH_rf.5.prob <- predict(cuCH_rf.5, cuCH_rf.5_full_out_of_sample_data_scaled, type = "response")

cuCH_rf.5_full_out_of_sample_data <- cbind(filter(cuCH_rf.5_full_out_of_sample_data, row %in% cuCH_out_of_training_rows), cuCH_rf.5.prob)

names(cuCH_rf.5_full_out_of_sample_data)[65] <- "fits"
names(cuCH_rf.5_full_out_of_sample_data)

cuCH_rf.5_full_out_of_sample_data_reduced <- cuCH_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

cuCH_rf.5_mean_table <- cuCH_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

cuCH_rf.5_full_out_of_sample_data$type <- with(cuCH_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

cuCH_rf.5_full_out_of_sample_data$hit_label <- with(cuCH_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

cuCH_rf.5_plot1 <- ggplot(cuCH_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuCH_rf.5_plot1

cuCH_rf.5_plot2 <- ggplot(cuCH_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuCH_rf.5_plot2

cuCH_rf.5_plot3 <- ggplot(cuCH_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuCH_rf.5_plot3

cuCH_grid_plot_rf.5 <- grid.arrange(cuCH_rf.5_plot1, cuCH_rf.5_plot2, cuCH_rf.5_plot3, ncol = 3)
cuCH_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

cuCH_test_rows <- cuCH_test$row
cuCH_validate_rows <- cuCH_validate$row
cuCH_pred_data_emp_1 <- ungroup(cuCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuCH_test_rows)

cuCH_pred_data_emp <- ungroup(cuCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuCH_validate_rows) %>%
	rbind(cuCH_pred_data_emp_1)

cuCH_out_of_training_rows <- cuCH_pred_data_emp$row

cuCH_pred_data_emp <- ungroup(cuCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuCH_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

cuCH_pred_data_emp_scaled <- cuCH_pred_data_emp

cuCH_pred_data_emp_scaled$hit_speed <- (cuCH_pred_data_emp_scaled$hit_speed - cuCH_center_values[2]) / cuCH_scale_values[2]

cuCH_pred_data_emp_scaled$hit_angle <- (cuCH_pred_data_emp_scaled$hit_angle - cuCH_center_values[3]) / cuCH_scale_values[3]

cuCH_pred_prob_hit <- predict(cuCH_rf.5, cuCH_pred_data_emp_scaled, type = "prob")[,2]
cuCH_pred_prob_hit_fits <- cbind(cuCH_pred_data_emp, cuCH_pred_prob_hit)

cuCH_pred_prob_hit_fits[,c(1:2)] <- cuCH_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

cuCH_angle_speed_pred <- cuCH_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = cuCH_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nCU-CH Hit Probability\n") + theme_bp_grey()

cuCH_angle_speed_pred
#####
slCH$hit_distance_sc <- as.numeric(slCH$hit_distance_sc, na.rm = TRUE)
slCH$hit_angle <- as.numeric(slCH$hit_angle, na.rm = TRUE)
slCH$hit_speed <- as.numeric(slCH$hit_speed, na.rm = TRUE)

slCH$hit <- with(slCH, ifelse(grepl("Single", slCH$events), 1,
															ifelse(grepl("Double", slCH$events), 1,
																		 ifelse(grepl("Triple", slCH$events), 1, 
																		 			 ifelse(grepl("Home Run", slCH$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

slCH$fieldingTeam <- with(slCH, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[slCH$hit_distance_sc == "null"] = NA
#slCH$hit_speed[slCH$hit_speed == "null"] = NA
#slCH$hit_angle[slCH$hit_angle == "null"] = NA

# include row names for unique record identification

slCH$row <- row.names(slCH) %>% as.numeric()

# recode stand and home_team as factors

slCH$stand <- as.factor(slCH$stand)
slCH$home_team <- as.factor(slCH$home_team)


slCH$game_date <- as.Date(slCH$game_date)


# subset 

slCH_working_data <- ungroup(slCH) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(slCH_working_data)
str(ungroup(slCH))
table(slCH_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

slCH_working_data <- filter(slCH_working_data, hc_x != 1, hc_y != 1)
head(slCH_working_data)

# create training and test sets
# scaled data

set.seed(42)
slCH_train <- sample_frac(slCH_working_data, .15, replace = FALSE)
slCH_split <- setdiff(slCH_working_data, slCH_train)
slCH_test <- sample_frac(slCH_split, .50, replace = FALSE)
slCH_validate <- setdiff(slCH_split, slCH_test)

nrow(slCH_train) + nrow(slCH_test) + nrow(slCH_validate) == nrow(slCH_working_data)

with(slCH_train, table(hit)) %>% prop.table()
with(slCH_test, table(hit)) %>% prop.table()
with(slCH_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(slCH)
##as.numeric(slCH$hit_distance_sc, slCH$hit_speed, slCH$hit_angle)

#slCH_train$hit_distance_sc <- as.numeric(slCH_train$hit_distance_sc)
#slCH_train$hit_speed <- as.numeric(slCH_train$hit_speed)
#slCH_train$hit_angle <- as.numeric(slCH_train$hit_angle)
#View(slCH_train)
slCH_scaled_data <- scale(slCH_train[,c(1:5)])
slCH_scale_values <- attr(slCH_scaled_data, 'scaled:scale')
slCH_scale_values
slCH_center_values <- attr(slCH_scaled_data, 'scaled:center')
slCH_center_values
slCH_train <- cbind(slCH_scaled_data, select(slCH_train, hit:row))

# save levels for factor variables
slCH_levels_home_team <- levels(slCH_train$home_team)
slCH_levels_stand <- levels(slCH_train$stand)
slCH_levels_fieldingTeam <- levels(slCH_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(slCH_test)

slCH_test$hit_distance_sc <- (slCH_test$hit_distance_sc - slCH_center_values[1]) / slCH_scale_values[1]

slCH_test$hit_speed <- (slCH_test$hit_speed - slCH_center_values[2]) / slCH_scale_values[2]

slCH_test$hit_angle <- (slCH_test$hit_angle - slCH_center_values[3]) / slCH_scale_values[3]

slCH_test$hc_x <- (slCH_test$hc_x - slCH_center_values[4]) / slCH_scale_values[4]

slCH_test$hc_y <- (slCH_test$hc_y - slCH_center_values[5]) / slCH_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

slCH_validate$hit_distance_sc <- (slCH_validate$hit_distance_sc - slCH_center_values[1]) / slCH_scale_values[1]

slCH_validate$hit_speed <- (slCH_validate$hit_speed - slCH_center_values[2]) / slCH_scale_values[2]

slCH_validate$hit_angle <- (slCH_validate$hit_angle - slCH_center_values[3]) / slCH_scale_values[3]

slCH_validate$hc_x <- (slCH_validate$hc_x - slCH_center_values[4]) / slCH_scale_values[4]

slCH_validate$hc_y <- (slCH_validate$hc_y - slCH_center_values[5]) / slCH_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(slCH_train)

set.seed(42)
slCH_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(slCH_train, -row), ntree = 501, importance = TRUE)

print(slCH_rf.1)

plot(slCH_rf.1)

varImpPlot(slCH_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
slCH_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(slCH_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(slCH_rf.5)

plot(slCH_rf.5)

varImpPlot(slCH_rf.5)

slCH_predict_fit.rf.5 <- data.frame(fits = predict(slCH_rf.5, slCH_test, type = "prob")[,2], actuals = slCH_test$hit)

slCH_pred.rf.5 <- prediction(slCH_predict_fit.rf.5$fits, slCH_predict_fit.rf.5$actuals)

slCH_roc.pred.rf.5 <- performance(slCH_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(slCH_roc.pred.rf.5)
abline(a = 0, b = 1)
slCH_opt <- opt.cut(slCH_roc.pred.rf.5, slCH_pred.rf.5)
slCH_opt
slCH_opt <- slCH_opt[3]
slCH_predict_fit.rf.5$fits <- with(slCH_predict_fit.rf.5, ifelse(fits > slCH_opt, 1, 0)) 

str(slCH_test)

#slCH_test$fieldingTeam <- as.character(slCH_test$fieldingTeam)
#slCH_test$home_team <- as.character(slCH_test$home_team)
#slCH_test$hit <- as.logical(slCH_test$hit)
#slCH_test$stand <- as.logical(slCH_test$stand)
str(slCH_test)
slCH_rf.5_confusion_test <- confusionMatrix(model = slCH_rf.5, x = slCH_test, y = slCH_test$hit)
slCH_rf.5_confusion_validate <- confusionMatrix(model = slCH_rf.5, x = slCH_validate, y = slCH_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


slCH_test_rows <- slCH_test$row
slCH_validate_rows <- slCH_validate$row
slCH_pred_data_emp_1 <- ungroup(slCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slCH_test_rows)

slCH_pred_data_emp <- ungroup(slCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slCH_validate_rows) %>%
	rbind(slCH_pred_data_emp_1)

slCH_out_of_training_rows <- slCH_pred_data_emp$row

slCH_rf.5_full_out_of_sample_data <- ungroup(slCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slCH_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



slCH_rf.5_full_out_of_sample_data_scaled <- slCH_rf.5_full_out_of_sample_data

slCH_rf.5_full_out_of_sample_data_scaled$hit_speed <- (slCH_rf.5_full_out_of_sample_data_scaled$hit_speed - slCH_center_values[2]) / slCH_scale_values[2]

slCH_rf.5_full_out_of_sample_data_scaled$hit_angle <- (slCH_rf.5_full_out_of_sample_data_scaled$hit_angle - slCH_center_values[3]) / slCH_scale_values[3]

slCH_rf.5.prob <- predict(slCH_rf.5, slCH_rf.5_full_out_of_sample_data_scaled, type = "response")

slCH_rf.5_full_out_of_sample_data <- cbind(filter(slCH_rf.5_full_out_of_sample_data, row %in% slCH_out_of_training_rows), slCH_rf.5.prob)

names(slCH_rf.5_full_out_of_sample_data)[65] <- "fits"
names(slCH_rf.5_full_out_of_sample_data)

slCH_rf.5_full_out_of_sample_data_reduced <- slCH_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

slCH_rf.5_mean_table <- slCH_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

slCH_rf.5_full_out_of_sample_data$type <- with(slCH_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

slCH_rf.5_full_out_of_sample_data$hit_label <- with(slCH_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

slCH_rf.5_plot1 <- ggplot(slCH_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slCH_rf.5_plot1

slCH_rf.5_plot2 <- ggplot(slCH_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slCH_rf.5_plot2

slCH_rf.5_plot3 <- ggplot(slCH_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slCH_rf.5_plot3

slCH_grid_plot_rf.5 <- grid.arrange(slCH_rf.5_plot1, slCH_rf.5_plot2, slCH_rf.5_plot3, ncol = 3)
slCH_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

slCH_test_rows <- slCH_test$row
slCH_validate_rows <- slCH_validate$row
slCH_pred_data_emp_1 <- ungroup(slCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slCH_test_rows)

slCH_pred_data_emp <- ungroup(slCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slCH_validate_rows) %>%
	rbind(slCH_pred_data_emp_1)

slCH_out_of_training_rows <- slCH_pred_data_emp$row

slCH_pred_data_emp <- ungroup(slCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slCH_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

slCH_pred_data_emp_scaled <- slCH_pred_data_emp

slCH_pred_data_emp_scaled$hit_speed <- (slCH_pred_data_emp_scaled$hit_speed - slCH_center_values[2]) / slCH_scale_values[2]

slCH_pred_data_emp_scaled$hit_angle <- (slCH_pred_data_emp_scaled$hit_angle - slCH_center_values[3]) / slCH_scale_values[3]

slCH_pred_prob_hit <- predict(slCH_rf.5, slCH_pred_data_emp_scaled, type = "prob")[,2]
slCH_pred_prob_hit_fits <- cbind(slCH_pred_data_emp, slCH_pred_prob_hit)

slCH_pred_prob_hit_fits[,c(1:2)] <- slCH_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

slCH_angle_speed_pred <- slCH_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = slCH_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nSL-CH Hit Probability\n") + theme_bp_grey()

slCH_angle_speed_pred
#####
ffCH$hit_distance_sc <- as.numeric(ffCH$hit_distance_sc, na.rm = TRUE)
ffCH$hit_angle <- as.numeric(ffCH$hit_angle, na.rm = TRUE)
ffCH$hit_speed <- as.numeric(ffCH$hit_speed, na.rm = TRUE)

ffCH$hit <- with(ffCH, ifelse(grepl("Single", ffCH$events), 1,
															ifelse(grepl("Double", ffCH$events), 1,
																		 ifelse(grepl("Triple", ffCH$events), 1, 
																		 			 ifelse(grepl("Home Run", ffCH$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

ffCH$fieldingTeam <- with(ffCH, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[ffCH$hit_distance_sc == "null"] = NA
#ffCH$hit_speed[ffCH$hit_speed == "null"] = NA
#ffCH$hit_angle[ffCH$hit_angle == "null"] = NA

# include row names for unique record identification

ffCH$row <- row.names(ffCH) %>% as.numeric()

# recode stand and home_team as factors

ffCH$stand <- as.factor(ffCH$stand)
ffCH$home_team <- as.factor(ffCH$home_team)


ffCH$game_date <- as.Date(ffCH$game_date)


# subset 

ffCH_working_data <- ungroup(ffCH) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(ffCH_working_data)
str(ungroup(ffCH))
table(ffCH_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

ffCH_working_data <- filter(ffCH_working_data, hc_x != 1, hc_y != 1)
head(ffCH_working_data)

# create training and test sets
# scaled data

set.seed(42)
ffCH_train <- sample_frac(ffCH_working_data, .15, replace = FALSE)
ffCH_split <- setdiff(ffCH_working_data, ffCH_train)
ffCH_test <- sample_frac(ffCH_split, .50, replace = FALSE)
ffCH_validate <- setdiff(ffCH_split, ffCH_test)

nrow(ffCH_train) + nrow(ffCH_test) + nrow(ffCH_validate) == nrow(ffCH_working_data)

with(ffCH_train, table(hit)) %>% prop.table()
with(ffCH_test, table(hit)) %>% prop.table()
with(ffCH_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(ffCH)
##as.numeric(ffCH$hit_distance_sc, ffCH$hit_speed, ffCH$hit_angle)

#ffCH_train$hit_distance_sc <- as.numeric(ffCH_train$hit_distance_sc)
#ffCH_train$hit_speed <- as.numeric(ffCH_train$hit_speed)
#ffCH_train$hit_angle <- as.numeric(ffCH_train$hit_angle)
#View(ffCH_train)
ffCH_scaled_data <- scale(ffCH_train[,c(1:5)])
ffCH_scale_values <- attr(ffCH_scaled_data, 'scaled:scale')
ffCH_scale_values
ffCH_center_values <- attr(ffCH_scaled_data, 'scaled:center')
ffCH_center_values
ffCH_train <- cbind(ffCH_scaled_data, select(ffCH_train, hit:row))

# save levels for factor variables
ffCH_levels_home_team <- levels(ffCH_train$home_team)
ffCH_levels_stand <- levels(ffCH_train$stand)
ffCH_levels_fieldingTeam <- levels(ffCH_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(ffCH_test)

ffCH_test$hit_distance_sc <- (ffCH_test$hit_distance_sc - ffCH_center_values[1]) / ffCH_scale_values[1]

ffCH_test$hit_speed <- (ffCH_test$hit_speed - ffCH_center_values[2]) / ffCH_scale_values[2]

ffCH_test$hit_angle <- (ffCH_test$hit_angle - ffCH_center_values[3]) / ffCH_scale_values[3]

ffCH_test$hc_x <- (ffCH_test$hc_x - ffCH_center_values[4]) / ffCH_scale_values[4]

ffCH_test$hc_y <- (ffCH_test$hc_y - ffCH_center_values[5]) / ffCH_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

ffCH_validate$hit_distance_sc <- (ffCH_validate$hit_distance_sc - ffCH_center_values[1]) / ffCH_scale_values[1]

ffCH_validate$hit_speed <- (ffCH_validate$hit_speed - ffCH_center_values[2]) / ffCH_scale_values[2]

ffCH_validate$hit_angle <- (ffCH_validate$hit_angle - ffCH_center_values[3]) / ffCH_scale_values[3]

ffCH_validate$hc_x <- (ffCH_validate$hc_x - ffCH_center_values[4]) / ffCH_scale_values[4]

ffCH_validate$hc_y <- (ffCH_validate$hc_y - ffCH_center_values[5]) / ffCH_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(ffCH_train)

set.seed(42)
ffCH_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(ffCH_train, -row), ntree = 501, importance = TRUE)

print(ffCH_rf.1)

plot(ffCH_rf.1)

varImpPlot(ffCH_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
ffCH_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(ffCH_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(ffCH_rf.5)

plot(ffCH_rf.5)

varImpPlot(ffCH_rf.5)

ffCH_predict_fit.rf.5 <- data.frame(fits = predict(ffCH_rf.5, ffCH_test, type = "prob")[,2], actuals = ffCH_test$hit)

ffCH_pred.rf.5 <- prediction(ffCH_predict_fit.rf.5$fits, ffCH_predict_fit.rf.5$actuals)

ffCH_roc.pred.rf.5 <- performance(ffCH_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(ffCH_roc.pred.rf.5)
abline(a = 0, b = 1)
ffCH_opt <- opt.cut(ffCH_roc.pred.rf.5, ffCH_pred.rf.5)
ffCH_opt
ffCH_opt <- ffCH_opt[3]
ffCH_predict_fit.rf.5$fits <- with(ffCH_predict_fit.rf.5, ifelse(fits > ffCH_opt, 1, 0)) 

str(ffCH_test)

#ffCH_test$fieldingTeam <- as.character(ffCH_test$fieldingTeam)
#ffCH_test$home_team <- as.character(ffCH_test$home_team)
#ffCH_test$hit <- as.logical(ffCH_test$hit)
#ffCH_test$stand <- as.logical(ffCH_test$stand)
str(ffCH_test)
ffCH_rf.5_confusion_test <- confusionMatrix(model = ffCH_rf.5, x = ffCH_test, y = ffCH_test$hit)
ffCH_rf.5_confusion_validate <- confusionMatrix(model = ffCH_rf.5, x = ffCH_validate, y = ffCH_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


ffCH_test_rows <- ffCH_test$row
ffCH_validate_rows <- ffCH_validate$row
ffCH_pred_data_emp_1 <- ungroup(ffCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffCH_test_rows)

ffCH_pred_data_emp <- ungroup(ffCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffCH_validate_rows) %>%
	rbind(ffCH_pred_data_emp_1)

ffCH_out_of_training_rows <- ffCH_pred_data_emp$row

ffCH_rf.5_full_out_of_sample_data <- ungroup(ffCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffCH_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



ffCH_rf.5_full_out_of_sample_data_scaled <- ffCH_rf.5_full_out_of_sample_data

ffCH_rf.5_full_out_of_sample_data_scaled$hit_speed <- (ffCH_rf.5_full_out_of_sample_data_scaled$hit_speed - ffCH_center_values[2]) / ffCH_scale_values[2]

ffCH_rf.5_full_out_of_sample_data_scaled$hit_angle <- (ffCH_rf.5_full_out_of_sample_data_scaled$hit_angle - ffCH_center_values[3]) / ffCH_scale_values[3]

ffCH_rf.5.prob <- predict(ffCH_rf.5, ffCH_rf.5_full_out_of_sample_data_scaled, type = "response")

ffCH_rf.5_full_out_of_sample_data <- cbind(filter(ffCH_rf.5_full_out_of_sample_data, row %in% ffCH_out_of_training_rows), ffCH_rf.5.prob)

names(ffCH_rf.5_full_out_of_sample_data)[65] <- "fits"
names(ffCH_rf.5_full_out_of_sample_data)

ffCH_rf.5_full_out_of_sample_data_reduced <- ffCH_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

ffCH_rf.5_mean_table <- ffCH_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

ffCH_rf.5_full_out_of_sample_data$type <- with(ffCH_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

ffCH_rf.5_full_out_of_sample_data$hit_label <- with(ffCH_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

ffCH_rf.5_plot1 <- ggplot(ffCH_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffCH_rf.5_plot1

ffCH_rf.5_plot2 <- ggplot(ffCH_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffCH_rf.5_plot2

ffCH_rf.5_plot3 <- ggplot(ffCH_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffCH_rf.5_plot3

ffCH_grid_plot_rf.5 <- grid.arrange(ffCH_rf.5_plot1, ffCH_rf.5_plot2, ffCH_rf.5_plot3, ncol = 3)
ffCH_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

ffCH_test_rows <- ffCH_test$row
ffCH_validate_rows <- ffCH_validate$row
ffCH_pred_data_emp_1 <- ungroup(ffCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffCH_test_rows)

ffCH_pred_data_emp <- ungroup(ffCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffCH_validate_rows) %>%
	rbind(ffCH_pred_data_emp_1)

ffCH_out_of_training_rows <- ffCH_pred_data_emp$row

ffCH_pred_data_emp <- ungroup(ffCH) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffCH_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

ffCH_pred_data_emp_scaled <- ffCH_pred_data_emp

ffCH_pred_data_emp_scaled$hit_speed <- (ffCH_pred_data_emp_scaled$hit_speed - ffCH_center_values[2]) / ffCH_scale_values[2]

ffCH_pred_data_emp_scaled$hit_angle <- (ffCH_pred_data_emp_scaled$hit_angle - ffCH_center_values[3]) / ffCH_scale_values[3]

ffCH_pred_prob_hit <- predict(ffCH_rf.5, ffCH_pred_data_emp_scaled, type = "prob")[,2]
ffCH_pred_prob_hit_fits <- cbind(ffCH_pred_data_emp, ffCH_pred_prob_hit)

ffCH_pred_prob_hit_fits[,c(1:2)] <- ffCH_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

ffCH_angle_speed_pred <- ffCH_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = ffCH_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFF-CH Hit Probability\n") + theme_bp_grey()

ffCH_angle_speed_pred
############# End Changeups; Start Cutters
#####
siFC$hit_distance_sc <- as.numeric(siFC$hit_distance_sc, na.rm = TRUE)
siFC$hit_angle <- as.numeric(siFC$hit_angle, na.rm = TRUE)
siFC$hit_speed <- as.numeric(siFC$hit_speed, na.rm = TRUE)

siFC$hit <- with(siFC, ifelse(grepl("Single", siFC$events), 1,
															ifelse(grepl("Double", siFC$events), 1,
																		 ifelse(grepl("Triple", siFC$events), 1, 
																		 			 ifelse(grepl("Home Run", siFC$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

siFC$fieldingTeam <- with(siFC, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[siFC$hit_distance_sc == "null"] = NA
#siFC$hit_speed[siFC$hit_speed == "null"] = NA
#siFC$hit_angle[siFC$hit_angle == "null"] = NA

# include row names for unique record identification

siFC$row <- row.names(siFC) %>% as.numeric()

# recode stand and home_team as factors

siFC$stand <- as.factor(siFC$stand)
siFC$home_team <- as.factor(siFC$home_team)


siFC$game_date <- as.Date(siFC$game_date)


# subset 

siFC_working_data <- ungroup(siFC) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(siFC_working_data)
str(ungroup(siFC))
table(siFC_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

siFC_working_data <- filter(siFC_working_data, hc_x != 1, hc_y != 1)
head(siFC_working_data)

# create training and test sets
# scaled data

set.seed(42)
siFC_train <- sample_frac(siFC_working_data, .15, replace = FALSE)
siFC_split <- setdiff(siFC_working_data, siFC_train)
siFC_test <- sample_frac(siFC_split, .50, replace = FALSE)
siFC_validate <- setdiff(siFC_split, siFC_test)

nrow(siFC_train) + nrow(siFC_test) + nrow(siFC_validate) == nrow(siFC_working_data)

with(siFC_train, table(hit)) %>% prop.table()
with(siFC_test, table(hit)) %>% prop.table()
with(siFC_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(siFC)
##as.numeric(siFC$hit_distance_sc, siFC$hit_speed, siFC$hit_angle)

#siFC_train$hit_distance_sc <- as.numeric(siFC_train$hit_distance_sc)
#siFC_train$hit_speed <- as.numeric(siFC_train$hit_speed)
#siFC_train$hit_angle <- as.numeric(siFC_train$hit_angle)
#View(siFC_train)
siFC_scaled_data <- scale(siFC_train[,c(1:5)])
siFC_scale_values <- attr(siFC_scaled_data, 'scaled:scale')
siFC_scale_values
siFC_center_values <- attr(siFC_scaled_data, 'scaled:center')
siFC_center_values
siFC_train <- cbind(siFC_scaled_data, select(siFC_train, hit:row))

# save levels for factor variables
siFC_levels_home_team <- levels(siFC_train$home_team)
siFC_levels_stand <- levels(siFC_train$stand)
siFC_levels_fieldingTeam <- levels(siFC_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(siFC_test)

siFC_test$hit_distance_sc <- (siFC_test$hit_distance_sc - siFC_center_values[1]) / siFC_scale_values[1]

siFC_test$hit_speed <- (siFC_test$hit_speed - siFC_center_values[2]) / siFC_scale_values[2]

siFC_test$hit_angle <- (siFC_test$hit_angle - siFC_center_values[3]) / siFC_scale_values[3]

siFC_test$hc_x <- (siFC_test$hc_x - siFC_center_values[4]) / siFC_scale_values[4]

siFC_test$hc_y <- (siFC_test$hc_y - siFC_center_values[5]) / siFC_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

siFC_validate$hit_distance_sc <- (siFC_validate$hit_distance_sc - siFC_center_values[1]) / siFC_scale_values[1]

siFC_validate$hit_speed <- (siFC_validate$hit_speed - siFC_center_values[2]) / siFC_scale_values[2]

siFC_validate$hit_angle <- (siFC_validate$hit_angle - siFC_center_values[3]) / siFC_scale_values[3]

siFC_validate$hc_x <- (siFC_validate$hc_x - siFC_center_values[4]) / siFC_scale_values[4]

siFC_validate$hc_y <- (siFC_validate$hc_y - siFC_center_values[5]) / siFC_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(siFC_train)

set.seed(42)
siFC_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(siFC_train, -row), ntree = 501, importance = TRUE)

print(siFC_rf.1)

plot(siFC_rf.1)

varImpPlot(siFC_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
siFC_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(siFC_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(siFC_rf.5)

plot(siFC_rf.5)

varImpPlot(siFC_rf.5)

siFC_predict_fit.rf.5 <- data.frame(fits = predict(siFC_rf.5, siFC_test, type = "prob")[,2], actuals = siFC_test$hit)

siFC_pred.rf.5 <- prediction(siFC_predict_fit.rf.5$fits, siFC_predict_fit.rf.5$actuals)

siFC_roc.pred.rf.5 <- performance(siFC_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(siFC_roc.pred.rf.5)
abline(a = 0, b = 1)
siFC_opt <- opt.cut(siFC_roc.pred.rf.5, siFC_pred.rf.5)
siFC_opt
siFC_opt <- siFC_opt[3]
siFC_predict_fit.rf.5$fits <- with(siFC_predict_fit.rf.5, ifelse(fits > siFC_opt, 1, 0)) 

str(siFC_test)

#siFC_test$fieldingTeam <- as.character(siFC_test$fieldingTeam)
#siFC_test$home_team <- as.character(siFC_test$home_team)
#siFC_test$hit <- as.logical(siFC_test$hit)
#siFC_test$stand <- as.logical(siFC_test$stand)
str(siFC_test)
siFC_rf.5_confusion_test <- confusionMatrix(model = siFC_rf.5, x = siFC_test, y = siFC_test$hit)
siFC_rf.5_confusion_validate <- confusionMatrix(model = siFC_rf.5, x = siFC_validate, y = siFC_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


siFC_test_rows <- siFC_test$row
siFC_validate_rows <- siFC_validate$row
siFC_pred_data_emp_1 <- ungroup(siFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFC_test_rows)

siFC_pred_data_emp <- ungroup(siFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFC_validate_rows) %>%
	rbind(siFC_pred_data_emp_1)

siFC_out_of_training_rows <- siFC_pred_data_emp$row

siFC_rf.5_full_out_of_sample_data <- ungroup(siFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFC_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



siFC_rf.5_full_out_of_sample_data_scaled <- siFC_rf.5_full_out_of_sample_data

siFC_rf.5_full_out_of_sample_data_scaled$hit_speed <- (siFC_rf.5_full_out_of_sample_data_scaled$hit_speed - siFC_center_values[2]) / siFC_scale_values[2]

siFC_rf.5_full_out_of_sample_data_scaled$hit_angle <- (siFC_rf.5_full_out_of_sample_data_scaled$hit_angle - siFC_center_values[3]) / siFC_scale_values[3]

siFC_rf.5.prob <- predict(siFC_rf.5, siFC_rf.5_full_out_of_sample_data_scaled, type = "response")

siFC_rf.5_full_out_of_sample_data <- cbind(filter(siFC_rf.5_full_out_of_sample_data, row %in% siFC_out_of_training_rows), siFC_rf.5.prob)

names(siFC_rf.5_full_out_of_sample_data)[65] <- "fits"
names(siFC_rf.5_full_out_of_sample_data)

siFC_rf.5_full_out_of_sample_data_reduced <- siFC_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

siFC_rf.5_mean_table <- siFC_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

siFC_rf.5_full_out_of_sample_data$type <- with(siFC_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

siFC_rf.5_full_out_of_sample_data$hit_label <- with(siFC_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

siFC_rf.5_plot1 <- ggplot(siFC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siFC_rf.5_plot1

siFC_rf.5_plot2 <- ggplot(siFC_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siFC_rf.5_plot2

siFC_rf.5_plot3 <- ggplot(siFC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siFC_rf.5_plot3

siFC_grid_plot_rf.5 <- grid.arrange(siFC_rf.5_plot1, siFC_rf.5_plot2, siFC_rf.5_plot3, ncol = 3)
siFC_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

siFC_test_rows <- siFC_test$row
siFC_validate_rows <- siFC_validate$row
siFC_pred_data_emp_1 <- ungroup(siFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFC_test_rows)

siFC_pred_data_emp <- ungroup(siFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFC_validate_rows) %>%
	rbind(siFC_pred_data_emp_1)

siFC_out_of_training_rows <- siFC_pred_data_emp$row

siFC_pred_data_emp <- ungroup(siFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFC_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

siFC_pred_data_emp_scaled <- siFC_pred_data_emp

siFC_pred_data_emp_scaled$hit_speed <- (siFC_pred_data_emp_scaled$hit_speed - siFC_center_values[2]) / siFC_scale_values[2]

siFC_pred_data_emp_scaled$hit_angle <- (siFC_pred_data_emp_scaled$hit_angle - siFC_center_values[3]) / siFC_scale_values[3]

siFC_pred_prob_hit <- predict(siFC_rf.5, siFC_pred_data_emp_scaled, type = "prob")[,2]
siFC_pred_prob_hit_fits <- cbind(siFC_pred_data_emp, siFC_pred_prob_hit)

siFC_pred_prob_hit_fits[,c(1:2)] <- siFC_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

siFC_angle_speed_pred <- siFC_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = siFC_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nSI-FC Hit Probability\n") + theme_bp_grey()

siFC_angle_speed_pred
########################## Start Cutters
#####
knFC$hit_distance_sc <- as.numeric(knFC$hit_distance_sc, na.rm = TRUE)
knFC$hit_angle <- as.numeric(knFC$hit_angle, na.rm = TRUE)
knFC$hit_speed <- as.numeric(knFC$hit_speed, na.rm = TRUE)

knFC$hit <- with(knFC, ifelse(grepl("Single", knFC$events), 1,
															ifelse(grepl("Double", knFC$events), 1,
																		 ifelse(grepl("Triple", knFC$events), 1, 
																		 			 ifelse(grepl("Home Run", knFC$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

knFC$fieldingTeam <- with(knFC, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[knFC$hit_distance_sc == "null"] = NA
#knFC$hit_speed[knFC$hit_speed == "null"] = NA
#knFC$hit_angle[knFC$hit_angle == "null"] = NA

# include row names for unique record identification

knFC$row <- row.names(knFC) %>% as.numeric()

# recode stand and home_team as factors

knFC$stand <- as.factor(knFC$stand)
knFC$home_team <- as.factor(knFC$home_team)


knFC$game_date <- as.Date(knFC$game_date)


# subset 

knFC_working_data <- ungroup(knFC) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(knFC_working_data)
str(ungroup(knFC))
table(knFC_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

knFC_working_data <- filter(knFC_working_data, hc_x != 1, hc_y != 1)
head(knFC_working_data)

# create training and test sets
# scaled data

set.seed(42)
knFC_train <- sample_frac(knFC_working_data, .15, replace = FALSE)
knFC_split <- setdiff(knFC_working_data, knFC_train)
knFC_test <- sample_frac(knFC_split, .50, replace = FALSE)
knFC_validate <- setdiff(knFC_split, knFC_test)

nrow(knFC_train) + nrow(knFC_test) + nrow(knFC_validate) == nrow(knFC_working_data)

with(knFC_train, table(hit)) %>% prop.table()
with(knFC_test, table(hit)) %>% prop.table()
with(knFC_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(knFC)
##as.numeric(knFC$hit_distance_sc, knFC$hit_speed, knFC$hit_angle)

#knFC_train$hit_distance_sc <- as.numeric(knFC_train$hit_distance_sc)
#knFC_train$hit_speed <- as.numeric(knFC_train$hit_speed)
#knFC_train$hit_angle <- as.numeric(knFC_train$hit_angle)
#View(knFC_train)
knFC_scaled_data <- scale(knFC_train[,c(1:5)])
knFC_scale_values <- attr(knFC_scaled_data, 'scaled:scale')
knFC_scale_values
knFC_center_values <- attr(knFC_scaled_data, 'scaled:center')
knFC_center_values
knFC_train <- cbind(knFC_scaled_data, select(knFC_train, hit:row))

# save levels for factor variables
knFC_levels_home_team <- levels(knFC_train$home_team)
knFC_levels_stand <- levels(knFC_train$stand)
knFC_levels_fieldingTeam <- levels(knFC_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(knFC_test)

knFC_test$hit_distance_sc <- (knFC_test$hit_distance_sc - knFC_center_values[1]) / knFC_scale_values[1]

knFC_test$hit_speed <- (knFC_test$hit_speed - knFC_center_values[2]) / knFC_scale_values[2]

knFC_test$hit_angle <- (knFC_test$hit_angle - knFC_center_values[3]) / knFC_scale_values[3]

knFC_test$hc_x <- (knFC_test$hc_x - knFC_center_values[4]) / knFC_scale_values[4]

knFC_test$hc_y <- (knFC_test$hc_y - knFC_center_values[5]) / knFC_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

knFC_validate$hit_distance_sc <- (knFC_validate$hit_distance_sc - knFC_center_values[1]) / knFC_scale_values[1]

knFC_validate$hit_speed <- (knFC_validate$hit_speed - knFC_center_values[2]) / knFC_scale_values[2]

knFC_validate$hit_angle <- (knFC_validate$hit_angle - knFC_center_values[3]) / knFC_scale_values[3]

knFC_validate$hc_x <- (knFC_validate$hc_x - knFC_center_values[4]) / knFC_scale_values[4]

knFC_validate$hc_y <- (knFC_validate$hc_y - knFC_center_values[5]) / knFC_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(knFC_train)

set.seed(42)
knFC_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(knFC_train, -row), ntree = 501, importance = TRUE)

print(knFC_rf.1)

plot(knFC_rf.1)

varImpPlot(knFC_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
knFC_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(knFC_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(knFC_rf.5)

plot(knFC_rf.5)

varImpPlot(knFC_rf.5)

knFC_predict_fit.rf.5 <- data.frame(fits = predict(knFC_rf.5, knFC_test, type = "prob")[,2], actuals = knFC_test$hit)

knFC_pred.rf.5 <- prediction(knFC_predict_fit.rf.5$fits, knFC_predict_fit.rf.5$actuals)

knFC_roc.pred.rf.5 <- performance(knFC_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(knFC_roc.pred.rf.5)
abline(a = 0, b = 1)
knFC_opt <- opt.cut(knFC_roc.pred.rf.5, knFC_pred.rf.5)
knFC_opt
knFC_opt <- knFC_opt[3]
knFC_predict_fit.rf.5$fits <- with(knFC_predict_fit.rf.5, ifelse(fits > knFC_opt, 1, 0)) 

str(knFC_test)

#knFC_test$fieldingTeam <- as.character(knFC_test$fieldingTeam)
#knFC_test$home_team <- as.character(knFC_test$home_team)
#knFC_test$hit <- as.logical(knFC_test$hit)
#knFC_test$stand <- as.logical(knFC_test$stand)
str(knFC_test)
knFC_rf.5_confusion_test <- confusionMatrix(model = knFC_rf.5, x = knFC_test, y = knFC_test$hit)
knFC_rf.5_confusion_validate <- confusionMatrix(model = knFC_rf.5, x = knFC_validate, y = knFC_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


knFC_test_rows <- knFC_test$row
knFC_validate_rows <- knFC_validate$row
knFC_pred_data_emp_1 <- ungroup(knFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFC_test_rows)

knFC_pred_data_emp <- ungroup(knFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFC_validate_rows) %>%
	rbind(knFC_pred_data_emp_1)

knFC_out_of_training_rows <- knFC_pred_data_emp$row

knFC_rf.5_full_out_of_sample_data <- ungroup(knFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFC_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



knFC_rf.5_full_out_of_sample_data_scaled <- knFC_rf.5_full_out_of_sample_data

knFC_rf.5_full_out_of_sample_data_scaled$hit_speed <- (knFC_rf.5_full_out_of_sample_data_scaled$hit_speed - knFC_center_values[2]) / knFC_scale_values[2]

knFC_rf.5_full_out_of_sample_data_scaled$hit_angle <- (knFC_rf.5_full_out_of_sample_data_scaled$hit_angle - knFC_center_values[3]) / knFC_scale_values[3]

knFC_rf.5.prob <- predict(knFC_rf.5, knFC_rf.5_full_out_of_sample_data_scaled, type = "response")

knFC_rf.5_full_out_of_sample_data <- cbind(filter(knFC_rf.5_full_out_of_sample_data, row %in% knFC_out_of_training_rows), knFC_rf.5.prob)

names(knFC_rf.5_full_out_of_sample_data)[65] <- "fits"
names(knFC_rf.5_full_out_of_sample_data)

knFC_rf.5_full_out_of_sample_data_reduced <- knFC_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

knFC_rf.5_mean_table <- knFC_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

knFC_rf.5_full_out_of_sample_data$type <- with(knFC_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

knFC_rf.5_full_out_of_sample_data$hit_label <- with(knFC_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

knFC_rf.5_plot1 <- ggplot(knFC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knFC_rf.5_plot1

knFC_rf.5_plot2 <- ggplot(knFC_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knFC_rf.5_plot2

knFC_rf.5_plot3 <- ggplot(knFC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knFC_rf.5_plot3

knFC_grid_plot_rf.5 <- grid.arrange(knFC_rf.5_plot1, knFC_rf.5_plot2, knFC_rf.5_plot3, ncol = 3)
knFC_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

knFC_test_rows <- knFC_test$row
knFC_validate_rows <- knFC_validate$row
knFC_pred_data_emp_1 <- ungroup(knFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFC_test_rows)

knFC_pred_data_emp <- ungroup(knFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFC_validate_rows) %>%
	rbind(knFC_pred_data_emp_1)

knFC_out_of_training_rows <- knFC_pred_data_emp$row

knFC_pred_data_emp <- ungroup(knFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFC_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

knFC_pred_data_emp_scaled <- knFC_pred_data_emp

knFC_pred_data_emp_scaled$hit_speed <- (knFC_pred_data_emp_scaled$hit_speed - knFC_center_values[2]) / knFC_scale_values[2]

knFC_pred_data_emp_scaled$hit_angle <- (knFC_pred_data_emp_scaled$hit_angle - knFC_center_values[3]) / knFC_scale_values[3]

knFC_pred_prob_hit <- predict(knFC_rf.5, knFC_pred_data_emp_scaled, type = "prob")[,2]
knFC_pred_prob_hit_fits <- cbind(knFC_pred_data_emp, knFC_pred_prob_hit)

knFC_pred_prob_hit_fits[,c(1:2)] <- knFC_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

knFC_angle_speed_pred <- knFC_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = knFC_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nKN-FC Hit Probability\n") + theme_bp_grey()

knFC_angle_speed_pred
#####
kcFC$hit_distance_sc <- as.numeric(kcFC$hit_distance_sc, na.rm = TRUE)
kcFC$hit_angle <- as.numeric(kcFC$hit_angle, na.rm = TRUE)
kcFC$hit_speed <- as.numeric(kcFC$hit_speed, na.rm = TRUE)

kcFC$hit <- with(kcFC, ifelse(grepl("Single", kcFC$events), 1,
															ifelse(grepl("Double", kcFC$events), 1,
																		 ifelse(grepl("Triple", kcFC$events), 1, 
																		 			 ifelse(grepl("Home Run", kcFC$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

kcFC$fieldingTeam <- with(kcFC, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[kcFC$hit_distance_sc == "null"] = NA
#kcFC$hit_speed[kcFC$hit_speed == "null"] = NA
#kcFC$hit_angle[kcFC$hit_angle == "null"] = NA

# include row names for unique record identification

kcFC$row <- row.names(kcFC) %>% as.numeric()

# recode stand and home_team as factors

kcFC$stand <- as.factor(kcFC$stand)
kcFC$home_team <- as.factor(kcFC$home_team)


kcFC$game_date <- as.Date(kcFC$game_date)


# subset 

kcFC_working_data <- ungroup(kcFC) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(kcFC_working_data)
str(ungroup(kcFC))
table(kcFC_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

kcFC_working_data <- filter(kcFC_working_data, hc_x != 1, hc_y != 1)
head(kcFC_working_data)

# create training and test sets
# scaled data

set.seed(42)
kcFC_train <- sample_frac(kcFC_working_data, .15, replace = FALSE)
kcFC_split <- setdiff(kcFC_working_data, kcFC_train)
kcFC_test <- sample_frac(kcFC_split, .50, replace = FALSE)
kcFC_validate <- setdiff(kcFC_split, kcFC_test)

nrow(kcFC_train) + nrow(kcFC_test) + nrow(kcFC_validate) == nrow(kcFC_working_data)

with(kcFC_train, table(hit)) %>% prop.table()
with(kcFC_test, table(hit)) %>% prop.table()
with(kcFC_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(kcFC)
##as.numeric(kcFC$hit_distance_sc, kcFC$hit_speed, kcFC$hit_angle)

#kcFC_train$hit_distance_sc <- as.numeric(kcFC_train$hit_distance_sc)
#kcFC_train$hit_speed <- as.numeric(kcFC_train$hit_speed)
#kcFC_train$hit_angle <- as.numeric(kcFC_train$hit_angle)
#View(kcFC_train)
kcFC_scaled_data <- scale(kcFC_train[,c(1:5)])
kcFC_scale_values <- attr(kcFC_scaled_data, 'scaled:scale')
kcFC_scale_values
kcFC_center_values <- attr(kcFC_scaled_data, 'scaled:center')
kcFC_center_values
kcFC_train <- cbind(kcFC_scaled_data, select(kcFC_train, hit:row))

# save levels for factor variables
kcFC_levels_home_team <- levels(kcFC_train$home_team)
kcFC_levels_stand <- levels(kcFC_train$stand)
kcFC_levels_fieldingTeam <- levels(kcFC_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(kcFC_test)

kcFC_test$hit_distance_sc <- (kcFC_test$hit_distance_sc - kcFC_center_values[1]) / kcFC_scale_values[1]

kcFC_test$hit_speed <- (kcFC_test$hit_speed - kcFC_center_values[2]) / kcFC_scale_values[2]

kcFC_test$hit_angle <- (kcFC_test$hit_angle - kcFC_center_values[3]) / kcFC_scale_values[3]

kcFC_test$hc_x <- (kcFC_test$hc_x - kcFC_center_values[4]) / kcFC_scale_values[4]

kcFC_test$hc_y <- (kcFC_test$hc_y - kcFC_center_values[5]) / kcFC_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

kcFC_validate$hit_distance_sc <- (kcFC_validate$hit_distance_sc - kcFC_center_values[1]) / kcFC_scale_values[1]

kcFC_validate$hit_speed <- (kcFC_validate$hit_speed - kcFC_center_values[2]) / kcFC_scale_values[2]

kcFC_validate$hit_angle <- (kcFC_validate$hit_angle - kcFC_center_values[3]) / kcFC_scale_values[3]

kcFC_validate$hc_x <- (kcFC_validate$hc_x - kcFC_center_values[4]) / kcFC_scale_values[4]

kcFC_validate$hc_y <- (kcFC_validate$hc_y - kcFC_center_values[5]) / kcFC_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(kcFC_train)

set.seed(42)
kcFC_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(kcFC_train, -row), ntree = 501, importance = TRUE)

print(kcFC_rf.1)

plot(kcFC_rf.1)

varImpPlot(kcFC_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
kcFC_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(kcFC_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(kcFC_rf.5)

plot(kcFC_rf.5)

varImpPlot(kcFC_rf.5)

kcFC_predict_fit.rf.5 <- data.frame(fits = predict(kcFC_rf.5, kcFC_test, type = "prob")[,2], actuals = kcFC_test$hit)

kcFC_pred.rf.5 <- prediction(kcFC_predict_fit.rf.5$fits, kcFC_predict_fit.rf.5$actuals)

kcFC_roc.pred.rf.5 <- performance(kcFC_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(kcFC_roc.pred.rf.5)
abline(a = 0, b = 1)
kcFC_opt <- opt.cut(kcFC_roc.pred.rf.5, kcFC_pred.rf.5)
kcFC_opt
kcFC_opt <- kcFC_opt[3]
kcFC_predict_fit.rf.5$fits <- with(kcFC_predict_fit.rf.5, ifelse(fits > kcFC_opt, 1, 0)) 

str(kcFC_test)

#kcFC_test$fieldingTeam <- as.character(kcFC_test$fieldingTeam)
#kcFC_test$home_team <- as.character(kcFC_test$home_team)
#kcFC_test$hit <- as.logical(kcFC_test$hit)
#kcFC_test$stand <- as.logical(kcFC_test$stand)
str(kcFC_test)
kcFC_rf.5_confusion_test <- confusionMatrix(model = kcFC_rf.5, x = kcFC_test, y = kcFC_test$hit)
kcFC_rf.5_confusion_validate <- confusionMatrix(model = kcFC_rf.5, x = kcFC_validate, y = kcFC_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


kcFC_test_rows <- kcFC_test$row
kcFC_validate_rows <- kcFC_validate$row
kcFC_pred_data_emp_1 <- ungroup(kcFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFC_test_rows)

kcFC_pred_data_emp <- ungroup(kcFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFC_validate_rows) %>%
	rbind(kcFC_pred_data_emp_1)

kcFC_out_of_training_rows <- kcFC_pred_data_emp$row

kcFC_rf.5_full_out_of_sample_data <- ungroup(kcFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFC_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



kcFC_rf.5_full_out_of_sample_data_scaled <- kcFC_rf.5_full_out_of_sample_data

kcFC_rf.5_full_out_of_sample_data_scaled$hit_speed <- (kcFC_rf.5_full_out_of_sample_data_scaled$hit_speed - kcFC_center_values[2]) / kcFC_scale_values[2]

kcFC_rf.5_full_out_of_sample_data_scaled$hit_angle <- (kcFC_rf.5_full_out_of_sample_data_scaled$hit_angle - kcFC_center_values[3]) / kcFC_scale_values[3]

kcFC_rf.5.prob <- predict(kcFC_rf.5, kcFC_rf.5_full_out_of_sample_data_scaled, type = "response")

kcFC_rf.5_full_out_of_sample_data <- cbind(filter(kcFC_rf.5_full_out_of_sample_data, row %in% kcFC_out_of_training_rows), kcFC_rf.5.prob)

names(kcFC_rf.5_full_out_of_sample_data)[65] <- "fits"
names(kcFC_rf.5_full_out_of_sample_data)

kcFC_rf.5_full_out_of_sample_data_reduced <- kcFC_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

kcFC_rf.5_mean_table <- kcFC_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

kcFC_rf.5_full_out_of_sample_data$type <- with(kcFC_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

kcFC_rf.5_full_out_of_sample_data$hit_label <- with(kcFC_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

kcFC_rf.5_plot1 <- ggplot(kcFC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcFC_rf.5_plot1

kcFC_rf.5_plot2 <- ggplot(kcFC_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcFC_rf.5_plot2

kcFC_rf.5_plot3 <- ggplot(kcFC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcFC_rf.5_plot3

kcFC_grid_plot_rf.5 <- grid.arrange(kcFC_rf.5_plot1, kcFC_rf.5_plot2, kcFC_rf.5_plot3, ncol = 3)
kcFC_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

kcFC_test_rows <- kcFC_test$row
kcFC_validate_rows <- kcFC_validate$row
kcFC_pred_data_emp_1 <- ungroup(kcFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFC_test_rows)

kcFC_pred_data_emp <- ungroup(kcFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFC_validate_rows) %>%
	rbind(kcFC_pred_data_emp_1)

kcFC_out_of_training_rows <- kcFC_pred_data_emp$row

kcFC_pred_data_emp <- ungroup(kcFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFC_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

kcFC_pred_data_emp_scaled <- kcFC_pred_data_emp

kcFC_pred_data_emp_scaled$hit_speed <- (kcFC_pred_data_emp_scaled$hit_speed - kcFC_center_values[2]) / kcFC_scale_values[2]

kcFC_pred_data_emp_scaled$hit_angle <- (kcFC_pred_data_emp_scaled$hit_angle - kcFC_center_values[3]) / kcFC_scale_values[3]

kcFC_pred_prob_hit <- predict(kcFC_rf.5, kcFC_pred_data_emp_scaled, type = "prob")[,2]
kcFC_pred_prob_hit_fits <- cbind(kcFC_pred_data_emp, kcFC_pred_prob_hit)

kcFC_pred_prob_hit_fits[,c(1:2)] <- kcFC_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

kcFC_angle_speed_pred <- kcFC_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = kcFC_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nKC-FC Hit Probability\n") + theme_bp_grey()

kcFC_angle_speed_pred
#####
fsFC$hit_distance_sc <- as.numeric(fsFC$hit_distance_sc, na.rm = TRUE)
fsFC$hit_angle <- as.numeric(fsFC$hit_angle, na.rm = TRUE)
fsFC$hit_speed <- as.numeric(fsFC$hit_speed, na.rm = TRUE)

fsFC$hit <- with(fsFC, ifelse(grepl("Single", fsFC$events), 1,
															ifelse(grepl("Double", fsFC$events), 1,
																		 ifelse(grepl("Triple", fsFC$events), 1, 
																		 			 ifelse(grepl("Home Run", fsFC$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

fsFC$fieldingTeam <- with(fsFC, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[fsFC$hit_distance_sc == "null"] = NA
#fsFC$hit_speed[fsFC$hit_speed == "null"] = NA
#fsFC$hit_angle[fsFC$hit_angle == "null"] = NA

# include row names for unique record identification

fsFC$row <- row.names(fsFC) %>% as.numeric()

# recode stand and home_team as factors

fsFC$stand <- as.factor(fsFC$stand)
fsFC$home_team <- as.factor(fsFC$home_team)


fsFC$game_date <- as.Date(fsFC$game_date)


# subset 

fsFC_working_data <- ungroup(fsFC) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(fsFC_working_data)
str(ungroup(fsFC))
table(fsFC_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

fsFC_working_data <- filter(fsFC_working_data, hc_x != 1, hc_y != 1)
head(fsFC_working_data)

# create training and test sets
# scaled data

set.seed(42)
fsFC_train <- sample_frac(fsFC_working_data, .15, replace = FALSE)
fsFC_split <- setdiff(fsFC_working_data, fsFC_train)
fsFC_test <- sample_frac(fsFC_split, .50, replace = FALSE)
fsFC_validate <- setdiff(fsFC_split, fsFC_test)

nrow(fsFC_train) + nrow(fsFC_test) + nrow(fsFC_validate) == nrow(fsFC_working_data)

with(fsFC_train, table(hit)) %>% prop.table()
with(fsFC_test, table(hit)) %>% prop.table()
with(fsFC_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(fsFC)
##as.numeric(fsFC$hit_distance_sc, fsFC$hit_speed, fsFC$hit_angle)

#fsFC_train$hit_distance_sc <- as.numeric(fsFC_train$hit_distance_sc)
#fsFC_train$hit_speed <- as.numeric(fsFC_train$hit_speed)
#fsFC_train$hit_angle <- as.numeric(fsFC_train$hit_angle)
#View(fsFC_train)
fsFC_scaled_data <- scale(fsFC_train[,c(1:5)])
fsFC_scale_values <- attr(fsFC_scaled_data, 'scaled:scale')
fsFC_scale_values
fsFC_center_values <- attr(fsFC_scaled_data, 'scaled:center')
fsFC_center_values
fsFC_train <- cbind(fsFC_scaled_data, select(fsFC_train, hit:row))

# save levels for factor variables
fsFC_levels_home_team <- levels(fsFC_train$home_team)
fsFC_levels_stand <- levels(fsFC_train$stand)
fsFC_levels_fieldingTeam <- levels(fsFC_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(fsFC_test)

fsFC_test$hit_distance_sc <- (fsFC_test$hit_distance_sc - fsFC_center_values[1]) / fsFC_scale_values[1]

fsFC_test$hit_speed <- (fsFC_test$hit_speed - fsFC_center_values[2]) / fsFC_scale_values[2]

fsFC_test$hit_angle <- (fsFC_test$hit_angle - fsFC_center_values[3]) / fsFC_scale_values[3]

fsFC_test$hc_x <- (fsFC_test$hc_x - fsFC_center_values[4]) / fsFC_scale_values[4]

fsFC_test$hc_y <- (fsFC_test$hc_y - fsFC_center_values[5]) / fsFC_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

fsFC_validate$hit_distance_sc <- (fsFC_validate$hit_distance_sc - fsFC_center_values[1]) / fsFC_scale_values[1]

fsFC_validate$hit_speed <- (fsFC_validate$hit_speed - fsFC_center_values[2]) / fsFC_scale_values[2]

fsFC_validate$hit_angle <- (fsFC_validate$hit_angle - fsFC_center_values[3]) / fsFC_scale_values[3]

fsFC_validate$hc_x <- (fsFC_validate$hc_x - fsFC_center_values[4]) / fsFC_scale_values[4]

fsFC_validate$hc_y <- (fsFC_validate$hc_y - fsFC_center_values[5]) / fsFC_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(fsFC_train)

set.seed(42)
fsFC_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(fsFC_train, -row), ntree = 501, importance = TRUE)

print(fsFC_rf.1)

plot(fsFC_rf.1)

varImpPlot(fsFC_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
fsFC_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(fsFC_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(fsFC_rf.5)

plot(fsFC_rf.5)

varImpPlot(fsFC_rf.5)

fsFC_predict_fit.rf.5 <- data.frame(fits = predict(fsFC_rf.5, fsFC_test, type = "prob")[,2], actuals = fsFC_test$hit)

fsFC_pred.rf.5 <- prediction(fsFC_predict_fit.rf.5$fits, fsFC_predict_fit.rf.5$actuals)

fsFC_roc.pred.rf.5 <- performance(fsFC_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(fsFC_roc.pred.rf.5)
abline(a = 0, b = 1)
fsFC_opt <- opt.cut(fsFC_roc.pred.rf.5, fsFC_pred.rf.5)
fsFC_opt
fsFC_opt <- fsFC_opt[3]
fsFC_predict_fit.rf.5$fits <- with(fsFC_predict_fit.rf.5, ifelse(fits > fsFC_opt, 1, 0)) 

str(fsFC_test)

#fsFC_test$fieldingTeam <- as.character(fsFC_test$fieldingTeam)
#fsFC_test$home_team <- as.character(fsFC_test$home_team)
#fsFC_test$hit <- as.logical(fsFC_test$hit)
#fsFC_test$stand <- as.logical(fsFC_test$stand)
str(fsFC_test)
fsFC_rf.5_confusion_test <- confusionMatrix(model = fsFC_rf.5, x = fsFC_test, y = fsFC_test$hit)
fsFC_rf.5_confusion_validate <- confusionMatrix(model = fsFC_rf.5, x = fsFC_validate, y = fsFC_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


fsFC_test_rows <- fsFC_test$row
fsFC_validate_rows <- fsFC_validate$row
fsFC_pred_data_emp_1 <- ungroup(fsFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsFC_test_rows)

fsFC_pred_data_emp <- ungroup(fsFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsFC_validate_rows) %>%
	rbind(fsFC_pred_data_emp_1)

fsFC_out_of_training_rows <- fsFC_pred_data_emp$row

fsFC_rf.5_full_out_of_sample_data <- ungroup(fsFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsFC_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



fsFC_rf.5_full_out_of_sample_data_scaled <- fsFC_rf.5_full_out_of_sample_data

fsFC_rf.5_full_out_of_sample_data_scaled$hit_speed <- (fsFC_rf.5_full_out_of_sample_data_scaled$hit_speed - fsFC_center_values[2]) / fsFC_scale_values[2]

fsFC_rf.5_full_out_of_sample_data_scaled$hit_angle <- (fsFC_rf.5_full_out_of_sample_data_scaled$hit_angle - fsFC_center_values[3]) / fsFC_scale_values[3]

fsFC_rf.5.prob <- predict(fsFC_rf.5, fsFC_rf.5_full_out_of_sample_data_scaled, type = "response")

fsFC_rf.5_full_out_of_sample_data <- cbind(filter(fsFC_rf.5_full_out_of_sample_data, row %in% fsFC_out_of_training_rows), fsFC_rf.5.prob)

names(fsFC_rf.5_full_out_of_sample_data)[65] <- "fits"
names(fsFC_rf.5_full_out_of_sample_data)

fsFC_rf.5_full_out_of_sample_data_reduced <- fsFC_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

fsFC_rf.5_mean_table <- fsFC_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

fsFC_rf.5_full_out_of_sample_data$type <- with(fsFC_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

fsFC_rf.5_full_out_of_sample_data$hit_label <- with(fsFC_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

fsFC_rf.5_plot1 <- ggplot(fsFC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsFC_rf.5_plot1

fsFC_rf.5_plot2 <- ggplot(fsFC_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsFC_rf.5_plot2

fsFC_rf.5_plot3 <- ggplot(fsFC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsFC_rf.5_plot3

fsFC_grid_plot_rf.5 <- grid.arrange(fsFC_rf.5_plot1, fsFC_rf.5_plot2, fsFC_rf.5_plot3, ncol = 3)
fsFC_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

fsFC_test_rows <- fsFC_test$row
fsFC_validate_rows <- fsFC_validate$row
fsFC_pred_data_emp_1 <- ungroup(fsFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsFC_test_rows)

fsFC_pred_data_emp <- ungroup(fsFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsFC_validate_rows) %>%
	rbind(fsFC_pred_data_emp_1)

fsFC_out_of_training_rows <- fsFC_pred_data_emp$row

fsFC_pred_data_emp <- ungroup(fsFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsFC_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

fsFC_pred_data_emp_scaled <- fsFC_pred_data_emp

fsFC_pred_data_emp_scaled$hit_speed <- (fsFC_pred_data_emp_scaled$hit_speed - fsFC_center_values[2]) / fsFC_scale_values[2]

fsFC_pred_data_emp_scaled$hit_angle <- (fsFC_pred_data_emp_scaled$hit_angle - fsFC_center_values[3]) / fsFC_scale_values[3]

fsFC_pred_prob_hit <- predict(fsFC_rf.5, fsFC_pred_data_emp_scaled, type = "prob")[,2]
fsFC_pred_prob_hit_fits <- cbind(fsFC_pred_data_emp, fsFC_pred_prob_hit)

fsFC_pred_prob_hit_fits[,c(1:2)] <- fsFC_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

fsFC_angle_speed_pred <- fsFC_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = fsFC_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFS-FC Hit Probability\n") + theme_bp_grey()

fsFC_angle_speed_pred
#####
chFC$hit_distance_sc <- as.numeric(chFC$hit_distance_sc, na.rm = TRUE)
chFC$hit_angle <- as.numeric(chFC$hit_angle, na.rm = TRUE)
chFC$hit_speed <- as.numeric(chFC$hit_speed, na.rm = TRUE)

chFC$hit <- with(chFC, ifelse(grepl("Single", chFC$events), 1,
															ifelse(grepl("Double", chFC$events), 1,
																		 ifelse(grepl("Triple", chFC$events), 1, 
																		 			 ifelse(grepl("Home Run", chFC$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

chFC$fieldingTeam <- with(chFC, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[chFC$hit_distance_sc == "null"] = NA
#chFC$hit_speed[chFC$hit_speed == "null"] = NA
#chFC$hit_angle[chFC$hit_angle == "null"] = NA

# include row names for unique record identification

chFC$row <- row.names(chFC) %>% as.numeric()

# recode stand and home_team as factors

chFC$stand <- as.factor(chFC$stand)
chFC$home_team <- as.factor(chFC$home_team)


chFC$game_date <- as.Date(chFC$game_date)


# subset 

chFC_working_data <- ungroup(chFC) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(chFC_working_data)
str(ungroup(chFC))
table(chFC_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

chFC_working_data <- filter(chFC_working_data, hc_x != 1, hc_y != 1)
head(chFC_working_data)

# create training and test sets
# scaled data

set.seed(42)
chFC_train <- sample_frac(chFC_working_data, .15, replace = FALSE)
chFC_split <- setdiff(chFC_working_data, chFC_train)
chFC_test <- sample_frac(chFC_split, .50, replace = FALSE)
chFC_validate <- setdiff(chFC_split, chFC_test)

nrow(chFC_train) + nrow(chFC_test) + nrow(chFC_validate) == nrow(chFC_working_data)

with(chFC_train, table(hit)) %>% prop.table()
with(chFC_test, table(hit)) %>% prop.table()
with(chFC_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(chFC)
##as.numeric(chFC$hit_distance_sc, chFC$hit_speed, chFC$hit_angle)

#chFC_train$hit_distance_sc <- as.numeric(chFC_train$hit_distance_sc)
#chFC_train$hit_speed <- as.numeric(chFC_train$hit_speed)
#chFC_train$hit_angle <- as.numeric(chFC_train$hit_angle)
#View(chFC_train)
chFC_scaled_data <- scale(chFC_train[,c(1:5)])
chFC_scale_values <- attr(chFC_scaled_data, 'scaled:scale')
chFC_scale_values
chFC_center_values <- attr(chFC_scaled_data, 'scaled:center')
chFC_center_values
chFC_train <- cbind(chFC_scaled_data, select(chFC_train, hit:row))

# save levels for factor variables
chFC_levels_home_team <- levels(chFC_train$home_team)
chFC_levels_stand <- levels(chFC_train$stand)
chFC_levels_fieldingTeam <- levels(chFC_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(chFC_test)

chFC_test$hit_distance_sc <- (chFC_test$hit_distance_sc - chFC_center_values[1]) / chFC_scale_values[1]

chFC_test$hit_speed <- (chFC_test$hit_speed - chFC_center_values[2]) / chFC_scale_values[2]

chFC_test$hit_angle <- (chFC_test$hit_angle - chFC_center_values[3]) / chFC_scale_values[3]

chFC_test$hc_x <- (chFC_test$hc_x - chFC_center_values[4]) / chFC_scale_values[4]

chFC_test$hc_y <- (chFC_test$hc_y - chFC_center_values[5]) / chFC_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

chFC_validate$hit_distance_sc <- (chFC_validate$hit_distance_sc - chFC_center_values[1]) / chFC_scale_values[1]

chFC_validate$hit_speed <- (chFC_validate$hit_speed - chFC_center_values[2]) / chFC_scale_values[2]

chFC_validate$hit_angle <- (chFC_validate$hit_angle - chFC_center_values[3]) / chFC_scale_values[3]

chFC_validate$hc_x <- (chFC_validate$hc_x - chFC_center_values[4]) / chFC_scale_values[4]

chFC_validate$hc_y <- (chFC_validate$hc_y - chFC_center_values[5]) / chFC_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(chFC_train)

set.seed(42)
chFC_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(chFC_train, -row), ntree = 501, importance = TRUE)

print(chFC_rf.1)

plot(chFC_rf.1)

varImpPlot(chFC_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
chFC_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(chFC_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(chFC_rf.5)

plot(chFC_rf.5)

varImpPlot(chFC_rf.5)

chFC_predict_fit.rf.5 <- data.frame(fits = predict(chFC_rf.5, chFC_test, type = "prob")[,2], actuals = chFC_test$hit)

chFC_pred.rf.5 <- prediction(chFC_predict_fit.rf.5$fits, chFC_predict_fit.rf.5$actuals)

chFC_roc.pred.rf.5 <- performance(chFC_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(chFC_roc.pred.rf.5)
abline(a = 0, b = 1)
chFC_opt <- opt.cut(chFC_roc.pred.rf.5, chFC_pred.rf.5)
chFC_opt
chFC_opt <- chFC_opt[3]
chFC_predict_fit.rf.5$fits <- with(chFC_predict_fit.rf.5, ifelse(fits > chFC_opt, 1, 0)) 

str(chFC_test)

#chFC_test$fieldingTeam <- as.character(chFC_test$fieldingTeam)
#chFC_test$home_team <- as.character(chFC_test$home_team)
#chFC_test$hit <- as.logical(chFC_test$hit)
#chFC_test$stand <- as.logical(chFC_test$stand)
str(chFC_test)
chFC_rf.5_confusion_test <- confusionMatrix(model = chFC_rf.5, x = chFC_test, y = chFC_test$hit)
chFC_rf.5_confusion_validate <- confusionMatrix(model = chFC_rf.5, x = chFC_validate, y = chFC_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


chFC_test_rows <- chFC_test$row
chFC_validate_rows <- chFC_validate$row
chFC_pred_data_emp_1 <- ungroup(chFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFC_test_rows)

chFC_pred_data_emp <- ungroup(chFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFC_validate_rows) %>%
	rbind(chFC_pred_data_emp_1)

chFC_out_of_training_rows <- chFC_pred_data_emp$row

chFC_rf.5_full_out_of_sample_data <- ungroup(chFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFC_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



chFC_rf.5_full_out_of_sample_data_scaled <- chFC_rf.5_full_out_of_sample_data

chFC_rf.5_full_out_of_sample_data_scaled$hit_speed <- (chFC_rf.5_full_out_of_sample_data_scaled$hit_speed - chFC_center_values[2]) / chFC_scale_values[2]

chFC_rf.5_full_out_of_sample_data_scaled$hit_angle <- (chFC_rf.5_full_out_of_sample_data_scaled$hit_angle - chFC_center_values[3]) / chFC_scale_values[3]

chFC_rf.5.prob <- predict(chFC_rf.5, chFC_rf.5_full_out_of_sample_data_scaled, type = "response")

chFC_rf.5_full_out_of_sample_data <- cbind(filter(chFC_rf.5_full_out_of_sample_data, row %in% chFC_out_of_training_rows), chFC_rf.5.prob)

names(chFC_rf.5_full_out_of_sample_data)[65] <- "fits"
names(chFC_rf.5_full_out_of_sample_data)

chFC_rf.5_full_out_of_sample_data_reduced <- chFC_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

chFC_rf.5_mean_table <- chFC_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

chFC_rf.5_full_out_of_sample_data$type <- with(chFC_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

chFC_rf.5_full_out_of_sample_data$hit_label <- with(chFC_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

chFC_rf.5_plot1 <- ggplot(chFC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chFC_rf.5_plot1

chFC_rf.5_plot2 <- ggplot(chFC_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chFC_rf.5_plot2

chFC_rf.5_plot3 <- ggplot(chFC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chFC_rf.5_plot3

chFC_grid_plot_rf.5 <- grid.arrange(chFC_rf.5_plot1, chFC_rf.5_plot2, chFC_rf.5_plot3, ncol = 3)
chFC_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

chFC_test_rows <- chFC_test$row
chFC_validate_rows <- chFC_validate$row
chFC_pred_data_emp_1 <- ungroup(chFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFC_test_rows)

chFC_pred_data_emp <- ungroup(chFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFC_validate_rows) %>%
	rbind(chFC_pred_data_emp_1)

chFC_out_of_training_rows <- chFC_pred_data_emp$row

chFC_pred_data_emp <- ungroup(chFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFC_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

chFC_pred_data_emp_scaled <- chFC_pred_data_emp

chFC_pred_data_emp_scaled$hit_speed <- (chFC_pred_data_emp_scaled$hit_speed - chFC_center_values[2]) / chFC_scale_values[2]

chFC_pred_data_emp_scaled$hit_angle <- (chFC_pred_data_emp_scaled$hit_angle - chFC_center_values[3]) / chFC_scale_values[3]

chFC_pred_prob_hit <- predict(chFC_rf.5, chFC_pred_data_emp_scaled, type = "prob")[,2]
chFC_pred_prob_hit_fits <- cbind(chFC_pred_data_emp, chFC_pred_prob_hit)

chFC_pred_prob_hit_fits[,c(1:2)] <- chFC_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

chFC_angle_speed_pred <- chFC_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = chFC_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nCH-FC Hit Probability\n") + theme_bp_grey()

chFC_angle_speed_pred
#####
ftFC$hit_distance_sc <- as.numeric(ftFC$hit_distance_sc, na.rm = TRUE)
ftFC$hit_angle <- as.numeric(ftFC$hit_angle, na.rm = TRUE)
ftFC$hit_speed <- as.numeric(ftFC$hit_speed, na.rm = TRUE)

ftFC$hit <- with(ftFC, ifelse(grepl("Single", ftFC$events), 1,
															ifelse(grepl("Double", ftFC$events), 1,
																		 ifelse(grepl("Triple", ftFC$events), 1, 
																		 			 ifelse(grepl("Home Run", ftFC$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

ftFC$fieldingTeam <- with(ftFC, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[ftFC$hit_distance_sc == "null"] = NA
#ftFC$hit_speed[ftFC$hit_speed == "null"] = NA
#ftFC$hit_angle[ftFC$hit_angle == "null"] = NA

# include row names for unique record identification

ftFC$row <- row.names(ftFC) %>% as.numeric()

# recode stand and home_team as factors

ftFC$stand <- as.factor(ftFC$stand)
ftFC$home_team <- as.factor(ftFC$home_team)


ftFC$game_date <- as.Date(ftFC$game_date)


# subset 

ftFC_working_data <- ungroup(ftFC) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(ftFC_working_data)
str(ungroup(ftFC))
table(ftFC_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

ftFC_working_data <- filter(ftFC_working_data, hc_x != 1, hc_y != 1)
head(ftFC_working_data)

# create training and test sets
# scaled data

set.seed(42)
ftFC_train <- sample_frac(ftFC_working_data, .15, replace = FALSE)
ftFC_split <- setdiff(ftFC_working_data, ftFC_train)
ftFC_test <- sample_frac(ftFC_split, .50, replace = FALSE)
ftFC_validate <- setdiff(ftFC_split, ftFC_test)

nrow(ftFC_train) + nrow(ftFC_test) + nrow(ftFC_validate) == nrow(ftFC_working_data)

with(ftFC_train, table(hit)) %>% prop.table()
with(ftFC_test, table(hit)) %>% prop.table()
with(ftFC_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(ftFC)
##as.numeric(ftFC$hit_distance_sc, ftFC$hit_speed, ftFC$hit_angle)

#ftFC_train$hit_distance_sc <- as.numeric(ftFC_train$hit_distance_sc)
#ftFC_train$hit_speed <- as.numeric(ftFC_train$hit_speed)
#ftFC_train$hit_angle <- as.numeric(ftFC_train$hit_angle)
#View(ftFC_train)
ftFC_scaled_data <- scale(ftFC_train[,c(1:5)])
ftFC_scale_values <- attr(ftFC_scaled_data, 'scaled:scale')
ftFC_scale_values
ftFC_center_values <- attr(ftFC_scaled_data, 'scaled:center')
ftFC_center_values
ftFC_train <- cbind(ftFC_scaled_data, select(ftFC_train, hit:row))

# save levels for factor variables
ftFC_levels_home_team <- levels(ftFC_train$home_team)
ftFC_levels_stand <- levels(ftFC_train$stand)
ftFC_levels_fieldingTeam <- levels(ftFC_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(ftFC_test)

ftFC_test$hit_distance_sc <- (ftFC_test$hit_distance_sc - ftFC_center_values[1]) / ftFC_scale_values[1]

ftFC_test$hit_speed <- (ftFC_test$hit_speed - ftFC_center_values[2]) / ftFC_scale_values[2]

ftFC_test$hit_angle <- (ftFC_test$hit_angle - ftFC_center_values[3]) / ftFC_scale_values[3]

ftFC_test$hc_x <- (ftFC_test$hc_x - ftFC_center_values[4]) / ftFC_scale_values[4]

ftFC_test$hc_y <- (ftFC_test$hc_y - ftFC_center_values[5]) / ftFC_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

ftFC_validate$hit_distance_sc <- (ftFC_validate$hit_distance_sc - ftFC_center_values[1]) / ftFC_scale_values[1]

ftFC_validate$hit_speed <- (ftFC_validate$hit_speed - ftFC_center_values[2]) / ftFC_scale_values[2]

ftFC_validate$hit_angle <- (ftFC_validate$hit_angle - ftFC_center_values[3]) / ftFC_scale_values[3]

ftFC_validate$hc_x <- (ftFC_validate$hc_x - ftFC_center_values[4]) / ftFC_scale_values[4]

ftFC_validate$hc_y <- (ftFC_validate$hc_y - ftFC_center_values[5]) / ftFC_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(ftFC_train)

set.seed(42)
ftFC_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(ftFC_train, -row), ntree = 501, importance = TRUE)

print(ftFC_rf.1)

plot(ftFC_rf.1)

varImpPlot(ftFC_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
ftFC_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(ftFC_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(ftFC_rf.5)

plot(ftFC_rf.5)

varImpPlot(ftFC_rf.5)

ftFC_predict_fit.rf.5 <- data.frame(fits = predict(ftFC_rf.5, ftFC_test, type = "prob")[,2], actuals = ftFC_test$hit)

ftFC_pred.rf.5 <- prediction(ftFC_predict_fit.rf.5$fits, ftFC_predict_fit.rf.5$actuals)

ftFC_roc.pred.rf.5 <- performance(ftFC_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(ftFC_roc.pred.rf.5)
abline(a = 0, b = 1)
ftFC_opt <- opt.cut(ftFC_roc.pred.rf.5, ftFC_pred.rf.5)
ftFC_opt
ftFC_opt <- ftFC_opt[3]
ftFC_predict_fit.rf.5$fits <- with(ftFC_predict_fit.rf.5, ifelse(fits > ftFC_opt, 1, 0)) 

str(ftFC_test)

#ftFC_test$fieldingTeam <- as.character(ftFC_test$fieldingTeam)
#ftFC_test$home_team <- as.character(ftFC_test$home_team)
#ftFC_test$hit <- as.logical(ftFC_test$hit)
#ftFC_test$stand <- as.logical(ftFC_test$stand)
str(ftFC_test)
ftFC_rf.5_confusion_test <- confusionMatrix(model = ftFC_rf.5, x = ftFC_test, y = ftFC_test$hit)
ftFC_rf.5_confusion_validate <- confusionMatrix(model = ftFC_rf.5, x = ftFC_validate, y = ftFC_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


ftFC_test_rows <- ftFC_test$row
ftFC_validate_rows <- ftFC_validate$row
ftFC_pred_data_emp_1 <- ungroup(ftFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftFC_test_rows)

ftFC_pred_data_emp <- ungroup(ftFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftFC_validate_rows) %>%
	rbind(ftFC_pred_data_emp_1)

ftFC_out_of_training_rows <- ftFC_pred_data_emp$row

ftFC_rf.5_full_out_of_sample_data <- ungroup(ftFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftFC_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



ftFC_rf.5_full_out_of_sample_data_scaled <- ftFC_rf.5_full_out_of_sample_data

ftFC_rf.5_full_out_of_sample_data_scaled$hit_speed <- (ftFC_rf.5_full_out_of_sample_data_scaled$hit_speed - ftFC_center_values[2]) / ftFC_scale_values[2]

ftFC_rf.5_full_out_of_sample_data_scaled$hit_angle <- (ftFC_rf.5_full_out_of_sample_data_scaled$hit_angle - ftFC_center_values[3]) / ftFC_scale_values[3]

ftFC_rf.5.prob <- predict(ftFC_rf.5, ftFC_rf.5_full_out_of_sample_data_scaled, type = "response")

ftFC_rf.5_full_out_of_sample_data <- cbind(filter(ftFC_rf.5_full_out_of_sample_data, row %in% ftFC_out_of_training_rows), ftFC_rf.5.prob)

names(ftFC_rf.5_full_out_of_sample_data)[65] <- "fits"
names(ftFC_rf.5_full_out_of_sample_data)

ftFC_rf.5_full_out_of_sample_data_reduced <- ftFC_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

ftFC_rf.5_mean_table <- ftFC_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

ftFC_rf.5_full_out_of_sample_data$type <- with(ftFC_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

ftFC_rf.5_full_out_of_sample_data$hit_label <- with(ftFC_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

ftFC_rf.5_plot1 <- ggplot(ftFC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftFC_rf.5_plot1

ftFC_rf.5_plot2 <- ggplot(ftFC_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftFC_rf.5_plot2

ftFC_rf.5_plot3 <- ggplot(ftFC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftFC_rf.5_plot3

ftFC_grid_plot_rf.5 <- grid.arrange(ftFC_rf.5_plot1, ftFC_rf.5_plot2, ftFC_rf.5_plot3, ncol = 3)
ftFC_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

ftFC_test_rows <- ftFC_test$row
ftFC_validate_rows <- ftFC_validate$row
ftFC_pred_data_emp_1 <- ungroup(ftFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftFC_test_rows)

ftFC_pred_data_emp <- ungroup(ftFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftFC_validate_rows) %>%
	rbind(ftFC_pred_data_emp_1)

ftFC_out_of_training_rows <- ftFC_pred_data_emp$row

ftFC_pred_data_emp <- ungroup(ftFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftFC_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

ftFC_pred_data_emp_scaled <- ftFC_pred_data_emp

ftFC_pred_data_emp_scaled$hit_speed <- (ftFC_pred_data_emp_scaled$hit_speed - ftFC_center_values[2]) / ftFC_scale_values[2]

ftFC_pred_data_emp_scaled$hit_angle <- (ftFC_pred_data_emp_scaled$hit_angle - ftFC_center_values[3]) / ftFC_scale_values[3]

ftFC_pred_prob_hit <- predict(ftFC_rf.5, ftFC_pred_data_emp_scaled, type = "prob")[,2]
ftFC_pred_prob_hit_fits <- cbind(ftFC_pred_data_emp, ftFC_pred_prob_hit)

ftFC_pred_prob_hit_fits[,c(1:2)] <- ftFC_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

ftFC_angle_speed_pred <- ftFC_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = ftFC_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFT-FC Hit Probability\n") + theme_bp_grey()

ftFC_angle_speed_pred
#####
slFC$hit_distance_sc <- as.numeric(slFC$hit_distance_sc, na.rm = TRUE)
slFC$hit_angle <- as.numeric(slFC$hit_angle, na.rm = TRUE)
slFC$hit_speed <- as.numeric(slFC$hit_speed, na.rm = TRUE)

slFC$hit <- with(slFC, ifelse(grepl("Single", slFC$events), 1,
															ifelse(grepl("Double", slFC$events), 1,
																		 ifelse(grepl("Triple", slFC$events), 1, 
																		 			 ifelse(grepl("Home Run", slFC$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

slFC$fieldingTeam <- with(slFC, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[slFC$hit_distance_sc == "null"] = NA
#slFC$hit_speed[slFC$hit_speed == "null"] = NA
#slFC$hit_angle[slFC$hit_angle == "null"] = NA

# include row names for unique record identification

slFC$row <- row.names(slFC) %>% as.numeric()

# recode stand and home_team as factors

slFC$stand <- as.factor(slFC$stand)
slFC$home_team <- as.factor(slFC$home_team)


slFC$game_date <- as.Date(slFC$game_date)


# subset 

slFC_working_data <- ungroup(slFC) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(slFC_working_data)
str(ungroup(slFC))
table(slFC_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

slFC_working_data <- filter(slFC_working_data, hc_x != 1, hc_y != 1)
head(slFC_working_data)

# create training and test sets
# scaled data

set.seed(42)
slFC_train <- sample_frac(slFC_working_data, .15, replace = FALSE)
slFC_split <- setdiff(slFC_working_data, slFC_train)
slFC_test <- sample_frac(slFC_split, .50, replace = FALSE)
slFC_validate <- setdiff(slFC_split, slFC_test)

nrow(slFC_train) + nrow(slFC_test) + nrow(slFC_validate) == nrow(slFC_working_data)

with(slFC_train, table(hit)) %>% prop.table()
with(slFC_test, table(hit)) %>% prop.table()
with(slFC_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(slFC)
##as.numeric(slFC$hit_distance_sc, slFC$hit_speed, slFC$hit_angle)

#slFC_train$hit_distance_sc <- as.numeric(slFC_train$hit_distance_sc)
#slFC_train$hit_speed <- as.numeric(slFC_train$hit_speed)
#slFC_train$hit_angle <- as.numeric(slFC_train$hit_angle)
#View(slFC_train)
slFC_scaled_data <- scale(slFC_train[,c(1:5)])
slFC_scale_values <- attr(slFC_scaled_data, 'scaled:scale')
slFC_scale_values
slFC_center_values <- attr(slFC_scaled_data, 'scaled:center')
slFC_center_values
slFC_train <- cbind(slFC_scaled_data, select(slFC_train, hit:row))

# save levels for factor variables
slFC_levels_home_team <- levels(slFC_train$home_team)
slFC_levels_stand <- levels(slFC_train$stand)
slFC_levels_fieldingTeam <- levels(slFC_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(slFC_test)

slFC_test$hit_distance_sc <- (slFC_test$hit_distance_sc - slFC_center_values[1]) / slFC_scale_values[1]

slFC_test$hit_speed <- (slFC_test$hit_speed - slFC_center_values[2]) / slFC_scale_values[2]

slFC_test$hit_angle <- (slFC_test$hit_angle - slFC_center_values[3]) / slFC_scale_values[3]

slFC_test$hc_x <- (slFC_test$hc_x - slFC_center_values[4]) / slFC_scale_values[4]

slFC_test$hc_y <- (slFC_test$hc_y - slFC_center_values[5]) / slFC_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

slFC_validate$hit_distance_sc <- (slFC_validate$hit_distance_sc - slFC_center_values[1]) / slFC_scale_values[1]

slFC_validate$hit_speed <- (slFC_validate$hit_speed - slFC_center_values[2]) / slFC_scale_values[2]

slFC_validate$hit_angle <- (slFC_validate$hit_angle - slFC_center_values[3]) / slFC_scale_values[3]

slFC_validate$hc_x <- (slFC_validate$hc_x - slFC_center_values[4]) / slFC_scale_values[4]

slFC_validate$hc_y <- (slFC_validate$hc_y - slFC_center_values[5]) / slFC_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(slFC_train)

set.seed(42)
slFC_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(slFC_train, -row), ntree = 501, importance = TRUE)

print(slFC_rf.1)

plot(slFC_rf.1)

varImpPlot(slFC_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
slFC_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(slFC_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(slFC_rf.5)

plot(slFC_rf.5)

varImpPlot(slFC_rf.5)

slFC_predict_fit.rf.5 <- data.frame(fits = predict(slFC_rf.5, slFC_test, type = "prob")[,2], actuals = slFC_test$hit)

slFC_pred.rf.5 <- prediction(slFC_predict_fit.rf.5$fits, slFC_predict_fit.rf.5$actuals)

slFC_roc.pred.rf.5 <- performance(slFC_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(slFC_roc.pred.rf.5)
abline(a = 0, b = 1)
slFC_opt <- opt.cut(slFC_roc.pred.rf.5, slFC_pred.rf.5)
slFC_opt
slFC_opt <- slFC_opt[3]
slFC_predict_fit.rf.5$fits <- with(slFC_predict_fit.rf.5, ifelse(fits > slFC_opt, 1, 0)) 

str(slFC_test)

#slFC_test$fieldingTeam <- as.character(slFC_test$fieldingTeam)
#slFC_test$home_team <- as.character(slFC_test$home_team)
#slFC_test$hit <- as.logical(slFC_test$hit)
#slFC_test$stand <- as.logical(slFC_test$stand)
str(slFC_test)
slFC_rf.5_confusion_test <- confusionMatrix(model = slFC_rf.5, x = slFC_test, y = slFC_test$hit)
slFC_rf.5_confusion_validate <- confusionMatrix(model = slFC_rf.5, x = slFC_validate, y = slFC_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


slFC_test_rows <- slFC_test$row
slFC_validate_rows <- slFC_validate$row
slFC_pred_data_emp_1 <- ungroup(slFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFC_test_rows)

slFC_pred_data_emp <- ungroup(slFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFC_validate_rows) %>%
	rbind(slFC_pred_data_emp_1)

slFC_out_of_training_rows <- slFC_pred_data_emp$row

slFC_rf.5_full_out_of_sample_data <- ungroup(slFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFC_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



slFC_rf.5_full_out_of_sample_data_scaled <- slFC_rf.5_full_out_of_sample_data

slFC_rf.5_full_out_of_sample_data_scaled$hit_speed <- (slFC_rf.5_full_out_of_sample_data_scaled$hit_speed - slFC_center_values[2]) / slFC_scale_values[2]

slFC_rf.5_full_out_of_sample_data_scaled$hit_angle <- (slFC_rf.5_full_out_of_sample_data_scaled$hit_angle - slFC_center_values[3]) / slFC_scale_values[3]

slFC_rf.5.prob <- predict(slFC_rf.5, slFC_rf.5_full_out_of_sample_data_scaled, type = "response")

slFC_rf.5_full_out_of_sample_data <- cbind(filter(slFC_rf.5_full_out_of_sample_data, row %in% slFC_out_of_training_rows), slFC_rf.5.prob)

names(slFC_rf.5_full_out_of_sample_data)[65] <- "fits"
names(slFC_rf.5_full_out_of_sample_data)

slFC_rf.5_full_out_of_sample_data_reduced <- slFC_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

slFC_rf.5_mean_table <- slFC_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

slFC_rf.5_full_out_of_sample_data$type <- with(slFC_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

slFC_rf.5_full_out_of_sample_data$hit_label <- with(slFC_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

slFC_rf.5_plot1 <- ggplot(slFC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slFC_rf.5_plot1

slFC_rf.5_plot2 <- ggplot(slFC_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slFC_rf.5_plot2

slFC_rf.5_plot3 <- ggplot(slFC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slFC_rf.5_plot3

slFC_grid_plot_rf.5 <- grid.arrange(slFC_rf.5_plot1, slFC_rf.5_plot2, slFC_rf.5_plot3, ncol = 3)
slFC_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

slFC_test_rows <- slFC_test$row
slFC_validate_rows <- slFC_validate$row
slFC_pred_data_emp_1 <- ungroup(slFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFC_test_rows)

slFC_pred_data_emp <- ungroup(slFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFC_validate_rows) %>%
	rbind(slFC_pred_data_emp_1)

slFC_out_of_training_rows <- slFC_pred_data_emp$row

slFC_pred_data_emp <- ungroup(slFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFC_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

slFC_pred_data_emp_scaled <- slFC_pred_data_emp

slFC_pred_data_emp_scaled$hit_speed <- (slFC_pred_data_emp_scaled$hit_speed - slFC_center_values[2]) / slFC_scale_values[2]

slFC_pred_data_emp_scaled$hit_angle <- (slFC_pred_data_emp_scaled$hit_angle - slFC_center_values[3]) / slFC_scale_values[3]

slFC_pred_prob_hit <- predict(slFC_rf.5, slFC_pred_data_emp_scaled, type = "prob")[,2]
slFC_pred_prob_hit_fits <- cbind(slFC_pred_data_emp, slFC_pred_prob_hit)

slFC_pred_prob_hit_fits[,c(1:2)] <- slFC_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

slFC_angle_speed_pred <- slFC_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = slFC_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nSL-FC Hit Probability\n") + theme_bp_grey()

slFC_angle_speed_pred
#####
cuFC$hit_distance_sc <- as.numeric(cuFC$hit_distance_sc, na.rm = TRUE)
cuFC$hit_angle <- as.numeric(cuFC$hit_angle, na.rm = TRUE)
cuFC$hit_speed <- as.numeric(cuFC$hit_speed, na.rm = TRUE)

cuFC$hit <- with(cuFC, ifelse(grepl("Single", cuFC$events), 1,
															ifelse(grepl("Double", cuFC$events), 1,
																		 ifelse(grepl("Triple", cuFC$events), 1, 
																		 			 ifelse(grepl("Home Run", cuFC$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

cuFC$fieldingTeam <- with(cuFC, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[cuFC$hit_distance_sc == "null"] = NA
#cuFC$hit_speed[cuFC$hit_speed == "null"] = NA
#cuFC$hit_angle[cuFC$hit_angle == "null"] = NA

# include row names for unique record identification

cuFC$row <- row.names(cuFC) %>% as.numeric()

# recode stand and home_team as factors

cuFC$stand <- as.factor(cuFC$stand)
cuFC$home_team <- as.factor(cuFC$home_team)


cuFC$game_date <- as.Date(cuFC$game_date)


# subset 

cuFC_working_data <- ungroup(cuFC) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(cuFC_working_data)
str(ungroup(cuFC))
table(cuFC_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

cuFC_working_data <- filter(cuFC_working_data, hc_x != 1, hc_y != 1)
head(cuFC_working_data)

# create training and test sets
# scaled data

set.seed(42)
cuFC_train <- sample_frac(cuFC_working_data, .15, replace = FALSE)
cuFC_split <- setdiff(cuFC_working_data, cuFC_train)
cuFC_test <- sample_frac(cuFC_split, .50, replace = FALSE)
cuFC_validate <- setdiff(cuFC_split, cuFC_test)

nrow(cuFC_train) + nrow(cuFC_test) + nrow(cuFC_validate) == nrow(cuFC_working_data)

with(cuFC_train, table(hit)) %>% prop.table()
with(cuFC_test, table(hit)) %>% prop.table()
with(cuFC_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(cuFC)
##as.numeric(cuFC$hit_distance_sc, cuFC$hit_speed, cuFC$hit_angle)

#cuFC_train$hit_distance_sc <- as.numeric(cuFC_train$hit_distance_sc)
#cuFC_train$hit_speed <- as.numeric(cuFC_train$hit_speed)
#cuFC_train$hit_angle <- as.numeric(cuFC_train$hit_angle)
#View(cuFC_train)
cuFC_scaled_data <- scale(cuFC_train[,c(1:5)])
cuFC_scale_values <- attr(cuFC_scaled_data, 'scaled:scale')
cuFC_scale_values
cuFC_center_values <- attr(cuFC_scaled_data, 'scaled:center')
cuFC_center_values
cuFC_train <- cbind(cuFC_scaled_data, select(cuFC_train, hit:row))

# save levels for factor variables
cuFC_levels_home_team <- levels(cuFC_train$home_team)
cuFC_levels_stand <- levels(cuFC_train$stand)
cuFC_levels_fieldingTeam <- levels(cuFC_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(cuFC_test)

cuFC_test$hit_distance_sc <- (cuFC_test$hit_distance_sc - cuFC_center_values[1]) / cuFC_scale_values[1]

cuFC_test$hit_speed <- (cuFC_test$hit_speed - cuFC_center_values[2]) / cuFC_scale_values[2]

cuFC_test$hit_angle <- (cuFC_test$hit_angle - cuFC_center_values[3]) / cuFC_scale_values[3]

cuFC_test$hc_x <- (cuFC_test$hc_x - cuFC_center_values[4]) / cuFC_scale_values[4]

cuFC_test$hc_y <- (cuFC_test$hc_y - cuFC_center_values[5]) / cuFC_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

cuFC_validate$hit_distance_sc <- (cuFC_validate$hit_distance_sc - cuFC_center_values[1]) / cuFC_scale_values[1]

cuFC_validate$hit_speed <- (cuFC_validate$hit_speed - cuFC_center_values[2]) / cuFC_scale_values[2]

cuFC_validate$hit_angle <- (cuFC_validate$hit_angle - cuFC_center_values[3]) / cuFC_scale_values[3]

cuFC_validate$hc_x <- (cuFC_validate$hc_x - cuFC_center_values[4]) / cuFC_scale_values[4]

cuFC_validate$hc_y <- (cuFC_validate$hc_y - cuFC_center_values[5]) / cuFC_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(cuFC_train)

set.seed(42)
cuFC_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(cuFC_train, -row), ntree = 501, importance = TRUE)

print(cuFC_rf.1)

plot(cuFC_rf.1)

varImpPlot(cuFC_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
cuFC_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(cuFC_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(cuFC_rf.5)

plot(cuFC_rf.5)

varImpPlot(cuFC_rf.5)

cuFC_predict_fit.rf.5 <- data.frame(fits = predict(cuFC_rf.5, cuFC_test, type = "prob")[,2], actuals = cuFC_test$hit)

cuFC_pred.rf.5 <- prediction(cuFC_predict_fit.rf.5$fits, cuFC_predict_fit.rf.5$actuals)

cuFC_roc.pred.rf.5 <- performance(cuFC_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(cuFC_roc.pred.rf.5)
abline(a = 0, b = 1)
cuFC_opt <- opt.cut(cuFC_roc.pred.rf.5, cuFC_pred.rf.5)
cuFC_opt
cuFC_opt <- cuFC_opt[3]
cuFC_predict_fit.rf.5$fits <- with(cuFC_predict_fit.rf.5, ifelse(fits > cuFC_opt, 1, 0)) 

str(cuFC_test)

#cuFC_test$fieldingTeam <- as.character(cuFC_test$fieldingTeam)
#cuFC_test$home_team <- as.character(cuFC_test$home_team)
#cuFC_test$hit <- as.logical(cuFC_test$hit)
#cuFC_test$stand <- as.logical(cuFC_test$stand)
str(cuFC_test)
cuFC_rf.5_confusion_test <- confusionMatrix(model = cuFC_rf.5, x = cuFC_test, y = cuFC_test$hit)
cuFC_rf.5_confusion_validate <- confusionMatrix(model = cuFC_rf.5, x = cuFC_validate, y = cuFC_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


cuFC_test_rows <- cuFC_test$row
cuFC_validate_rows <- cuFC_validate$row
cuFC_pred_data_emp_1 <- ungroup(cuFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFC_test_rows)

cuFC_pred_data_emp <- ungroup(cuFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFC_validate_rows) %>%
	rbind(cuFC_pred_data_emp_1)

cuFC_out_of_training_rows <- cuFC_pred_data_emp$row

cuFC_rf.5_full_out_of_sample_data <- ungroup(cuFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFC_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



cuFC_rf.5_full_out_of_sample_data_scaled <- cuFC_rf.5_full_out_of_sample_data

cuFC_rf.5_full_out_of_sample_data_scaled$hit_speed <- (cuFC_rf.5_full_out_of_sample_data_scaled$hit_speed - cuFC_center_values[2]) / cuFC_scale_values[2]

cuFC_rf.5_full_out_of_sample_data_scaled$hit_angle <- (cuFC_rf.5_full_out_of_sample_data_scaled$hit_angle - cuFC_center_values[3]) / cuFC_scale_values[3]

cuFC_rf.5.prob <- predict(cuFC_rf.5, cuFC_rf.5_full_out_of_sample_data_scaled, type = "response")

cuFC_rf.5_full_out_of_sample_data <- cbind(filter(cuFC_rf.5_full_out_of_sample_data, row %in% cuFC_out_of_training_rows), cuFC_rf.5.prob)

names(cuFC_rf.5_full_out_of_sample_data)[65] <- "fits"
names(cuFC_rf.5_full_out_of_sample_data)

cuFC_rf.5_full_out_of_sample_data_reduced <- cuFC_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

cuFC_rf.5_mean_table <- cuFC_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

cuFC_rf.5_full_out_of_sample_data$type <- with(cuFC_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

cuFC_rf.5_full_out_of_sample_data$hit_label <- with(cuFC_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

cuFC_rf.5_plot1 <- ggplot(cuFC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuFC_rf.5_plot1

cuFC_rf.5_plot2 <- ggplot(cuFC_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuFC_rf.5_plot2

cuFC_rf.5_plot3 <- ggplot(cuFC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuFC_rf.5_plot3

cuFC_grid_plot_rf.5 <- grid.arrange(cuFC_rf.5_plot1, cuFC_rf.5_plot2, cuFC_rf.5_plot3, ncol = 3)
cuFC_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

cuFC_test_rows <- cuFC_test$row
cuFC_validate_rows <- cuFC_validate$row
cuFC_pred_data_emp_1 <- ungroup(cuFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFC_test_rows)

cuFC_pred_data_emp <- ungroup(cuFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFC_validate_rows) %>%
	rbind(cuFC_pred_data_emp_1)

cuFC_out_of_training_rows <- cuFC_pred_data_emp$row

cuFC_pred_data_emp <- ungroup(cuFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFC_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

cuFC_pred_data_emp_scaled <- cuFC_pred_data_emp

cuFC_pred_data_emp_scaled$hit_speed <- (cuFC_pred_data_emp_scaled$hit_speed - cuFC_center_values[2]) / cuFC_scale_values[2]

cuFC_pred_data_emp_scaled$hit_angle <- (cuFC_pred_data_emp_scaled$hit_angle - cuFC_center_values[3]) / cuFC_scale_values[3]

cuFC_pred_prob_hit <- predict(cuFC_rf.5, cuFC_pred_data_emp_scaled, type = "prob")[,2]
cuFC_pred_prob_hit_fits <- cbind(cuFC_pred_data_emp, cuFC_pred_prob_hit)

cuFC_pred_prob_hit_fits[,c(1:2)] <- cuFC_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

cuFC_angle_speed_pred <- cuFC_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = cuFC_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nCU-FC Hit Probability\n") + theme_bp_grey()

cuFC_angle_speed_pred
#####
ffFC$hit_distance_sc <- as.numeric(ffFC$hit_distance_sc, na.rm = TRUE)
ffFC$hit_angle <- as.numeric(ffFC$hit_angle, na.rm = TRUE)
ffFC$hit_speed <- as.numeric(ffFC$hit_speed, na.rm = TRUE)

ffFC$hit <- with(ffFC, ifelse(grepl("Single", ffFC$events), 1,
															ifelse(grepl("Double", ffFC$events), 1,
																		 ifelse(grepl("Triple", ffFC$events), 1, 
																		 			 ifelse(grepl("Home Run", ffFC$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

ffFC$fieldingTeam <- with(ffFC, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[ffFC$hit_distance_sc == "null"] = NA
#ffFC$hit_speed[ffFC$hit_speed == "null"] = NA
#ffFC$hit_angle[ffFC$hit_angle == "null"] = NA

# include row names for unique record identification

ffFC$row <- row.names(ffFC) %>% as.numeric()

# recode stand and home_team as factors

ffFC$stand <- as.factor(ffFC$stand)
ffFC$home_team <- as.factor(ffFC$home_team)


ffFC$game_date <- as.Date(ffFC$game_date)


# subset 

ffFC_working_data <- ungroup(ffFC) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(ffFC_working_data)
str(ungroup(ffFC))
table(ffFC_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

ffFC_working_data <- filter(ffFC_working_data, hc_x != 1, hc_y != 1)
head(ffFC_working_data)

# create training and test sets
# scaled data

set.seed(42)
ffFC_train <- sample_frac(ffFC_working_data, .15, replace = FALSE)
ffFC_split <- setdiff(ffFC_working_data, ffFC_train)
ffFC_test <- sample_frac(ffFC_split, .50, replace = FALSE)
ffFC_validate <- setdiff(ffFC_split, ffFC_test)

nrow(ffFC_train) + nrow(ffFC_test) + nrow(ffFC_validate) == nrow(ffFC_working_data)

with(ffFC_train, table(hit)) %>% prop.table()
with(ffFC_test, table(hit)) %>% prop.table()
with(ffFC_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(ffFC)
##as.numeric(ffFC$hit_distance_sc, ffFC$hit_speed, ffFC$hit_angle)

#ffFC_train$hit_distance_sc <- as.numeric(ffFC_train$hit_distance_sc)
#ffFC_train$hit_speed <- as.numeric(ffFC_train$hit_speed)
#ffFC_train$hit_angle <- as.numeric(ffFC_train$hit_angle)
#View(ffFC_train)
ffFC_scaled_data <- scale(ffFC_train[,c(1:5)])
ffFC_scale_values <- attr(ffFC_scaled_data, 'scaled:scale')
ffFC_scale_values
ffFC_center_values <- attr(ffFC_scaled_data, 'scaled:center')
ffFC_center_values
ffFC_train <- cbind(ffFC_scaled_data, select(ffFC_train, hit:row))

# save levels for factor variables
ffFC_levels_home_team <- levels(ffFC_train$home_team)
ffFC_levels_stand <- levels(ffFC_train$stand)
ffFC_levels_fieldingTeam <- levels(ffFC_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(ffFC_test)

ffFC_test$hit_distance_sc <- (ffFC_test$hit_distance_sc - ffFC_center_values[1]) / ffFC_scale_values[1]

ffFC_test$hit_speed <- (ffFC_test$hit_speed - ffFC_center_values[2]) / ffFC_scale_values[2]

ffFC_test$hit_angle <- (ffFC_test$hit_angle - ffFC_center_values[3]) / ffFC_scale_values[3]

ffFC_test$hc_x <- (ffFC_test$hc_x - ffFC_center_values[4]) / ffFC_scale_values[4]

ffFC_test$hc_y <- (ffFC_test$hc_y - ffFC_center_values[5]) / ffFC_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

ffFC_validate$hit_distance_sc <- (ffFC_validate$hit_distance_sc - ffFC_center_values[1]) / ffFC_scale_values[1]

ffFC_validate$hit_speed <- (ffFC_validate$hit_speed - ffFC_center_values[2]) / ffFC_scale_values[2]

ffFC_validate$hit_angle <- (ffFC_validate$hit_angle - ffFC_center_values[3]) / ffFC_scale_values[3]

ffFC_validate$hc_x <- (ffFC_validate$hc_x - ffFC_center_values[4]) / ffFC_scale_values[4]

ffFC_validate$hc_y <- (ffFC_validate$hc_y - ffFC_center_values[5]) / ffFC_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(ffFC_train)

set.seed(42)
ffFC_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(ffFC_train, -row), ntree = 501, importance = TRUE)

print(ffFC_rf.1)

plot(ffFC_rf.1)

varImpPlot(ffFC_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
ffFC_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(ffFC_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(ffFC_rf.5)

plot(ffFC_rf.5)

varImpPlot(ffFC_rf.5)

ffFC_predict_fit.rf.5 <- data.frame(fits = predict(ffFC_rf.5, ffFC_test, type = "prob")[,2], actuals = ffFC_test$hit)

ffFC_pred.rf.5 <- prediction(ffFC_predict_fit.rf.5$fits, ffFC_predict_fit.rf.5$actuals)

ffFC_roc.pred.rf.5 <- performance(ffFC_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(ffFC_roc.pred.rf.5)
abline(a = 0, b = 1)
ffFC_opt <- opt.cut(ffFC_roc.pred.rf.5, ffFC_pred.rf.5)
ffFC_opt
ffFC_opt <- ffFC_opt[3]
ffFC_predict_fit.rf.5$fits <- with(ffFC_predict_fit.rf.5, ifelse(fits > ffFC_opt, 1, 0)) 

str(ffFC_test)

#ffFC_test$fieldingTeam <- as.character(ffFC_test$fieldingTeam)
#ffFC_test$home_team <- as.character(ffFC_test$home_team)
#ffFC_test$hit <- as.logical(ffFC_test$hit)
#ffFC_test$stand <- as.logical(ffFC_test$stand)
str(ffFC_test)
ffFC_rf.5_confusion_test <- confusionMatrix(model = ffFC_rf.5, x = ffFC_test, y = ffFC_test$hit)
ffFC_rf.5_confusion_validate <- confusionMatrix(model = ffFC_rf.5, x = ffFC_validate, y = ffFC_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


ffFC_test_rows <- ffFC_test$row
ffFC_validate_rows <- ffFC_validate$row
ffFC_pred_data_emp_1 <- ungroup(ffFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffFC_test_rows)

ffFC_pred_data_emp <- ungroup(ffFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffFC_validate_rows) %>%
	rbind(ffFC_pred_data_emp_1)

ffFC_out_of_training_rows <- ffFC_pred_data_emp$row

ffFC_rf.5_full_out_of_sample_data <- ungroup(ffFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffFC_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



ffFC_rf.5_full_out_of_sample_data_scaled <- ffFC_rf.5_full_out_of_sample_data

ffFC_rf.5_full_out_of_sample_data_scaled$hit_speed <- (ffFC_rf.5_full_out_of_sample_data_scaled$hit_speed - ffFC_center_values[2]) / ffFC_scale_values[2]

ffFC_rf.5_full_out_of_sample_data_scaled$hit_angle <- (ffFC_rf.5_full_out_of_sample_data_scaled$hit_angle - ffFC_center_values[3]) / ffFC_scale_values[3]

ffFC_rf.5.prob <- predict(ffFC_rf.5, ffFC_rf.5_full_out_of_sample_data_scaled, type = "response")

ffFC_rf.5_full_out_of_sample_data <- cbind(filter(ffFC_rf.5_full_out_of_sample_data, row %in% ffFC_out_of_training_rows), ffFC_rf.5.prob)

names(ffFC_rf.5_full_out_of_sample_data)[65] <- "fits"
names(ffFC_rf.5_full_out_of_sample_data)

ffFC_rf.5_full_out_of_sample_data_reduced <- ffFC_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

ffFC_rf.5_mean_table <- ffFC_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

ffFC_rf.5_full_out_of_sample_data$type <- with(ffFC_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

ffFC_rf.5_full_out_of_sample_data$hit_label <- with(ffFC_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

ffFC_rf.5_plot1 <- ggplot(ffFC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffFC_rf.5_plot1

ffFC_rf.5_plot2 <- ggplot(ffFC_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffFC_rf.5_plot2

ffFC_rf.5_plot3 <- ggplot(ffFC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffFC_rf.5_plot3

ffFC_grid_plot_rf.5 <- grid.arrange(ffFC_rf.5_plot1, ffFC_rf.5_plot2, ffFC_rf.5_plot3, ncol = 3)
ffFC_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

ffFC_test_rows <- ffFC_test$row
ffFC_validate_rows <- ffFC_validate$row
ffFC_pred_data_emp_1 <- ungroup(ffFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffFC_test_rows)

ffFC_pred_data_emp <- ungroup(ffFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffFC_validate_rows) %>%
	rbind(ffFC_pred_data_emp_1)

ffFC_out_of_training_rows <- ffFC_pred_data_emp$row

ffFC_pred_data_emp <- ungroup(ffFC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffFC_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

ffFC_pred_data_emp_scaled <- ffFC_pred_data_emp

ffFC_pred_data_emp_scaled$hit_speed <- (ffFC_pred_data_emp_scaled$hit_speed - ffFC_center_values[2]) / ffFC_scale_values[2]

ffFC_pred_data_emp_scaled$hit_angle <- (ffFC_pred_data_emp_scaled$hit_angle - ffFC_center_values[3]) / ffFC_scale_values[3]

ffFC_pred_prob_hit <- predict(ffFC_rf.5, ffFC_pred_data_emp_scaled, type = "prob")[,2]
ffFC_pred_prob_hit_fits <- cbind(ffFC_pred_data_emp, ffFC_pred_prob_hit)

ffFC_pred_prob_hit_fits[,c(1:2)] <- ffFC_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

ffFC_angle_speed_pred <- ffFC_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = ffFC_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFF-FC Hit Probability\n") + theme_bp_grey()

ffFC_angle_speed_pred
############# End Cutters; Start Splitters
#####
siFS$hit_distance_sc <- as.numeric(siFS$hit_distance_sc, na.rm = TRUE)
siFS$hit_angle <- as.numeric(siFS$hit_angle, na.rm = TRUE)
siFS$hit_speed <- as.numeric(siFS$hit_speed, na.rm = TRUE)

siFS$hit <- with(siFS, ifelse(grepl("Single", siFS$events), 1,
															ifelse(grepl("Double", siFS$events), 1,
																		 ifelse(grepl("Triple", siFS$events), 1, 
																		 			 ifelse(grepl("Home Run", siFS$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

siFS$fieldingTeam <- with(siFS, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[siFS$hit_distance_sc == "null"] = NA
#siFS$hit_speed[siFS$hit_speed == "null"] = NA
#siFS$hit_angle[siFS$hit_angle == "null"] = NA

# include row names for unique record identification

siFS$row <- row.names(siFS) %>% as.numeric()

# recode stand and home_team as factors

siFS$stand <- as.factor(siFS$stand)
siFS$home_team <- as.factor(siFS$home_team)


siFS$game_date <- as.Date(siFS$game_date)


# subset 

siFS_working_data <- ungroup(siFS) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(siFS_working_data)
str(ungroup(siFS))
table(siFS_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

siFS_working_data <- filter(siFS_working_data, hc_x != 1, hc_y != 1)
head(siFS_working_data)

# create training and test sets
# scaled data

set.seed(42)
siFS_train <- sample_frac(siFS_working_data, .15, replace = FALSE)
siFS_split <- setdiff(siFS_working_data, siFS_train)
siFS_test <- sample_frac(siFS_split, .50, replace = FALSE)
siFS_validate <- setdiff(siFS_split, siFS_test)

nrow(siFS_train) + nrow(siFS_test) + nrow(siFS_validate) == nrow(siFS_working_data)

with(siFS_train, table(hit)) %>% prop.table()
with(siFS_test, table(hit)) %>% prop.table()
with(siFS_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(siFS)
##as.numeric(siFS$hit_distance_sc, siFS$hit_speed, siFS$hit_angle)

#siFS_train$hit_distance_sc <- as.numeric(siFS_train$hit_distance_sc)
#siFS_train$hit_speed <- as.numeric(siFS_train$hit_speed)
#siFS_train$hit_angle <- as.numeric(siFS_train$hit_angle)
#View(siFS_train)
siFS_scaled_data <- scale(siFS_train[,c(1:5)])
siFS_scale_values <- attr(siFS_scaled_data, 'scaled:scale')
siFS_scale_values
siFS_center_values <- attr(siFS_scaled_data, 'scaled:center')
siFS_center_values
siFS_train <- cbind(siFS_scaled_data, select(siFS_train, hit:row))

# save levels for factor variables
siFS_levels_home_team <- levels(siFS_train$home_team)
siFS_levels_stand <- levels(siFS_train$stand)
siFS_levels_fieldingTeam <- levels(siFS_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(siFS_test)

siFS_test$hit_distance_sc <- (siFS_test$hit_distance_sc - siFS_center_values[1]) / siFS_scale_values[1]

siFS_test$hit_speed <- (siFS_test$hit_speed - siFS_center_values[2]) / siFS_scale_values[2]

siFS_test$hit_angle <- (siFS_test$hit_angle - siFS_center_values[3]) / siFS_scale_values[3]

siFS_test$hc_x <- (siFS_test$hc_x - siFS_center_values[4]) / siFS_scale_values[4]

siFS_test$hc_y <- (siFS_test$hc_y - siFS_center_values[5]) / siFS_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

siFS_validate$hit_distance_sc <- (siFS_validate$hit_distance_sc - siFS_center_values[1]) / siFS_scale_values[1]

siFS_validate$hit_speed <- (siFS_validate$hit_speed - siFS_center_values[2]) / siFS_scale_values[2]

siFS_validate$hit_angle <- (siFS_validate$hit_angle - siFS_center_values[3]) / siFS_scale_values[3]

siFS_validate$hc_x <- (siFS_validate$hc_x - siFS_center_values[4]) / siFS_scale_values[4]

siFS_validate$hc_y <- (siFS_validate$hc_y - siFS_center_values[5]) / siFS_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(siFS_train)

set.seed(42)
siFS_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(siFS_train, -row), ntree = 501, importance = TRUE)

print(siFS_rf.1)

plot(siFS_rf.1)

varImpPlot(siFS_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
siFS_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(siFS_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(siFS_rf.5)

plot(siFS_rf.5)

varImpPlot(siFS_rf.5)

siFS_predict_fit.rf.5 <- data.frame(fits = predict(siFS_rf.5, siFS_test, type = "prob")[,2], actuals = siFS_test$hit)

siFS_pred.rf.5 <- prediction(siFS_predict_fit.rf.5$fits, siFS_predict_fit.rf.5$actuals)

siFS_roc.pred.rf.5 <- performance(siFS_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(siFS_roc.pred.rf.5)
abline(a = 0, b = 1)
siFS_opt <- opt.cut(siFS_roc.pred.rf.5, siFS_pred.rf.5)
siFS_opt
siFS_opt <- siFS_opt[3]
siFS_predict_fit.rf.5$fits <- with(siFS_predict_fit.rf.5, ifelse(fits > siFS_opt, 1, 0)) 

str(siFS_test)

#siFS_test$fieldingTeam <- as.character(siFS_test$fieldingTeam)
#siFS_test$home_team <- as.character(siFS_test$home_team)
#siFS_test$hit <- as.logical(siFS_test$hit)
#siFS_test$stand <- as.logical(siFS_test$stand)
str(siFS_test)
siFS_rf.5_confusion_test <- confusionMatrix(model = siFS_rf.5, x = siFS_test, y = siFS_test$hit)
siFS_rf.5_confusion_validate <- confusionMatrix(model = siFS_rf.5, x = siFS_validate, y = siFS_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


siFS_test_rows <- siFS_test$row
siFS_validate_rows <- siFS_validate$row
siFS_pred_data_emp_1 <- ungroup(siFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFS_test_rows)

siFS_pred_data_emp <- ungroup(siFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFS_validate_rows) %>%
	rbind(siFS_pred_data_emp_1)

siFS_out_of_training_rows <- siFS_pred_data_emp$row

siFS_rf.5_full_out_of_sample_data <- ungroup(siFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFS_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



siFS_rf.5_full_out_of_sample_data_scaled <- siFS_rf.5_full_out_of_sample_data

siFS_rf.5_full_out_of_sample_data_scaled$hit_speed <- (siFS_rf.5_full_out_of_sample_data_scaled$hit_speed - siFS_center_values[2]) / siFS_scale_values[2]

siFS_rf.5_full_out_of_sample_data_scaled$hit_angle <- (siFS_rf.5_full_out_of_sample_data_scaled$hit_angle - siFS_center_values[3]) / siFS_scale_values[3]

siFS_rf.5.prob <- predict(siFS_rf.5, siFS_rf.5_full_out_of_sample_data_scaled, type = "response")

siFS_rf.5_full_out_of_sample_data <- cbind(filter(siFS_rf.5_full_out_of_sample_data, row %in% siFS_out_of_training_rows), siFS_rf.5.prob)

names(siFS_rf.5_full_out_of_sample_data)[65] <- "fits"
names(siFS_rf.5_full_out_of_sample_data)

siFS_rf.5_full_out_of_sample_data_reduced <- siFS_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

siFS_rf.5_mean_table <- siFS_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

siFS_rf.5_full_out_of_sample_data$type <- with(siFS_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

siFS_rf.5_full_out_of_sample_data$hit_label <- with(siFS_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

siFS_rf.5_plot1 <- ggplot(siFS_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siFS_rf.5_plot1

siFS_rf.5_plot2 <- ggplot(siFS_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siFS_rf.5_plot2

siFS_rf.5_plot3 <- ggplot(siFS_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siFS_rf.5_plot3

siFS_grid_plot_rf.5 <- grid.arrange(siFS_rf.5_plot1, siFS_rf.5_plot2, siFS_rf.5_plot3, ncol = 3)
siFS_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

siFS_test_rows <- siFS_test$row
siFS_validate_rows <- siFS_validate$row
siFS_pred_data_emp_1 <- ungroup(siFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFS_test_rows)

siFS_pred_data_emp <- ungroup(siFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFS_validate_rows) %>%
	rbind(siFS_pred_data_emp_1)

siFS_out_of_training_rows <- siFS_pred_data_emp$row

siFS_pred_data_emp <- ungroup(siFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siFS_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

siFS_pred_data_emp_scaled <- siFS_pred_data_emp

siFS_pred_data_emp_scaled$hit_speed <- (siFS_pred_data_emp_scaled$hit_speed - siFS_center_values[2]) / siFS_scale_values[2]

siFS_pred_data_emp_scaled$hit_angle <- (siFS_pred_data_emp_scaled$hit_angle - siFS_center_values[3]) / siFS_scale_values[3]

siFS_pred_prob_hit <- predict(siFS_rf.5, siFS_pred_data_emp_scaled, type = "prob")[,2]
siFS_pred_prob_hit_fits <- cbind(siFS_pred_data_emp, siFS_pred_prob_hit)

siFS_pred_prob_hit_fits[,c(1:2)] <- siFS_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

siFS_angle_speed_pred <- siFS_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = siFS_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nSI-FS Hit Probability\n") + theme_bp_grey()

siFS_angle_speed_pred
########################## Start Splitters
#####
knFS$hit_distance_sc <- as.numeric(knFS$hit_distance_sc, na.rm = TRUE)
knFS$hit_angle <- as.numeric(knFS$hit_angle, na.rm = TRUE)
knFS$hit_speed <- as.numeric(knFS$hit_speed, na.rm = TRUE)

knFS$hit <- with(knFS, ifelse(grepl("Single", knFS$events), 1,
															ifelse(grepl("Double", knFS$events), 1,
																		 ifelse(grepl("Triple", knFS$events), 1, 
																		 			 ifelse(grepl("Home Run", knFS$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

knFS$fieldingTeam <- with(knFS, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[knFS$hit_distance_sc == "null"] = NA
#knFS$hit_speed[knFS$hit_speed == "null"] = NA
#knFS$hit_angle[knFS$hit_angle == "null"] = NA

# include row names for unique record identification

knFS$row <- row.names(knFS) %>% as.numeric()

# recode stand and home_team as factors

knFS$stand <- as.factor(knFS$stand)
knFS$home_team <- as.factor(knFS$home_team)


knFS$game_date <- as.Date(knFS$game_date)


# subset 

knFS_working_data <- ungroup(knFS) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(knFS_working_data)
str(ungroup(knFS))
table(knFS_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

knFS_working_data <- filter(knFS_working_data, hc_x != 1, hc_y != 1)
head(knFS_working_data)

# create training and test sets
# scaled data

set.seed(42)
knFS_train <- sample_frac(knFS_working_data, .15, replace = FALSE)
knFS_split <- setdiff(knFS_working_data, knFS_train)
knFS_test <- sample_frac(knFS_split, .50, replace = FALSE)
knFS_validate <- setdiff(knFS_split, knFS_test)

nrow(knFS_train) + nrow(knFS_test) + nrow(knFS_validate) == nrow(knFS_working_data)

with(knFS_train, table(hit)) %>% prop.table()
with(knFS_test, table(hit)) %>% prop.table()
with(knFS_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(knFS)
##as.numeric(knFS$hit_distance_sc, knFS$hit_speed, knFS$hit_angle)

#knFS_train$hit_distance_sc <- as.numeric(knFS_train$hit_distance_sc)
#knFS_train$hit_speed <- as.numeric(knFS_train$hit_speed)
#knFS_train$hit_angle <- as.numeric(knFS_train$hit_angle)
#View(knFS_train)
knFS_scaled_data <- scale(knFS_train[,c(1:5)])
knFS_scale_values <- attr(knFS_scaled_data, 'scaled:scale')
knFS_scale_values
knFS_center_values <- attr(knFS_scaled_data, 'scaled:center')
knFS_center_values
knFS_train <- cbind(knFS_scaled_data, select(knFS_train, hit:row))

# save levels for factor variables
knFS_levels_home_team <- levels(knFS_train$home_team)
knFS_levels_stand <- levels(knFS_train$stand)
knFS_levels_fieldingTeam <- levels(knFS_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(knFS_test)

knFS_test$hit_distance_sc <- (knFS_test$hit_distance_sc - knFS_center_values[1]) / knFS_scale_values[1]

knFS_test$hit_speed <- (knFS_test$hit_speed - knFS_center_values[2]) / knFS_scale_values[2]

knFS_test$hit_angle <- (knFS_test$hit_angle - knFS_center_values[3]) / knFS_scale_values[3]

knFS_test$hc_x <- (knFS_test$hc_x - knFS_center_values[4]) / knFS_scale_values[4]

knFS_test$hc_y <- (knFS_test$hc_y - knFS_center_values[5]) / knFS_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

knFS_validate$hit_distance_sc <- (knFS_validate$hit_distance_sc - knFS_center_values[1]) / knFS_scale_values[1]

knFS_validate$hit_speed <- (knFS_validate$hit_speed - knFS_center_values[2]) / knFS_scale_values[2]

knFS_validate$hit_angle <- (knFS_validate$hit_angle - knFS_center_values[3]) / knFS_scale_values[3]

knFS_validate$hc_x <- (knFS_validate$hc_x - knFS_center_values[4]) / knFS_scale_values[4]

knFS_validate$hc_y <- (knFS_validate$hc_y - knFS_center_values[5]) / knFS_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(knFS_train)

set.seed(42)
knFS_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(knFS_train, -row), ntree = 501, importance = TRUE)

print(knFS_rf.1)

plot(knFS_rf.1)

varImpPlot(knFS_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
knFS_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(knFS_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(knFS_rf.5)

plot(knFS_rf.5)

varImpPlot(knFS_rf.5)

knFS_predict_fit.rf.5 <- data.frame(fits = predict(knFS_rf.5, knFS_test, type = "prob")[,2], actuals = knFS_test$hit)

knFS_pred.rf.5 <- prediction(knFS_predict_fit.rf.5$fits, knFS_predict_fit.rf.5$actuals)

knFS_roc.pred.rf.5 <- performance(knFS_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(knFS_roc.pred.rf.5)
abline(a = 0, b = 1)
knFS_opt <- opt.cut(knFS_roc.pred.rf.5, knFS_pred.rf.5)
knFS_opt
knFS_opt <- knFS_opt[3]
knFS_predict_fit.rf.5$fits <- with(knFS_predict_fit.rf.5, ifelse(fits > knFS_opt, 1, 0)) 

str(knFS_test)

#knFS_test$fieldingTeam <- as.character(knFS_test$fieldingTeam)
#knFS_test$home_team <- as.character(knFS_test$home_team)
#knFS_test$hit <- as.logical(knFS_test$hit)
#knFS_test$stand <- as.logical(knFS_test$stand)
str(knFS_test)
knFS_rf.5_confusion_test <- confusionMatrix(model = knFS_rf.5, x = knFS_test, y = knFS_test$hit)
knFS_rf.5_confusion_validate <- confusionMatrix(model = knFS_rf.5, x = knFS_validate, y = knFS_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


knFS_test_rows <- knFS_test$row
knFS_validate_rows <- knFS_validate$row
knFS_pred_data_emp_1 <- ungroup(knFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFS_test_rows)

knFS_pred_data_emp <- ungroup(knFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFS_validate_rows) %>%
	rbind(knFS_pred_data_emp_1)

knFS_out_of_training_rows <- knFS_pred_data_emp$row

knFS_rf.5_full_out_of_sample_data <- ungroup(knFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFS_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



knFS_rf.5_full_out_of_sample_data_scaled <- knFS_rf.5_full_out_of_sample_data

knFS_rf.5_full_out_of_sample_data_scaled$hit_speed <- (knFS_rf.5_full_out_of_sample_data_scaled$hit_speed - knFS_center_values[2]) / knFS_scale_values[2]

knFS_rf.5_full_out_of_sample_data_scaled$hit_angle <- (knFS_rf.5_full_out_of_sample_data_scaled$hit_angle - knFS_center_values[3]) / knFS_scale_values[3]

knFS_rf.5.prob <- predict(knFS_rf.5, knFS_rf.5_full_out_of_sample_data_scaled, type = "response")

knFS_rf.5_full_out_of_sample_data <- cbind(filter(knFS_rf.5_full_out_of_sample_data, row %in% knFS_out_of_training_rows), knFS_rf.5.prob)

names(knFS_rf.5_full_out_of_sample_data)[65] <- "fits"
names(knFS_rf.5_full_out_of_sample_data)

knFS_rf.5_full_out_of_sample_data_reduced <- knFS_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

knFS_rf.5_mean_table <- knFS_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

knFS_rf.5_full_out_of_sample_data$type <- with(knFS_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

knFS_rf.5_full_out_of_sample_data$hit_label <- with(knFS_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

knFS_rf.5_plot1 <- ggplot(knFS_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knFS_rf.5_plot1

knFS_rf.5_plot2 <- ggplot(knFS_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knFS_rf.5_plot2

knFS_rf.5_plot3 <- ggplot(knFS_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knFS_rf.5_plot3

knFS_grid_plot_rf.5 <- grid.arrange(knFS_rf.5_plot1, knFS_rf.5_plot2, knFS_rf.5_plot3, ncol = 3)
knFS_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

knFS_test_rows <- knFS_test$row
knFS_validate_rows <- knFS_validate$row
knFS_pred_data_emp_1 <- ungroup(knFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFS_test_rows)

knFS_pred_data_emp <- ungroup(knFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFS_validate_rows) %>%
	rbind(knFS_pred_data_emp_1)

knFS_out_of_training_rows <- knFS_pred_data_emp$row

knFS_pred_data_emp <- ungroup(knFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knFS_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

knFS_pred_data_emp_scaled <- knFS_pred_data_emp

knFS_pred_data_emp_scaled$hit_speed <- (knFS_pred_data_emp_scaled$hit_speed - knFS_center_values[2]) / knFS_scale_values[2]

knFS_pred_data_emp_scaled$hit_angle <- (knFS_pred_data_emp_scaled$hit_angle - knFS_center_values[3]) / knFS_scale_values[3]

knFS_pred_prob_hit <- predict(knFS_rf.5, knFS_pred_data_emp_scaled, type = "prob")[,2]
knFS_pred_prob_hit_fits <- cbind(knFS_pred_data_emp, knFS_pred_prob_hit)

knFS_pred_prob_hit_fits[,c(1:2)] <- knFS_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

knFS_angle_speed_pred <- knFS_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = knFS_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nKN-FS Hit Probability\n") + theme_bp_grey()

knFS_angle_speed_pred
#####
kcFS$hit_distance_sc <- as.numeric(kcFS$hit_distance_sc, na.rm = TRUE)
kcFS$hit_angle <- as.numeric(kcFS$hit_angle, na.rm = TRUE)
kcFS$hit_speed <- as.numeric(kcFS$hit_speed, na.rm = TRUE)

kcFS$hit <- with(kcFS, ifelse(grepl("Single", kcFS$events), 1,
															ifelse(grepl("Double", kcFS$events), 1,
																		 ifelse(grepl("Triple", kcFS$events), 1, 
																		 			 ifelse(grepl("Home Run", kcFS$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

kcFS$fieldingTeam <- with(kcFS, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[kcFS$hit_distance_sc == "null"] = NA
#kcFS$hit_speed[kcFS$hit_speed == "null"] = NA
#kcFS$hit_angle[kcFS$hit_angle == "null"] = NA

# include row names for unique record identification

kcFS$row <- row.names(kcFS) %>% as.numeric()

# recode stand and home_team as factors

kcFS$stand <- as.factor(kcFS$stand)
kcFS$home_team <- as.factor(kcFS$home_team)


kcFS$game_date <- as.Date(kcFS$game_date)


# subset 

kcFS_working_data <- ungroup(kcFS) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(kcFS_working_data)
str(ungroup(kcFS))
table(kcFS_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

kcFS_working_data <- filter(kcFS_working_data, hc_x != 1, hc_y != 1)
head(kcFS_working_data)

# create training and test sets
# scaled data

set.seed(42)
kcFS_train <- sample_frac(kcFS_working_data, .15, replace = FALSE)
kcFS_split <- setdiff(kcFS_working_data, kcFS_train)
kcFS_test <- sample_frac(kcFS_split, .50, replace = FALSE)
kcFS_validate <- setdiff(kcFS_split, kcFS_test)

nrow(kcFS_train) + nrow(kcFS_test) + nrow(kcFS_validate) == nrow(kcFS_working_data)

with(kcFS_train, table(hit)) %>% prop.table()
with(kcFS_test, table(hit)) %>% prop.table()
with(kcFS_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(kcFS)
##as.numeric(kcFS$hit_distance_sc, kcFS$hit_speed, kcFS$hit_angle)

#kcFS_train$hit_distance_sc <- as.numeric(kcFS_train$hit_distance_sc)
#kcFS_train$hit_speed <- as.numeric(kcFS_train$hit_speed)
#kcFS_train$hit_angle <- as.numeric(kcFS_train$hit_angle)
#View(kcFS_train)
kcFS_scaled_data <- scale(kcFS_train[,c(1:5)])
kcFS_scale_values <- attr(kcFS_scaled_data, 'scaled:scale')
kcFS_scale_values
kcFS_center_values <- attr(kcFS_scaled_data, 'scaled:center')
kcFS_center_values
kcFS_train <- cbind(kcFS_scaled_data, select(kcFS_train, hit:row))

# save levels for factor variables
kcFS_levels_home_team <- levels(kcFS_train$home_team)
kcFS_levels_stand <- levels(kcFS_train$stand)
kcFS_levels_fieldingTeam <- levels(kcFS_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(kcFS_test)

kcFS_test$hit_distance_sc <- (kcFS_test$hit_distance_sc - kcFS_center_values[1]) / kcFS_scale_values[1]

kcFS_test$hit_speed <- (kcFS_test$hit_speed - kcFS_center_values[2]) / kcFS_scale_values[2]

kcFS_test$hit_angle <- (kcFS_test$hit_angle - kcFS_center_values[3]) / kcFS_scale_values[3]

kcFS_test$hc_x <- (kcFS_test$hc_x - kcFS_center_values[4]) / kcFS_scale_values[4]

kcFS_test$hc_y <- (kcFS_test$hc_y - kcFS_center_values[5]) / kcFS_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

kcFS_validate$hit_distance_sc <- (kcFS_validate$hit_distance_sc - kcFS_center_values[1]) / kcFS_scale_values[1]

kcFS_validate$hit_speed <- (kcFS_validate$hit_speed - kcFS_center_values[2]) / kcFS_scale_values[2]

kcFS_validate$hit_angle <- (kcFS_validate$hit_angle - kcFS_center_values[3]) / kcFS_scale_values[3]

kcFS_validate$hc_x <- (kcFS_validate$hc_x - kcFS_center_values[4]) / kcFS_scale_values[4]

kcFS_validate$hc_y <- (kcFS_validate$hc_y - kcFS_center_values[5]) / kcFS_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(kcFS_train)

set.seed(42)
kcFS_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(kcFS_train, -row), ntree = 501, importance = TRUE)

print(kcFS_rf.1)

plot(kcFS_rf.1)

varImpPlot(kcFS_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
kcFS_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(kcFS_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(kcFS_rf.5)

plot(kcFS_rf.5)

varImpPlot(kcFS_rf.5)

kcFS_predict_fit.rf.5 <- data.frame(fits = predict(kcFS_rf.5, kcFS_test, type = "prob")[,2], actuals = kcFS_test$hit)

kcFS_pred.rf.5 <- prediction(kcFS_predict_fit.rf.5$fits, kcFS_predict_fit.rf.5$actuals)

kcFS_roc.pred.rf.5 <- performance(kcFS_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(kcFS_roc.pred.rf.5)
abline(a = 0, b = 1)
kcFS_opt <- opt.cut(kcFS_roc.pred.rf.5, kcFS_pred.rf.5)
kcFS_opt
kcFS_opt <- kcFS_opt[3]
kcFS_predict_fit.rf.5$fits <- with(kcFS_predict_fit.rf.5, ifelse(fits > kcFS_opt, 1, 0)) 

str(kcFS_test)

#kcFS_test$fieldingTeam <- as.character(kcFS_test$fieldingTeam)
#kcFS_test$home_team <- as.character(kcFS_test$home_team)
#kcFS_test$hit <- as.logical(kcFS_test$hit)
#kcFS_test$stand <- as.logical(kcFS_test$stand)
str(kcFS_test)
kcFS_rf.5_confusion_test <- confusionMatrix(model = kcFS_rf.5, x = kcFS_test, y = kcFS_test$hit)
kcFS_rf.5_confusion_validate <- confusionMatrix(model = kcFS_rf.5, x = kcFS_validate, y = kcFS_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


kcFS_test_rows <- kcFS_test$row
kcFS_validate_rows <- kcFS_validate$row
kcFS_pred_data_emp_1 <- ungroup(kcFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFS_test_rows)

kcFS_pred_data_emp <- ungroup(kcFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFS_validate_rows) %>%
	rbind(kcFS_pred_data_emp_1)

kcFS_out_of_training_rows <- kcFS_pred_data_emp$row

kcFS_rf.5_full_out_of_sample_data <- ungroup(kcFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFS_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



kcFS_rf.5_full_out_of_sample_data_scaled <- kcFS_rf.5_full_out_of_sample_data

kcFS_rf.5_full_out_of_sample_data_scaled$hit_speed <- (kcFS_rf.5_full_out_of_sample_data_scaled$hit_speed - kcFS_center_values[2]) / kcFS_scale_values[2]

kcFS_rf.5_full_out_of_sample_data_scaled$hit_angle <- (kcFS_rf.5_full_out_of_sample_data_scaled$hit_angle - kcFS_center_values[3]) / kcFS_scale_values[3]

kcFS_rf.5.prob <- predict(kcFS_rf.5, kcFS_rf.5_full_out_of_sample_data_scaled, type = "response")

kcFS_rf.5_full_out_of_sample_data <- cbind(filter(kcFS_rf.5_full_out_of_sample_data, row %in% kcFS_out_of_training_rows), kcFS_rf.5.prob)

names(kcFS_rf.5_full_out_of_sample_data)[65] <- "fits"
names(kcFS_rf.5_full_out_of_sample_data)

kcFS_rf.5_full_out_of_sample_data_reduced <- kcFS_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

kcFS_rf.5_mean_table <- kcFS_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

kcFS_rf.5_full_out_of_sample_data$type <- with(kcFS_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

kcFS_rf.5_full_out_of_sample_data$hit_label <- with(kcFS_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

kcFS_rf.5_plot1 <- ggplot(kcFS_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcFS_rf.5_plot1

kcFS_rf.5_plot2 <- ggplot(kcFS_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcFS_rf.5_plot2

kcFS_rf.5_plot3 <- ggplot(kcFS_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcFS_rf.5_plot3

kcFS_grid_plot_rf.5 <- grid.arrange(kcFS_rf.5_plot1, kcFS_rf.5_plot2, kcFS_rf.5_plot3, ncol = 3)
kcFS_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

kcFS_test_rows <- kcFS_test$row
kcFS_validate_rows <- kcFS_validate$row
kcFS_pred_data_emp_1 <- ungroup(kcFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFS_test_rows)

kcFS_pred_data_emp <- ungroup(kcFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFS_validate_rows) %>%
	rbind(kcFS_pred_data_emp_1)

kcFS_out_of_training_rows <- kcFS_pred_data_emp$row

kcFS_pred_data_emp <- ungroup(kcFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcFS_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

kcFS_pred_data_emp_scaled <- kcFS_pred_data_emp

kcFS_pred_data_emp_scaled$hit_speed <- (kcFS_pred_data_emp_scaled$hit_speed - kcFS_center_values[2]) / kcFS_scale_values[2]

kcFS_pred_data_emp_scaled$hit_angle <- (kcFS_pred_data_emp_scaled$hit_angle - kcFS_center_values[3]) / kcFS_scale_values[3]

kcFS_pred_prob_hit <- predict(kcFS_rf.5, kcFS_pred_data_emp_scaled, type = "prob")[,2]
kcFS_pred_prob_hit_fits <- cbind(kcFS_pred_data_emp, kcFS_pred_prob_hit)

kcFS_pred_prob_hit_fits[,c(1:2)] <- kcFS_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

kcFS_angle_speed_pred <- kcFS_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = kcFS_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nKC-FS Hit Probability\n") + theme_bp_grey()

kcFS_angle_speed_pred
#####
fcFS$hit_distance_sc <- as.numeric(fcFS$hit_distance_sc, na.rm = TRUE)
fcFS$hit_angle <- as.numeric(fcFS$hit_angle, na.rm = TRUE)
fcFS$hit_speed <- as.numeric(fcFS$hit_speed, na.rm = TRUE)

fcFS$hit <- with(fcFS, ifelse(grepl("Single", fcFS$events), 1,
															ifelse(grepl("Double", fcFS$events), 1,
																		 ifelse(grepl("Triple", fcFS$events), 1, 
																		 			 ifelse(grepl("Home Run", fcFS$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

fcFS$fieldingTeam <- with(fcFS, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[fcFS$hit_distance_sc == "null"] = NA
#fcFS$hit_speed[fcFS$hit_speed == "null"] = NA
#fcFS$hit_angle[fcFS$hit_angle == "null"] = NA

# include row names for unique record identification

fcFS$row <- row.names(fcFS) %>% as.numeric()

# recode stand and home_team as factors

fcFS$stand <- as.factor(fcFS$stand)
fcFS$home_team <- as.factor(fcFS$home_team)


fcFS$game_date <- as.Date(fcFS$game_date)


# subset 

fcFS_working_data <- ungroup(fcFS) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(fcFS_working_data)
str(ungroup(fcFS))
table(fcFS_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

fcFS_working_data <- filter(fcFS_working_data, hc_x != 1, hc_y != 1)
head(fcFS_working_data)

# create training and test sets
# scaled data

set.seed(42)
fcFS_train <- sample_frac(fcFS_working_data, .15, replace = FALSE)
fcFS_split <- setdiff(fcFS_working_data, fcFS_train)
fcFS_test <- sample_frac(fcFS_split, .50, replace = FALSE)
fcFS_validate <- setdiff(fcFS_split, fcFS_test)

nrow(fcFS_train) + nrow(fcFS_test) + nrow(fcFS_validate) == nrow(fcFS_working_data)

with(fcFS_train, table(hit)) %>% prop.table()
with(fcFS_test, table(hit)) %>% prop.table()
with(fcFS_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(fcFS)
##as.numeric(fcFS$hit_distance_sc, fcFS$hit_speed, fcFS$hit_angle)

#fcFS_train$hit_distance_sc <- as.numeric(fcFS_train$hit_distance_sc)
#fcFS_train$hit_speed <- as.numeric(fcFS_train$hit_speed)
#fcFS_train$hit_angle <- as.numeric(fcFS_train$hit_angle)
#View(fcFS_train)
fcFS_scaled_data <- scale(fcFS_train[,c(1:5)])
fcFS_scale_values <- attr(fcFS_scaled_data, 'scaled:scale')
fcFS_scale_values
fcFS_center_values <- attr(fcFS_scaled_data, 'scaled:center')
fcFS_center_values
fcFS_train <- cbind(fcFS_scaled_data, select(fcFS_train, hit:row))

# save levels for factor variables
fcFS_levels_home_team <- levels(fcFS_train$home_team)
fcFS_levels_stand <- levels(fcFS_train$stand)
fcFS_levels_fieldingTeam <- levels(fcFS_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(fcFS_test)

fcFS_test$hit_distance_sc <- (fcFS_test$hit_distance_sc - fcFS_center_values[1]) / fcFS_scale_values[1]

fcFS_test$hit_speed <- (fcFS_test$hit_speed - fcFS_center_values[2]) / fcFS_scale_values[2]

fcFS_test$hit_angle <- (fcFS_test$hit_angle - fcFS_center_values[3]) / fcFS_scale_values[3]

fcFS_test$hc_x <- (fcFS_test$hc_x - fcFS_center_values[4]) / fcFS_scale_values[4]

fcFS_test$hc_y <- (fcFS_test$hc_y - fcFS_center_values[5]) / fcFS_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

fcFS_validate$hit_distance_sc <- (fcFS_validate$hit_distance_sc - fcFS_center_values[1]) / fcFS_scale_values[1]

fcFS_validate$hit_speed <- (fcFS_validate$hit_speed - fcFS_center_values[2]) / fcFS_scale_values[2]

fcFS_validate$hit_angle <- (fcFS_validate$hit_angle - fcFS_center_values[3]) / fcFS_scale_values[3]

fcFS_validate$hc_x <- (fcFS_validate$hc_x - fcFS_center_values[4]) / fcFS_scale_values[4]

fcFS_validate$hc_y <- (fcFS_validate$hc_y - fcFS_center_values[5]) / fcFS_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(fcFS_train)

set.seed(42)
fcFS_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(fcFS_train, -row), ntree = 501, importance = TRUE)

print(fcFS_rf.1)

plot(fcFS_rf.1)

varImpPlot(fcFS_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
fcFS_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(fcFS_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(fcFS_rf.5)

plot(fcFS_rf.5)

varImpPlot(fcFS_rf.5)

fcFS_predict_fit.rf.5 <- data.frame(fits = predict(fcFS_rf.5, fcFS_test, type = "prob")[,2], actuals = fcFS_test$hit)

fcFS_pred.rf.5 <- prediction(fcFS_predict_fit.rf.5$fits, fcFS_predict_fit.rf.5$actuals)

fcFS_roc.pred.rf.5 <- performance(fcFS_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(fcFS_roc.pred.rf.5)
abline(a = 0, b = 1)
fcFS_opt <- opt.cut(fcFS_roc.pred.rf.5, fcFS_pred.rf.5)
fcFS_opt
fcFS_opt <- fcFS_opt[3]
fcFS_predict_fit.rf.5$fits <- with(fcFS_predict_fit.rf.5, ifelse(fits > fcFS_opt, 1, 0)) 

str(fcFS_test)

#fcFS_test$fieldingTeam <- as.character(fcFS_test$fieldingTeam)
#fcFS_test$home_team <- as.character(fcFS_test$home_team)
#fcFS_test$hit <- as.logical(fcFS_test$hit)
#fcFS_test$stand <- as.logical(fcFS_test$stand)
str(fcFS_test)
fcFS_rf.5_confusion_test <- confusionMatrix(model = fcFS_rf.5, x = fcFS_test, y = fcFS_test$hit)
fcFS_rf.5_confusion_validate <- confusionMatrix(model = fcFS_rf.5, x = fcFS_validate, y = fcFS_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


fcFS_test_rows <- fcFS_test$row
fcFS_validate_rows <- fcFS_validate$row
fcFS_pred_data_emp_1 <- ungroup(fcFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcFS_test_rows)

fcFS_pred_data_emp <- ungroup(fcFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcFS_validate_rows) %>%
	rbind(fcFS_pred_data_emp_1)

fcFS_out_of_training_rows <- fcFS_pred_data_emp$row

fcFS_rf.5_full_out_of_sample_data <- ungroup(fcFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcFS_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



fcFS_rf.5_full_out_of_sample_data_scaled <- fcFS_rf.5_full_out_of_sample_data

fcFS_rf.5_full_out_of_sample_data_scaled$hit_speed <- (fcFS_rf.5_full_out_of_sample_data_scaled$hit_speed - fcFS_center_values[2]) / fcFS_scale_values[2]

fcFS_rf.5_full_out_of_sample_data_scaled$hit_angle <- (fcFS_rf.5_full_out_of_sample_data_scaled$hit_angle - fcFS_center_values[3]) / fcFS_scale_values[3]

fcFS_rf.5.prob <- predict(fcFS_rf.5, fcFS_rf.5_full_out_of_sample_data_scaled, type = "response")

fcFS_rf.5_full_out_of_sample_data <- cbind(filter(fcFS_rf.5_full_out_of_sample_data, row %in% fcFS_out_of_training_rows), fcFS_rf.5.prob)

names(fcFS_rf.5_full_out_of_sample_data)[65] <- "fits"
names(fcFS_rf.5_full_out_of_sample_data)

fcFS_rf.5_full_out_of_sample_data_reduced <- fcFS_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

fcFS_rf.5_mean_table <- fcFS_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

fcFS_rf.5_full_out_of_sample_data$type <- with(fcFS_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

fcFS_rf.5_full_out_of_sample_data$hit_label <- with(fcFS_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

fcFS_rf.5_plot1 <- ggplot(fcFS_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcFS_rf.5_plot1

fcFS_rf.5_plot2 <- ggplot(fcFS_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcFS_rf.5_plot2

fcFS_rf.5_plot3 <- ggplot(fcFS_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcFS_rf.5_plot3

fcFS_grid_plot_rf.5 <- grid.arrange(fcFS_rf.5_plot1, fcFS_rf.5_plot2, fcFS_rf.5_plot3, ncol = 3)
fcFS_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

fcFS_test_rows <- fcFS_test$row
fcFS_validate_rows <- fcFS_validate$row
fcFS_pred_data_emp_1 <- ungroup(fcFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcFS_test_rows)

fcFS_pred_data_emp <- ungroup(fcFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcFS_validate_rows) %>%
	rbind(fcFS_pred_data_emp_1)

fcFS_out_of_training_rows <- fcFS_pred_data_emp$row

fcFS_pred_data_emp <- ungroup(fcFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcFS_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

fcFS_pred_data_emp_scaled <- fcFS_pred_data_emp

fcFS_pred_data_emp_scaled$hit_speed <- (fcFS_pred_data_emp_scaled$hit_speed - fcFS_center_values[2]) / fcFS_scale_values[2]

fcFS_pred_data_emp_scaled$hit_angle <- (fcFS_pred_data_emp_scaled$hit_angle - fcFS_center_values[3]) / fcFS_scale_values[3]

fcFS_pred_prob_hit <- predict(fcFS_rf.5, fcFS_pred_data_emp_scaled, type = "prob")[,2]
fcFS_pred_prob_hit_fits <- cbind(fcFS_pred_data_emp, fcFS_pred_prob_hit)

fcFS_pred_prob_hit_fits[,c(1:2)] <- fcFS_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

fcFS_angle_speed_pred <- fcFS_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = fcFS_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFC-FS Hit Probability\n") + theme_bp_grey()

fcFS_angle_speed_pred
#####
chFS$hit_distance_sc <- as.numeric(chFS$hit_distance_sc, na.rm = TRUE)
chFS$hit_angle <- as.numeric(chFS$hit_angle, na.rm = TRUE)
chFS$hit_speed <- as.numeric(chFS$hit_speed, na.rm = TRUE)

chFS$hit <- with(chFS, ifelse(grepl("Single", chFS$events), 1,
															ifelse(grepl("Double", chFS$events), 1,
																		 ifelse(grepl("Triple", chFS$events), 1, 
																		 			 ifelse(grepl("Home Run", chFS$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

chFS$fieldingTeam <- with(chFS, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[chFS$hit_distance_sc == "null"] = NA
#chFS$hit_speed[chFS$hit_speed == "null"] = NA
#chFS$hit_angle[chFS$hit_angle == "null"] = NA

# include row names for unique record identification

chFS$row <- row.names(chFS) %>% as.numeric()

# recode stand and home_team as factors

chFS$stand <- as.factor(chFS$stand)
chFS$home_team <- as.factor(chFS$home_team)


chFS$game_date <- as.Date(chFS$game_date)


# subset 

chFS_working_data <- ungroup(chFS) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(chFS_working_data)
str(ungroup(chFS))
table(chFS_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

chFS_working_data <- filter(chFS_working_data, hc_x != 1, hc_y != 1)
head(chFS_working_data)

# create training and test sets
# scaled data

set.seed(42)
chFS_train <- sample_frac(chFS_working_data, .15, replace = FALSE)
chFS_split <- setdiff(chFS_working_data, chFS_train)
chFS_test <- sample_frac(chFS_split, .50, replace = FALSE)
chFS_validate <- setdiff(chFS_split, chFS_test)

nrow(chFS_train) + nrow(chFS_test) + nrow(chFS_validate) == nrow(chFS_working_data)

with(chFS_train, table(hit)) %>% prop.table()
with(chFS_test, table(hit)) %>% prop.table()
with(chFS_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(chFS)
##as.numeric(chFS$hit_distance_sc, chFS$hit_speed, chFS$hit_angle)

#chFS_train$hit_distance_sc <- as.numeric(chFS_train$hit_distance_sc)
#chFS_train$hit_speed <- as.numeric(chFS_train$hit_speed)
#chFS_train$hit_angle <- as.numeric(chFS_train$hit_angle)
#View(chFS_train)
chFS_scaled_data <- scale(chFS_train[,c(1:5)])
chFS_scale_values <- attr(chFS_scaled_data, 'scaled:scale')
chFS_scale_values
chFS_center_values <- attr(chFS_scaled_data, 'scaled:center')
chFS_center_values
chFS_train <- cbind(chFS_scaled_data, select(chFS_train, hit:row))

# save levels for factor variables
chFS_levels_home_team <- levels(chFS_train$home_team)
chFS_levels_stand <- levels(chFS_train$stand)
chFS_levels_fieldingTeam <- levels(chFS_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(chFS_test)

chFS_test$hit_distance_sc <- (chFS_test$hit_distance_sc - chFS_center_values[1]) / chFS_scale_values[1]

chFS_test$hit_speed <- (chFS_test$hit_speed - chFS_center_values[2]) / chFS_scale_values[2]

chFS_test$hit_angle <- (chFS_test$hit_angle - chFS_center_values[3]) / chFS_scale_values[3]

chFS_test$hc_x <- (chFS_test$hc_x - chFS_center_values[4]) / chFS_scale_values[4]

chFS_test$hc_y <- (chFS_test$hc_y - chFS_center_values[5]) / chFS_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

chFS_validate$hit_distance_sc <- (chFS_validate$hit_distance_sc - chFS_center_values[1]) / chFS_scale_values[1]

chFS_validate$hit_speed <- (chFS_validate$hit_speed - chFS_center_values[2]) / chFS_scale_values[2]

chFS_validate$hit_angle <- (chFS_validate$hit_angle - chFS_center_values[3]) / chFS_scale_values[3]

chFS_validate$hc_x <- (chFS_validate$hc_x - chFS_center_values[4]) / chFS_scale_values[4]

chFS_validate$hc_y <- (chFS_validate$hc_y - chFS_center_values[5]) / chFS_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(chFS_train)

set.seed(42)
chFS_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(chFS_train, -row), ntree = 501, importance = TRUE)

print(chFS_rf.1)

plot(chFS_rf.1)

varImpPlot(chFS_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
chFS_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(chFS_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(chFS_rf.5)

plot(chFS_rf.5)

varImpPlot(chFS_rf.5)

chFS_predict_fit.rf.5 <- data.frame(fits = predict(chFS_rf.5, chFS_test, type = "prob")[,2], actuals = chFS_test$hit)

chFS_pred.rf.5 <- prediction(chFS_predict_fit.rf.5$fits, chFS_predict_fit.rf.5$actuals)

chFS_roc.pred.rf.5 <- performance(chFS_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(chFS_roc.pred.rf.5)
abline(a = 0, b = 1)
chFS_opt <- opt.cut(chFS_roc.pred.rf.5, chFS_pred.rf.5)
chFS_opt
chFS_opt <- chFS_opt[3]
chFS_predict_fit.rf.5$fits <- with(chFS_predict_fit.rf.5, ifelse(fits > chFS_opt, 1, 0)) 

str(chFS_test)

#chFS_test$fieldingTeam <- as.character(chFS_test$fieldingTeam)
#chFS_test$home_team <- as.character(chFS_test$home_team)
#chFS_test$hit <- as.logical(chFS_test$hit)
#chFS_test$stand <- as.logical(chFS_test$stand)
str(chFS_test)
chFS_rf.5_confusion_test <- confusionMatrix(model = chFS_rf.5, x = chFS_test, y = chFS_test$hit)
chFS_rf.5_confusion_validate <- confusionMatrix(model = chFS_rf.5, x = chFS_validate, y = chFS_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


chFS_test_rows <- chFS_test$row
chFS_validate_rows <- chFS_validate$row
chFS_pred_data_emp_1 <- ungroup(chFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFS_test_rows)

chFS_pred_data_emp <- ungroup(chFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFS_validate_rows) %>%
	rbind(chFS_pred_data_emp_1)

chFS_out_of_training_rows <- chFS_pred_data_emp$row

chFS_rf.5_full_out_of_sample_data <- ungroup(chFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFS_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



chFS_rf.5_full_out_of_sample_data_scaled <- chFS_rf.5_full_out_of_sample_data

chFS_rf.5_full_out_of_sample_data_scaled$hit_speed <- (chFS_rf.5_full_out_of_sample_data_scaled$hit_speed - chFS_center_values[2]) / chFS_scale_values[2]

chFS_rf.5_full_out_of_sample_data_scaled$hit_angle <- (chFS_rf.5_full_out_of_sample_data_scaled$hit_angle - chFS_center_values[3]) / chFS_scale_values[3]

chFS_rf.5.prob <- predict(chFS_rf.5, chFS_rf.5_full_out_of_sample_data_scaled, type = "response")

chFS_rf.5_full_out_of_sample_data <- cbind(filter(chFS_rf.5_full_out_of_sample_data, row %in% chFS_out_of_training_rows), chFS_rf.5.prob)

names(chFS_rf.5_full_out_of_sample_data)[65] <- "fits"
names(chFS_rf.5_full_out_of_sample_data)

chFS_rf.5_full_out_of_sample_data_reduced <- chFS_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

chFS_rf.5_mean_table <- chFS_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

chFS_rf.5_full_out_of_sample_data$type <- with(chFS_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

chFS_rf.5_full_out_of_sample_data$hit_label <- with(chFS_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

chFS_rf.5_plot1 <- ggplot(chFS_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chFS_rf.5_plot1

chFS_rf.5_plot2 <- ggplot(chFS_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chFS_rf.5_plot2

chFS_rf.5_plot3 <- ggplot(chFS_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chFS_rf.5_plot3

chFS_grid_plot_rf.5 <- grid.arrange(chFS_rf.5_plot1, chFS_rf.5_plot2, chFS_rf.5_plot3, ncol = 3)
chFS_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

chFS_test_rows <- chFS_test$row
chFS_validate_rows <- chFS_validate$row
chFS_pred_data_emp_1 <- ungroup(chFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFS_test_rows)

chFS_pred_data_emp <- ungroup(chFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFS_validate_rows) %>%
	rbind(chFS_pred_data_emp_1)

chFS_out_of_training_rows <- chFS_pred_data_emp$row

chFS_pred_data_emp <- ungroup(chFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chFS_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

chFS_pred_data_emp_scaled <- chFS_pred_data_emp

chFS_pred_data_emp_scaled$hit_speed <- (chFS_pred_data_emp_scaled$hit_speed - chFS_center_values[2]) / chFS_scale_values[2]

chFS_pred_data_emp_scaled$hit_angle <- (chFS_pred_data_emp_scaled$hit_angle - chFS_center_values[3]) / chFS_scale_values[3]

chFS_pred_prob_hit <- predict(chFS_rf.5, chFS_pred_data_emp_scaled, type = "prob")[,2]
chFS_pred_prob_hit_fits <- cbind(chFS_pred_data_emp, chFS_pred_prob_hit)

chFS_pred_prob_hit_fits[,c(1:2)] <- chFS_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

chFS_angle_speed_pred <- chFS_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = chFS_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nCH-FS Hit Probability\n") + theme_bp_grey()

chFS_angle_speed_pred
#####
ftFS$hit_distance_sc <- as.numeric(ftFS$hit_distance_sc, na.rm = TRUE)
ftFS$hit_angle <- as.numeric(ftFS$hit_angle, na.rm = TRUE)
ftFS$hit_speed <- as.numeric(ftFS$hit_speed, na.rm = TRUE)

ftFS$hit <- with(ftFS, ifelse(grepl("Single", ftFS$events), 1,
															ifelse(grepl("Double", ftFS$events), 1,
																		 ifelse(grepl("Triple", ftFS$events), 1, 
																		 			 ifelse(grepl("Home Run", ftFS$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

ftFS$fieldingTeam <- with(ftFS, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[ftFS$hit_distance_sc == "null"] = NA
#ftFS$hit_speed[ftFS$hit_speed == "null"] = NA
#ftFS$hit_angle[ftFS$hit_angle == "null"] = NA

# include row names for unique record identification

ftFS$row <- row.names(ftFS) %>% as.numeric()

# recode stand and home_team as factors

ftFS$stand <- as.factor(ftFS$stand)
ftFS$home_team <- as.factor(ftFS$home_team)


ftFS$game_date <- as.Date(ftFS$game_date)


# subset 

ftFS_working_data <- ungroup(ftFS) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(ftFS_working_data)
str(ungroup(ftFS))
table(ftFS_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

ftFS_working_data <- filter(ftFS_working_data, hc_x != 1, hc_y != 1)
head(ftFS_working_data)

# create training and test sets
# scaled data

set.seed(42)
ftFS_train <- sample_frac(ftFS_working_data, .15, replace = FALSE)
ftFS_split <- setdiff(ftFS_working_data, ftFS_train)
ftFS_test <- sample_frac(ftFS_split, .50, replace = FALSE)
ftFS_validate <- setdiff(ftFS_split, ftFS_test)

nrow(ftFS_train) + nrow(ftFS_test) + nrow(ftFS_validate) == nrow(ftFS_working_data)

with(ftFS_train, table(hit)) %>% prop.table()
with(ftFS_test, table(hit)) %>% prop.table()
with(ftFS_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(ftFS)
##as.numeric(ftFS$hit_distance_sc, ftFS$hit_speed, ftFS$hit_angle)

#ftFS_train$hit_distance_sc <- as.numeric(ftFS_train$hit_distance_sc)
#ftFS_train$hit_speed <- as.numeric(ftFS_train$hit_speed)
#ftFS_train$hit_angle <- as.numeric(ftFS_train$hit_angle)
#View(ftFS_train)
ftFS_scaled_data <- scale(ftFS_train[,c(1:5)])
ftFS_scale_values <- attr(ftFS_scaled_data, 'scaled:scale')
ftFS_scale_values
ftFS_center_values <- attr(ftFS_scaled_data, 'scaled:center')
ftFS_center_values
ftFS_train <- cbind(ftFS_scaled_data, select(ftFS_train, hit:row))

# save levels for factor variables
ftFS_levels_home_team <- levels(ftFS_train$home_team)
ftFS_levels_stand <- levels(ftFS_train$stand)
ftFS_levels_fieldingTeam <- levels(ftFS_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(ftFS_test)

ftFS_test$hit_distance_sc <- (ftFS_test$hit_distance_sc - ftFS_center_values[1]) / ftFS_scale_values[1]

ftFS_test$hit_speed <- (ftFS_test$hit_speed - ftFS_center_values[2]) / ftFS_scale_values[2]

ftFS_test$hit_angle <- (ftFS_test$hit_angle - ftFS_center_values[3]) / ftFS_scale_values[3]

ftFS_test$hc_x <- (ftFS_test$hc_x - ftFS_center_values[4]) / ftFS_scale_values[4]

ftFS_test$hc_y <- (ftFS_test$hc_y - ftFS_center_values[5]) / ftFS_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

ftFS_validate$hit_distance_sc <- (ftFS_validate$hit_distance_sc - ftFS_center_values[1]) / ftFS_scale_values[1]

ftFS_validate$hit_speed <- (ftFS_validate$hit_speed - ftFS_center_values[2]) / ftFS_scale_values[2]

ftFS_validate$hit_angle <- (ftFS_validate$hit_angle - ftFS_center_values[3]) / ftFS_scale_values[3]

ftFS_validate$hc_x <- (ftFS_validate$hc_x - ftFS_center_values[4]) / ftFS_scale_values[4]

ftFS_validate$hc_y <- (ftFS_validate$hc_y - ftFS_center_values[5]) / ftFS_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(ftFS_train)

set.seed(42)
ftFS_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(ftFS_train, -row), ntree = 501, importance = TRUE)

print(ftFS_rf.1)

plot(ftFS_rf.1)

varImpPlot(ftFS_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
ftFS_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(ftFS_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(ftFS_rf.5)

plot(ftFS_rf.5)

varImpPlot(ftFS_rf.5)

ftFS_predict_fit.rf.5 <- data.frame(fits = predict(ftFS_rf.5, ftFS_test, type = "prob")[,2], actuals = ftFS_test$hit)

ftFS_pred.rf.5 <- prediction(ftFS_predict_fit.rf.5$fits, ftFS_predict_fit.rf.5$actuals)

ftFS_roc.pred.rf.5 <- performance(ftFS_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(ftFS_roc.pred.rf.5)
abline(a = 0, b = 1)
ftFS_opt <- opt.cut(ftFS_roc.pred.rf.5, ftFS_pred.rf.5)
ftFS_opt
ftFS_opt <- ftFS_opt[3]
ftFS_predict_fit.rf.5$fits <- with(ftFS_predict_fit.rf.5, ifelse(fits > ftFS_opt, 1, 0)) 

str(ftFS_test)

#ftFS_test$fieldingTeam <- as.character(ftFS_test$fieldingTeam)
#ftFS_test$home_team <- as.character(ftFS_test$home_team)
#ftFS_test$hit <- as.logical(ftFS_test$hit)
#ftFS_test$stand <- as.logical(ftFS_test$stand)
str(ftFS_test)
ftFS_rf.5_confusion_test <- confusionMatrix(model = ftFS_rf.5, x = ftFS_test, y = ftFS_test$hit)
ftFS_rf.5_confusion_validate <- confusionMatrix(model = ftFS_rf.5, x = ftFS_validate, y = ftFS_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


ftFS_test_rows <- ftFS_test$row
ftFS_validate_rows <- ftFS_validate$row
ftFS_pred_data_emp_1 <- ungroup(ftFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftFS_test_rows)

ftFS_pred_data_emp <- ungroup(ftFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftFS_validate_rows) %>%
	rbind(ftFS_pred_data_emp_1)

ftFS_out_of_training_rows <- ftFS_pred_data_emp$row

ftFS_rf.5_full_out_of_sample_data <- ungroup(ftFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftFS_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



ftFS_rf.5_full_out_of_sample_data_scaled <- ftFS_rf.5_full_out_of_sample_data

ftFS_rf.5_full_out_of_sample_data_scaled$hit_speed <- (ftFS_rf.5_full_out_of_sample_data_scaled$hit_speed - ftFS_center_values[2]) / ftFS_scale_values[2]

ftFS_rf.5_full_out_of_sample_data_scaled$hit_angle <- (ftFS_rf.5_full_out_of_sample_data_scaled$hit_angle - ftFS_center_values[3]) / ftFS_scale_values[3]

ftFS_rf.5.prob <- predict(ftFS_rf.5, ftFS_rf.5_full_out_of_sample_data_scaled, type = "response")

ftFS_rf.5_full_out_of_sample_data <- cbind(filter(ftFS_rf.5_full_out_of_sample_data, row %in% ftFS_out_of_training_rows), ftFS_rf.5.prob)

names(ftFS_rf.5_full_out_of_sample_data)[65] <- "fits"
names(ftFS_rf.5_full_out_of_sample_data)

ftFS_rf.5_full_out_of_sample_data_reduced <- ftFS_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

ftFS_rf.5_mean_table <- ftFS_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

ftFS_rf.5_full_out_of_sample_data$type <- with(ftFS_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

ftFS_rf.5_full_out_of_sample_data$hit_label <- with(ftFS_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

ftFS_rf.5_plot1 <- ggplot(ftFS_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftFS_rf.5_plot1

ftFS_rf.5_plot2 <- ggplot(ftFS_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftFS_rf.5_plot2

ftFS_rf.5_plot3 <- ggplot(ftFS_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftFS_rf.5_plot3

ftFS_grid_plot_rf.5 <- grid.arrange(ftFS_rf.5_plot1, ftFS_rf.5_plot2, ftFS_rf.5_plot3, ncol = 3)
ftFS_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

ftFS_test_rows <- ftFS_test$row
ftFS_validate_rows <- ftFS_validate$row
ftFS_pred_data_emp_1 <- ungroup(ftFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftFS_test_rows)

ftFS_pred_data_emp <- ungroup(ftFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftFS_validate_rows) %>%
	rbind(ftFS_pred_data_emp_1)

ftFS_out_of_training_rows <- ftFS_pred_data_emp$row

ftFS_pred_data_emp <- ungroup(ftFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftFS_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

ftFS_pred_data_emp_scaled <- ftFS_pred_data_emp

ftFS_pred_data_emp_scaled$hit_speed <- (ftFS_pred_data_emp_scaled$hit_speed - ftFS_center_values[2]) / ftFS_scale_values[2]

ftFS_pred_data_emp_scaled$hit_angle <- (ftFS_pred_data_emp_scaled$hit_angle - ftFS_center_values[3]) / ftFS_scale_values[3]

ftFS_pred_prob_hit <- predict(ftFS_rf.5, ftFS_pred_data_emp_scaled, type = "prob")[,2]
ftFS_pred_prob_hit_fits <- cbind(ftFS_pred_data_emp, ftFS_pred_prob_hit)

ftFS_pred_prob_hit_fits[,c(1:2)] <- ftFS_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

ftFS_angle_speed_pred <- ftFS_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = ftFS_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFT-FS Hit Probability\n") + theme_bp_grey()

ftFS_angle_speed_pred
#####
slFS$hit_distance_sc <- as.numeric(slFS$hit_distance_sc, na.rm = TRUE)
slFS$hit_angle <- as.numeric(slFS$hit_angle, na.rm = TRUE)
slFS$hit_speed <- as.numeric(slFS$hit_speed, na.rm = TRUE)

slFS$hit <- with(slFS, ifelse(grepl("Single", slFS$events), 1,
															ifelse(grepl("Double", slFS$events), 1,
																		 ifelse(grepl("Triple", slFS$events), 1, 
																		 			 ifelse(grepl("Home Run", slFS$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

slFS$fieldingTeam <- with(slFS, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[slFS$hit_distance_sc == "null"] = NA
#slFS$hit_speed[slFS$hit_speed == "null"] = NA
#slFS$hit_angle[slFS$hit_angle == "null"] = NA

# include row names for unique record identification

slFS$row <- row.names(slFS) %>% as.numeric()

# recode stand and home_team as factors

slFS$stand <- as.factor(slFS$stand)
slFS$home_team <- as.factor(slFS$home_team)


slFS$game_date <- as.Date(slFS$game_date)


# subset 

slFS_working_data <- ungroup(slFS) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(slFS_working_data)
str(ungroup(slFS))
table(slFS_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

slFS_working_data <- filter(slFS_working_data, hc_x != 1, hc_y != 1)
head(slFS_working_data)

# create training and test sets
# scaled data

set.seed(42)
slFS_train <- sample_frac(slFS_working_data, .15, replace = FALSE)
slFS_split <- setdiff(slFS_working_data, slFS_train)
slFS_test <- sample_frac(slFS_split, .50, replace = FALSE)
slFS_validate <- setdiff(slFS_split, slFS_test)

nrow(slFS_train) + nrow(slFS_test) + nrow(slFS_validate) == nrow(slFS_working_data)

with(slFS_train, table(hit)) %>% prop.table()
with(slFS_test, table(hit)) %>% prop.table()
with(slFS_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(slFS)
##as.numeric(slFS$hit_distance_sc, slFS$hit_speed, slFS$hit_angle)

#slFS_train$hit_distance_sc <- as.numeric(slFS_train$hit_distance_sc)
#slFS_train$hit_speed <- as.numeric(slFS_train$hit_speed)
#slFS_train$hit_angle <- as.numeric(slFS_train$hit_angle)
#View(slFS_train)
slFS_scaled_data <- scale(slFS_train[,c(1:5)])
slFS_scale_values <- attr(slFS_scaled_data, 'scaled:scale')
slFS_scale_values
slFS_center_values <- attr(slFS_scaled_data, 'scaled:center')
slFS_center_values
slFS_train <- cbind(slFS_scaled_data, select(slFS_train, hit:row))

# save levels for factor variables
slFS_levels_home_team <- levels(slFS_train$home_team)
slFS_levels_stand <- levels(slFS_train$stand)
slFS_levels_fieldingTeam <- levels(slFS_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(slFS_test)

slFS_test$hit_distance_sc <- (slFS_test$hit_distance_sc - slFS_center_values[1]) / slFS_scale_values[1]

slFS_test$hit_speed <- (slFS_test$hit_speed - slFS_center_values[2]) / slFS_scale_values[2]

slFS_test$hit_angle <- (slFS_test$hit_angle - slFS_center_values[3]) / slFS_scale_values[3]

slFS_test$hc_x <- (slFS_test$hc_x - slFS_center_values[4]) / slFS_scale_values[4]

slFS_test$hc_y <- (slFS_test$hc_y - slFS_center_values[5]) / slFS_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

slFS_validate$hit_distance_sc <- (slFS_validate$hit_distance_sc - slFS_center_values[1]) / slFS_scale_values[1]

slFS_validate$hit_speed <- (slFS_validate$hit_speed - slFS_center_values[2]) / slFS_scale_values[2]

slFS_validate$hit_angle <- (slFS_validate$hit_angle - slFS_center_values[3]) / slFS_scale_values[3]

slFS_validate$hc_x <- (slFS_validate$hc_x - slFS_center_values[4]) / slFS_scale_values[4]

slFS_validate$hc_y <- (slFS_validate$hc_y - slFS_center_values[5]) / slFS_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(slFS_train)

set.seed(42)
slFS_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(slFS_train, -row), ntree = 501, importance = TRUE)

print(slFS_rf.1)

plot(slFS_rf.1)

varImpPlot(slFS_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
slFS_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(slFS_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(slFS_rf.5)

plot(slFS_rf.5)

varImpPlot(slFS_rf.5)

slFS_predict_fit.rf.5 <- data.frame(fits = predict(slFS_rf.5, slFS_test, type = "prob")[,2], actuals = slFS_test$hit)

slFS_pred.rf.5 <- prediction(slFS_predict_fit.rf.5$fits, slFS_predict_fit.rf.5$actuals)

slFS_roc.pred.rf.5 <- performance(slFS_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(slFS_roc.pred.rf.5)
abline(a = 0, b = 1)
slFS_opt <- opt.cut(slFS_roc.pred.rf.5, slFS_pred.rf.5)
slFS_opt
slFS_opt <- slFS_opt[3]
slFS_predict_fit.rf.5$fits <- with(slFS_predict_fit.rf.5, ifelse(fits > slFS_opt, 1, 0)) 

str(slFS_test)

#slFS_test$fieldingTeam <- as.character(slFS_test$fieldingTeam)
#slFS_test$home_team <- as.character(slFS_test$home_team)
#slFS_test$hit <- as.logical(slFS_test$hit)
#slFS_test$stand <- as.logical(slFS_test$stand)
str(slFS_test)
slFS_rf.5_confusion_test <- confusionMatrix(model = slFS_rf.5, x = slFS_test, y = slFS_test$hit)
slFS_rf.5_confusion_validate <- confusionMatrix(model = slFS_rf.5, x = slFS_validate, y = slFS_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


slFS_test_rows <- slFS_test$row
slFS_validate_rows <- slFS_validate$row
slFS_pred_data_emp_1 <- ungroup(slFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFS_test_rows)

slFS_pred_data_emp <- ungroup(slFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFS_validate_rows) %>%
	rbind(slFS_pred_data_emp_1)

slFS_out_of_training_rows <- slFS_pred_data_emp$row

slFS_rf.5_full_out_of_sample_data <- ungroup(slFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFS_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



slFS_rf.5_full_out_of_sample_data_scaled <- slFS_rf.5_full_out_of_sample_data

slFS_rf.5_full_out_of_sample_data_scaled$hit_speed <- (slFS_rf.5_full_out_of_sample_data_scaled$hit_speed - slFS_center_values[2]) / slFS_scale_values[2]

slFS_rf.5_full_out_of_sample_data_scaled$hit_angle <- (slFS_rf.5_full_out_of_sample_data_scaled$hit_angle - slFS_center_values[3]) / slFS_scale_values[3]

slFS_rf.5.prob <- predict(slFS_rf.5, slFS_rf.5_full_out_of_sample_data_scaled, type = "response")

slFS_rf.5_full_out_of_sample_data <- cbind(filter(slFS_rf.5_full_out_of_sample_data, row %in% slFS_out_of_training_rows), slFS_rf.5.prob)

names(slFS_rf.5_full_out_of_sample_data)[65] <- "fits"
names(slFS_rf.5_full_out_of_sample_data)

slFS_rf.5_full_out_of_sample_data_reduced <- slFS_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

slFS_rf.5_mean_table <- slFS_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

slFS_rf.5_full_out_of_sample_data$type <- with(slFS_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

slFS_rf.5_full_out_of_sample_data$hit_label <- with(slFS_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

slFS_rf.5_plot1 <- ggplot(slFS_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slFS_rf.5_plot1

slFS_rf.5_plot2 <- ggplot(slFS_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slFS_rf.5_plot2

slFS_rf.5_plot3 <- ggplot(slFS_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slFS_rf.5_plot3

slFS_grid_plot_rf.5 <- grid.arrange(slFS_rf.5_plot1, slFS_rf.5_plot2, slFS_rf.5_plot3, ncol = 3)
slFS_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

slFS_test_rows <- slFS_test$row
slFS_validate_rows <- slFS_validate$row
slFS_pred_data_emp_1 <- ungroup(slFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFS_test_rows)

slFS_pred_data_emp <- ungroup(slFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFS_validate_rows) %>%
	rbind(slFS_pred_data_emp_1)

slFS_out_of_training_rows <- slFS_pred_data_emp$row

slFS_pred_data_emp <- ungroup(slFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slFS_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

slFS_pred_data_emp_scaled <- slFS_pred_data_emp

slFS_pred_data_emp_scaled$hit_speed <- (slFS_pred_data_emp_scaled$hit_speed - slFS_center_values[2]) / slFS_scale_values[2]

slFS_pred_data_emp_scaled$hit_angle <- (slFS_pred_data_emp_scaled$hit_angle - slFS_center_values[3]) / slFS_scale_values[3]

slFS_pred_prob_hit <- predict(slFS_rf.5, slFS_pred_data_emp_scaled, type = "prob")[,2]
slFS_pred_prob_hit_fits <- cbind(slFS_pred_data_emp, slFS_pred_prob_hit)

slFS_pred_prob_hit_fits[,c(1:2)] <- slFS_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

slFS_angle_speed_pred <- slFS_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = slFS_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nSL-FS Hit Probability\n") + theme_bp_grey()

slFS_angle_speed_pred
#####
cuFS$hit_distance_sc <- as.numeric(cuFS$hit_distance_sc, na.rm = TRUE)
cuFS$hit_angle <- as.numeric(cuFS$hit_angle, na.rm = TRUE)
cuFS$hit_speed <- as.numeric(cuFS$hit_speed, na.rm = TRUE)

cuFS$hit <- with(cuFS, ifelse(grepl("Single", cuFS$events), 1,
															ifelse(grepl("Double", cuFS$events), 1,
																		 ifelse(grepl("Triple", cuFS$events), 1, 
																		 			 ifelse(grepl("Home Run", cuFS$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

cuFS$fieldingTeam <- with(cuFS, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[cuFS$hit_distance_sc == "null"] = NA
#cuFS$hit_speed[cuFS$hit_speed == "null"] = NA
#cuFS$hit_angle[cuFS$hit_angle == "null"] = NA

# include row names for unique record identification

cuFS$row <- row.names(cuFS) %>% as.numeric()

# recode stand and home_team as factors

cuFS$stand <- as.factor(cuFS$stand)
cuFS$home_team <- as.factor(cuFS$home_team)


cuFS$game_date <- as.Date(cuFS$game_date)


# subset 

cuFS_working_data <- ungroup(cuFS) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(cuFS_working_data)
str(ungroup(cuFS))
table(cuFS_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

cuFS_working_data <- filter(cuFS_working_data, hc_x != 1, hc_y != 1)
head(cuFS_working_data)

# create training and test sets
# scaled data

set.seed(42)
cuFS_train <- sample_frac(cuFS_working_data, .15, replace = FALSE)
cuFS_split <- setdiff(cuFS_working_data, cuFS_train)
cuFS_test <- sample_frac(cuFS_split, .50, replace = FALSE)
cuFS_validate <- setdiff(cuFS_split, cuFS_test)

nrow(cuFS_train) + nrow(cuFS_test) + nrow(cuFS_validate) == nrow(cuFS_working_data)

with(cuFS_train, table(hit)) %>% prop.table()
with(cuFS_test, table(hit)) %>% prop.table()
with(cuFS_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(cuFS)
##as.numeric(cuFS$hit_distance_sc, cuFS$hit_speed, cuFS$hit_angle)

#cuFS_train$hit_distance_sc <- as.numeric(cuFS_train$hit_distance_sc)
#cuFS_train$hit_speed <- as.numeric(cuFS_train$hit_speed)
#cuFS_train$hit_angle <- as.numeric(cuFS_train$hit_angle)
#View(cuFS_train)
cuFS_scaled_data <- scale(cuFS_train[,c(1:5)])
cuFS_scale_values <- attr(cuFS_scaled_data, 'scaled:scale')
cuFS_scale_values
cuFS_center_values <- attr(cuFS_scaled_data, 'scaled:center')
cuFS_center_values
cuFS_train <- cbind(cuFS_scaled_data, select(cuFS_train, hit:row))

# save levels for factor variables
cuFS_levels_home_team <- levels(cuFS_train$home_team)
cuFS_levels_stand <- levels(cuFS_train$stand)
cuFS_levels_fieldingTeam <- levels(cuFS_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(cuFS_test)

cuFS_test$hit_distance_sc <- (cuFS_test$hit_distance_sc - cuFS_center_values[1]) / cuFS_scale_values[1]

cuFS_test$hit_speed <- (cuFS_test$hit_speed - cuFS_center_values[2]) / cuFS_scale_values[2]

cuFS_test$hit_angle <- (cuFS_test$hit_angle - cuFS_center_values[3]) / cuFS_scale_values[3]

cuFS_test$hc_x <- (cuFS_test$hc_x - cuFS_center_values[4]) / cuFS_scale_values[4]

cuFS_test$hc_y <- (cuFS_test$hc_y - cuFS_center_values[5]) / cuFS_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

cuFS_validate$hit_distance_sc <- (cuFS_validate$hit_distance_sc - cuFS_center_values[1]) / cuFS_scale_values[1]

cuFS_validate$hit_speed <- (cuFS_validate$hit_speed - cuFS_center_values[2]) / cuFS_scale_values[2]

cuFS_validate$hit_angle <- (cuFS_validate$hit_angle - cuFS_center_values[3]) / cuFS_scale_values[3]

cuFS_validate$hc_x <- (cuFS_validate$hc_x - cuFS_center_values[4]) / cuFS_scale_values[4]

cuFS_validate$hc_y <- (cuFS_validate$hc_y - cuFS_center_values[5]) / cuFS_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(cuFS_train)

set.seed(42)
cuFS_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(cuFS_train, -row), ntree = 501, importance = TRUE)

print(cuFS_rf.1)

plot(cuFS_rf.1)

varImpPlot(cuFS_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
cuFS_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(cuFS_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(cuFS_rf.5)

plot(cuFS_rf.5)

varImpPlot(cuFS_rf.5)

cuFS_predict_fit.rf.5 <- data.frame(fits = predict(cuFS_rf.5, cuFS_test, type = "prob")[,2], actuals = cuFS_test$hit)

cuFS_pred.rf.5 <- prediction(cuFS_predict_fit.rf.5$fits, cuFS_predict_fit.rf.5$actuals)

cuFS_roc.pred.rf.5 <- performance(cuFS_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(cuFS_roc.pred.rf.5)
abline(a = 0, b = 1)
cuFS_opt <- opt.cut(cuFS_roc.pred.rf.5, cuFS_pred.rf.5)
cuFS_opt
cuFS_opt <- cuFS_opt[3]
cuFS_predict_fit.rf.5$fits <- with(cuFS_predict_fit.rf.5, ifelse(fits > cuFS_opt, 1, 0)) 

str(cuFS_test)

#cuFS_test$fieldingTeam <- as.character(cuFS_test$fieldingTeam)
#cuFS_test$home_team <- as.character(cuFS_test$home_team)
#cuFS_test$hit <- as.logical(cuFS_test$hit)
#cuFS_test$stand <- as.logical(cuFS_test$stand)
str(cuFS_test)
cuFS_rf.5_confusion_test <- confusionMatrix(model = cuFS_rf.5, x = cuFS_test, y = cuFS_test$hit)
cuFS_rf.5_confusion_validate <- confusionMatrix(model = cuFS_rf.5, x = cuFS_validate, y = cuFS_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


cuFS_test_rows <- cuFS_test$row
cuFS_validate_rows <- cuFS_validate$row
cuFS_pred_data_emp_1 <- ungroup(cuFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFS_test_rows)

cuFS_pred_data_emp <- ungroup(cuFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFS_validate_rows) %>%
	rbind(cuFS_pred_data_emp_1)

cuFS_out_of_training_rows <- cuFS_pred_data_emp$row

cuFS_rf.5_full_out_of_sample_data <- ungroup(cuFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFS_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



cuFS_rf.5_full_out_of_sample_data_scaled <- cuFS_rf.5_full_out_of_sample_data

cuFS_rf.5_full_out_of_sample_data_scaled$hit_speed <- (cuFS_rf.5_full_out_of_sample_data_scaled$hit_speed - cuFS_center_values[2]) / cuFS_scale_values[2]

cuFS_rf.5_full_out_of_sample_data_scaled$hit_angle <- (cuFS_rf.5_full_out_of_sample_data_scaled$hit_angle - cuFS_center_values[3]) / cuFS_scale_values[3]

cuFS_rf.5.prob <- predict(cuFS_rf.5, cuFS_rf.5_full_out_of_sample_data_scaled, type = "response")

cuFS_rf.5_full_out_of_sample_data <- cbind(filter(cuFS_rf.5_full_out_of_sample_data, row %in% cuFS_out_of_training_rows), cuFS_rf.5.prob)

names(cuFS_rf.5_full_out_of_sample_data)[65] <- "fits"
names(cuFS_rf.5_full_out_of_sample_data)

cuFS_rf.5_full_out_of_sample_data_reduced <- cuFS_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

cuFS_rf.5_mean_table <- cuFS_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

cuFS_rf.5_full_out_of_sample_data$type <- with(cuFS_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

cuFS_rf.5_full_out_of_sample_data$hit_label <- with(cuFS_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

cuFS_rf.5_plot1 <- ggplot(cuFS_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuFS_rf.5_plot1

cuFS_rf.5_plot2 <- ggplot(cuFS_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuFS_rf.5_plot2

cuFS_rf.5_plot3 <- ggplot(cuFS_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuFS_rf.5_plot3

cuFS_grid_plot_rf.5 <- grid.arrange(cuFS_rf.5_plot1, cuFS_rf.5_plot2, cuFS_rf.5_plot3, ncol = 3)
cuFS_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

cuFS_test_rows <- cuFS_test$row
cuFS_validate_rows <- cuFS_validate$row
cuFS_pred_data_emp_1 <- ungroup(cuFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFS_test_rows)

cuFS_pred_data_emp <- ungroup(cuFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFS_validate_rows) %>%
	rbind(cuFS_pred_data_emp_1)

cuFS_out_of_training_rows <- cuFS_pred_data_emp$row

cuFS_pred_data_emp <- ungroup(cuFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuFS_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

cuFS_pred_data_emp_scaled <- cuFS_pred_data_emp

cuFS_pred_data_emp_scaled$hit_speed <- (cuFS_pred_data_emp_scaled$hit_speed - cuFS_center_values[2]) / cuFS_scale_values[2]

cuFS_pred_data_emp_scaled$hit_angle <- (cuFS_pred_data_emp_scaled$hit_angle - cuFS_center_values[3]) / cuFS_scale_values[3]

cuFS_pred_prob_hit <- predict(cuFS_rf.5, cuFS_pred_data_emp_scaled, type = "prob")[,2]
cuFS_pred_prob_hit_fits <- cbind(cuFS_pred_data_emp, cuFS_pred_prob_hit)

cuFS_pred_prob_hit_fits[,c(1:2)] <- cuFS_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

cuFS_angle_speed_pred <- cuFS_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = cuFS_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nCU-FS Hit Probability\n") + theme_bp_grey()

cuFS_angle_speed_pred
#####
ffFS$hit_distance_sc <- as.numeric(ffFS$hit_distance_sc, na.rm = TRUE)
ffFS$hit_angle <- as.numeric(ffFS$hit_angle, na.rm = TRUE)
ffFS$hit_speed <- as.numeric(ffFS$hit_speed, na.rm = TRUE)

ffFS$hit <- with(ffFS, ifelse(grepl("Single", ffFS$events), 1,
															ifelse(grepl("Double", ffFS$events), 1,
																		 ifelse(grepl("Triple", ffFS$events), 1, 
																		 			 ifelse(grepl("Home Run", ffFS$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

ffFS$fieldingTeam <- with(ffFS, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[ffFS$hit_distance_sc == "null"] = NA
#ffFS$hit_speed[ffFS$hit_speed == "null"] = NA
#ffFS$hit_angle[ffFS$hit_angle == "null"] = NA

# include row names for unique record identification

ffFS$row <- row.names(ffFS) %>% as.numeric()

# recode stand and home_team as factors

ffFS$stand <- as.factor(ffFS$stand)
ffFS$home_team <- as.factor(ffFS$home_team)


ffFS$game_date <- as.Date(ffFS$game_date)


# subset 

ffFS_working_data <- ungroup(ffFS) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(ffFS_working_data)
str(ungroup(ffFS))
table(ffFS_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

ffFS_working_data <- filter(ffFS_working_data, hc_x != 1, hc_y != 1)
head(ffFS_working_data)

# create training and test sets
# scaled data

set.seed(42)
ffFS_train <- sample_frac(ffFS_working_data, .15, replace = FALSE)
ffFS_split <- setdiff(ffFS_working_data, ffFS_train)
ffFS_test <- sample_frac(ffFS_split, .50, replace = FALSE)
ffFS_validate <- setdiff(ffFS_split, ffFS_test)

nrow(ffFS_train) + nrow(ffFS_test) + nrow(ffFS_validate) == nrow(ffFS_working_data)

with(ffFS_train, table(hit)) %>% prop.table()
with(ffFS_test, table(hit)) %>% prop.table()
with(ffFS_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(ffFS)
##as.numeric(ffFS$hit_distance_sc, ffFS$hit_speed, ffFS$hit_angle)

#ffFS_train$hit_distance_sc <- as.numeric(ffFS_train$hit_distance_sc)
#ffFS_train$hit_speed <- as.numeric(ffFS_train$hit_speed)
#ffFS_train$hit_angle <- as.numeric(ffFS_train$hit_angle)
#View(ffFS_train)
ffFS_scaled_data <- scale(ffFS_train[,c(1:5)])
ffFS_scale_values <- attr(ffFS_scaled_data, 'scaled:scale')
ffFS_scale_values
ffFS_center_values <- attr(ffFS_scaled_data, 'scaled:center')
ffFS_center_values
ffFS_train <- cbind(ffFS_scaled_data, select(ffFS_train, hit:row))

# save levels for factor variables
ffFS_levels_home_team <- levels(ffFS_train$home_team)
ffFS_levels_stand <- levels(ffFS_train$stand)
ffFS_levels_fieldingTeam <- levels(ffFS_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(ffFS_test)

ffFS_test$hit_distance_sc <- (ffFS_test$hit_distance_sc - ffFS_center_values[1]) / ffFS_scale_values[1]

ffFS_test$hit_speed <- (ffFS_test$hit_speed - ffFS_center_values[2]) / ffFS_scale_values[2]

ffFS_test$hit_angle <- (ffFS_test$hit_angle - ffFS_center_values[3]) / ffFS_scale_values[3]

ffFS_test$hc_x <- (ffFS_test$hc_x - ffFS_center_values[4]) / ffFS_scale_values[4]

ffFS_test$hc_y <- (ffFS_test$hc_y - ffFS_center_values[5]) / ffFS_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

ffFS_validate$hit_distance_sc <- (ffFS_validate$hit_distance_sc - ffFS_center_values[1]) / ffFS_scale_values[1]

ffFS_validate$hit_speed <- (ffFS_validate$hit_speed - ffFS_center_values[2]) / ffFS_scale_values[2]

ffFS_validate$hit_angle <- (ffFS_validate$hit_angle - ffFS_center_values[3]) / ffFS_scale_values[3]

ffFS_validate$hc_x <- (ffFS_validate$hc_x - ffFS_center_values[4]) / ffFS_scale_values[4]

ffFS_validate$hc_y <- (ffFS_validate$hc_y - ffFS_center_values[5]) / ffFS_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(ffFS_train)

set.seed(42)
ffFS_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(ffFS_train, -row), ntree = 501, importance = TRUE)

print(ffFS_rf.1)

plot(ffFS_rf.1)

varImpPlot(ffFS_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
ffFS_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(ffFS_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(ffFS_rf.5)

plot(ffFS_rf.5)

varImpPlot(ffFS_rf.5)

ffFS_predict_fit.rf.5 <- data.frame(fits = predict(ffFS_rf.5, ffFS_test, type = "prob")[,2], actuals = ffFS_test$hit)

ffFS_pred.rf.5 <- prediction(ffFS_predict_fit.rf.5$fits, ffFS_predict_fit.rf.5$actuals)

ffFS_roc.pred.rf.5 <- performance(ffFS_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(ffFS_roc.pred.rf.5)
abline(a = 0, b = 1)
ffFS_opt <- opt.cut(ffFS_roc.pred.rf.5, ffFS_pred.rf.5)
ffFS_opt
ffFS_opt <- ffFS_opt[3]
ffFS_predict_fit.rf.5$fits <- with(ffFS_predict_fit.rf.5, ifelse(fits > ffFS_opt, 1, 0)) 

str(ffFS_test)

#ffFS_test$fieldingTeam <- as.character(ffFS_test$fieldingTeam)
#ffFS_test$home_team <- as.character(ffFS_test$home_team)
#ffFS_test$hit <- as.logical(ffFS_test$hit)
#ffFS_test$stand <- as.logical(ffFS_test$stand)
str(ffFS_test)
ffFS_rf.5_confusion_test <- confusionMatrix(model = ffFS_rf.5, x = ffFS_test, y = ffFS_test$hit)
ffFS_rf.5_confusion_validate <- confusionMatrix(model = ffFS_rf.5, x = ffFS_validate, y = ffFS_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


ffFS_test_rows <- ffFS_test$row
ffFS_validate_rows <- ffFS_validate$row
ffFS_pred_data_emp_1 <- ungroup(ffFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffFS_test_rows)

ffFS_pred_data_emp <- ungroup(ffFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffFS_validate_rows) %>%
	rbind(ffFS_pred_data_emp_1)

ffFS_out_of_training_rows <- ffFS_pred_data_emp$row

ffFS_rf.5_full_out_of_sample_data <- ungroup(ffFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffFS_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



ffFS_rf.5_full_out_of_sample_data_scaled <- ffFS_rf.5_full_out_of_sample_data

ffFS_rf.5_full_out_of_sample_data_scaled$hit_speed <- (ffFS_rf.5_full_out_of_sample_data_scaled$hit_speed - ffFS_center_values[2]) / ffFS_scale_values[2]

ffFS_rf.5_full_out_of_sample_data_scaled$hit_angle <- (ffFS_rf.5_full_out_of_sample_data_scaled$hit_angle - ffFS_center_values[3]) / ffFS_scale_values[3]

ffFS_rf.5.prob <- predict(ffFS_rf.5, ffFS_rf.5_full_out_of_sample_data_scaled, type = "response")

ffFS_rf.5_full_out_of_sample_data <- cbind(filter(ffFS_rf.5_full_out_of_sample_data, row %in% ffFS_out_of_training_rows), ffFS_rf.5.prob)

names(ffFS_rf.5_full_out_of_sample_data)[65] <- "fits"
names(ffFS_rf.5_full_out_of_sample_data)

ffFS_rf.5_full_out_of_sample_data_reduced <- ffFS_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

ffFS_rf.5_mean_table <- ffFS_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

ffFS_rf.5_full_out_of_sample_data$type <- with(ffFS_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

ffFS_rf.5_full_out_of_sample_data$hit_label <- with(ffFS_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

ffFS_rf.5_plot1 <- ggplot(ffFS_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffFS_rf.5_plot1

ffFS_rf.5_plot2 <- ggplot(ffFS_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffFS_rf.5_plot2

ffFS_rf.5_plot3 <- ggplot(ffFS_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffFS_rf.5_plot3

ffFS_grid_plot_rf.5 <- grid.arrange(ffFS_rf.5_plot1, ffFS_rf.5_plot2, ffFS_rf.5_plot3, ncol = 3)
ffFS_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

ffFS_test_rows <- ffFS_test$row
ffFS_validate_rows <- ffFS_validate$row
ffFS_pred_data_emp_1 <- ungroup(ffFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffFS_test_rows)

ffFS_pred_data_emp <- ungroup(ffFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffFS_validate_rows) %>%
	rbind(ffFS_pred_data_emp_1)

ffFS_out_of_training_rows <- ffFS_pred_data_emp$row

ffFS_pred_data_emp <- ungroup(ffFS) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffFS_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

ffFS_pred_data_emp_scaled <- ffFS_pred_data_emp

ffFS_pred_data_emp_scaled$hit_speed <- (ffFS_pred_data_emp_scaled$hit_speed - ffFS_center_values[2]) / ffFS_scale_values[2]

ffFS_pred_data_emp_scaled$hit_angle <- (ffFS_pred_data_emp_scaled$hit_angle - ffFS_center_values[3]) / ffFS_scale_values[3]

ffFS_pred_prob_hit <- predict(ffFS_rf.5, ffFS_pred_data_emp_scaled, type = "prob")[,2]
ffFS_pred_prob_hit_fits <- cbind(ffFS_pred_data_emp, ffFS_pred_prob_hit)

ffFS_pred_prob_hit_fits[,c(1:2)] <- ffFS_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

ffFS_angle_speed_pred <- ffFS_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = ffFS_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFF-FS Hit Probability\n") + theme_bp_grey()

ffFS_angle_speed_pred
############# End Splitters; Start Knuckle Curves
#####
siKC$hit_distance_sc <- as.numeric(siKC$hit_distance_sc, na.rm = TRUE)
siKC$hit_angle <- as.numeric(siKC$hit_angle, na.rm = TRUE)
siKC$hit_speed <- as.numeric(siKC$hit_speed, na.rm = TRUE)

siKC$hit <- with(siKC, ifelse(grepl("Single", siKC$events), 1,
															ifelse(grepl("Double", siKC$events), 1,
																		 ifelse(grepl("Triple", siKC$events), 1, 
																		 			 ifelse(grepl("Home Run", siKC$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

siKC$fieldingTeam <- with(siKC, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[siKC$hit_distance_sc == "null"] = NA
#siKC$hit_speed[siKC$hit_speed == "null"] = NA
#siKC$hit_angle[siKC$hit_angle == "null"] = NA

# include row names for unique record identification

siKC$row <- row.names(siKC) %>% as.numeric()

# recode stand and home_team as factors

siKC$stand <- as.factor(siKC$stand)
siKC$home_team <- as.factor(siKC$home_team)


siKC$game_date <- as.Date(siKC$game_date)


# subset 

siKC_working_data <- ungroup(siKC) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(siKC_working_data)
str(ungroup(siKC))
table(siKC_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

siKC_working_data <- filter(siKC_working_data, hc_x != 1, hc_y != 1)
head(siKC_working_data)

# create training and test sets
# scaled data

set.seed(42)
siKC_train <- sample_frac(siKC_working_data, .15, replace = FALSE)
siKC_split <- setdiff(siKC_working_data, siKC_train)
siKC_test <- sample_frac(siKC_split, .50, replace = FALSE)
siKC_validate <- setdiff(siKC_split, siKC_test)

nrow(siKC_train) + nrow(siKC_test) + nrow(siKC_validate) == nrow(siKC_working_data)

with(siKC_train, table(hit)) %>% prop.table()
with(siKC_test, table(hit)) %>% prop.table()
with(siKC_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(siKC)
##as.numeric(siKC$hit_distance_sc, siKC$hit_speed, siKC$hit_angle)

#siKC_train$hit_distance_sc <- as.numeric(siKC_train$hit_distance_sc)
#siKC_train$hit_speed <- as.numeric(siKC_train$hit_speed)
#siKC_train$hit_angle <- as.numeric(siKC_train$hit_angle)
#View(siKC_train)
siKC_scaled_data <- scale(siKC_train[,c(1:5)])
siKC_scale_values <- attr(siKC_scaled_data, 'scaled:scale')
siKC_scale_values
siKC_center_values <- attr(siKC_scaled_data, 'scaled:center')
siKC_center_values
siKC_train <- cbind(siKC_scaled_data, select(siKC_train, hit:row))

# save levels for factor variables
siKC_levels_home_team <- levels(siKC_train$home_team)
siKC_levels_stand <- levels(siKC_train$stand)
siKC_levels_fieldingTeam <- levels(siKC_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(siKC_test)

siKC_test$hit_distance_sc <- (siKC_test$hit_distance_sc - siKC_center_values[1]) / siKC_scale_values[1]

siKC_test$hit_speed <- (siKC_test$hit_speed - siKC_center_values[2]) / siKC_scale_values[2]

siKC_test$hit_angle <- (siKC_test$hit_angle - siKC_center_values[3]) / siKC_scale_values[3]

siKC_test$hc_x <- (siKC_test$hc_x - siKC_center_values[4]) / siKC_scale_values[4]

siKC_test$hc_y <- (siKC_test$hc_y - siKC_center_values[5]) / siKC_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

siKC_validate$hit_distance_sc <- (siKC_validate$hit_distance_sc - siKC_center_values[1]) / siKC_scale_values[1]

siKC_validate$hit_speed <- (siKC_validate$hit_speed - siKC_center_values[2]) / siKC_scale_values[2]

siKC_validate$hit_angle <- (siKC_validate$hit_angle - siKC_center_values[3]) / siKC_scale_values[3]

siKC_validate$hc_x <- (siKC_validate$hc_x - siKC_center_values[4]) / siKC_scale_values[4]

siKC_validate$hc_y <- (siKC_validate$hc_y - siKC_center_values[5]) / siKC_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(siKC_train)

set.seed(42)
siKC_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(siKC_train, -row), ntree = 501, importance = TRUE)

print(siKC_rf.1)

plot(siKC_rf.1)

varImpPlot(siKC_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
siKC_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(siKC_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(siKC_rf.5)

plot(siKC_rf.5)

varImpPlot(siKC_rf.5)

siKC_predict_fit.rf.5 <- data.frame(fits = predict(siKC_rf.5, siKC_test, type = "prob")[,2], actuals = siKC_test$hit)

siKC_pred.rf.5 <- prediction(siKC_predict_fit.rf.5$fits, siKC_predict_fit.rf.5$actuals)

siKC_roc.pred.rf.5 <- performance(siKC_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(siKC_roc.pred.rf.5)
abline(a = 0, b = 1)
siKC_opt <- opt.cut(siKC_roc.pred.rf.5, siKC_pred.rf.5)
siKC_opt
siKC_opt <- siKC_opt[3]
siKC_predict_fit.rf.5$fits <- with(siKC_predict_fit.rf.5, ifelse(fits > siKC_opt, 1, 0)) 

str(siKC_test)

#siKC_test$fieldingTeam <- as.character(siKC_test$fieldingTeam)
#siKC_test$home_team <- as.character(siKC_test$home_team)
#siKC_test$hit <- as.logical(siKC_test$hit)
#siKC_test$stand <- as.logical(siKC_test$stand)
str(siKC_test)
siKC_rf.5_confusion_test <- confusionMatrix(model = siKC_rf.5, x = siKC_test, y = siKC_test$hit)
siKC_rf.5_confusion_validate <- confusionMatrix(model = siKC_rf.5, x = siKC_validate, y = siKC_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


siKC_test_rows <- siKC_test$row
siKC_validate_rows <- siKC_validate$row
siKC_pred_data_emp_1 <- ungroup(siKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siKC_test_rows)

siKC_pred_data_emp <- ungroup(siKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siKC_validate_rows) %>%
	rbind(siKC_pred_data_emp_1)

siKC_out_of_training_rows <- siKC_pred_data_emp$row

siKC_rf.5_full_out_of_sample_data <- ungroup(siKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siKC_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



siKC_rf.5_full_out_of_sample_data_scaled <- siKC_rf.5_full_out_of_sample_data

siKC_rf.5_full_out_of_sample_data_scaled$hit_speed <- (siKC_rf.5_full_out_of_sample_data_scaled$hit_speed - siKC_center_values[2]) / siKC_scale_values[2]

siKC_rf.5_full_out_of_sample_data_scaled$hit_angle <- (siKC_rf.5_full_out_of_sample_data_scaled$hit_angle - siKC_center_values[3]) / siKC_scale_values[3]

siKC_rf.5.prob <- predict(siKC_rf.5, siKC_rf.5_full_out_of_sample_data_scaled, type = "response")

siKC_rf.5_full_out_of_sample_data <- cbind(filter(siKC_rf.5_full_out_of_sample_data, row %in% siKC_out_of_training_rows), siKC_rf.5.prob)

names(siKC_rf.5_full_out_of_sample_data)[65] <- "fits"
names(siKC_rf.5_full_out_of_sample_data)

siKC_rf.5_full_out_of_sample_data_reduced <- siKC_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

siKC_rf.5_mean_table <- siKC_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

siKC_rf.5_full_out_of_sample_data$type <- with(siKC_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

siKC_rf.5_full_out_of_sample_data$hit_label <- with(siKC_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

siKC_rf.5_plot1 <- ggplot(siKC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siKC_rf.5_plot1

siKC_rf.5_plot2 <- ggplot(siKC_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siKC_rf.5_plot2

siKC_rf.5_plot3 <- ggplot(siKC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siKC_rf.5_plot3

siKC_grid_plot_rf.5 <- grid.arrange(siKC_rf.5_plot1, siKC_rf.5_plot2, siKC_rf.5_plot3, ncol = 3)
siKC_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

siKC_test_rows <- siKC_test$row
siKC_validate_rows <- siKC_validate$row
siKC_pred_data_emp_1 <- ungroup(siKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siKC_test_rows)

siKC_pred_data_emp <- ungroup(siKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siKC_validate_rows) %>%
	rbind(siKC_pred_data_emp_1)

siKC_out_of_training_rows <- siKC_pred_data_emp$row

siKC_pred_data_emp <- ungroup(siKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siKC_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

siKC_pred_data_emp_scaled <- siKC_pred_data_emp

siKC_pred_data_emp_scaled$hit_speed <- (siKC_pred_data_emp_scaled$hit_speed - siKC_center_values[2]) / siKC_scale_values[2]

siKC_pred_data_emp_scaled$hit_angle <- (siKC_pred_data_emp_scaled$hit_angle - siKC_center_values[3]) / siKC_scale_values[3]

siKC_pred_prob_hit <- predict(siKC_rf.5, siKC_pred_data_emp_scaled, type = "prob")[,2]
siKC_pred_prob_hit_fits <- cbind(siKC_pred_data_emp, siKC_pred_prob_hit)

siKC_pred_prob_hit_fits[,c(1:2)] <- siKC_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

siKC_angle_speed_pred <- siKC_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = siKC_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nSI-KC Hit Probability\n") + theme_bp_grey()

siKC_angle_speed_pred
########################## Start Knuckle Curves
#####
knKC$hit_distance_sc <- as.numeric(knKC$hit_distance_sc, na.rm = TRUE)
knKC$hit_angle <- as.numeric(knKC$hit_angle, na.rm = TRUE)
knKC$hit_speed <- as.numeric(knKC$hit_speed, na.rm = TRUE)

knKC$hit <- with(knKC, ifelse(grepl("Single", knKC$events), 1,
															ifelse(grepl("Double", knKC$events), 1,
																		 ifelse(grepl("Triple", knKC$events), 1, 
																		 			 ifelse(grepl("Home Run", knKC$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

knKC$fieldingTeam <- with(knKC, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[knKC$hit_distance_sc == "null"] = NA
#knKC$hit_speed[knKC$hit_speed == "null"] = NA
#knKC$hit_angle[knKC$hit_angle == "null"] = NA

# include row names for unique record identification

knKC$row <- row.names(knKC) %>% as.numeric()

# recode stand and home_team as factors

knKC$stand <- as.factor(knKC$stand)
knKC$home_team <- as.factor(knKC$home_team)


knKC$game_date <- as.Date(knKC$game_date)


# subset 

knKC_working_data <- ungroup(knKC) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(knKC_working_data)
str(ungroup(knKC))
table(knKC_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

knKC_working_data <- filter(knKC_working_data, hc_x != 1, hc_y != 1)
head(knKC_working_data)

# create training and test sets
# scaled data

set.seed(42)
knKC_train <- sample_frac(knKC_working_data, .15, replace = FALSE)
knKC_split <- setdiff(knKC_working_data, knKC_train)
knKC_test <- sample_frac(knKC_split, .50, replace = FALSE)
knKC_validate <- setdiff(knKC_split, knKC_test)

nrow(knKC_train) + nrow(knKC_test) + nrow(knKC_validate) == nrow(knKC_working_data)

with(knKC_train, table(hit)) %>% prop.table()
with(knKC_test, table(hit)) %>% prop.table()
with(knKC_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(knKC)
##as.numeric(knKC$hit_distance_sc, knKC$hit_speed, knKC$hit_angle)

#knKC_train$hit_distance_sc <- as.numeric(knKC_train$hit_distance_sc)
#knKC_train$hit_speed <- as.numeric(knKC_train$hit_speed)
#knKC_train$hit_angle <- as.numeric(knKC_train$hit_angle)
#View(knKC_train)
knKC_scaled_data <- scale(knKC_train[,c(1:5)])
knKC_scale_values <- attr(knKC_scaled_data, 'scaled:scale')
knKC_scale_values
knKC_center_values <- attr(knKC_scaled_data, 'scaled:center')
knKC_center_values
knKC_train <- cbind(knKC_scaled_data, select(knKC_train, hit:row))

# save levels for factor variables
knKC_levels_home_team <- levels(knKC_train$home_team)
knKC_levels_stand <- levels(knKC_train$stand)
knKC_levels_fieldingTeam <- levels(knKC_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(knKC_test)

knKC_test$hit_distance_sc <- (knKC_test$hit_distance_sc - knKC_center_values[1]) / knKC_scale_values[1]

knKC_test$hit_speed <- (knKC_test$hit_speed - knKC_center_values[2]) / knKC_scale_values[2]

knKC_test$hit_angle <- (knKC_test$hit_angle - knKC_center_values[3]) / knKC_scale_values[3]

knKC_test$hc_x <- (knKC_test$hc_x - knKC_center_values[4]) / knKC_scale_values[4]

knKC_test$hc_y <- (knKC_test$hc_y - knKC_center_values[5]) / knKC_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

knKC_validate$hit_distance_sc <- (knKC_validate$hit_distance_sc - knKC_center_values[1]) / knKC_scale_values[1]

knKC_validate$hit_speed <- (knKC_validate$hit_speed - knKC_center_values[2]) / knKC_scale_values[2]

knKC_validate$hit_angle <- (knKC_validate$hit_angle - knKC_center_values[3]) / knKC_scale_values[3]

knKC_validate$hc_x <- (knKC_validate$hc_x - knKC_center_values[4]) / knKC_scale_values[4]

knKC_validate$hc_y <- (knKC_validate$hc_y - knKC_center_values[5]) / knKC_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(knKC_train)

set.seed(42)
knKC_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(knKC_train, -row), ntree = 501, importance = TRUE)

print(knKC_rf.1)

plot(knKC_rf.1)

varImpPlot(knKC_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
knKC_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(knKC_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(knKC_rf.5)

plot(knKC_rf.5)

varImpPlot(knKC_rf.5)

knKC_predict_fit.rf.5 <- data.frame(fits = predict(knKC_rf.5, knKC_test, type = "prob")[,2], actuals = knKC_test$hit)

knKC_pred.rf.5 <- prediction(knKC_predict_fit.rf.5$fits, knKC_predict_fit.rf.5$actuals)

knKC_roc.pred.rf.5 <- performance(knKC_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(knKC_roc.pred.rf.5)
abline(a = 0, b = 1)
knKC_opt <- opt.cut(knKC_roc.pred.rf.5, knKC_pred.rf.5)
knKC_opt
knKC_opt <- knKC_opt[3]
knKC_predict_fit.rf.5$fits <- with(knKC_predict_fit.rf.5, ifelse(fits > knKC_opt, 1, 0)) 

str(knKC_test)

#knKC_test$fieldingTeam <- as.character(knKC_test$fieldingTeam)
#knKC_test$home_team <- as.character(knKC_test$home_team)
#knKC_test$hit <- as.logical(knKC_test$hit)
#knKC_test$stand <- as.logical(knKC_test$stand)
str(knKC_test)
knKC_rf.5_confusion_test <- confusionMatrix(model = knKC_rf.5, x = knKC_test, y = knKC_test$hit)
knKC_rf.5_confusion_validate <- confusionMatrix(model = knKC_rf.5, x = knKC_validate, y = knKC_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


knKC_test_rows <- knKC_test$row
knKC_validate_rows <- knKC_validate$row
knKC_pred_data_emp_1 <- ungroup(knKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knKC_test_rows)

knKC_pred_data_emp <- ungroup(knKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knKC_validate_rows) %>%
	rbind(knKC_pred_data_emp_1)

knKC_out_of_training_rows <- knKC_pred_data_emp$row

knKC_rf.5_full_out_of_sample_data <- ungroup(knKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knKC_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



knKC_rf.5_full_out_of_sample_data_scaled <- knKC_rf.5_full_out_of_sample_data

knKC_rf.5_full_out_of_sample_data_scaled$hit_speed <- (knKC_rf.5_full_out_of_sample_data_scaled$hit_speed - knKC_center_values[2]) / knKC_scale_values[2]

knKC_rf.5_full_out_of_sample_data_scaled$hit_angle <- (knKC_rf.5_full_out_of_sample_data_scaled$hit_angle - knKC_center_values[3]) / knKC_scale_values[3]

knKC_rf.5.prob <- predict(knKC_rf.5, knKC_rf.5_full_out_of_sample_data_scaled, type = "response")

knKC_rf.5_full_out_of_sample_data <- cbind(filter(knKC_rf.5_full_out_of_sample_data, row %in% knKC_out_of_training_rows), knKC_rf.5.prob)

names(knKC_rf.5_full_out_of_sample_data)[65] <- "fits"
names(knKC_rf.5_full_out_of_sample_data)

knKC_rf.5_full_out_of_sample_data_reduced <- knKC_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

knKC_rf.5_mean_table <- knKC_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

knKC_rf.5_full_out_of_sample_data$type <- with(knKC_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

knKC_rf.5_full_out_of_sample_data$hit_label <- with(knKC_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

knKC_rf.5_plot1 <- ggplot(knKC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knKC_rf.5_plot1

knKC_rf.5_plot2 <- ggplot(knKC_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knKC_rf.5_plot2

knKC_rf.5_plot3 <- ggplot(knKC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knKC_rf.5_plot3

knKC_grid_plot_rf.5 <- grid.arrange(knKC_rf.5_plot1, knKC_rf.5_plot2, knKC_rf.5_plot3, ncol = 3)
knKC_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

knKC_test_rows <- knKC_test$row
knKC_validate_rows <- knKC_validate$row
knKC_pred_data_emp_1 <- ungroup(knKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knKC_test_rows)

knKC_pred_data_emp <- ungroup(knKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knKC_validate_rows) %>%
	rbind(knKC_pred_data_emp_1)

knKC_out_of_training_rows <- knKC_pred_data_emp$row

knKC_pred_data_emp <- ungroup(knKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knKC_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

knKC_pred_data_emp_scaled <- knKC_pred_data_emp

knKC_pred_data_emp_scaled$hit_speed <- (knKC_pred_data_emp_scaled$hit_speed - knKC_center_values[2]) / knKC_scale_values[2]

knKC_pred_data_emp_scaled$hit_angle <- (knKC_pred_data_emp_scaled$hit_angle - knKC_center_values[3]) / knKC_scale_values[3]

knKC_pred_prob_hit <- predict(knKC_rf.5, knKC_pred_data_emp_scaled, type = "prob")[,2]
knKC_pred_prob_hit_fits <- cbind(knKC_pred_data_emp, knKC_pred_prob_hit)

knKC_pred_prob_hit_fits[,c(1:2)] <- knKC_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

knKC_angle_speed_pred <- knKC_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = knKC_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nKN-KC Hit Probability\n") + theme_bp_grey()

knKC_angle_speed_pred
#####
fsKC$hit_distance_sc <- as.numeric(fsKC$hit_distance_sc, na.rm = TRUE)
fsKC$hit_angle <- as.numeric(fsKC$hit_angle, na.rm = TRUE)
fsKC$hit_speed <- as.numeric(fsKC$hit_speed, na.rm = TRUE)

fsKC$hit <- with(fsKC, ifelse(grepl("Single", fsKC$events), 1,
															ifelse(grepl("Double", fsKC$events), 1,
																		 ifelse(grepl("Triple", fsKC$events), 1, 
																		 			 ifelse(grepl("Home Run", fsKC$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

fsKC$fieldingTeam <- with(fsKC, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[fsKC$hit_distance_sc == "null"] = NA
#fsKC$hit_speed[fsKC$hit_speed == "null"] = NA
#fsKC$hit_angle[fsKC$hit_angle == "null"] = NA

# include row names for unique record identification

fsKC$row <- row.names(fsKC) %>% as.numeric()

# recode stand and home_team as factors

fsKC$stand <- as.factor(fsKC$stand)
fsKC$home_team <- as.factor(fsKC$home_team)


fsKC$game_date <- as.Date(fsKC$game_date)


# subset 

fsKC_working_data <- ungroup(fsKC) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(fsKC_working_data)
str(ungroup(fsKC))
table(fsKC_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

fsKC_working_data <- filter(fsKC_working_data, hc_x != 1, hc_y != 1)
head(fsKC_working_data)

# create training and test sets
# scaled data

set.seed(42)
fsKC_train <- sample_frac(fsKC_working_data, .15, replace = FALSE)
fsKC_split <- setdiff(fsKC_working_data, fsKC_train)
fsKC_test <- sample_frac(fsKC_split, .50, replace = FALSE)
fsKC_validate <- setdiff(fsKC_split, fsKC_test)

nrow(fsKC_train) + nrow(fsKC_test) + nrow(fsKC_validate) == nrow(fsKC_working_data)

with(fsKC_train, table(hit)) %>% prop.table()
with(fsKC_test, table(hit)) %>% prop.table()
with(fsKC_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(fsKC)
##as.numeric(fsKC$hit_distance_sc, fsKC$hit_speed, fsKC$hit_angle)

#fsKC_train$hit_distance_sc <- as.numeric(fsKC_train$hit_distance_sc)
#fsKC_train$hit_speed <- as.numeric(fsKC_train$hit_speed)
#fsKC_train$hit_angle <- as.numeric(fsKC_train$hit_angle)
#View(fsKC_train)
fsKC_scaled_data <- scale(fsKC_train[,c(1:5)])
fsKC_scale_values <- attr(fsKC_scaled_data, 'scaled:scale')
fsKC_scale_values
fsKC_center_values <- attr(fsKC_scaled_data, 'scaled:center')
fsKC_center_values
fsKC_train <- cbind(fsKC_scaled_data, select(fsKC_train, hit:row))

# save levels for factor variables
fsKC_levels_home_team <- levels(fsKC_train$home_team)
fsKC_levels_stand <- levels(fsKC_train$stand)
fsKC_levels_fieldingTeam <- levels(fsKC_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(fsKC_test)

fsKC_test$hit_distance_sc <- (fsKC_test$hit_distance_sc - fsKC_center_values[1]) / fsKC_scale_values[1]

fsKC_test$hit_speed <- (fsKC_test$hit_speed - fsKC_center_values[2]) / fsKC_scale_values[2]

fsKC_test$hit_angle <- (fsKC_test$hit_angle - fsKC_center_values[3]) / fsKC_scale_values[3]

fsKC_test$hc_x <- (fsKC_test$hc_x - fsKC_center_values[4]) / fsKC_scale_values[4]

fsKC_test$hc_y <- (fsKC_test$hc_y - fsKC_center_values[5]) / fsKC_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

fsKC_validate$hit_distance_sc <- (fsKC_validate$hit_distance_sc - fsKC_center_values[1]) / fsKC_scale_values[1]

fsKC_validate$hit_speed <- (fsKC_validate$hit_speed - fsKC_center_values[2]) / fsKC_scale_values[2]

fsKC_validate$hit_angle <- (fsKC_validate$hit_angle - fsKC_center_values[3]) / fsKC_scale_values[3]

fsKC_validate$hc_x <- (fsKC_validate$hc_x - fsKC_center_values[4]) / fsKC_scale_values[4]

fsKC_validate$hc_y <- (fsKC_validate$hc_y - fsKC_center_values[5]) / fsKC_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(fsKC_train)

set.seed(42)
fsKC_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(fsKC_train, -row), ntree = 501, importance = TRUE)

print(fsKC_rf.1)

plot(fsKC_rf.1)

varImpPlot(fsKC_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
fsKC_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(fsKC_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(fsKC_rf.5)

plot(fsKC_rf.5)

varImpPlot(fsKC_rf.5)

fsKC_predict_fit.rf.5 <- data.frame(fits = predict(fsKC_rf.5, fsKC_test, type = "prob")[,2], actuals = fsKC_test$hit)

fsKC_pred.rf.5 <- prediction(fsKC_predict_fit.rf.5$fits, fsKC_predict_fit.rf.5$actuals)

fsKC_roc.pred.rf.5 <- performance(fsKC_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(fsKC_roc.pred.rf.5)
abline(a = 0, b = 1)
fsKC_opt <- opt.cut(fsKC_roc.pred.rf.5, fsKC_pred.rf.5)
fsKC_opt
fsKC_opt <- fsKC_opt[3]
fsKC_predict_fit.rf.5$fits <- with(fsKC_predict_fit.rf.5, ifelse(fits > fsKC_opt, 1, 0)) 

str(fsKC_test)

#fsKC_test$fieldingTeam <- as.character(fsKC_test$fieldingTeam)
#fsKC_test$home_team <- as.character(fsKC_test$home_team)
#fsKC_test$hit <- as.logical(fsKC_test$hit)
#fsKC_test$stand <- as.logical(fsKC_test$stand)
str(fsKC_test)
fsKC_rf.5_confusion_test <- confusionMatrix(model = fsKC_rf.5, x = fsKC_test, y = fsKC_test$hit)
fsKC_rf.5_confusion_validate <- confusionMatrix(model = fsKC_rf.5, x = fsKC_validate, y = fsKC_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


fsKC_test_rows <- fsKC_test$row
fsKC_validate_rows <- fsKC_validate$row
fsKC_pred_data_emp_1 <- ungroup(fsKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsKC_test_rows)

fsKC_pred_data_emp <- ungroup(fsKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsKC_validate_rows) %>%
	rbind(fsKC_pred_data_emp_1)

fsKC_out_of_training_rows <- fsKC_pred_data_emp$row

fsKC_rf.5_full_out_of_sample_data <- ungroup(fsKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsKC_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



fsKC_rf.5_full_out_of_sample_data_scaled <- fsKC_rf.5_full_out_of_sample_data

fsKC_rf.5_full_out_of_sample_data_scaled$hit_speed <- (fsKC_rf.5_full_out_of_sample_data_scaled$hit_speed - fsKC_center_values[2]) / fsKC_scale_values[2]

fsKC_rf.5_full_out_of_sample_data_scaled$hit_angle <- (fsKC_rf.5_full_out_of_sample_data_scaled$hit_angle - fsKC_center_values[3]) / fsKC_scale_values[3]

fsKC_rf.5.prob <- predict(fsKC_rf.5, fsKC_rf.5_full_out_of_sample_data_scaled, type = "response")

fsKC_rf.5_full_out_of_sample_data <- cbind(filter(fsKC_rf.5_full_out_of_sample_data, row %in% fsKC_out_of_training_rows), fsKC_rf.5.prob)

names(fsKC_rf.5_full_out_of_sample_data)[65] <- "fits"
names(fsKC_rf.5_full_out_of_sample_data)

fsKC_rf.5_full_out_of_sample_data_reduced <- fsKC_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

fsKC_rf.5_mean_table <- fsKC_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

fsKC_rf.5_full_out_of_sample_data$type <- with(fsKC_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

fsKC_rf.5_full_out_of_sample_data$hit_label <- with(fsKC_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

fsKC_rf.5_plot1 <- ggplot(fsKC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsKC_rf.5_plot1

fsKC_rf.5_plot2 <- ggplot(fsKC_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsKC_rf.5_plot2

fsKC_rf.5_plot3 <- ggplot(fsKC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsKC_rf.5_plot3

fsKC_grid_plot_rf.5 <- grid.arrange(fsKC_rf.5_plot1, fsKC_rf.5_plot2, fsKC_rf.5_plot3, ncol = 3)
fsKC_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

fsKC_test_rows <- fsKC_test$row
fsKC_validate_rows <- fsKC_validate$row
fsKC_pred_data_emp_1 <- ungroup(fsKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsKC_test_rows)

fsKC_pred_data_emp <- ungroup(fsKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsKC_validate_rows) %>%
	rbind(fsKC_pred_data_emp_1)

fsKC_out_of_training_rows <- fsKC_pred_data_emp$row

fsKC_pred_data_emp <- ungroup(fsKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsKC_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

fsKC_pred_data_emp_scaled <- fsKC_pred_data_emp

fsKC_pred_data_emp_scaled$hit_speed <- (fsKC_pred_data_emp_scaled$hit_speed - fsKC_center_values[2]) / fsKC_scale_values[2]

fsKC_pred_data_emp_scaled$hit_angle <- (fsKC_pred_data_emp_scaled$hit_angle - fsKC_center_values[3]) / fsKC_scale_values[3]

fsKC_pred_prob_hit <- predict(fsKC_rf.5, fsKC_pred_data_emp_scaled, type = "prob")[,2]
fsKC_pred_prob_hit_fits <- cbind(fsKC_pred_data_emp, fsKC_pred_prob_hit)

fsKC_pred_prob_hit_fits[,c(1:2)] <- fsKC_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

fsKC_angle_speed_pred <- fsKC_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = fsKC_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFS-KC Hit Probability\n") + theme_bp_grey()

fsKC_angle_speed_pred
#####
chKC$hit_distance_sc <- as.numeric(chKC$hit_distance_sc, na.rm = TRUE)
chKC$hit_angle <- as.numeric(chKC$hit_angle, na.rm = TRUE)
chKC$hit_speed <- as.numeric(chKC$hit_speed, na.rm = TRUE)

chKC$hit <- with(chKC, ifelse(grepl("Single", chKC$events), 1,
															ifelse(grepl("Double", chKC$events), 1,
																		 ifelse(grepl("Triple", chKC$events), 1, 
																		 			 ifelse(grepl("Home Run", chKC$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

chKC$fieldingTeam <- with(chKC, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[chKC$hit_distance_sc == "null"] = NA
#chKC$hit_speed[chKC$hit_speed == "null"] = NA
#chKC$hit_angle[chKC$hit_angle == "null"] = NA

# include row names for unique record identification

chKC$row <- row.names(chKC) %>% as.numeric()

# recode stand and home_team as factors

chKC$stand <- as.factor(chKC$stand)
chKC$home_team <- as.factor(chKC$home_team)


chKC$game_date <- as.Date(chKC$game_date)


# subset 

chKC_working_data <- ungroup(chKC) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(chKC_working_data)
str(ungroup(chKC))
table(chKC_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

chKC_working_data <- filter(chKC_working_data, hc_x != 1, hc_y != 1)
head(chKC_working_data)

# create training and test sets
# scaled data

set.seed(42)
chKC_train <- sample_frac(chKC_working_data, .15, replace = FALSE)
chKC_split <- setdiff(chKC_working_data, chKC_train)
chKC_test <- sample_frac(chKC_split, .50, replace = FALSE)
chKC_validate <- setdiff(chKC_split, chKC_test)

nrow(chKC_train) + nrow(chKC_test) + nrow(chKC_validate) == nrow(chKC_working_data)

with(chKC_train, table(hit)) %>% prop.table()
with(chKC_test, table(hit)) %>% prop.table()
with(chKC_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(chKC)
##as.numeric(chKC$hit_distance_sc, chKC$hit_speed, chKC$hit_angle)

#chKC_train$hit_distance_sc <- as.numeric(chKC_train$hit_distance_sc)
#chKC_train$hit_speed <- as.numeric(chKC_train$hit_speed)
#chKC_train$hit_angle <- as.numeric(chKC_train$hit_angle)
#View(chKC_train)
chKC_scaled_data <- scale(chKC_train[,c(1:5)])
chKC_scale_values <- attr(chKC_scaled_data, 'scaled:scale')
chKC_scale_values
chKC_center_values <- attr(chKC_scaled_data, 'scaled:center')
chKC_center_values
chKC_train <- cbind(chKC_scaled_data, select(chKC_train, hit:row))

# save levels for factor variables
chKC_levels_home_team <- levels(chKC_train$home_team)
chKC_levels_stand <- levels(chKC_train$stand)
chKC_levels_fieldingTeam <- levels(chKC_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(chKC_test)

chKC_test$hit_distance_sc <- (chKC_test$hit_distance_sc - chKC_center_values[1]) / chKC_scale_values[1]

chKC_test$hit_speed <- (chKC_test$hit_speed - chKC_center_values[2]) / chKC_scale_values[2]

chKC_test$hit_angle <- (chKC_test$hit_angle - chKC_center_values[3]) / chKC_scale_values[3]

chKC_test$hc_x <- (chKC_test$hc_x - chKC_center_values[4]) / chKC_scale_values[4]

chKC_test$hc_y <- (chKC_test$hc_y - chKC_center_values[5]) / chKC_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

chKC_validate$hit_distance_sc <- (chKC_validate$hit_distance_sc - chKC_center_values[1]) / chKC_scale_values[1]

chKC_validate$hit_speed <- (chKC_validate$hit_speed - chKC_center_values[2]) / chKC_scale_values[2]

chKC_validate$hit_angle <- (chKC_validate$hit_angle - chKC_center_values[3]) / chKC_scale_values[3]

chKC_validate$hc_x <- (chKC_validate$hc_x - chKC_center_values[4]) / chKC_scale_values[4]

chKC_validate$hc_y <- (chKC_validate$hc_y - chKC_center_values[5]) / chKC_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(chKC_train)

set.seed(42)
chKC_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(chKC_train, -row), ntree = 501, importance = TRUE)

print(chKC_rf.1)

plot(chKC_rf.1)

varImpPlot(chKC_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
chKC_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(chKC_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(chKC_rf.5)

plot(chKC_rf.5)

varImpPlot(chKC_rf.5)

chKC_predict_fit.rf.5 <- data.frame(fits = predict(chKC_rf.5, chKC_test, type = "prob")[,2], actuals = chKC_test$hit)

chKC_pred.rf.5 <- prediction(chKC_predict_fit.rf.5$fits, chKC_predict_fit.rf.5$actuals)

chKC_roc.pred.rf.5 <- performance(chKC_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(chKC_roc.pred.rf.5)
abline(a = 0, b = 1)
chKC_opt <- opt.cut(chKC_roc.pred.rf.5, chKC_pred.rf.5)
chKC_opt
chKC_opt <- chKC_opt[3]
chKC_predict_fit.rf.5$fits <- with(chKC_predict_fit.rf.5, ifelse(fits > chKC_opt, 1, 0)) 

str(chKC_test)

#chKC_test$fieldingTeam <- as.character(chKC_test$fieldingTeam)
#chKC_test$home_team <- as.character(chKC_test$home_team)
#chKC_test$hit <- as.logical(chKC_test$hit)
#chKC_test$stand <- as.logical(chKC_test$stand)
str(chKC_test)
chKC_rf.5_confusion_test <- confusionMatrix(model = chKC_rf.5, x = chKC_test, y = chKC_test$hit)
chKC_rf.5_confusion_validate <- confusionMatrix(model = chKC_rf.5, x = chKC_validate, y = chKC_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


chKC_test_rows <- chKC_test$row
chKC_validate_rows <- chKC_validate$row
chKC_pred_data_emp_1 <- ungroup(chKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chKC_test_rows)

chKC_pred_data_emp <- ungroup(chKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chKC_validate_rows) %>%
	rbind(chKC_pred_data_emp_1)

chKC_out_of_training_rows <- chKC_pred_data_emp$row

chKC_rf.5_full_out_of_sample_data <- ungroup(chKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chKC_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



chKC_rf.5_full_out_of_sample_data_scaled <- chKC_rf.5_full_out_of_sample_data

chKC_rf.5_full_out_of_sample_data_scaled$hit_speed <- (chKC_rf.5_full_out_of_sample_data_scaled$hit_speed - chKC_center_values[2]) / chKC_scale_values[2]

chKC_rf.5_full_out_of_sample_data_scaled$hit_angle <- (chKC_rf.5_full_out_of_sample_data_scaled$hit_angle - chKC_center_values[3]) / chKC_scale_values[3]

chKC_rf.5.prob <- predict(chKC_rf.5, chKC_rf.5_full_out_of_sample_data_scaled, type = "response")

chKC_rf.5_full_out_of_sample_data <- cbind(filter(chKC_rf.5_full_out_of_sample_data, row %in% chKC_out_of_training_rows), chKC_rf.5.prob)

names(chKC_rf.5_full_out_of_sample_data)[65] <- "fits"
names(chKC_rf.5_full_out_of_sample_data)

chKC_rf.5_full_out_of_sample_data_reduced <- chKC_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

chKC_rf.5_mean_table <- chKC_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

chKC_rf.5_full_out_of_sample_data$type <- with(chKC_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

chKC_rf.5_full_out_of_sample_data$hit_label <- with(chKC_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

chKC_rf.5_plot1 <- ggplot(chKC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chKC_rf.5_plot1

chKC_rf.5_plot2 <- ggplot(chKC_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chKC_rf.5_plot2

chKC_rf.5_plot3 <- ggplot(chKC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chKC_rf.5_plot3

chKC_grid_plot_rf.5 <- grid.arrange(chKC_rf.5_plot1, chKC_rf.5_plot2, chKC_rf.5_plot3, ncol = 3)
chKC_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

chKC_test_rows <- chKC_test$row
chKC_validate_rows <- chKC_validate$row
chKC_pred_data_emp_1 <- ungroup(chKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chKC_test_rows)

chKC_pred_data_emp <- ungroup(chKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chKC_validate_rows) %>%
	rbind(chKC_pred_data_emp_1)

chKC_out_of_training_rows <- chKC_pred_data_emp$row

chKC_pred_data_emp <- ungroup(chKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chKC_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

chKC_pred_data_emp_scaled <- chKC_pred_data_emp

chKC_pred_data_emp_scaled$hit_speed <- (chKC_pred_data_emp_scaled$hit_speed - chKC_center_values[2]) / chKC_scale_values[2]

chKC_pred_data_emp_scaled$hit_angle <- (chKC_pred_data_emp_scaled$hit_angle - chKC_center_values[3]) / chKC_scale_values[3]

chKC_pred_prob_hit <- predict(chKC_rf.5, chKC_pred_data_emp_scaled, type = "prob")[,2]
chKC_pred_prob_hit_fits <- cbind(chKC_pred_data_emp, chKC_pred_prob_hit)

chKC_pred_prob_hit_fits[,c(1:2)] <- chKC_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

chKC_angle_speed_pred <- chKC_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = chKC_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nCH-KC Hit Probability\n") + theme_bp_grey()

chKC_angle_speed_pred
#####
ftKC$hit_distance_sc <- as.numeric(ftKC$hit_distance_sc, na.rm = TRUE)
ftKC$hit_angle <- as.numeric(ftKC$hit_angle, na.rm = TRUE)
ftKC$hit_speed <- as.numeric(ftKC$hit_speed, na.rm = TRUE)

ftKC$hit <- with(ftKC, ifelse(grepl("Single", ftKC$events), 1,
															ifelse(grepl("Double", ftKC$events), 1,
																		 ifelse(grepl("Triple", ftKC$events), 1, 
																		 			 ifelse(grepl("Home Run", ftKC$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

ftKC$fieldingTeam <- with(ftKC, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[ftKC$hit_distance_sc == "null"] = NA
#ftKC$hit_speed[ftKC$hit_speed == "null"] = NA
#ftKC$hit_angle[ftKC$hit_angle == "null"] = NA

# include row names for unique record identification

ftKC$row <- row.names(ftKC) %>% as.numeric()

# recode stand and home_team as factors

ftKC$stand <- as.factor(ftKC$stand)
ftKC$home_team <- as.factor(ftKC$home_team)


ftKC$game_date <- as.Date(ftKC$game_date)


# subset 

ftKC_working_data <- ungroup(ftKC) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(ftKC_working_data)
str(ungroup(ftKC))
table(ftKC_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

ftKC_working_data <- filter(ftKC_working_data, hc_x != 1, hc_y != 1)
head(ftKC_working_data)

# create training and test sets
# scaled data

set.seed(42)
ftKC_train <- sample_frac(ftKC_working_data, .15, replace = FALSE)
ftKC_split <- setdiff(ftKC_working_data, ftKC_train)
ftKC_test <- sample_frac(ftKC_split, .50, replace = FALSE)
ftKC_validate <- setdiff(ftKC_split, ftKC_test)

nrow(ftKC_train) + nrow(ftKC_test) + nrow(ftKC_validate) == nrow(ftKC_working_data)

with(ftKC_train, table(hit)) %>% prop.table()
with(ftKC_test, table(hit)) %>% prop.table()
with(ftKC_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(ftKC)
##as.numeric(ftKC$hit_distance_sc, ftKC$hit_speed, ftKC$hit_angle)

#ftKC_train$hit_distance_sc <- as.numeric(ftKC_train$hit_distance_sc)
#ftKC_train$hit_speed <- as.numeric(ftKC_train$hit_speed)
#ftKC_train$hit_angle <- as.numeric(ftKC_train$hit_angle)
#View(ftKC_train)
ftKC_scaled_data <- scale(ftKC_train[,c(1:5)])
ftKC_scale_values <- attr(ftKC_scaled_data, 'scaled:scale')
ftKC_scale_values
ftKC_center_values <- attr(ftKC_scaled_data, 'scaled:center')
ftKC_center_values
ftKC_train <- cbind(ftKC_scaled_data, select(ftKC_train, hit:row))

# save levels for factor variables
ftKC_levels_home_team <- levels(ftKC_train$home_team)
ftKC_levels_stand <- levels(ftKC_train$stand)
ftKC_levels_fieldingTeam <- levels(ftKC_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(ftKC_test)

ftKC_test$hit_distance_sc <- (ftKC_test$hit_distance_sc - ftKC_center_values[1]) / ftKC_scale_values[1]

ftKC_test$hit_speed <- (ftKC_test$hit_speed - ftKC_center_values[2]) / ftKC_scale_values[2]

ftKC_test$hit_angle <- (ftKC_test$hit_angle - ftKC_center_values[3]) / ftKC_scale_values[3]

ftKC_test$hc_x <- (ftKC_test$hc_x - ftKC_center_values[4]) / ftKC_scale_values[4]

ftKC_test$hc_y <- (ftKC_test$hc_y - ftKC_center_values[5]) / ftKC_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

ftKC_validate$hit_distance_sc <- (ftKC_validate$hit_distance_sc - ftKC_center_values[1]) / ftKC_scale_values[1]

ftKC_validate$hit_speed <- (ftKC_validate$hit_speed - ftKC_center_values[2]) / ftKC_scale_values[2]

ftKC_validate$hit_angle <- (ftKC_validate$hit_angle - ftKC_center_values[3]) / ftKC_scale_values[3]

ftKC_validate$hc_x <- (ftKC_validate$hc_x - ftKC_center_values[4]) / ftKC_scale_values[4]

ftKC_validate$hc_y <- (ftKC_validate$hc_y - ftKC_center_values[5]) / ftKC_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(ftKC_train)

set.seed(42)
ftKC_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(ftKC_train, -row), ntree = 501, importance = TRUE)

print(ftKC_rf.1)

plot(ftKC_rf.1)

varImpPlot(ftKC_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
ftKC_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(ftKC_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(ftKC_rf.5)

plot(ftKC_rf.5)

varImpPlot(ftKC_rf.5)

ftKC_predict_fit.rf.5 <- data.frame(fits = predict(ftKC_rf.5, ftKC_test, type = "prob")[,2], actuals = ftKC_test$hit)

ftKC_pred.rf.5 <- prediction(ftKC_predict_fit.rf.5$fits, ftKC_predict_fit.rf.5$actuals)

ftKC_roc.pred.rf.5 <- performance(ftKC_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(ftKC_roc.pred.rf.5)
abline(a = 0, b = 1)
ftKC_opt <- opt.cut(ftKC_roc.pred.rf.5, ftKC_pred.rf.5)
ftKC_opt
ftKC_opt <- ftKC_opt[3]
ftKC_predict_fit.rf.5$fits <- with(ftKC_predict_fit.rf.5, ifelse(fits > ftKC_opt, 1, 0)) 

str(ftKC_test)

#ftKC_test$fieldingTeam <- as.character(ftKC_test$fieldingTeam)
#ftKC_test$home_team <- as.character(ftKC_test$home_team)
#ftKC_test$hit <- as.logical(ftKC_test$hit)
#ftKC_test$stand <- as.logical(ftKC_test$stand)
str(ftKC_test)
ftKC_rf.5_confusion_test <- confusionMatrix(model = ftKC_rf.5, x = ftKC_test, y = ftKC_test$hit)
ftKC_rf.5_confusion_validate <- confusionMatrix(model = ftKC_rf.5, x = ftKC_validate, y = ftKC_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


ftKC_test_rows <- ftKC_test$row
ftKC_validate_rows <- ftKC_validate$row
ftKC_pred_data_emp_1 <- ungroup(ftKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftKC_test_rows)

ftKC_pred_data_emp <- ungroup(ftKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftKC_validate_rows) %>%
	rbind(ftKC_pred_data_emp_1)

ftKC_out_of_training_rows <- ftKC_pred_data_emp$row

ftKC_rf.5_full_out_of_sample_data <- ungroup(ftKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftKC_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



ftKC_rf.5_full_out_of_sample_data_scaled <- ftKC_rf.5_full_out_of_sample_data

ftKC_rf.5_full_out_of_sample_data_scaled$hit_speed <- (ftKC_rf.5_full_out_of_sample_data_scaled$hit_speed - ftKC_center_values[2]) / ftKC_scale_values[2]

ftKC_rf.5_full_out_of_sample_data_scaled$hit_angle <- (ftKC_rf.5_full_out_of_sample_data_scaled$hit_angle - ftKC_center_values[3]) / ftKC_scale_values[3]

ftKC_rf.5.prob <- predict(ftKC_rf.5, ftKC_rf.5_full_out_of_sample_data_scaled, type = "response")

ftKC_rf.5_full_out_of_sample_data <- cbind(filter(ftKC_rf.5_full_out_of_sample_data, row %in% ftKC_out_of_training_rows), ftKC_rf.5.prob)

names(ftKC_rf.5_full_out_of_sample_data)[65] <- "fits"
names(ftKC_rf.5_full_out_of_sample_data)

ftKC_rf.5_full_out_of_sample_data_reduced <- ftKC_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

ftKC_rf.5_mean_table <- ftKC_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

ftKC_rf.5_full_out_of_sample_data$type <- with(ftKC_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

ftKC_rf.5_full_out_of_sample_data$hit_label <- with(ftKC_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

ftKC_rf.5_plot1 <- ggplot(ftKC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftKC_rf.5_plot1

ftKC_rf.5_plot2 <- ggplot(ftKC_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftKC_rf.5_plot2

ftKC_rf.5_plot3 <- ggplot(ftKC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftKC_rf.5_plot3

ftKC_grid_plot_rf.5 <- grid.arrange(ftKC_rf.5_plot1, ftKC_rf.5_plot2, ftKC_rf.5_plot3, ncol = 3)
ftKC_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

ftKC_test_rows <- ftKC_test$row
ftKC_validate_rows <- ftKC_validate$row
ftKC_pred_data_emp_1 <- ungroup(ftKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftKC_test_rows)

ftKC_pred_data_emp <- ungroup(ftKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftKC_validate_rows) %>%
	rbind(ftKC_pred_data_emp_1)

ftKC_out_of_training_rows <- ftKC_pred_data_emp$row

ftKC_pred_data_emp <- ungroup(ftKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftKC_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

ftKC_pred_data_emp_scaled <- ftKC_pred_data_emp

ftKC_pred_data_emp_scaled$hit_speed <- (ftKC_pred_data_emp_scaled$hit_speed - ftKC_center_values[2]) / ftKC_scale_values[2]

ftKC_pred_data_emp_scaled$hit_angle <- (ftKC_pred_data_emp_scaled$hit_angle - ftKC_center_values[3]) / ftKC_scale_values[3]

ftKC_pred_prob_hit <- predict(ftKC_rf.5, ftKC_pred_data_emp_scaled, type = "prob")[,2]
ftKC_pred_prob_hit_fits <- cbind(ftKC_pred_data_emp, ftKC_pred_prob_hit)

ftKC_pred_prob_hit_fits[,c(1:2)] <- ftKC_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

ftKC_angle_speed_pred <- ftKC_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = ftKC_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFT-FC Hit Probability\n") + theme_bp_grey()

ftKC_angle_speed_pred
#####
slKC$hit_distance_sc <- as.numeric(slKC$hit_distance_sc, na.rm = TRUE)
slKC$hit_angle <- as.numeric(slKC$hit_angle, na.rm = TRUE)
slKC$hit_speed <- as.numeric(slKC$hit_speed, na.rm = TRUE)

slKC$hit <- with(slKC, ifelse(grepl("Single", slKC$events), 1,
															ifelse(grepl("Double", slKC$events), 1,
																		 ifelse(grepl("Triple", slKC$events), 1, 
																		 			 ifelse(grepl("Home Run", slKC$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

slKC$fieldingTeam <- with(slKC, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[slKC$hit_distance_sc == "null"] = NA
#slKC$hit_speed[slKC$hit_speed == "null"] = NA
#slKC$hit_angle[slKC$hit_angle == "null"] = NA

# include row names for unique record identification

slKC$row <- row.names(slKC) %>% as.numeric()

# recode stand and home_team as factors

slKC$stand <- as.factor(slKC$stand)
slKC$home_team <- as.factor(slKC$home_team)


slKC$game_date <- as.Date(slKC$game_date)


# subset 

slKC_working_data <- ungroup(slKC) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(slKC_working_data)
str(ungroup(slKC))
table(slKC_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

slKC_working_data <- filter(slKC_working_data, hc_x != 1, hc_y != 1)
head(slKC_working_data)

# create training and test sets
# scaled data

set.seed(42)
slKC_train <- sample_frac(slKC_working_data, .15, replace = FALSE)
slKC_split <- setdiff(slKC_working_data, slKC_train)
slKC_test <- sample_frac(slKC_split, .50, replace = FALSE)
slKC_validate <- setdiff(slKC_split, slKC_test)

nrow(slKC_train) + nrow(slKC_test) + nrow(slKC_validate) == nrow(slKC_working_data)

with(slKC_train, table(hit)) %>% prop.table()
with(slKC_test, table(hit)) %>% prop.table()
with(slKC_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(slKC)
##as.numeric(slKC$hit_distance_sc, slKC$hit_speed, slKC$hit_angle)

#slKC_train$hit_distance_sc <- as.numeric(slKC_train$hit_distance_sc)
#slKC_train$hit_speed <- as.numeric(slKC_train$hit_speed)
#slKC_train$hit_angle <- as.numeric(slKC_train$hit_angle)
#View(slKC_train)
slKC_scaled_data <- scale(slKC_train[,c(1:5)])
slKC_scale_values <- attr(slKC_scaled_data, 'scaled:scale')
slKC_scale_values
slKC_center_values <- attr(slKC_scaled_data, 'scaled:center')
slKC_center_values
slKC_train <- cbind(slKC_scaled_data, select(slKC_train, hit:row))

# save levels for factor variables
slKC_levels_home_team <- levels(slKC_train$home_team)
slKC_levels_stand <- levels(slKC_train$stand)
slKC_levels_fieldingTeam <- levels(slKC_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(slKC_test)

slKC_test$hit_distance_sc <- (slKC_test$hit_distance_sc - slKC_center_values[1]) / slKC_scale_values[1]

slKC_test$hit_speed <- (slKC_test$hit_speed - slKC_center_values[2]) / slKC_scale_values[2]

slKC_test$hit_angle <- (slKC_test$hit_angle - slKC_center_values[3]) / slKC_scale_values[3]

slKC_test$hc_x <- (slKC_test$hc_x - slKC_center_values[4]) / slKC_scale_values[4]

slKC_test$hc_y <- (slKC_test$hc_y - slKC_center_values[5]) / slKC_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

slKC_validate$hit_distance_sc <- (slKC_validate$hit_distance_sc - slKC_center_values[1]) / slKC_scale_values[1]

slKC_validate$hit_speed <- (slKC_validate$hit_speed - slKC_center_values[2]) / slKC_scale_values[2]

slKC_validate$hit_angle <- (slKC_validate$hit_angle - slKC_center_values[3]) / slKC_scale_values[3]

slKC_validate$hc_x <- (slKC_validate$hc_x - slKC_center_values[4]) / slKC_scale_values[4]

slKC_validate$hc_y <- (slKC_validate$hc_y - slKC_center_values[5]) / slKC_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(slKC_train)

set.seed(42)
slKC_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(slKC_train, -row), ntree = 501, importance = TRUE)

print(slKC_rf.1)

plot(slKC_rf.1)

varImpPlot(slKC_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
slKC_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(slKC_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(slKC_rf.5)

plot(slKC_rf.5)

varImpPlot(slKC_rf.5)

slKC_predict_fit.rf.5 <- data.frame(fits = predict(slKC_rf.5, slKC_test, type = "prob")[,2], actuals = slKC_test$hit)

slKC_pred.rf.5 <- prediction(slKC_predict_fit.rf.5$fits, slKC_predict_fit.rf.5$actuals)

slKC_roc.pred.rf.5 <- performance(slKC_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(slKC_roc.pred.rf.5)
abline(a = 0, b = 1)
slKC_opt <- opt.cut(slKC_roc.pred.rf.5, slKC_pred.rf.5)
slKC_opt
slKC_opt <- slKC_opt[3]
slKC_predict_fit.rf.5$fits <- with(slKC_predict_fit.rf.5, ifelse(fits > slKC_opt, 1, 0)) 

str(slKC_test)

#slKC_test$fieldingTeam <- as.character(slKC_test$fieldingTeam)
#slKC_test$home_team <- as.character(slKC_test$home_team)
#slKC_test$hit <- as.logical(slKC_test$hit)
#slKC_test$stand <- as.logical(slKC_test$stand)
str(slKC_test)
slKC_rf.5_confusion_test <- confusionMatrix(model = slKC_rf.5, x = slKC_test, y = slKC_test$hit)
slKC_rf.5_confusion_validate <- confusionMatrix(model = slKC_rf.5, x = slKC_validate, y = slKC_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


slKC_test_rows <- slKC_test$row
slKC_validate_rows <- slKC_validate$row
slKC_pred_data_emp_1 <- ungroup(slKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slKC_test_rows)

slKC_pred_data_emp <- ungroup(slKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slKC_validate_rows) %>%
	rbind(slKC_pred_data_emp_1)

slKC_out_of_training_rows <- slKC_pred_data_emp$row

slKC_rf.5_full_out_of_sample_data <- ungroup(slKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slKC_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



slKC_rf.5_full_out_of_sample_data_scaled <- slKC_rf.5_full_out_of_sample_data

slKC_rf.5_full_out_of_sample_data_scaled$hit_speed <- (slKC_rf.5_full_out_of_sample_data_scaled$hit_speed - slKC_center_values[2]) / slKC_scale_values[2]

slKC_rf.5_full_out_of_sample_data_scaled$hit_angle <- (slKC_rf.5_full_out_of_sample_data_scaled$hit_angle - slKC_center_values[3]) / slKC_scale_values[3]

slKC_rf.5.prob <- predict(slKC_rf.5, slKC_rf.5_full_out_of_sample_data_scaled, type = "response")

slKC_rf.5_full_out_of_sample_data <- cbind(filter(slKC_rf.5_full_out_of_sample_data, row %in% slKC_out_of_training_rows), slKC_rf.5.prob)

names(slKC_rf.5_full_out_of_sample_data)[65] <- "fits"
names(slKC_rf.5_full_out_of_sample_data)

slKC_rf.5_full_out_of_sample_data_reduced <- slKC_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

slKC_rf.5_mean_table <- slKC_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

slKC_rf.5_full_out_of_sample_data$type <- with(slKC_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

slKC_rf.5_full_out_of_sample_data$hit_label <- with(slKC_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

slKC_rf.5_plot1 <- ggplot(slKC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slKC_rf.5_plot1

slKC_rf.5_plot2 <- ggplot(slKC_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slKC_rf.5_plot2

slKC_rf.5_plot3 <- ggplot(slKC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slKC_rf.5_plot3

slKC_grid_plot_rf.5 <- grid.arrange(slKC_rf.5_plot1, slKC_rf.5_plot2, slKC_rf.5_plot3, ncol = 3)
slKC_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

slKC_test_rows <- slKC_test$row
slKC_validate_rows <- slKC_validate$row
slKC_pred_data_emp_1 <- ungroup(slKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slKC_test_rows)

slKC_pred_data_emp <- ungroup(slKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slKC_validate_rows) %>%
	rbind(slKC_pred_data_emp_1)

slKC_out_of_training_rows <- slKC_pred_data_emp$row

slKC_pred_data_emp <- ungroup(slKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slKC_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

slKC_pred_data_emp_scaled <- slKC_pred_data_emp

slKC_pred_data_emp_scaled$hit_speed <- (slKC_pred_data_emp_scaled$hit_speed - slKC_center_values[2]) / slKC_scale_values[2]

slKC_pred_data_emp_scaled$hit_angle <- (slKC_pred_data_emp_scaled$hit_angle - slKC_center_values[3]) / slKC_scale_values[3]

slKC_pred_prob_hit <- predict(slKC_rf.5, slKC_pred_data_emp_scaled, type = "prob")[,2]
slKC_pred_prob_hit_fits <- cbind(slKC_pred_data_emp, slKC_pred_prob_hit)

slKC_pred_prob_hit_fits[,c(1:2)] <- slKC_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

slKC_angle_speed_pred <- slKC_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = slKC_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nSL-KC Hit Probability\n") + theme_bp_grey()

slKC_angle_speed_pred
#####
fcKC$hit_distance_sc <- as.numeric(fcKC$hit_distance_sc, na.rm = TRUE)
fcKC$hit_angle <- as.numeric(fcKC$hit_angle, na.rm = TRUE)
fcKC$hit_speed <- as.numeric(fcKC$hit_speed, na.rm = TRUE)

fcKC$hit <- with(fcKC, ifelse(grepl("Single", fcKC$events), 1,
															ifelse(grepl("Double", fcKC$events), 1,
																		 ifelse(grepl("Triple", fcKC$events), 1, 
																		 			 ifelse(grepl("Home Run", fcKC$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

fcKC$fieldingTeam <- with(fcKC, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[fcKC$hit_distance_sc == "null"] = NA
#fcKC$hit_speed[fcKC$hit_speed == "null"] = NA
#fcKC$hit_angle[fcKC$hit_angle == "null"] = NA

# include row names for unique record identification

fcKC$row <- row.names(fcKC) %>% as.numeric()

# recode stand and home_team as factors

fcKC$stand <- as.factor(fcKC$stand)
fcKC$home_team <- as.factor(fcKC$home_team)


fcKC$game_date <- as.Date(fcKC$game_date)


# subset 

fcKC_working_data <- ungroup(fcKC) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(fcKC_working_data)
str(ungroup(fcKC))
table(fcKC_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

fcKC_working_data <- filter(fcKC_working_data, hc_x != 1, hc_y != 1)
head(fcKC_working_data)

# create training and test sets
# scaled data

set.seed(42)
fcKC_train <- sample_frac(fcKC_working_data, .15, replace = FALSE)
fcKC_split <- setdiff(fcKC_working_data, fcKC_train)
fcKC_test <- sample_frac(fcKC_split, .50, replace = FALSE)
fcKC_validate <- setdiff(fcKC_split, fcKC_test)

nrow(fcKC_train) + nrow(fcKC_test) + nrow(fcKC_validate) == nrow(fcKC_working_data)

with(fcKC_train, table(hit)) %>% prop.table()
with(fcKC_test, table(hit)) %>% prop.table()
with(fcKC_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(fcKC)
##as.numeric(fcKC$hit_distance_sc, fcKC$hit_speed, fcKC$hit_angle)

#fcKC_train$hit_distance_sc <- as.numeric(fcKC_train$hit_distance_sc)
#fcKC_train$hit_speed <- as.numeric(fcKC_train$hit_speed)
#fcKC_train$hit_angle <- as.numeric(fcKC_train$hit_angle)
#View(fcKC_train)
fcKC_scaled_data <- scale(fcKC_train[,c(1:5)])
fcKC_scale_values <- attr(fcKC_scaled_data, 'scaled:scale')
fcKC_scale_values
fcKC_center_values <- attr(fcKC_scaled_data, 'scaled:center')
fcKC_center_values
fcKC_train <- cbind(fcKC_scaled_data, select(fcKC_train, hit:row))

# save levels for factor variables
fcKC_levels_home_team <- levels(fcKC_train$home_team)
fcKC_levels_stand <- levels(fcKC_train$stand)
fcKC_levels_fieldingTeam <- levels(fcKC_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(fcKC_test)

fcKC_test$hit_distance_sc <- (fcKC_test$hit_distance_sc - fcKC_center_values[1]) / fcKC_scale_values[1]

fcKC_test$hit_speed <- (fcKC_test$hit_speed - fcKC_center_values[2]) / fcKC_scale_values[2]

fcKC_test$hit_angle <- (fcKC_test$hit_angle - fcKC_center_values[3]) / fcKC_scale_values[3]

fcKC_test$hc_x <- (fcKC_test$hc_x - fcKC_center_values[4]) / fcKC_scale_values[4]

fcKC_test$hc_y <- (fcKC_test$hc_y - fcKC_center_values[5]) / fcKC_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

fcKC_validate$hit_distance_sc <- (fcKC_validate$hit_distance_sc - fcKC_center_values[1]) / fcKC_scale_values[1]

fcKC_validate$hit_speed <- (fcKC_validate$hit_speed - fcKC_center_values[2]) / fcKC_scale_values[2]

fcKC_validate$hit_angle <- (fcKC_validate$hit_angle - fcKC_center_values[3]) / fcKC_scale_values[3]

fcKC_validate$hc_x <- (fcKC_validate$hc_x - fcKC_center_values[4]) / fcKC_scale_values[4]

fcKC_validate$hc_y <- (fcKC_validate$hc_y - fcKC_center_values[5]) / fcKC_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(fcKC_train)

set.seed(42)
fcKC_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(fcKC_train, -row), ntree = 501, importance = TRUE)

print(fcKC_rf.1)

plot(fcKC_rf.1)

varImpPlot(fcKC_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
fcKC_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(fcKC_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(fcKC_rf.5)

plot(fcKC_rf.5)

varImpPlot(fcKC_rf.5)

fcKC_predict_fit.rf.5 <- data.frame(fits = predict(fcKC_rf.5, fcKC_test, type = "prob")[,2], actuals = fcKC_test$hit)

fcKC_pred.rf.5 <- prediction(fcKC_predict_fit.rf.5$fits, fcKC_predict_fit.rf.5$actuals)

fcKC_roc.pred.rf.5 <- performance(fcKC_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(fcKC_roc.pred.rf.5)
abline(a = 0, b = 1)
fcKC_opt <- opt.cut(fcKC_roc.pred.rf.5, fcKC_pred.rf.5)
fcKC_opt
fcKC_opt <- fcKC_opt[3]
fcKC_predict_fit.rf.5$fits <- with(fcKC_predict_fit.rf.5, ifelse(fits > fcKC_opt, 1, 0)) 

str(fcKC_test)

#fcKC_test$fieldingTeam <- as.character(fcKC_test$fieldingTeam)
#fcKC_test$home_team <- as.character(fcKC_test$home_team)
#fcKC_test$hit <- as.logical(fcKC_test$hit)
#fcKC_test$stand <- as.logical(fcKC_test$stand)
str(fcKC_test)
fcKC_rf.5_confusion_test <- confusionMatrix(model = fcKC_rf.5, x = fcKC_test, y = fcKC_test$hit)
fcKC_rf.5_confusion_validate <- confusionMatrix(model = fcKC_rf.5, x = fcKC_validate, y = fcKC_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


fcKC_test_rows <- fcKC_test$row
fcKC_validate_rows <- fcKC_validate$row
fcKC_pred_data_emp_1 <- ungroup(fcKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcKC_test_rows)

fcKC_pred_data_emp <- ungroup(fcKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcKC_validate_rows) %>%
	rbind(fcKC_pred_data_emp_1)

fcKC_out_of_training_rows <- fcKC_pred_data_emp$row

fcKC_rf.5_full_out_of_sample_data <- ungroup(fcKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcKC_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



fcKC_rf.5_full_out_of_sample_data_scaled <- fcKC_rf.5_full_out_of_sample_data

fcKC_rf.5_full_out_of_sample_data_scaled$hit_speed <- (fcKC_rf.5_full_out_of_sample_data_scaled$hit_speed - fcKC_center_values[2]) / fcKC_scale_values[2]

fcKC_rf.5_full_out_of_sample_data_scaled$hit_angle <- (fcKC_rf.5_full_out_of_sample_data_scaled$hit_angle - fcKC_center_values[3]) / fcKC_scale_values[3]

fcKC_rf.5.prob <- predict(fcKC_rf.5, fcKC_rf.5_full_out_of_sample_data_scaled, type = "response")

fcKC_rf.5_full_out_of_sample_data <- cbind(filter(fcKC_rf.5_full_out_of_sample_data, row %in% fcKC_out_of_training_rows), fcKC_rf.5.prob)

names(fcKC_rf.5_full_out_of_sample_data)[65] <- "fits"
names(fcKC_rf.5_full_out_of_sample_data)

fcKC_rf.5_full_out_of_sample_data_reduced <- fcKC_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

fcKC_rf.5_mean_table <- fcKC_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

fcKC_rf.5_full_out_of_sample_data$type <- with(fcKC_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

fcKC_rf.5_full_out_of_sample_data$hit_label <- with(fcKC_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

fcKC_rf.5_plot1 <- ggplot(fcKC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcKC_rf.5_plot1

fcKC_rf.5_plot2 <- ggplot(fcKC_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcKC_rf.5_plot2

fcKC_rf.5_plot3 <- ggplot(fcKC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcKC_rf.5_plot3

fcKC_grid_plot_rf.5 <- grid.arrange(fcKC_rf.5_plot1, fcKC_rf.5_plot2, fcKC_rf.5_plot3, ncol = 3)
fcKC_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

fcKC_test_rows <- fcKC_test$row
fcKC_validate_rows <- fcKC_validate$row
fcKC_pred_data_emp_1 <- ungroup(fcKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcKC_test_rows)

fcKC_pred_data_emp <- ungroup(fcKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcKC_validate_rows) %>%
	rbind(fcKC_pred_data_emp_1)

fcKC_out_of_training_rows <- fcKC_pred_data_emp$row

fcKC_pred_data_emp <- ungroup(fcKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcKC_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

fcKC_pred_data_emp_scaled <- fcKC_pred_data_emp

fcKC_pred_data_emp_scaled$hit_speed <- (fcKC_pred_data_emp_scaled$hit_speed - fcKC_center_values[2]) / fcKC_scale_values[2]

fcKC_pred_data_emp_scaled$hit_angle <- (fcKC_pred_data_emp_scaled$hit_angle - fcKC_center_values[3]) / fcKC_scale_values[3]

fcKC_pred_prob_hit <- predict(fcKC_rf.5, fcKC_pred_data_emp_scaled, type = "prob")[,2]
fcKC_pred_prob_hit_fits <- cbind(fcKC_pred_data_emp, fcKC_pred_prob_hit)

fcKC_pred_prob_hit_fits[,c(1:2)] <- fcKC_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

fcKC_angle_speed_pred <- fcKC_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = fcKC_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFC-KC Hit Probability\n") + theme_bp_grey()

fcKC_angle_speed_pred
#####
cuKC$hit_distance_sc <- as.numeric(cuKC$hit_distance_sc, na.rm = TRUE)
cuKC$hit_angle <- as.numeric(cuKC$hit_angle, na.rm = TRUE)
cuKC$hit_speed <- as.numeric(cuKC$hit_speed, na.rm = TRUE)

cuKC$hit <- with(cuKC, ifelse(grepl("Single", cuKC$events), 1,
															ifelse(grepl("Double", cuKC$events), 1,
																		 ifelse(grepl("Triple", cuKC$events), 1, 
																		 			 ifelse(grepl("Home Run", cuKC$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

cuKC$fieldingTeam <- with(cuKC, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[cuKC$hit_distance_sc == "null"] = NA
#cuKC$hit_speed[cuKC$hit_speed == "null"] = NA
#cuKC$hit_angle[cuKC$hit_angle == "null"] = NA

# include row names for unique record identification

cuKC$row <- row.names(cuKC) %>% as.numeric()

# recode stand and home_team as factors

cuKC$stand <- as.factor(cuKC$stand)
cuKC$home_team <- as.factor(cuKC$home_team)


cuKC$game_date <- as.Date(cuKC$game_date)


# subset 

cuKC_working_data <- ungroup(cuKC) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(cuKC_working_data)
str(ungroup(cuKC))
table(cuKC_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

cuKC_working_data <- filter(cuKC_working_data, hc_x != 1, hc_y != 1)
head(cuKC_working_data)

# create training and test sets
# scaled data

set.seed(42)
cuKC_train <- sample_frac(cuKC_working_data, .15, replace = FALSE)
cuKC_split <- setdiff(cuKC_working_data, cuKC_train)
cuKC_test <- sample_frac(cuKC_split, .50, replace = FALSE)
cuKC_validate <- setdiff(cuKC_split, cuKC_test)

nrow(cuKC_train) + nrow(cuKC_test) + nrow(cuKC_validate) == nrow(cuKC_working_data)

with(cuKC_train, table(hit)) %>% prop.table()
with(cuKC_test, table(hit)) %>% prop.table()
with(cuKC_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(cuKC)
##as.numeric(cuKC$hit_distance_sc, cuKC$hit_speed, cuKC$hit_angle)

#cuKC_train$hit_distance_sc <- as.numeric(cuKC_train$hit_distance_sc)
#cuKC_train$hit_speed <- as.numeric(cuKC_train$hit_speed)
#cuKC_train$hit_angle <- as.numeric(cuKC_train$hit_angle)
#View(cuKC_train)
cuKC_scaled_data <- scale(cuKC_train[,c(1:5)])
cuKC_scale_values <- attr(cuKC_scaled_data, 'scaled:scale')
cuKC_scale_values
cuKC_center_values <- attr(cuKC_scaled_data, 'scaled:center')
cuKC_center_values
cuKC_train <- cbind(cuKC_scaled_data, select(cuKC_train, hit:row))

# save levels for factor variables
cuKC_levels_home_team <- levels(cuKC_train$home_team)
cuKC_levels_stand <- levels(cuKC_train$stand)
cuKC_levels_fieldingTeam <- levels(cuKC_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(cuKC_test)

cuKC_test$hit_distance_sc <- (cuKC_test$hit_distance_sc - cuKC_center_values[1]) / cuKC_scale_values[1]

cuKC_test$hit_speed <- (cuKC_test$hit_speed - cuKC_center_values[2]) / cuKC_scale_values[2]

cuKC_test$hit_angle <- (cuKC_test$hit_angle - cuKC_center_values[3]) / cuKC_scale_values[3]

cuKC_test$hc_x <- (cuKC_test$hc_x - cuKC_center_values[4]) / cuKC_scale_values[4]

cuKC_test$hc_y <- (cuKC_test$hc_y - cuKC_center_values[5]) / cuKC_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

cuKC_validate$hit_distance_sc <- (cuKC_validate$hit_distance_sc - cuKC_center_values[1]) / cuKC_scale_values[1]

cuKC_validate$hit_speed <- (cuKC_validate$hit_speed - cuKC_center_values[2]) / cuKC_scale_values[2]

cuKC_validate$hit_angle <- (cuKC_validate$hit_angle - cuKC_center_values[3]) / cuKC_scale_values[3]

cuKC_validate$hc_x <- (cuKC_validate$hc_x - cuKC_center_values[4]) / cuKC_scale_values[4]

cuKC_validate$hc_y <- (cuKC_validate$hc_y - cuKC_center_values[5]) / cuKC_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(cuKC_train)

set.seed(42)
cuKC_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(cuKC_train, -row), ntree = 501, importance = TRUE)

print(cuKC_rf.1)

plot(cuKC_rf.1)

varImpPlot(cuKC_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
cuKC_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(cuKC_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(cuKC_rf.5)

plot(cuKC_rf.5)

varImpPlot(cuKC_rf.5)

cuKC_predict_fit.rf.5 <- data.frame(fits = predict(cuKC_rf.5, cuKC_test, type = "prob")[,2], actuals = cuKC_test$hit)

cuKC_pred.rf.5 <- prediction(cuKC_predict_fit.rf.5$fits, cuKC_predict_fit.rf.5$actuals)

cuKC_roc.pred.rf.5 <- performance(cuKC_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(cuKC_roc.pred.rf.5)
abline(a = 0, b = 1)
cuKC_opt <- opt.cut(cuKC_roc.pred.rf.5, cuKC_pred.rf.5)
cuKC_opt
cuKC_opt <- cuKC_opt[3]
cuKC_predict_fit.rf.5$fits <- with(cuKC_predict_fit.rf.5, ifelse(fits > cuKC_opt, 1, 0)) 

str(cuKC_test)

#cuKC_test$fieldingTeam <- as.character(cuKC_test$fieldingTeam)
#cuKC_test$home_team <- as.character(cuKC_test$home_team)
#cuKC_test$hit <- as.logical(cuKC_test$hit)
#cuKC_test$stand <- as.logical(cuKC_test$stand)
str(cuKC_test)
cuKC_rf.5_confusion_test <- confusionMatrix(model = cuKC_rf.5, x = cuKC_test, y = cuKC_test$hit)
cuKC_rf.5_confusion_validate <- confusionMatrix(model = cuKC_rf.5, x = cuKC_validate, y = cuKC_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


cuKC_test_rows <- cuKC_test$row
cuKC_validate_rows <- cuKC_validate$row
cuKC_pred_data_emp_1 <- ungroup(cuKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuKC_test_rows)

cuKC_pred_data_emp <- ungroup(cuKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuKC_validate_rows) %>%
	rbind(cuKC_pred_data_emp_1)

cuKC_out_of_training_rows <- cuKC_pred_data_emp$row

cuKC_rf.5_full_out_of_sample_data <- ungroup(cuKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuKC_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



cuKC_rf.5_full_out_of_sample_data_scaled <- cuKC_rf.5_full_out_of_sample_data

cuKC_rf.5_full_out_of_sample_data_scaled$hit_speed <- (cuKC_rf.5_full_out_of_sample_data_scaled$hit_speed - cuKC_center_values[2]) / cuKC_scale_values[2]

cuKC_rf.5_full_out_of_sample_data_scaled$hit_angle <- (cuKC_rf.5_full_out_of_sample_data_scaled$hit_angle - cuKC_center_values[3]) / cuKC_scale_values[3]

cuKC_rf.5.prob <- predict(cuKC_rf.5, cuKC_rf.5_full_out_of_sample_data_scaled, type = "response")

cuKC_rf.5_full_out_of_sample_data <- cbind(filter(cuKC_rf.5_full_out_of_sample_data, row %in% cuKC_out_of_training_rows), cuKC_rf.5.prob)

names(cuKC_rf.5_full_out_of_sample_data)[65] <- "fits"
names(cuKC_rf.5_full_out_of_sample_data)

cuKC_rf.5_full_out_of_sample_data_reduced <- cuKC_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

cuKC_rf.5_mean_table <- cuKC_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

cuKC_rf.5_full_out_of_sample_data$type <- with(cuKC_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

cuKC_rf.5_full_out_of_sample_data$hit_label <- with(cuKC_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

cuKC_rf.5_plot1 <- ggplot(cuKC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuKC_rf.5_plot1

cuKC_rf.5_plot2 <- ggplot(cuKC_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuKC_rf.5_plot2

cuKC_rf.5_plot3 <- ggplot(cuKC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuKC_rf.5_plot3

cuKC_grid_plot_rf.5 <- grid.arrange(cuKC_rf.5_plot1, cuKC_rf.5_plot2, cuKC_rf.5_plot3, ncol = 3)
cuKC_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

cuKC_test_rows <- cuKC_test$row
cuKC_validate_rows <- cuKC_validate$row
cuKC_pred_data_emp_1 <- ungroup(cuKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuKC_test_rows)

cuKC_pred_data_emp <- ungroup(cuKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuKC_validate_rows) %>%
	rbind(cuKC_pred_data_emp_1)

cuKC_out_of_training_rows <- cuKC_pred_data_emp$row

cuKC_pred_data_emp <- ungroup(cuKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuKC_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

cuKC_pred_data_emp_scaled <- cuKC_pred_data_emp

cuKC_pred_data_emp_scaled$hit_speed <- (cuKC_pred_data_emp_scaled$hit_speed - cuKC_center_values[2]) / cuKC_scale_values[2]

cuKC_pred_data_emp_scaled$hit_angle <- (cuKC_pred_data_emp_scaled$hit_angle - cuKC_center_values[3]) / cuKC_scale_values[3]

cuKC_pred_prob_hit <- predict(cuKC_rf.5, cuKC_pred_data_emp_scaled, type = "prob")[,2]
cuKC_pred_prob_hit_fits <- cbind(cuKC_pred_data_emp, cuKC_pred_prob_hit)

cuKC_pred_prob_hit_fits[,c(1:2)] <- cuKC_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

cuKC_angle_speed_pred <- cuKC_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = cuKC_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nCU-KC Hit Probability\n") + theme_bp_grey()

cuKC_angle_speed_pred
#####
ffKC$hit_distance_sc <- as.numeric(ffKC$hit_distance_sc, na.rm = TRUE)
ffKC$hit_angle <- as.numeric(ffKC$hit_angle, na.rm = TRUE)
ffKC$hit_speed <- as.numeric(ffKC$hit_speed, na.rm = TRUE)

ffKC$hit <- with(ffKC, ifelse(grepl("Single", ffKC$events), 1,
															ifelse(grepl("Double", ffKC$events), 1,
																		 ifelse(grepl("Triple", ffKC$events), 1, 
																		 			 ifelse(grepl("Home Run", ffKC$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

ffKC$fieldingTeam <- with(ffKC, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[ffKC$hit_distance_sc == "null"] = NA
#ffKC$hit_speed[ffKC$hit_speed == "null"] = NA
#ffKC$hit_angle[ffKC$hit_angle == "null"] = NA

# include row names for unique record identification

ffKC$row <- row.names(ffKC) %>% as.numeric()

# recode stand and home_team as factors

ffKC$stand <- as.factor(ffKC$stand)
ffKC$home_team <- as.factor(ffKC$home_team)


ffKC$game_date <- as.Date(ffKC$game_date)


# subset 

ffKC_working_data <- ungroup(ffKC) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(ffKC_working_data)
str(ungroup(ffKC))
table(ffKC_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

ffKC_working_data <- filter(ffKC_working_data, hc_x != 1, hc_y != 1)
head(ffKC_working_data)

# create training and test sets
# scaled data

set.seed(42)
ffKC_train <- sample_frac(ffKC_working_data, .15, replace = FALSE)
ffKC_split <- setdiff(ffKC_working_data, ffKC_train)
ffKC_test <- sample_frac(ffKC_split, .50, replace = FALSE)
ffKC_validate <- setdiff(ffKC_split, ffKC_test)

nrow(ffKC_train) + nrow(ffKC_test) + nrow(ffKC_validate) == nrow(ffKC_working_data)

with(ffKC_train, table(hit)) %>% prop.table()
with(ffKC_test, table(hit)) %>% prop.table()
with(ffKC_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(ffKC)
##as.numeric(ffKC$hit_distance_sc, ffKC$hit_speed, ffKC$hit_angle)

#ffKC_train$hit_distance_sc <- as.numeric(ffKC_train$hit_distance_sc)
#ffKC_train$hit_speed <- as.numeric(ffKC_train$hit_speed)
#ffKC_train$hit_angle <- as.numeric(ffKC_train$hit_angle)
#View(ffKC_train)
ffKC_scaled_data <- scale(ffKC_train[,c(1:5)])
ffKC_scale_values <- attr(ffKC_scaled_data, 'scaled:scale')
ffKC_scale_values
ffKC_center_values <- attr(ffKC_scaled_data, 'scaled:center')
ffKC_center_values
ffKC_train <- cbind(ffKC_scaled_data, select(ffKC_train, hit:row))

# save levels for factor variables
ffKC_levels_home_team <- levels(ffKC_train$home_team)
ffKC_levels_stand <- levels(ffKC_train$stand)
ffKC_levels_fieldingTeam <- levels(ffKC_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(ffKC_test)

ffKC_test$hit_distance_sc <- (ffKC_test$hit_distance_sc - ffKC_center_values[1]) / ffKC_scale_values[1]

ffKC_test$hit_speed <- (ffKC_test$hit_speed - ffKC_center_values[2]) / ffKC_scale_values[2]

ffKC_test$hit_angle <- (ffKC_test$hit_angle - ffKC_center_values[3]) / ffKC_scale_values[3]

ffKC_test$hc_x <- (ffKC_test$hc_x - ffKC_center_values[4]) / ffKC_scale_values[4]

ffKC_test$hc_y <- (ffKC_test$hc_y - ffKC_center_values[5]) / ffKC_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

ffKC_validate$hit_distance_sc <- (ffKC_validate$hit_distance_sc - ffKC_center_values[1]) / ffKC_scale_values[1]

ffKC_validate$hit_speed <- (ffKC_validate$hit_speed - ffKC_center_values[2]) / ffKC_scale_values[2]

ffKC_validate$hit_angle <- (ffKC_validate$hit_angle - ffKC_center_values[3]) / ffKC_scale_values[3]

ffKC_validate$hc_x <- (ffKC_validate$hc_x - ffKC_center_values[4]) / ffKC_scale_values[4]

ffKC_validate$hc_y <- (ffKC_validate$hc_y - ffKC_center_values[5]) / ffKC_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(ffKC_train)

set.seed(42)
ffKC_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(ffKC_train, -row), ntree = 501, importance = TRUE)

print(ffKC_rf.1)

plot(ffKC_rf.1)

varImpPlot(ffKC_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
ffKC_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(ffKC_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(ffKC_rf.5)

plot(ffKC_rf.5)

varImpPlot(ffKC_rf.5)

ffKC_predict_fit.rf.5 <- data.frame(fits = predict(ffKC_rf.5, ffKC_test, type = "prob")[,2], actuals = ffKC_test$hit)

ffKC_pred.rf.5 <- prediction(ffKC_predict_fit.rf.5$fits, ffKC_predict_fit.rf.5$actuals)

ffKC_roc.pred.rf.5 <- performance(ffKC_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(ffKC_roc.pred.rf.5)
abline(a = 0, b = 1)
ffKC_opt <- opt.cut(ffKC_roc.pred.rf.5, ffKC_pred.rf.5)
ffKC_opt
ffKC_opt <- ffKC_opt[3]
ffKC_predict_fit.rf.5$fits <- with(ffKC_predict_fit.rf.5, ifelse(fits > ffKC_opt, 1, 0)) 

str(ffKC_test)

#ffKC_test$fieldingTeam <- as.character(ffKC_test$fieldingTeam)
#ffKC_test$home_team <- as.character(ffKC_test$home_team)
#ffKC_test$hit <- as.logical(ffKC_test$hit)
#ffKC_test$stand <- as.logical(ffKC_test$stand)
str(ffKC_test)
ffKC_rf.5_confusion_test <- confusionMatrix(model = ffKC_rf.5, x = ffKC_test, y = ffKC_test$hit)
ffKC_rf.5_confusion_validate <- confusionMatrix(model = ffKC_rf.5, x = ffKC_validate, y = ffKC_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


ffKC_test_rows <- ffKC_test$row
ffKC_validate_rows <- ffKC_validate$row
ffKC_pred_data_emp_1 <- ungroup(ffKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffKC_test_rows)

ffKC_pred_data_emp <- ungroup(ffKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffKC_validate_rows) %>%
	rbind(ffKC_pred_data_emp_1)

ffKC_out_of_training_rows <- ffKC_pred_data_emp$row

ffKC_rf.5_full_out_of_sample_data <- ungroup(ffKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffKC_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



ffKC_rf.5_full_out_of_sample_data_scaled <- ffKC_rf.5_full_out_of_sample_data

ffKC_rf.5_full_out_of_sample_data_scaled$hit_speed <- (ffKC_rf.5_full_out_of_sample_data_scaled$hit_speed - ffKC_center_values[2]) / ffKC_scale_values[2]

ffKC_rf.5_full_out_of_sample_data_scaled$hit_angle <- (ffKC_rf.5_full_out_of_sample_data_scaled$hit_angle - ffKC_center_values[3]) / ffKC_scale_values[3]

ffKC_rf.5.prob <- predict(ffKC_rf.5, ffKC_rf.5_full_out_of_sample_data_scaled, type = "response")

ffKC_rf.5_full_out_of_sample_data <- cbind(filter(ffKC_rf.5_full_out_of_sample_data, row %in% ffKC_out_of_training_rows), ffKC_rf.5.prob)

names(ffKC_rf.5_full_out_of_sample_data)[65] <- "fits"
names(ffKC_rf.5_full_out_of_sample_data)

ffKC_rf.5_full_out_of_sample_data_reduced <- ffKC_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

ffKC_rf.5_mean_table <- ffKC_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

ffKC_rf.5_full_out_of_sample_data$type <- with(ffKC_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

ffKC_rf.5_full_out_of_sample_data$hit_label <- with(ffKC_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

ffKC_rf.5_plot1 <- ggplot(ffKC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffKC_rf.5_plot1

ffKC_rf.5_plot2 <- ggplot(ffKC_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffKC_rf.5_plot2

ffKC_rf.5_plot3 <- ggplot(ffKC_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffKC_rf.5_plot3

ffKC_grid_plot_rf.5 <- grid.arrange(ffKC_rf.5_plot1, ffKC_rf.5_plot2, ffKC_rf.5_plot3, ncol = 3)
ffKC_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

ffKC_test_rows <- ffKC_test$row
ffKC_validate_rows <- ffKC_validate$row
ffKC_pred_data_emp_1 <- ungroup(ffKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffKC_test_rows)

ffKC_pred_data_emp <- ungroup(ffKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffKC_validate_rows) %>%
	rbind(ffKC_pred_data_emp_1)

ffKC_out_of_training_rows <- ffKC_pred_data_emp$row

ffKC_pred_data_emp <- ungroup(ffKC) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffKC_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

ffKC_pred_data_emp_scaled <- ffKC_pred_data_emp

ffKC_pred_data_emp_scaled$hit_speed <- (ffKC_pred_data_emp_scaled$hit_speed - ffKC_center_values[2]) / ffKC_scale_values[2]

ffKC_pred_data_emp_scaled$hit_angle <- (ffKC_pred_data_emp_scaled$hit_angle - ffKC_center_values[3]) / ffKC_scale_values[3]

ffKC_pred_prob_hit <- predict(ffKC_rf.5, ffKC_pred_data_emp_scaled, type = "prob")[,2]
ffKC_pred_prob_hit_fits <- cbind(ffKC_pred_data_emp, ffKC_pred_prob_hit)

ffKC_pred_prob_hit_fits[,c(1:2)] <- ffKC_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

ffKC_angle_speed_pred <- ffKC_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = ffKC_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFF-KC Hit Probability\n") + theme_bp_grey()

ffKC_angle_speed_pred
############# End Knuckle Curves; Start Knuckleballs
########################## Start Knuckleballs
#####
siKN$hit_distance_sc <- as.numeric(siKN$hit_distance_sc, na.rm = TRUE)
siKN$hit_angle <- as.numeric(siKN$hit_angle, na.rm = TRUE)
siKN$hit_speed <- as.numeric(siKN$hit_speed, na.rm = TRUE)

siKN$hit <- with(siKN, ifelse(grepl("Single", siKN$events), 1,
															ifelse(grepl("Double", siKN$events), 1,
																		 ifelse(grepl("Triple", siKN$events), 1, 
																		 			 ifelse(grepl("Home Run", siKN$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

siKN$fieldingTeam <- with(siKN, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[siKN$hit_distance_sc == "null"] = NA
#siKN$hit_speed[siKN$hit_speed == "null"] = NA
#siKN$hit_angle[siKN$hit_angle == "null"] = NA

# include row names for unique record identification

siKN$row <- row.names(siKN) %>% as.numeric()

# recode stand and home_team as factors

siKN$stand <- as.factor(siKN$stand)
siKN$home_team <- as.factor(siKN$home_team)


siKN$game_date <- as.Date(siKN$game_date)


# subset 

siKN_working_data <- ungroup(siKN) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(siKN_working_data)
str(ungroup(siKN))
table(siKN_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

siKN_working_data <- filter(siKN_working_data, hc_x != 1, hc_y != 1)
head(siKN_working_data)

# create training and test sets
# scaled data

set.seed(42)
siKN_train <- sample_frac(siKN_working_data, .15, replace = FALSE)
siKN_split <- setdiff(siKN_working_data, siKN_train)
siKN_test <- sample_frac(siKN_split, .50, replace = FALSE)
siKN_validate <- setdiff(siKN_split, siKN_test)

nrow(siKN_train) + nrow(siKN_test) + nrow(siKN_validate) == nrow(siKN_working_data)

with(siKN_train, table(hit)) %>% prop.table()
with(siKN_test, table(hit)) %>% prop.table()
with(siKN_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(siKN)
##as.numeric(siKN$hit_distance_sc, siKN$hit_speed, siKN$hit_angle)

#siKN_train$hit_distance_sc <- as.numeric(siKN_train$hit_distance_sc)
#siKN_train$hit_speed <- as.numeric(siKN_train$hit_speed)
#siKN_train$hit_angle <- as.numeric(siKN_train$hit_angle)
#View(siKN_train)
siKN_scaled_data <- scale(siKN_train[,c(1:5)])
siKN_scale_values <- attr(siKN_scaled_data, 'scaled:scale')
siKN_scale_values
siKN_center_values <- attr(siKN_scaled_data, 'scaled:center')
siKN_center_values
siKN_train <- cbind(siKN_scaled_data, select(siKN_train, hit:row))

# save levels for factor variables
siKN_levels_home_team <- levels(siKN_train$home_team)
siKN_levels_stand <- levels(siKN_train$stand)
siKN_levels_fieldingTeam <- levels(siKN_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(siKN_test)

siKN_test$hit_distance_sc <- (siKN_test$hit_distance_sc - siKN_center_values[1]) / siKN_scale_values[1]

siKN_test$hit_speed <- (siKN_test$hit_speed - siKN_center_values[2]) / siKN_scale_values[2]

siKN_test$hit_angle <- (siKN_test$hit_angle - siKN_center_values[3]) / siKN_scale_values[3]

siKN_test$hc_x <- (siKN_test$hc_x - siKN_center_values[4]) / siKN_scale_values[4]

siKN_test$hc_y <- (siKN_test$hc_y - siKN_center_values[5]) / siKN_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

siKN_validate$hit_distance_sc <- (siKN_validate$hit_distance_sc - siKN_center_values[1]) / siKN_scale_values[1]

siKN_validate$hit_speed <- (siKN_validate$hit_speed - siKN_center_values[2]) / siKN_scale_values[2]

siKN_validate$hit_angle <- (siKN_validate$hit_angle - siKN_center_values[3]) / siKN_scale_values[3]

siKN_validate$hc_x <- (siKN_validate$hc_x - siKN_center_values[4]) / siKN_scale_values[4]

siKN_validate$hc_y <- (siKN_validate$hc_y - siKN_center_values[5]) / siKN_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(siKN_train)

set.seed(42)
siKN_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(siKN_train, -row), ntree = 501, importance = TRUE)

print(siKN_rf.1)

plot(siKN_rf.1)

varImpPlot(siKN_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
siKN_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(siKN_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(siKN_rf.5)

plot(siKN_rf.5)

varImpPlot(siKN_rf.5)

siKN_predict_fit.rf.5 <- data.frame(fits = predict(siKN_rf.5, siKN_test, type = "prob")[,2], actuals = siKN_test$hit)

siKN_pred.rf.5 <- prediction(siKN_predict_fit.rf.5$fits, siKN_predict_fit.rf.5$actuals)

siKN_roc.pred.rf.5 <- performance(siKN_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(siKN_roc.pred.rf.5)
abline(a = 0, b = 1)
siKN_opt <- opt.cut(siKN_roc.pred.rf.5, siKN_pred.rf.5)
siKN_opt
siKN_opt <- siKN_opt[3]
siKN_predict_fit.rf.5$fits <- with(siKN_predict_fit.rf.5, ifelse(fits > siKN_opt, 1, 0)) 

str(siKN_test)

#siKN_test$fieldingTeam <- as.character(siKN_test$fieldingTeam)
#siKN_test$home_team <- as.character(siKN_test$home_team)
#siKN_test$hit <- as.logical(siKN_test$hit)
#siKN_test$stand <- as.logical(siKN_test$stand)
str(siKN_test)
siKN_rf.5_confusion_test <- confusionMatrix(model = siKN_rf.5, x = siKN_test, y = siKN_test$hit)
siKN_rf.5_confusion_validate <- confusionMatrix(model = siKN_rf.5, x = siKN_validate, y = siKN_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


siKN_test_rows <- siKN_test$row
siKN_validate_rows <- siKN_validate$row
siKN_pred_data_emp_1 <- ungroup(siKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siKN_test_rows)

siKN_pred_data_emp <- ungroup(siKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siKN_validate_rows) %>%
	rbind(siKN_pred_data_emp_1)

siKN_out_of_training_rows <- siKN_pred_data_emp$row

siKN_rf.5_full_out_of_sample_data <- ungroup(siKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siKN_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



siKN_rf.5_full_out_of_sample_data_scaled <- siKN_rf.5_full_out_of_sample_data

siKN_rf.5_full_out_of_sample_data_scaled$hit_speed <- (siKN_rf.5_full_out_of_sample_data_scaled$hit_speed - siKN_center_values[2]) / siKN_scale_values[2]

siKN_rf.5_full_out_of_sample_data_scaled$hit_angle <- (siKN_rf.5_full_out_of_sample_data_scaled$hit_angle - siKN_center_values[3]) / siKN_scale_values[3]

siKN_rf.5.prob <- predict(siKN_rf.5, siKN_rf.5_full_out_of_sample_data_scaled, type = "response")

siKN_rf.5_full_out_of_sample_data <- cbind(filter(siKN_rf.5_full_out_of_sample_data, row %in% siKN_out_of_training_rows), siKN_rf.5.prob)

names(siKN_rf.5_full_out_of_sample_data)[65] <- "fits"
names(siKN_rf.5_full_out_of_sample_data)

siKN_rf.5_full_out_of_sample_data_reduced <- siKN_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

siKN_rf.5_mean_table <- siKN_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

siKN_rf.5_full_out_of_sample_data$type <- with(siKN_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

siKN_rf.5_full_out_of_sample_data$hit_label <- with(siKN_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

siKN_rf.5_plot1 <- ggplot(siKN_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siKN_rf.5_plot1

siKN_rf.5_plot2 <- ggplot(siKN_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siKN_rf.5_plot2

siKN_rf.5_plot3 <- ggplot(siKN_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

siKN_rf.5_plot3

siKN_grid_plot_rf.5 <- grid.arrange(siKN_rf.5_plot1, siKN_rf.5_plot2, siKN_rf.5_plot3, ncol = 3)
siKN_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

siKN_test_rows <- siKN_test$row
siKN_validate_rows <- siKN_validate$row
siKN_pred_data_emp_1 <- ungroup(siKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siKN_test_rows)

siKN_pred_data_emp <- ungroup(siKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siKN_validate_rows) %>%
	rbind(siKN_pred_data_emp_1)

siKN_out_of_training_rows <- siKN_pred_data_emp$row

siKN_pred_data_emp <- ungroup(siKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% siKN_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

siKN_pred_data_emp_scaled <- siKN_pred_data_emp

siKN_pred_data_emp_scaled$hit_speed <- (siKN_pred_data_emp_scaled$hit_speed - siKN_center_values[2]) / siKN_scale_values[2]

siKN_pred_data_emp_scaled$hit_angle <- (siKN_pred_data_emp_scaled$hit_angle - siKN_center_values[3]) / siKN_scale_values[3]

siKN_pred_prob_hit <- predict(siKN_rf.5, siKN_pred_data_emp_scaled, type = "prob")[,2]
siKN_pred_prob_hit_fits <- cbind(siKN_pred_data_emp, siKN_pred_prob_hit)

siKN_pred_prob_hit_fits[,c(1:2)] <- siKN_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

siKN_angle_speed_pred <- siKN_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = siKN_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nSI-KN Hit Probability\n") + theme_bp_grey()

siKN_angle_speed_pred
#####
kcKN$hit_distance_sc <- as.numeric(kcKN$hit_distance_sc, na.rm = TRUE)
kcKN$hit_angle <- as.numeric(kcKN$hit_angle, na.rm = TRUE)
kcKN$hit_speed <- as.numeric(kcKN$hit_speed, na.rm = TRUE)

kcKN$hit <- with(kcKN, ifelse(grepl("Single", kcKN$events), 1,
															ifelse(grepl("Double", kcKN$events), 1,
																		 ifelse(grepl("Triple", kcKN$events), 1, 
																		 			 ifelse(grepl("Home Run", kcKN$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

kcKN$fieldingTeam <- with(kcKN, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[kcKN$hit_distance_sc == "null"] = NA
#kcKN$hit_speed[kcKN$hit_speed == "null"] = NA
#kcKN$hit_angle[kcKN$hit_angle == "null"] = NA

# include row names for unique record identification

kcKN$row <- row.names(kcKN) %>% as.numeric()

# recode stand and home_team as factors

kcKN$stand <- as.factor(kcKN$stand)
kcKN$home_team <- as.factor(kcKN$home_team)


kcKN$game_date <- as.Date(kcKN$game_date)


# subset 

kcKN_working_data <- ungroup(kcKN) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(kcKN_working_data)
str(ungroup(kcKN))
table(kcKN_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

kcKN_working_data <- filter(kcKN_working_data, hc_x != 1, hc_y != 1)
head(kcKN_working_data)

# create training and test sets
# scaled data

set.seed(42)
kcKN_train <- sample_frac(kcKN_working_data, .15, replace = FALSE)
kcKN_split <- setdiff(kcKN_working_data, kcKN_train)
kcKN_test <- sample_frac(kcKN_split, .50, replace = FALSE)
kcKN_validate <- setdiff(kcKN_split, kcKN_test)

nrow(kcKN_train) + nrow(kcKN_test) + nrow(kcKN_validate) == nrow(kcKN_working_data)

with(kcKN_train, table(hit)) %>% prop.table()
with(kcKN_test, table(hit)) %>% prop.table()
with(kcKN_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(kcKN)
##as.numeric(kcKN$hit_distance_sc, kcKN$hit_speed, kcKN$hit_angle)

#kcKN_train$hit_distance_sc <- as.numeric(kcKN_train$hit_distance_sc)
#kcKN_train$hit_speed <- as.numeric(kcKN_train$hit_speed)
#kcKN_train$hit_angle <- as.numeric(kcKN_train$hit_angle)
#View(kcKN_train)
kcKN_scaled_data <- scale(kcKN_train[,c(1:5)])
kcKN_scale_values <- attr(kcKN_scaled_data, 'scaled:scale')
kcKN_scale_values
kcKN_center_values <- attr(kcKN_scaled_data, 'scaled:center')
kcKN_center_values
kcKN_train <- cbind(kcKN_scaled_data, select(kcKN_train, hit:row))

# save levels for factor variables
kcKN_levels_home_team <- levels(kcKN_train$home_team)
kcKN_levels_stand <- levels(kcKN_train$stand)
kcKN_levels_fieldingTeam <- levels(kcKN_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(kcKN_test)

kcKN_test$hit_distance_sc <- (kcKN_test$hit_distance_sc - kcKN_center_values[1]) / kcKN_scale_values[1]

kcKN_test$hit_speed <- (kcKN_test$hit_speed - kcKN_center_values[2]) / kcKN_scale_values[2]

kcKN_test$hit_angle <- (kcKN_test$hit_angle - kcKN_center_values[3]) / kcKN_scale_values[3]

kcKN_test$hc_x <- (kcKN_test$hc_x - kcKN_center_values[4]) / kcKN_scale_values[4]

kcKN_test$hc_y <- (kcKN_test$hc_y - kcKN_center_values[5]) / kcKN_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

kcKN_validate$hit_distance_sc <- (kcKN_validate$hit_distance_sc - kcKN_center_values[1]) / kcKN_scale_values[1]

kcKN_validate$hit_speed <- (kcKN_validate$hit_speed - kcKN_center_values[2]) / kcKN_scale_values[2]

kcKN_validate$hit_angle <- (kcKN_validate$hit_angle - kcKN_center_values[3]) / kcKN_scale_values[3]

kcKN_validate$hc_x <- (kcKN_validate$hc_x - kcKN_center_values[4]) / kcKN_scale_values[4]

kcKN_validate$hc_y <- (kcKN_validate$hc_y - kcKN_center_values[5]) / kcKN_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(kcKN_train)

set.seed(42)
kcKN_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(kcKN_train, -row), ntree = 501, importance = TRUE)

print(kcKN_rf.1)

plot(kcKN_rf.1)

varImpPlot(kcKN_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
kcKN_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(kcKN_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(kcKN_rf.5)

plot(kcKN_rf.5)

varImpPlot(kcKN_rf.5)

kcKN_predict_fit.rf.5 <- data.frame(fits = predict(kcKN_rf.5, kcKN_test, type = "prob")[,2], actuals = kcKN_test$hit)

kcKN_pred.rf.5 <- prediction(kcKN_predict_fit.rf.5$fits, kcKN_predict_fit.rf.5$actuals)

kcKN_roc.pred.rf.5 <- performance(kcKN_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(kcKN_roc.pred.rf.5)
abline(a = 0, b = 1)
kcKN_opt <- opt.cut(kcKN_roc.pred.rf.5, kcKN_pred.rf.5)
kcKN_opt
kcKN_opt <- kcKN_opt[3]
kcKN_predict_fit.rf.5$fits <- with(kcKN_predict_fit.rf.5, ifelse(fits > kcKN_opt, 1, 0)) 

str(kcKN_test)

#kcKN_test$fieldingTeam <- as.character(kcKN_test$fieldingTeam)
#kcKN_test$home_team <- as.character(kcKN_test$home_team)
#kcKN_test$hit <- as.logical(kcKN_test$hit)
#kcKN_test$stand <- as.logical(kcKN_test$stand)
str(kcKN_test)
kcKN_rf.5_confusion_test <- confusionMatrix(model = kcKN_rf.5, x = kcKN_test, y = kcKN_test$hit)
kcKN_rf.5_confusion_validate <- confusionMatrix(model = kcKN_rf.5, x = kcKN_validate, y = kcKN_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


kcKN_test_rows <- kcKN_test$row
kcKN_validate_rows <- kcKN_validate$row
kcKN_pred_data_emp_1 <- ungroup(kcKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcKN_test_rows)

kcKN_pred_data_emp <- ungroup(kcKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcKN_validate_rows) %>%
	rbind(kcKN_pred_data_emp_1)

kcKN_out_of_training_rows <- kcKN_pred_data_emp$row

kcKN_rf.5_full_out_of_sample_data <- ungroup(kcKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcKN_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



kcKN_rf.5_full_out_of_sample_data_scaled <- kcKN_rf.5_full_out_of_sample_data

kcKN_rf.5_full_out_of_sample_data_scaled$hit_speed <- (kcKN_rf.5_full_out_of_sample_data_scaled$hit_speed - kcKN_center_values[2]) / kcKN_scale_values[2]

kcKN_rf.5_full_out_of_sample_data_scaled$hit_angle <- (kcKN_rf.5_full_out_of_sample_data_scaled$hit_angle - kcKN_center_values[3]) / kcKN_scale_values[3]

kcKN_rf.5.prob <- predict(kcKN_rf.5, kcKN_rf.5_full_out_of_sample_data_scaled, type = "response")

kcKN_rf.5_full_out_of_sample_data <- cbind(filter(kcKN_rf.5_full_out_of_sample_data, row %in% kcKN_out_of_training_rows), kcKN_rf.5.prob)

names(kcKN_rf.5_full_out_of_sample_data)[65] <- "fits"
names(kcKN_rf.5_full_out_of_sample_data)

kcKN_rf.5_full_out_of_sample_data_reduced <- kcKN_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

kcKN_rf.5_mean_table <- kcKN_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

kcKN_rf.5_full_out_of_sample_data$type <- with(kcKN_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

kcKN_rf.5_full_out_of_sample_data$hit_label <- with(kcKN_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

kcKN_rf.5_plot1 <- ggplot(kcKN_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcKN_rf.5_plot1

kcKN_rf.5_plot2 <- ggplot(kcKN_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcKN_rf.5_plot2

kcKN_rf.5_plot3 <- ggplot(kcKN_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcKN_rf.5_plot3

kcKN_grid_plot_rf.5 <- grid.arrange(kcKN_rf.5_plot1, kcKN_rf.5_plot2, kcKN_rf.5_plot3, ncol = 3)
kcKN_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

kcKN_test_rows <- kcKN_test$row
kcKN_validate_rows <- kcKN_validate$row
kcKN_pred_data_emp_1 <- ungroup(kcKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcKN_test_rows)

kcKN_pred_data_emp <- ungroup(kcKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcKN_validate_rows) %>%
	rbind(kcKN_pred_data_emp_1)

kcKN_out_of_training_rows <- kcKN_pred_data_emp$row

kcKN_pred_data_emp <- ungroup(kcKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcKN_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

kcKN_pred_data_emp_scaled <- kcKN_pred_data_emp

kcKN_pred_data_emp_scaled$hit_speed <- (kcKN_pred_data_emp_scaled$hit_speed - kcKN_center_values[2]) / kcKN_scale_values[2]

kcKN_pred_data_emp_scaled$hit_angle <- (kcKN_pred_data_emp_scaled$hit_angle - kcKN_center_values[3]) / kcKN_scale_values[3]

kcKN_pred_prob_hit <- predict(kcKN_rf.5, kcKN_pred_data_emp_scaled, type = "prob")[,2]
kcKN_pred_prob_hit_fits <- cbind(kcKN_pred_data_emp, kcKN_pred_prob_hit)

kcKN_pred_prob_hit_fits[,c(1:2)] <- kcKN_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

kcKN_angle_speed_pred <- kcKN_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = kcKN_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nKC-KN Hit Probability\n") + theme_bp_grey()

kcKN_angle_speed_pred

#####
fsKN$hit_distance_sc <- as.numeric(fsKN$hit_distance_sc, na.rm = TRUE)
fsKN$hit_angle <- as.numeric(fsKN$hit_angle, na.rm = TRUE)
fsKN$hit_speed <- as.numeric(fsKN$hit_speed, na.rm = TRUE)

fsKN$hit <- with(fsKN, ifelse(grepl("Single", fsKN$events), 1,
															ifelse(grepl("Double", fsKN$events), 1,
																		 ifelse(grepl("Triple", fsKN$events), 1, 
																		 			 ifelse(grepl("Home Run", fsKN$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

fsKN$fieldingTeam <- with(fsKN, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[fsKN$hit_distance_sc == "null"] = NA
#fsKN$hit_speed[fsKN$hit_speed == "null"] = NA
#fsKN$hit_angle[fsKN$hit_angle == "null"] = NA

# include row names for unique record identification

fsKN$row <- row.names(fsKN) %>% as.numeric()

# recode stand and home_team as factors

fsKN$stand <- as.factor(fsKN$stand)
fsKN$home_team <- as.factor(fsKN$home_team)


fsKN$game_date <- as.Date(fsKN$game_date)


# subset 

fsKN_working_data <- ungroup(fsKN) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(fsKN_working_data)
str(ungroup(fsKN))
table(fsKN_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

fsKN_working_data <- filter(fsKN_working_data, hc_x != 1, hc_y != 1)
head(fsKN_working_data)

# create training and test sets
# scaled data

set.seed(42)
fsKN_train <- sample_frac(fsKN_working_data, .15, replace = FALSE)
fsKN_split <- setdiff(fsKN_working_data, fsKN_train)
fsKN_test <- sample_frac(fsKN_split, .50, replace = FALSE)
fsKN_validate <- setdiff(fsKN_split, fsKN_test)

nrow(fsKN_train) + nrow(fsKN_test) + nrow(fsKN_validate) == nrow(fsKN_working_data)

with(fsKN_train, table(hit)) %>% prop.table()
with(fsKN_test, table(hit)) %>% prop.table()
with(fsKN_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(fsKN)
##as.numeric(fsKN$hit_distance_sc, fsKN$hit_speed, fsKN$hit_angle)

#fsKN_train$hit_distance_sc <- as.numeric(fsKN_train$hit_distance_sc)
#fsKN_train$hit_speed <- as.numeric(fsKN_train$hit_speed)
#fsKN_train$hit_angle <- as.numeric(fsKN_train$hit_angle)
#View(fsKN_train)
fsKN_scaled_data <- scale(fsKN_train[,c(1:5)])
fsKN_scale_values <- attr(fsKN_scaled_data, 'scaled:scale')
fsKN_scale_values
fsKN_center_values <- attr(fsKN_scaled_data, 'scaled:center')
fsKN_center_values
fsKN_train <- cbind(fsKN_scaled_data, select(fsKN_train, hit:row))

# save levels for factor variables
fsKN_levels_home_team <- levels(fsKN_train$home_team)
fsKN_levels_stand <- levels(fsKN_train$stand)
fsKN_levels_fieldingTeam <- levels(fsKN_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(fsKN_test)

fsKN_test$hit_distance_sc <- (fsKN_test$hit_distance_sc - fsKN_center_values[1]) / fsKN_scale_values[1]

fsKN_test$hit_speed <- (fsKN_test$hit_speed - fsKN_center_values[2]) / fsKN_scale_values[2]

fsKN_test$hit_angle <- (fsKN_test$hit_angle - fsKN_center_values[3]) / fsKN_scale_values[3]

fsKN_test$hc_x <- (fsKN_test$hc_x - fsKN_center_values[4]) / fsKN_scale_values[4]

fsKN_test$hc_y <- (fsKN_test$hc_y - fsKN_center_values[5]) / fsKN_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

fsKN_validate$hit_distance_sc <- (fsKN_validate$hit_distance_sc - fsKN_center_values[1]) / fsKN_scale_values[1]

fsKN_validate$hit_speed <- (fsKN_validate$hit_speed - fsKN_center_values[2]) / fsKN_scale_values[2]

fsKN_validate$hit_angle <- (fsKN_validate$hit_angle - fsKN_center_values[3]) / fsKN_scale_values[3]

fsKN_validate$hc_x <- (fsKN_validate$hc_x - fsKN_center_values[4]) / fsKN_scale_values[4]

fsKN_validate$hc_y <- (fsKN_validate$hc_y - fsKN_center_values[5]) / fsKN_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(fsKN_train)

set.seed(42)
fsKN_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(fsKN_train, -row), ntree = 501, importance = TRUE)

print(fsKN_rf.1)

plot(fsKN_rf.1)

varImpPlot(fsKN_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
fsKN_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(fsKN_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(fsKN_rf.5)

plot(fsKN_rf.5)

varImpPlot(fsKN_rf.5)

fsKN_predict_fit.rf.5 <- data.frame(fits = predict(fsKN_rf.5, fsKN_test, type = "prob")[,2], actuals = fsKN_test$hit)

fsKN_pred.rf.5 <- prediction(fsKN_predict_fit.rf.5$fits, fsKN_predict_fit.rf.5$actuals)

fsKN_roc.pred.rf.5 <- performance(fsKN_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(fsKN_roc.pred.rf.5)
abline(a = 0, b = 1)
fsKN_opt <- opt.cut(fsKN_roc.pred.rf.5, fsKN_pred.rf.5)
fsKN_opt
fsKN_opt <- fsKN_opt[3]
fsKN_predict_fit.rf.5$fits <- with(fsKN_predict_fit.rf.5, ifelse(fits > fsKN_opt, 1, 0)) 

str(fsKN_test)

#fsKN_test$fieldingTeam <- as.character(fsKN_test$fieldingTeam)
#fsKN_test$home_team <- as.character(fsKN_test$home_team)
#fsKN_test$hit <- as.logical(fsKN_test$hit)
#fsKN_test$stand <- as.logical(fsKN_test$stand)
str(fsKN_test)
fsKN_rf.5_confusion_test <- confusionMatrix(model = fsKN_rf.5, x = fsKN_test, y = fsKN_test$hit)
fsKN_rf.5_confusion_validate <- confusionMatrix(model = fsKN_rf.5, x = fsKN_validate, y = fsKN_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


fsKN_test_rows <- fsKN_test$row
fsKN_validate_rows <- fsKN_validate$row
fsKN_pred_data_emp_1 <- ungroup(fsKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsKN_test_rows)

fsKN_pred_data_emp <- ungroup(fsKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsKN_validate_rows) %>%
	rbind(fsKN_pred_data_emp_1)

fsKN_out_of_training_rows <- fsKN_pred_data_emp$row

fsKN_rf.5_full_out_of_sample_data <- ungroup(fsKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsKN_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



fsKN_rf.5_full_out_of_sample_data_scaled <- fsKN_rf.5_full_out_of_sample_data

fsKN_rf.5_full_out_of_sample_data_scaled$hit_speed <- (fsKN_rf.5_full_out_of_sample_data_scaled$hit_speed - fsKN_center_values[2]) / fsKN_scale_values[2]

fsKN_rf.5_full_out_of_sample_data_scaled$hit_angle <- (fsKN_rf.5_full_out_of_sample_data_scaled$hit_angle - fsKN_center_values[3]) / fsKN_scale_values[3]

fsKN_rf.5.prob <- predict(fsKN_rf.5, fsKN_rf.5_full_out_of_sample_data_scaled, type = "response")

fsKN_rf.5_full_out_of_sample_data <- cbind(filter(fsKN_rf.5_full_out_of_sample_data, row %in% fsKN_out_of_training_rows), fsKN_rf.5.prob)

names(fsKN_rf.5_full_out_of_sample_data)[65] <- "fits"
names(fsKN_rf.5_full_out_of_sample_data)

fsKN_rf.5_full_out_of_sample_data_reduced <- fsKN_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

fsKN_rf.5_mean_table <- fsKN_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

fsKN_rf.5_full_out_of_sample_data$type <- with(fsKN_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

fsKN_rf.5_full_out_of_sample_data$hit_label <- with(fsKN_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

fsKN_rf.5_plot1 <- ggplot(fsKN_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsKN_rf.5_plot1

fsKN_rf.5_plot2 <- ggplot(fsKN_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsKN_rf.5_plot2

fsKN_rf.5_plot3 <- ggplot(fsKN_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsKN_rf.5_plot3

fsKN_grid_plot_rf.5 <- grid.arrange(fsKN_rf.5_plot1, fsKN_rf.5_plot2, fsKN_rf.5_plot3, ncol = 3)
fsKN_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

fsKN_test_rows <- fsKN_test$row
fsKN_validate_rows <- fsKN_validate$row
fsKN_pred_data_emp_1 <- ungroup(fsKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsKN_test_rows)

fsKN_pred_data_emp <- ungroup(fsKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsKN_validate_rows) %>%
	rbind(fsKN_pred_data_emp_1)

fsKN_out_of_training_rows <- fsKN_pred_data_emp$row

fsKN_pred_data_emp <- ungroup(fsKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsKN_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

fsKN_pred_data_emp_scaled <- fsKN_pred_data_emp

fsKN_pred_data_emp_scaled$hit_speed <- (fsKN_pred_data_emp_scaled$hit_speed - fsKN_center_values[2]) / fsKN_scale_values[2]

fsKN_pred_data_emp_scaled$hit_angle <- (fsKN_pred_data_emp_scaled$hit_angle - fsKN_center_values[3]) / fsKN_scale_values[3]

fsKN_pred_prob_hit <- predict(fsKN_rf.5, fsKN_pred_data_emp_scaled, type = "prob")[,2]
fsKN_pred_prob_hit_fits <- cbind(fsKN_pred_data_emp, fsKN_pred_prob_hit)

fsKN_pred_prob_hit_fits[,c(1:2)] <- fsKN_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

fsKN_angle_speed_pred <- fsKN_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = fsKN_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFS-KN Hit Probability\n") + theme_bp_grey()

fsKN_angle_speed_pred
#####
fcKN$hit_distance_sc <- as.numeric(fcKN$hit_distance_sc, na.rm = TRUE)
fcKN$hit_angle <- as.numeric(fcKN$hit_angle, na.rm = TRUE)
fcKN$hit_speed <- as.numeric(fcKN$hit_speed, na.rm = TRUE)

fcKN$hit <- with(fcKN, ifelse(grepl("Single", fcKN$events), 1,
															ifelse(grepl("Double", fcKN$events), 1,
																		 ifelse(grepl("Triple", fcKN$events), 1, 
																		 			 ifelse(grepl("Home Run", fcKN$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

fcKN$fieldingTeam <- with(fcKN, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[fcKN$hit_distance_sc == "null"] = NA
#fcKN$hit_speed[fcKN$hit_speed == "null"] = NA
#fcKN$hit_angle[fcKN$hit_angle == "null"] = NA

# include row names for unique record identification

fcKN$row <- row.names(fcKN) %>% as.numeric()

# recode stand and home_team as factors

fcKN$stand <- as.factor(fcKN$stand)
fcKN$home_team <- as.factor(fcKN$home_team)


fcKN$game_date <- as.Date(fcKN$game_date)


# subset 

fcKN_working_data <- ungroup(fcKN) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(fcKN_working_data)
str(ungroup(fcKN))
table(fcKN_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

fcKN_working_data <- filter(fcKN_working_data, hc_x != 1, hc_y != 1)
head(fcKN_working_data)

# create training and test sets
# scaled data

set.seed(42)
fcKN_train <- sample_frac(fcKN_working_data, .15, replace = FALSE)
fcKN_split <- setdiff(fcKN_working_data, fcKN_train)
fcKN_test <- sample_frac(fcKN_split, .50, replace = FALSE)
fcKN_validate <- setdiff(fcKN_split, fcKN_test)

nrow(fcKN_train) + nrow(fcKN_test) + nrow(fcKN_validate) == nrow(fcKN_working_data)

with(fcKN_train, table(hit)) %>% prop.table()
with(fcKN_test, table(hit)) %>% prop.table()
with(fcKN_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(fcKN)
##as.numeric(fcKN$hit_distance_sc, fcKN$hit_speed, fcKN$hit_angle)

#fcKN_train$hit_distance_sc <- as.numeric(fcKN_train$hit_distance_sc)
#fcKN_train$hit_speed <- as.numeric(fcKN_train$hit_speed)
#fcKN_train$hit_angle <- as.numeric(fcKN_train$hit_angle)
#View(fcKN_train)
fcKN_scaled_data <- scale(fcKN_train[,c(1:5)])
fcKN_scale_values <- attr(fcKN_scaled_data, 'scaled:scale')
fcKN_scale_values
fcKN_center_values <- attr(fcKN_scaled_data, 'scaled:center')
fcKN_center_values
fcKN_train <- cbind(fcKN_scaled_data, select(fcKN_train, hit:row))

# save levels for factor variables
fcKN_levels_home_team <- levels(fcKN_train$home_team)
fcKN_levels_stand <- levels(fcKN_train$stand)
fcKN_levels_fieldingTeam <- levels(fcKN_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(fcKN_test)

fcKN_test$hit_distance_sc <- (fcKN_test$hit_distance_sc - fcKN_center_values[1]) / fcKN_scale_values[1]

fcKN_test$hit_speed <- (fcKN_test$hit_speed - fcKN_center_values[2]) / fcKN_scale_values[2]

fcKN_test$hit_angle <- (fcKN_test$hit_angle - fcKN_center_values[3]) / fcKN_scale_values[3]

fcKN_test$hc_x <- (fcKN_test$hc_x - fcKN_center_values[4]) / fcKN_scale_values[4]

fcKN_test$hc_y <- (fcKN_test$hc_y - fcKN_center_values[5]) / fcKN_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

fcKN_validate$hit_distance_sc <- (fcKN_validate$hit_distance_sc - fcKN_center_values[1]) / fcKN_scale_values[1]

fcKN_validate$hit_speed <- (fcKN_validate$hit_speed - fcKN_center_values[2]) / fcKN_scale_values[2]

fcKN_validate$hit_angle <- (fcKN_validate$hit_angle - fcKN_center_values[3]) / fcKN_scale_values[3]

fcKN_validate$hc_x <- (fcKN_validate$hc_x - fcKN_center_values[4]) / fcKN_scale_values[4]

fcKN_validate$hc_y <- (fcKN_validate$hc_y - fcKN_center_values[5]) / fcKN_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(fcKN_train)

set.seed(42)
fcKN_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(fcKN_train, -row), ntree = 501, importance = TRUE)

print(fcKN_rf.1)

plot(fcKN_rf.1)

varImpPlot(fcKN_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
fcKN_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(fcKN_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(fcKN_rf.5)

plot(fcKN_rf.5)

varImpPlot(fcKN_rf.5)

fcKN_predict_fit.rf.5 <- data.frame(fits = predict(fcKN_rf.5, fcKN_test, type = "prob")[,2], actuals = fcKN_test$hit)

fcKN_pred.rf.5 <- prediction(fcKN_predict_fit.rf.5$fits, fcKN_predict_fit.rf.5$actuals)

fcKN_roc.pred.rf.5 <- performance(fcKN_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(fcKN_roc.pred.rf.5)
abline(a = 0, b = 1)
fcKN_opt <- opt.cut(fcKN_roc.pred.rf.5, fcKN_pred.rf.5)
fcKN_opt
fcKN_opt <- fcKN_opt[3]
fcKN_predict_fit.rf.5$fits <- with(fcKN_predict_fit.rf.5, ifelse(fits > fcKN_opt, 1, 0)) 

str(fcKN_test)

#fcKN_test$fieldingTeam <- as.character(fcKN_test$fieldingTeam)
#fcKN_test$home_team <- as.character(fcKN_test$home_team)
#fcKN_test$hit <- as.logical(fcKN_test$hit)
#fcKN_test$stand <- as.logical(fcKN_test$stand)
str(fcKN_test)
fcKN_rf.5_confusion_test <- confusionMatrix(model = fcKN_rf.5, x = fcKN_test, y = fcKN_test$hit)
fcKN_rf.5_confusion_validate <- confusionMatrix(model = fcKN_rf.5, x = fcKN_validate, y = fcKN_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


fcKN_test_rows <- fcKN_test$row
fcKN_validate_rows <- fcKN_validate$row
fcKN_pred_data_emp_1 <- ungroup(fcKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcKN_test_rows)

fcKN_pred_data_emp <- ungroup(fcKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcKN_validate_rows) %>%
	rbind(fcKN_pred_data_emp_1)

fcKN_out_of_training_rows <- fcKN_pred_data_emp$row

fcKN_rf.5_full_out_of_sample_data <- ungroup(fcKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcKN_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



fcKN_rf.5_full_out_of_sample_data_scaled <- fcKN_rf.5_full_out_of_sample_data

fcKN_rf.5_full_out_of_sample_data_scaled$hit_speed <- (fcKN_rf.5_full_out_of_sample_data_scaled$hit_speed - fcKN_center_values[2]) / fcKN_scale_values[2]

fcKN_rf.5_full_out_of_sample_data_scaled$hit_angle <- (fcKN_rf.5_full_out_of_sample_data_scaled$hit_angle - fcKN_center_values[3]) / fcKN_scale_values[3]

fcKN_rf.5.prob <- predict(fcKN_rf.5, fcKN_rf.5_full_out_of_sample_data_scaled, type = "response")

fcKN_rf.5_full_out_of_sample_data <- cbind(filter(fcKN_rf.5_full_out_of_sample_data, row %in% fcKN_out_of_training_rows), fcKN_rf.5.prob)

names(fcKN_rf.5_full_out_of_sample_data)[65] <- "fits"
names(fcKN_rf.5_full_out_of_sample_data)

fcKN_rf.5_full_out_of_sample_data_reduced <- fcKN_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

fcKN_rf.5_mean_table <- fcKN_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

fcKN_rf.5_full_out_of_sample_data$type <- with(fcKN_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

fcKN_rf.5_full_out_of_sample_data$hit_label <- with(fcKN_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

fcKN_rf.5_plot1 <- ggplot(fcKN_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcKN_rf.5_plot1

fcKN_rf.5_plot2 <- ggplot(fcKN_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcKN_rf.5_plot2

fcKN_rf.5_plot3 <- ggplot(fcKN_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcKN_rf.5_plot3

fcKN_grid_plot_rf.5 <- grid.arrange(fcKN_rf.5_plot1, fcKN_rf.5_plot2, fcKN_rf.5_plot3, ncol = 3)
fcKN_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

fcKN_test_rows <- fcKN_test$row
fcKN_validate_rows <- fcKN_validate$row
fcKN_pred_data_emp_1 <- ungroup(fcKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcKN_test_rows)

fcKN_pred_data_emp <- ungroup(fcKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcKN_validate_rows) %>%
	rbind(fcKN_pred_data_emp_1)

fcKN_out_of_training_rows <- fcKN_pred_data_emp$row

fcKN_pred_data_emp <- ungroup(fcKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcKN_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

fcKN_pred_data_emp_scaled <- fcKN_pred_data_emp

fcKN_pred_data_emp_scaled$hit_speed <- (fcKN_pred_data_emp_scaled$hit_speed - fcKN_center_values[2]) / fcKN_scale_values[2]

fcKN_pred_data_emp_scaled$hit_angle <- (fcKN_pred_data_emp_scaled$hit_angle - fcKN_center_values[3]) / fcKN_scale_values[3]

fcKN_pred_prob_hit <- predict(fcKN_rf.5, fcKN_pred_data_emp_scaled, type = "prob")[,2]
fcKN_pred_prob_hit_fits <- cbind(fcKN_pred_data_emp, fcKN_pred_prob_hit)

fcKN_pred_prob_hit_fits[,c(1:2)] <- fcKN_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

fcKN_angle_speed_pred <- fcKN_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = fcKN_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFC-KN Hit Probability\n") + theme_bp_grey()

fcKN_angle_speed_pred
#####
chKN$hit_distance_sc <- as.numeric(chKN$hit_distance_sc, na.rm = TRUE)
chKN$hit_angle <- as.numeric(chKN$hit_angle, na.rm = TRUE)
chKN$hit_speed <- as.numeric(chKN$hit_speed, na.rm = TRUE)

chKN$hit <- with(chKN, ifelse(grepl("Single", chKN$events), 1,
															ifelse(grepl("Double", chKN$events), 1,
																		 ifelse(grepl("Triple", chKN$events), 1, 
																		 			 ifelse(grepl("Home Run", chKN$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

chKN$fieldingTeam <- with(chKN, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[chKN$hit_distance_sc == "null"] = NA
#chKN$hit_speed[chKN$hit_speed == "null"] = NA
#chKN$hit_angle[chKN$hit_angle == "null"] = NA

# include row names for unique record identification

chKN$row <- row.names(chKN) %>% as.numeric()

# recode stand and home_team as factors

chKN$stand <- as.factor(chKN$stand)
chKN$home_team <- as.factor(chKN$home_team)


chKN$game_date <- as.Date(chKN$game_date)


# subset 

chKN_working_data <- ungroup(chKN) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(chKN_working_data)
str(ungroup(chKN))
table(chKN_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

chKN_working_data <- filter(chKN_working_data, hc_x != 1, hc_y != 1)
head(chKN_working_data)

# create training and test sets
# scaled data

set.seed(42)
chKN_train <- sample_frac(chKN_working_data, .15, replace = FALSE)
chKN_split <- setdiff(chKN_working_data, chKN_train)
chKN_test <- sample_frac(chKN_split, .50, replace = FALSE)
chKN_validate <- setdiff(chKN_split, chKN_test)

nrow(chKN_train) + nrow(chKN_test) + nrow(chKN_validate) == nrow(chKN_working_data)

with(chKN_train, table(hit)) %>% prop.table()
with(chKN_test, table(hit)) %>% prop.table()
with(chKN_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(chKN)
##as.numeric(chKN$hit_distance_sc, chKN$hit_speed, chKN$hit_angle)

#chKN_train$hit_distance_sc <- as.numeric(chKN_train$hit_distance_sc)
#chKN_train$hit_speed <- as.numeric(chKN_train$hit_speed)
#chKN_train$hit_angle <- as.numeric(chKN_train$hit_angle)
#View(chKN_train)
chKN_scaled_data <- scale(chKN_train[,c(1:5)])
chKN_scale_values <- attr(chKN_scaled_data, 'scaled:scale')
chKN_scale_values
chKN_center_values <- attr(chKN_scaled_data, 'scaled:center')
chKN_center_values
chKN_train <- cbind(chKN_scaled_data, select(chKN_train, hit:row))

# save levels for factor variables
chKN_levels_home_team <- levels(chKN_train$home_team)
chKN_levels_stand <- levels(chKN_train$stand)
chKN_levels_fieldingTeam <- levels(chKN_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(chKN_test)

chKN_test$hit_distance_sc <- (chKN_test$hit_distance_sc - chKN_center_values[1]) / chKN_scale_values[1]

chKN_test$hit_speed <- (chKN_test$hit_speed - chKN_center_values[2]) / chKN_scale_values[2]

chKN_test$hit_angle <- (chKN_test$hit_angle - chKN_center_values[3]) / chKN_scale_values[3]

chKN_test$hc_x <- (chKN_test$hc_x - chKN_center_values[4]) / chKN_scale_values[4]

chKN_test$hc_y <- (chKN_test$hc_y - chKN_center_values[5]) / chKN_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

chKN_validate$hit_distance_sc <- (chKN_validate$hit_distance_sc - chKN_center_values[1]) / chKN_scale_values[1]

chKN_validate$hit_speed <- (chKN_validate$hit_speed - chKN_center_values[2]) / chKN_scale_values[2]

chKN_validate$hit_angle <- (chKN_validate$hit_angle - chKN_center_values[3]) / chKN_scale_values[3]

chKN_validate$hc_x <- (chKN_validate$hc_x - chKN_center_values[4]) / chKN_scale_values[4]

chKN_validate$hc_y <- (chKN_validate$hc_y - chKN_center_values[5]) / chKN_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(chKN_train)

set.seed(42)
chKN_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(chKN_train, -row), ntree = 501, importance = TRUE)

print(chKN_rf.1)

plot(chKN_rf.1)

varImpPlot(chKN_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
chKN_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(chKN_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(chKN_rf.5)

plot(chKN_rf.5)

varImpPlot(chKN_rf.5)

chKN_predict_fit.rf.5 <- data.frame(fits = predict(chKN_rf.5, chKN_test, type = "prob")[,2], actuals = chKN_test$hit)

chKN_pred.rf.5 <- prediction(chKN_predict_fit.rf.5$fits, chKN_predict_fit.rf.5$actuals)

chKN_roc.pred.rf.5 <- performance(chKN_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(chKN_roc.pred.rf.5)
abline(a = 0, b = 1)
chKN_opt <- opt.cut(chKN_roc.pred.rf.5, chKN_pred.rf.5)
chKN_opt
chKN_opt <- chKN_opt[3]
chKN_predict_fit.rf.5$fits <- with(chKN_predict_fit.rf.5, ifelse(fits > chKN_opt, 1, 0)) 

str(chKN_test)

#chKN_test$fieldingTeam <- as.character(chKN_test$fieldingTeam)
#chKN_test$home_team <- as.character(chKN_test$home_team)
#chKN_test$hit <- as.logical(chKN_test$hit)
#chKN_test$stand <- as.logical(chKN_test$stand)
str(chKN_test)
chKN_rf.5_confusion_test <- confusionMatrix(model = chKN_rf.5, x = chKN_test, y = chKN_test$hit)
chKN_rf.5_confusion_validate <- confusionMatrix(model = chKN_rf.5, x = chKN_validate, y = chKN_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


chKN_test_rows <- chKN_test$row
chKN_validate_rows <- chKN_validate$row
chKN_pred_data_emp_1 <- ungroup(chKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chKN_test_rows)

chKN_pred_data_emp <- ungroup(chKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chKN_validate_rows) %>%
	rbind(chKN_pred_data_emp_1)

chKN_out_of_training_rows <- chKN_pred_data_emp$row

chKN_rf.5_full_out_of_sample_data <- ungroup(chKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chKN_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



chKN_rf.5_full_out_of_sample_data_scaled <- chKN_rf.5_full_out_of_sample_data

chKN_rf.5_full_out_of_sample_data_scaled$hit_speed <- (chKN_rf.5_full_out_of_sample_data_scaled$hit_speed - chKN_center_values[2]) / chKN_scale_values[2]

chKN_rf.5_full_out_of_sample_data_scaled$hit_angle <- (chKN_rf.5_full_out_of_sample_data_scaled$hit_angle - chKN_center_values[3]) / chKN_scale_values[3]

chKN_rf.5.prob <- predict(chKN_rf.5, chKN_rf.5_full_out_of_sample_data_scaled, type = "response")

chKN_rf.5_full_out_of_sample_data <- cbind(filter(chKN_rf.5_full_out_of_sample_data, row %in% chKN_out_of_training_rows), chKN_rf.5.prob)

names(chKN_rf.5_full_out_of_sample_data)[65] <- "fits"
names(chKN_rf.5_full_out_of_sample_data)

chKN_rf.5_full_out_of_sample_data_reduced <- chKN_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

chKN_rf.5_mean_table <- chKN_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

chKN_rf.5_full_out_of_sample_data$type <- with(chKN_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

chKN_rf.5_full_out_of_sample_data$hit_label <- with(chKN_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

chKN_rf.5_plot1 <- ggplot(chKN_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chKN_rf.5_plot1

chKN_rf.5_plot2 <- ggplot(chKN_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chKN_rf.5_plot2

chKN_rf.5_plot3 <- ggplot(chKN_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chKN_rf.5_plot3

chKN_grid_plot_rf.5 <- grid.arrange(chKN_rf.5_plot1, chKN_rf.5_plot2, chKN_rf.5_plot3, ncol = 3)
chKN_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

chKN_test_rows <- chKN_test$row
chKN_validate_rows <- chKN_validate$row
chKN_pred_data_emp_1 <- ungroup(chKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chKN_test_rows)

chKN_pred_data_emp <- ungroup(chKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chKN_validate_rows) %>%
	rbind(chKN_pred_data_emp_1)

chKN_out_of_training_rows <- chKN_pred_data_emp$row

chKN_pred_data_emp <- ungroup(chKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chKN_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

chKN_pred_data_emp_scaled <- chKN_pred_data_emp

chKN_pred_data_emp_scaled$hit_speed <- (chKN_pred_data_emp_scaled$hit_speed - chKN_center_values[2]) / chKN_scale_values[2]

chKN_pred_data_emp_scaled$hit_angle <- (chKN_pred_data_emp_scaled$hit_angle - chKN_center_values[3]) / chKN_scale_values[3]

chKN_pred_prob_hit <- predict(chKN_rf.5, chKN_pred_data_emp_scaled, type = "prob")[,2]
chKN_pred_prob_hit_fits <- cbind(chKN_pred_data_emp, chKN_pred_prob_hit)

chKN_pred_prob_hit_fits[,c(1:2)] <- chKN_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

chKN_angle_speed_pred <- chKN_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = chKN_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nCH-KN Hit Probability\n") + theme_bp_grey()

chKN_angle_speed_pred
#####
ftKN$hit_distance_sc <- as.numeric(ftKN$hit_distance_sc, na.rm = TRUE)
ftKN$hit_angle <- as.numeric(ftKN$hit_angle, na.rm = TRUE)
ftKN$hit_speed <- as.numeric(ftKN$hit_speed, na.rm = TRUE)

ftKN$hit <- with(ftKN, ifelse(grepl("Single", ftKN$events), 1,
															ifelse(grepl("Double", ftKN$events), 1,
																		 ifelse(grepl("Triple", ftKN$events), 1, 
																		 			 ifelse(grepl("Home Run", ftKN$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

ftKN$fieldingTeam <- with(ftKN, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[ftKN$hit_distance_sc == "null"] = NA
#ftKN$hit_speed[ftKN$hit_speed == "null"] = NA
#ftKN$hit_angle[ftKN$hit_angle == "null"] = NA

# include row names for unique record identification

ftKN$row <- row.names(ftKN) %>% as.numeric()

# recode stand and home_team as factors

ftKN$stand <- as.factor(ftKN$stand)
ftKN$home_team <- as.factor(ftKN$home_team)


ftKN$game_date <- as.Date(ftKN$game_date)


# subset 

ftKN_working_data <- ungroup(ftKN) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(ftKN_working_data)
str(ungroup(ftKN))
table(ftKN_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

ftKN_working_data <- filter(ftKN_working_data, hc_x != 1, hc_y != 1)
head(ftKN_working_data)

# create training and test sets
# scaled data

set.seed(42)
ftKN_train <- sample_frac(ftKN_working_data, .15, replace = FALSE)
ftKN_split <- setdiff(ftKN_working_data, ftKN_train)
ftKN_test <- sample_frac(ftKN_split, .50, replace = FALSE)
ftKN_validate <- setdiff(ftKN_split, ftKN_test)

nrow(ftKN_train) + nrow(ftKN_test) + nrow(ftKN_validate) == nrow(ftKN_working_data)

with(ftKN_train, table(hit)) %>% prop.table()
with(ftKN_test, table(hit)) %>% prop.table()
with(ftKN_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(ftKN)
##as.numeric(ftKN$hit_distance_sc, ftKN$hit_speed, ftKN$hit_angle)

#ftKN_train$hit_distance_sc <- as.numeric(ftKN_train$hit_distance_sc)
#ftKN_train$hit_speed <- as.numeric(ftKN_train$hit_speed)
#ftKN_train$hit_angle <- as.numeric(ftKN_train$hit_angle)
#View(ftKN_train)
ftKN_scaled_data <- scale(ftKN_train[,c(1:5)])
ftKN_scale_values <- attr(ftKN_scaled_data, 'scaled:scale')
ftKN_scale_values
ftKN_center_values <- attr(ftKN_scaled_data, 'scaled:center')
ftKN_center_values
ftKN_train <- cbind(ftKN_scaled_data, select(ftKN_train, hit:row))

# save levels for factor variables
ftKN_levels_home_team <- levels(ftKN_train$home_team)
ftKN_levels_stand <- levels(ftKN_train$stand)
ftKN_levels_fieldingTeam <- levels(ftKN_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(ftKN_test)

ftKN_test$hit_distance_sc <- (ftKN_test$hit_distance_sc - ftKN_center_values[1]) / ftKN_scale_values[1]

ftKN_test$hit_speed <- (ftKN_test$hit_speed - ftKN_center_values[2]) / ftKN_scale_values[2]

ftKN_test$hit_angle <- (ftKN_test$hit_angle - ftKN_center_values[3]) / ftKN_scale_values[3]

ftKN_test$hc_x <- (ftKN_test$hc_x - ftKN_center_values[4]) / ftKN_scale_values[4]

ftKN_test$hc_y <- (ftKN_test$hc_y - ftKN_center_values[5]) / ftKN_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

ftKN_validate$hit_distance_sc <- (ftKN_validate$hit_distance_sc - ftKN_center_values[1]) / ftKN_scale_values[1]

ftKN_validate$hit_speed <- (ftKN_validate$hit_speed - ftKN_center_values[2]) / ftKN_scale_values[2]

ftKN_validate$hit_angle <- (ftKN_validate$hit_angle - ftKN_center_values[3]) / ftKN_scale_values[3]

ftKN_validate$hc_x <- (ftKN_validate$hc_x - ftKN_center_values[4]) / ftKN_scale_values[4]

ftKN_validate$hc_y <- (ftKN_validate$hc_y - ftKN_center_values[5]) / ftKN_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(ftKN_train)

set.seed(42)
ftKN_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(ftKN_train, -row), ntree = 501, importance = TRUE)

print(ftKN_rf.1)

plot(ftKN_rf.1)

varImpPlot(ftKN_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
ftKN_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(ftKN_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(ftKN_rf.5)

plot(ftKN_rf.5)

varImpPlot(ftKN_rf.5)

ftKN_predict_fit.rf.5 <- data.frame(fits = predict(ftKN_rf.5, ftKN_test, type = "prob")[,2], actuals = ftKN_test$hit)

ftKN_pred.rf.5 <- prediction(ftKN_predict_fit.rf.5$fits, ftKN_predict_fit.rf.5$actuals)

ftKN_roc.pred.rf.5 <- performance(ftKN_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(ftKN_roc.pred.rf.5)
abline(a = 0, b = 1)
ftKN_opt <- opt.cut(ftKN_roc.pred.rf.5, ftKN_pred.rf.5)
ftKN_opt
ftKN_opt <- ftKN_opt[3]
ftKN_predict_fit.rf.5$fits <- with(ftKN_predict_fit.rf.5, ifelse(fits > ftKN_opt, 1, 0)) 

str(ftKN_test)

#ftKN_test$fieldingTeam <- as.character(ftKN_test$fieldingTeam)
#ftKN_test$home_team <- as.character(ftKN_test$home_team)
#ftKN_test$hit <- as.logical(ftKN_test$hit)
#ftKN_test$stand <- as.logical(ftKN_test$stand)
str(ftKN_test)
ftKN_rf.5_confusion_test <- confusionMatrix(model = ftKN_rf.5, x = ftKN_test, y = ftKN_test$hit)
ftKN_rf.5_confusion_validate <- confusionMatrix(model = ftKN_rf.5, x = ftKN_validate, y = ftKN_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


ftKN_test_rows <- ftKN_test$row
ftKN_validate_rows <- ftKN_validate$row
ftKN_pred_data_emp_1 <- ungroup(ftKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftKN_test_rows)

ftKN_pred_data_emp <- ungroup(ftKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftKN_validate_rows) %>%
	rbind(ftKN_pred_data_emp_1)

ftKN_out_of_training_rows <- ftKN_pred_data_emp$row

ftKN_rf.5_full_out_of_sample_data <- ungroup(ftKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftKN_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



ftKN_rf.5_full_out_of_sample_data_scaled <- ftKN_rf.5_full_out_of_sample_data

ftKN_rf.5_full_out_of_sample_data_scaled$hit_speed <- (ftKN_rf.5_full_out_of_sample_data_scaled$hit_speed - ftKN_center_values[2]) / ftKN_scale_values[2]

ftKN_rf.5_full_out_of_sample_data_scaled$hit_angle <- (ftKN_rf.5_full_out_of_sample_data_scaled$hit_angle - ftKN_center_values[3]) / ftKN_scale_values[3]

ftKN_rf.5.prob <- predict(ftKN_rf.5, ftKN_rf.5_full_out_of_sample_data_scaled, type = "response")

ftKN_rf.5_full_out_of_sample_data <- cbind(filter(ftKN_rf.5_full_out_of_sample_data, row %in% ftKN_out_of_training_rows), ftKN_rf.5.prob)

names(ftKN_rf.5_full_out_of_sample_data)[65] <- "fits"
names(ftKN_rf.5_full_out_of_sample_data)

ftKN_rf.5_full_out_of_sample_data_reduced <- ftKN_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

ftKN_rf.5_mean_table <- ftKN_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

ftKN_rf.5_full_out_of_sample_data$type <- with(ftKN_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

ftKN_rf.5_full_out_of_sample_data$hit_label <- with(ftKN_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

ftKN_rf.5_plot1 <- ggplot(ftKN_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftKN_rf.5_plot1

ftKN_rf.5_plot2 <- ggplot(ftKN_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftKN_rf.5_plot2

ftKN_rf.5_plot3 <- ggplot(ftKN_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftKN_rf.5_plot3

ftKN_grid_plot_rf.5 <- grid.arrange(ftKN_rf.5_plot1, ftKN_rf.5_plot2, ftKN_rf.5_plot3, ncol = 3)
ftKN_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

ftKN_test_rows <- ftKN_test$row
ftKN_validate_rows <- ftKN_validate$row
ftKN_pred_data_emp_1 <- ungroup(ftKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftKN_test_rows)

ftKN_pred_data_emp <- ungroup(ftKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftKN_validate_rows) %>%
	rbind(ftKN_pred_data_emp_1)

ftKN_out_of_training_rows <- ftKN_pred_data_emp$row

ftKN_pred_data_emp <- ungroup(ftKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftKN_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

ftKN_pred_data_emp_scaled <- ftKN_pred_data_emp

ftKN_pred_data_emp_scaled$hit_speed <- (ftKN_pred_data_emp_scaled$hit_speed - ftKN_center_values[2]) / ftKN_scale_values[2]

ftKN_pred_data_emp_scaled$hit_angle <- (ftKN_pred_data_emp_scaled$hit_angle - ftKN_center_values[3]) / ftKN_scale_values[3]

ftKN_pred_prob_hit <- predict(ftKN_rf.5, ftKN_pred_data_emp_scaled, type = "prob")[,2]
ftKN_pred_prob_hit_fits <- cbind(ftKN_pred_data_emp, ftKN_pred_prob_hit)

ftKN_pred_prob_hit_fits[,c(1:2)] <- ftKN_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

ftKN_angle_speed_pred <- ftKN_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = ftKN_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFT-KN Hit Probability\n") + theme_bp_grey()

ftKN_angle_speed_pred
#####
slKN$hit_distance_sc <- as.numeric(slKN$hit_distance_sc, na.rm = TRUE)
slKN$hit_angle <- as.numeric(slKN$hit_angle, na.rm = TRUE)
slKN$hit_speed <- as.numeric(slKN$hit_speed, na.rm = TRUE)

slKN$hit <- with(slKN, ifelse(grepl("Single", slKN$events), 1,
															ifelse(grepl("Double", slKN$events), 1,
																		 ifelse(grepl("Triple", slKN$events), 1, 
																		 			 ifelse(grepl("Home Run", slKN$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

slKN$fieldingTeam <- with(slKN, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[slKN$hit_distance_sc == "null"] = NA
#slKN$hit_speed[slKN$hit_speed == "null"] = NA
#slKN$hit_angle[slKN$hit_angle == "null"] = NA

# include row names for unique record identification

slKN$row <- row.names(slKN) %>% as.numeric()

# recode stand and home_team as factors

slKN$stand <- as.factor(slKN$stand)
slKN$home_team <- as.factor(slKN$home_team)


slKN$game_date <- as.Date(slKN$game_date)


# subset 

slKN_working_data <- ungroup(slKN) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(slKN_working_data)
str(ungroup(slKN))
table(slKN_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

slKN_working_data <- filter(slKN_working_data, hc_x != 1, hc_y != 1)
head(slKN_working_data)

# create training and test sets
# scaled data

set.seed(42)
slKN_train <- sample_frac(slKN_working_data, .15, replace = FALSE)
slKN_split <- setdiff(slKN_working_data, slKN_train)
slKN_test <- sample_frac(slKN_split, .50, replace = FALSE)
slKN_validate <- setdiff(slKN_split, slKN_test)

nrow(slKN_train) + nrow(slKN_test) + nrow(slKN_validate) == nrow(slKN_working_data)

with(slKN_train, table(hit)) %>% prop.table()
with(slKN_test, table(hit)) %>% prop.table()
with(slKN_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(slKN)
##as.numeric(slKN$hit_distance_sc, slKN$hit_speed, slKN$hit_angle)

#slKN_train$hit_distance_sc <- as.numeric(slKN_train$hit_distance_sc)
#slKN_train$hit_speed <- as.numeric(slKN_train$hit_speed)
#slKN_train$hit_angle <- as.numeric(slKN_train$hit_angle)
#View(slKN_train)
slKN_scaled_data <- scale(slKN_train[,c(1:5)])
slKN_scale_values <- attr(slKN_scaled_data, 'scaled:scale')
slKN_scale_values
slKN_center_values <- attr(slKN_scaled_data, 'scaled:center')
slKN_center_values
slKN_train <- cbind(slKN_scaled_data, select(slKN_train, hit:row))

# save levels for factor variables
slKN_levels_home_team <- levels(slKN_train$home_team)
slKN_levels_stand <- levels(slKN_train$stand)
slKN_levels_fieldingTeam <- levels(slKN_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(slKN_test)

slKN_test$hit_distance_sc <- (slKN_test$hit_distance_sc - slKN_center_values[1]) / slKN_scale_values[1]

slKN_test$hit_speed <- (slKN_test$hit_speed - slKN_center_values[2]) / slKN_scale_values[2]

slKN_test$hit_angle <- (slKN_test$hit_angle - slKN_center_values[3]) / slKN_scale_values[3]

slKN_test$hc_x <- (slKN_test$hc_x - slKN_center_values[4]) / slKN_scale_values[4]

slKN_test$hc_y <- (slKN_test$hc_y - slKN_center_values[5]) / slKN_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

slKN_validate$hit_distance_sc <- (slKN_validate$hit_distance_sc - slKN_center_values[1]) / slKN_scale_values[1]

slKN_validate$hit_speed <- (slKN_validate$hit_speed - slKN_center_values[2]) / slKN_scale_values[2]

slKN_validate$hit_angle <- (slKN_validate$hit_angle - slKN_center_values[3]) / slKN_scale_values[3]

slKN_validate$hc_x <- (slKN_validate$hc_x - slKN_center_values[4]) / slKN_scale_values[4]

slKN_validate$hc_y <- (slKN_validate$hc_y - slKN_center_values[5]) / slKN_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(slKN_train)

set.seed(42)
slKN_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(slKN_train, -row), ntree = 501, importance = TRUE)

print(slKN_rf.1)

plot(slKN_rf.1)

varImpPlot(slKN_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
slKN_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(slKN_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(slKN_rf.5)

plot(slKN_rf.5)

varImpPlot(slKN_rf.5)

slKN_predict_fit.rf.5 <- data.frame(fits = predict(slKN_rf.5, slKN_test, type = "prob")[,2], actuals = slKN_test$hit)

slKN_pred.rf.5 <- prediction(slKN_predict_fit.rf.5$fits, slKN_predict_fit.rf.5$actuals)

slKN_roc.pred.rf.5 <- performance(slKN_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(slKN_roc.pred.rf.5)
abline(a = 0, b = 1)
slKN_opt <- opt.cut(slKN_roc.pred.rf.5, slKN_pred.rf.5)
slKN_opt
slKN_opt <- slKN_opt[3]
slKN_predict_fit.rf.5$fits <- with(slKN_predict_fit.rf.5, ifelse(fits > slKN_opt, 1, 0)) 

str(slKN_test)

#slKN_test$fieldingTeam <- as.character(slKN_test$fieldingTeam)
#slKN_test$home_team <- as.character(slKN_test$home_team)
#slKN_test$hit <- as.logical(slKN_test$hit)
#slKN_test$stand <- as.logical(slKN_test$stand)
str(slKN_test)
slKN_rf.5_confusion_test <- confusionMatrix(model = slKN_rf.5, x = slKN_test, y = slKN_test$hit)
slKN_rf.5_confusion_validate <- confusionMatrix(model = slKN_rf.5, x = slKN_validate, y = slKN_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


slKN_test_rows <- slKN_test$row
slKN_validate_rows <- slKN_validate$row
slKN_pred_data_emp_1 <- ungroup(slKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slKN_test_rows)

slKN_pred_data_emp <- ungroup(slKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slKN_validate_rows) %>%
	rbind(slKN_pred_data_emp_1)

slKN_out_of_training_rows <- slKN_pred_data_emp$row

slKN_rf.5_full_out_of_sample_data <- ungroup(slKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slKN_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



slKN_rf.5_full_out_of_sample_data_scaled <- slKN_rf.5_full_out_of_sample_data

slKN_rf.5_full_out_of_sample_data_scaled$hit_speed <- (slKN_rf.5_full_out_of_sample_data_scaled$hit_speed - slKN_center_values[2]) / slKN_scale_values[2]

slKN_rf.5_full_out_of_sample_data_scaled$hit_angle <- (slKN_rf.5_full_out_of_sample_data_scaled$hit_angle - slKN_center_values[3]) / slKN_scale_values[3]

slKN_rf.5.prob <- predict(slKN_rf.5, slKN_rf.5_full_out_of_sample_data_scaled, type = "response")

slKN_rf.5_full_out_of_sample_data <- cbind(filter(slKN_rf.5_full_out_of_sample_data, row %in% slKN_out_of_training_rows), slKN_rf.5.prob)

names(slKN_rf.5_full_out_of_sample_data)[65] <- "fits"
names(slKN_rf.5_full_out_of_sample_data)

slKN_rf.5_full_out_of_sample_data_reduced <- slKN_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

slKN_rf.5_mean_table <- slKN_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

slKN_rf.5_full_out_of_sample_data$type <- with(slKN_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

slKN_rf.5_full_out_of_sample_data$hit_label <- with(slKN_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

slKN_rf.5_plot1 <- ggplot(slKN_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slKN_rf.5_plot1

slKN_rf.5_plot2 <- ggplot(slKN_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slKN_rf.5_plot2

slKN_rf.5_plot3 <- ggplot(slKN_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slKN_rf.5_plot3

slKN_grid_plot_rf.5 <- grid.arrange(slKN_rf.5_plot1, slKN_rf.5_plot2, slKN_rf.5_plot3, ncol = 3)
slKN_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

slKN_test_rows <- slKN_test$row
slKN_validate_rows <- slKN_validate$row
slKN_pred_data_emp_1 <- ungroup(slKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slKN_test_rows)

slKN_pred_data_emp <- ungroup(slKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slKN_validate_rows) %>%
	rbind(slKN_pred_data_emp_1)

slKN_out_of_training_rows <- slKN_pred_data_emp$row

slKN_pred_data_emp <- ungroup(slKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slKN_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

slKN_pred_data_emp_scaled <- slKN_pred_data_emp

slKN_pred_data_emp_scaled$hit_speed <- (slKN_pred_data_emp_scaled$hit_speed - slKN_center_values[2]) / slKN_scale_values[2]

slKN_pred_data_emp_scaled$hit_angle <- (slKN_pred_data_emp_scaled$hit_angle - slKN_center_values[3]) / slKN_scale_values[3]

slKN_pred_prob_hit <- predict(slKN_rf.5, slKN_pred_data_emp_scaled, type = "prob")[,2]
slKN_pred_prob_hit_fits <- cbind(slKN_pred_data_emp, slKN_pred_prob_hit)

slKN_pred_prob_hit_fits[,c(1:2)] <- slKN_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

slKN_angle_speed_pred <- slKN_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = slKN_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nSL-KN Hit Probability\n") + theme_bp_grey()

slKN_angle_speed_pred
#####
cuKN$hit_distance_sc <- as.numeric(cuKN$hit_distance_sc, na.rm = TRUE)
cuKN$hit_angle <- as.numeric(cuKN$hit_angle, na.rm = TRUE)
cuKN$hit_speed <- as.numeric(cuKN$hit_speed, na.rm = TRUE)

cuKN$hit <- with(cuKN, ifelse(grepl("Single", cuKN$events), 1,
															ifelse(grepl("Double", cuKN$events), 1,
																		 ifelse(grepl("Triple", cuKN$events), 1, 
																		 			 ifelse(grepl("Home Run", cuKN$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

cuKN$fieldingTeam <- with(cuKN, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[cuKN$hit_distance_sc == "null"] = NA
#cuKN$hit_speed[cuKN$hit_speed == "null"] = NA
#cuKN$hit_angle[cuKN$hit_angle == "null"] = NA

# include row names for unique record identification

cuKN$row <- row.names(cuKN) %>% as.numeric()

# recode stand and home_team as factors

cuKN$stand <- as.factor(cuKN$stand)
cuKN$home_team <- as.factor(cuKN$home_team)


cuKN$game_date <- as.Date(cuKN$game_date)


# subset 

cuKN_working_data <- ungroup(cuKN) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(cuKN_working_data)
str(ungroup(cuKN))
table(cuKN_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

cuKN_working_data <- filter(cuKN_working_data, hc_x != 1, hc_y != 1)
head(cuKN_working_data)

# create training and test sets
# scaled data

set.seed(42)
cuKN_train <- sample_frac(cuKN_working_data, .15, replace = FALSE)
cuKN_split <- setdiff(cuKN_working_data, cuKN_train)
cuKN_test <- sample_frac(cuKN_split, .50, replace = FALSE)
cuKN_validate <- setdiff(cuKN_split, cuKN_test)

nrow(cuKN_train) + nrow(cuKN_test) + nrow(cuKN_validate) == nrow(cuKN_working_data)

with(cuKN_train, table(hit)) %>% prop.table()
with(cuKN_test, table(hit)) %>% prop.table()
with(cuKN_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(cuKN)
##as.numeric(cuKN$hit_distance_sc, cuKN$hit_speed, cuKN$hit_angle)

#cuKN_train$hit_distance_sc <- as.numeric(cuKN_train$hit_distance_sc)
#cuKN_train$hit_speed <- as.numeric(cuKN_train$hit_speed)
#cuKN_train$hit_angle <- as.numeric(cuKN_train$hit_angle)
#View(cuKN_train)
cuKN_scaled_data <- scale(cuKN_train[,c(1:5)])
cuKN_scale_values <- attr(cuKN_scaled_data, 'scaled:scale')
cuKN_scale_values
cuKN_center_values <- attr(cuKN_scaled_data, 'scaled:center')
cuKN_center_values
cuKN_train <- cbind(cuKN_scaled_data, select(cuKN_train, hit:row))

# save levels for factor variables
cuKN_levels_home_team <- levels(cuKN_train$home_team)
cuKN_levels_stand <- levels(cuKN_train$stand)
cuKN_levels_fieldingTeam <- levels(cuKN_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(cuKN_test)

cuKN_test$hit_distance_sc <- (cuKN_test$hit_distance_sc - cuKN_center_values[1]) / cuKN_scale_values[1]

cuKN_test$hit_speed <- (cuKN_test$hit_speed - cuKN_center_values[2]) / cuKN_scale_values[2]

cuKN_test$hit_angle <- (cuKN_test$hit_angle - cuKN_center_values[3]) / cuKN_scale_values[3]

cuKN_test$hc_x <- (cuKN_test$hc_x - cuKN_center_values[4]) / cuKN_scale_values[4]

cuKN_test$hc_y <- (cuKN_test$hc_y - cuKN_center_values[5]) / cuKN_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

cuKN_validate$hit_distance_sc <- (cuKN_validate$hit_distance_sc - cuKN_center_values[1]) / cuKN_scale_values[1]

cuKN_validate$hit_speed <- (cuKN_validate$hit_speed - cuKN_center_values[2]) / cuKN_scale_values[2]

cuKN_validate$hit_angle <- (cuKN_validate$hit_angle - cuKN_center_values[3]) / cuKN_scale_values[3]

cuKN_validate$hc_x <- (cuKN_validate$hc_x - cuKN_center_values[4]) / cuKN_scale_values[4]

cuKN_validate$hc_y <- (cuKN_validate$hc_y - cuKN_center_values[5]) / cuKN_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(cuKN_train)

set.seed(42)
cuKN_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(cuKN_train, -row), ntree = 501, importance = TRUE)

print(cuKN_rf.1)

plot(cuKN_rf.1)

varImpPlot(cuKN_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
cuKN_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(cuKN_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(cuKN_rf.5)

plot(cuKN_rf.5)

varImpPlot(cuKN_rf.5)

cuKN_predict_fit.rf.5 <- data.frame(fits = predict(cuKN_rf.5, cuKN_test, type = "prob")[,2], actuals = cuKN_test$hit)

cuKN_pred.rf.5 <- prediction(cuKN_predict_fit.rf.5$fits, cuKN_predict_fit.rf.5$actuals)

cuKN_roc.pred.rf.5 <- performance(cuKN_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(cuKN_roc.pred.rf.5)
abline(a = 0, b = 1)
cuKN_opt <- opt.cut(cuKN_roc.pred.rf.5, cuKN_pred.rf.5)
cuKN_opt
cuKN_opt <- cuKN_opt[3]
cuKN_predict_fit.rf.5$fits <- with(cuKN_predict_fit.rf.5, ifelse(fits > cuKN_opt, 1, 0)) 

str(cuKN_test)

#cuKN_test$fieldingTeam <- as.character(cuKN_test$fieldingTeam)
#cuKN_test$home_team <- as.character(cuKN_test$home_team)
#cuKN_test$hit <- as.logical(cuKN_test$hit)
#cuKN_test$stand <- as.logical(cuKN_test$stand)
str(cuKN_test)
cuKN_rf.5_confusion_test <- confusionMatrix(model = cuKN_rf.5, x = cuKN_test, y = cuKN_test$hit)
cuKN_rf.5_confusion_validate <- confusionMatrix(model = cuKN_rf.5, x = cuKN_validate, y = cuKN_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


cuKN_test_rows <- cuKN_test$row
cuKN_validate_rows <- cuKN_validate$row
cuKN_pred_data_emp_1 <- ungroup(cuKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuKN_test_rows)

cuKN_pred_data_emp <- ungroup(cuKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuKN_validate_rows) %>%
	rbind(cuKN_pred_data_emp_1)

cuKN_out_of_training_rows <- cuKN_pred_data_emp$row

cuKN_rf.5_full_out_of_sample_data <- ungroup(cuKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuKN_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



cuKN_rf.5_full_out_of_sample_data_scaled <- cuKN_rf.5_full_out_of_sample_data

cuKN_rf.5_full_out_of_sample_data_scaled$hit_speed <- (cuKN_rf.5_full_out_of_sample_data_scaled$hit_speed - cuKN_center_values[2]) / cuKN_scale_values[2]

cuKN_rf.5_full_out_of_sample_data_scaled$hit_angle <- (cuKN_rf.5_full_out_of_sample_data_scaled$hit_angle - cuKN_center_values[3]) / cuKN_scale_values[3]

cuKN_rf.5.prob <- predict(cuKN_rf.5, cuKN_rf.5_full_out_of_sample_data_scaled, type = "response")

cuKN_rf.5_full_out_of_sample_data <- cbind(filter(cuKN_rf.5_full_out_of_sample_data, row %in% cuKN_out_of_training_rows), cuKN_rf.5.prob)

names(cuKN_rf.5_full_out_of_sample_data)[65] <- "fits"
names(cuKN_rf.5_full_out_of_sample_data)

cuKN_rf.5_full_out_of_sample_data_reduced <- cuKN_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

cuKN_rf.5_mean_table <- cuKN_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

cuKN_rf.5_full_out_of_sample_data$type <- with(cuKN_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

cuKN_rf.5_full_out_of_sample_data$hit_label <- with(cuKN_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

cuKN_rf.5_plot1 <- ggplot(cuKN_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuKN_rf.5_plot1

cuKN_rf.5_plot2 <- ggplot(cuKN_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuKN_rf.5_plot2

cuKN_rf.5_plot3 <- ggplot(cuKN_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuKN_rf.5_plot3

cuKN_grid_plot_rf.5 <- grid.arrange(cuKN_rf.5_plot1, cuKN_rf.5_plot2, cuKN_rf.5_plot3, ncol = 3)
cuKN_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

cuKN_test_rows <- cuKN_test$row
cuKN_validate_rows <- cuKN_validate$row
cuKN_pred_data_emp_1 <- ungroup(cuKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuKN_test_rows)

cuKN_pred_data_emp <- ungroup(cuKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuKN_validate_rows) %>%
	rbind(cuKN_pred_data_emp_1)

cuKN_out_of_training_rows <- cuKN_pred_data_emp$row

cuKN_pred_data_emp <- ungroup(cuKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuKN_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

cuKN_pred_data_emp_scaled <- cuKN_pred_data_emp

cuKN_pred_data_emp_scaled$hit_speed <- (cuKN_pred_data_emp_scaled$hit_speed - cuKN_center_values[2]) / cuKN_scale_values[2]

cuKN_pred_data_emp_scaled$hit_angle <- (cuKN_pred_data_emp_scaled$hit_angle - cuKN_center_values[3]) / cuKN_scale_values[3]

cuKN_pred_prob_hit <- predict(cuKN_rf.5, cuKN_pred_data_emp_scaled, type = "prob")[,2]
cuKN_pred_prob_hit_fits <- cbind(cuKN_pred_data_emp, cuKN_pred_prob_hit)

cuKN_pred_prob_hit_fits[,c(1:2)] <- cuKN_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

cuKN_angle_speed_pred <- cuKN_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = cuKN_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nCU-KN Hit Probability\n") + theme_bp_grey()

cuKN_angle_speed_pred
#####
ffKN$hit_distance_sc <- as.numeric(ffKN$hit_distance_sc, na.rm = TRUE)
ffKN$hit_angle <- as.numeric(ffKN$hit_angle, na.rm = TRUE)
ffKN$hit_speed <- as.numeric(ffKN$hit_speed, na.rm = TRUE)

ffKN$hit <- with(ffKN, ifelse(grepl("Single", ffKN$events), 1,
															ifelse(grepl("Double", ffKN$events), 1,
																		 ifelse(grepl("Triple", ffKN$events), 1, 
																		 			 ifelse(grepl("Home Run", ffKN$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

ffKN$fieldingTeam <- with(ffKN, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[ffKN$hit_distance_sc == "null"] = NA
#ffKN$hit_speed[ffKN$hit_speed == "null"] = NA
#ffKN$hit_angle[ffKN$hit_angle == "null"] = NA

# include row names for unique record identification

ffKN$row <- row.names(ffKN) %>% as.numeric()

# recode stand and home_team as factors

ffKN$stand <- as.factor(ffKN$stand)
ffKN$home_team <- as.factor(ffKN$home_team)


ffKN$game_date <- as.Date(ffKN$game_date)


# subset 

ffKN_working_data <- ungroup(ffKN) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(ffKN_working_data)
str(ungroup(ffKN))
table(ffKN_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

ffKN_working_data <- filter(ffKN_working_data, hc_x != 1, hc_y != 1)
head(ffKN_working_data)

# create training and test sets
# scaled data

set.seed(42)
ffKN_train <- sample_frac(ffKN_working_data, .15, replace = FALSE)
ffKN_split <- setdiff(ffKN_working_data, ffKN_train)
ffKN_test <- sample_frac(ffKN_split, .50, replace = FALSE)
ffKN_validate <- setdiff(ffKN_split, ffKN_test)

nrow(ffKN_train) + nrow(ffKN_test) + nrow(ffKN_validate) == nrow(ffKN_working_data)

with(ffKN_train, table(hit)) %>% prop.table()
with(ffKN_test, table(hit)) %>% prop.table()
with(ffKN_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(ffKN)
##as.numeric(ffKN$hit_distance_sc, ffKN$hit_speed, ffKN$hit_angle)

#ffKN_train$hit_distance_sc <- as.numeric(ffKN_train$hit_distance_sc)
#ffKN_train$hit_speed <- as.numeric(ffKN_train$hit_speed)
#ffKN_train$hit_angle <- as.numeric(ffKN_train$hit_angle)
#View(ffKN_train)
ffKN_scaled_data <- scale(ffKN_train[,c(1:5)])
ffKN_scale_values <- attr(ffKN_scaled_data, 'scaled:scale')
ffKN_scale_values
ffKN_center_values <- attr(ffKN_scaled_data, 'scaled:center')
ffKN_center_values
ffKN_train <- cbind(ffKN_scaled_data, select(ffKN_train, hit:row))

# save levels for factor variables
ffKN_levels_home_team <- levels(ffKN_train$home_team)
ffKN_levels_stand <- levels(ffKN_train$stand)
ffKN_levels_fieldingTeam <- levels(ffKN_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(ffKN_test)

ffKN_test$hit_distance_sc <- (ffKN_test$hit_distance_sc - ffKN_center_values[1]) / ffKN_scale_values[1]

ffKN_test$hit_speed <- (ffKN_test$hit_speed - ffKN_center_values[2]) / ffKN_scale_values[2]

ffKN_test$hit_angle <- (ffKN_test$hit_angle - ffKN_center_values[3]) / ffKN_scale_values[3]

ffKN_test$hc_x <- (ffKN_test$hc_x - ffKN_center_values[4]) / ffKN_scale_values[4]

ffKN_test$hc_y <- (ffKN_test$hc_y - ffKN_center_values[5]) / ffKN_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

ffKN_validate$hit_distance_sc <- (ffKN_validate$hit_distance_sc - ffKN_center_values[1]) / ffKN_scale_values[1]

ffKN_validate$hit_speed <- (ffKN_validate$hit_speed - ffKN_center_values[2]) / ffKN_scale_values[2]

ffKN_validate$hit_angle <- (ffKN_validate$hit_angle - ffKN_center_values[3]) / ffKN_scale_values[3]

ffKN_validate$hc_x <- (ffKN_validate$hc_x - ffKN_center_values[4]) / ffKN_scale_values[4]

ffKN_validate$hc_y <- (ffKN_validate$hc_y - ffKN_center_values[5]) / ffKN_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(ffKN_train)

set.seed(42)
ffKN_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(ffKN_train, -row), ntree = 501, importance = TRUE)

print(ffKN_rf.1)

plot(ffKN_rf.1)

varImpPlot(ffKN_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
ffKN_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(ffKN_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(ffKN_rf.5)

plot(ffKN_rf.5)

varImpPlot(ffKN_rf.5)

ffKN_predict_fit.rf.5 <- data.frame(fits = predict(ffKN_rf.5, ffKN_test, type = "prob")[,2], actuals = ffKN_test$hit)

ffKN_pred.rf.5 <- prediction(ffKN_predict_fit.rf.5$fits, ffKN_predict_fit.rf.5$actuals)

ffKN_roc.pred.rf.5 <- performance(ffKN_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(ffKN_roc.pred.rf.5)
abline(a = 0, b = 1)
ffKN_opt <- opt.cut(ffKN_roc.pred.rf.5, ffKN_pred.rf.5)
ffKN_opt
ffKN_opt <- ffKN_opt[3]
ffKN_predict_fit.rf.5$fits <- with(ffKN_predict_fit.rf.5, ifelse(fits > ffKN_opt, 1, 0)) 

str(ffKN_test)

#ffKN_test$fieldingTeam <- as.character(ffKN_test$fieldingTeam)
#ffKN_test$home_team <- as.character(ffKN_test$home_team)
#ffKN_test$hit <- as.logical(ffKN_test$hit)
#ffKN_test$stand <- as.logical(ffKN_test$stand)
str(ffKN_test)
ffKN_rf.5_confusion_test <- confusionMatrix(model = ffKN_rf.5, x = ffKN_test, y = ffKN_test$hit)
ffKN_rf.5_confusion_validate <- confusionMatrix(model = ffKN_rf.5, x = ffKN_validate, y = ffKN_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


ffKN_test_rows <- ffKN_test$row
ffKN_validate_rows <- ffKN_validate$row
ffKN_pred_data_emp_1 <- ungroup(ffKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffKN_test_rows)

ffKN_pred_data_emp <- ungroup(ffKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffKN_validate_rows) %>%
	rbind(ffKN_pred_data_emp_1)

ffKN_out_of_training_rows <- ffKN_pred_data_emp$row

ffKN_rf.5_full_out_of_sample_data <- ungroup(ffKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffKN_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



ffKN_rf.5_full_out_of_sample_data_scaled <- ffKN_rf.5_full_out_of_sample_data

ffKN_rf.5_full_out_of_sample_data_scaled$hit_speed <- (ffKN_rf.5_full_out_of_sample_data_scaled$hit_speed - ffKN_center_values[2]) / ffKN_scale_values[2]

ffKN_rf.5_full_out_of_sample_data_scaled$hit_angle <- (ffKN_rf.5_full_out_of_sample_data_scaled$hit_angle - ffKN_center_values[3]) / ffKN_scale_values[3]

ffKN_rf.5.prob <- predict(ffKN_rf.5, ffKN_rf.5_full_out_of_sample_data_scaled, type = "response")

ffKN_rf.5_full_out_of_sample_data <- cbind(filter(ffKN_rf.5_full_out_of_sample_data, row %in% ffKN_out_of_training_rows), ffKN_rf.5.prob)

names(ffKN_rf.5_full_out_of_sample_data)[65] <- "fits"
names(ffKN_rf.5_full_out_of_sample_data)

ffKN_rf.5_full_out_of_sample_data_reduced <- ffKN_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

ffKN_rf.5_mean_table <- ffKN_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

ffKN_rf.5_full_out_of_sample_data$type <- with(ffKN_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

ffKN_rf.5_full_out_of_sample_data$hit_label <- with(ffKN_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

ffKN_rf.5_plot1 <- ggplot(ffKN_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffKN_rf.5_plot1

ffKN_rf.5_plot2 <- ggplot(ffKN_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffKN_rf.5_plot2

ffKN_rf.5_plot3 <- ggplot(ffKN_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffKN_rf.5_plot3

ffKN_grid_plot_rf.5 <- grid.arrange(ffKN_rf.5_plot1, ffKN_rf.5_plot2, ffKN_rf.5_plot3, ncol = 3)
ffKN_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

ffKN_test_rows <- ffKN_test$row
ffKN_validate_rows <- ffKN_validate$row
ffKN_pred_data_emp_1 <- ungroup(ffKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffKN_test_rows)

ffKN_pred_data_emp <- ungroup(ffKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffKN_validate_rows) %>%
	rbind(ffKN_pred_data_emp_1)

ffKN_out_of_training_rows <- ffKN_pred_data_emp$row

ffKN_pred_data_emp <- ungroup(ffKN) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffKN_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

ffKN_pred_data_emp_scaled <- ffKN_pred_data_emp

ffKN_pred_data_emp_scaled$hit_speed <- (ffKN_pred_data_emp_scaled$hit_speed - ffKN_center_values[2]) / ffKN_scale_values[2]

ffKN_pred_data_emp_scaled$hit_angle <- (ffKN_pred_data_emp_scaled$hit_angle - ffKN_center_values[3]) / ffKN_scale_values[3]

ffKN_pred_prob_hit <- predict(ffKN_rf.5, ffKN_pred_data_emp_scaled, type = "prob")[,2]
ffKN_pred_prob_hit_fits <- cbind(ffKN_pred_data_emp, ffKN_pred_prob_hit)

ffKN_pred_prob_hit_fits[,c(1:2)] <- ffKN_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

ffKN_angle_speed_pred <- ffKN_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = ffKN_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFF-KN Hit Probability\n") + theme_bp_grey()

ffKN_angle_speed_pred
############# End Knuckleballs; Start Sinkers

########################## Start Sinkers
#####
knSI$hit_distance_sc <- as.numeric(knSI$hit_distance_sc, na.rm = TRUE)
knSI$hit_angle <- as.numeric(knSI$hit_angle, na.rm = TRUE)
knSI$hit_speed <- as.numeric(knSI$hit_speed, na.rm = TRUE)

knSI$hit <- with(knSI, ifelse(grepl("Single", knSI$events), 1,
															ifelse(grepl("Double", knSI$events), 1,
																		 ifelse(grepl("Triple", knSI$events), 1, 
																		 			 ifelse(grepl("Home Run", knSI$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

knSI$fieldingTeam <- with(knSI, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[knSI$hit_distance_sc == "null"] = NA
#knSI$hit_speed[knSI$hit_speed == "null"] = NA
#knSI$hit_angle[knSI$hit_angle == "null"] = NA

# include row names for unique record identification

knSI$row <- row.names(knSI) %>% as.numeric()

# recode stand and home_team as factors

knSI$stand <- as.factor(knSI$stand)
knSI$home_team <- as.factor(knSI$home_team)


knSI$game_date <- as.Date(knSI$game_date)


# subset 

knSI_working_data <- ungroup(knSI) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(knSI_working_data)
str(ungroup(knSI))
table(knSI_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

knSI_working_data <- filter(knSI_working_data, hc_x != 1, hc_y != 1)
head(knSI_working_data)

# create training and test sets
# scaled data

set.seed(42)
knSI_train <- sample_frac(knSI_working_data, .15, replace = FALSE)
knSI_split <- setdiff(knSI_working_data, knSI_train)
knSI_test <- sample_frac(knSI_split, .50, replace = FALSE)
knSI_validate <- setdiff(knSI_split, knSI_test)

nrow(knSI_train) + nrow(knSI_test) + nrow(knSI_validate) == nrow(knSI_working_data)

with(knSI_train, table(hit)) %>% prop.table()
with(knSI_test, table(hit)) %>% prop.table()
with(knSI_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(knSI)
##as.numeric(knSI$hit_distance_sc, knSI$hit_speed, knSI$hit_angle)

#knSI_train$hit_distance_sc <- as.numeric(knSI_train$hit_distance_sc)
#knSI_train$hit_speed <- as.numeric(knSI_train$hit_speed)
#knSI_train$hit_angle <- as.numeric(knSI_train$hit_angle)
#View(knSI_train)
knSI_scaled_data <- scale(knSI_train[,c(1:5)])
knSI_scale_values <- attr(knSI_scaled_data, 'scaled:scale')
knSI_scale_values
knSI_center_values <- attr(knSI_scaled_data, 'scaled:center')
knSI_center_values
knSI_train <- cbind(knSI_scaled_data, select(knSI_train, hit:row))

# save levels for factor variables
knSI_levels_home_team <- levels(knSI_train$home_team)
knSI_levels_stand <- levels(knSI_train$stand)
knSI_levels_fieldingTeam <- levels(knSI_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(knSI_test)

knSI_test$hit_distance_sc <- (knSI_test$hit_distance_sc - knSI_center_values[1]) / knSI_scale_values[1]

knSI_test$hit_speed <- (knSI_test$hit_speed - knSI_center_values[2]) / knSI_scale_values[2]

knSI_test$hit_angle <- (knSI_test$hit_angle - knSI_center_values[3]) / knSI_scale_values[3]

knSI_test$hc_x <- (knSI_test$hc_x - knSI_center_values[4]) / knSI_scale_values[4]

knSI_test$hc_y <- (knSI_test$hc_y - knSI_center_values[5]) / knSI_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

knSI_validate$hit_distance_sc <- (knSI_validate$hit_distance_sc - knSI_center_values[1]) / knSI_scale_values[1]

knSI_validate$hit_speed <- (knSI_validate$hit_speed - knSI_center_values[2]) / knSI_scale_values[2]

knSI_validate$hit_angle <- (knSI_validate$hit_angle - knSI_center_values[3]) / knSI_scale_values[3]

knSI_validate$hc_x <- (knSI_validate$hc_x - knSI_center_values[4]) / knSI_scale_values[4]

knSI_validate$hc_y <- (knSI_validate$hc_y - knSI_center_values[5]) / knSI_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(knSI_train)

set.seed(42)
knSI_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(knSI_train, -row), ntree = 501, importance = TRUE)

print(knSI_rf.1)

plot(knSI_rf.1)

varImpPlot(knSI_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
knSI_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(knSI_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(knSI_rf.5)

plot(knSI_rf.5)

varImpPlot(knSI_rf.5)

knSI_predict_fit.rf.5 <- data.frame(fits = predict(knSI_rf.5, knSI_test, type = "prob")[,2], actuals = knSI_test$hit)

knSI_pred.rf.5 <- prediction(knSI_predict_fit.rf.5$fits, knSI_predict_fit.rf.5$actuals)

knSI_roc.pred.rf.5 <- performance(knSI_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(knSI_roc.pred.rf.5)
abline(a = 0, b = 1)
knSI_opt <- opt.cut(knSI_roc.pred.rf.5, knSI_pred.rf.5)
knSI_opt
knSI_opt <- knSI_opt[3]
knSI_predict_fit.rf.5$fits <- with(knSI_predict_fit.rf.5, ifelse(fits > knSI_opt, 1, 0)) 

str(knSI_test)

#knSI_test$fieldingTeam <- as.character(knSI_test$fieldingTeam)
#knSI_test$home_team <- as.character(knSI_test$home_team)
#knSI_test$hit <- as.logical(knSI_test$hit)
#knSI_test$stand <- as.logical(knSI_test$stand)
str(knSI_test)
knSI_rf.5_confusion_test <- confusionMatrix(model = knSI_rf.5, x = knSI_test, y = knSI_test$hit)
knSI_rf.5_confusion_validate <- confusionMatrix(model = knSI_rf.5, x = knSI_validate, y = knSI_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


knSI_test_rows <- knSI_test$row
knSI_validate_rows <- knSI_validate$row
knSI_pred_data_emp_1 <- ungroup(knSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knSI_test_rows)

knSI_pred_data_emp <- ungroup(knSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knSI_validate_rows) %>%
	rbind(knSI_pred_data_emp_1)

knSI_out_of_training_rows <- knSI_pred_data_emp$row

knSI_rf.5_full_out_of_sample_data <- ungroup(knSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knSI_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



knSI_rf.5_full_out_of_sample_data_scaled <- knSI_rf.5_full_out_of_sample_data

knSI_rf.5_full_out_of_sample_data_scaled$hit_speed <- (knSI_rf.5_full_out_of_sample_data_scaled$hit_speed - knSI_center_values[2]) / knSI_scale_values[2]

knSI_rf.5_full_out_of_sample_data_scaled$hit_angle <- (knSI_rf.5_full_out_of_sample_data_scaled$hit_angle - knSI_center_values[3]) / knSI_scale_values[3]

knSI_rf.5.prob <- predict(knSI_rf.5, knSI_rf.5_full_out_of_sample_data_scaled, type = "response")

knSI_rf.5_full_out_of_sample_data <- cbind(filter(knSI_rf.5_full_out_of_sample_data, row %in% knSI_out_of_training_rows), knSI_rf.5.prob)

names(knSI_rf.5_full_out_of_sample_data)[65] <- "fits"
names(knSI_rf.5_full_out_of_sample_data)

knSI_rf.5_full_out_of_sample_data_reduced <- knSI_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

knSI_rf.5_mean_table <- knSI_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

knSI_rf.5_full_out_of_sample_data$type <- with(knSI_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

knSI_rf.5_full_out_of_sample_data$hit_label <- with(knSI_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

knSI_rf.5_plot1 <- ggplot(knSI_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knSI_rf.5_plot1

knSI_rf.5_plot2 <- ggplot(knSI_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knSI_rf.5_plot2

knSI_rf.5_plot3 <- ggplot(knSI_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

knSI_rf.5_plot3

knSI_grid_plot_rf.5 <- grid.arrange(knSI_rf.5_plot1, knSI_rf.5_plot2, knSI_rf.5_plot3, ncol = 3)
knSI_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

knSI_test_rows <- knSI_test$row
knSI_validate_rows <- knSI_validate$row
knSI_pred_data_emp_1 <- ungroup(knSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knSI_test_rows)

knSI_pred_data_emp <- ungroup(knSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knSI_validate_rows) %>%
	rbind(knSI_pred_data_emp_1)

knSI_out_of_training_rows <- knSI_pred_data_emp$row

knSI_pred_data_emp <- ungroup(knSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% knSI_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

knSI_pred_data_emp_scaled <- knSI_pred_data_emp

knSI_pred_data_emp_scaled$hit_speed <- (knSI_pred_data_emp_scaled$hit_speed - knSI_center_values[2]) / knSI_scale_values[2]

knSI_pred_data_emp_scaled$hit_angle <- (knSI_pred_data_emp_scaled$hit_angle - knSI_center_values[3]) / knSI_scale_values[3]

knSI_pred_prob_hit <- predict(knSI_rf.5, knSI_pred_data_emp_scaled, type = "prob")[,2]
knSI_pred_prob_hit_fits <- cbind(knSI_pred_data_emp, knSI_pred_prob_hit)

knSI_pred_prob_hit_fits[,c(1:2)] <- knSI_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

knSI_angle_speed_pred <- knSI_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = knSI_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nKN-SI Hit Probability\n") + theme_bp_grey()

knSI_angle_speed_pred
#####
kcSI$hit_distance_sc <- as.numeric(kcSI$hit_distance_sc, na.rm = TRUE)
kcSI$hit_angle <- as.numeric(kcSI$hit_angle, na.rm = TRUE)
kcSI$hit_speed <- as.numeric(kcSI$hit_speed, na.rm = TRUE)

kcSI$hit <- with(kcSI, ifelse(grepl("Single", kcSI$events), 1,
															ifelse(grepl("Double", kcSI$events), 1,
																		 ifelse(grepl("Triple", kcSI$events), 1, 
																		 			 ifelse(grepl("Home Run", kcSI$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

kcSI$fieldingTeam <- with(kcSI, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[kcSI$hit_distance_sc == "null"] = NA
#kcSI$hit_speed[kcSI$hit_speed == "null"] = NA
#kcSI$hit_angle[kcSI$hit_angle == "null"] = NA

# include row names for unique record identification

kcSI$row <- row.names(kcSI) %>% as.numeric()

# recode stand and home_team as factors

kcSI$stand <- as.factor(kcSI$stand)
kcSI$home_team <- as.factor(kcSI$home_team)


kcSI$game_date <- as.Date(kcSI$game_date)


# subset 

kcSI_working_data <- ungroup(kcSI) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(kcSI_working_data)
str(ungroup(kcSI))
table(kcSI_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

kcSI_working_data <- filter(kcSI_working_data, hc_x != 1, hc_y != 1)
head(kcSI_working_data)

# create training and test sets
# scaled data

set.seed(42)
kcSI_train <- sample_frac(kcSI_working_data, .15, replace = FALSE)
kcSI_split <- setdiff(kcSI_working_data, kcSI_train)
kcSI_test <- sample_frac(kcSI_split, .50, replace = FALSE)
kcSI_validate <- setdiff(kcSI_split, kcSI_test)

nrow(kcSI_train) + nrow(kcSI_test) + nrow(kcSI_validate) == nrow(kcSI_working_data)

with(kcSI_train, table(hit)) %>% prop.table()
with(kcSI_test, table(hit)) %>% prop.table()
with(kcSI_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(kcSI)
##as.numeric(kcSI$hit_distance_sc, kcSI$hit_speed, kcSI$hit_angle)

#kcSI_train$hit_distance_sc <- as.numeric(kcSI_train$hit_distance_sc)
#kcSI_train$hit_speed <- as.numeric(kcSI_train$hit_speed)
#kcSI_train$hit_angle <- as.numeric(kcSI_train$hit_angle)
#View(kcSI_train)
kcSI_scaled_data <- scale(kcSI_train[,c(1:5)])
kcSI_scale_values <- attr(kcSI_scaled_data, 'scaled:scale')
kcSI_scale_values
kcSI_center_values <- attr(kcSI_scaled_data, 'scaled:center')
kcSI_center_values
kcSI_train <- cbind(kcSI_scaled_data, select(kcSI_train, hit:row))

# save levels for factor variables
kcSI_levels_home_team <- levels(kcSI_train$home_team)
kcSI_levels_stand <- levels(kcSI_train$stand)
kcSI_levels_fieldingTeam <- levels(kcSI_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(kcSI_test)

kcSI_test$hit_distance_sc <- (kcSI_test$hit_distance_sc - kcSI_center_values[1]) / kcSI_scale_values[1]

kcSI_test$hit_speed <- (kcSI_test$hit_speed - kcSI_center_values[2]) / kcSI_scale_values[2]

kcSI_test$hit_angle <- (kcSI_test$hit_angle - kcSI_center_values[3]) / kcSI_scale_values[3]

kcSI_test$hc_x <- (kcSI_test$hc_x - kcSI_center_values[4]) / kcSI_scale_values[4]

kcSI_test$hc_y <- (kcSI_test$hc_y - kcSI_center_values[5]) / kcSI_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

kcSI_validate$hit_distance_sc <- (kcSI_validate$hit_distance_sc - kcSI_center_values[1]) / kcSI_scale_values[1]

kcSI_validate$hit_speed <- (kcSI_validate$hit_speed - kcSI_center_values[2]) / kcSI_scale_values[2]

kcSI_validate$hit_angle <- (kcSI_validate$hit_angle - kcSI_center_values[3]) / kcSI_scale_values[3]

kcSI_validate$hc_x <- (kcSI_validate$hc_x - kcSI_center_values[4]) / kcSI_scale_values[4]

kcSI_validate$hc_y <- (kcSI_validate$hc_y - kcSI_center_values[5]) / kcSI_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(kcSI_train)

set.seed(42)
kcSI_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(kcSI_train, -row), ntree = 501, importance = TRUE)

print(kcSI_rf.1)

plot(kcSI_rf.1)

varImpPlot(kcSI_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
kcSI_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(kcSI_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(kcSI_rf.5)

plot(kcSI_rf.5)

varImpPlot(kcSI_rf.5)

kcSI_predict_fit.rf.5 <- data.frame(fits = predict(kcSI_rf.5, kcSI_test, type = "prob")[,2], actuals = kcSI_test$hit)

kcSI_pred.rf.5 <- prediction(kcSI_predict_fit.rf.5$fits, kcSI_predict_fit.rf.5$actuals)

kcSI_roc.pred.rf.5 <- performance(kcSI_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(kcSI_roc.pred.rf.5)
abline(a = 0, b = 1)
kcSI_opt <- opt.cut(kcSI_roc.pred.rf.5, kcSI_pred.rf.5)
kcSI_opt
kcSI_opt <- kcSI_opt[3]
kcSI_predict_fit.rf.5$fits <- with(kcSI_predict_fit.rf.5, ifelse(fits > kcSI_opt, 1, 0)) 

str(kcSI_test)

#kcSI_test$fieldingTeam <- as.character(kcSI_test$fieldingTeam)
#kcSI_test$home_team <- as.character(kcSI_test$home_team)
#kcSI_test$hit <- as.logical(kcSI_test$hit)
#kcSI_test$stand <- as.logical(kcSI_test$stand)
str(kcSI_test)
kcSI_rf.5_confusion_test <- confusionMatrix(model = kcSI_rf.5, x = kcSI_test, y = kcSI_test$hit)
kcSI_rf.5_confusion_validate <- confusionMatrix(model = kcSI_rf.5, x = kcSI_validate, y = kcSI_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


kcSI_test_rows <- kcSI_test$row
kcSI_validate_rows <- kcSI_validate$row
kcSI_pred_data_emp_1 <- ungroup(kcSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcSI_test_rows)

kcSI_pred_data_emp <- ungroup(kcSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcSI_validate_rows) %>%
	rbind(kcSI_pred_data_emp_1)

kcSI_out_of_training_rows <- kcSI_pred_data_emp$row

kcSI_rf.5_full_out_of_sample_data <- ungroup(kcSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcSI_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



kcSI_rf.5_full_out_of_sample_data_scaled <- kcSI_rf.5_full_out_of_sample_data

kcSI_rf.5_full_out_of_sample_data_scaled$hit_speed <- (kcSI_rf.5_full_out_of_sample_data_scaled$hit_speed - kcSI_center_values[2]) / kcSI_scale_values[2]

kcSI_rf.5_full_out_of_sample_data_scaled$hit_angle <- (kcSI_rf.5_full_out_of_sample_data_scaled$hit_angle - kcSI_center_values[3]) / kcSI_scale_values[3]

kcSI_rf.5.prob <- predict(kcSI_rf.5, kcSI_rf.5_full_out_of_sample_data_scaled, type = "response")

kcSI_rf.5_full_out_of_sample_data <- cbind(filter(kcSI_rf.5_full_out_of_sample_data, row %in% kcSI_out_of_training_rows), kcSI_rf.5.prob)

names(kcSI_rf.5_full_out_of_sample_data)[65] <- "fits"
names(kcSI_rf.5_full_out_of_sample_data)

kcSI_rf.5_full_out_of_sample_data_reduced <- kcSI_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

kcSI_rf.5_mean_table <- kcSI_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

kcSI_rf.5_full_out_of_sample_data$type <- with(kcSI_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

kcSI_rf.5_full_out_of_sample_data$hit_label <- with(kcSI_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

kcSI_rf.5_plot1 <- ggplot(kcSI_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcSI_rf.5_plot1

kcSI_rf.5_plot2 <- ggplot(kcSI_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcSI_rf.5_plot2

kcSI_rf.5_plot3 <- ggplot(kcSI_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

kcSI_rf.5_plot3

kcSI_grid_plot_rf.5 <- grid.arrange(kcSI_rf.5_plot1, kcSI_rf.5_plot2, kcSI_rf.5_plot3, ncol = 3)
kcSI_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

kcSI_test_rows <- kcSI_test$row
kcSI_validate_rows <- kcSI_validate$row
kcSI_pred_data_emp_1 <- ungroup(kcSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcSI_test_rows)

kcSI_pred_data_emp <- ungroup(kcSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcSI_validate_rows) %>%
	rbind(kcSI_pred_data_emp_1)

kcSI_out_of_training_rows <- kcSI_pred_data_emp$row

kcSI_pred_data_emp <- ungroup(kcSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% kcSI_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

kcSI_pred_data_emp_scaled <- kcSI_pred_data_emp

kcSI_pred_data_emp_scaled$hit_speed <- (kcSI_pred_data_emp_scaled$hit_speed - kcSI_center_values[2]) / kcSI_scale_values[2]

kcSI_pred_data_emp_scaled$hit_angle <- (kcSI_pred_data_emp_scaled$hit_angle - kcSI_center_values[3]) / kcSI_scale_values[3]

kcSI_pred_prob_hit <- predict(kcSI_rf.5, kcSI_pred_data_emp_scaled, type = "prob")[,2]
kcSI_pred_prob_hit_fits <- cbind(kcSI_pred_data_emp, kcSI_pred_prob_hit)

kcSI_pred_prob_hit_fits[,c(1:2)] <- kcSI_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

kcSI_angle_speed_pred <- kcSI_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = kcSI_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nKC-SI Hit Probability\n") + theme_bp_grey()

kcSI_angle_speed_pred
#####
fsSI$hit_distance_sc <- as.numeric(fsSI$hit_distance_sc, na.rm = TRUE)
fsSI$hit_angle <- as.numeric(fsSI$hit_angle, na.rm = TRUE)
fsSI$hit_speed <- as.numeric(fsSI$hit_speed, na.rm = TRUE)

fsSI$hit <- with(fsSI, ifelse(grepl("Single", fsSI$events), 1,
															ifelse(grepl("Double", fsSI$events), 1,
																		 ifelse(grepl("Triple", fsSI$events), 1, 
																		 			 ifelse(grepl("Home Run", fsSI$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

fsSI$fieldingTeam <- with(fsSI, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[fsSI$hit_distance_sc == "null"] = NA
#fsSI$hit_speed[fsSI$hit_speed == "null"] = NA
#fsSI$hit_angle[fsSI$hit_angle == "null"] = NA

# include row names for unique record identification

fsSI$row <- row.names(fsSI) %>% as.numeric()

# recode stand and home_team as factors

fsSI$stand <- as.factor(fsSI$stand)
fsSI$home_team <- as.factor(fsSI$home_team)


fsSI$game_date <- as.Date(fsSI$game_date)


# subset 

fsSI_working_data <- ungroup(fsSI) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(fsSI_working_data)
str(ungroup(fsSI))
table(fsSI_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

fsSI_working_data <- filter(fsSI_working_data, hc_x != 1, hc_y != 1)
head(fsSI_working_data)

# create training and test sets
# scaled data

set.seed(42)
fsSI_train <- sample_frac(fsSI_working_data, .15, replace = FALSE)
fsSI_split <- setdiff(fsSI_working_data, fsSI_train)
fsSI_test <- sample_frac(fsSI_split, .50, replace = FALSE)
fsSI_validate <- setdiff(fsSI_split, fsSI_test)

nrow(fsSI_train) + nrow(fsSI_test) + nrow(fsSI_validate) == nrow(fsSI_working_data)

with(fsSI_train, table(hit)) %>% prop.table()
with(fsSI_test, table(hit)) %>% prop.table()
with(fsSI_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(fsSI)
##as.numeric(fsSI$hit_distance_sc, fsSI$hit_speed, fsSI$hit_angle)

#fsSI_train$hit_distance_sc <- as.numeric(fsSI_train$hit_distance_sc)
#fsSI_train$hit_speed <- as.numeric(fsSI_train$hit_speed)
#fsSI_train$hit_angle <- as.numeric(fsSI_train$hit_angle)
#View(fsSI_train)
fsSI_scaled_data <- scale(fsSI_train[,c(1:5)])
fsSI_scale_values <- attr(fsSI_scaled_data, 'scaled:scale')
fsSI_scale_values
fsSI_center_values <- attr(fsSI_scaled_data, 'scaled:center')
fsSI_center_values
fsSI_train <- cbind(fsSI_scaled_data, select(fsSI_train, hit:row))

# save levels for factor variables
fsSI_levels_home_team <- levels(fsSI_train$home_team)
fsSI_levels_stand <- levels(fsSI_train$stand)
fsSI_levels_fieldingTeam <- levels(fsSI_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(fsSI_test)

fsSI_test$hit_distance_sc <- (fsSI_test$hit_distance_sc - fsSI_center_values[1]) / fsSI_scale_values[1]

fsSI_test$hit_speed <- (fsSI_test$hit_speed - fsSI_center_values[2]) / fsSI_scale_values[2]

fsSI_test$hit_angle <- (fsSI_test$hit_angle - fsSI_center_values[3]) / fsSI_scale_values[3]

fsSI_test$hc_x <- (fsSI_test$hc_x - fsSI_center_values[4]) / fsSI_scale_values[4]

fsSI_test$hc_y <- (fsSI_test$hc_y - fsSI_center_values[5]) / fsSI_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

fsSI_validate$hit_distance_sc <- (fsSI_validate$hit_distance_sc - fsSI_center_values[1]) / fsSI_scale_values[1]

fsSI_validate$hit_speed <- (fsSI_validate$hit_speed - fsSI_center_values[2]) / fsSI_scale_values[2]

fsSI_validate$hit_angle <- (fsSI_validate$hit_angle - fsSI_center_values[3]) / fsSI_scale_values[3]

fsSI_validate$hc_x <- (fsSI_validate$hc_x - fsSI_center_values[4]) / fsSI_scale_values[4]

fsSI_validate$hc_y <- (fsSI_validate$hc_y - fsSI_center_values[5]) / fsSI_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(fsSI_train)

set.seed(42)
fsSI_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(fsSI_train, -row), ntree = 501, importance = TRUE)

print(fsSI_rf.1)

plot(fsSI_rf.1)

varImpPlot(fsSI_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
fsSI_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(fsSI_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(fsSI_rf.5)

plot(fsSI_rf.5)

varImpPlot(fsSI_rf.5)

fsSI_predict_fit.rf.5 <- data.frame(fits = predict(fsSI_rf.5, fsSI_test, type = "prob")[,2], actuals = fsSI_test$hit)

fsSI_pred.rf.5 <- prediction(fsSI_predict_fit.rf.5$fits, fsSI_predict_fit.rf.5$actuals)

fsSI_roc.pred.rf.5 <- performance(fsSI_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(fsSI_roc.pred.rf.5)
abline(a = 0, b = 1)
fsSI_opt <- opt.cut(fsSI_roc.pred.rf.5, fsSI_pred.rf.5)
fsSI_opt
fsSI_opt <- fsSI_opt[3]
fsSI_predict_fit.rf.5$fits <- with(fsSI_predict_fit.rf.5, ifelse(fits > fsSI_opt, 1, 0)) 

str(fsSI_test)

#fsSI_test$fieldingTeam <- as.character(fsSI_test$fieldingTeam)
#fsSI_test$home_team <- as.character(fsSI_test$home_team)
#fsSI_test$hit <- as.logical(fsSI_test$hit)
#fsSI_test$stand <- as.logical(fsSI_test$stand)
str(fsSI_test)
fsSI_rf.5_confusion_test <- confusionMatrix(model = fsSI_rf.5, x = fsSI_test, y = fsSI_test$hit)
fsSI_rf.5_confusion_validate <- confusionMatrix(model = fsSI_rf.5, x = fsSI_validate, y = fsSI_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


fsSI_test_rows <- fsSI_test$row
fsSI_validate_rows <- fsSI_validate$row
fsSI_pred_data_emp_1 <- ungroup(fsSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsSI_test_rows)

fsSI_pred_data_emp <- ungroup(fsSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsSI_validate_rows) %>%
	rbind(fsSI_pred_data_emp_1)

fsSI_out_of_training_rows <- fsSI_pred_data_emp$row

fsSI_rf.5_full_out_of_sample_data <- ungroup(fsSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsSI_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



fsSI_rf.5_full_out_of_sample_data_scaled <- fsSI_rf.5_full_out_of_sample_data

fsSI_rf.5_full_out_of_sample_data_scaled$hit_speed <- (fsSI_rf.5_full_out_of_sample_data_scaled$hit_speed - fsSI_center_values[2]) / fsSI_scale_values[2]

fsSI_rf.5_full_out_of_sample_data_scaled$hit_angle <- (fsSI_rf.5_full_out_of_sample_data_scaled$hit_angle - fsSI_center_values[3]) / fsSI_scale_values[3]

fsSI_rf.5.prob <- predict(fsSI_rf.5, fsSI_rf.5_full_out_of_sample_data_scaled, type = "response")

fsSI_rf.5_full_out_of_sample_data <- cbind(filter(fsSI_rf.5_full_out_of_sample_data, row %in% fsSI_out_of_training_rows), fsSI_rf.5.prob)

names(fsSI_rf.5_full_out_of_sample_data)[65] <- "fits"
names(fsSI_rf.5_full_out_of_sample_data)

fsSI_rf.5_full_out_of_sample_data_reduced <- fsSI_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

fsSI_rf.5_mean_table <- fsSI_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

fsSI_rf.5_full_out_of_sample_data$type <- with(fsSI_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

fsSI_rf.5_full_out_of_sample_data$hit_label <- with(fsSI_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

fsSI_rf.5_plot1 <- ggplot(fsSI_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsSI_rf.5_plot1

fsSI_rf.5_plot2 <- ggplot(fsSI_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsSI_rf.5_plot2

fsSI_rf.5_plot3 <- ggplot(fsSI_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fsSI_rf.5_plot3

fsSI_grid_plot_rf.5 <- grid.arrange(fsSI_rf.5_plot1, fsSI_rf.5_plot2, fsSI_rf.5_plot3, ncol = 3)
fsSI_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

fsSI_test_rows <- fsSI_test$row
fsSI_validate_rows <- fsSI_validate$row
fsSI_pred_data_emp_1 <- ungroup(fsSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsSI_test_rows)

fsSI_pred_data_emp <- ungroup(fsSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsSI_validate_rows) %>%
	rbind(fsSI_pred_data_emp_1)

fsSI_out_of_training_rows <- fsSI_pred_data_emp$row

fsSI_pred_data_emp <- ungroup(fsSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fsSI_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

fsSI_pred_data_emp_scaled <- fsSI_pred_data_emp

fsSI_pred_data_emp_scaled$hit_speed <- (fsSI_pred_data_emp_scaled$hit_speed - fsSI_center_values[2]) / fsSI_scale_values[2]

fsSI_pred_data_emp_scaled$hit_angle <- (fsSI_pred_data_emp_scaled$hit_angle - fsSI_center_values[3]) / fsSI_scale_values[3]

fsSI_pred_prob_hit <- predict(fsSI_rf.5, fsSI_pred_data_emp_scaled, type = "prob")[,2]
fsSI_pred_prob_hit_fits <- cbind(fsSI_pred_data_emp, fsSI_pred_prob_hit)

fsSI_pred_prob_hit_fits[,c(1:2)] <- fsSI_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

fsSI_angle_speed_pred <- fsSI_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = fsSI_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFS-SI Hit Probability\n") + theme_bp_grey()

fsSI_angle_speed_pred
#####
fcSI$hit_distance_sc <- as.numeric(fcSI$hit_distance_sc, na.rm = TRUE)
fcSI$hit_angle <- as.numeric(fcSI$hit_angle, na.rm = TRUE)
fcSI$hit_speed <- as.numeric(fcSI$hit_speed, na.rm = TRUE)

fcSI$hit <- with(fcSI, ifelse(grepl("Single", fcSI$events), 1,
															ifelse(grepl("Double", fcSI$events), 1,
																		 ifelse(grepl("Triple", fcSI$events), 1, 
																		 			 ifelse(grepl("Home Run", fcSI$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

fcSI$fieldingTeam <- with(fcSI, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[fcSI$hit_distance_sc == "null"] = NA
#fcSI$hit_speed[fcSI$hit_speed == "null"] = NA
#fcSI$hit_angle[fcSI$hit_angle == "null"] = NA

# include row names for unique record identification

fcSI$row <- row.names(fcSI) %>% as.numeric()

# recode stand and home_team as factors

fcSI$stand <- as.factor(fcSI$stand)
fcSI$home_team <- as.factor(fcSI$home_team)


fcSI$game_date <- as.Date(fcSI$game_date)


# subset 

fcSI_working_data <- ungroup(fcSI) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(fcSI_working_data)
str(ungroup(fcSI))
table(fcSI_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

fcSI_working_data <- filter(fcSI_working_data, hc_x != 1, hc_y != 1)
head(fcSI_working_data)

# create training and test sets
# scaled data

set.seed(42)
fcSI_train <- sample_frac(fcSI_working_data, .15, replace = FALSE)
fcSI_split <- setdiff(fcSI_working_data, fcSI_train)
fcSI_test <- sample_frac(fcSI_split, .50, replace = FALSE)
fcSI_validate <- setdiff(fcSI_split, fcSI_test)

nrow(fcSI_train) + nrow(fcSI_test) + nrow(fcSI_validate) == nrow(fcSI_working_data)

with(fcSI_train, table(hit)) %>% prop.table()
with(fcSI_test, table(hit)) %>% prop.table()
with(fcSI_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(fcSI)
##as.numeric(fcSI$hit_distance_sc, fcSI$hit_speed, fcSI$hit_angle)

#fcSI_train$hit_distance_sc <- as.numeric(fcSI_train$hit_distance_sc)
#fcSI_train$hit_speed <- as.numeric(fcSI_train$hit_speed)
#fcSI_train$hit_angle <- as.numeric(fcSI_train$hit_angle)
#View(fcSI_train)
fcSI_scaled_data <- scale(fcSI_train[,c(1:5)])
fcSI_scale_values <- attr(fcSI_scaled_data, 'scaled:scale')
fcSI_scale_values
fcSI_center_values <- attr(fcSI_scaled_data, 'scaled:center')
fcSI_center_values
fcSI_train <- cbind(fcSI_scaled_data, select(fcSI_train, hit:row))

# save levels for factor variables
fcSI_levels_home_team <- levels(fcSI_train$home_team)
fcSI_levels_stand <- levels(fcSI_train$stand)
fcSI_levels_fieldingTeam <- levels(fcSI_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(fcSI_test)

fcSI_test$hit_distance_sc <- (fcSI_test$hit_distance_sc - fcSI_center_values[1]) / fcSI_scale_values[1]

fcSI_test$hit_speed <- (fcSI_test$hit_speed - fcSI_center_values[2]) / fcSI_scale_values[2]

fcSI_test$hit_angle <- (fcSI_test$hit_angle - fcSI_center_values[3]) / fcSI_scale_values[3]

fcSI_test$hc_x <- (fcSI_test$hc_x - fcSI_center_values[4]) / fcSI_scale_values[4]

fcSI_test$hc_y <- (fcSI_test$hc_y - fcSI_center_values[5]) / fcSI_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

fcSI_validate$hit_distance_sc <- (fcSI_validate$hit_distance_sc - fcSI_center_values[1]) / fcSI_scale_values[1]

fcSI_validate$hit_speed <- (fcSI_validate$hit_speed - fcSI_center_values[2]) / fcSI_scale_values[2]

fcSI_validate$hit_angle <- (fcSI_validate$hit_angle - fcSI_center_values[3]) / fcSI_scale_values[3]

fcSI_validate$hc_x <- (fcSI_validate$hc_x - fcSI_center_values[4]) / fcSI_scale_values[4]

fcSI_validate$hc_y <- (fcSI_validate$hc_y - fcSI_center_values[5]) / fcSI_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(fcSI_train)

set.seed(42)
fcSI_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(fcSI_train, -row), ntree = 501, importance = TRUE)

print(fcSI_rf.1)

plot(fcSI_rf.1)

varImpPlot(fcSI_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
fcSI_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(fcSI_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(fcSI_rf.5)

plot(fcSI_rf.5)

varImpPlot(fcSI_rf.5)

fcSI_predict_fit.rf.5 <- data.frame(fits = predict(fcSI_rf.5, fcSI_test, type = "prob")[,2], actuals = fcSI_test$hit)

fcSI_pred.rf.5 <- prediction(fcSI_predict_fit.rf.5$fits, fcSI_predict_fit.rf.5$actuals)

fcSI_roc.pred.rf.5 <- performance(fcSI_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(fcSI_roc.pred.rf.5)
abline(a = 0, b = 1)
fcSI_opt <- opt.cut(fcSI_roc.pred.rf.5, fcSI_pred.rf.5)
fcSI_opt
fcSI_opt <- fcSI_opt[3]
fcSI_predict_fit.rf.5$fits <- with(fcSI_predict_fit.rf.5, ifelse(fits > fcSI_opt, 1, 0)) 

str(fcSI_test)

#fcSI_test$fieldingTeam <- as.character(fcSI_test$fieldingTeam)
#fcSI_test$home_team <- as.character(fcSI_test$home_team)
#fcSI_test$hit <- as.logical(fcSI_test$hit)
#fcSI_test$stand <- as.logical(fcSI_test$stand)
str(fcSI_test)
fcSI_rf.5_confusion_test <- confusionMatrix(model = fcSI_rf.5, x = fcSI_test, y = fcSI_test$hit)
fcSI_rf.5_confusion_validate <- confusionMatrix(model = fcSI_rf.5, x = fcSI_validate, y = fcSI_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


fcSI_test_rows <- fcSI_test$row
fcSI_validate_rows <- fcSI_validate$row
fcSI_pred_data_emp_1 <- ungroup(fcSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcSI_test_rows)

fcSI_pred_data_emp <- ungroup(fcSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcSI_validate_rows) %>%
	rbind(fcSI_pred_data_emp_1)

fcSI_out_of_training_rows <- fcSI_pred_data_emp$row

fcSI_rf.5_full_out_of_sample_data <- ungroup(fcSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcSI_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



fcSI_rf.5_full_out_of_sample_data_scaled <- fcSI_rf.5_full_out_of_sample_data

fcSI_rf.5_full_out_of_sample_data_scaled$hit_speed <- (fcSI_rf.5_full_out_of_sample_data_scaled$hit_speed - fcSI_center_values[2]) / fcSI_scale_values[2]

fcSI_rf.5_full_out_of_sample_data_scaled$hit_angle <- (fcSI_rf.5_full_out_of_sample_data_scaled$hit_angle - fcSI_center_values[3]) / fcSI_scale_values[3]

fcSI_rf.5.prob <- predict(fcSI_rf.5, fcSI_rf.5_full_out_of_sample_data_scaled, type = "response")

fcSI_rf.5_full_out_of_sample_data <- cbind(filter(fcSI_rf.5_full_out_of_sample_data, row %in% fcSI_out_of_training_rows), fcSI_rf.5.prob)

names(fcSI_rf.5_full_out_of_sample_data)[65] <- "fits"
names(fcSI_rf.5_full_out_of_sample_data)

fcSI_rf.5_full_out_of_sample_data_reduced <- fcSI_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

fcSI_rf.5_mean_table <- fcSI_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

fcSI_rf.5_full_out_of_sample_data$type <- with(fcSI_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

fcSI_rf.5_full_out_of_sample_data$hit_label <- with(fcSI_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

fcSI_rf.5_plot1 <- ggplot(fcSI_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcSI_rf.5_plot1

fcSI_rf.5_plot2 <- ggplot(fcSI_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcSI_rf.5_plot2

fcSI_rf.5_plot3 <- ggplot(fcSI_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

fcSI_rf.5_plot3

fcSI_grid_plot_rf.5 <- grid.arrange(fcSI_rf.5_plot1, fcSI_rf.5_plot2, fcSI_rf.5_plot3, ncol = 3)
fcSI_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

fcSI_test_rows <- fcSI_test$row
fcSI_validate_rows <- fcSI_validate$row
fcSI_pred_data_emp_1 <- ungroup(fcSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcSI_test_rows)

fcSI_pred_data_emp <- ungroup(fcSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcSI_validate_rows) %>%
	rbind(fcSI_pred_data_emp_1)

fcSI_out_of_training_rows <- fcSI_pred_data_emp$row

fcSI_pred_data_emp <- ungroup(fcSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% fcSI_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

fcSI_pred_data_emp_scaled <- fcSI_pred_data_emp

fcSI_pred_data_emp_scaled$hit_speed <- (fcSI_pred_data_emp_scaled$hit_speed - fcSI_center_values[2]) / fcSI_scale_values[2]

fcSI_pred_data_emp_scaled$hit_angle <- (fcSI_pred_data_emp_scaled$hit_angle - fcSI_center_values[3]) / fcSI_scale_values[3]

fcSI_pred_prob_hit <- predict(fcSI_rf.5, fcSI_pred_data_emp_scaled, type = "prob")[,2]
fcSI_pred_prob_hit_fits <- cbind(fcSI_pred_data_emp, fcSI_pred_prob_hit)

fcSI_pred_prob_hit_fits[,c(1:2)] <- fcSI_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

fcSI_angle_speed_pred <- fcSI_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = fcSI_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFC-SI Hit Probability\n") + theme_bp_grey()

fcSI_angle_speed_pred
#####
chSI$hit_distance_sc <- as.numeric(chSI$hit_distance_sc, na.rm = TRUE)
chSI$hit_angle <- as.numeric(chSI$hit_angle, na.rm = TRUE)
chSI$hit_speed <- as.numeric(chSI$hit_speed, na.rm = TRUE)

chSI$hit <- with(chSI, ifelse(grepl("Single", chSI$events), 1,
															ifelse(grepl("Double", chSI$events), 1,
																		 ifelse(grepl("Triple", chSI$events), 1, 
																		 			 ifelse(grepl("Home Run", chSI$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

chSI$fieldingTeam <- with(chSI, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[chSI$hit_distance_sc == "null"] = NA
#chSI$hit_speed[chSI$hit_speed == "null"] = NA
#chSI$hit_angle[chSI$hit_angle == "null"] = NA

# include row names for unique record identification

chSI$row <- row.names(chSI) %>% as.numeric()

# recode stand and home_team as factors

chSI$stand <- as.factor(chSI$stand)
chSI$home_team <- as.factor(chSI$home_team)


chSI$game_date <- as.Date(chSI$game_date)


# subset 

chSI_working_data <- ungroup(chSI) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(chSI_working_data)
str(ungroup(chSI))
table(chSI_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

chSI_working_data <- filter(chSI_working_data, hc_x != 1, hc_y != 1)
head(chSI_working_data)

# create training and test sets
# scaled data

set.seed(42)
chSI_train <- sample_frac(chSI_working_data, .15, replace = FALSE)
chSI_split <- setdiff(chSI_working_data, chSI_train)
chSI_test <- sample_frac(chSI_split, .50, replace = FALSE)
chSI_validate <- setdiff(chSI_split, chSI_test)

nrow(chSI_train) + nrow(chSI_test) + nrow(chSI_validate) == nrow(chSI_working_data)

with(chSI_train, table(hit)) %>% prop.table()
with(chSI_test, table(hit)) %>% prop.table()
with(chSI_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(chSI)
##as.numeric(chSI$hit_distance_sc, chSI$hit_speed, chSI$hit_angle)

#chSI_train$hit_distance_sc <- as.numeric(chSI_train$hit_distance_sc)
#chSI_train$hit_speed <- as.numeric(chSI_train$hit_speed)
#chSI_train$hit_angle <- as.numeric(chSI_train$hit_angle)
#View(chSI_train)
chSI_scaled_data <- scale(chSI_train[,c(1:5)])
chSI_scale_values <- attr(chSI_scaled_data, 'scaled:scale')
chSI_scale_values
chSI_center_values <- attr(chSI_scaled_data, 'scaled:center')
chSI_center_values
chSI_train <- cbind(chSI_scaled_data, select(chSI_train, hit:row))

# save levels for factor variables
chSI_levels_home_team <- levels(chSI_train$home_team)
chSI_levels_stand <- levels(chSI_train$stand)
chSI_levels_fieldingTeam <- levels(chSI_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(chSI_test)

chSI_test$hit_distance_sc <- (chSI_test$hit_distance_sc - chSI_center_values[1]) / chSI_scale_values[1]

chSI_test$hit_speed <- (chSI_test$hit_speed - chSI_center_values[2]) / chSI_scale_values[2]

chSI_test$hit_angle <- (chSI_test$hit_angle - chSI_center_values[3]) / chSI_scale_values[3]

chSI_test$hc_x <- (chSI_test$hc_x - chSI_center_values[4]) / chSI_scale_values[4]

chSI_test$hc_y <- (chSI_test$hc_y - chSI_center_values[5]) / chSI_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

chSI_validate$hit_distance_sc <- (chSI_validate$hit_distance_sc - chSI_center_values[1]) / chSI_scale_values[1]

chSI_validate$hit_speed <- (chSI_validate$hit_speed - chSI_center_values[2]) / chSI_scale_values[2]

chSI_validate$hit_angle <- (chSI_validate$hit_angle - chSI_center_values[3]) / chSI_scale_values[3]

chSI_validate$hc_x <- (chSI_validate$hc_x - chSI_center_values[4]) / chSI_scale_values[4]

chSI_validate$hc_y <- (chSI_validate$hc_y - chSI_center_values[5]) / chSI_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(chSI_train)

set.seed(42)
chSI_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(chSI_train, -row), ntree = 501, importance = TRUE)

print(chSI_rf.1)

plot(chSI_rf.1)

varImpPlot(chSI_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
chSI_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(chSI_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(chSI_rf.5)

plot(chSI_rf.5)

varImpPlot(chSI_rf.5)

chSI_predict_fit.rf.5 <- data.frame(fits = predict(chSI_rf.5, chSI_test, type = "prob")[,2], actuals = chSI_test$hit)

chSI_pred.rf.5 <- prediction(chSI_predict_fit.rf.5$fits, chSI_predict_fit.rf.5$actuals)

chSI_roc.pred.rf.5 <- performance(chSI_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(chSI_roc.pred.rf.5)
abline(a = 0, b = 1)
chSI_opt <- opt.cut(chSI_roc.pred.rf.5, chSI_pred.rf.5)
chSI_opt
chSI_opt <- chSI_opt[3]
chSI_predict_fit.rf.5$fits <- with(chSI_predict_fit.rf.5, ifelse(fits > chSI_opt, 1, 0)) 

str(chSI_test)

#chSI_test$fieldingTeam <- as.character(chSI_test$fieldingTeam)
#chSI_test$home_team <- as.character(chSI_test$home_team)
#chSI_test$hit <- as.logical(chSI_test$hit)
#chSI_test$stand <- as.logical(chSI_test$stand)
str(chSI_test)
chSI_rf.5_confusion_test <- confusionMatrix(model = chSI_rf.5, x = chSI_test, y = chSI_test$hit)
chSI_rf.5_confusion_validate <- confusionMatrix(model = chSI_rf.5, x = chSI_validate, y = chSI_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


chSI_test_rows <- chSI_test$row
chSI_validate_rows <- chSI_validate$row
chSI_pred_data_emp_1 <- ungroup(chSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chSI_test_rows)

chSI_pred_data_emp <- ungroup(chSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chSI_validate_rows) %>%
	rbind(chSI_pred_data_emp_1)

chSI_out_of_training_rows <- chSI_pred_data_emp$row

chSI_rf.5_full_out_of_sample_data <- ungroup(chSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chSI_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



chSI_rf.5_full_out_of_sample_data_scaled <- chSI_rf.5_full_out_of_sample_data

chSI_rf.5_full_out_of_sample_data_scaled$hit_speed <- (chSI_rf.5_full_out_of_sample_data_scaled$hit_speed - chSI_center_values[2]) / chSI_scale_values[2]

chSI_rf.5_full_out_of_sample_data_scaled$hit_angle <- (chSI_rf.5_full_out_of_sample_data_scaled$hit_angle - chSI_center_values[3]) / chSI_scale_values[3]

chSI_rf.5.prob <- predict(chSI_rf.5, chSI_rf.5_full_out_of_sample_data_scaled, type = "response")

chSI_rf.5_full_out_of_sample_data <- cbind(filter(chSI_rf.5_full_out_of_sample_data, row %in% chSI_out_of_training_rows), chSI_rf.5.prob)

names(chSI_rf.5_full_out_of_sample_data)[65] <- "fits"
names(chSI_rf.5_full_out_of_sample_data)

chSI_rf.5_full_out_of_sample_data_reduced <- chSI_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

chSI_rf.5_mean_table <- chSI_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

chSI_rf.5_full_out_of_sample_data$type <- with(chSI_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

chSI_rf.5_full_out_of_sample_data$hit_label <- with(chSI_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

chSI_rf.5_plot1 <- ggplot(chSI_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chSI_rf.5_plot1

chSI_rf.5_plot2 <- ggplot(chSI_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chSI_rf.5_plot2

chSI_rf.5_plot3 <- ggplot(chSI_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

chSI_rf.5_plot3

chSI_grid_plot_rf.5 <- grid.arrange(chSI_rf.5_plot1, chSI_rf.5_plot2, chSI_rf.5_plot3, ncol = 3)
chSI_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

chSI_test_rows <- chSI_test$row
chSI_validate_rows <- chSI_validate$row
chSI_pred_data_emp_1 <- ungroup(chSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chSI_test_rows)

chSI_pred_data_emp <- ungroup(chSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chSI_validate_rows) %>%
	rbind(chSI_pred_data_emp_1)

chSI_out_of_training_rows <- chSI_pred_data_emp$row

chSI_pred_data_emp <- ungroup(chSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% chSI_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

chSI_pred_data_emp_scaled <- chSI_pred_data_emp

chSI_pred_data_emp_scaled$hit_speed <- (chSI_pred_data_emp_scaled$hit_speed - chSI_center_values[2]) / chSI_scale_values[2]

chSI_pred_data_emp_scaled$hit_angle <- (chSI_pred_data_emp_scaled$hit_angle - chSI_center_values[3]) / chSI_scale_values[3]

chSI_pred_prob_hit <- predict(chSI_rf.5, chSI_pred_data_emp_scaled, type = "prob")[,2]
chSI_pred_prob_hit_fits <- cbind(chSI_pred_data_emp, chSI_pred_prob_hit)

chSI_pred_prob_hit_fits[,c(1:2)] <- chSI_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

chSI_angle_speed_pred <- chSI_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = chSI_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nCH-SI Hit Probability\n") + theme_bp_grey()

chSI_angle_speed_pred
#####
ftSI$hit_distance_sc <- as.numeric(ftSI$hit_distance_sc, na.rm = TRUE)
ftSI$hit_angle <- as.numeric(ftSI$hit_angle, na.rm = TRUE)
ftSI$hit_speed <- as.numeric(ftSI$hit_speed, na.rm = TRUE)

ftSI$hit <- with(ftSI, ifelse(grepl("Single", ftSI$events), 1,
															ifelse(grepl("Double", ftSI$events), 1,
																		 ifelse(grepl("Triple", ftSI$events), 1, 
																		 			 ifelse(grepl("Home Run", ftSI$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

ftSI$fieldingTeam <- with(ftSI, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[ftSI$hit_distance_sc == "null"] = NA
#ftSI$hit_speed[ftSI$hit_speed == "null"] = NA
#ftSI$hit_angle[ftSI$hit_angle == "null"] = NA

# include row names for unique record identification

ftSI$row <- row.names(ftSI) %>% as.numeric()

# recode stand and home_team as factors

ftSI$stand <- as.factor(ftSI$stand)
ftSI$home_team <- as.factor(ftSI$home_team)


ftSI$game_date <- as.Date(ftSI$game_date)


# subset 

ftSI_working_data <- ungroup(ftSI) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(ftSI_working_data)
str(ungroup(ftSI))
table(ftSI_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

ftSI_working_data <- filter(ftSI_working_data, hc_x != 1, hc_y != 1)
head(ftSI_working_data)

# create training and test sets
# scaled data

set.seed(42)
ftSI_train <- sample_frac(ftSI_working_data, .15, replace = FALSE)
ftSI_split <- setdiff(ftSI_working_data, ftSI_train)
ftSI_test <- sample_frac(ftSI_split, .50, replace = FALSE)
ftSI_validate <- setdiff(ftSI_split, ftSI_test)

nrow(ftSI_train) + nrow(ftSI_test) + nrow(ftSI_validate) == nrow(ftSI_working_data)

with(ftSI_train, table(hit)) %>% prop.table()
with(ftSI_test, table(hit)) %>% prop.table()
with(ftSI_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(ftSI)
##as.numeric(ftSI$hit_distance_sc, ftSI$hit_speed, ftSI$hit_angle)

#ftSI_train$hit_distance_sc <- as.numeric(ftSI_train$hit_distance_sc)
#ftSI_train$hit_speed <- as.numeric(ftSI_train$hit_speed)
#ftSI_train$hit_angle <- as.numeric(ftSI_train$hit_angle)
#View(ftSI_train)
ftSI_scaled_data <- scale(ftSI_train[,c(1:5)])
ftSI_scale_values <- attr(ftSI_scaled_data, 'scaled:scale')
ftSI_scale_values
ftSI_center_values <- attr(ftSI_scaled_data, 'scaled:center')
ftSI_center_values
ftSI_train <- cbind(ftSI_scaled_data, select(ftSI_train, hit:row))

# save levels for factor variables
ftSI_levels_home_team <- levels(ftSI_train$home_team)
ftSI_levels_stand <- levels(ftSI_train$stand)
ftSI_levels_fieldingTeam <- levels(ftSI_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(ftSI_test)

ftSI_test$hit_distance_sc <- (ftSI_test$hit_distance_sc - ftSI_center_values[1]) / ftSI_scale_values[1]

ftSI_test$hit_speed <- (ftSI_test$hit_speed - ftSI_center_values[2]) / ftSI_scale_values[2]

ftSI_test$hit_angle <- (ftSI_test$hit_angle - ftSI_center_values[3]) / ftSI_scale_values[3]

ftSI_test$hc_x <- (ftSI_test$hc_x - ftSI_center_values[4]) / ftSI_scale_values[4]

ftSI_test$hc_y <- (ftSI_test$hc_y - ftSI_center_values[5]) / ftSI_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

ftSI_validate$hit_distance_sc <- (ftSI_validate$hit_distance_sc - ftSI_center_values[1]) / ftSI_scale_values[1]

ftSI_validate$hit_speed <- (ftSI_validate$hit_speed - ftSI_center_values[2]) / ftSI_scale_values[2]

ftSI_validate$hit_angle <- (ftSI_validate$hit_angle - ftSI_center_values[3]) / ftSI_scale_values[3]

ftSI_validate$hc_x <- (ftSI_validate$hc_x - ftSI_center_values[4]) / ftSI_scale_values[4]

ftSI_validate$hc_y <- (ftSI_validate$hc_y - ftSI_center_values[5]) / ftSI_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(ftSI_train)

set.seed(42)
ftSI_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(ftSI_train, -row), ntree = 501, importance = TRUE)

print(ftSI_rf.1)

plot(ftSI_rf.1)

varImpPlot(ftSI_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
ftSI_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(ftSI_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(ftSI_rf.5)

plot(ftSI_rf.5)

varImpPlot(ftSI_rf.5)

ftSI_predict_fit.rf.5 <- data.frame(fits = predict(ftSI_rf.5, ftSI_test, type = "prob")[,2], actuals = ftSI_test$hit)

ftSI_pred.rf.5 <- prediction(ftSI_predict_fit.rf.5$fits, ftSI_predict_fit.rf.5$actuals)

ftSI_roc.pred.rf.5 <- performance(ftSI_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(ftSI_roc.pred.rf.5)
abline(a = 0, b = 1)
ftSI_opt <- opt.cut(ftSI_roc.pred.rf.5, ftSI_pred.rf.5)
ftSI_opt
ftSI_opt <- ftSI_opt[3]
ftSI_predict_fit.rf.5$fits <- with(ftSI_predict_fit.rf.5, ifelse(fits > ftSI_opt, 1, 0)) 

str(ftSI_test)

#ftSI_test$fieldingTeam <- as.character(ftSI_test$fieldingTeam)
#ftSI_test$home_team <- as.character(ftSI_test$home_team)
#ftSI_test$hit <- as.logical(ftSI_test$hit)
#ftSI_test$stand <- as.logical(ftSI_test$stand)
str(ftSI_test)
ftSI_rf.5_confusion_test <- confusionMatrix(model = ftSI_rf.5, x = ftSI_test, y = ftSI_test$hit)
ftSI_rf.5_confusion_validate <- confusionMatrix(model = ftSI_rf.5, x = ftSI_validate, y = ftSI_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


ftSI_test_rows <- ftSI_test$row
ftSI_validate_rows <- ftSI_validate$row
ftSI_pred_data_emp_1 <- ungroup(ftSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftSI_test_rows)

ftSI_pred_data_emp <- ungroup(ftSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftSI_validate_rows) %>%
	rbind(ftSI_pred_data_emp_1)

ftSI_out_of_training_rows <- ftSI_pred_data_emp$row

ftSI_rf.5_full_out_of_sample_data <- ungroup(ftSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftSI_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



ftSI_rf.5_full_out_of_sample_data_scaled <- ftSI_rf.5_full_out_of_sample_data

ftSI_rf.5_full_out_of_sample_data_scaled$hit_speed <- (ftSI_rf.5_full_out_of_sample_data_scaled$hit_speed - ftSI_center_values[2]) / ftSI_scale_values[2]

ftSI_rf.5_full_out_of_sample_data_scaled$hit_angle <- (ftSI_rf.5_full_out_of_sample_data_scaled$hit_angle - ftSI_center_values[3]) / ftSI_scale_values[3]

ftSI_rf.5.prob <- predict(ftSI_rf.5, ftSI_rf.5_full_out_of_sample_data_scaled, type = "response")

ftSI_rf.5_full_out_of_sample_data <- cbind(filter(ftSI_rf.5_full_out_of_sample_data, row %in% ftSI_out_of_training_rows), ftSI_rf.5.prob)

names(ftSI_rf.5_full_out_of_sample_data)[65] <- "fits"
names(ftSI_rf.5_full_out_of_sample_data)

ftSI_rf.5_full_out_of_sample_data_reduced <- ftSI_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

ftSI_rf.5_mean_table <- ftSI_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

ftSI_rf.5_full_out_of_sample_data$type <- with(ftSI_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

ftSI_rf.5_full_out_of_sample_data$hit_label <- with(ftSI_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

ftSI_rf.5_plot1 <- ggplot(ftSI_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftSI_rf.5_plot1

ftSI_rf.5_plot2 <- ggplot(ftSI_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftSI_rf.5_plot2

ftSI_rf.5_plot3 <- ggplot(ftSI_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ftSI_rf.5_plot3

ftSI_grid_plot_rf.5 <- grid.arrange(ftSI_rf.5_plot1, ftSI_rf.5_plot2, ftSI_rf.5_plot3, ncol = 3)
ftSI_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

ftSI_test_rows <- ftSI_test$row
ftSI_validate_rows <- ftSI_validate$row
ftSI_pred_data_emp_1 <- ungroup(ftSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftSI_test_rows)

ftSI_pred_data_emp <- ungroup(ftSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftSI_validate_rows) %>%
	rbind(ftSI_pred_data_emp_1)

ftSI_out_of_training_rows <- ftSI_pred_data_emp$row

ftSI_pred_data_emp <- ungroup(ftSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ftSI_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

ftSI_pred_data_emp_scaled <- ftSI_pred_data_emp

ftSI_pred_data_emp_scaled$hit_speed <- (ftSI_pred_data_emp_scaled$hit_speed - ftSI_center_values[2]) / ftSI_scale_values[2]

ftSI_pred_data_emp_scaled$hit_angle <- (ftSI_pred_data_emp_scaled$hit_angle - ftSI_center_values[3]) / ftSI_scale_values[3]

ftSI_pred_prob_hit <- predict(ftSI_rf.5, ftSI_pred_data_emp_scaled, type = "prob")[,2]
ftSI_pred_prob_hit_fits <- cbind(ftSI_pred_data_emp, ftSI_pred_prob_hit)

ftSI_pred_prob_hit_fits[,c(1:2)] <- ftSI_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

ftSI_angle_speed_pred <- ftSI_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = ftSI_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFT-SI Hit Probability\n") + theme_bp_grey()

ftSI_angle_speed_pred
#####
slSI$hit_distance_sc <- as.numeric(slSI$hit_distance_sc, na.rm = TRUE)
slSI$hit_angle <- as.numeric(slSI$hit_angle, na.rm = TRUE)
slSI$hit_speed <- as.numeric(slSI$hit_speed, na.rm = TRUE)

slSI$hit <- with(slSI, ifelse(grepl("Single", slSI$events), 1,
															ifelse(grepl("Double", slSI$events), 1,
																		 ifelse(grepl("Triple", slSI$events), 1, 
																		 			 ifelse(grepl("Home Run", slSI$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

slSI$fieldingTeam <- with(slSI, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[slSI$hit_distance_sc == "null"] = NA
#slSI$hit_speed[slSI$hit_speed == "null"] = NA
#slSI$hit_angle[slSI$hit_angle == "null"] = NA

# include row names for unique record identification

slSI$row <- row.names(slSI) %>% as.numeric()

# recode stand and home_team as factors

slSI$stand <- as.factor(slSI$stand)
slSI$home_team <- as.factor(slSI$home_team)


slSI$game_date <- as.Date(slSI$game_date)


# subset 

slSI_working_data <- ungroup(slSI) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(slSI_working_data)
str(ungroup(slSI))
table(slSI_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

slSI_working_data <- filter(slSI_working_data, hc_x != 1, hc_y != 1)
head(slSI_working_data)

# create training and test sets
# scaled data

set.seed(42)
slSI_train <- sample_frac(slSI_working_data, .15, replace = FALSE)
slSI_split <- setdiff(slSI_working_data, slSI_train)
slSI_test <- sample_frac(slSI_split, .50, replace = FALSE)
slSI_validate <- setdiff(slSI_split, slSI_test)

nrow(slSI_train) + nrow(slSI_test) + nrow(slSI_validate) == nrow(slSI_working_data)

with(slSI_train, table(hit)) %>% prop.table()
with(slSI_test, table(hit)) %>% prop.table()
with(slSI_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(slSI)
##as.numeric(slSI$hit_distance_sc, slSI$hit_speed, slSI$hit_angle)

#slSI_train$hit_distance_sc <- as.numeric(slSI_train$hit_distance_sc)
#slSI_train$hit_speed <- as.numeric(slSI_train$hit_speed)
#slSI_train$hit_angle <- as.numeric(slSI_train$hit_angle)
#View(slSI_train)
slSI_scaled_data <- scale(slSI_train[,c(1:5)])
slSI_scale_values <- attr(slSI_scaled_data, 'scaled:scale')
slSI_scale_values
slSI_center_values <- attr(slSI_scaled_data, 'scaled:center')
slSI_center_values
slSI_train <- cbind(slSI_scaled_data, select(slSI_train, hit:row))

# save levels for factor variables
slSI_levels_home_team <- levels(slSI_train$home_team)
slSI_levels_stand <- levels(slSI_train$stand)
slSI_levels_fieldingTeam <- levels(slSI_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(slSI_test)

slSI_test$hit_distance_sc <- (slSI_test$hit_distance_sc - slSI_center_values[1]) / slSI_scale_values[1]

slSI_test$hit_speed <- (slSI_test$hit_speed - slSI_center_values[2]) / slSI_scale_values[2]

slSI_test$hit_angle <- (slSI_test$hit_angle - slSI_center_values[3]) / slSI_scale_values[3]

slSI_test$hc_x <- (slSI_test$hc_x - slSI_center_values[4]) / slSI_scale_values[4]

slSI_test$hc_y <- (slSI_test$hc_y - slSI_center_values[5]) / slSI_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

slSI_validate$hit_distance_sc <- (slSI_validate$hit_distance_sc - slSI_center_values[1]) / slSI_scale_values[1]

slSI_validate$hit_speed <- (slSI_validate$hit_speed - slSI_center_values[2]) / slSI_scale_values[2]

slSI_validate$hit_angle <- (slSI_validate$hit_angle - slSI_center_values[3]) / slSI_scale_values[3]

slSI_validate$hc_x <- (slSI_validate$hc_x - slSI_center_values[4]) / slSI_scale_values[4]

slSI_validate$hc_y <- (slSI_validate$hc_y - slSI_center_values[5]) / slSI_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(slSI_train)

set.seed(42)
slSI_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(slSI_train, -row), ntree = 501, importance = TRUE)

print(slSI_rf.1)

plot(slSI_rf.1)

varImpPlot(slSI_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
slSI_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(slSI_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(slSI_rf.5)

plot(slSI_rf.5)

varImpPlot(slSI_rf.5)

slSI_predict_fit.rf.5 <- data.frame(fits = predict(slSI_rf.5, slSI_test, type = "prob")[,2], actuals = slSI_test$hit)

slSI_pred.rf.5 <- prediction(slSI_predict_fit.rf.5$fits, slSI_predict_fit.rf.5$actuals)

slSI_roc.pred.rf.5 <- performance(slSI_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(slSI_roc.pred.rf.5)
abline(a = 0, b = 1)
slSI_opt <- opt.cut(slSI_roc.pred.rf.5, slSI_pred.rf.5)
slSI_opt
slSI_opt <- slSI_opt[3]
slSI_predict_fit.rf.5$fits <- with(slSI_predict_fit.rf.5, ifelse(fits > slSI_opt, 1, 0)) 

str(slSI_test)

#slSI_test$fieldingTeam <- as.character(slSI_test$fieldingTeam)
#slSI_test$home_team <- as.character(slSI_test$home_team)
#slSI_test$hit <- as.logical(slSI_test$hit)
#slSI_test$stand <- as.logical(slSI_test$stand)
str(slSI_test)
slSI_rf.5_confusion_test <- confusionMatrix(model = slSI_rf.5, x = slSI_test, y = slSI_test$hit)
slSI_rf.5_confusion_validate <- confusionMatrix(model = slSI_rf.5, x = slSI_validate, y = slSI_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


slSI_test_rows <- slSI_test$row
slSI_validate_rows <- slSI_validate$row
slSI_pred_data_emp_1 <- ungroup(slSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slSI_test_rows)

slSI_pred_data_emp <- ungroup(slSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slSI_validate_rows) %>%
	rbind(slSI_pred_data_emp_1)

slSI_out_of_training_rows <- slSI_pred_data_emp$row

slSI_rf.5_full_out_of_sample_data <- ungroup(slSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slSI_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



slSI_rf.5_full_out_of_sample_data_scaled <- slSI_rf.5_full_out_of_sample_data

slSI_rf.5_full_out_of_sample_data_scaled$hit_speed <- (slSI_rf.5_full_out_of_sample_data_scaled$hit_speed - slSI_center_values[2]) / slSI_scale_values[2]

slSI_rf.5_full_out_of_sample_data_scaled$hit_angle <- (slSI_rf.5_full_out_of_sample_data_scaled$hit_angle - slSI_center_values[3]) / slSI_scale_values[3]

slSI_rf.5.prob <- predict(slSI_rf.5, slSI_rf.5_full_out_of_sample_data_scaled, type = "response")

slSI_rf.5_full_out_of_sample_data <- cbind(filter(slSI_rf.5_full_out_of_sample_data, row %in% slSI_out_of_training_rows), slSI_rf.5.prob)

names(slSI_rf.5_full_out_of_sample_data)[65] <- "fits"
names(slSI_rf.5_full_out_of_sample_data)

slSI_rf.5_full_out_of_sample_data_reduced <- slSI_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

slSI_rf.5_mean_table <- slSI_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

slSI_rf.5_full_out_of_sample_data$type <- with(slSI_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

slSI_rf.5_full_out_of_sample_data$hit_label <- with(slSI_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

slSI_rf.5_plot1 <- ggplot(slSI_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slSI_rf.5_plot1

slSI_rf.5_plot2 <- ggplot(slSI_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slSI_rf.5_plot2

slSI_rf.5_plot3 <- ggplot(slSI_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

slSI_rf.5_plot3

slSI_grid_plot_rf.5 <- grid.arrange(slSI_rf.5_plot1, slSI_rf.5_plot2, slSI_rf.5_plot3, ncol = 3)
slSI_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

slSI_test_rows <- slSI_test$row
slSI_validate_rows <- slSI_validate$row
slSI_pred_data_emp_1 <- ungroup(slSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slSI_test_rows)

slSI_pred_data_emp <- ungroup(slSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slSI_validate_rows) %>%
	rbind(slSI_pred_data_emp_1)

slSI_out_of_training_rows <- slSI_pred_data_emp$row

slSI_pred_data_emp <- ungroup(slSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% slSI_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

slSI_pred_data_emp_scaled <- slSI_pred_data_emp

slSI_pred_data_emp_scaled$hit_speed <- (slSI_pred_data_emp_scaled$hit_speed - slSI_center_values[2]) / slSI_scale_values[2]

slSI_pred_data_emp_scaled$hit_angle <- (slSI_pred_data_emp_scaled$hit_angle - slSI_center_values[3]) / slSI_scale_values[3]

slSI_pred_prob_hit <- predict(slSI_rf.5, slSI_pred_data_emp_scaled, type = "prob")[,2]
slSI_pred_prob_hit_fits <- cbind(slSI_pred_data_emp, slSI_pred_prob_hit)

slSI_pred_prob_hit_fits[,c(1:2)] <- slSI_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

slSI_angle_speed_pred <- slSI_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = slSI_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nSL-SI Hit Probability\n") + theme_bp_grey()

slSI_angle_speed_pred
#####
cuSI$hit_distance_sc <- as.numeric(cuSI$hit_distance_sc, na.rm = TRUE)
cuSI$hit_angle <- as.numeric(cuSI$hit_angle, na.rm = TRUE)
cuSI$hit_speed <- as.numeric(cuSI$hit_speed, na.rm = TRUE)

cuSI$hit <- with(cuSI, ifelse(grepl("Single", cuSI$events), 1,
															ifelse(grepl("Double", cuSI$events), 1,
																		 ifelse(grepl("Triple", cuSI$events), 1, 
																		 			 ifelse(grepl("Home Run", cuSI$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

cuSI$fieldingTeam <- with(cuSI, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[cuSI$hit_distance_sc == "null"] = NA
#cuSI$hit_speed[cuSI$hit_speed == "null"] = NA
#cuSI$hit_angle[cuSI$hit_angle == "null"] = NA

# include row names for unique record identification

cuSI$row <- row.names(cuSI) %>% as.numeric()

# recode stand and home_team as factors

cuSI$stand <- as.factor(cuSI$stand)
cuSI$home_team <- as.factor(cuSI$home_team)


cuSI$game_date <- as.Date(cuSI$game_date)


# subset 

cuSI_working_data <- ungroup(cuSI) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(cuSI_working_data)
str(ungroup(cuSI))
table(cuSI_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

cuSI_working_data <- filter(cuSI_working_data, hc_x != 1, hc_y != 1)
head(cuSI_working_data)

# create training and test sets
# scaled data

set.seed(42)
cuSI_train <- sample_frac(cuSI_working_data, .15, replace = FALSE)
cuSI_split <- setdiff(cuSI_working_data, cuSI_train)
cuSI_test <- sample_frac(cuSI_split, .50, replace = FALSE)
cuSI_validate <- setdiff(cuSI_split, cuSI_test)

nrow(cuSI_train) + nrow(cuSI_test) + nrow(cuSI_validate) == nrow(cuSI_working_data)

with(cuSI_train, table(hit)) %>% prop.table()
with(cuSI_test, table(hit)) %>% prop.table()
with(cuSI_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(cuSI)
##as.numeric(cuSI$hit_distance_sc, cuSI$hit_speed, cuSI$hit_angle)

#cuSI_train$hit_distance_sc <- as.numeric(cuSI_train$hit_distance_sc)
#cuSI_train$hit_speed <- as.numeric(cuSI_train$hit_speed)
#cuSI_train$hit_angle <- as.numeric(cuSI_train$hit_angle)
#View(cuSI_train)
cuSI_scaled_data <- scale(cuSI_train[,c(1:5)])
cuSI_scale_values <- attr(cuSI_scaled_data, 'scaled:scale')
cuSI_scale_values
cuSI_center_values <- attr(cuSI_scaled_data, 'scaled:center')
cuSI_center_values
cuSI_train <- cbind(cuSI_scaled_data, select(cuSI_train, hit:row))

# save levels for factor variables
cuSI_levels_home_team <- levels(cuSI_train$home_team)
cuSI_levels_stand <- levels(cuSI_train$stand)
cuSI_levels_fieldingTeam <- levels(cuSI_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(cuSI_test)

cuSI_test$hit_distance_sc <- (cuSI_test$hit_distance_sc - cuSI_center_values[1]) / cuSI_scale_values[1]

cuSI_test$hit_speed <- (cuSI_test$hit_speed - cuSI_center_values[2]) / cuSI_scale_values[2]

cuSI_test$hit_angle <- (cuSI_test$hit_angle - cuSI_center_values[3]) / cuSI_scale_values[3]

cuSI_test$hc_x <- (cuSI_test$hc_x - cuSI_center_values[4]) / cuSI_scale_values[4]

cuSI_test$hc_y <- (cuSI_test$hc_y - cuSI_center_values[5]) / cuSI_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

cuSI_validate$hit_distance_sc <- (cuSI_validate$hit_distance_sc - cuSI_center_values[1]) / cuSI_scale_values[1]

cuSI_validate$hit_speed <- (cuSI_validate$hit_speed - cuSI_center_values[2]) / cuSI_scale_values[2]

cuSI_validate$hit_angle <- (cuSI_validate$hit_angle - cuSI_center_values[3]) / cuSI_scale_values[3]

cuSI_validate$hc_x <- (cuSI_validate$hc_x - cuSI_center_values[4]) / cuSI_scale_values[4]

cuSI_validate$hc_y <- (cuSI_validate$hc_y - cuSI_center_values[5]) / cuSI_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(cuSI_train)

set.seed(42)
cuSI_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(cuSI_train, -row), ntree = 501, importance = TRUE)

print(cuSI_rf.1)

plot(cuSI_rf.1)

varImpPlot(cuSI_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
cuSI_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(cuSI_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(cuSI_rf.5)

plot(cuSI_rf.5)

varImpPlot(cuSI_rf.5)

cuSI_predict_fit.rf.5 <- data.frame(fits = predict(cuSI_rf.5, cuSI_test, type = "prob")[,2], actuals = cuSI_test$hit)

cuSI_pred.rf.5 <- prediction(cuSI_predict_fit.rf.5$fits, cuSI_predict_fit.rf.5$actuals)

cuSI_roc.pred.rf.5 <- performance(cuSI_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(cuSI_roc.pred.rf.5)
abline(a = 0, b = 1)
cuSI_opt <- opt.cut(cuSI_roc.pred.rf.5, cuSI_pred.rf.5)
cuSI_opt
cuSI_opt <- cuSI_opt[3]
cuSI_predict_fit.rf.5$fits <- with(cuSI_predict_fit.rf.5, ifelse(fits > cuSI_opt, 1, 0)) 

str(cuSI_test)

#cuSI_test$fieldingTeam <- as.character(cuSI_test$fieldingTeam)
#cuSI_test$home_team <- as.character(cuSI_test$home_team)
#cuSI_test$hit <- as.logical(cuSI_test$hit)
#cuSI_test$stand <- as.logical(cuSI_test$stand)
str(cuSI_test)
cuSI_rf.5_confusion_test <- confusionMatrix(model = cuSI_rf.5, x = cuSI_test, y = cuSI_test$hit)
cuSI_rf.5_confusion_validate <- confusionMatrix(model = cuSI_rf.5, x = cuSI_validate, y = cuSI_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


cuSI_test_rows <- cuSI_test$row
cuSI_validate_rows <- cuSI_validate$row
cuSI_pred_data_emp_1 <- ungroup(cuSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuSI_test_rows)

cuSI_pred_data_emp <- ungroup(cuSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuSI_validate_rows) %>%
	rbind(cuSI_pred_data_emp_1)

cuSI_out_of_training_rows <- cuSI_pred_data_emp$row

cuSI_rf.5_full_out_of_sample_data <- ungroup(cuSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuSI_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



cuSI_rf.5_full_out_of_sample_data_scaled <- cuSI_rf.5_full_out_of_sample_data

cuSI_rf.5_full_out_of_sample_data_scaled$hit_speed <- (cuSI_rf.5_full_out_of_sample_data_scaled$hit_speed - cuSI_center_values[2]) / cuSI_scale_values[2]

cuSI_rf.5_full_out_of_sample_data_scaled$hit_angle <- (cuSI_rf.5_full_out_of_sample_data_scaled$hit_angle - cuSI_center_values[3]) / cuSI_scale_values[3]

cuSI_rf.5.prob <- predict(cuSI_rf.5, cuSI_rf.5_full_out_of_sample_data_scaled, type = "response")

cuSI_rf.5_full_out_of_sample_data <- cbind(filter(cuSI_rf.5_full_out_of_sample_data, row %in% cuSI_out_of_training_rows), cuSI_rf.5.prob)

names(cuSI_rf.5_full_out_of_sample_data)[65] <- "fits"
names(cuSI_rf.5_full_out_of_sample_data)

cuSI_rf.5_full_out_of_sample_data_reduced <- cuSI_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

cuSI_rf.5_mean_table <- cuSI_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

cuSI_rf.5_full_out_of_sample_data$type <- with(cuSI_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

cuSI_rf.5_full_out_of_sample_data$hit_label <- with(cuSI_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

cuSI_rf.5_plot1 <- ggplot(cuSI_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuSI_rf.5_plot1

cuSI_rf.5_plot2 <- ggplot(cuSI_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuSI_rf.5_plot2

cuSI_rf.5_plot3 <- ggplot(cuSI_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

cuSI_rf.5_plot3

cuSI_grid_plot_rf.5 <- grid.arrange(cuSI_rf.5_plot1, cuSI_rf.5_plot2, cuSI_rf.5_plot3, ncol = 3)
cuSI_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

cuSI_test_rows <- cuSI_test$row
cuSI_validate_rows <- cuSI_validate$row
cuSI_pred_data_emp_1 <- ungroup(cuSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuSI_test_rows)

cuSI_pred_data_emp <- ungroup(cuSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuSI_validate_rows) %>%
	rbind(cuSI_pred_data_emp_1)

cuSI_out_of_training_rows <- cuSI_pred_data_emp$row

cuSI_pred_data_emp <- ungroup(cuSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% cuSI_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

cuSI_pred_data_emp_scaled <- cuSI_pred_data_emp

cuSI_pred_data_emp_scaled$hit_speed <- (cuSI_pred_data_emp_scaled$hit_speed - cuSI_center_values[2]) / cuSI_scale_values[2]

cuSI_pred_data_emp_scaled$hit_angle <- (cuSI_pred_data_emp_scaled$hit_angle - cuSI_center_values[3]) / cuSI_scale_values[3]

cuSI_pred_prob_hit <- predict(cuSI_rf.5, cuSI_pred_data_emp_scaled, type = "prob")[,2]
cuSI_pred_prob_hit_fits <- cbind(cuSI_pred_data_emp, cuSI_pred_prob_hit)

cuSI_pred_prob_hit_fits[,c(1:2)] <- cuSI_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

cuSI_angle_speed_pred <- cuSI_pred5_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = cuSI_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nCU-SI Hit Probability\n") + theme_bp_grey()

cuSI_angle_speed_pred
#####
ffSI$hit_distance_sc <- as.numeric(ffSI$hit_distance_sc, na.rm = TRUE)
ffSI$hit_angle <- as.numeric(ffSI$hit_angle, na.rm = TRUE)
ffSI$hit_speed <- as.numeric(ffSI$hit_speed, na.rm = TRUE)

ffSI$hit <- with(ffSI, ifelse(grepl("Single", ffSI$events), 1,
															ifelse(grepl("Double", ffSI$events), 1,
																		 ifelse(grepl("Triple", ffSI$events), 1, 
																		 			 ifelse(grepl("Home Run", ffSI$events), 1, 0))))) %>% 
	as.factor()

# create a variable for the fielding team

ffSI$fieldingTeam <- with(ffSI, ifelse(inning_topbot == "bot", away_team, home_team)) %>% 
	as.factor()

#F$hit_distance_sc[ffSI$hit_distance_sc == "null"] = NA
#ffSI$hit_speed[ffSI$hit_speed == "null"] = NA
#ffSI$hit_angle[ffSI$hit_angle == "null"] = NA

# include row names for unique record identification

ffSI$row <- row.names(ffSI) %>% as.numeric()

# recode stand and home_team as factors

ffSI$stand <- as.factor(ffSI$stand)
ffSI$home_team <- as.factor(ffSI$home_team)


ffSI$game_date <- as.Date(ffSI$game_date)


# subset 

ffSI_working_data <- ungroup(ffSI) %>%
	filter(game_date <= "2016-05-28") %>%
	select(hit_distance_sc:hit_angle, hc_x, hc_y, hit, stand, fieldingTeam, home_team,  row) %>%
	filter(!is.na(hit_distance_sc)) %>%
	filter(!is.na(hit_angle)) %>% 
	filter(!is.na(hit_speed)) %>%
	arrange(desc(hit))
head(ffSI_working_data)
str(ungroup(ffSI))
table(ffSI_working_data$hit)

# remove apparently miscoded balls with x,y of 1,1

ffSI_working_data <- filter(ffSI_working_data, hc_x != 1, hc_y != 1)
head(ffSI_working_data)

# create training and test sets
# scaled data

set.seed(42)
ffSI_train <- sample_frac(ffSI_working_data, .15, replace = FALSE)
ffSI_split <- setdiff(ffSI_working_data, ffSI_train)
ffSI_test <- sample_frac(ffSI_split, .50, replace = FALSE)
ffSI_validate <- setdiff(ffSI_split, ffSI_test)

nrow(ffSI_train) + nrow(ffSI_test) + nrow(ffSI_validate) == nrow(ffSI_working_data)

with(ffSI_train, table(hit)) %>% prop.table()
with(ffSI_test, table(hit)) %>% prop.table()
with(ffSI_validate, table(hit)) %>% prop.table()


# normalize exit velocity, launch angle and distance
# scaled features
str(ffSI)
##as.numeric(ffSI$hit_distance_sc, ffSI$hit_speed, ffSI$hit_angle)

#ffSI_train$hit_distance_sc <- as.numeric(ffSI_train$hit_distance_sc)
#ffSI_train$hit_speed <- as.numeric(ffSI_train$hit_speed)
#ffSI_train$hit_angle <- as.numeric(ffSI_train$hit_angle)
#View(ffSI_train)
ffSI_scaled_data <- scale(ffSI_train[,c(1:5)])
ffSI_scale_values <- attr(ffSI_scaled_data, 'scaled:scale')
ffSI_scale_values
ffSI_center_values <- attr(ffSI_scaled_data, 'scaled:center')
ffSI_center_values
ffSI_train <- cbind(ffSI_scaled_data, select(ffSI_train, hit:row))

# save levels for factor variables
ffSI_levels_home_team <- levels(ffSI_train$home_team)
ffSI_levels_stand <- levels(ffSI_train$stand)
ffSI_levels_fieldingTeam <- levels(ffSI_train$fieldingTeam)
#levels_first_pitch <- levels(train$first_pitch)
#levels_second_pitch <- levels(train$levels_second_pitch)

# apply scaling to test data
#View(ffSI_test)

ffSI_test$hit_distance_sc <- (ffSI_test$hit_distance_sc - ffSI_center_values[1]) / ffSI_scale_values[1]

ffSI_test$hit_speed <- (ffSI_test$hit_speed - ffSI_center_values[2]) / ffSI_scale_values[2]

ffSI_test$hit_angle <- (ffSI_test$hit_angle - ffSI_center_values[3]) / ffSI_scale_values[3]

ffSI_test$hc_x <- (ffSI_test$hc_x - ffSI_center_values[4]) / ffSI_scale_values[4]

ffSI_test$hc_y <- (ffSI_test$hc_y - ffSI_center_values[5]) / ffSI_scale_values[5]

#test$px <- (test$px - center_values[6])/scale_values[6]

#test$pz <- (test$pz - center_values[7])/scale_values[7]

#test$break_length <- (test$break_length - center_values[8])/scale_values[8]

# apply scaling to validation data

ffSI_validate$hit_distance_sc <- (ffSI_validate$hit_distance_sc - ffSI_center_values[1]) / ffSI_scale_values[1]

ffSI_validate$hit_speed <- (ffSI_validate$hit_speed - ffSI_center_values[2]) / ffSI_scale_values[2]

ffSI_validate$hit_angle <- (ffSI_validate$hit_angle - ffSI_center_values[3]) / ffSI_scale_values[3]

ffSI_validate$hc_x <- (ffSI_validate$hc_x - ffSI_center_values[4]) / ffSI_scale_values[4]

ffSI_validate$hc_y <- (ffSI_validate$hc_y - ffSI_center_values[5]) / ffSI_scale_values[5]

#validate$px <- (validate$px - center_values[6]) / scale_values[6]

#validate$pz <- (validate$pz - center_values[7])/scale_values[7]

#validate$break_length <- (validate$break_length - center_values[8])/scale_values[8]

# build, test, validate models



# model hit/no-hit random forest
# with all variables
head(ffSI_train)

set.seed(42)
ffSI_rf.1 <- randomForest(as.factor(hit) ~ ., data = select(ffSI_train, -row), ntree = 501, importance = TRUE)

print(ffSI_rf.1)

plot(ffSI_rf.1)

varImpPlot(ffSI_rf.1)

# predict values and tune for optimal out of sample accuracy

opt.cut = function(perf, pred){
	cut.ind = mapply(FUN=function(x, y, p){
		d = (x - 0)^2 + (y-1)^2
		ind = which(d == min(d))
		c(sensitivity = y[[ind]], specificity = 1-x[[ind]], 
			cutoff = p[[ind]])
	}, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.perf, pred))

# only speed, angle, stand, fielding team and park

set.seed(42)
ffSI_rf.5 <- randomForest(as.factor(hit) ~ ., mtry = 2, ntrees = 501, data = select(ffSI_train, -row, -hit_distance_sc, -hc_y, -hc_x), importance = TRUE)

print(ffSI_rf.5)

plot(ffSI_rf.5)

varImpPlot(ffSI_rf.5)

ffSI_predict_fit.rf.5 <- data.frame(fits = predict(ffSI_rf.5, ffSI_test, type = "prob")[,2], actuals = ffSI_test$hit)

ffSI_pred.rf.5 <- prediction(ffSI_predict_fit.rf.5$fits, ffSI_predict_fit.rf.5$actuals)

ffSI_roc.pred.rf.5 <- performance(ffSI_pred.rf.5, measure = "tpr", x.measure = "fpr")

plot(ffSI_roc.pred.rf.5)
abline(a = 0, b = 1)
ffSI_opt <- opt.cut(ffSI_roc.pred.rf.5, ffSI_pred.rf.5)
ffSI_opt
ffSI_opt <- ffSI_opt[3]
ffSI_predict_fit.rf.5$fits <- with(ffSI_predict_fit.rf.5, ifelse(fits > ffSI_opt, 1, 0)) 

str(ffSI_test)

#ffSI_test$fieldingTeam <- as.character(ffSI_test$fieldingTeam)
#ffSI_test$home_team <- as.character(ffSI_test$home_team)
#ffSI_test$hit <- as.logical(ffSI_test$hit)
#ffSI_test$stand <- as.logical(ffSI_test$stand)
str(ffSI_test)
ffSI_rf.5_confusion_test <- confusionMatrix(model = ffSI_rf.5, x = ffSI_test, y = ffSI_test$hit)
ffSI_rf.5_confusion_validate <- confusionMatrix(model = ffSI_rf.5, x = ffSI_validate, y = ffSI_validate$hit)

# can we improve the model by altering the number of variables randomly tried at each branch?


ffSI_test_rows <- ffSI_test$row
ffSI_validate_rows <- ffSI_validate$row
ffSI_pred_data_emp_1 <- ungroup(ffSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffSI_test_rows)

ffSI_pred_data_emp <- ungroup(ffSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffSI_validate_rows) %>%
	rbind(ffSI_pred_data_emp_1)

ffSI_out_of_training_rows <- ffSI_pred_data_emp$row

ffSI_rf.5_full_out_of_sample_data <- ungroup(ffSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffSI_out_of_training_rows) %>%
	filter(!is.na(hit_speed)) %>%
	filter(!is.na(hit_angle))



ffSI_rf.5_full_out_of_sample_data_scaled <- ffSI_rf.5_full_out_of_sample_data

ffSI_rf.5_full_out_of_sample_data_scaled$hit_speed <- (ffSI_rf.5_full_out_of_sample_data_scaled$hit_speed - ffSI_center_values[2]) / ffSI_scale_values[2]

ffSI_rf.5_full_out_of_sample_data_scaled$hit_angle <- (ffSI_rf.5_full_out_of_sample_data_scaled$hit_angle - ffSI_center_values[3]) / ffSI_scale_values[3]

ffSI_rf.5.prob <- predict(ffSI_rf.5, ffSI_rf.5_full_out_of_sample_data_scaled, type = "response")

ffSI_rf.5_full_out_of_sample_data <- cbind(filter(ffSI_rf.5_full_out_of_sample_data, row %in% ffSI_out_of_training_rows), ffSI_rf.5.prob)

names(ffSI_rf.5_full_out_of_sample_data)[65] <- "fits"
names(ffSI_rf.5_full_out_of_sample_data)

ffSI_rf.5_full_out_of_sample_data_reduced <- ffSI_rf.5_full_out_of_sample_data %>%
	select(hit_distance_sc, hit_angle, hit_speed, hit, fits)

ffSI_rf.5_mean_table <- ffSI_rf.5_full_out_of_sample_data_reduced %>% 
	group_by(hit, fits) %>%
	summarise_each(funs(mean(., na.rm = TRUE),n()))

ffSI_rf.5_full_out_of_sample_data$type <- with(ffSI_rf.5_full_out_of_sample_data, ifelse(hit == fits, 1, 0))

ffSI_rf.5_full_out_of_sample_data$hit_label <- with(ffSI_rf.5_full_out_of_sample_data, ifelse(hit == 1, "Hit", "Out"))

# condensed tab palette
source("https://raw.githubusercontent.com/BillPetti/R-Plotting-Resources/master/theme_bp_grey")

tab_condensed <- c("#006BA4", "#C85200")

ffSI_rf.5_plot1 <- ggplot(ffSI_rf.5_full_out_of_sample_data, aes(hit_angle, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffSI_rf.5_plot1

ffSI_rf.5_plot2 <- ggplot(ffSI_rf.5_full_out_of_sample_data, aes(hit_speed, hit_distance_sc)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nSpeed off the Bat") +
	ylab("Batted Ball Distance (ft.)\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffSI_rf.5_plot2

ffSI_rf.5_plot3 <- ggplot(ffSI_rf.5_full_out_of_sample_data, aes(hit_angle, hit_speed)) +
	geom_point(aes(color = as.factor(type)), alpha = .2) + 
	xlab("\nLaunch Angle") +
	ylab("Speed off the Bat\n") +
	facet_wrap(~hit_label) + 
	theme_bp_grey() + 
	theme(strip.text.x = element_text(face = "bold", size = 14)) +
	scale_color_manual(values = tab_condensed, guide = FALSE)

ffSI_rf.5_plot3

ffSI_grid_plot_rf.5 <- grid.arrange(ffSI_rf.5_plot1, ffSI_rf.5_plot2, ffSI_rf.5_plot3, ncol = 3)
ffSI_grid_plot_rf.5


#ggsave("grid_plot_rf.5.png", grid_plot_rf.5rf.5, scale = 1.2, width = 11, height = 8.5, units = "in")

## predicted probabilities using rf.5

# create a data set that combines the test and validation sets

ffSI_test_rows <- ffSI_test$row
ffSI_validate_rows <- ffSI_validate$row
ffSI_pred_data_emp_1 <- ungroup(ffSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffSI_test_rows)

ffSI_pred_data_emp <- ungroup(ffSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffSI_validate_rows) %>%
	rbind(ffSI_pred_data_emp_1)

ffSI_out_of_training_rows <- ffSI_pred_data_emp$row

ffSI_pred_data_emp <- ungroup(ffSI) %>% 
	filter(hc_x != 1, hc_y != 1) %>% 
	filter(row %in% ffSI_out_of_training_rows) %>%
	select(hit_angle, hit_speed, stand, fieldingTeam, home_team) %>%
	filter(complete.cases(.))

# empirical data

ffSI_pred_data_emp_scaled <- ffSI_pred_data_emp

ffSI_pred_data_emp_scaled$hit_speed <- (ffSI_pred_data_emp_scaled$hit_speed - ffSI_center_values[2]) / ffSI_scale_values[2]

ffSI_pred_data_emp_scaled$hit_angle <- (ffSI_pred_data_emp_scaled$hit_angle - ffSI_center_values[3]) / ffSI_scale_values[3]

ffSI_pred_prob_hit <- predict(ffSI_rf.5, ffSI_pred_data_emp_scaled, type = "prob")[,2]
ffSI_pred_prob_hit_fits <- cbind(ffSI_pred_data_emp, ffSI_pred_prob_hit)

ffSI_pred_prob_hit_fits[,c(1:2)] <- ffSI_pred_prob_hit_fits[,c(1:2)] %>%
	round(.)

ffSI_angle_speed_pred <- ffSI_pred_prob_hit_fits %>% ggplot(aes(hit_speed, hit_angle)) + geom_tile(aes(fill = ffSI_pred_prob_hit), alpha = .5, size = .05, color = "white") + scale_fill_gradient(limit = c(0,1), low = "red", high = "blue", "Probability\nof Hit\n", labels = percent) + xlab("\nSpeed off the Bat") + ylab("Launch Angle\n") + ggtitle("\nFF-SI Hit Probability\n") + theme_bp_grey()

ffSI_angle_speed_pred
############# End Sinkers